# Comparing `tmp/megfile-2.0.6-py3-none-any.whl.zip` & `tmp/megfile-2.0.6.post1-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,46 +1,47 @@
-Zip file size: 107709 bytes, number of entries: 44
+Zip file size: 108077 bytes, number of entries: 45
 -rw-rw-r--  2.0 unx     5434 b- defN 23-May-25 06:42 megfile/__init__.py
 -rw-rw-r--  2.0 unx    10033 b- defN 23-May-25 06:42 megfile/cli.py
--rw-rw-r--  2.0 unx    11584 b- defN 23-May-25 06:42 megfile/errors.py
--rw-rw-r--  2.0 unx    11621 b- defN 23-Jun-13 05:32 megfile/fs.py
--rw-rw-r--  2.0 unx    38484 b- defN 23-Jun-13 05:49 megfile/fs_path.py
--rw-rw-r--  2.0 unx     1852 b- defN 23-Jun-13 05:32 megfile/http.py
--rw-rw-r--  2.0 unx     4483 b- defN 23-May-25 06:42 megfile/http_path.py
+-rw-rw-r--  2.0 unx    11686 b- defN 23-Jun-16 08:51 megfile/errors.py
+-rw-rw-r--  2.0 unx    11621 b- defN 23-Jun-15 07:50 megfile/fs.py
+-rw-rw-r--  2.0 unx    38552 b- defN 23-Jun-16 02:18 megfile/fs_path.py
+-rw-rw-r--  2.0 unx     1852 b- defN 23-Jun-15 07:50 megfile/http.py
+-rw-rw-r--  2.0 unx     4487 b- defN 23-Jun-16 02:18 megfile/http_path.py
 -rw-rw-r--  2.0 unx     6219 b- defN 23-May-25 06:42 megfile/interfaces.py
 -rw-rw-r--  2.0 unx    29307 b- defN 23-Jun-13 05:49 megfile/pathlike.py
--rw-rw-r--  2.0 unx    12456 b- defN 23-Jun-13 05:32 megfile/s3.py
--rw-rw-r--  2.0 unx    85094 b- defN 23-Jun-13 05:49 megfile/s3_path.py
--rw-rw-r--  2.0 unx    11943 b- defN 23-Jun-13 05:32 megfile/sftp.py
--rw-rw-r--  2.0 unx    44039 b- defN 23-Jun-13 05:49 megfile/sftp_path.py
+-rw-rw-r--  2.0 unx    12456 b- defN 23-Jun-15 07:50 megfile/s3.py
+-rw-rw-r--  2.0 unx    85102 b- defN 23-Jun-16 02:18 megfile/s3_path.py
+-rw-rw-r--  2.0 unx    11943 b- defN 23-Jun-15 07:50 megfile/sftp.py
+-rw-rw-r--  2.0 unx    44039 b- defN 23-Jun-16 07:57 megfile/sftp_path.py
 -rw-rw-r--  2.0 unx    31952 b- defN 23-Jun-13 05:49 megfile/smart.py
--rw-rw-r--  2.0 unx     6700 b- defN 23-Jun-13 05:49 megfile/smart_path.py
--rw-rw-r--  2.0 unx      559 b- defN 23-Jun-13 05:32 megfile/stdio.py
--rw-rw-r--  2.0 unx     2672 b- defN 23-May-25 06:42 megfile/stdio_path.py
--rw-rw-r--  2.0 unx       19 b- defN 23-Jun-13 06:23 megfile/version.py
+-rw-rw-r--  2.0 unx     6708 b- defN 23-Jun-16 02:18 megfile/smart_path.py
+-rw-rw-r--  2.0 unx      559 b- defN 23-Jun-15 07:50 megfile/stdio.py
+-rw-rw-r--  2.0 unx     2682 b- defN 23-Jun-16 02:18 megfile/stdio_path.py
+-rw-rw-r--  2.0 unx       25 b- defN 23-Jun-16 10:24 megfile/version.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-May-25 06:42 megfile/lib/__init__.py
--rw-rw-r--  2.0 unx     4580 b- defN 23-Jun-13 05:32 megfile/lib/combine_reader.py
+-rw-rw-r--  2.0 unx     4580 b- defN 23-Jun-15 07:50 megfile/lib/combine_reader.py
 -rw-rw-r--  2.0 unx     2233 b- defN 23-Jun-13 05:49 megfile/lib/compare.py
 -rw-rw-r--  2.0 unx     3053 b- defN 23-Jun-13 05:49 megfile/lib/compat.py
 -rw-rw-r--  2.0 unx     4054 b- defN 23-May-25 06:42 megfile/lib/fnmatch.py
--rw-rw-r--  2.0 unx     9478 b- defN 23-May-25 06:42 megfile/lib/glob.py
+-rw-rw-r--  2.0 unx     9514 b- defN 23-Jun-15 06:20 megfile/lib/glob.py
 -rw-rw-r--  2.0 unx      929 b- defN 23-May-25 06:42 megfile/lib/joinpath.py
 -rw-rw-r--  2.0 unx     1915 b- defN 23-May-25 06:42 megfile/lib/lazy_handler.py
 -rw-rw-r--  2.0 unx     6934 b- defN 23-May-25 06:42 megfile/lib/s3_buffered_writer.py
 -rw-rw-r--  2.0 unx     1322 b- defN 23-May-25 06:42 megfile/lib/s3_cached_handler.py
 -rw-rw-r--  2.0 unx     6057 b- defN 23-May-25 06:42 megfile/lib/s3_limited_seekable_writer.py
 -rw-rw-r--  2.0 unx     3725 b- defN 23-May-25 06:42 megfile/lib/s3_memory_handler.py
 -rw-rw-r--  2.0 unx     3404 b- defN 23-May-25 06:42 megfile/lib/s3_pipe_handler.py
 -rw-rw-r--  2.0 unx    15053 b- defN 23-May-25 06:42 megfile/lib/s3_prefetch_reader.py
--rw-rw-r--  2.0 unx     3791 b- defN 23-Jun-13 05:32 megfile/lib/s3_share_cache_reader.py
+-rw-rw-r--  2.0 unx     3791 b- defN 23-Jun-15 07:50 megfile/lib/s3_share_cache_reader.py
 -rw-rw-r--  2.0 unx     2683 b- defN 23-May-25 06:42 megfile/lib/shadow_handler.py
 -rw-rw-r--  2.0 unx     2044 b- defN 23-May-25 06:42 megfile/lib/stdio_handler.py
+-rw-rw-r--  2.0 unx      103 b- defN 23-Jun-16 02:18 megfile/lib/url.py
 -rw-rw-r--  2.0 unx     9025 b- defN 23-May-25 06:42 megfile/utils/__init__.py
 -rw-rw-r--  2.0 unx     2461 b- defN 23-May-25 06:42 megfile/utils/mutex.py
--rw-rw-r--  2.0 unx    11357 b- defN 23-Jun-13 06:26 megfile-2.0.6.dist-info/LICENSE
--rw-rw-r--  2.0 unx     1080 b- defN 23-Jun-13 06:26 megfile-2.0.6.dist-info/LICENSE.pyre
--rw-rw-r--  2.0 unx    10154 b- defN 23-Jun-13 06:26 megfile-2.0.6.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Jun-13 06:26 megfile-2.0.6.dist-info/WHEEL
--rw-rw-r--  2.0 unx       49 b- defN 23-Jun-13 06:26 megfile-2.0.6.dist-info/entry_points.txt
--rw-rw-r--  2.0 unx        8 b- defN 23-Jun-13 06:26 megfile-2.0.6.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     3529 b- defN 23-Jun-13 06:26 megfile-2.0.6.dist-info/RECORD
-44 files, 423461 bytes uncompressed, 102191 bytes compressed:  75.9%
+-rw-rw-r--  2.0 unx    11357 b- defN 23-Jun-16 10:25 megfile-2.0.6.post1.dist-info/LICENSE
+-rw-rw-r--  2.0 unx     1080 b- defN 23-Jun-16 10:25 megfile-2.0.6.post1.dist-info/LICENSE.pyre
+-rw-rw-r--  2.0 unx    10160 b- defN 23-Jun-16 10:25 megfile-2.0.6.post1.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Jun-16 10:25 megfile-2.0.6.post1.dist-info/WHEEL
+-rw-rw-r--  2.0 unx       49 b- defN 23-Jun-16 10:25 megfile-2.0.6.post1.dist-info/entry_points.txt
+-rw-rw-r--  2.0 unx        8 b- defN 23-Jun-16 10:25 megfile-2.0.6.post1.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     3645 b- defN 23-Jun-16 10:25 megfile-2.0.6.post1.dist-info/RECORD
+45 files, 423928 bytes uncompressed, 102363 bytes compressed:  75.9%
```

## zipnote {}

```diff
@@ -99,35 +99,38 @@
 
 Filename: megfile/lib/shadow_handler.py
 Comment: 
 
 Filename: megfile/lib/stdio_handler.py
 Comment: 
 
+Filename: megfile/lib/url.py
+Comment: 
+
 Filename: megfile/utils/__init__.py
 Comment: 
 
 Filename: megfile/utils/mutex.py
 Comment: 
 
-Filename: megfile-2.0.6.dist-info/LICENSE
+Filename: megfile-2.0.6.post1.dist-info/LICENSE
 Comment: 
 
-Filename: megfile-2.0.6.dist-info/LICENSE.pyre
+Filename: megfile-2.0.6.post1.dist-info/LICENSE.pyre
 Comment: 
 
-Filename: megfile-2.0.6.dist-info/METADATA
+Filename: megfile-2.0.6.post1.dist-info/METADATA
 Comment: 
 
-Filename: megfile-2.0.6.dist-info/WHEEL
+Filename: megfile-2.0.6.post1.dist-info/WHEEL
 Comment: 
 
-Filename: megfile-2.0.6.dist-info/entry_points.txt
+Filename: megfile-2.0.6.post1.dist-info/entry_points.txt
 Comment: 
 
-Filename: megfile-2.0.6.dist-info/top_level.txt
+Filename: megfile-2.0.6.post1.dist-info/top_level.txt
 Comment: 
 
-Filename: megfile-2.0.6.dist-info/RECORD
+Filename: megfile-2.0.6.post1.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## megfile/errors.py

```diff
@@ -141,14 +141,16 @@
                 if after_callback is not None:
                     result = after_callback(result, *args, **kwargs)
                 if error is not None:
                     _logger.debug(  # pragma: no cover
                         'unknown error resolved: %s, with %d tries' %
                         (full_error_message(error), retries))
                 return result
+            except EOFError as eof_exception:
+                raise eof_exception  # pragma: no cover
             except Exception as exception:
                 if retry_callback is not None:
                     retry_callback(error, *args, **kwargs)
                 error = exception
                 if retries == max_retries or not should_retry(error):
                     raise
                 retry_interval = min(0.1 * 2**retries, 30)
```

## megfile/fs_path.py

```diff
@@ -3,21 +3,21 @@
 import os
 import pathlib
 import shutil
 from stat import S_ISDIR as stat_isdir
 from stat import S_ISLNK as stat_islnk
 from typing import IO, AnyStr, BinaryIO, Callable, Iterator, List, Optional, Tuple, Union
 from unittest.mock import patch
-from urllib.parse import urlsplit
 
 from megfile.errors import _create_missing_ok_generator
 from megfile.interfaces import Access, ContextIterator, FileEntry, PathLike, StatResult
 from megfile.lib.compare import is_same_file
 from megfile.lib.compat import copytree
 from megfile.lib.glob import iglob
+from megfile.lib.url import get_url_scheme
 from megfile.utils import cachedproperty, calculate_md5
 
 from .interfaces import PathLike, URIPath
 from .lib.compat import fspath
 from .lib.joinpath import path_join
 from .smart_path import SmartPath
 
@@ -47,23 +47,25 @@
         mtime=stat.st_mtime,
         isdir=stat_isdir(stat.st_mode),
         islnk=stat_islnk(stat.st_mode),
         extra=stat,
     )
 
 
-def is_fs(path: PathLike) -> bool:
+def is_fs(path: Union["PathLike", int]) -> bool:
     '''Test if a path is fs path
 
     :param path: Path to be tested
     :returns: True of a path is fs path, else False
     '''
+    if isinstance(path, int):
+        return True
     path = fspath(path)
-    parts = urlsplit(path)
-    return parts.scheme == '' or parts.scheme == 'file'
+    scheme = get_url_scheme(path)
+    return scheme == '' or scheme == 'file'
 
 
 def fs_path_join(path: PathLike, *other_paths: PathLike) -> str:
     return path_join(fspath(path), *map(fspath, other_paths))
 
 
 def fs_readlink(path) -> str:
```

## megfile/http_path.py

```diff
@@ -1,19 +1,19 @@
 import time
 from functools import partial
 from io import BufferedReader
 from logging import getLogger as get_logger
 from typing import Iterable
-from urllib.parse import urlsplit
 
 import requests
 
 from megfile.errors import http_should_retry, patch_method, translate_http_error
 from megfile.interfaces import PathLike, StatResult, URIPath
 from megfile.lib.compat import fspath
+from megfile.lib.url import get_url_scheme
 from megfile.smart_path import SmartPath
 from megfile.utils import binary_open
 
 __all__ = [
     'HttpPath',
     'HttpsPath',
     'get_http_session',
@@ -56,16 +56,16 @@
     '''
 
     path = fspath(path)
     if not isinstance(path, str) or not (path.startswith('http://') or
                                          path.startswith('https://')):
         return False
 
-    parts = urlsplit(path)
-    return parts.scheme == 'http' or parts.scheme == 'https'
+    scheme = get_url_scheme(path)
+    return scheme == 'http' or scheme == 'https'
 
 
 @SmartPath.register
 class HttpPath(URIPath):
 
     protocol = "http"
```

## megfile/s3_path.py

```diff
@@ -12,5308 +12,5308 @@
 000000b0: 6173 2067 6574 5f6c 6f67 6765 720a 6672  as get_logger.fr
 000000c0: 6f6d 2074 7970 696e 6720 696d 706f 7274  om typing import
 000000d0: 2049 4f2c 2041 6e79 2c20 416e 7953 7472   IO, Any, AnyStr
 000000e0: 2c20 4269 6e61 7279 494f 2c20 4361 6c6c  , BinaryIO, Call
 000000f0: 6162 6c65 2c20 4469 6374 2c20 4974 6572  able, Dict, Iter
 00000100: 6174 6f72 2c20 4c69 7374 2c20 4f70 7469  ator, List, Opti
 00000110: 6f6e 616c 2c20 5475 706c 652c 2055 6e69  onal, Tuple, Uni
-00000120: 6f6e 0a66 726f 6d20 7572 6c6c 6962 2e70  on.from urllib.p
-00000130: 6172 7365 2069 6d70 6f72 7420 7572 6c73  arse import urls
-00000140: 706c 6974 0a0a 696d 706f 7274 2062 6f74  plit..import bot
-00000150: 6f33 0a69 6d70 6f72 7420 626f 746f 636f  o3.import botoco
-00000160: 7265 0a66 726f 6d20 626f 746f 636f 7265  re.from botocore
-00000170: 2e61 7773 7265 7175 6573 7420 696d 706f  .awsrequest impo
-00000180: 7274 2041 5753 5265 7370 6f6e 7365 0a0a  rt AWSResponse..
-00000190: 6672 6f6d 206d 6567 6669 6c65 2e65 7272  from megfile.err
-000001a0: 6f72 7320 696d 706f 7274 2053 3342 7563  ors import S3Buc
-000001b0: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
-000001c0: 2c20 5333 436f 6e66 6967 4572 726f 722c  , S3ConfigError,
-000001d0: 2053 3346 696c 6545 7869 7374 7345 7272   S3FileExistsErr
-000001e0: 6f72 2c20 5333 4669 6c65 4e6f 7446 6f75  or, S3FileNotFou
-000001f0: 6e64 4572 726f 722c 2053 3349 7341 4469  ndError, S3IsADi
-00000200: 7265 6374 6f72 7945 7272 6f72 2c20 5333  rectoryError, S3
-00000210: 4e61 6d65 546f 6f4c 6f6e 6745 7272 6f72  NameTooLongError
-00000220: 2c20 5333 4e6f 7441 4469 7265 6374 6f72  , S3NotADirector
-00000230: 7945 7272 6f72 2c20 5333 4e6f 7441 4c69  yError, S3NotALi
-00000240: 6e6b 4572 726f 722c 2053 3350 6572 6d69  nkError, S3Permi
-00000250: 7373 696f 6e45 7272 6f72 2c20 5333 556e  ssionError, S3Un
-00000260: 6b6e 6f77 6e45 7272 6f72 2c20 556e 7375  knownError, Unsu
-00000270: 7070 6f72 7465 6445 7272 6f72 2c20 5f63  pportedError, _c
-00000280: 7265 6174 655f 6d69 7373 696e 675f 6f6b  reate_missing_ok
-00000290: 5f67 656e 6572 6174 6f72 0a66 726f 6d20  _generator.from 
-000002a0: 6d65 6766 696c 652e 6572 726f 7273 2069  megfile.errors i
-000002b0: 6d70 6f72 7420 5f6c 6f67 6765 7220 6173  mport _logger as
-000002c0: 2065 7272 6f72 5f6c 6f67 6765 720a 6672   error_logger.fr
-000002d0: 6f6d 206d 6567 6669 6c65 2e65 7272 6f72  om megfile.error
-000002e0: 7320 696d 706f 7274 2070 6174 6368 5f6d  s import patch_m
-000002f0: 6574 686f 642c 2072 6169 7365 5f73 335f  ethod, raise_s3_
-00000300: 6572 726f 722c 2073 335f 6572 726f 725f  error, s3_error_
-00000310: 636f 6465 5f73 686f 756c 645f 7265 7472  code_should_retr
-00000320: 792c 2073 335f 7368 6f75 6c64 5f72 6574  y, s3_should_ret
-00000330: 7279 2c20 7472 616e 736c 6174 655f 6673  ry, translate_fs
-00000340: 5f65 7272 6f72 2c20 7472 616e 736c 6174  _error, translat
-00000350: 655f 7333 5f65 7272 6f72 0a66 726f 6d20  e_s3_error.from 
-00000360: 6d65 6766 696c 652e 696e 7465 7266 6163  megfile.interfac
-00000370: 6573 2069 6d70 6f72 7420 4163 6365 7373  es import Access
-00000380: 2c20 436f 6e74 6578 7449 7465 7261 746f  , ContextIterato
-00000390: 722c 2046 696c 6543 6163 6865 722c 2046  r, FileCacher, F
-000003a0: 696c 6545 6e74 7279 2c20 5061 7468 4c69  ileEntry, PathLi
-000003b0: 6b65 2c20 5374 6174 5265 7375 6c74 2c20  ke, StatResult, 
-000003c0: 5552 4950 6174 680a 6672 6f6d 206d 6567  URIPath.from meg
-000003d0: 6669 6c65 2e6c 6962 2e63 6f6d 7061 7265  file.lib.compare
-000003e0: 2069 6d70 6f72 7420 6973 5f73 616d 655f   import is_same_
-000003f0: 6669 6c65 0a66 726f 6d20 6d65 6766 696c  file.from megfil
-00000400: 652e 6c69 622e 636f 6d70 6174 2069 6d70  e.lib.compat imp
-00000410: 6f72 7420 6673 7061 7468 0a66 726f 6d20  ort fspath.from 
-00000420: 6d65 6766 696c 652e 6c69 622e 666e 6d61  megfile.lib.fnma
-00000430: 7463 6820 696d 706f 7274 2074 7261 6e73  tch import trans
-00000440: 6c61 7465 0a66 726f 6d20 6d65 6766 696c  late.from megfil
-00000450: 652e 6c69 622e 676c 6f62 2069 6d70 6f72  e.lib.glob impor
-00000460: 7420 6861 735f 6d61 6769 632c 2068 6173  t has_magic, has
-00000470: 5f6d 6167 6963 5f69 676e 6f72 655f 6272  _magic_ignore_br
-00000480: 6163 652c 2075 6e67 6c6f 626c 697a 650a  ace, ungloblize.
-00000490: 6672 6f6d 206d 6567 6669 6c65 2e6c 6962  from megfile.lib
-000004a0: 2e6a 6f69 6e70 6174 6820 696d 706f 7274  .joinpath import
-000004b0: 2075 7269 5f6a 6f69 6e0a 6672 6f6d 206d   uri_join.from m
-000004c0: 6567 6669 6c65 2e6c 6962 2e73 335f 6275  egfile.lib.s3_bu
-000004d0: 6666 6572 6564 5f77 7269 7465 7220 696d  ffered_writer im
-000004e0: 706f 7274 2044 4546 4155 4c54 5f4d 4158  port DEFAULT_MAX
-000004f0: 5f42 5546 4645 525f 5349 5a45 2c20 474c  _BUFFER_SIZE, GL
-00000500: 4f42 414c 5f4d 4158 5f57 4f52 4b45 5253  OBAL_MAX_WORKERS
-00000510: 2c20 5333 4275 6666 6572 6564 5772 6974  , S3BufferedWrit
-00000520: 6572 0a66 726f 6d20 6d65 6766 696c 652e  er.from megfile.
-00000530: 6c69 622e 7333 5f63 6163 6865 645f 6861  lib.s3_cached_ha
-00000540: 6e64 6c65 7220 696d 706f 7274 2053 3343  ndler import S3C
-00000550: 6163 6865 6448 616e 646c 6572 0a66 726f  achedHandler.fro
-00000560: 6d20 6d65 6766 696c 652e 6c69 622e 7333  m megfile.lib.s3
-00000570: 5f6c 696d 6974 6564 5f73 6565 6b61 626c  _limited_seekabl
-00000580: 655f 7772 6974 6572 2069 6d70 6f72 7420  e_writer import 
-00000590: 5333 4c69 6d69 7465 6453 6565 6b61 626c  S3LimitedSeekabl
-000005a0: 6557 7269 7465 720a 6672 6f6d 206d 6567  eWriter.from meg
-000005b0: 6669 6c65 2e6c 6962 2e73 335f 6d65 6d6f  file.lib.s3_memo
-000005c0: 7279 5f68 616e 646c 6572 2069 6d70 6f72  ry_handler impor
-000005d0: 7420 5333 4d65 6d6f 7279 4861 6e64 6c65  t S3MemoryHandle
-000005e0: 720a 6672 6f6d 206d 6567 6669 6c65 2e6c  r.from megfile.l
-000005f0: 6962 2e73 335f 7069 7065 5f68 616e 646c  ib.s3_pipe_handl
-00000600: 6572 2069 6d70 6f72 7420 5333 5069 7065  er import S3Pipe
-00000610: 4861 6e64 6c65 720a 6672 6f6d 206d 6567  Handler.from meg
-00000620: 6669 6c65 2e6c 6962 2e73 335f 7072 6566  file.lib.s3_pref
-00000630: 6574 6368 5f72 6561 6465 7220 696d 706f  etch_reader impo
-00000640: 7274 2044 4546 4155 4c54 5f42 4c4f 434b  rt DEFAULT_BLOCK
-00000650: 5f53 495a 452c 2053 3350 7265 6665 7463  _SIZE, S3Prefetc
-00000660: 6852 6561 6465 720a 6672 6f6d 206d 6567  hReader.from meg
-00000670: 6669 6c65 2e6c 6962 2e73 335f 7368 6172  file.lib.s3_shar
-00000680: 655f 6361 6368 655f 7265 6164 6572 2069  e_cache_reader i
-00000690: 6d70 6f72 7420 5333 5368 6172 6543 6163  mport S3ShareCac
-000006a0: 6865 5265 6164 6572 0a66 726f 6d20 6d65  heReader.from me
-000006b0: 6766 696c 652e 736d 6172 745f 7061 7468  gfile.smart_path
-000006c0: 2069 6d70 6f72 7420 536d 6172 7450 6174   import SmartPat
-000006d0: 680a 6672 6f6d 206d 6567 6669 6c65 2e75  h.from megfile.u
-000006e0: 7469 6c73 2069 6d70 6f72 7420 6361 6368  tils import cach
-000006f0: 6564 7072 6f70 6572 7479 2c20 6361 6c63  edproperty, calc
-00000700: 756c 6174 655f 6d64 352c 2067 656e 6572  ulate_md5, gener
-00000710: 6174 655f 6361 6368 655f 7061 7468 2c20  ate_cache_path, 
-00000720: 6765 745f 6269 6e61 7279 5f6d 6f64 652c  get_binary_mode,
-00000730: 2067 6574 5f63 6f6e 7465 6e74 5f6f 6666   get_content_off
-00000740: 7365 742c 2069 735f 7265 6164 6162 6c65  set, is_readable
-00000750: 2c20 6e65 6365 7373 6172 795f 7061 7261  , necessary_para
-00000760: 6d73 2c20 7468 7265 6164 5f6c 6f63 616c  ms, thread_local
-00000770: 0a0a 5f5f 616c 6c5f 5f20 3d20 5b0a 2020  ..__all__ = [.  
-00000780: 2020 2753 3350 6174 6827 2c0a 2020 2020    'S3Path',.    
-00000790: 2770 6172 7365 5f73 335f 7572 6c27 2c0a  'parse_s3_url',.
-000007a0: 2020 2020 2767 6574 5f65 6e64 706f 696e      'get_endpoin
-000007b0: 745f 7572 6c27 2c0a 2020 2020 2767 6574  t_url',.    'get
-000007c0: 5f73 335f 7365 7373 696f 6e27 2c0a 2020  _s3_session',.  
-000007d0: 2020 2767 6574 5f73 335f 636c 6965 6e74    'get_s3_client
-000007e0: 272c 0a20 2020 2027 7333 5f70 6174 685f  ',.    's3_path_
-000007f0: 6a6f 696e 272c 0a20 2020 2027 6973 5f73  join',.    'is_s
-00000800: 3327 2c0a 2020 2020 2773 335f 6275 6666  3',.    's3_buff
-00000810: 6572 6564 5f6f 7065 6e27 2c0a 2020 2020  ered_open',.    
-00000820: 2773 335f 6361 6368 6564 5f6f 7065 6e27  's3_cached_open'
-00000830: 2c0a 2020 2020 2773 335f 646f 776e 6c6f  ,.    's3_downlo
-00000840: 6164 272c 0a20 2020 2027 7333 5f6d 656d  ad',.    's3_mem
-00000850: 6f72 795f 6f70 656e 272c 0a20 2020 2027  ory_open',.    '
-00000860: 7333 5f70 6970 655f 6f70 656e 272c 0a20  s3_pipe_open',. 
-00000870: 2020 2027 7333 5f70 7265 6665 7463 685f     's3_prefetch_
-00000880: 6f70 656e 272c 0a20 2020 2027 7333 5f73  open',.    's3_s
-00000890: 6861 7265 5f63 6163 6865 5f6f 7065 6e27  hare_cache_open'
-000008a0: 2c0a 2020 2020 2773 335f 6f70 656e 272c  ,.    's3_open',
-000008b0: 0a20 2020 2027 5333 4361 6368 6572 272c  .    'S3Cacher',
-000008c0: 0a20 2020 2027 5333 4275 6666 6572 6564  .    'S3Buffered
-000008d0: 5772 6974 6572 272c 0a20 2020 2027 5333  Writer',.    'S3
-000008e0: 4c69 6d69 7465 6453 6565 6b61 626c 6557  LimitedSeekableW
-000008f0: 7269 7465 7227 2c0a 2020 2020 2753 3350  riter',.    'S3P
-00000900: 7265 6665 7463 6852 6561 6465 7227 2c0a  refetchReader',.
-00000910: 2020 2020 2753 3353 6861 7265 4361 6368      'S3ShareCach
-00000920: 6552 6561 6465 7227 2c0a 2020 2020 2773  eReader',.    's
-00000930: 335f 7570 6c6f 6164 272c 0a20 2020 2027  3_upload',.    '
-00000940: 7333 5f64 6f77 6e6c 6f61 6427 2c0a 2020  s3_download',.  
-00000950: 2020 2773 335f 6c6f 6164 5f63 6f6e 7465    's3_load_conte
-00000960: 6e74 272c 0a20 2020 2027 7333 5f72 6561  nt',.    's3_rea
-00000970: 646c 696e 6b27 2c0a 2020 2020 2773 335f  dlink',.    's3_
-00000980: 676c 6f62 272c 0a20 2020 2027 7333 5f67  glob',.    's3_g
-00000990: 6c6f 625f 7374 6174 272c 0a20 2020 2027  lob_stat',.    '
-000009a0: 7333 5f69 676c 6f62 272c 0a20 2020 2027  s3_iglob',.    '
-000009b0: 7333 5f72 656e 616d 6527 2c0a 2020 2020  s3_rename',.    
-000009c0: 2773 335f 6d61 6b65 6469 7273 272c 0a20  's3_makedirs',. 
-000009d0: 2020 2027 7333 5f63 6f6e 6361 7427 2c0a     's3_concat',.
-000009e0: 5d0a 5f6c 6f67 6765 7220 3d20 6765 745f  ]._logger = get_
-000009f0: 6c6f 6767 6572 285f 5f6e 616d 655f 5f29  logger(__name__)
-00000a00: 0a63 6f6e 7465 6e74 5f6d 6435 5f68 6561  .content_md5_hea
-00000a10: 6465 7220 3d20 276d 6567 6669 6c65 2d63  der = 'megfile-c
-00000a20: 6f6e 7465 6e74 2d6d 6435 270a 656e 6470  ontent-md5'.endp
-00000a30: 6f69 6e74 5f75 726c 203d 2027 6874 7470  oint_url = 'http
-00000a40: 733a 2f2f 7333 2e61 6d61 7a6f 6e61 7773  s://s3.amazonaws
-00000a50: 2e63 6f6d 270a 6d61 785f 706f 6f6c 5f63  .com'.max_pool_c
-00000a60: 6f6e 6e65 6374 696f 6e73 203d 2033 320a  onnections = 32.
-00000a70: 6d61 785f 7265 7472 6965 7320 3d20 3130  max_retries = 10
-00000a80: 0a6d 6178 5f6b 6579 7320 3d20 3130 3030  .max_keys = 1000
-00000a90: 0a0a 0a64 6566 205f 7061 7463 685f 6d61  ...def _patch_ma
-00000aa0: 6b65 5f72 6571 7565 7374 2863 6c69 656e  ke_request(clien
-00000ab0: 743a 2062 6f74 6f63 6f72 652e 636c 6965  t: botocore.clie
-00000ac0: 6e74 2e42 6173 6543 6c69 656e 7429 3a0a  nt.BaseClient):.
-00000ad0: 0a20 2020 2064 6566 2061 6674 6572 5f63  .    def after_c
-00000ae0: 616c 6c62 6163 6b28 7265 7375 6c74 3a20  allback(result: 
-00000af0: 5475 706c 655b 4157 5352 6573 706f 6e73  Tuple[AWSRespons
-00000b00: 652c 2064 6963 745d 2c20 2a61 7267 732c  e, dict], *args,
-00000b10: 202a 2a6b 7761 7267 7329 3a0a 2020 2020   **kwargs):.    
-00000b20: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-00000b30: 7461 6e63 6528 7265 7375 6c74 2c20 7475  tance(result, tu
-00000b40: 706c 6529 206f 7220 6c65 6e28 7265 7375  ple) or len(resu
-00000b50: 6c74 2920 213d 2032 205c 0a20 2020 2020  lt) != 2 \.     
-00000b60: 2020 2020 2020 206f 7220 6e6f 7420 6973         or not is
-00000b70: 696e 7374 616e 6365 2872 6573 756c 745b  instance(result[
-00000b80: 305d 2c20 4157 5352 6573 706f 6e73 6529  0], AWSResponse)
-00000b90: 206f 7220 6e6f 7420 6973 696e 7374 616e   or not isinstan
-00000ba0: 6365 2872 6573 756c 745b 315d 2c20 6469  ce(result[1], di
-00000bb0: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-00000bc0: 2072 6574 7572 6e20 7265 7375 6c74 0a20   return result. 
-00000bd0: 2020 2020 2020 2068 7474 702c 2070 6172         http, par
-00000be0: 7365 645f 7265 7370 6f6e 7365 203d 2072  sed_response = r
-00000bf0: 6573 756c 740a 2020 2020 2020 2020 6966  esult.        if
-00000c00: 2068 7474 702e 7374 6174 7573 5f63 6f64   http.status_cod
-00000c10: 6520 3e3d 2035 3030 3a0a 2020 2020 2020  e >= 500:.      
-00000c20: 2020 2020 2020 6572 726f 725f 636f 6465        error_code
-00000c30: 203d 2070 6172 7365 645f 7265 7370 6f6e   = parsed_respon
-00000c40: 7365 2e67 6574 2822 4572 726f 7222 2c20  se.get("Error", 
-00000c50: 7b7d 292e 6765 7428 2243 6f64 6522 290a  {}).get("Code").
-00000c60: 2020 2020 2020 2020 2020 2020 6f70 6572              oper
-00000c70: 6174 696f 6e5f 6d6f 6465 6c20 3d20 6b77  ation_model = kw
-00000c80: 6172 6773 2e67 6574 2827 6f70 6572 6174  args.get('operat
-00000c90: 696f 6e5f 6d6f 6465 6c27 2920 6f72 2028  ion_model') or (
-00000ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000cb0: 2061 7267 735b 305d 2069 6620 6172 6773   args[0] if args
-00000cc0: 2065 6c73 6520 4e6f 6e65 290a 2020 2020   else None).    
-00000cd0: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
-00000ce0: 6e5f 6e61 6d65 203d 206f 7065 7261 7469  n_name = operati
-00000cf0: 6f6e 5f6d 6f64 656c 2e6e 616d 6520 6966  on_model.name if
-00000d00: 206f 7065 7261 7469 6f6e 5f6d 6f64 656c   operation_model
-00000d10: 2065 6c73 6520 2750 726f 7879 4d65 7468   else 'ProxyMeth
-00000d20: 6f64 270a 2020 2020 2020 2020 2020 2020  od'.            
-00000d30: 6572 726f 725f 636c 6173 7320 3d20 636c  error_class = cl
-00000d40: 6965 6e74 2e65 7863 6570 7469 6f6e 732e  ient.exceptions.
-00000d50: 6672 6f6d 5f63 6f64 6528 6572 726f 725f  from_code(error_
-00000d60: 636f 6465 290a 2020 2020 2020 2020 2020  code).          
-00000d70: 2020 7261 6973 6520 6572 726f 725f 636c    raise error_cl
-00000d80: 6173 7328 7061 7273 6564 5f72 6573 706f  ass(parsed_respo
-00000d90: 6e73 652c 206f 7065 7261 7469 6f6e 5f6e  nse, operation_n
-00000da0: 616d 6529 0a20 2020 2020 2020 2072 6574  ame).        ret
-00000db0: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
-00000dc0: 6465 6620 7265 7472 795f 6361 6c6c 6261  def retry_callba
-00000dd0: 636b 2865 7272 6f72 2c20 6f70 6572 6174  ck(error, operat
-00000de0: 696f 6e5f 6d6f 6465 6c2c 2072 6571 7565  ion_model, reque
-00000df0: 7374 5f64 6963 742c 2072 6571 7565 7374  st_dict, request
-00000e00: 5f63 6f6e 7465 7874 293a 0a20 2020 2020  _context):.     
-00000e10: 2020 2069 6620 6572 726f 7220 6973 204e     if error is N
-00000e20: 6f6e 653a 2020 2320 7265 7472 7920 666f  one:  # retry fo
-00000e30: 7220 7468 6520 6669 7273 7420 7469 6d65  r the first time
-00000e40: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
-00000e50: 6f72 5f6c 6f67 6765 722e 6465 6275 6728  or_logger.debug(
-00000e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000e70: 2027 6661 696c 6564 2074 6f20 7072 6f63   'failed to proc
-00000e80: 6573 733a 2025 722c 2077 6974 6820 7061  ess: %r, with pa
-00000e90: 7261 6d65 7465 7273 3a20 2573 272c 0a20  rameters: %s',. 
-00000ea0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00000eb0: 7065 7261 7469 6f6e 5f6d 6f64 656c 2e6e  peration_model.n
-00000ec0: 616d 652c 2072 6571 7565 7374 5f64 6963  ame, request_dic
-00000ed0: 7429 0a20 2020 2020 2020 2069 6620 6973  t).        if is
-00000ee0: 5f72 6561 6461 626c 6528 7265 7175 6573  _readable(reques
-00000ef0: 745f 6469 6374 5b27 626f 6479 275d 293a  t_dict['body']):
-00000f00: 0a20 2020 2020 2020 2020 2020 2072 6571  .            req
-00000f10: 7565 7374 5f64 6963 745b 2762 6f64 7927  uest_dict['body'
-00000f20: 5d2e 7365 656b 2830 290a 0a20 2020 2064  ].seek(0)..    d
-00000f30: 6566 2062 6566 6f72 655f 6361 6c6c 6261  ef before_callba
-00000f40: 636b 286f 7065 7261 7469 6f6e 5f6d 6f64  ck(operation_mod
-00000f50: 656c 2c20 7265 7175 6573 745f 6469 6374  el, request_dict
-00000f60: 2c20 7265 7175 6573 745f 636f 6e74 6578  , request_contex
-00000f70: 7429 3a0a 2020 2020 2020 2020 5f6c 6f67  t):.        _log
-00000f80: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
-00000f90: 2020 2020 2020 2027 7365 6e64 2073 3320         'send s3 
-00000fa0: 7265 7175 6573 743a 2025 722c 2077 6974  request: %r, wit
-00000fb0: 6820 7061 7261 6d65 7465 7273 3a20 2573  h parameters: %s
-00000fc0: 272c 206f 7065 7261 7469 6f6e 5f6d 6f64  ', operation_mod
-00000fd0: 656c 2e6e 616d 652c 0a20 2020 2020 2020  el.name,.       
-00000fe0: 2020 2020 2072 6571 7565 7374 5f64 6963       request_dic
-00000ff0: 7429 0a0a 2020 2020 636c 6965 6e74 2e5f  t)..    client._
-00001000: 6d61 6b65 5f72 6571 7565 7374 203d 2070  make_request = p
-00001010: 6174 6368 5f6d 6574 686f 6428 0a20 2020  atch_method(.   
-00001020: 2020 2020 2063 6c69 656e 742e 5f6d 616b       client._mak
-00001030: 655f 7265 7175 6573 742c 0a20 2020 2020  e_request,.     
-00001040: 2020 206d 6178 5f72 6574 7269 6573 3d6d     max_retries=m
-00001050: 6178 5f72 6574 7269 6573 2c0a 2020 2020  ax_retries,.    
-00001060: 2020 2020 7368 6f75 6c64 5f72 6574 7279      should_retry
-00001070: 3d73 335f 7368 6f75 6c64 5f72 6574 7279  =s3_should_retry
-00001080: 2c0a 2020 2020 2020 2020 6166 7465 725f  ,.        after_
-00001090: 6361 6c6c 6261 636b 3d61 6674 6572 5f63  callback=after_c
-000010a0: 616c 6c62 6163 6b2c 0a20 2020 2020 2020  allback,.       
-000010b0: 2062 6566 6f72 655f 6361 6c6c 6261 636b   before_callback
-000010c0: 3d62 6566 6f72 655f 6361 6c6c 6261 636b  =before_callback
-000010d0: 2c0a 2020 2020 2020 2020 7265 7472 795f  ,.        retry_
-000010e0: 6361 6c6c 6261 636b 3d72 6574 7279 5f63  callback=retry_c
-000010f0: 616c 6c62 6163 6b29 0a20 2020 2072 6574  allback).    ret
-00001100: 7572 6e20 636c 6965 6e74 0a0a 0a64 6566  urn client...def
-00001110: 2070 6172 7365 5f73 335f 7572 6c28 7333   parse_s3_url(s3
-00001120: 5f75 726c 3a20 5061 7468 4c69 6b65 2920  _url: PathLike) 
-00001130: 2d3e 2054 7570 6c65 5b73 7472 2c20 7374  -> Tuple[str, st
-00001140: 725d 3a0a 2020 2020 7333 5f75 726c 203d  r]:.    s3_url =
-00001150: 2066 7370 6174 6828 7333 5f75 726c 290a   fspath(s3_url).
-00001160: 2020 2020 6966 206e 6f74 2069 735f 7333      if not is_s3
-00001170: 2873 335f 7572 6c29 3a0a 2020 2020 2020  (s3_url):.      
-00001180: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00001190: 6f72 2827 4e6f 7420 6120 7333 2075 726c  or('Not a s3 url
-000011a0: 3a20 2572 2720 2520 7333 5f75 726c 290a  : %r' % s3_url).
-000011b0: 2020 2020 7269 6768 7470 6172 7420 3d20      rightpart = 
-000011c0: 7333 5f75 726c 2e73 706c 6974 2827 3a2f  s3_url.split(':/
-000011d0: 2f27 2c20 6d61 7873 706c 6974 3d31 295b  /', maxsplit=1)[
-000011e0: 315d 0a20 2020 2062 7563 6b65 746d 6174  1].    bucketmat
-000011f0: 6368 203d 2072 652e 6d61 7463 6828 2728  ch = re.match('(
-00001200: 2e2a 3f29 2f27 2c20 7269 6768 7470 6172  .*?)/', rightpar
-00001210: 7429 0a20 2020 2069 6620 6275 636b 6574  t).    if bucket
-00001220: 6d61 7463 6820 6973 204e 6f6e 653a 0a20  match is None:. 
-00001230: 2020 2020 2020 2062 7563 6b65 7420 3d20         bucket = 
-00001240: 7269 6768 7470 6172 740a 2020 2020 2020  rightpart.      
-00001250: 2020 7061 7468 203d 2027 270a 2020 2020    path = ''.    
-00001260: 656c 7365 3a0a 2020 2020 2020 2020 6275  else:.        bu
-00001270: 636b 6574 203d 2062 7563 6b65 746d 6174  cket = bucketmat
-00001280: 6368 2e67 726f 7570 2831 290a 2020 2020  ch.group(1).    
-00001290: 2020 2020 7061 7468 203d 2072 6967 6874      path = right
-000012a0: 7061 7274 5b6c 656e 2862 7563 6b65 7429  part[len(bucket)
-000012b0: 202b 2031 3a5d 0a20 2020 2072 6574 7572   + 1:].    retur
-000012c0: 6e20 6275 636b 6574 2c20 7061 7468 0a0a  n bucket, path..
-000012d0: 0a64 6566 2067 6574 5f73 636f 7065 645f  .def get_scoped_
-000012e0: 636f 6e66 6967 2870 726f 6669 6c65 5f6e  config(profile_n
-000012f0: 616d 653a 204f 7074 696f 6e61 6c5b 7374  ame: Optional[st
-00001300: 725d 203d 204e 6f6e 6529 202d 3e20 4469  r] = None) -> Di
-00001310: 6374 3a0a 2020 2020 7265 7475 726e 2067  ct:.    return g
-00001320: 6574 5f73 335f 7365 7373 696f 6e28 0a20  et_s3_session(. 
-00001330: 2020 2020 2020 2070 726f 6669 6c65 5f6e         profile_n
-00001340: 616d 653d 7072 6f66 696c 655f 6e61 6d65  ame=profile_name
-00001350: 292e 5f73 6573 7369 6f6e 2e67 6574 5f73  )._session.get_s
-00001360: 636f 7065 645f 636f 6e66 6967 2829 0a0a  coped_config()..
-00001370: 0a40 6c72 755f 6361 6368 6528 290a 6465  .@lru_cache().de
-00001380: 6620 7761 726e 696e 675f 656e 6470 6f69  f warning_endpoi
-00001390: 6e74 5f75 726c 286b 6579 3a20 7374 722c  nt_url(key: str,
-000013a0: 2065 6e64 706f 696e 745f 7572 6c3a 2073   endpoint_url: s
-000013b0: 7472 293a 0a20 2020 205f 6c6f 6767 6572  tr):.    _logger
-000013c0: 2e69 6e66 6f28 2275 7369 6e67 2025 733a  .info("using %s:
-000013d0: 2025 7322 2025 2028 6b65 792c 2065 6e64   %s" % (key, end
-000013e0: 706f 696e 745f 7572 6c29 290a 0a0a 6465  point_url))...de
-000013f0: 6620 6765 745f 656e 6470 6f69 6e74 5f75  f get_endpoint_u
-00001400: 726c 2870 726f 6669 6c65 5f6e 616d 653a  rl(profile_name:
-00001410: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00001420: 204e 6f6e 6529 202d 3e20 7374 723a 0a20   None) -> str:. 
-00001430: 2020 2027 2727 4765 7420 7468 6520 656e     '''Get the en
-00001440: 6470 6f69 6e74 2075 726c 206f 6620 5333  dpoint url of S3
-00001450: 0a0a 2020 2020 3a72 6574 7572 6e73 3a20  ..    :returns: 
-00001460: 5333 2065 6e64 706f 696e 7420 7572 6c0a  S3 endpoint url.
-00001470: 2020 2020 2727 270a 2020 2020 656e 7669      '''.    envi
-00001480: 726f 6e5f 6b65 7920 3d20 6627 7b70 726f  ron_key = f'{pro
-00001490: 6669 6c65 5f6e 616d 657d 5f5f 4f53 535f  file_name}__OSS_
-000014a0: 454e 4450 4f49 4e54 272e 7570 7065 7228  ENDPOINT'.upper(
-000014b0: 0a20 2020 2029 2069 6620 7072 6f66 696c  .    ) if profil
-000014c0: 655f 6e61 6d65 2065 6c73 6520 274f 5353  e_name else 'OSS
-000014d0: 5f45 4e44 504f 494e 5427 0a20 2020 2065  _ENDPOINT'.    e
-000014e0: 6e76 6972 6f6e 5f65 6e64 706f 696e 745f  nviron_endpoint_
-000014f0: 7572 6c20 3d20 6f73 2e65 6e76 6972 6f6e  url = os.environ
-00001500: 2e67 6574 2865 6e76 6972 6f6e 5f6b 6579  .get(environ_key
-00001510: 290a 2020 2020 6966 2065 6e76 6972 6f6e  ).    if environ
-00001520: 5f65 6e64 706f 696e 745f 7572 6c3a 0a20  _endpoint_url:. 
-00001530: 2020 2020 2020 2077 6172 6e69 6e67 5f65         warning_e
-00001540: 6e64 706f 696e 745f 7572 6c28 656e 7669  ndpoint_url(envi
-00001550: 726f 6e5f 6b65 792c 2065 6e76 6972 6f6e  ron_key, environ
-00001560: 5f65 6e64 706f 696e 745f 7572 6c29 0a20  _endpoint_url). 
-00001570: 2020 2020 2020 2072 6574 7572 6e20 656e         return en
-00001580: 7669 726f 6e5f 656e 6470 6f69 6e74 5f75  viron_endpoint_u
-00001590: 726c 0a20 2020 2074 7279 3a0a 2020 2020  rl.    try:.    
-000015a0: 2020 2020 636f 6e66 6967 5f65 6e64 706f      config_endpo
-000015b0: 696e 745f 7572 6c20 3d20 6765 745f 7363  int_url = get_sc
-000015c0: 6f70 6564 5f63 6f6e 6669 6728 7072 6f66  oped_config(prof
-000015d0: 696c 655f 6e61 6d65 3d70 726f 6669 6c65  ile_name=profile
-000015e0: 5f6e 616d 6529 2e67 6574 280a 2020 2020  _name).get(.    
-000015f0: 2020 2020 2020 2020 2773 3327 2c20 7b7d          's3', {}
-00001600: 292e 6765 7428 2765 6e64 706f 696e 745f  ).get('endpoint_
-00001610: 7572 6c27 290a 2020 2020 2020 2020 6966  url').        if
-00001620: 2063 6f6e 6669 675f 656e 6470 6f69 6e74   config_endpoint
-00001630: 5f75 726c 3a0a 2020 2020 2020 2020 2020  _url:.          
-00001640: 2020 7761 726e 696e 675f 656e 6470 6f69    warning_endpoi
-00001650: 6e74 5f75 726c 2827 7e2f 2e61 7773 2f63  nt_url('~/.aws/c
-00001660: 6f6e 6669 6727 2c20 636f 6e66 6967 5f65  onfig', config_e
-00001670: 6e64 706f 696e 745f 7572 6c29 0a20 2020  ndpoint_url).   
-00001680: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00001690: 636f 6e66 6967 5f65 6e64 706f 696e 745f  config_endpoint_
-000016a0: 7572 6c0a 2020 2020 6578 6365 7074 2062  url.    except b
-000016b0: 6f74 6f63 6f72 652e 6578 6365 7074 696f  otocore.exceptio
-000016c0: 6e73 2e50 726f 6669 6c65 4e6f 7446 6f75  ns.ProfileNotFou
-000016d0: 6e64 3a20 2023 2070 7261 676d 613a 206e  nd:  # pragma: n
-000016e0: 6f20 636f 7665 720a 2020 2020 2020 2020  o cover.        
-000016f0: 7061 7373 0a20 2020 2072 6574 7572 6e20  pass.    return 
-00001700: 656e 6470 6f69 6e74 5f75 726c 0a0a 0a64  endpoint_url...d
-00001710: 6566 2067 6574 5f73 335f 7365 7373 696f  ef get_s3_sessio
-00001720: 6e28 7072 6f66 696c 655f 6e61 6d65 3d4e  n(profile_name=N
-00001730: 6f6e 6529 3a0a 2020 2020 2727 2747 6574  one):.    '''Get
-00001740: 2053 3320 7365 7373 696f 6e0a 0a20 2020   S3 session..   
-00001750: 203a 7265 7475 726e 733a 2053 3320 7365   :returns: S3 se
-00001760: 7373 696f 6e0a 2020 2020 2727 270a 2020  ssion.    '''.  
-00001770: 2020 7265 7475 726e 2074 6872 6561 645f    return thread_
-00001780: 6c6f 6361 6c28 0a20 2020 2020 2020 2066  local(.        f
-00001790: 2773 335f 7365 7373 696f 6e3a 7b70 726f  's3_session:{pro
-000017a0: 6669 6c65 5f6e 616d 657d 272c 2062 6f74  file_name}', bot
-000017b0: 6f33 2e53 6573 7369 6f6e 2c20 7072 6f66  o3.Session, prof
-000017c0: 696c 655f 6e61 6d65 3d70 726f 6669 6c65  ile_name=profile
-000017d0: 5f6e 616d 6529 0a0a 0a64 6566 2067 6574  _name)...def get
-000017e0: 5f61 6363 6573 735f 746f 6b65 6e28 7072  _access_token(pr
-000017f0: 6f66 696c 655f 6e61 6d65 3d4e 6f6e 6529  ofile_name=None)
-00001800: 3a0a 2020 2020 6163 6365 7373 5f6b 6579  :.    access_key
-00001810: 5f65 6e76 5f6e 616d 6520 3d20 6622 7b70  _env_name = f"{p
-00001820: 726f 6669 6c65 5f6e 616d 657d 5f5f 4157  rofile_name}__AW
-00001830: 535f 4143 4345 5353 5f4b 4559 5f49 4422  S_ACCESS_KEY_ID"
-00001840: 2e75 7070 6572 280a 2020 2020 2920 6966  .upper(.    ) if
-00001850: 2070 726f 6669 6c65 5f6e 616d 6520 656c   profile_name el
-00001860: 7365 2022 4157 535f 4143 4345 5353 5f4b  se "AWS_ACCESS_K
-00001870: 4559 5f49 4422 0a20 2020 2073 6563 7265  EY_ID".    secre
-00001880: 745f 6b65 795f 656e 765f 6e61 6d65 203d  t_key_env_name =
-00001890: 2066 227b 7072 6f66 696c 655f 6e61 6d65   f"{profile_name
-000018a0: 7d5f 5f41 5753 5f53 4543 5245 545f 4143  }__AWS_SECRET_AC
-000018b0: 4345 5353 5f4b 4559 222e 7570 7065 7228  CESS_KEY".upper(
-000018c0: 0a20 2020 2029 2069 6620 7072 6f66 696c  .    ) if profil
-000018d0: 655f 6e61 6d65 2065 6c73 6520 2241 5753  e_name else "AWS
-000018e0: 5f53 4543 5245 545f 4143 4345 5353 5f4b  _SECRET_ACCESS_K
-000018f0: 4559 220a 2020 2020 6163 6365 7373 5f6b  EY".    access_k
-00001900: 6579 203d 206f 732e 6765 7465 6e76 2861  ey = os.getenv(a
-00001910: 6363 6573 735f 6b65 795f 656e 765f 6e61  ccess_key_env_na
-00001920: 6d65 290a 2020 2020 7365 6372 6574 5f6b  me).    secret_k
-00001930: 6579 203d 206f 732e 6765 7465 6e76 2873  ey = os.getenv(s
-00001940: 6563 7265 745f 6b65 795f 656e 765f 6e61  ecret_key_env_na
-00001950: 6d65 290a 2020 2020 6966 2061 6363 6573  me).    if acces
-00001960: 735f 6b65 7920 616e 6420 7365 6372 6574  s_key and secret
-00001970: 5f6b 6579 3a0a 2020 2020 2020 2020 7265  _key:.        re
-00001980: 7475 726e 2061 6363 6573 735f 6b65 792c  turn access_key,
-00001990: 2073 6563 7265 745f 6b65 790a 0a20 2020   secret_key..   
-000019a0: 2063 7265 6465 6e74 6961 6c73 203d 2067   credentials = g
-000019b0: 6574 5f73 335f 7365 7373 696f 6e28 7072  et_s3_session(pr
-000019c0: 6f66 696c 655f 6e61 6d65 3d70 726f 6669  ofile_name=profi
-000019d0: 6c65 5f6e 616d 6529 2e67 6574 5f63 7265  le_name).get_cre
-000019e0: 6465 6e74 6961 6c73 2829 0a20 2020 2069  dentials().    i
-000019f0: 6620 6372 6564 656e 7469 616c 733a 0a20  f credentials:. 
-00001a00: 2020 2020 2020 2069 6620 6e6f 7420 6163         if not ac
-00001a10: 6365 7373 5f6b 6579 3a0a 2020 2020 2020  cess_key:.      
-00001a20: 2020 2020 2020 6163 6365 7373 5f6b 6579        access_key
-00001a30: 203d 2063 7265 6465 6e74 6961 6c73 2e61   = credentials.a
-00001a40: 6363 6573 735f 6b65 790a 2020 2020 2020  ccess_key.      
-00001a50: 2020 6966 206e 6f74 2073 6563 7265 745f    if not secret_
-00001a60: 6b65 793a 0a20 2020 2020 2020 2020 2020  key:.           
-00001a70: 2073 6563 7265 745f 6b65 7920 3d20 6372   secret_key = cr
-00001a80: 6564 656e 7469 616c 732e 7365 6372 6574  edentials.secret
-00001a90: 5f6b 6579 0a20 2020 2072 6574 7572 6e20  _key.    return 
-00001aa0: 6163 6365 7373 5f6b 6579 2c20 7365 6372  access_key, secr
-00001ab0: 6574 5f6b 6579 0a0a 0a64 6566 2067 6574  et_key...def get
-00001ac0: 5f73 335f 636c 6965 6e74 280a 2020 2020  _s3_client(.    
-00001ad0: 2020 2020 636f 6e66 6967 3a20 4f70 7469      config: Opti
-00001ae0: 6f6e 616c 5b62 6f74 6f63 6f72 652e 636f  onal[botocore.co
-00001af0: 6e66 6967 2e43 6f6e 6669 675d 203d 204e  nfig.Config] = N
-00001b00: 6f6e 652c 0a20 2020 2020 2020 2063 6163  one,.        cac
-00001b10: 6865 5f6b 6579 3a20 4f70 7469 6f6e 616c  he_key: Optional
-00001b20: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
-00001b30: 2020 2020 2020 7072 6f66 696c 655f 6e61        profile_na
-00001b40: 6d65 3a20 4f70 7469 6f6e 616c 5b73 7472  me: Optional[str
-00001b50: 5d20 3d20 4e6f 6e65 293a 0a20 2020 2027  ] = None):.    '
-00001b60: 2727 4765 7420 5333 2063 6c69 656e 740a  ''Get S3 client.
-00001b70: 0a20 2020 203a 7265 7475 726e 733a 2053  .    :returns: S
-00001b80: 3320 636c 6965 6e74 0a20 2020 2027 2727  3 client.    '''
-00001b90: 0a20 2020 2069 6620 6361 6368 655f 6b65  .    if cache_ke
-00001ba0: 7920 6973 206e 6f74 204e 6f6e 653a 0a20  y is not None:. 
-00001bb0: 2020 2020 2020 2072 6574 7572 6e20 7468         return th
-00001bc0: 7265 6164 5f6c 6f63 616c 280a 2020 2020  read_local(.    
-00001bd0: 2020 2020 2020 2020 6361 6368 655f 6b65          cache_ke
-00001be0: 792c 2067 6574 5f73 335f 636c 6965 6e74  y, get_s3_client
-00001bf0: 2c20 636f 6e66 6967 3d63 6f6e 6669 672c  , config=config,
-00001c00: 2070 726f 6669 6c65 5f6e 616d 653d 7072   profile_name=pr
-00001c10: 6f66 696c 655f 6e61 6d65 290a 0a20 2020  ofile_name)..   
-00001c20: 2061 6363 6573 735f 6b65 792c 2073 6563   access_key, sec
-00001c30: 7265 745f 6b65 7920 3d20 6765 745f 6163  ret_key = get_ac
-00001c40: 6365 7373 5f74 6f6b 656e 2870 726f 6669  cess_token(profi
-00001c50: 6c65 5f6e 616d 6529 0a20 2020 2063 6c69  le_name).    cli
-00001c60: 656e 7420 3d20 6765 745f 7333 5f73 6573  ent = get_s3_ses
-00001c70: 7369 6f6e 2829 2e63 6c69 656e 7428 0a20  sion().client(. 
-00001c80: 2020 2020 2020 2027 7333 272c 0a20 2020         's3',.   
-00001c90: 2020 2020 2065 6e64 706f 696e 745f 7572       endpoint_ur
-00001ca0: 6c3d 6765 745f 656e 6470 6f69 6e74 5f75  l=get_endpoint_u
-00001cb0: 726c 2870 726f 6669 6c65 5f6e 616d 653d  rl(profile_name=
-00001cc0: 7072 6f66 696c 655f 6e61 6d65 292c 0a20  profile_name),. 
-00001cd0: 2020 2020 2020 2063 6f6e 6669 673d 636f         config=co
-00001ce0: 6e66 6967 2c0a 2020 2020 2020 2020 6177  nfig,.        aw
-00001cf0: 735f 6163 6365 7373 5f6b 6579 5f69 643d  s_access_key_id=
-00001d00: 6163 6365 7373 5f6b 6579 2c0a 2020 2020  access_key,.    
-00001d10: 2020 2020 6177 735f 7365 6372 6574 5f61      aws_secret_a
-00001d20: 6363 6573 735f 6b65 793d 7365 6372 6574  ccess_key=secret
-00001d30: 5f6b 6579 2c0a 2020 2020 290a 2020 2020  _key,.    ).    
-00001d40: 636c 6965 6e74 203d 205f 7061 7463 685f  client = _patch_
-00001d50: 6d61 6b65 5f72 6571 7565 7374 2863 6c69  make_request(cli
-00001d60: 656e 7429 0a20 2020 2072 6574 7572 6e20  ent).    return 
-00001d70: 636c 6965 6e74 0a0a 0a64 6566 2073 335f  client...def s3_
-00001d80: 7061 7468 5f6a 6f69 6e28 7061 7468 3a20  path_join(path: 
-00001d90: 5061 7468 4c69 6b65 2c20 2a6f 7468 6572  PathLike, *other
-00001da0: 5f70 6174 6873 3a20 5061 7468 4c69 6b65  _paths: PathLike
-00001db0: 2920 2d3e 2073 7472 3a0a 2020 2020 2727  ) -> str:.    ''
-00001dc0: 270a 2020 2020 436f 6e63 6174 2032 206f  '.    Concat 2 o
-00001dd0: 7220 6d6f 7265 2070 6174 6820 746f 2061  r more path to a
-00001de0: 2063 6f6d 706c 6574 6520 7061 7468 0a0a   complete path..
-00001df0: 2020 2020 3a70 6172 616d 2070 6174 683a      :param path:
-00001e00: 2047 6976 656e 2070 6174 680a 2020 2020   Given path.    
-00001e10: 3a70 6172 616d 206f 7468 6572 5f70 6174  :param other_pat
-00001e20: 6873 3a20 5061 7468 7320 746f 2062 6520  hs: Paths to be 
-00001e30: 636f 6e63 6174 656e 6174 6564 0a20 2020  concatenated.   
-00001e40: 203a 7265 7475 726e 733a 2043 6f6e 6361   :returns: Conca
-00001e50: 7465 6e61 7465 6420 636f 6d70 6c65 7465  tenated complete
-00001e60: 2070 6174 680a 0a20 2020 202e 2e20 6e6f   path..    .. no
-00001e70: 7465 203a 3a0a 0a20 2020 2020 2020 2054  te ::..        T
-00001e80: 6865 2064 6966 6665 7265 6e63 6520 6265  he difference be
-00001e90: 7477 6565 6e20 7468 6973 2066 756e 6374  tween this funct
-00001ea0: 696f 6e20 616e 6420 6060 6f73 2e70 6174  ion and ``os.pat
-00001eb0: 682e 6a6f 696e 6060 2069 7320 7468 6174  h.join`` is that
-00001ec0: 2074 6869 7320 6675 6e63 7469 6f6e 2069   this function i
-00001ed0: 676e 6f72 6573 206c 6566 7420 7369 6465  gnores left side
-00001ee0: 2073 6c61 7368 2028 7768 6963 6820 696e   slash (which in
-00001ef0: 6469 6361 7465 7320 6162 736f 6c75 7465  dicates absolute
-00001f00: 2070 6174 6829 2069 6e20 6060 6f74 6865   path) in ``othe
-00001f10: 725f 7061 7468 7360 6020 616e 6420 7769  r_paths`` and wi
-00001f20: 6c6c 2064 6972 6563 746c 7920 636f 6e63  ll directly conc
-00001f30: 6174 2e0a 2020 2020 2020 2020 652e 672e  at..        e.g.
-00001f40: 206f 732e 7061 7468 2e6a 6f69 6e28 272f   os.path.join('/
-00001f50: 7061 7468 272c 2027 746f 272c 2027 2f66  path', 'to', '/f
-00001f60: 696c 6527 2920 3d3e 2027 2f66 696c 6527  ile') => '/file'
-00001f70: 2c20 6275 7420 7333 5f70 6174 685f 6a6f  , but s3_path_jo
-00001f80: 696e 2827 2f70 6174 6827 2c20 2774 6f27  in('/path', 'to'
-00001f90: 2c20 272f 6669 6c65 2729 203d 3e20 272f  , '/file') => '/
-00001fa0: 7061 7468 2f74 6f2f 6669 6c65 270a 2020  path/to/file'.  
-00001fb0: 2020 2727 270a 2020 2020 7265 7475 726e    '''.    return
-00001fc0: 2075 7269 5f6a 6f69 6e28 6673 7061 7468   uri_join(fspath
-00001fd0: 2870 6174 6829 2c20 2a6d 6170 2866 7370  (path), *map(fsp
-00001fe0: 6174 682c 206f 7468 6572 5f70 6174 6873  ath, other_paths
-00001ff0: 2929 0a0a 0a64 6566 205f 6c69 7374 5f61  ))...def _list_a
-00002000: 6c6c 5f62 7563 6b65 7473 2870 726f 6669  ll_buckets(profi
-00002010: 6c65 5f6e 616d 653a 204f 7074 696f 6e61  le_name: Optiona
-00002020: 6c5b 7374 725d 203d 204e 6f6e 6529 202d  l[str] = None) -
-00002030: 3e20 4c69 7374 5b73 7472 5d3a 0a20 2020  > List[str]:.   
-00002040: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
-00002050: 5f63 6c69 656e 7428 7072 6f66 696c 655f  _client(profile_
-00002060: 6e61 6d65 3d70 726f 6669 6c65 5f6e 616d  name=profile_nam
-00002070: 6529 0a20 2020 2072 6573 706f 6e73 6520  e).    response 
-00002080: 3d20 636c 6965 6e74 2e6c 6973 745f 6275  = client.list_bu
-00002090: 636b 6574 7328 290a 2020 2020 7265 7475  ckets().    retu
-000020a0: 726e 205b 636f 6e74 656e 745b 274e 616d  rn [content['Nam
-000020b0: 6527 5d20 666f 7220 636f 6e74 656e 7420  e'] for content 
-000020c0: 696e 2072 6573 706f 6e73 655b 2742 7563  in response['Buc
-000020d0: 6b65 7473 275d 5d0a 0a0a 6465 6620 5f70  kets']]...def _p
-000020e0: 6172 7365 5f73 335f 7572 6c5f 6967 6e6f  arse_s3_url_igno
-000020f0: 7265 5f62 7261 6365 2873 335f 7572 6c3a  re_brace(s3_url:
-00002100: 2073 7472 2920 2d3e 2054 7570 6c65 5b73   str) -> Tuple[s
-00002110: 7472 2c20 7374 725d 3a0a 2020 2020 7333  tr, str]:.    s3
-00002120: 5f75 726c 203d 2066 7370 6174 6828 7333  _url = fspath(s3
-00002130: 5f75 726c 290a 2020 2020 7333 5f73 6368  _url).    s3_sch
-00002140: 656d 652c 2072 6967 6874 7061 7274 203d  eme, rightpart =
-00002150: 2073 335f 7572 6c5b 3a35 5d2c 2073 335f   s3_url[:5], s3_
-00002160: 7572 6c5b 353a 5d0a 2020 2020 6966 2073  url[5:].    if s
-00002170: 335f 7363 6865 6d65 2021 3d20 2773 333a  3_scheme != 's3:
-00002180: 2f2f 273a 0a20 2020 2020 2020 2072 6169  //':.        rai
-00002190: 7365 2056 616c 7565 4572 726f 7228 274e  se ValueError('N
-000021a0: 6f74 2061 2073 3320 7572 6c3a 2025 7227  ot a s3 url: %r'
-000021b0: 2025 2073 335f 7572 6c29 0a20 2020 206c   % s3_url).    l
-000021c0: 6566 745f 6272 6163 6520 3d20 4661 6c73  eft_brace = Fals
-000021d0: 650a 2020 2020 666f 7220 6375 7272 656e  e.    for curren
-000021e0: 745f 696e 6465 782c 2063 7572 7265 6e74  t_index, current
-000021f0: 5f63 6861 7261 6374 6572 2069 6e20 656e  _character in en
-00002200: 756d 6572 6174 6528 7269 6768 7470 6172  umerate(rightpar
-00002210: 7429 3a0a 2020 2020 2020 2020 6966 2063  t):.        if c
-00002220: 7572 7265 6e74 5f63 6861 7261 6374 6572  urrent_character
-00002230: 203d 3d20 222f 2220 616e 6420 6c65 6674   == "/" and left
-00002240: 5f62 7261 6365 2069 7320 4661 6c73 653a  _brace is False:
-00002250: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00002260: 7572 6e20 7269 6768 7470 6172 745b 3a63  urn rightpart[:c
-00002270: 7572 7265 6e74 5f69 6e64 6578 5d2c 2072  urrent_index], r
-00002280: 6967 6874 7061 7274 5b63 7572 7265 6e74  ightpart[current
-00002290: 5f69 6e64 6578 202b 2031 3a5d 0a20 2020  _index + 1:].   
-000022a0: 2020 2020 2065 6c69 6620 6375 7272 656e       elif curren
-000022b0: 745f 6368 6172 6163 7465 7220 3d3d 2022  t_character == "
-000022c0: 7b22 3a0a 2020 2020 2020 2020 2020 2020  {":.            
-000022d0: 6c65 6674 5f62 7261 6365 203d 2054 7275  left_brace = Tru
-000022e0: 650a 2020 2020 2020 2020 656c 6966 2063  e.        elif c
-000022f0: 7572 7265 6e74 5f63 6861 7261 6374 6572  urrent_character
-00002300: 203d 3d20 227d 223a 0a20 2020 2020 2020   == "}":.       
-00002310: 2020 2020 206c 6566 745f 6272 6163 6520       left_brace 
-00002320: 3d20 4661 6c73 650a 2020 2020 7265 7475  = False.    retu
-00002330: 726e 2072 6967 6874 7061 7274 2c20 2222  rn rightpart, ""
-00002340: 0a0a 0a64 6566 205f 6772 6f75 705f 7333  ...def _group_s3
-00002350: 7061 7468 5f62 795f 6275 636b 6574 280a  path_by_bucket(.
-00002360: 2020 2020 2020 2020 7333 5f70 6174 686e          s3_pathn
-00002370: 616d 653a 2073 7472 2c20 7072 6f66 696c  ame: str, profil
-00002380: 655f 6e61 6d65 3a20 4f70 7469 6f6e 616c  e_name: Optional
-00002390: 5b73 7472 5d20 3d20 4e6f 6e65 2920 2d3e  [str] = None) ->
-000023a0: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
-000023b0: 6275 636b 6574 2c20 6b65 7920 3d20 5f70  bucket, key = _p
-000023c0: 6172 7365 5f73 335f 7572 6c5f 6967 6e6f  arse_s3_url_igno
-000023d0: 7265 5f62 7261 6365 2873 335f 7061 7468  re_brace(s3_path
-000023e0: 6e61 6d65 290a 2020 2020 6966 206e 6f74  name).    if not
-000023f0: 2062 7563 6b65 743a 0a20 2020 2020 2020   bucket:.       
-00002400: 2069 6620 6e6f 7420 6b65 793a 0a20 2020   if not key:.   
-00002410: 2020 2020 2020 2020 2072 6169 7365 2055           raise U
-00002420: 6e73 7570 706f 7274 6564 4572 726f 7228  nsupportedError(
-00002430: 2747 6c6f 6220 7768 6f6c 6520 7333 272c  'Glob whole s3',
-00002440: 2073 335f 7061 7468 6e61 6d65 290a 2020   s3_pathname).  
-00002450: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
-00002460: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
-00002470: 7228 2745 6d70 7479 2062 7563 6b65 7420  r('Empty bucket 
-00002480: 6e61 6d65 3a20 2572 2720 2520 7333 5f70  name: %r' % s3_p
-00002490: 6174 686e 616d 6529 0a0a 2020 2020 6772  athname)..    gr
-000024a0: 6f75 7065 645f 7061 7468 203d 205b 5d0a  ouped_path = [].
-000024b0: 0a20 2020 2064 6566 2067 656e 6572 6174  .    def generat
-000024c0: 655f 7333 5f70 6174 6828 6275 636b 6574  e_s3_path(bucket
-000024d0: 3a20 7374 722c 206b 6579 3a20 7374 7229  : str, key: str)
-000024e0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-000024f0: 2069 6620 6b65 793a 0a20 2020 2020 2020   if key:.       
-00002500: 2020 2020 2072 6574 7572 6e20 2273 333a       return "s3:
-00002510: 2f2f 2573 2f25 7322 2025 2028 6275 636b  //%s/%s" % (buck
-00002520: 6574 2c20 6b65 7929 0a20 2020 2020 2020  et, key).       
-00002530: 2072 6574 7572 6e20 2273 333a 2f2f 2573   return "s3://%s
-00002540: 2573 2220 2520 2862 7563 6b65 742c 2022  %s" % (bucket, "
-00002550: 2f22 2069 6620 7333 5f70 6174 686e 616d  /" if s3_pathnam
-00002560: 652e 656e 6473 7769 7468 2822 2f22 2920  e.endswith("/") 
-00002570: 656c 7365 2022 2229 0a0a 2020 2020 616c  else "")..    al
-00002580: 6c5f 6275 636b 6574 203d 206c 7275 5f63  l_bucket = lru_c
-00002590: 6163 6865 286d 6178 7369 7a65 3d31 2928  ache(maxsize=1)(
-000025a0: 5f6c 6973 745f 616c 6c5f 6275 636b 6574  _list_all_bucket
-000025b0: 7329 0a20 2020 2066 6f72 2062 7563 6b65  s).    for bucke
-000025c0: 746e 616d 6520 696e 2075 6e67 6c6f 626c  tname in unglobl
-000025d0: 697a 6528 6275 636b 6574 293a 0a20 2020  ize(bucket):.   
-000025e0: 2020 2020 2069 6620 6861 735f 6d61 6769       if has_magi
-000025f0: 6328 6275 636b 6574 6e61 6d65 293a 0a20  c(bucketname):. 
-00002600: 2020 2020 2020 2020 2020 2073 706c 6974             split
-00002610: 5f62 7563 6b65 746e 616d 6520 3d20 6275  _bucketname = bu
-00002620: 636b 6574 6e61 6d65 2e73 706c 6974 2822  cketname.split("
-00002630: 2f22 2c20 3129 0a20 2020 2020 2020 2020  /", 1).         
-00002640: 2020 2070 6174 685f 7061 7274 203d 204e     path_part = N
-00002650: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00002660: 6966 206c 656e 2873 706c 6974 5f62 7563  if len(split_buc
-00002670: 6b65 746e 616d 6529 203d 3d20 323a 0a20  ketname) == 2:. 
-00002680: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00002690: 7563 6b65 746e 616d 652c 2070 6174 685f  ucketname, path_
-000026a0: 7061 7274 203d 2073 706c 6974 5f62 7563  part = split_buc
-000026b0: 6b65 746e 616d 650a 2020 2020 2020 2020  ketname.        
-000026c0: 2020 2020 7061 7474 6572 6e20 3d20 7265      pattern = re
-000026d0: 2e63 6f6d 7069 6c65 2874 7261 6e73 6c61  .compile(transla
-000026e0: 7465 2872 652e 7375 6228 7227 5c2a 7b32  te(re.sub(r'\*{2
-000026f0: 2c7d 272c 2027 2a27 2c20 6275 636b 6574  ,}', '*', bucket
-00002700: 6e61 6d65 2929 290a 0a20 2020 2020 2020  name)))..       
-00002710: 2020 2020 2066 6f72 2062 7563 6b65 7420       for bucket 
-00002720: 696e 2061 6c6c 5f62 7563 6b65 7428 7072  in all_bucket(pr
-00002730: 6f66 696c 655f 6e61 6d65 293a 0a20 2020  ofile_name):.   
-00002740: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00002750: 7061 7474 6572 6e2e 6675 6c6c 6d61 7463  pattern.fullmatc
-00002760: 6828 6275 636b 6574 2920 6973 206e 6f74  h(bucket) is not
-00002770: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00002780: 2020 2020 2020 2020 2020 2069 6620 7061             if pa
-00002790: 7468 5f70 6172 7420 6973 206e 6f74 204e  th_part is not N
-000027a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000027b0: 2020 2020 2020 2020 2020 2020 2062 7563               buc
-000027c0: 6b65 7420 3d20 2225 732f 2573 2220 2520  ket = "%s/%s" % 
-000027d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000027e0: 2020 2020 2020 2020 2020 2020 2020 6275                bu
-000027f0: 636b 6574 2c20 7061 7468 5f70 6172 7429  cket, path_part)
-00002800: 2020 2320 7072 6167 6d61 3a20 6e6f 2063    # pragma: no c
-00002810: 6f76 6572 0a20 2020 2020 2020 2020 2020  over.           
-00002820: 2020 2020 2020 2020 2067 726f 7570 6564           grouped
-00002830: 5f70 6174 682e 6170 7065 6e64 2867 656e  _path.append(gen
-00002840: 6572 6174 655f 7333 5f70 6174 6828 6275  erate_s3_path(bu
-00002850: 636b 6574 2c20 6b65 7929 290a 2020 2020  cket, key)).    
-00002860: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00002870: 2020 2020 2020 6772 6f75 7065 645f 7061        grouped_pa
-00002880: 7468 2e61 7070 656e 6428 6765 6e65 7261  th.append(genera
-00002890: 7465 5f73 335f 7061 7468 2862 7563 6b65  te_s3_path(bucke
-000028a0: 746e 616d 652c 206b 6579 2929 0a0a 2020  tname, key))..  
-000028b0: 2020 7265 7475 726e 2067 726f 7570 6564    return grouped
-000028c0: 5f70 6174 680a 0a0a 6465 6620 5f73 335f  _path...def _s3_
-000028d0: 7370 6c69 745f 6d61 6769 635f 6967 6e6f  split_magic_igno
-000028e0: 7265 5f62 7261 6365 2873 335f 7061 7468  re_brace(s3_path
-000028f0: 6e61 6d65 3a20 7374 7229 202d 3e20 5475  name: str) -> Tu
-00002900: 706c 655b 7374 722c 2073 7472 5d3a 0a20  ple[str, str]:. 
-00002910: 2020 2069 6620 6e6f 7420 7333 5f70 6174     if not s3_pat
-00002920: 686e 616d 653a 0a20 2020 2020 2020 2072  hname:.        r
-00002930: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00002940: 2273 335f 7061 7468 6e61 6d65 3a20 2573  "s3_pathname: %s
-00002950: 222c 2073 335f 7061 7468 6e61 6d65 290a  ", s3_pathname).
-00002960: 0a20 2020 2068 6173 5f70 726f 746f 636f  .    has_protoco
-00002970: 6c20 3d20 4661 6c73 650a 2020 2020 6966  l = False.    if
-00002980: 2073 335f 7061 7468 6e61 6d65 2e73 7461   s3_pathname.sta
-00002990: 7274 7377 6974 6828 2273 333a 2f2f 2229  rtswith("s3://")
-000029a0: 3a0a 2020 2020 2020 2020 6861 735f 7072  :.        has_pr
-000029b0: 6f74 6f63 6f6c 203d 2054 7275 650a 2020  otocol = True.  
-000029c0: 2020 2020 2020 7333 5f70 6174 686e 616d        s3_pathnam
-000029d0: 6520 3d20 7333 5f70 6174 686e 616d 655b  e = s3_pathname[
-000029e0: 353a 5d0a 0a20 2020 2068 6173 5f64 656c  5:]..    has_del
-000029f0: 696d 6974 6572 203d 2046 616c 7365 0a20  imiter = False. 
-00002a00: 2020 2069 6620 7333 5f70 6174 686e 616d     if s3_pathnam
-00002a10: 652e 656e 6473 7769 7468 2822 2f22 293a  e.endswith("/"):
-00002a20: 0a20 2020 2020 2020 2068 6173 5f64 656c  .        has_del
-00002a30: 696d 6974 6572 203d 2054 7275 650a 2020  imiter = True.  
-00002a40: 2020 2020 2020 7333 5f70 6174 686e 616d        s3_pathnam
-00002a50: 6520 3d20 7333 5f70 6174 686e 616d 655b  e = s3_pathname[
-00002a60: 3a2d 315d 0a0a 2020 2020 6e6f 726d 616c  :-1]..    normal
-00002a70: 5f70 6172 7473 203d 205b 5d0a 2020 2020  _parts = [].    
-00002a80: 6d61 6769 635f 7061 7274 7320 3d20 5b5d  magic_parts = []
-00002a90: 0a20 2020 206c 6566 745f 6272 6163 6520  .    left_brace 
-00002aa0: 3d20 4661 6c73 650a 2020 2020 6c65 6674  = False.    left
-00002ab0: 5f69 6e64 6578 203d 2030 0a20 2020 2066  _index = 0.    f
-00002ac0: 6f72 2063 7572 7265 6e74 5f69 6e64 6578  or current_index
-00002ad0: 2c20 6375 7272 656e 745f 6368 6172 6163  , current_charac
-00002ae0: 7465 7220 696e 2065 6e75 6d65 7261 7465  ter in enumerate
-00002af0: 2873 335f 7061 7468 6e61 6d65 293a 0a20  (s3_pathname):. 
-00002b00: 2020 2020 2020 2069 6620 6375 7272 656e         if curren
-00002b10: 745f 6368 6172 6163 7465 7220 3d3d 2022  t_character == "
-00002b20: 2f22 2061 6e64 206c 6566 745f 6272 6163  /" and left_brac
-00002b30: 6520 6973 2046 616c 7365 3a0a 2020 2020  e is False:.    
-00002b40: 2020 2020 2020 2020 6966 2068 6173 5f6d          if has_m
-00002b50: 6167 6963 5f69 676e 6f72 655f 6272 6163  agic_ignore_brac
-00002b60: 6528 7333 5f70 6174 686e 616d 655b 6c65  e(s3_pathname[le
-00002b70: 6674 5f69 6e64 6578 3a63 7572 7265 6e74  ft_index:current
-00002b80: 5f69 6e64 6578 5d29 3a0a 2020 2020 2020  _index]):.      
-00002b90: 2020 2020 2020 2020 2020 6d61 6769 635f            magic_
-00002ba0: 7061 7274 732e 6170 7065 6e64 2873 335f  parts.append(s3_
-00002bb0: 7061 7468 6e61 6d65 5b6c 6566 745f 696e  pathname[left_in
-00002bc0: 6465 783a 6375 7272 656e 745f 696e 6465  dex:current_inde
-00002bd0: 785d 290a 2020 2020 2020 2020 2020 2020  x]).            
-00002be0: 2020 2020 6966 2073 335f 7061 7468 6e61      if s3_pathna
-00002bf0: 6d65 5b63 7572 7265 6e74 5f69 6e64 6578  me[current_index
-00002c00: 202b 2031 3a5d 3a0a 2020 2020 2020 2020   + 1:]:.        
-00002c10: 2020 2020 2020 2020 2020 2020 6d61 6769              magi
-00002c20: 635f 7061 7274 732e 6170 7065 6e64 2873  c_parts.append(s
-00002c30: 335f 7061 7468 6e61 6d65 5b63 7572 7265  3_pathname[curre
-00002c40: 6e74 5f69 6e64 6578 202b 2031 3a5d 290a  nt_index + 1:]).
-00002c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c60: 2020 2020 6c65 6674 5f69 6e64 6578 203d      left_index =
-00002c70: 206c 656e 2873 335f 7061 7468 6e61 6d65   len(s3_pathname
-00002c80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00002c90: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-00002ca0: 2020 2020 6e6f 726d 616c 5f70 6172 7473      normal_parts
-00002cb0: 2e61 7070 656e 6428 7333 5f70 6174 686e  .append(s3_pathn
-00002cc0: 616d 655b 6c65 6674 5f69 6e64 6578 3a63  ame[left_index:c
-00002cd0: 7572 7265 6e74 5f69 6e64 6578 5d29 0a20  urrent_index]). 
-00002ce0: 2020 2020 2020 2020 2020 206c 6566 745f             left_
-00002cf0: 696e 6465 7820 3d20 6375 7272 656e 745f  index = current_
-00002d00: 696e 6465 7820 2b20 310a 2020 2020 2020  index + 1.      
-00002d10: 2020 656c 6966 2063 7572 7265 6e74 5f63    elif current_c
-00002d20: 6861 7261 6374 6572 203d 3d20 227b 223a  haracter == "{":
-00002d30: 0a20 2020 2020 2020 2020 2020 206c 6566  .            lef
-00002d40: 745f 6272 6163 6520 3d20 5472 7565 0a20  t_brace = True. 
-00002d50: 2020 2020 2020 2065 6c69 6620 6375 7272         elif curr
-00002d60: 656e 745f 6368 6172 6163 7465 7220 3d3d  ent_character ==
-00002d70: 2022 7d22 3a0a 2020 2020 2020 2020 2020   "}":.          
-00002d80: 2020 6c65 6674 5f62 7261 6365 203d 2046    left_brace = F
-00002d90: 616c 7365 0a20 2020 2069 6620 7333 5f70  alse.    if s3_p
-00002da0: 6174 686e 616d 655b 6c65 6674 5f69 6e64  athname[left_ind
-00002db0: 6578 3a5d 3a0a 2020 2020 2020 2020 6966  ex:]:.        if
-00002dc0: 2068 6173 5f6d 6167 6963 5f69 676e 6f72   has_magic_ignor
-00002dd0: 655f 6272 6163 6528 7333 5f70 6174 686e  e_brace(s3_pathn
-00002de0: 616d 655b 6c65 6674 5f69 6e64 6578 3a5d  ame[left_index:]
-00002df0: 293a 0a20 2020 2020 2020 2020 2020 206d  ):.            m
-00002e00: 6167 6963 5f70 6172 7473 2e61 7070 656e  agic_parts.appen
-00002e10: 6428 7333 5f70 6174 686e 616d 655b 6c65  d(s3_pathname[le
-00002e20: 6674 5f69 6e64 6578 3a5d 290a 2020 2020  ft_index:]).    
-00002e30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00002e40: 2020 2020 2020 6e6f 726d 616c 5f70 6172        normal_par
-00002e50: 7473 2e61 7070 656e 6428 7333 5f70 6174  ts.append(s3_pat
-00002e60: 686e 616d 655b 6c65 6674 5f69 6e64 6578  hname[left_index
-00002e70: 3a5d 290a 0a20 2020 2069 6620 6861 735f  :])..    if has_
-00002e80: 7072 6f74 6f63 6f6c 2061 6e64 206e 6f72  protocol and nor
-00002e90: 6d61 6c5f 7061 7274 733a 0a20 2020 2020  mal_parts:.     
-00002ea0: 2020 206e 6f72 6d61 6c5f 7061 7274 732e     normal_parts.
-00002eb0: 696e 7365 7274 2830 2c20 2273 333a 2f22  insert(0, "s3:/"
-00002ec0: 290a 2020 2020 656c 6966 2068 6173 5f70  ).    elif has_p
-00002ed0: 726f 746f 636f 6c3a 0a20 2020 2020 2020  rotocol:.       
-00002ee0: 206d 6167 6963 5f70 6172 7473 2e69 6e73   magic_parts.ins
-00002ef0: 6572 7428 302c 2022 7333 3a2f 2229 0a0a  ert(0, "s3:/")..
-00002f00: 2020 2020 6966 2068 6173 5f64 656c 696d      if has_delim
-00002f10: 6974 6572 2061 6e64 206d 6167 6963 5f70  iter and magic_p
-00002f20: 6172 7473 3a0a 2020 2020 2020 2020 6d61  arts:.        ma
-00002f30: 6769 635f 7061 7274 732e 6170 7065 6e64  gic_parts.append
-00002f40: 2822 2229 0a20 2020 2065 6c69 6620 6861  ("").    elif ha
-00002f50: 735f 6465 6c69 6d69 7465 723a 0a20 2020  s_delimiter:.   
-00002f60: 2020 2020 206e 6f72 6d61 6c5f 7061 7274       normal_part
-00002f70: 732e 6170 7065 6e64 2822 2229 0a0a 2020  s.append("")..  
-00002f80: 2020 7265 7475 726e 2022 2f22 2e6a 6f69    return "/".joi
-00002f90: 6e28 6e6f 726d 616c 5f70 6172 7473 292c  n(normal_parts),
-00002fa0: 2022 2f22 2e6a 6f69 6e28 6d61 6769 635f   "/".join(magic_
-00002fb0: 7061 7274 7329 0a0a 0a64 6566 205f 6772  parts)...def _gr
-00002fc0: 6f75 705f 7333 7061 7468 5f62 795f 7072  oup_s3path_by_pr
-00002fd0: 6566 6978 2873 335f 7061 7468 6e61 6d65  efix(s3_pathname
-00002fe0: 3a20 7374 7229 202d 3e20 4c69 7374 5b73  : str) -> List[s
-00002ff0: 7472 5d3a 0a0a 2020 2020 5f2c 206b 6579  tr]:..    _, key
-00003000: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-00003010: 7333 5f70 6174 686e 616d 6529 0a20 2020  s3_pathname).   
-00003020: 2069 6620 6e6f 7420 6b65 793a 0a20 2020   if not key:.   
-00003030: 2020 2020 2072 6574 7572 6e20 756e 676c       return ungl
-00003040: 6f62 6c69 7a65 2873 335f 7061 7468 6e61  oblize(s3_pathna
-00003050: 6d65 290a 0a20 2020 2074 6f70 5f64 6972  me)..    top_dir
-00003060: 2c20 6d61 6769 635f 7061 7274 203d 205f  , magic_part = _
-00003070: 7333 5f73 706c 6974 5f6d 6167 6963 5f69  s3_split_magic_i
-00003080: 676e 6f72 655f 6272 6163 6528 7333 5f70  gnore_brace(s3_p
-00003090: 6174 686e 616d 6529 0a20 2020 2069 6620  athname).    if 
-000030a0: 6e6f 7420 746f 705f 6469 723a 0a20 2020  not top_dir:.   
-000030b0: 2020 2020 2072 6574 7572 6e20 5b6d 6167       return [mag
-000030c0: 6963 5f70 6172 745d 0a20 2020 2067 726f  ic_part].    gro
-000030d0: 7570 6564 5f70 6174 6820 3d20 5b5d 0a20  uped_path = []. 
-000030e0: 2020 2066 6f72 2070 6174 686e 616d 6520     for pathname 
-000030f0: 696e 2075 6e67 6c6f 626c 697a 6528 746f  in ungloblize(to
-00003100: 705f 6469 7229 3a0a 2020 2020 2020 2020  p_dir):.        
-00003110: 6966 206d 6167 6963 5f70 6172 743a 0a20  if magic_part:. 
-00003120: 2020 2020 2020 2020 2020 2070 6174 686e             pathn
-00003130: 616d 6520 3d20 222f 222e 6a6f 696e 285b  ame = "/".join([
-00003140: 7061 7468 6e61 6d65 2c20 6d61 6769 635f  pathname, magic_
-00003150: 7061 7274 5d29 0a20 2020 2020 2020 2067  part]).        g
-00003160: 726f 7570 6564 5f70 6174 682e 6170 7065  rouped_path.appe
-00003170: 6e64 2870 6174 686e 616d 6529 0a20 2020  nd(pathname).   
-00003180: 2072 6574 7572 6e20 6772 6f75 7065 645f   return grouped_
-00003190: 7061 7468 0a0a 0a64 6566 205f 6265 636f  path...def _beco
-000031a0: 6d65 5f70 7265 6669 7828 7072 6566 6978  me_prefix(prefix
-000031b0: 3a20 7374 7229 202d 3e20 7374 723a 0a20  : str) -> str:. 
-000031c0: 2020 2069 6620 7072 6566 6978 2021 3d20     if prefix != 
-000031d0: 2727 2061 6e64 206e 6f74 2070 7265 6669  '' and not prefi
-000031e0: 782e 656e 6473 7769 7468 2827 2f27 293a  x.endswith('/'):
-000031f0: 0a20 2020 2020 2020 2070 7265 6669 7820  .        prefix 
-00003200: 2b3d 2027 2f27 0a20 2020 2072 6574 7572  += '/'.    retur
-00003210: 6e20 7072 6566 6978 0a0a 0a64 6566 205f  n prefix...def _
-00003220: 7333 5f73 706c 6974 5f6d 6167 6963 2873  s3_split_magic(s
-00003230: 335f 7061 7468 6e61 6d65 3a20 7374 7229  3_pathname: str)
-00003240: 202d 3e20 5475 706c 655b 7374 722c 2073   -> Tuple[str, s
-00003250: 7472 5d3a 0a20 2020 2069 6620 6e6f 7420  tr]:.    if not 
-00003260: 6861 735f 6d61 6769 6328 7333 5f70 6174  has_magic(s3_pat
-00003270: 686e 616d 6529 3a0a 2020 2020 2020 2020  hname):.        
-00003280: 7265 7475 726e 2073 335f 7061 7468 6e61  return s3_pathna
-00003290: 6d65 2c20 2727 0a20 2020 2064 656c 696d  me, ''.    delim
-000032a0: 6974 6572 203d 2027 2f27 0a20 2020 206e  iter = '/'.    n
-000032b0: 6f72 6d61 6c5f 7061 7274 7320 3d20 5b5d  ormal_parts = []
-000032c0: 0a20 2020 206d 6167 6963 5f70 6172 7473  .    magic_parts
-000032d0: 203d 205b 5d0a 2020 2020 616c 6c5f 7061   = [].    all_pa
-000032e0: 7274 7320 3d20 7333 5f70 6174 686e 616d  rts = s3_pathnam
-000032f0: 652e 7370 6c69 7428 6465 6c69 6d69 7465  e.split(delimite
-00003300: 7229 0a20 2020 2066 6f72 2069 2c20 7061  r).    for i, pa
-00003310: 7274 2069 6e20 656e 756d 6572 6174 6528  rt in enumerate(
-00003320: 616c 6c5f 7061 7274 7329 3a0a 2020 2020  all_parts):.    
-00003330: 2020 2020 6966 206e 6f74 2068 6173 5f6d      if not has_m
-00003340: 6167 6963 2870 6172 7429 3a0a 2020 2020  agic(part):.    
-00003350: 2020 2020 2020 2020 6e6f 726d 616c 5f70          normal_p
-00003360: 6172 7473 2e61 7070 656e 6428 7061 7274  arts.append(part
-00003370: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00003380: 2020 2020 2020 2020 2020 2020 6d61 6769              magi
-00003390: 635f 7061 7274 7320 3d20 616c 6c5f 7061  c_parts = all_pa
-000033a0: 7274 735b 693a 5d0a 2020 2020 2020 2020  rts[i:].        
-000033b0: 2020 2020 6272 6561 6b0a 2020 2020 7265      break.    re
-000033c0: 7475 726e 2064 656c 696d 6974 6572 2e6a  turn delimiter.j
-000033d0: 6f69 6e28 6e6f 726d 616c 5f70 6172 7473  oin(normal_parts
-000033e0: 292c 2064 656c 696d 6974 6572 2e6a 6f69  ), delimiter.joi
-000033f0: 6e28 6d61 6769 635f 7061 7274 7329 0a0a  n(magic_parts)..
-00003400: 0a64 6566 205f 6c69 7374 5f6f 626a 6563  .def _list_objec
-00003410: 7473 5f72 6563 7572 7369 7665 280a 2020  ts_recursive(.  
-00003420: 2020 2020 2020 7333 5f63 6c69 656e 742c        s3_client,
-00003430: 2062 7563 6b65 743a 2073 7472 2c20 7072   bucket: str, pr
-00003440: 6566 6978 3a20 7374 722c 2064 656c 696d  efix: str, delim
-00003450: 6974 6572 3a20 7374 7220 3d20 2727 293a  iter: str = ''):
-00003460: 0a0a 2020 2020 7265 7370 203d 2073 335f  ..    resp = s3_
-00003470: 636c 6965 6e74 2e6c 6973 745f 6f62 6a65  client.list_obje
-00003480: 6374 735f 7632 280a 2020 2020 2020 2020  cts_v2(.        
-00003490: 4275 636b 6574 3d62 7563 6b65 742c 2050  Bucket=bucket, P
-000034a0: 7265 6669 783d 7072 6566 6978 2c20 4465  refix=prefix, De
-000034b0: 6c69 6d69 7465 723d 6465 6c69 6d69 7465  limiter=delimite
-000034c0: 722c 204d 6178 4b65 7973 3d6d 6178 5f6b  r, MaxKeys=max_k
-000034d0: 6579 7329 0a0a 2020 2020 7768 696c 6520  eys)..    while 
-000034e0: 5472 7565 3a0a 2020 2020 2020 2020 7969  True:.        yi
-000034f0: 656c 6420 7265 7370 0a0a 2020 2020 2020  eld resp..      
-00003500: 2020 6966 206e 6f74 2072 6573 705b 2749    if not resp['I
-00003510: 7354 7275 6e63 6174 6564 275d 3a0a 2020  sTruncated']:.  
-00003520: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00003530: 0a20 2020 2020 2020 2072 6573 7020 3d20  .        resp = 
-00003540: 7333 5f63 6c69 656e 742e 6c69 7374 5f6f  s3_client.list_o
-00003550: 626a 6563 7473 5f76 3228 0a20 2020 2020  bjects_v2(.     
-00003560: 2020 2020 2020 2042 7563 6b65 743d 6275         Bucket=bu
-00003570: 636b 6574 2c0a 2020 2020 2020 2020 2020  cket,.          
-00003580: 2020 5072 6566 6978 3d70 7265 6669 782c    Prefix=prefix,
-00003590: 0a20 2020 2020 2020 2020 2020 2044 656c  .            Del
-000035a0: 696d 6974 6572 3d64 656c 696d 6974 6572  imiter=delimiter
-000035b0: 2c0a 2020 2020 2020 2020 2020 2020 436f  ,.            Co
-000035c0: 6e74 696e 7561 7469 6f6e 546f 6b65 6e3d  ntinuationToken=
-000035d0: 7265 7370 5b27 4e65 7874 436f 6e74 696e  resp['NextContin
-000035e0: 7561 7469 6f6e 546f 6b65 6e27 5d2c 0a20  uationToken'],. 
-000035f0: 2020 2020 2020 2020 2020 204d 6178 4b65             MaxKe
-00003600: 7973 3d6d 6178 5f6b 6579 7329 0a0a 0a64  ys=max_keys)...d
-00003610: 6566 205f 6d61 6b65 5f73 7461 7428 636f  ef _make_stat(co
-00003620: 6e74 656e 743a 2044 6963 745b 7374 722c  ntent: Dict[str,
-00003630: 2041 6e79 5d29 3a0a 2020 2020 7265 7475   Any]):.    retu
-00003640: 726e 2053 7461 7452 6573 756c 7428 0a20  rn StatResult(. 
-00003650: 2020 2020 2020 2069 736c 6e6b 3d63 6f6e         islnk=con
-00003660: 7465 6e74 2e67 6574 2827 6973 6c6e 6b27  tent.get('islnk'
-00003670: 2c20 4661 6c73 6529 2c0a 2020 2020 2020  , False),.      
-00003680: 2020 7369 7a65 3d63 6f6e 7465 6e74 5b27    size=content['
-00003690: 5369 7a65 275d 2c0a 2020 2020 2020 2020  Size'],.        
-000036a0: 6d74 696d 653d 636f 6e74 656e 745b 274c  mtime=content['L
-000036b0: 6173 744d 6f64 6966 6965 6427 5d2e 7469  astModified'].ti
-000036c0: 6d65 7374 616d 7028 292c 0a20 2020 2020  mestamp(),.     
-000036d0: 2020 2065 7874 7261 3d63 6f6e 7465 6e74     extra=content
-000036e0: 2c0a 2020 2020 290a 0a0a 6465 6620 5f73  ,.    )...def _s
-000036f0: 335f 676c 6f62 5f73 7461 745f 7369 6e67  3_glob_stat_sing
-00003700: 6c65 5f70 6174 6828 0a20 2020 2020 2020  le_path(.       
-00003710: 2073 335f 7061 7468 6e61 6d65 3a20 5061   s3_pathname: Pa
-00003720: 7468 4c69 6b65 2c0a 2020 2020 2020 2020  thLike,.        
-00003730: 7265 6375 7273 6976 653a 2062 6f6f 6c20  recursive: bool 
-00003740: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-00003750: 6d69 7373 696e 675f 6f6b 3a20 626f 6f6c  missing_ok: bool
-00003760: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-00003770: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
-00003780: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-00003790: 2020 2020 7072 6f66 696c 655f 6e61 6d65      profile_name
-000037a0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-000037b0: 3d20 4e6f 6e65 2920 2d3e 2049 7465 7261  = None) -> Itera
-000037c0: 746f 725b 4669 6c65 456e 7472 795d 3a0a  tor[FileEntry]:.
-000037d0: 2020 2020 6966 206e 6f74 2072 6563 7572      if not recur
-000037e0: 7369 7665 3a0a 2020 2020 2020 2020 2320  sive:.        # 
-000037f0: 4966 206e 6f74 2072 6563 7572 7369 7665  If not recursive
-00003800: 2c20 7265 706c 6163 6520 2a2a 2077 6974  , replace ** wit
-00003810: 6820 2a0a 2020 2020 2020 2020 7333 5f70  h *.        s3_p
-00003820: 6174 686e 616d 6520 3d20 7265 2e73 7562  athname = re.sub
-00003830: 2872 275c 2a7b 322c 7d27 2c20 272a 272c  (r'\*{2,}', '*',
-00003840: 2073 335f 7061 7468 6e61 6d65 290a 2020   s3_pathname).  
-00003850: 2020 746f 705f 6469 722c 2077 696c 6463    top_dir, wildc
-00003860: 6172 645f 7061 7274 203d 205f 7333 5f73  ard_part = _s3_s
-00003870: 706c 6974 5f6d 6167 6963 2873 335f 7061  plit_magic(s3_pa
-00003880: 7468 6e61 6d65 290a 2020 2020 7365 6172  thname).    sear
-00003890: 6368 5f64 6972 203d 2077 696c 6463 6172  ch_dir = wildcar
-000038a0: 645f 7061 7274 2e65 6e64 7377 6974 6828  d_part.endswith(
-000038b0: 272f 2729 0a0a 2020 2020 6465 6620 7368  '/')..    def sh
-000038c0: 6f75 6c64 5f72 6563 7572 7369 7665 2877  ould_recursive(w
-000038d0: 696c 6463 6172 645f 7061 7274 3a20 7374  ildcard_part: st
-000038e0: 7229 202d 3e20 626f 6f6c 3a0a 2020 2020  r) -> bool:.    
-000038f0: 2020 2020 6966 2027 2a2a 2720 696e 2077      if '**' in w
-00003900: 696c 6463 6172 645f 7061 7274 3a0a 2020  ildcard_part:.  
-00003910: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00003920: 2054 7275 650a 2020 2020 2020 2020 666f   True.        fo
-00003930: 7220 6578 7061 6e64 6564 5f70 6174 6820  r expanded_path 
-00003940: 696e 2075 6e67 6c6f 626c 697a 6528 7769  in ungloblize(wi
-00003950: 6c64 6361 7264 5f70 6172 7429 3a0a 2020  ldcard_part):.  
-00003960: 2020 2020 2020 2020 2020 7061 7274 735f            parts_
-00003970: 6c65 6e67 7468 203d 206c 656e 2865 7870  length = len(exp
-00003980: 616e 6465 645f 7061 7468 2e73 706c 6974  anded_path.split
-00003990: 2827 2f27 2929 0a20 2020 2020 2020 2020  ('/')).         
-000039a0: 2020 2069 6620 7061 7274 735f 6c65 6e67     if parts_leng
-000039b0: 7468 202b 2073 6561 7263 685f 6469 7220  th + search_dir 
-000039c0: 3e3d 2032 3a0a 2020 2020 2020 2020 2020  >= 2:.          
-000039d0: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-000039e0: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
-000039f0: 2046 616c 7365 0a0a 2020 2020 6465 6620   False..    def 
-00003a00: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
-00003a10: 285f 7333 5f70 6174 686e 616d 6529 202d  (_s3_pathname) -
-00003a20: 3e20 4974 6572 6174 6f72 5b46 696c 6545  > Iterator[FileE
-00003a30: 6e74 7279 5d3a 0a20 2020 2020 2020 2069  ntry]:.        i
-00003a40: 6620 6e6f 7420 5333 5061 7468 2874 6f70  f not S3Path(top
-00003a50: 5f64 6972 292e 6578 6973 7473 2829 3a0a  _dir).exists():.
-00003a60: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00003a70: 726e 0a20 2020 2020 2020 2069 6620 6e6f  rn.        if no
-00003a80: 7420 6861 735f 6d61 6769 6328 5f73 335f  t has_magic(_s3_
-00003a90: 7061 7468 6e61 6d65 293a 0a20 2020 2020  pathname):.     
-00003aa0: 2020 2020 2020 205f 7333 5f70 6174 686e         _s3_pathn
-00003ab0: 616d 655f 6f62 6a20 3d20 5333 5061 7468  ame_obj = S3Path
-00003ac0: 285f 7333 5f70 6174 686e 616d 6529 0a20  (_s3_pathname). 
-00003ad0: 2020 2020 2020 2020 2020 2069 6620 5f73             if _s
-00003ae0: 335f 7061 7468 6e61 6d65 5f6f 626a 2e69  3_pathname_obj.i
-00003af0: 735f 6669 6c65 2829 3a0a 2020 2020 2020  s_file():.      
-00003b00: 2020 2020 2020 2020 2020 7374 6174 203d            stat =
-00003b10: 2053 3350 6174 6828 5f73 335f 7061 7468   S3Path(_s3_path
-00003b20: 6e61 6d65 292e 7374 6174 2866 6f6c 6c6f  name).stat(follo
-00003b30: 775f 7379 6d6c 696e 6b73 3d66 6f6c 6c6f  w_symlinks=follo
-00003b40: 776c 696e 6b73 290a 2020 2020 2020 2020  wlinks).        
-00003b50: 2020 2020 2020 2020 7969 656c 6420 4669          yield Fi
-00003b60: 6c65 456e 7472 7928 0a20 2020 2020 2020  leEntry(.       
-00003b70: 2020 2020 2020 2020 2020 2020 205f 7333               _s3
-00003b80: 5f70 6174 686e 616d 655f 6f62 6a2e 6e61  _pathname_obj.na
-00003b90: 6d65 2c20 5f73 335f 7061 7468 6e61 6d65  me, _s3_pathname
-00003ba0: 5f6f 626a 2e70 6174 682c 2073 7461 7429  _obj.path, stat)
-00003bb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00003bc0: 5f73 335f 7061 7468 6e61 6d65 5f6f 626a  _s3_pathname_obj
-00003bd0: 2e69 735f 6469 7228 293a 0a20 2020 2020  .is_dir():.     
-00003be0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-00003bf0: 2046 696c 6545 6e74 7279 280a 2020 2020   FileEntry(.    
-00003c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003c10: 5f73 335f 7061 7468 6e61 6d65 5f6f 626a  _s3_pathname_obj
-00003c20: 2e6e 616d 652c 205f 7333 5f70 6174 686e  .name, _s3_pathn
-00003c30: 616d 655f 6f62 6a2e 7061 7468 2c0a 2020  ame_obj.path,.  
-00003c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003c50: 2020 5374 6174 5265 7375 6c74 2869 7364    StatResult(isd
-00003c60: 6972 3d54 7275 6529 290a 2020 2020 2020  ir=True)).      
-00003c70: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-00003c80: 2020 2020 2020 6465 6c69 6d69 7465 7220        delimiter 
-00003c90: 3d20 2727 0a20 2020 2020 2020 2069 6620  = ''.        if 
-00003ca0: 6e6f 7420 7368 6f75 6c64 5f72 6563 7572  not should_recur
-00003cb0: 7369 7665 2877 696c 6463 6172 645f 7061  sive(wildcard_pa
-00003cc0: 7274 293a 0a20 2020 2020 2020 2020 2020  rt):.           
-00003cd0: 2064 656c 696d 6974 6572 203d 2027 2f27   delimiter = '/'
-00003ce0: 0a0a 2020 2020 2020 2020 6469 726e 616d  ..        dirnam
-00003cf0: 6573 203d 2073 6574 2829 0a20 2020 2020  es = set().     
-00003d00: 2020 2070 6174 7465 726e 203d 2072 652e     pattern = re.
-00003d10: 636f 6d70 696c 6528 7472 616e 736c 6174  compile(translat
-00003d20: 6528 5f73 335f 7061 7468 6e61 6d65 2929  e(_s3_pathname))
-00003d30: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
-00003d40: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
-00003d50: 7572 6c28 746f 705f 6469 7229 0a20 2020  url(top_dir).   
-00003d60: 2020 2020 2070 7265 6669 7820 3d20 5f62       prefix = _b
-00003d70: 6563 6f6d 655f 7072 6566 6978 286b 6579  ecome_prefix(key
-00003d80: 290a 2020 2020 2020 2020 636c 6965 6e74  ).        client
-00003d90: 203d 2067 6574 5f73 335f 636c 6965 6e74   = get_s3_client
-00003da0: 2870 726f 6669 6c65 5f6e 616d 653d 7072  (profile_name=pr
-00003db0: 6f66 696c 655f 6e61 6d65 290a 2020 2020  ofile_name).    
-00003dc0: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
-00003dd0: 335f 6572 726f 7228 5f73 335f 7061 7468  3_error(_s3_path
-00003de0: 6e61 6d65 293a 0a20 2020 2020 2020 2020  name):.         
-00003df0: 2020 2066 6f72 2072 6573 7020 696e 205f     for resp in _
-00003e00: 6c69 7374 5f6f 626a 6563 7473 5f72 6563  list_objects_rec
-00003e10: 7572 7369 7665 2863 6c69 656e 742c 2062  ursive(client, b
-00003e20: 7563 6b65 742c 2070 7265 6669 782c 0a20  ucket, prefix,. 
-00003e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000120: 6f6e 0a0a 696d 706f 7274 2062 6f74 6f33  on..import boto3
+00000130: 0a69 6d70 6f72 7420 626f 746f 636f 7265  .import botocore
+00000140: 0a66 726f 6d20 626f 746f 636f 7265 2e61  .from botocore.a
+00000150: 7773 7265 7175 6573 7420 696d 706f 7274  wsrequest import
+00000160: 2041 5753 5265 7370 6f6e 7365 0a0a 6672   AWSResponse..fr
+00000170: 6f6d 206d 6567 6669 6c65 2e65 7272 6f72  om megfile.error
+00000180: 7320 696d 706f 7274 2053 3342 7563 6b65  s import S3Bucke
+00000190: 744e 6f74 466f 756e 6445 7272 6f72 2c20  tNotFoundError, 
+000001a0: 5333 436f 6e66 6967 4572 726f 722c 2053  S3ConfigError, S
+000001b0: 3346 696c 6545 7869 7374 7345 7272 6f72  3FileExistsError
+000001c0: 2c20 5333 4669 6c65 4e6f 7446 6f75 6e64  , S3FileNotFound
+000001d0: 4572 726f 722c 2053 3349 7341 4469 7265  Error, S3IsADire
+000001e0: 6374 6f72 7945 7272 6f72 2c20 5333 4e61  ctoryError, S3Na
+000001f0: 6d65 546f 6f4c 6f6e 6745 7272 6f72 2c20  meTooLongError, 
+00000200: 5333 4e6f 7441 4469 7265 6374 6f72 7945  S3NotADirectoryE
+00000210: 7272 6f72 2c20 5333 4e6f 7441 4c69 6e6b  rror, S3NotALink
+00000220: 4572 726f 722c 2053 3350 6572 6d69 7373  Error, S3Permiss
+00000230: 696f 6e45 7272 6f72 2c20 5333 556e 6b6e  ionError, S3Unkn
+00000240: 6f77 6e45 7272 6f72 2c20 556e 7375 7070  ownError, Unsupp
+00000250: 6f72 7465 6445 7272 6f72 2c20 5f63 7265  ortedError, _cre
+00000260: 6174 655f 6d69 7373 696e 675f 6f6b 5f67  ate_missing_ok_g
+00000270: 656e 6572 6174 6f72 0a66 726f 6d20 6d65  enerator.from me
+00000280: 6766 696c 652e 6572 726f 7273 2069 6d70  gfile.errors imp
+00000290: 6f72 7420 5f6c 6f67 6765 7220 6173 2065  ort _logger as e
+000002a0: 7272 6f72 5f6c 6f67 6765 720a 6672 6f6d  rror_logger.from
+000002b0: 206d 6567 6669 6c65 2e65 7272 6f72 7320   megfile.errors 
+000002c0: 696d 706f 7274 2070 6174 6368 5f6d 6574  import patch_met
+000002d0: 686f 642c 2072 6169 7365 5f73 335f 6572  hod, raise_s3_er
+000002e0: 726f 722c 2073 335f 6572 726f 725f 636f  ror, s3_error_co
+000002f0: 6465 5f73 686f 756c 645f 7265 7472 792c  de_should_retry,
+00000300: 2073 335f 7368 6f75 6c64 5f72 6574 7279   s3_should_retry
+00000310: 2c20 7472 616e 736c 6174 655f 6673 5f65  , translate_fs_e
+00000320: 7272 6f72 2c20 7472 616e 736c 6174 655f  rror, translate_
+00000330: 7333 5f65 7272 6f72 0a66 726f 6d20 6d65  s3_error.from me
+00000340: 6766 696c 652e 696e 7465 7266 6163 6573  gfile.interfaces
+00000350: 2069 6d70 6f72 7420 4163 6365 7373 2c20   import Access, 
+00000360: 436f 6e74 6578 7449 7465 7261 746f 722c  ContextIterator,
+00000370: 2046 696c 6543 6163 6865 722c 2046 696c   FileCacher, Fil
+00000380: 6545 6e74 7279 2c20 5061 7468 4c69 6b65  eEntry, PathLike
+00000390: 2c20 5374 6174 5265 7375 6c74 2c20 5552  , StatResult, UR
+000003a0: 4950 6174 680a 6672 6f6d 206d 6567 6669  IPath.from megfi
+000003b0: 6c65 2e6c 6962 2e63 6f6d 7061 7265 2069  le.lib.compare i
+000003c0: 6d70 6f72 7420 6973 5f73 616d 655f 6669  mport is_same_fi
+000003d0: 6c65 0a66 726f 6d20 6d65 6766 696c 652e  le.from megfile.
+000003e0: 6c69 622e 636f 6d70 6174 2069 6d70 6f72  lib.compat impor
+000003f0: 7420 6673 7061 7468 0a66 726f 6d20 6d65  t fspath.from me
+00000400: 6766 696c 652e 6c69 622e 666e 6d61 7463  gfile.lib.fnmatc
+00000410: 6820 696d 706f 7274 2074 7261 6e73 6c61  h import transla
+00000420: 7465 0a66 726f 6d20 6d65 6766 696c 652e  te.from megfile.
+00000430: 6c69 622e 676c 6f62 2069 6d70 6f72 7420  lib.glob import 
+00000440: 6861 735f 6d61 6769 632c 2068 6173 5f6d  has_magic, has_m
+00000450: 6167 6963 5f69 676e 6f72 655f 6272 6163  agic_ignore_brac
+00000460: 652c 2075 6e67 6c6f 626c 697a 650a 6672  e, ungloblize.fr
+00000470: 6f6d 206d 6567 6669 6c65 2e6c 6962 2e6a  om megfile.lib.j
+00000480: 6f69 6e70 6174 6820 696d 706f 7274 2075  oinpath import u
+00000490: 7269 5f6a 6f69 6e0a 6672 6f6d 206d 6567  ri_join.from meg
+000004a0: 6669 6c65 2e6c 6962 2e73 335f 6275 6666  file.lib.s3_buff
+000004b0: 6572 6564 5f77 7269 7465 7220 696d 706f  ered_writer impo
+000004c0: 7274 2044 4546 4155 4c54 5f4d 4158 5f42  rt DEFAULT_MAX_B
+000004d0: 5546 4645 525f 5349 5a45 2c20 474c 4f42  UFFER_SIZE, GLOB
+000004e0: 414c 5f4d 4158 5f57 4f52 4b45 5253 2c20  AL_MAX_WORKERS, 
+000004f0: 5333 4275 6666 6572 6564 5772 6974 6572  S3BufferedWriter
+00000500: 0a66 726f 6d20 6d65 6766 696c 652e 6c69  .from megfile.li
+00000510: 622e 7333 5f63 6163 6865 645f 6861 6e64  b.s3_cached_hand
+00000520: 6c65 7220 696d 706f 7274 2053 3343 6163  ler import S3Cac
+00000530: 6865 6448 616e 646c 6572 0a66 726f 6d20  hedHandler.from 
+00000540: 6d65 6766 696c 652e 6c69 622e 7333 5f6c  megfile.lib.s3_l
+00000550: 696d 6974 6564 5f73 6565 6b61 626c 655f  imited_seekable_
+00000560: 7772 6974 6572 2069 6d70 6f72 7420 5333  writer import S3
+00000570: 4c69 6d69 7465 6453 6565 6b61 626c 6557  LimitedSeekableW
+00000580: 7269 7465 720a 6672 6f6d 206d 6567 6669  riter.from megfi
+00000590: 6c65 2e6c 6962 2e73 335f 6d65 6d6f 7279  le.lib.s3_memory
+000005a0: 5f68 616e 646c 6572 2069 6d70 6f72 7420  _handler import 
+000005b0: 5333 4d65 6d6f 7279 4861 6e64 6c65 720a  S3MemoryHandler.
+000005c0: 6672 6f6d 206d 6567 6669 6c65 2e6c 6962  from megfile.lib
+000005d0: 2e73 335f 7069 7065 5f68 616e 646c 6572  .s3_pipe_handler
+000005e0: 2069 6d70 6f72 7420 5333 5069 7065 4861   import S3PipeHa
+000005f0: 6e64 6c65 720a 6672 6f6d 206d 6567 6669  ndler.from megfi
+00000600: 6c65 2e6c 6962 2e73 335f 7072 6566 6574  le.lib.s3_prefet
+00000610: 6368 5f72 6561 6465 7220 696d 706f 7274  ch_reader import
+00000620: 2044 4546 4155 4c54 5f42 4c4f 434b 5f53   DEFAULT_BLOCK_S
+00000630: 495a 452c 2053 3350 7265 6665 7463 6852  IZE, S3PrefetchR
+00000640: 6561 6465 720a 6672 6f6d 206d 6567 6669  eader.from megfi
+00000650: 6c65 2e6c 6962 2e73 335f 7368 6172 655f  le.lib.s3_share_
+00000660: 6361 6368 655f 7265 6164 6572 2069 6d70  cache_reader imp
+00000670: 6f72 7420 5333 5368 6172 6543 6163 6865  ort S3ShareCache
+00000680: 5265 6164 6572 0a66 726f 6d20 6d65 6766  Reader.from megf
+00000690: 696c 652e 6c69 622e 7572 6c20 696d 706f  ile.lib.url impo
+000006a0: 7274 2067 6574 5f75 726c 5f73 6368 656d  rt get_url_schem
+000006b0: 650a 6672 6f6d 206d 6567 6669 6c65 2e73  e.from megfile.s
+000006c0: 6d61 7274 5f70 6174 6820 696d 706f 7274  mart_path import
+000006d0: 2053 6d61 7274 5061 7468 0a66 726f 6d20   SmartPath.from 
+000006e0: 6d65 6766 696c 652e 7574 696c 7320 696d  megfile.utils im
+000006f0: 706f 7274 2063 6163 6865 6470 726f 7065  port cachedprope
+00000700: 7274 792c 2063 616c 6375 6c61 7465 5f6d  rty, calculate_m
+00000710: 6435 2c20 6765 6e65 7261 7465 5f63 6163  d5, generate_cac
+00000720: 6865 5f70 6174 682c 2067 6574 5f62 696e  he_path, get_bin
+00000730: 6172 795f 6d6f 6465 2c20 6765 745f 636f  ary_mode, get_co
+00000740: 6e74 656e 745f 6f66 6673 6574 2c20 6973  ntent_offset, is
+00000750: 5f72 6561 6461 626c 652c 206e 6563 6573  _readable, neces
+00000760: 7361 7279 5f70 6172 616d 732c 2074 6872  sary_params, thr
+00000770: 6561 645f 6c6f 6361 6c0a 0a5f 5f61 6c6c  ead_local..__all
+00000780: 5f5f 203d 205b 0a20 2020 2027 5333 5061  __ = [.    'S3Pa
+00000790: 7468 272c 0a20 2020 2027 7061 7273 655f  th',.    'parse_
+000007a0: 7333 5f75 726c 272c 0a20 2020 2027 6765  s3_url',.    'ge
+000007b0: 745f 656e 6470 6f69 6e74 5f75 726c 272c  t_endpoint_url',
+000007c0: 0a20 2020 2027 6765 745f 7333 5f73 6573  .    'get_s3_ses
+000007d0: 7369 6f6e 272c 0a20 2020 2027 6765 745f  sion',.    'get_
+000007e0: 7333 5f63 6c69 656e 7427 2c0a 2020 2020  s3_client',.    
+000007f0: 2773 335f 7061 7468 5f6a 6f69 6e27 2c0a  's3_path_join',.
+00000800: 2020 2020 2769 735f 7333 272c 0a20 2020      'is_s3',.   
+00000810: 2027 7333 5f62 7566 6665 7265 645f 6f70   's3_buffered_op
+00000820: 656e 272c 0a20 2020 2027 7333 5f63 6163  en',.    's3_cac
+00000830: 6865 645f 6f70 656e 272c 0a20 2020 2027  hed_open',.    '
+00000840: 7333 5f64 6f77 6e6c 6f61 6427 2c0a 2020  s3_download',.  
+00000850: 2020 2773 335f 6d65 6d6f 7279 5f6f 7065    's3_memory_ope
+00000860: 6e27 2c0a 2020 2020 2773 335f 7069 7065  n',.    's3_pipe
+00000870: 5f6f 7065 6e27 2c0a 2020 2020 2773 335f  _open',.    's3_
+00000880: 7072 6566 6574 6368 5f6f 7065 6e27 2c0a  prefetch_open',.
+00000890: 2020 2020 2773 335f 7368 6172 655f 6361      's3_share_ca
+000008a0: 6368 655f 6f70 656e 272c 0a20 2020 2027  che_open',.    '
+000008b0: 7333 5f6f 7065 6e27 2c0a 2020 2020 2753  s3_open',.    'S
+000008c0: 3343 6163 6865 7227 2c0a 2020 2020 2753  3Cacher',.    'S
+000008d0: 3342 7566 6665 7265 6457 7269 7465 7227  3BufferedWriter'
+000008e0: 2c0a 2020 2020 2753 334c 696d 6974 6564  ,.    'S3Limited
+000008f0: 5365 656b 6162 6c65 5772 6974 6572 272c  SeekableWriter',
+00000900: 0a20 2020 2027 5333 5072 6566 6574 6368  .    'S3Prefetch
+00000910: 5265 6164 6572 272c 0a20 2020 2027 5333  Reader',.    'S3
+00000920: 5368 6172 6543 6163 6865 5265 6164 6572  ShareCacheReader
+00000930: 272c 0a20 2020 2027 7333 5f75 706c 6f61  ',.    's3_uploa
+00000940: 6427 2c0a 2020 2020 2773 335f 646f 776e  d',.    's3_down
+00000950: 6c6f 6164 272c 0a20 2020 2027 7333 5f6c  load',.    's3_l
+00000960: 6f61 645f 636f 6e74 656e 7427 2c0a 2020  oad_content',.  
+00000970: 2020 2773 335f 7265 6164 6c69 6e6b 272c    's3_readlink',
+00000980: 0a20 2020 2027 7333 5f67 6c6f 6227 2c0a  .    's3_glob',.
+00000990: 2020 2020 2773 335f 676c 6f62 5f73 7461      's3_glob_sta
+000009a0: 7427 2c0a 2020 2020 2773 335f 6967 6c6f  t',.    's3_iglo
+000009b0: 6227 2c0a 2020 2020 2773 335f 7265 6e61  b',.    's3_rena
+000009c0: 6d65 272c 0a20 2020 2027 7333 5f6d 616b  me',.    's3_mak
+000009d0: 6564 6972 7327 2c0a 2020 2020 2773 335f  edirs',.    's3_
+000009e0: 636f 6e63 6174 272c 0a5d 0a5f 6c6f 6767  concat',.]._logg
+000009f0: 6572 203d 2067 6574 5f6c 6f67 6765 7228  er = get_logger(
+00000a00: 5f5f 6e61 6d65 5f5f 290a 636f 6e74 656e  __name__).conten
+00000a10: 745f 6d64 355f 6865 6164 6572 203d 2027  t_md5_header = '
+00000a20: 6d65 6766 696c 652d 636f 6e74 656e 742d  megfile-content-
+00000a30: 6d64 3527 0a65 6e64 706f 696e 745f 7572  md5'.endpoint_ur
+00000a40: 6c20 3d20 2768 7474 7073 3a2f 2f73 332e  l = 'https://s3.
+00000a50: 616d 617a 6f6e 6177 732e 636f 6d27 0a6d  amazonaws.com'.m
+00000a60: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
+00000a70: 6f6e 7320 3d20 3332 0a6d 6178 5f72 6574  ons = 32.max_ret
+00000a80: 7269 6573 203d 2031 300a 6d61 785f 6b65  ries = 10.max_ke
+00000a90: 7973 203d 2031 3030 300a 0a0a 6465 6620  ys = 1000...def 
+00000aa0: 5f70 6174 6368 5f6d 616b 655f 7265 7175  _patch_make_requ
+00000ab0: 6573 7428 636c 6965 6e74 3a20 626f 746f  est(client: boto
+00000ac0: 636f 7265 2e63 6c69 656e 742e 4261 7365  core.client.Base
+00000ad0: 436c 6965 6e74 293a 0a0a 2020 2020 6465  Client):..    de
+00000ae0: 6620 6166 7465 725f 6361 6c6c 6261 636b  f after_callback
+00000af0: 2872 6573 756c 743a 2054 7570 6c65 5b41  (result: Tuple[A
+00000b00: 5753 5265 7370 6f6e 7365 2c20 6469 6374  WSResponse, dict
+00000b10: 5d2c 202a 6172 6773 2c20 2a2a 6b77 6172  ], *args, **kwar
+00000b20: 6773 293a 0a20 2020 2020 2020 2069 6620  gs):.        if 
+00000b30: 6e6f 7420 6973 696e 7374 616e 6365 2872  not isinstance(r
+00000b40: 6573 756c 742c 2074 7570 6c65 2920 6f72  esult, tuple) or
+00000b50: 206c 656e 2872 6573 756c 7429 2021 3d20   len(result) != 
+00000b60: 3220 5c0a 2020 2020 2020 2020 2020 2020  2 \.            
+00000b70: 6f72 206e 6f74 2069 7369 6e73 7461 6e63  or not isinstanc
+00000b80: 6528 7265 7375 6c74 5b30 5d2c 2041 5753  e(result[0], AWS
+00000b90: 5265 7370 6f6e 7365 2920 6f72 206e 6f74  Response) or not
+00000ba0: 2069 7369 6e73 7461 6e63 6528 7265 7375   isinstance(resu
+00000bb0: 6c74 5b31 5d2c 2064 6963 7429 3a0a 2020  lt[1], dict):.  
+00000bc0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00000bd0: 2072 6573 756c 740a 2020 2020 2020 2020   result.        
+00000be0: 6874 7470 2c20 7061 7273 6564 5f72 6573  http, parsed_res
+00000bf0: 706f 6e73 6520 3d20 7265 7375 6c74 0a20  ponse = result. 
+00000c00: 2020 2020 2020 2069 6620 6874 7470 2e73         if http.s
+00000c10: 7461 7475 735f 636f 6465 203e 3d20 3530  tatus_code >= 50
+00000c20: 303a 0a20 2020 2020 2020 2020 2020 2065  0:.            e
+00000c30: 7272 6f72 5f63 6f64 6520 3d20 7061 7273  rror_code = pars
+00000c40: 6564 5f72 6573 706f 6e73 652e 6765 7428  ed_response.get(
+00000c50: 2245 7272 6f72 222c 207b 7d29 2e67 6574  "Error", {}).get
+00000c60: 2822 436f 6465 2229 0a20 2020 2020 2020  ("Code").       
+00000c70: 2020 2020 206f 7065 7261 7469 6f6e 5f6d       operation_m
+00000c80: 6f64 656c 203d 206b 7761 7267 732e 6765  odel = kwargs.ge
+00000c90: 7428 276f 7065 7261 7469 6f6e 5f6d 6f64  t('operation_mod
+00000ca0: 656c 2729 206f 7220 280a 2020 2020 2020  el') or (.      
+00000cb0: 2020 2020 2020 2020 2020 6172 6773 5b30            args[0
+00000cc0: 5d20 6966 2061 7267 7320 656c 7365 204e  ] if args else N
+00000cd0: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
+00000ce0: 206f 7065 7261 7469 6f6e 5f6e 616d 6520   operation_name 
+00000cf0: 3d20 6f70 6572 6174 696f 6e5f 6d6f 6465  = operation_mode
+00000d00: 6c2e 6e61 6d65 2069 6620 6f70 6572 6174  l.name if operat
+00000d10: 696f 6e5f 6d6f 6465 6c20 656c 7365 2027  ion_model else '
+00000d20: 5072 6f78 794d 6574 686f 6427 0a20 2020  ProxyMethod'.   
+00000d30: 2020 2020 2020 2020 2065 7272 6f72 5f63           error_c
+00000d40: 6c61 7373 203d 2063 6c69 656e 742e 6578  lass = client.ex
+00000d50: 6365 7074 696f 6e73 2e66 726f 6d5f 636f  ceptions.from_co
+00000d60: 6465 2865 7272 6f72 5f63 6f64 6529 0a20  de(error_code). 
+00000d70: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00000d80: 2065 7272 6f72 5f63 6c61 7373 2870 6172   error_class(par
+00000d90: 7365 645f 7265 7370 6f6e 7365 2c20 6f70  sed_response, op
+00000da0: 6572 6174 696f 6e5f 6e61 6d65 290a 2020  eration_name).  
+00000db0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00000dc0: 756c 740a 0a20 2020 2064 6566 2072 6574  ult..    def ret
+00000dd0: 7279 5f63 616c 6c62 6163 6b28 6572 726f  ry_callback(erro
+00000de0: 722c 206f 7065 7261 7469 6f6e 5f6d 6f64  r, operation_mod
+00000df0: 656c 2c20 7265 7175 6573 745f 6469 6374  el, request_dict
+00000e00: 2c20 7265 7175 6573 745f 636f 6e74 6578  , request_contex
+00000e10: 7429 3a0a 2020 2020 2020 2020 6966 2065  t):.        if e
+00000e20: 7272 6f72 2069 7320 4e6f 6e65 3a20 2023  rror is None:  #
+00000e30: 2072 6574 7279 2066 6f72 2074 6865 2066   retry for the f
+00000e40: 6972 7374 2074 696d 650a 2020 2020 2020  irst time.      
+00000e50: 2020 2020 2020 6572 726f 725f 6c6f 6767        error_logg
+00000e60: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
+00000e70: 2020 2020 2020 2020 2020 2766 6169 6c65            'faile
+00000e80: 6420 746f 2070 726f 6365 7373 3a20 2572  d to process: %r
+00000e90: 2c20 7769 7468 2070 6172 616d 6574 6572  , with parameter
+00000ea0: 733a 2025 7327 2c0a 2020 2020 2020 2020  s: %s',.        
+00000eb0: 2020 2020 2020 2020 6f70 6572 6174 696f          operatio
+00000ec0: 6e5f 6d6f 6465 6c2e 6e61 6d65 2c20 7265  n_model.name, re
+00000ed0: 7175 6573 745f 6469 6374 290a 2020 2020  quest_dict).    
+00000ee0: 2020 2020 6966 2069 735f 7265 6164 6162      if is_readab
+00000ef0: 6c65 2872 6571 7565 7374 5f64 6963 745b  le(request_dict[
+00000f00: 2762 6f64 7927 5d29 3a0a 2020 2020 2020  'body']):.      
+00000f10: 2020 2020 2020 7265 7175 6573 745f 6469        request_di
+00000f20: 6374 5b27 626f 6479 275d 2e73 6565 6b28  ct['body'].seek(
+00000f30: 3029 0a0a 2020 2020 6465 6620 6265 666f  0)..    def befo
+00000f40: 7265 5f63 616c 6c62 6163 6b28 6f70 6572  re_callback(oper
+00000f50: 6174 696f 6e5f 6d6f 6465 6c2c 2072 6571  ation_model, req
+00000f60: 7565 7374 5f64 6963 742c 2072 6571 7565  uest_dict, reque
+00000f70: 7374 5f63 6f6e 7465 7874 293a 0a20 2020  st_context):.   
+00000f80: 2020 2020 205f 6c6f 6767 6572 2e64 6562       _logger.deb
+00000f90: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00000fa0: 2773 656e 6420 7333 2072 6571 7565 7374  'send s3 request
+00000fb0: 3a20 2572 2c20 7769 7468 2070 6172 616d  : %r, with param
+00000fc0: 6574 6572 733a 2025 7327 2c20 6f70 6572  eters: %s', oper
+00000fd0: 6174 696f 6e5f 6d6f 6465 6c2e 6e61 6d65  ation_model.name
+00000fe0: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+00000ff0: 7175 6573 745f 6469 6374 290a 0a20 2020  quest_dict)..   
+00001000: 2063 6c69 656e 742e 5f6d 616b 655f 7265   client._make_re
+00001010: 7175 6573 7420 3d20 7061 7463 685f 6d65  quest = patch_me
+00001020: 7468 6f64 280a 2020 2020 2020 2020 636c  thod(.        cl
+00001030: 6965 6e74 2e5f 6d61 6b65 5f72 6571 7565  ient._make_reque
+00001040: 7374 2c0a 2020 2020 2020 2020 6d61 785f  st,.        max_
+00001050: 7265 7472 6965 733d 6d61 785f 7265 7472  retries=max_retr
+00001060: 6965 732c 0a20 2020 2020 2020 2073 686f  ies,.        sho
+00001070: 756c 645f 7265 7472 793d 7333 5f73 686f  uld_retry=s3_sho
+00001080: 756c 645f 7265 7472 792c 0a20 2020 2020  uld_retry,.     
+00001090: 2020 2061 6674 6572 5f63 616c 6c62 6163     after_callbac
+000010a0: 6b3d 6166 7465 725f 6361 6c6c 6261 636b  k=after_callback
+000010b0: 2c0a 2020 2020 2020 2020 6265 666f 7265  ,.        before
+000010c0: 5f63 616c 6c62 6163 6b3d 6265 666f 7265  _callback=before
+000010d0: 5f63 616c 6c62 6163 6b2c 0a20 2020 2020  _callback,.     
+000010e0: 2020 2072 6574 7279 5f63 616c 6c62 6163     retry_callbac
+000010f0: 6b3d 7265 7472 795f 6361 6c6c 6261 636b  k=retry_callback
+00001100: 290a 2020 2020 7265 7475 726e 2063 6c69  ).    return cli
+00001110: 656e 740a 0a0a 6465 6620 7061 7273 655f  ent...def parse_
+00001120: 7333 5f75 726c 2873 335f 7572 6c3a 2050  s3_url(s3_url: P
+00001130: 6174 684c 696b 6529 202d 3e20 5475 706c  athLike) -> Tupl
+00001140: 655b 7374 722c 2073 7472 5d3a 0a20 2020  e[str, str]:.   
+00001150: 2073 335f 7572 6c20 3d20 6673 7061 7468   s3_url = fspath
+00001160: 2873 335f 7572 6c29 0a20 2020 2069 6620  (s3_url).    if 
+00001170: 6e6f 7420 6973 5f73 3328 7333 5f75 726c  not is_s3(s3_url
+00001180: 293a 0a20 2020 2020 2020 2072 6169 7365  ):.        raise
+00001190: 2056 616c 7565 4572 726f 7228 274e 6f74   ValueError('Not
+000011a0: 2061 2073 3320 7572 6c3a 2025 7227 2025   a s3 url: %r' %
+000011b0: 2073 335f 7572 6c29 0a20 2020 2072 6967   s3_url).    rig
+000011c0: 6874 7061 7274 203d 2073 335f 7572 6c2e  htpart = s3_url.
+000011d0: 7370 6c69 7428 273a 2f2f 272c 206d 6178  split('://', max
+000011e0: 7370 6c69 743d 3129 5b31 5d0a 2020 2020  split=1)[1].    
+000011f0: 6275 636b 6574 6d61 7463 6820 3d20 7265  bucketmatch = re
+00001200: 2e6d 6174 6368 2827 282e 2a3f 292f 272c  .match('(.*?)/',
+00001210: 2072 6967 6874 7061 7274 290a 2020 2020   rightpart).    
+00001220: 6966 2062 7563 6b65 746d 6174 6368 2069  if bucketmatch i
+00001230: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00001240: 6275 636b 6574 203d 2072 6967 6874 7061  bucket = rightpa
+00001250: 7274 0a20 2020 2020 2020 2070 6174 6820  rt.        path 
+00001260: 3d20 2727 0a20 2020 2065 6c73 653a 0a20  = ''.    else:. 
+00001270: 2020 2020 2020 2062 7563 6b65 7420 3d20         bucket = 
+00001280: 6275 636b 6574 6d61 7463 682e 6772 6f75  bucketmatch.grou
+00001290: 7028 3129 0a20 2020 2020 2020 2070 6174  p(1).        pat
+000012a0: 6820 3d20 7269 6768 7470 6172 745b 6c65  h = rightpart[le
+000012b0: 6e28 6275 636b 6574 2920 2b20 313a 5d0a  n(bucket) + 1:].
+000012c0: 2020 2020 7265 7475 726e 2062 7563 6b65      return bucke
+000012d0: 742c 2070 6174 680a 0a0a 6465 6620 6765  t, path...def ge
+000012e0: 745f 7363 6f70 6564 5f63 6f6e 6669 6728  t_scoped_config(
+000012f0: 7072 6f66 696c 655f 6e61 6d65 3a20 4f70  profile_name: Op
+00001300: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
+00001310: 6e65 2920 2d3e 2044 6963 743a 0a20 2020  ne) -> Dict:.   
+00001320: 2072 6574 7572 6e20 6765 745f 7333 5f73   return get_s3_s
+00001330: 6573 7369 6f6e 280a 2020 2020 2020 2020  ession(.        
+00001340: 7072 6f66 696c 655f 6e61 6d65 3d70 726f  profile_name=pro
+00001350: 6669 6c65 5f6e 616d 6529 2e5f 7365 7373  file_name)._sess
+00001360: 696f 6e2e 6765 745f 7363 6f70 6564 5f63  ion.get_scoped_c
+00001370: 6f6e 6669 6728 290a 0a0a 406c 7275 5f63  onfig()...@lru_c
+00001380: 6163 6865 2829 0a64 6566 2077 6172 6e69  ache().def warni
+00001390: 6e67 5f65 6e64 706f 696e 745f 7572 6c28  ng_endpoint_url(
+000013a0: 6b65 793a 2073 7472 2c20 656e 6470 6f69  key: str, endpoi
+000013b0: 6e74 5f75 726c 3a20 7374 7229 3a0a 2020  nt_url: str):.  
+000013c0: 2020 5f6c 6f67 6765 722e 696e 666f 2822    _logger.info("
+000013d0: 7573 696e 6720 2573 3a20 2573 2220 2520  using %s: %s" % 
+000013e0: 286b 6579 2c20 656e 6470 6f69 6e74 5f75  (key, endpoint_u
+000013f0: 726c 2929 0a0a 0a64 6566 2067 6574 5f65  rl))...def get_e
+00001400: 6e64 706f 696e 745f 7572 6c28 7072 6f66  ndpoint_url(prof
+00001410: 696c 655f 6e61 6d65 3a20 4f70 7469 6f6e  ile_name: Option
+00001420: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2920  al[str] = None) 
+00001430: 2d3e 2073 7472 3a0a 2020 2020 2727 2747  -> str:.    '''G
+00001440: 6574 2074 6865 2065 6e64 706f 696e 7420  et the endpoint 
+00001450: 7572 6c20 6f66 2053 330a 0a20 2020 203a  url of S3..    :
+00001460: 7265 7475 726e 733a 2053 3320 656e 6470  returns: S3 endp
+00001470: 6f69 6e74 2075 726c 0a20 2020 2027 2727  oint url.    '''
+00001480: 0a20 2020 2065 6e76 6972 6f6e 5f6b 6579  .    environ_key
+00001490: 203d 2066 277b 7072 6f66 696c 655f 6e61   = f'{profile_na
+000014a0: 6d65 7d5f 5f4f 5353 5f45 4e44 504f 494e  me}__OSS_ENDPOIN
+000014b0: 5427 2e75 7070 6572 280a 2020 2020 2920  T'.upper(.    ) 
+000014c0: 6966 2070 726f 6669 6c65 5f6e 616d 6520  if profile_name 
+000014d0: 656c 7365 2027 4f53 535f 454e 4450 4f49  else 'OSS_ENDPOI
+000014e0: 4e54 270a 2020 2020 656e 7669 726f 6e5f  NT'.    environ_
+000014f0: 656e 6470 6f69 6e74 5f75 726c 203d 206f  endpoint_url = o
+00001500: 732e 656e 7669 726f 6e2e 6765 7428 656e  s.environ.get(en
+00001510: 7669 726f 6e5f 6b65 7929 0a20 2020 2069  viron_key).    i
+00001520: 6620 656e 7669 726f 6e5f 656e 6470 6f69  f environ_endpoi
+00001530: 6e74 5f75 726c 3a0a 2020 2020 2020 2020  nt_url:.        
+00001540: 7761 726e 696e 675f 656e 6470 6f69 6e74  warning_endpoint
+00001550: 5f75 726c 2865 6e76 6972 6f6e 5f6b 6579  _url(environ_key
+00001560: 2c20 656e 7669 726f 6e5f 656e 6470 6f69  , environ_endpoi
+00001570: 6e74 5f75 726c 290a 2020 2020 2020 2020  nt_url).        
+00001580: 7265 7475 726e 2065 6e76 6972 6f6e 5f65  return environ_e
+00001590: 6e64 706f 696e 745f 7572 6c0a 2020 2020  ndpoint_url.    
+000015a0: 7472 793a 0a20 2020 2020 2020 2063 6f6e  try:.        con
+000015b0: 6669 675f 656e 6470 6f69 6e74 5f75 726c  fig_endpoint_url
+000015c0: 203d 2067 6574 5f73 636f 7065 645f 636f   = get_scoped_co
+000015d0: 6e66 6967 2870 726f 6669 6c65 5f6e 616d  nfig(profile_nam
+000015e0: 653d 7072 6f66 696c 655f 6e61 6d65 292e  e=profile_name).
+000015f0: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+00001600: 2027 7333 272c 207b 7d29 2e67 6574 2827   's3', {}).get('
+00001610: 656e 6470 6f69 6e74 5f75 726c 2729 0a20  endpoint_url'). 
+00001620: 2020 2020 2020 2069 6620 636f 6e66 6967         if config
+00001630: 5f65 6e64 706f 696e 745f 7572 6c3a 0a20  _endpoint_url:. 
+00001640: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
+00001650: 6e67 5f65 6e64 706f 696e 745f 7572 6c28  ng_endpoint_url(
+00001660: 277e 2f2e 6177 732f 636f 6e66 6967 272c  '~/.aws/config',
+00001670: 2063 6f6e 6669 675f 656e 6470 6f69 6e74   config_endpoint
+00001680: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
+00001690: 2020 7265 7475 726e 2063 6f6e 6669 675f    return config_
+000016a0: 656e 6470 6f69 6e74 5f75 726c 0a20 2020  endpoint_url.   
+000016b0: 2065 7863 6570 7420 626f 746f 636f 7265   except botocore
+000016c0: 2e65 7863 6570 7469 6f6e 732e 5072 6f66  .exceptions.Prof
+000016d0: 696c 654e 6f74 466f 756e 643a 2020 2320  ileNotFound:  # 
+000016e0: 7072 6167 6d61 3a20 6e6f 2063 6f76 6572  pragma: no cover
+000016f0: 0a20 2020 2020 2020 2070 6173 730a 2020  .        pass.  
+00001700: 2020 7265 7475 726e 2065 6e64 706f 696e    return endpoin
+00001710: 745f 7572 6c0a 0a0a 6465 6620 6765 745f  t_url...def get_
+00001720: 7333 5f73 6573 7369 6f6e 2870 726f 6669  s3_session(profi
+00001730: 6c65 5f6e 616d 653d 4e6f 6e65 293a 0a20  le_name=None):. 
+00001740: 2020 2027 2727 4765 7420 5333 2073 6573     '''Get S3 ses
+00001750: 7369 6f6e 0a0a 2020 2020 3a72 6574 7572  sion..    :retur
+00001760: 6e73 3a20 5333 2073 6573 7369 6f6e 0a20  ns: S3 session. 
+00001770: 2020 2027 2727 0a20 2020 2072 6574 7572     '''.    retur
+00001780: 6e20 7468 7265 6164 5f6c 6f63 616c 280a  n thread_local(.
+00001790: 2020 2020 2020 2020 6627 7333 5f73 6573          f's3_ses
+000017a0: 7369 6f6e 3a7b 7072 6f66 696c 655f 6e61  sion:{profile_na
+000017b0: 6d65 7d27 2c20 626f 746f 332e 5365 7373  me}', boto3.Sess
+000017c0: 696f 6e2c 2070 726f 6669 6c65 5f6e 616d  ion, profile_nam
+000017d0: 653d 7072 6f66 696c 655f 6e61 6d65 290a  e=profile_name).
+000017e0: 0a0a 6465 6620 6765 745f 6163 6365 7373  ..def get_access
+000017f0: 5f74 6f6b 656e 2870 726f 6669 6c65 5f6e  _token(profile_n
+00001800: 616d 653d 4e6f 6e65 293a 0a20 2020 2061  ame=None):.    a
+00001810: 6363 6573 735f 6b65 795f 656e 765f 6e61  ccess_key_env_na
+00001820: 6d65 203d 2066 227b 7072 6f66 696c 655f  me = f"{profile_
+00001830: 6e61 6d65 7d5f 5f41 5753 5f41 4343 4553  name}__AWS_ACCES
+00001840: 535f 4b45 595f 4944 222e 7570 7065 7228  S_KEY_ID".upper(
+00001850: 0a20 2020 2029 2069 6620 7072 6f66 696c  .    ) if profil
+00001860: 655f 6e61 6d65 2065 6c73 6520 2241 5753  e_name else "AWS
+00001870: 5f41 4343 4553 535f 4b45 595f 4944 220a  _ACCESS_KEY_ID".
+00001880: 2020 2020 7365 6372 6574 5f6b 6579 5f65      secret_key_e
+00001890: 6e76 5f6e 616d 6520 3d20 6622 7b70 726f  nv_name = f"{pro
+000018a0: 6669 6c65 5f6e 616d 657d 5f5f 4157 535f  file_name}__AWS_
+000018b0: 5345 4352 4554 5f41 4343 4553 535f 4b45  SECRET_ACCESS_KE
+000018c0: 5922 2e75 7070 6572 280a 2020 2020 2920  Y".upper(.    ) 
+000018d0: 6966 2070 726f 6669 6c65 5f6e 616d 6520  if profile_name 
+000018e0: 656c 7365 2022 4157 535f 5345 4352 4554  else "AWS_SECRET
+000018f0: 5f41 4343 4553 535f 4b45 5922 0a20 2020  _ACCESS_KEY".   
+00001900: 2061 6363 6573 735f 6b65 7920 3d20 6f73   access_key = os
+00001910: 2e67 6574 656e 7628 6163 6365 7373 5f6b  .getenv(access_k
+00001920: 6579 5f65 6e76 5f6e 616d 6529 0a20 2020  ey_env_name).   
+00001930: 2073 6563 7265 745f 6b65 7920 3d20 6f73   secret_key = os
+00001940: 2e67 6574 656e 7628 7365 6372 6574 5f6b  .getenv(secret_k
+00001950: 6579 5f65 6e76 5f6e 616d 6529 0a20 2020  ey_env_name).   
+00001960: 2069 6620 6163 6365 7373 5f6b 6579 2061   if access_key a
+00001970: 6e64 2073 6563 7265 745f 6b65 793a 0a20  nd secret_key:. 
+00001980: 2020 2020 2020 2072 6574 7572 6e20 6163         return ac
+00001990: 6365 7373 5f6b 6579 2c20 7365 6372 6574  cess_key, secret
+000019a0: 5f6b 6579 0a0a 2020 2020 6372 6564 656e  _key..    creden
+000019b0: 7469 616c 7320 3d20 6765 745f 7333 5f73  tials = get_s3_s
+000019c0: 6573 7369 6f6e 2870 726f 6669 6c65 5f6e  ession(profile_n
+000019d0: 616d 653d 7072 6f66 696c 655f 6e61 6d65  ame=profile_name
+000019e0: 292e 6765 745f 6372 6564 656e 7469 616c  ).get_credential
+000019f0: 7328 290a 2020 2020 6966 2063 7265 6465  s().    if crede
+00001a00: 6e74 6961 6c73 3a0a 2020 2020 2020 2020  ntials:.        
+00001a10: 6966 206e 6f74 2061 6363 6573 735f 6b65  if not access_ke
+00001a20: 793a 0a20 2020 2020 2020 2020 2020 2061  y:.            a
+00001a30: 6363 6573 735f 6b65 7920 3d20 6372 6564  ccess_key = cred
+00001a40: 656e 7469 616c 732e 6163 6365 7373 5f6b  entials.access_k
+00001a50: 6579 0a20 2020 2020 2020 2069 6620 6e6f  ey.        if no
+00001a60: 7420 7365 6372 6574 5f6b 6579 3a0a 2020  t secret_key:.  
+00001a70: 2020 2020 2020 2020 2020 7365 6372 6574            secret
+00001a80: 5f6b 6579 203d 2063 7265 6465 6e74 6961  _key = credentia
+00001a90: 6c73 2e73 6563 7265 745f 6b65 790a 2020  ls.secret_key.  
+00001aa0: 2020 7265 7475 726e 2061 6363 6573 735f    return access_
+00001ab0: 6b65 792c 2073 6563 7265 745f 6b65 790a  key, secret_key.
+00001ac0: 0a0a 6465 6620 6765 745f 7333 5f63 6c69  ..def get_s3_cli
+00001ad0: 656e 7428 0a20 2020 2020 2020 2063 6f6e  ent(.        con
+00001ae0: 6669 673a 204f 7074 696f 6e61 6c5b 626f  fig: Optional[bo
+00001af0: 746f 636f 7265 2e63 6f6e 6669 672e 436f  tocore.config.Co
+00001b00: 6e66 6967 5d20 3d20 4e6f 6e65 2c0a 2020  nfig] = None,.  
+00001b10: 2020 2020 2020 6361 6368 655f 6b65 793a        cache_key:
+00001b20: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+00001b30: 204e 6f6e 652c 0a20 2020 2020 2020 2070   None,.        p
+00001b40: 726f 6669 6c65 5f6e 616d 653a 204f 7074  rofile_name: Opt
+00001b50: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00001b60: 6529 3a0a 2020 2020 2727 2747 6574 2053  e):.    '''Get S
+00001b70: 3320 636c 6965 6e74 0a0a 2020 2020 3a72  3 client..    :r
+00001b80: 6574 7572 6e73 3a20 5333 2063 6c69 656e  eturns: S3 clien
+00001b90: 740a 2020 2020 2727 270a 2020 2020 6966  t.    '''.    if
+00001ba0: 2063 6163 6865 5f6b 6579 2069 7320 6e6f   cache_key is no
+00001bb0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00001bc0: 7265 7475 726e 2074 6872 6561 645f 6c6f  return thread_lo
+00001bd0: 6361 6c28 0a20 2020 2020 2020 2020 2020  cal(.           
+00001be0: 2063 6163 6865 5f6b 6579 2c20 6765 745f   cache_key, get_
+00001bf0: 7333 5f63 6c69 656e 742c 2063 6f6e 6669  s3_client, confi
+00001c00: 673d 636f 6e66 6967 2c20 7072 6f66 696c  g=config, profil
+00001c10: 655f 6e61 6d65 3d70 726f 6669 6c65 5f6e  e_name=profile_n
+00001c20: 616d 6529 0a0a 2020 2020 6163 6365 7373  ame)..    access
+00001c30: 5f6b 6579 2c20 7365 6372 6574 5f6b 6579  _key, secret_key
+00001c40: 203d 2067 6574 5f61 6363 6573 735f 746f   = get_access_to
+00001c50: 6b65 6e28 7072 6f66 696c 655f 6e61 6d65  ken(profile_name
+00001c60: 290a 2020 2020 636c 6965 6e74 203d 2067  ).    client = g
+00001c70: 6574 5f73 335f 7365 7373 696f 6e28 292e  et_s3_session().
+00001c80: 636c 6965 6e74 280a 2020 2020 2020 2020  client(.        
+00001c90: 2773 3327 2c0a 2020 2020 2020 2020 656e  's3',.        en
+00001ca0: 6470 6f69 6e74 5f75 726c 3d67 6574 5f65  dpoint_url=get_e
+00001cb0: 6e64 706f 696e 745f 7572 6c28 7072 6f66  ndpoint_url(prof
+00001cc0: 696c 655f 6e61 6d65 3d70 726f 6669 6c65  ile_name=profile
+00001cd0: 5f6e 616d 6529 2c0a 2020 2020 2020 2020  _name),.        
+00001ce0: 636f 6e66 6967 3d63 6f6e 6669 672c 0a20  config=config,. 
+00001cf0: 2020 2020 2020 2061 7773 5f61 6363 6573         aws_acces
+00001d00: 735f 6b65 795f 6964 3d61 6363 6573 735f  s_key_id=access_
+00001d10: 6b65 792c 0a20 2020 2020 2020 2061 7773  key,.        aws
+00001d20: 5f73 6563 7265 745f 6163 6365 7373 5f6b  _secret_access_k
+00001d30: 6579 3d73 6563 7265 745f 6b65 792c 0a20  ey=secret_key,. 
+00001d40: 2020 2029 0a20 2020 2063 6c69 656e 7420     ).    client 
+00001d50: 3d20 5f70 6174 6368 5f6d 616b 655f 7265  = _patch_make_re
+00001d60: 7175 6573 7428 636c 6965 6e74 290a 2020  quest(client).  
+00001d70: 2020 7265 7475 726e 2063 6c69 656e 740a    return client.
+00001d80: 0a0a 6465 6620 7333 5f70 6174 685f 6a6f  ..def s3_path_jo
+00001d90: 696e 2870 6174 683a 2050 6174 684c 696b  in(path: PathLik
+00001da0: 652c 202a 6f74 6865 725f 7061 7468 733a  e, *other_paths:
+00001db0: 2050 6174 684c 696b 6529 202d 3e20 7374   PathLike) -> st
+00001dc0: 723a 0a20 2020 2027 2727 0a20 2020 2043  r:.    '''.    C
+00001dd0: 6f6e 6361 7420 3220 6f72 206d 6f72 6520  oncat 2 or more 
+00001de0: 7061 7468 2074 6f20 6120 636f 6d70 6c65  path to a comple
+00001df0: 7465 2070 6174 680a 0a20 2020 203a 7061  te path..    :pa
+00001e00: 7261 6d20 7061 7468 3a20 4769 7665 6e20  ram path: Given 
+00001e10: 7061 7468 0a20 2020 203a 7061 7261 6d20  path.    :param 
+00001e20: 6f74 6865 725f 7061 7468 733a 2050 6174  other_paths: Pat
+00001e30: 6873 2074 6f20 6265 2063 6f6e 6361 7465  hs to be concate
+00001e40: 6e61 7465 640a 2020 2020 3a72 6574 7572  nated.    :retur
+00001e50: 6e73 3a20 436f 6e63 6174 656e 6174 6564  ns: Concatenated
+00001e60: 2063 6f6d 706c 6574 6520 7061 7468 0a0a   complete path..
+00001e70: 2020 2020 2e2e 206e 6f74 6520 3a3a 0a0a      .. note ::..
+00001e80: 2020 2020 2020 2020 5468 6520 6469 6666          The diff
+00001e90: 6572 656e 6365 2062 6574 7765 656e 2074  erence between t
+00001ea0: 6869 7320 6675 6e63 7469 6f6e 2061 6e64  his function and
+00001eb0: 2060 606f 732e 7061 7468 2e6a 6f69 6e60   ``os.path.join`
+00001ec0: 6020 6973 2074 6861 7420 7468 6973 2066  ` is that this f
+00001ed0: 756e 6374 696f 6e20 6967 6e6f 7265 7320  unction ignores 
+00001ee0: 6c65 6674 2073 6964 6520 736c 6173 6820  left side slash 
+00001ef0: 2877 6869 6368 2069 6e64 6963 6174 6573  (which indicates
+00001f00: 2061 6273 6f6c 7574 6520 7061 7468 2920   absolute path) 
+00001f10: 696e 2060 606f 7468 6572 5f70 6174 6873  in ``other_paths
+00001f20: 6060 2061 6e64 2077 696c 6c20 6469 7265  `` and will dire
+00001f30: 6374 6c79 2063 6f6e 6361 742e 0a20 2020  ctly concat..   
+00001f40: 2020 2020 2065 2e67 2e20 6f73 2e70 6174       e.g. os.pat
+00001f50: 682e 6a6f 696e 2827 2f70 6174 6827 2c20  h.join('/path', 
+00001f60: 2774 6f27 2c20 272f 6669 6c65 2729 203d  'to', '/file') =
+00001f70: 3e20 272f 6669 6c65 272c 2062 7574 2073  > '/file', but s
+00001f80: 335f 7061 7468 5f6a 6f69 6e28 272f 7061  3_path_join('/pa
+00001f90: 7468 272c 2027 746f 272c 2027 2f66 696c  th', 'to', '/fil
+00001fa0: 6527 2920 3d3e 2027 2f70 6174 682f 746f  e') => '/path/to
+00001fb0: 2f66 696c 6527 0a20 2020 2027 2727 0a20  /file'.    '''. 
+00001fc0: 2020 2072 6574 7572 6e20 7572 695f 6a6f     return uri_jo
+00001fd0: 696e 2866 7370 6174 6828 7061 7468 292c  in(fspath(path),
+00001fe0: 202a 6d61 7028 6673 7061 7468 2c20 6f74   *map(fspath, ot
+00001ff0: 6865 725f 7061 7468 7329 290a 0a0a 6465  her_paths))...de
+00002000: 6620 5f6c 6973 745f 616c 6c5f 6275 636b  f _list_all_buck
+00002010: 6574 7328 7072 6f66 696c 655f 6e61 6d65  ets(profile_name
+00002020: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+00002030: 3d20 4e6f 6e65 2920 2d3e 204c 6973 745b  = None) -> List[
+00002040: 7374 725d 3a0a 2020 2020 636c 6965 6e74  str]:.    client
+00002050: 203d 2067 6574 5f73 335f 636c 6965 6e74   = get_s3_client
+00002060: 2870 726f 6669 6c65 5f6e 616d 653d 7072  (profile_name=pr
+00002070: 6f66 696c 655f 6e61 6d65 290a 2020 2020  ofile_name).    
+00002080: 7265 7370 6f6e 7365 203d 2063 6c69 656e  response = clien
+00002090: 742e 6c69 7374 5f62 7563 6b65 7473 2829  t.list_buckets()
+000020a0: 0a20 2020 2072 6574 7572 6e20 5b63 6f6e  .    return [con
+000020b0: 7465 6e74 5b27 4e61 6d65 275d 2066 6f72  tent['Name'] for
+000020c0: 2063 6f6e 7465 6e74 2069 6e20 7265 7370   content in resp
+000020d0: 6f6e 7365 5b27 4275 636b 6574 7327 5d5d  onse['Buckets']]
+000020e0: 0a0a 0a64 6566 205f 7061 7273 655f 7333  ...def _parse_s3
+000020f0: 5f75 726c 5f69 676e 6f72 655f 6272 6163  _url_ignore_brac
+00002100: 6528 7333 5f75 726c 3a20 7374 7229 202d  e(s3_url: str) -
+00002110: 3e20 5475 706c 655b 7374 722c 2073 7472  > Tuple[str, str
+00002120: 5d3a 0a20 2020 2073 335f 7572 6c20 3d20  ]:.    s3_url = 
+00002130: 6673 7061 7468 2873 335f 7572 6c29 0a20  fspath(s3_url). 
+00002140: 2020 2073 335f 7363 6865 6d65 2c20 7269     s3_scheme, ri
+00002150: 6768 7470 6172 7420 3d20 7333 5f75 726c  ghtpart = s3_url
+00002160: 5b3a 355d 2c20 7333 5f75 726c 5b35 3a5d  [:5], s3_url[5:]
+00002170: 0a20 2020 2069 6620 7333 5f73 6368 656d  .    if s3_schem
+00002180: 6520 213d 2027 7333 3a2f 2f27 3a0a 2020  e != 's3://':.  
+00002190: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+000021a0: 6545 7272 6f72 2827 4e6f 7420 6120 7333  eError('Not a s3
+000021b0: 2075 726c 3a20 2572 2720 2520 7333 5f75   url: %r' % s3_u
+000021c0: 726c 290a 2020 2020 6c65 6674 5f62 7261  rl).    left_bra
+000021d0: 6365 203d 2046 616c 7365 0a20 2020 2066  ce = False.    f
+000021e0: 6f72 2063 7572 7265 6e74 5f69 6e64 6578  or current_index
+000021f0: 2c20 6375 7272 656e 745f 6368 6172 6163  , current_charac
+00002200: 7465 7220 696e 2065 6e75 6d65 7261 7465  ter in enumerate
+00002210: 2872 6967 6874 7061 7274 293a 0a20 2020  (rightpart):.   
+00002220: 2020 2020 2069 6620 6375 7272 656e 745f       if current_
+00002230: 6368 6172 6163 7465 7220 3d3d 2022 2f22  character == "/"
+00002240: 2061 6e64 206c 6566 745f 6272 6163 6520   and left_brace 
+00002250: 6973 2046 616c 7365 3a0a 2020 2020 2020  is False:.      
+00002260: 2020 2020 2020 7265 7475 726e 2072 6967        return rig
+00002270: 6874 7061 7274 5b3a 6375 7272 656e 745f  htpart[:current_
+00002280: 696e 6465 785d 2c20 7269 6768 7470 6172  index], rightpar
+00002290: 745b 6375 7272 656e 745f 696e 6465 7820  t[current_index 
+000022a0: 2b20 313a 5d0a 2020 2020 2020 2020 656c  + 1:].        el
+000022b0: 6966 2063 7572 7265 6e74 5f63 6861 7261  if current_chara
+000022c0: 6374 6572 203d 3d20 227b 223a 0a20 2020  cter == "{":.   
+000022d0: 2020 2020 2020 2020 206c 6566 745f 6272           left_br
+000022e0: 6163 6520 3d20 5472 7565 0a20 2020 2020  ace = True.     
+000022f0: 2020 2065 6c69 6620 6375 7272 656e 745f     elif current_
+00002300: 6368 6172 6163 7465 7220 3d3d 2022 7d22  character == "}"
+00002310: 3a0a 2020 2020 2020 2020 2020 2020 6c65  :.            le
+00002320: 6674 5f62 7261 6365 203d 2046 616c 7365  ft_brace = False
+00002330: 0a20 2020 2072 6574 7572 6e20 7269 6768  .    return righ
+00002340: 7470 6172 742c 2022 220a 0a0a 6465 6620  tpart, ""...def 
+00002350: 5f67 726f 7570 5f73 3370 6174 685f 6279  _group_s3path_by
+00002360: 5f62 7563 6b65 7428 0a20 2020 2020 2020  _bucket(.       
+00002370: 2073 335f 7061 7468 6e61 6d65 3a20 7374   s3_pathname: st
+00002380: 722c 2070 726f 6669 6c65 5f6e 616d 653a  r, profile_name:
+00002390: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
+000023a0: 204e 6f6e 6529 202d 3e20 4c69 7374 5b73   None) -> List[s
+000023b0: 7472 5d3a 0a20 2020 2062 7563 6b65 742c  tr]:.    bucket,
+000023c0: 206b 6579 203d 205f 7061 7273 655f 7333   key = _parse_s3
+000023d0: 5f75 726c 5f69 676e 6f72 655f 6272 6163  _url_ignore_brac
+000023e0: 6528 7333 5f70 6174 686e 616d 6529 0a20  e(s3_pathname). 
+000023f0: 2020 2069 6620 6e6f 7420 6275 636b 6574     if not bucket
+00002400: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+00002410: 206b 6579 3a0a 2020 2020 2020 2020 2020   key:.          
+00002420: 2020 7261 6973 6520 556e 7375 7070 6f72    raise Unsuppor
+00002430: 7465 6445 7272 6f72 2827 476c 6f62 2077  tedError('Glob w
+00002440: 686f 6c65 2073 3327 2c20 7333 5f70 6174  hole s3', s3_pat
+00002450: 686e 616d 6529 0a20 2020 2020 2020 2072  hname).        r
+00002460: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
+00002470: 466f 756e 6445 7272 6f72 2827 456d 7074  FoundError('Empt
+00002480: 7920 6275 636b 6574 206e 616d 653a 2025  y bucket name: %
+00002490: 7227 2025 2073 335f 7061 7468 6e61 6d65  r' % s3_pathname
+000024a0: 290a 0a20 2020 2067 726f 7570 6564 5f70  )..    grouped_p
+000024b0: 6174 6820 3d20 5b5d 0a0a 2020 2020 6465  ath = []..    de
+000024c0: 6620 6765 6e65 7261 7465 5f73 335f 7061  f generate_s3_pa
+000024d0: 7468 2862 7563 6b65 743a 2073 7472 2c20  th(bucket: str, 
+000024e0: 6b65 793a 2073 7472 2920 2d3e 2073 7472  key: str) -> str
+000024f0: 3a0a 2020 2020 2020 2020 6966 206b 6579  :.        if key
+00002500: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00002510: 7475 726e 2022 7333 3a2f 2f25 732f 2573  turn "s3://%s/%s
+00002520: 2220 2520 2862 7563 6b65 742c 206b 6579  " % (bucket, key
+00002530: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00002540: 2022 7333 3a2f 2f25 7325 7322 2025 2028   "s3://%s%s" % (
+00002550: 6275 636b 6574 2c20 222f 2220 6966 2073  bucket, "/" if s
+00002560: 335f 7061 7468 6e61 6d65 2e65 6e64 7377  3_pathname.endsw
+00002570: 6974 6828 222f 2229 2065 6c73 6520 2222  ith("/") else ""
+00002580: 290a 0a20 2020 2061 6c6c 5f62 7563 6b65  )..    all_bucke
+00002590: 7420 3d20 6c72 755f 6361 6368 6528 6d61  t = lru_cache(ma
+000025a0: 7873 697a 653d 3129 285f 6c69 7374 5f61  xsize=1)(_list_a
+000025b0: 6c6c 5f62 7563 6b65 7473 290a 2020 2020  ll_buckets).    
+000025c0: 666f 7220 6275 636b 6574 6e61 6d65 2069  for bucketname i
+000025d0: 6e20 756e 676c 6f62 6c69 7a65 2862 7563  n ungloblize(buc
+000025e0: 6b65 7429 3a0a 2020 2020 2020 2020 6966  ket):.        if
+000025f0: 2068 6173 5f6d 6167 6963 2862 7563 6b65   has_magic(bucke
+00002600: 746e 616d 6529 3a0a 2020 2020 2020 2020  tname):.        
+00002610: 2020 2020 7370 6c69 745f 6275 636b 6574      split_bucket
+00002620: 6e61 6d65 203d 2062 7563 6b65 746e 616d  name = bucketnam
+00002630: 652e 7370 6c69 7428 222f 222c 2031 290a  e.split("/", 1).
+00002640: 2020 2020 2020 2020 2020 2020 7061 7468              path
+00002650: 5f70 6172 7420 3d20 4e6f 6e65 0a20 2020  _part = None.   
+00002660: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+00002670: 7370 6c69 745f 6275 636b 6574 6e61 6d65  split_bucketname
+00002680: 2920 3d3d 2032 3a0a 2020 2020 2020 2020  ) == 2:.        
+00002690: 2020 2020 2020 2020 6275 636b 6574 6e61          bucketna
+000026a0: 6d65 2c20 7061 7468 5f70 6172 7420 3d20  me, path_part = 
+000026b0: 7370 6c69 745f 6275 636b 6574 6e61 6d65  split_bucketname
+000026c0: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
+000026d0: 7465 726e 203d 2072 652e 636f 6d70 696c  tern = re.compil
+000026e0: 6528 7472 616e 736c 6174 6528 7265 2e73  e(translate(re.s
+000026f0: 7562 2872 275c 2a7b 322c 7d27 2c20 272a  ub(r'\*{2,}', '*
+00002700: 272c 2062 7563 6b65 746e 616d 6529 2929  ', bucketname)))
+00002710: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00002720: 7220 6275 636b 6574 2069 6e20 616c 6c5f  r bucket in all_
+00002730: 6275 636b 6574 2870 726f 6669 6c65 5f6e  bucket(profile_n
+00002740: 616d 6529 3a0a 2020 2020 2020 2020 2020  ame):.          
+00002750: 2020 2020 2020 6966 2070 6174 7465 726e        if pattern
+00002760: 2e66 756c 6c6d 6174 6368 2862 7563 6b65  .fullmatch(bucke
+00002770: 7429 2069 7320 6e6f 7420 4e6f 6e65 3a0a  t) is not None:.
+00002780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002790: 2020 2020 6966 2070 6174 685f 7061 7274      if path_part
+000027a0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000027b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027c0: 2020 2020 2020 6275 636b 6574 203d 2022        bucket = "
+000027d0: 2573 2f25 7322 2025 2028 0a20 2020 2020  %s/%s" % (.     
+000027e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027f0: 2020 2020 2020 2062 7563 6b65 742c 2070         bucket, p
+00002800: 6174 685f 7061 7274 2920 2023 2070 7261  ath_part)  # pra
+00002810: 676d 613a 206e 6f20 636f 7665 720a 2020  gma: no cover.  
+00002820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002830: 2020 6772 6f75 7065 645f 7061 7468 2e61    grouped_path.a
+00002840: 7070 656e 6428 6765 6e65 7261 7465 5f73  ppend(generate_s
+00002850: 335f 7061 7468 2862 7563 6b65 742c 206b  3_path(bucket, k
+00002860: 6579 2929 0a20 2020 2020 2020 2065 6c73  ey)).        els
+00002870: 653a 0a20 2020 2020 2020 2020 2020 2067  e:.            g
+00002880: 726f 7570 6564 5f70 6174 682e 6170 7065  rouped_path.appe
+00002890: 6e64 2867 656e 6572 6174 655f 7333 5f70  nd(generate_s3_p
+000028a0: 6174 6828 6275 636b 6574 6e61 6d65 2c20  ath(bucketname, 
+000028b0: 6b65 7929 290a 0a20 2020 2072 6574 7572  key))..    retur
+000028c0: 6e20 6772 6f75 7065 645f 7061 7468 0a0a  n grouped_path..
+000028d0: 0a64 6566 205f 7333 5f73 706c 6974 5f6d  .def _s3_split_m
+000028e0: 6167 6963 5f69 676e 6f72 655f 6272 6163  agic_ignore_brac
+000028f0: 6528 7333 5f70 6174 686e 616d 653a 2073  e(s3_pathname: s
+00002900: 7472 2920 2d3e 2054 7570 6c65 5b73 7472  tr) -> Tuple[str
+00002910: 2c20 7374 725d 3a0a 2020 2020 6966 206e  , str]:.    if n
+00002920: 6f74 2073 335f 7061 7468 6e61 6d65 3a0a  ot s3_pathname:.
+00002930: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00002940: 6c75 6545 7272 6f72 2822 7333 5f70 6174  lueError("s3_pat
+00002950: 686e 616d 653a 2025 7322 2c20 7333 5f70  hname: %s", s3_p
+00002960: 6174 686e 616d 6529 0a0a 2020 2020 6861  athname)..    ha
+00002970: 735f 7072 6f74 6f63 6f6c 203d 2046 616c  s_protocol = Fal
+00002980: 7365 0a20 2020 2069 6620 7333 5f70 6174  se.    if s3_pat
+00002990: 686e 616d 652e 7374 6172 7473 7769 7468  hname.startswith
+000029a0: 2822 7333 3a2f 2f22 293a 0a20 2020 2020  ("s3://"):.     
+000029b0: 2020 2068 6173 5f70 726f 746f 636f 6c20     has_protocol 
+000029c0: 3d20 5472 7565 0a20 2020 2020 2020 2073  = True.        s
+000029d0: 335f 7061 7468 6e61 6d65 203d 2073 335f  3_pathname = s3_
+000029e0: 7061 7468 6e61 6d65 5b35 3a5d 0a0a 2020  pathname[5:]..  
+000029f0: 2020 6861 735f 6465 6c69 6d69 7465 7220    has_delimiter 
+00002a00: 3d20 4661 6c73 650a 2020 2020 6966 2073  = False.    if s
+00002a10: 335f 7061 7468 6e61 6d65 2e65 6e64 7377  3_pathname.endsw
+00002a20: 6974 6828 222f 2229 3a0a 2020 2020 2020  ith("/"):.      
+00002a30: 2020 6861 735f 6465 6c69 6d69 7465 7220    has_delimiter 
+00002a40: 3d20 5472 7565 0a20 2020 2020 2020 2073  = True.        s
+00002a50: 335f 7061 7468 6e61 6d65 203d 2073 335f  3_pathname = s3_
+00002a60: 7061 7468 6e61 6d65 5b3a 2d31 5d0a 0a20  pathname[:-1].. 
+00002a70: 2020 206e 6f72 6d61 6c5f 7061 7274 7320     normal_parts 
+00002a80: 3d20 5b5d 0a20 2020 206d 6167 6963 5f70  = [].    magic_p
+00002a90: 6172 7473 203d 205b 5d0a 2020 2020 6c65  arts = [].    le
+00002aa0: 6674 5f62 7261 6365 203d 2046 616c 7365  ft_brace = False
+00002ab0: 0a20 2020 206c 6566 745f 696e 6465 7820  .    left_index 
+00002ac0: 3d20 300a 2020 2020 666f 7220 6375 7272  = 0.    for curr
+00002ad0: 656e 745f 696e 6465 782c 2063 7572 7265  ent_index, curre
+00002ae0: 6e74 5f63 6861 7261 6374 6572 2069 6e20  nt_character in 
+00002af0: 656e 756d 6572 6174 6528 7333 5f70 6174  enumerate(s3_pat
+00002b00: 686e 616d 6529 3a0a 2020 2020 2020 2020  hname):.        
+00002b10: 6966 2063 7572 7265 6e74 5f63 6861 7261  if current_chara
+00002b20: 6374 6572 203d 3d20 222f 2220 616e 6420  cter == "/" and 
+00002b30: 6c65 6674 5f62 7261 6365 2069 7320 4661  left_brace is Fa
+00002b40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00002b50: 2069 6620 6861 735f 6d61 6769 635f 6967   if has_magic_ig
+00002b60: 6e6f 7265 5f62 7261 6365 2873 335f 7061  nore_brace(s3_pa
+00002b70: 7468 6e61 6d65 5b6c 6566 745f 696e 6465  thname[left_inde
+00002b80: 783a 6375 7272 656e 745f 696e 6465 785d  x:current_index]
+00002b90: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00002ba0: 2020 206d 6167 6963 5f70 6172 7473 2e61     magic_parts.a
+00002bb0: 7070 656e 6428 7333 5f70 6174 686e 616d  ppend(s3_pathnam
+00002bc0: 655b 6c65 6674 5f69 6e64 6578 3a63 7572  e[left_index:cur
+00002bd0: 7265 6e74 5f69 6e64 6578 5d29 0a20 2020  rent_index]).   
+00002be0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00002bf0: 7333 5f70 6174 686e 616d 655b 6375 7272  s3_pathname[curr
+00002c00: 656e 745f 696e 6465 7820 2b20 313a 5d3a  ent_index + 1:]:
+00002c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002c20: 2020 2020 206d 6167 6963 5f70 6172 7473       magic_parts
+00002c30: 2e61 7070 656e 6428 7333 5f70 6174 686e  .append(s3_pathn
+00002c40: 616d 655b 6375 7272 656e 745f 696e 6465  ame[current_inde
+00002c50: 7820 2b20 313a 5d29 0a20 2020 2020 2020  x + 1:]).       
+00002c60: 2020 2020 2020 2020 2020 2020 206c 6566               lef
+00002c70: 745f 696e 6465 7820 3d20 6c65 6e28 7333  t_index = len(s3
+00002c80: 5f70 6174 686e 616d 6529 0a20 2020 2020  _pathname).     
+00002c90: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00002ca0: 0a20 2020 2020 2020 2020 2020 206e 6f72  .            nor
+00002cb0: 6d61 6c5f 7061 7274 732e 6170 7065 6e64  mal_parts.append
+00002cc0: 2873 335f 7061 7468 6e61 6d65 5b6c 6566  (s3_pathname[lef
+00002cd0: 745f 696e 6465 783a 6375 7272 656e 745f  t_index:current_
+00002ce0: 696e 6465 785d 290a 2020 2020 2020 2020  index]).        
+00002cf0: 2020 2020 6c65 6674 5f69 6e64 6578 203d      left_index =
+00002d00: 2063 7572 7265 6e74 5f69 6e64 6578 202b   current_index +
+00002d10: 2031 0a20 2020 2020 2020 2065 6c69 6620   1.        elif 
+00002d20: 6375 7272 656e 745f 6368 6172 6163 7465  current_characte
+00002d30: 7220 3d3d 2022 7b22 3a0a 2020 2020 2020  r == "{":.      
+00002d40: 2020 2020 2020 6c65 6674 5f62 7261 6365        left_brace
+00002d50: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00002d60: 656c 6966 2063 7572 7265 6e74 5f63 6861  elif current_cha
+00002d70: 7261 6374 6572 203d 3d20 227d 223a 0a20  racter == "}":. 
+00002d80: 2020 2020 2020 2020 2020 206c 6566 745f             left_
+00002d90: 6272 6163 6520 3d20 4661 6c73 650a 2020  brace = False.  
+00002da0: 2020 6966 2073 335f 7061 7468 6e61 6d65    if s3_pathname
+00002db0: 5b6c 6566 745f 696e 6465 783a 5d3a 0a20  [left_index:]:. 
+00002dc0: 2020 2020 2020 2069 6620 6861 735f 6d61         if has_ma
+00002dd0: 6769 635f 6967 6e6f 7265 5f62 7261 6365  gic_ignore_brace
+00002de0: 2873 335f 7061 7468 6e61 6d65 5b6c 6566  (s3_pathname[lef
+00002df0: 745f 696e 6465 783a 5d29 3a0a 2020 2020  t_index:]):.    
+00002e00: 2020 2020 2020 2020 6d61 6769 635f 7061          magic_pa
+00002e10: 7274 732e 6170 7065 6e64 2873 335f 7061  rts.append(s3_pa
+00002e20: 7468 6e61 6d65 5b6c 6566 745f 696e 6465  thname[left_inde
+00002e30: 783a 5d29 0a20 2020 2020 2020 2065 6c73  x:]).        els
+00002e40: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+00002e50: 6f72 6d61 6c5f 7061 7274 732e 6170 7065  ormal_parts.appe
+00002e60: 6e64 2873 335f 7061 7468 6e61 6d65 5b6c  nd(s3_pathname[l
+00002e70: 6566 745f 696e 6465 783a 5d29 0a0a 2020  eft_index:])..  
+00002e80: 2020 6966 2068 6173 5f70 726f 746f 636f    if has_protoco
+00002e90: 6c20 616e 6420 6e6f 726d 616c 5f70 6172  l and normal_par
+00002ea0: 7473 3a0a 2020 2020 2020 2020 6e6f 726d  ts:.        norm
+00002eb0: 616c 5f70 6172 7473 2e69 6e73 6572 7428  al_parts.insert(
+00002ec0: 302c 2022 7333 3a2f 2229 0a20 2020 2065  0, "s3:/").    e
+00002ed0: 6c69 6620 6861 735f 7072 6f74 6f63 6f6c  lif has_protocol
+00002ee0: 3a0a 2020 2020 2020 2020 6d61 6769 635f  :.        magic_
+00002ef0: 7061 7274 732e 696e 7365 7274 2830 2c20  parts.insert(0, 
+00002f00: 2273 333a 2f22 290a 0a20 2020 2069 6620  "s3:/")..    if 
+00002f10: 6861 735f 6465 6c69 6d69 7465 7220 616e  has_delimiter an
+00002f20: 6420 6d61 6769 635f 7061 7274 733a 0a20  d magic_parts:. 
+00002f30: 2020 2020 2020 206d 6167 6963 5f70 6172         magic_par
+00002f40: 7473 2e61 7070 656e 6428 2222 290a 2020  ts.append("").  
+00002f50: 2020 656c 6966 2068 6173 5f64 656c 696d    elif has_delim
+00002f60: 6974 6572 3a0a 2020 2020 2020 2020 6e6f  iter:.        no
+00002f70: 726d 616c 5f70 6172 7473 2e61 7070 656e  rmal_parts.appen
+00002f80: 6428 2222 290a 0a20 2020 2072 6574 7572  d("")..    retur
+00002f90: 6e20 222f 222e 6a6f 696e 286e 6f72 6d61  n "/".join(norma
+00002fa0: 6c5f 7061 7274 7329 2c20 222f 222e 6a6f  l_parts), "/".jo
+00002fb0: 696e 286d 6167 6963 5f70 6172 7473 290a  in(magic_parts).
+00002fc0: 0a0a 6465 6620 5f67 726f 7570 5f73 3370  ..def _group_s3p
+00002fd0: 6174 685f 6279 5f70 7265 6669 7828 7333  ath_by_prefix(s3
+00002fe0: 5f70 6174 686e 616d 653a 2073 7472 2920  _pathname: str) 
+00002ff0: 2d3e 204c 6973 745b 7374 725d 3a0a 0a20  -> List[str]:.. 
+00003000: 2020 205f 2c20 6b65 7920 3d20 7061 7273     _, key = pars
+00003010: 655f 7333 5f75 726c 2873 335f 7061 7468  e_s3_url(s3_path
+00003020: 6e61 6d65 290a 2020 2020 6966 206e 6f74  name).    if not
+00003030: 206b 6579 3a0a 2020 2020 2020 2020 7265   key:.        re
+00003040: 7475 726e 2075 6e67 6c6f 626c 697a 6528  turn ungloblize(
+00003050: 7333 5f70 6174 686e 616d 6529 0a0a 2020  s3_pathname)..  
+00003060: 2020 746f 705f 6469 722c 206d 6167 6963    top_dir, magic
+00003070: 5f70 6172 7420 3d20 5f73 335f 7370 6c69  _part = _s3_spli
+00003080: 745f 6d61 6769 635f 6967 6e6f 7265 5f62  t_magic_ignore_b
+00003090: 7261 6365 2873 335f 7061 7468 6e61 6d65  race(s3_pathname
+000030a0: 290a 2020 2020 6966 206e 6f74 2074 6f70  ).    if not top
+000030b0: 5f64 6972 3a0a 2020 2020 2020 2020 7265  _dir:.        re
+000030c0: 7475 726e 205b 6d61 6769 635f 7061 7274  turn [magic_part
+000030d0: 5d0a 2020 2020 6772 6f75 7065 645f 7061  ].    grouped_pa
+000030e0: 7468 203d 205b 5d0a 2020 2020 666f 7220  th = [].    for 
+000030f0: 7061 7468 6e61 6d65 2069 6e20 756e 676c  pathname in ungl
+00003100: 6f62 6c69 7a65 2874 6f70 5f64 6972 293a  oblize(top_dir):
+00003110: 0a20 2020 2020 2020 2069 6620 6d61 6769  .        if magi
+00003120: 635f 7061 7274 3a0a 2020 2020 2020 2020  c_part:.        
+00003130: 2020 2020 7061 7468 6e61 6d65 203d 2022      pathname = "
+00003140: 2f22 2e6a 6f69 6e28 5b70 6174 686e 616d  /".join([pathnam
+00003150: 652c 206d 6167 6963 5f70 6172 745d 290a  e, magic_part]).
+00003160: 2020 2020 2020 2020 6772 6f75 7065 645f          grouped_
+00003170: 7061 7468 2e61 7070 656e 6428 7061 7468  path.append(path
+00003180: 6e61 6d65 290a 2020 2020 7265 7475 726e  name).    return
+00003190: 2067 726f 7570 6564 5f70 6174 680a 0a0a   grouped_path...
+000031a0: 6465 6620 5f62 6563 6f6d 655f 7072 6566  def _become_pref
+000031b0: 6978 2870 7265 6669 783a 2073 7472 2920  ix(prefix: str) 
+000031c0: 2d3e 2073 7472 3a0a 2020 2020 6966 2070  -> str:.    if p
+000031d0: 7265 6669 7820 213d 2027 2720 616e 6420  refix != '' and 
+000031e0: 6e6f 7420 7072 6566 6978 2e65 6e64 7377  not prefix.endsw
+000031f0: 6974 6828 272f 2729 3a0a 2020 2020 2020  ith('/'):.      
+00003200: 2020 7072 6566 6978 202b 3d20 272f 270a    prefix += '/'.
+00003210: 2020 2020 7265 7475 726e 2070 7265 6669      return prefi
+00003220: 780a 0a0a 6465 6620 5f73 335f 7370 6c69  x...def _s3_spli
+00003230: 745f 6d61 6769 6328 7333 5f70 6174 686e  t_magic(s3_pathn
+00003240: 616d 653a 2073 7472 2920 2d3e 2054 7570  ame: str) -> Tup
+00003250: 6c65 5b73 7472 2c20 7374 725d 3a0a 2020  le[str, str]:.  
+00003260: 2020 6966 206e 6f74 2068 6173 5f6d 6167    if not has_mag
+00003270: 6963 2873 335f 7061 7468 6e61 6d65 293a  ic(s3_pathname):
+00003280: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00003290: 7333 5f70 6174 686e 616d 652c 2027 270a  s3_pathname, ''.
+000032a0: 2020 2020 6465 6c69 6d69 7465 7220 3d20      delimiter = 
+000032b0: 272f 270a 2020 2020 6e6f 726d 616c 5f70  '/'.    normal_p
+000032c0: 6172 7473 203d 205b 5d0a 2020 2020 6d61  arts = [].    ma
+000032d0: 6769 635f 7061 7274 7320 3d20 5b5d 0a20  gic_parts = []. 
+000032e0: 2020 2061 6c6c 5f70 6172 7473 203d 2073     all_parts = s
+000032f0: 335f 7061 7468 6e61 6d65 2e73 706c 6974  3_pathname.split
+00003300: 2864 656c 696d 6974 6572 290a 2020 2020  (delimiter).    
+00003310: 666f 7220 692c 2070 6172 7420 696e 2065  for i, part in e
+00003320: 6e75 6d65 7261 7465 2861 6c6c 5f70 6172  numerate(all_par
+00003330: 7473 293a 0a20 2020 2020 2020 2069 6620  ts):.        if 
+00003340: 6e6f 7420 6861 735f 6d61 6769 6328 7061  not has_magic(pa
+00003350: 7274 293a 0a20 2020 2020 2020 2020 2020  rt):.           
+00003360: 206e 6f72 6d61 6c5f 7061 7274 732e 6170   normal_parts.ap
+00003370: 7065 6e64 2870 6172 7429 0a20 2020 2020  pend(part).     
+00003380: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00003390: 2020 2020 206d 6167 6963 5f70 6172 7473       magic_parts
+000033a0: 203d 2061 6c6c 5f70 6172 7473 5b69 3a5d   = all_parts[i:]
+000033b0: 0a20 2020 2020 2020 2020 2020 2062 7265  .            bre
+000033c0: 616b 0a20 2020 2072 6574 7572 6e20 6465  ak.    return de
+000033d0: 6c69 6d69 7465 722e 6a6f 696e 286e 6f72  limiter.join(nor
+000033e0: 6d61 6c5f 7061 7274 7329 2c20 6465 6c69  mal_parts), deli
+000033f0: 6d69 7465 722e 6a6f 696e 286d 6167 6963  miter.join(magic
+00003400: 5f70 6172 7473 290a 0a0a 6465 6620 5f6c  _parts)...def _l
+00003410: 6973 745f 6f62 6a65 6374 735f 7265 6375  ist_objects_recu
+00003420: 7273 6976 6528 0a20 2020 2020 2020 2073  rsive(.        s
+00003430: 335f 636c 6965 6e74 2c20 6275 636b 6574  3_client, bucket
+00003440: 3a20 7374 722c 2070 7265 6669 783a 2073  : str, prefix: s
+00003450: 7472 2c20 6465 6c69 6d69 7465 723a 2073  tr, delimiter: s
+00003460: 7472 203d 2027 2729 3a0a 0a20 2020 2072  tr = ''):..    r
+00003470: 6573 7020 3d20 7333 5f63 6c69 656e 742e  esp = s3_client.
+00003480: 6c69 7374 5f6f 626a 6563 7473 5f76 3228  list_objects_v2(
+00003490: 0a20 2020 2020 2020 2042 7563 6b65 743d  .        Bucket=
+000034a0: 6275 636b 6574 2c20 5072 6566 6978 3d70  bucket, Prefix=p
+000034b0: 7265 6669 782c 2044 656c 696d 6974 6572  refix, Delimiter
+000034c0: 3d64 656c 696d 6974 6572 2c20 4d61 784b  =delimiter, MaxK
+000034d0: 6579 733d 6d61 785f 6b65 7973 290a 0a20  eys=max_keys).. 
+000034e0: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
+000034f0: 2020 2020 2020 2079 6965 6c64 2072 6573         yield res
+00003500: 700a 0a20 2020 2020 2020 2069 6620 6e6f  p..        if no
+00003510: 7420 7265 7370 5b27 4973 5472 756e 6361  t resp['IsTrunca
+00003520: 7465 6427 5d3a 0a20 2020 2020 2020 2020  ted']:.         
+00003530: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
+00003540: 2020 7265 7370 203d 2073 335f 636c 6965    resp = s3_clie
+00003550: 6e74 2e6c 6973 745f 6f62 6a65 6374 735f  nt.list_objects_
+00003560: 7632 280a 2020 2020 2020 2020 2020 2020  v2(.            
+00003570: 4275 636b 6574 3d62 7563 6b65 742c 0a20  Bucket=bucket,. 
+00003580: 2020 2020 2020 2020 2020 2050 7265 6669             Prefi
+00003590: 783d 7072 6566 6978 2c0a 2020 2020 2020  x=prefix,.      
+000035a0: 2020 2020 2020 4465 6c69 6d69 7465 723d        Delimiter=
+000035b0: 6465 6c69 6d69 7465 722c 0a20 2020 2020  delimiter,.     
+000035c0: 2020 2020 2020 2043 6f6e 7469 6e75 6174         Continuat
+000035d0: 696f 6e54 6f6b 656e 3d72 6573 705b 274e  ionToken=resp['N
+000035e0: 6578 7443 6f6e 7469 6e75 6174 696f 6e54  extContinuationT
+000035f0: 6f6b 656e 275d 2c0a 2020 2020 2020 2020  oken'],.        
+00003600: 2020 2020 4d61 784b 6579 733d 6d61 785f      MaxKeys=max_
+00003610: 6b65 7973 290a 0a0a 6465 6620 5f6d 616b  keys)...def _mak
+00003620: 655f 7374 6174 2863 6f6e 7465 6e74 3a20  e_stat(content: 
+00003630: 4469 6374 5b73 7472 2c20 416e 795d 293a  Dict[str, Any]):
+00003640: 0a20 2020 2072 6574 7572 6e20 5374 6174  .    return Stat
+00003650: 5265 7375 6c74 280a 2020 2020 2020 2020  Result(.        
+00003660: 6973 6c6e 6b3d 636f 6e74 656e 742e 6765  islnk=content.ge
+00003670: 7428 2769 736c 6e6b 272c 2046 616c 7365  t('islnk', False
+00003680: 292c 0a20 2020 2020 2020 2073 697a 653d  ),.        size=
+00003690: 636f 6e74 656e 745b 2753 697a 6527 5d2c  content['Size'],
+000036a0: 0a20 2020 2020 2020 206d 7469 6d65 3d63  .        mtime=c
+000036b0: 6f6e 7465 6e74 5b27 4c61 7374 4d6f 6469  ontent['LastModi
+000036c0: 6669 6564 275d 2e74 696d 6573 7461 6d70  fied'].timestamp
+000036d0: 2829 2c0a 2020 2020 2020 2020 6578 7472  (),.        extr
+000036e0: 613d 636f 6e74 656e 742c 0a20 2020 2029  a=content,.    )
+000036f0: 0a0a 0a64 6566 205f 7333 5f67 6c6f 625f  ...def _s3_glob_
+00003700: 7374 6174 5f73 696e 676c 655f 7061 7468  stat_single_path
+00003710: 280a 2020 2020 2020 2020 7333 5f70 6174  (.        s3_pat
+00003720: 686e 616d 653a 2050 6174 684c 696b 652c  hname: PathLike,
+00003730: 0a20 2020 2020 2020 2072 6563 7572 7369  .        recursi
+00003740: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
+00003750: 0a20 2020 2020 2020 206d 6973 7369 6e67  .        missing
+00003760: 5f6f 6b3a 2062 6f6f 6c20 3d20 5472 7565  _ok: bool = True
+00003770: 2c0a 2020 2020 2020 2020 666f 6c6c 6f77  ,.        follow
+00003780: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
+00003790: 6c73 652c 0a20 2020 2020 2020 2070 726f  lse,.        pro
+000037a0: 6669 6c65 5f6e 616d 653a 204f 7074 696f  file_name: Optio
+000037b0: 6e61 6c5b 7374 725d 203d 204e 6f6e 6529  nal[str] = None)
+000037c0: 202d 3e20 4974 6572 6174 6f72 5b46 696c   -> Iterator[Fil
+000037d0: 6545 6e74 7279 5d3a 0a20 2020 2069 6620  eEntry]:.    if 
+000037e0: 6e6f 7420 7265 6375 7273 6976 653a 0a20  not recursive:. 
+000037f0: 2020 2020 2020 2023 2049 6620 6e6f 7420         # If not 
+00003800: 7265 6375 7273 6976 652c 2072 6570 6c61  recursive, repla
+00003810: 6365 202a 2a20 7769 7468 202a 0a20 2020  ce ** with *.   
+00003820: 2020 2020 2073 335f 7061 7468 6e61 6d65       s3_pathname
+00003830: 203d 2072 652e 7375 6228 7227 5c2a 7b32   = re.sub(r'\*{2
+00003840: 2c7d 272c 2027 2a27 2c20 7333 5f70 6174  ,}', '*', s3_pat
+00003850: 686e 616d 6529 0a20 2020 2074 6f70 5f64  hname).    top_d
+00003860: 6972 2c20 7769 6c64 6361 7264 5f70 6172  ir, wildcard_par
+00003870: 7420 3d20 5f73 335f 7370 6c69 745f 6d61  t = _s3_split_ma
+00003880: 6769 6328 7333 5f70 6174 686e 616d 6529  gic(s3_pathname)
+00003890: 0a20 2020 2073 6561 7263 685f 6469 7220  .    search_dir 
+000038a0: 3d20 7769 6c64 6361 7264 5f70 6172 742e  = wildcard_part.
+000038b0: 656e 6473 7769 7468 2827 2f27 290a 0a20  endswith('/').. 
+000038c0: 2020 2064 6566 2073 686f 756c 645f 7265     def should_re
+000038d0: 6375 7273 6976 6528 7769 6c64 6361 7264  cursive(wildcard
+000038e0: 5f70 6172 743a 2073 7472 2920 2d3e 2062  _part: str) -> b
+000038f0: 6f6f 6c3a 0a20 2020 2020 2020 2069 6620  ool:.        if 
+00003900: 272a 2a27 2069 6e20 7769 6c64 6361 7264  '**' in wildcard
+00003910: 5f70 6172 743a 0a20 2020 2020 2020 2020  _part:.         
+00003920: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
+00003930: 2020 2020 2020 2066 6f72 2065 7870 616e         for expan
+00003940: 6465 645f 7061 7468 2069 6e20 756e 676c  ded_path in ungl
+00003950: 6f62 6c69 7a65 2877 696c 6463 6172 645f  oblize(wildcard_
+00003960: 7061 7274 293a 0a20 2020 2020 2020 2020  part):.         
+00003970: 2020 2070 6172 7473 5f6c 656e 6774 6820     parts_length 
+00003980: 3d20 6c65 6e28 6578 7061 6e64 6564 5f70  = len(expanded_p
+00003990: 6174 682e 7370 6c69 7428 272f 2729 290a  ath.split('/')).
+000039a0: 2020 2020 2020 2020 2020 2020 6966 2070              if p
+000039b0: 6172 7473 5f6c 656e 6774 6820 2b20 7365  arts_length + se
+000039c0: 6172 6368 5f64 6972 203e 3d20 323a 0a20  arch_dir >= 2:. 
+000039d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000039e0: 6574 7572 6e20 5472 7565 0a20 2020 2020  eturn True.     
+000039f0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+00003a00: 0a20 2020 2064 6566 2063 7265 6174 655f  .    def create_
+00003a10: 6765 6e65 7261 746f 7228 5f73 335f 7061  generator(_s3_pa
+00003a20: 7468 6e61 6d65 2920 2d3e 2049 7465 7261  thname) -> Itera
+00003a30: 746f 725b 4669 6c65 456e 7472 795d 3a0a  tor[FileEntry]:.
+00003a40: 2020 2020 2020 2020 6966 206e 6f74 2053          if not S
+00003a50: 3350 6174 6828 746f 705f 6469 7229 2e65  3Path(top_dir).e
+00003a60: 7869 7374 7328 293a 0a20 2020 2020 2020  xists():.       
+00003a70: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00003a80: 2020 2020 6966 206e 6f74 2068 6173 5f6d      if not has_m
+00003a90: 6167 6963 285f 7333 5f70 6174 686e 616d  agic(_s3_pathnam
+00003aa0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00003ab0: 5f73 335f 7061 7468 6e61 6d65 5f6f 626a  _s3_pathname_obj
+00003ac0: 203d 2053 3350 6174 6828 5f73 335f 7061   = S3Path(_s3_pa
+00003ad0: 7468 6e61 6d65 290a 2020 2020 2020 2020  thname).        
+00003ae0: 2020 2020 6966 205f 7333 5f70 6174 686e      if _s3_pathn
+00003af0: 616d 655f 6f62 6a2e 6973 5f66 696c 6528  ame_obj.is_file(
+00003b00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00003b10: 2020 2073 7461 7420 3d20 5333 5061 7468     stat = S3Path
+00003b20: 285f 7333 5f70 6174 686e 616d 6529 2e73  (_s3_pathname).s
+00003b30: 7461 7428 666f 6c6c 6f77 5f73 796d 6c69  tat(follow_symli
+00003b40: 6e6b 733d 666f 6c6c 6f77 6c69 6e6b 7329  nks=followlinks)
+00003b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003b60: 2079 6965 6c64 2046 696c 6545 6e74 7279   yield FileEntry
+00003b70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00003b80: 2020 2020 2020 5f73 335f 7061 7468 6e61        _s3_pathna
+00003b90: 6d65 5f6f 626a 2e6e 616d 652c 205f 7333  me_obj.name, _s3
+00003ba0: 5f70 6174 686e 616d 655f 6f62 6a2e 7061  _pathname_obj.pa
+00003bb0: 7468 2c20 7374 6174 290a 2020 2020 2020  th, stat).      
+00003bc0: 2020 2020 2020 6966 205f 7333 5f70 6174        if _s3_pat
+00003bd0: 686e 616d 655f 6f62 6a2e 6973 5f64 6972  hname_obj.is_dir
+00003be0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00003bf0: 2020 2020 7969 656c 6420 4669 6c65 456e      yield FileEn
+00003c00: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
+00003c10: 2020 2020 2020 2020 205f 7333 5f70 6174           _s3_pat
+00003c20: 686e 616d 655f 6f62 6a2e 6e61 6d65 2c20  hname_obj.name, 
+00003c30: 5f73 335f 7061 7468 6e61 6d65 5f6f 626a  _s3_pathname_obj
+00003c40: 2e70 6174 682c 0a20 2020 2020 2020 2020  .path,.         
+00003c50: 2020 2020 2020 2020 2020 2053 7461 7452             StatR
+00003c60: 6573 756c 7428 6973 6469 723d 5472 7565  esult(isdir=True
+00003c70: 2929 0a20 2020 2020 2020 2020 2020 2072  )).            r
+00003c80: 6574 7572 6e0a 0a20 2020 2020 2020 2064  eturn..        d
+00003c90: 656c 696d 6974 6572 203d 2027 270a 2020  elimiter = ''.  
+00003ca0: 2020 2020 2020 6966 206e 6f74 2073 686f        if not sho
+00003cb0: 756c 645f 7265 6375 7273 6976 6528 7769  uld_recursive(wi
+00003cc0: 6c64 6361 7264 5f70 6172 7429 3a0a 2020  ldcard_part):.  
+00003cd0: 2020 2020 2020 2020 2020 6465 6c69 6d69            delimi
+00003ce0: 7465 7220 3d20 272f 270a 0a20 2020 2020  ter = '/'..     
+00003cf0: 2020 2064 6972 6e61 6d65 7320 3d20 7365     dirnames = se
+00003d00: 7428 290a 2020 2020 2020 2020 7061 7474  t().        patt
+00003d10: 6572 6e20 3d20 7265 2e63 6f6d 7069 6c65  ern = re.compile
+00003d20: 2874 7261 6e73 6c61 7465 285f 7333 5f70  (translate(_s3_p
+00003d30: 6174 686e 616d 6529 290a 2020 2020 2020  athname)).      
+00003d40: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
+00003d50: 7061 7273 655f 7333 5f75 726c 2874 6f70  parse_s3_url(top
+00003d60: 5f64 6972 290a 2020 2020 2020 2020 7072  _dir).        pr
+00003d70: 6566 6978 203d 205f 6265 636f 6d65 5f70  efix = _become_p
+00003d80: 7265 6669 7828 6b65 7929 0a20 2020 2020  refix(key).     
+00003d90: 2020 2063 6c69 656e 7420 3d20 6765 745f     client = get_
+00003da0: 7333 5f63 6c69 656e 7428 7072 6f66 696c  s3_client(profil
+00003db0: 655f 6e61 6d65 3d70 726f 6669 6c65 5f6e  e_name=profile_n
+00003dc0: 616d 6529 0a20 2020 2020 2020 2077 6974  ame).        wit
+00003dd0: 6820 7261 6973 655f 7333 5f65 7272 6f72  h raise_s3_error
+00003de0: 285f 7333 5f70 6174 686e 616d 6529 3a0a  (_s3_pathname):.
+00003df0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00003e00: 7265 7370 2069 6e20 5f6c 6973 745f 6f62  resp in _list_ob
+00003e10: 6a65 6374 735f 7265 6375 7273 6976 6528  jects_recursive(
+00003e20: 636c 6965 6e74 2c20 6275 636b 6574 2c20  client, bucket, 
+00003e30: 7072 6566 6978 2c0a 2020 2020 2020 2020  prefix,.        
 00003e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e50: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00003e60: 656c 696d 6974 6572 293a 0a20 2020 2020  elimiter):.     
-00003e70: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-00003e80: 6f6e 7465 6e74 2069 6e20 7265 7370 2e67  ontent in resp.g
-00003e90: 6574 2827 436f 6e74 656e 7473 272c 205b  et('Contents', [
-00003ea0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-00003eb0: 2020 2020 2020 2020 7061 7468 203d 2073          path = s
-00003ec0: 335f 7061 7468 5f6a 6f69 6e28 2773 333a  3_path_join('s3:
-00003ed0: 2f2f 272c 2062 7563 6b65 742c 2063 6f6e  //', bucket, con
-00003ee0: 7465 6e74 5b27 4b65 7927 5d29 0a20 2020  tent['Key']).   
-00003ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f00: 2069 6620 6e6f 7420 7365 6172 6368 5f64   if not search_d
-00003f10: 6972 2061 6e64 2070 6174 7465 726e 2e6d  ir and pattern.m
-00003f20: 6174 6368 2870 6174 6829 3a0a 2020 2020  atch(path):.    
-00003f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f40: 2020 2020 7969 656c 6420 4669 6c65 456e      yield FileEn
-00003f50: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
+00003e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003e60: 2020 2020 2020 2020 6465 6c69 6d69 7465          delimite
+00003e70: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00003e80: 2020 2020 666f 7220 636f 6e74 656e 7420      for content 
+00003e90: 696e 2072 6573 702e 6765 7428 2743 6f6e  in resp.get('Con
+00003ea0: 7465 6e74 7327 2c20 5b5d 293a 0a20 2020  tents', []):.   
+00003eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ec0: 2070 6174 6820 3d20 7333 5f70 6174 685f   path = s3_path_
+00003ed0: 6a6f 696e 2827 7333 3a2f 2f27 2c20 6275  join('s3://', bu
+00003ee0: 636b 6574 2c20 636f 6e74 656e 745b 274b  cket, content['K
+00003ef0: 6579 275d 290a 2020 2020 2020 2020 2020  ey']).          
+00003f00: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00003f10: 2073 6561 7263 685f 6469 7220 616e 6420   search_dir and 
+00003f20: 7061 7474 6572 6e2e 6d61 7463 6828 7061  pattern.match(pa
+00003f30: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
+00003f40: 2020 2020 2020 2020 2020 2020 2079 6965               yie
+00003f50: 6c64 2046 696c 6545 6e74 7279 280a 2020  ld FileEntry(.  
 00003f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f70: 2053 3350 6174 6828 7061 7468 292e 6e61   S3Path(path).na
-00003f80: 6d65 2c20 7061 7468 2c20 5f6d 616b 655f  me, path, _make_
-00003f90: 7374 6174 2863 6f6e 7465 6e74 2929 0a20  stat(content)). 
-00003fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003fb0: 2020 2064 6972 6e61 6d65 203d 206f 732e     dirname = os.
-00003fc0: 7061 7468 2e64 6972 6e61 6d65 2870 6174  path.dirname(pat
-00003fd0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-00003fe0: 2020 2020 2020 2077 6869 6c65 2064 6972         while dir
-00003ff0: 6e61 6d65 206e 6f74 2069 6e20 6469 726e  name not in dirn
-00004000: 616d 6573 2061 6e64 2064 6972 6e61 6d65  ames and dirname
-00004010: 2021 3d20 746f 705f 6469 723a 0a20 2020   != top_dir:.   
-00004020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004030: 2020 2020 2064 6972 6e61 6d65 732e 6164       dirnames.ad
-00004040: 6428 6469 726e 616d 6529 0a20 2020 2020  d(dirname).     
-00004050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004060: 2020 2070 6174 6820 3d20 6469 726e 616d     path = dirnam
-00004070: 6520 2b20 272f 2720 6966 2073 6561 7263  e + '/' if searc
-00004080: 685f 6469 7220 656c 7365 2064 6972 6e61  h_dir else dirna
-00004090: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
-000040a0: 2020 2020 2020 2020 2020 2069 6620 7061             if pa
-000040b0: 7474 6572 6e2e 6d61 7463 6828 7061 7468  ttern.match(path
-000040c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000040d0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-000040e0: 6965 6c64 2046 696c 6545 6e74 7279 280a  ield FileEntry(.
-000040f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003f70: 2020 2020 2020 2020 2020 5333 5061 7468            S3Path
+00003f80: 2870 6174 6829 2e6e 616d 652c 2070 6174  (path).name, pat
+00003f90: 682c 205f 6d61 6b65 5f73 7461 7428 636f  h, _make_stat(co
+00003fa0: 6e74 656e 7429 290a 2020 2020 2020 2020  ntent)).        
+00003fb0: 2020 2020 2020 2020 2020 2020 6469 726e              dirn
+00003fc0: 616d 6520 3d20 6f73 2e70 6174 682e 6469  ame = os.path.di
+00003fd0: 726e 616d 6528 7061 7468 290a 2020 2020  rname(path).    
+00003fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ff0: 7768 696c 6520 6469 726e 616d 6520 6e6f  while dirname no
+00004000: 7420 696e 2064 6972 6e61 6d65 7320 616e  t in dirnames an
+00004010: 6420 6469 726e 616d 6520 213d 2074 6f70  d dirname != top
+00004020: 5f64 6972 3a0a 2020 2020 2020 2020 2020  _dir:.          
+00004030: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00004040: 726e 616d 6573 2e61 6464 2864 6972 6e61  rnames.add(dirna
+00004050: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+00004060: 2020 2020 2020 2020 2020 2020 7061 7468              path
+00004070: 203d 2064 6972 6e61 6d65 202b 2027 2f27   = dirname + '/'
+00004080: 2069 6620 7365 6172 6368 5f64 6972 2065   if search_dir e
+00004090: 6c73 6520 6469 726e 616d 650a 2020 2020  lse dirname.    
+000040a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040b0: 2020 2020 6966 2070 6174 7465 726e 2e6d      if pattern.m
+000040c0: 6174 6368 2870 6174 6829 3a0a 2020 2020  atch(path):.    
+000040d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040e0: 2020 2020 2020 2020 7969 656c 6420 4669          yield Fi
+000040f0: 6c65 456e 7472 7928 0a20 2020 2020 2020  leEntry(.       
 00004100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004110: 5333 5061 7468 2870 6174 6829 2e6e 616d  S3Path(path).nam
-00004120: 652c 2070 6174 682c 2053 7461 7452 6573  e, path, StatRes
-00004130: 756c 7428 6973 6469 723d 5472 7565 2929  ult(isdir=True))
-00004140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004150: 2020 2020 2020 2020 2064 6972 6e61 6d65           dirname
-00004160: 203d 206f 732e 7061 7468 2e64 6972 6e61   = os.path.dirna
-00004170: 6d65 2864 6972 6e61 6d65 290a 2020 2020  me(dirname).    
-00004180: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00004190: 636f 6d6d 6f6e 5f70 7265 6669 7820 696e  common_prefix in
-000041a0: 2072 6573 702e 6765 7428 2743 6f6d 6d6f   resp.get('Commo
-000041b0: 6e50 7265 6669 7865 7327 2c20 5b5d 293a  nPrefixes', []):
-000041c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000041d0: 2020 2020 2070 6174 6820 3d20 7333 5f70       path = s3_p
-000041e0: 6174 685f 6a6f 696e 280a 2020 2020 2020  ath_join(.      
-000041f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004200: 2020 2773 333a 2f2f 272c 2062 7563 6b65    's3://', bucke
-00004210: 742c 2063 6f6d 6d6f 6e5f 7072 6566 6978  t, common_prefix
-00004220: 5b27 5072 6566 6978 275d 290a 2020 2020  ['Prefix']).    
-00004230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004240: 6469 726e 616d 6520 3d20 6f73 2e70 6174  dirname = os.pat
-00004250: 682e 6469 726e 616d 6528 7061 7468 290a  h.dirname(path).
-00004260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004270: 2020 2020 6966 2064 6972 6e61 6d65 206e      if dirname n
-00004280: 6f74 2069 6e20 6469 726e 616d 6573 2061  ot in dirnames a
-00004290: 6e64 2064 6972 6e61 6d65 2021 3d20 746f  nd dirname != to
-000042a0: 705f 6469 723a 0a20 2020 2020 2020 2020  p_dir:.         
-000042b0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000042c0: 6972 6e61 6d65 732e 6164 6428 6469 726e  irnames.add(dirn
-000042d0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-000042e0: 2020 2020 2020 2020 2020 2020 2070 6174               pat
-000042f0: 6820 3d20 6469 726e 616d 6520 2b20 272f  h = dirname + '/
-00004300: 2720 6966 2073 6561 7263 685f 6469 7220  ' if search_dir 
-00004310: 656c 7365 2064 6972 6e61 6d65 0a20 2020  else dirname.   
-00004320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004330: 2020 2020 2069 6620 7061 7474 6572 6e2e       if pattern.
-00004340: 6d61 7463 6828 7061 7468 293a 0a20 2020  match(path):.   
-00004350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004360: 2020 2020 2020 2020 2079 6965 6c64 2046           yield F
-00004370: 696c 6545 6e74 7279 280a 2020 2020 2020  ileEntry(.      
-00004380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004390: 2020 2020 2020 2020 2020 5333 5061 7468            S3Path
-000043a0: 2870 6174 6829 2e6e 616d 652c 2070 6174  (path).name, pat
-000043b0: 682c 2053 7461 7452 6573 756c 7428 6973  h, StatResult(is
-000043c0: 6469 723d 5472 7565 2929 0a0a 2020 2020  dir=True))..    
-000043d0: 7265 7475 726e 2063 7265 6174 655f 6765  return create_ge
-000043e0: 6e65 7261 746f 7228 7333 5f70 6174 686e  nerator(s3_pathn
-000043f0: 616d 6529 0a0a 0a64 6566 205f 7333 5f73  ame)...def _s3_s
-00004400: 6361 6e5f 7061 6972 7328 7372 635f 7572  can_pairs(src_ur
-00004410: 6c3a 2050 6174 684c 696b 652c 0a20 2020  l: PathLike,.   
-00004420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004430: 6473 745f 7572 6c3a 2050 6174 684c 696b  dst_url: PathLik
-00004440: 6529 202d 3e20 4974 6572 6174 6f72 5b54  e) -> Iterator[T
-00004450: 7570 6c65 5b50 6174 684c 696b 652c 2050  uple[PathLike, P
-00004460: 6174 684c 696b 655d 5d3a 0a20 2020 2066  athLike]]:.    f
-00004470: 6f72 2073 7263 5f66 696c 655f 7061 7468  or src_file_path
-00004480: 2069 6e20 5333 5061 7468 2873 7263 5f75   in S3Path(src_u
-00004490: 726c 292e 7363 616e 2829 3a0a 2020 2020  rl).scan():.    
-000044a0: 2020 2020 636f 6e74 656e 745f 7061 7468      content_path
-000044b0: 203d 2073 7263 5f66 696c 655f 7061 7468   = src_file_path
-000044c0: 5b6c 656e 2873 7263 5f75 726c 293a 5d0a  [len(src_url):].
-000044d0: 2020 2020 2020 2020 6966 206c 656e 2863          if len(c
-000044e0: 6f6e 7465 6e74 5f70 6174 6829 203e 2030  ontent_path) > 0
-000044f0: 3a0a 2020 2020 2020 2020 2020 2020 6473  :.            ds
-00004500: 745f 6669 6c65 5f70 6174 6820 3d20 7333  t_file_path = s3
-00004510: 5f70 6174 685f 6a6f 696e 2864 7374 5f75  _path_join(dst_u
-00004520: 726c 2c20 636f 6e74 656e 745f 7061 7468  rl, content_path
-00004530: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00004540: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-00004550: 6669 6c65 5f70 6174 6820 3d20 6473 745f  file_path = dst_
-00004560: 7572 6c0a 2020 2020 2020 2020 7969 656c  url.        yiel
-00004570: 6420 7372 635f 6669 6c65 5f70 6174 682c  d src_file_path,
-00004580: 2064 7374 5f66 696c 655f 7061 7468 0a0a   dst_file_path..
-00004590: 0a64 6566 2069 735f 7333 2870 6174 683a  .def is_s3(path:
-000045a0: 2050 6174 684c 696b 6529 202d 3e20 626f   PathLike) -> bo
-000045b0: 6f6c 3a0a 2020 2020 2727 270a 2020 2020  ol:.    '''.    
-000045c0: 312e 2041 6363 6f72 6469 6e67 2074 6f20  1. According to 
-000045d0: 6061 7773 2d63 6c69 203c 6874 7470 733a  `aws-cli <https:
-000045e0: 2f2f 646f 6373 2e61 7773 2e61 6d61 7a6f  //docs.aws.amazo
-000045f0: 6e2e 636f 6d2f 636c 692f 6c61 7465 7374  n.com/cli/latest
-00004600: 2f72 6566 6572 656e 6365 2f73 332f 696e  /reference/s3/in
-00004610: 6465 782e 6874 6d6c 3e60 5f20 2c20 7465  dex.html>`_ , te
-00004620: 7374 2069 6620 6120 7061 7468 2069 7320  st if a path is 
-00004630: 7333 2070 6174 682e 0a20 2020 2032 2e20  s3 path..    2. 
-00004640: 6d65 6766 696c 6520 616c 736f 2073 7570  megfile also sup
-00004650: 706f 7274 2074 6865 2070 6174 6820 6c69  port the path li
-00004660: 6b65 2060 7333 5b2b 7072 6f66 696c 655f  ke `s3[+profile_
-00004670: 6e61 6d65 5d3a 2f2f 6275 636b 6574 2f6b  name]://bucket/k
-00004680: 6579 600a 0a20 2020 203a 7061 7261 6d20  ey`..    :param 
-00004690: 7061 7468 3a20 5061 7468 2074 6f20 6265  path: Path to be
-000046a0: 2074 6573 7465 640a 2020 2020 3a72 6574   tested.    :ret
-000046b0: 7572 6e73 3a20 5472 7565 2069 6620 7061  urns: True if pa
-000046c0: 7468 2069 7320 7333 2070 6174 682c 2065  th is s3 path, e
-000046d0: 6c73 6520 4661 6c73 650a 2020 2020 2727  lse False.    ''
-000046e0: 270a 2020 2020 7061 7468 203d 2066 7370  '.    path = fsp
-000046f0: 6174 6828 7061 7468 290a 2020 2020 6966  ath(path).    if
-00004700: 2072 652e 6d61 7463 6828 7227 5e73 3328   re.match(r'^s3(
-00004710: 5c2b 5c77 2b29 3f3a 5c2f 5c2f 272c 2070  \+\w+)?:\/\/', p
-00004720: 6174 6829 3a0a 2020 2020 2020 2020 7265  ath):.        re
-00004730: 7475 726e 2054 7275 650a 2020 2020 7265  turn True.    re
-00004740: 7475 726e 2046 616c 7365 0a0a 0a64 6566  turn False...def
-00004750: 205f 7333 5f62 696e 6172 795f 6d6f 6465   _s3_binary_mode
-00004760: 2873 335f 6f70 656e 5f66 756e 6329 3a0a  (s3_open_func):.
-00004770: 0a20 2020 2040 7772 6170 7328 7333 5f6f  .    @wraps(s3_o
-00004780: 7065 6e5f 6675 6e63 290a 2020 2020 6465  pen_func).    de
-00004790: 6620 7772 6170 7065 7228 7333 5f75 726c  f wrapper(s3_url
-000047a0: 2c20 6d6f 6465 3a20 7374 7220 3d20 2772  , mode: str = 'r
-000047b0: 6227 2c20 2a2a 6b77 6172 6773 293a 0a20  b', **kwargs):. 
-000047c0: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
-000047d0: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
-000047e0: 6c28 7333 5f75 726c 290a 2020 2020 2020  l(s3_url).      
-000047f0: 2020 6966 206e 6f74 2062 7563 6b65 743a    if not bucket:
-00004800: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00004810: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-00004820: 756e 6445 7272 6f72 2827 456d 7074 7920  undError('Empty 
-00004830: 6275 636b 6574 206e 616d 653a 2025 7227  bucket name: %r'
-00004840: 2025 2073 335f 7572 6c29 0a0a 2020 2020   % s3_url)..    
-00004850: 2020 2020 6966 206e 6f74 206b 6579 206f      if not key o
-00004860: 7220 6b65 792e 656e 6473 7769 7468 2827  r key.endswith('
-00004870: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
-00004880: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
-00004890: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
-000048a0: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
-000048b0: 2520 7333 5f75 726c 290a 0a20 2020 2020  % s3_url)..     
-000048c0: 2020 2069 6620 2778 2720 696e 206d 6f64     if 'x' in mod
-000048d0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-000048e0: 6620 5333 5061 7468 2873 335f 7572 6c29  f S3Path(s3_url)
-000048f0: 2e69 735f 6669 6c65 2829 3a0a 2020 2020  .is_file():.    
-00004900: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00004910: 6520 5333 4669 6c65 4578 6973 7473 4572  e S3FileExistsEr
-00004920: 726f 7228 2746 696c 6520 6578 6973 7473  ror('File exists
-00004930: 3a20 2572 2720 2520 7333 5f75 726c 290a  : %r' % s3_url).
-00004940: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-00004950: 203d 206d 6f64 652e 7265 706c 6163 6528   = mode.replace(
-00004960: 2778 272c 2027 7727 290a 0a20 2020 2020  'x', 'w')..     
-00004970: 2020 2069 6620 2777 2720 696e 206d 6f64     if 'w' in mod
-00004980: 6520 6f72 2027 6127 2069 6e20 6d6f 6465  e or 'a' in mode
-00004990: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000049a0: 206e 6f74 2053 3350 6174 6828 7333 5f75   not S3Path(s3_u
-000049b0: 726c 292e 6861 7362 7563 6b65 7428 293a  rl).hasbucket():
-000049c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000049d0: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
-000049e0: 6f74 466f 756e 6445 7272 6f72 2827 4e6f  otFoundError('No
-000049f0: 2073 7563 6820 6275 636b 6574 3a20 2572   such bucket: %r
-00004a00: 2720 2520 7333 5f75 726c 290a 0a20 2020  ' % s3_url)..   
-00004a10: 2020 2020 2066 696c 656f 626a 203d 2073       fileobj = s
-00004a20: 335f 6f70 656e 5f66 756e 6328 7333 5f75  3_open_func(s3_u
-00004a30: 726c 2c20 6765 745f 6269 6e61 7279 5f6d  rl, get_binary_m
-00004a40: 6f64 6528 6d6f 6465 292c 202a 2a6b 7761  ode(mode), **kwa
-00004a50: 7267 7329 0a20 2020 2020 2020 2069 6620  rgs).        if 
-00004a60: 2762 2720 6e6f 7420 696e 206d 6f64 653a  'b' not in mode:
-00004a70: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-00004a80: 656f 626a 203d 2069 6f2e 5465 7874 494f  eobj = io.TextIO
-00004a90: 5772 6170 7065 7228 6669 6c65 6f62 6a29  Wrapper(fileobj)
-00004aa0: 2020 2320 7079 7479 7065 3a20 6469 7361    # pytype: disa
-00004ab0: 626c 653d 7772 6f6e 672d 6172 672d 7479  ble=wrong-arg-ty
-00004ac0: 7065 730a 2020 2020 2020 2020 2020 2020  pes.            
-00004ad0: 6669 6c65 6f62 6a2e 6d6f 6465 203d 206d  fileobj.mode = m
-00004ae0: 6f64 650a 2020 2020 2020 2020 7265 7475  ode.        retu
-00004af0: 726e 2066 696c 656f 626a 0a0a 2020 2020  rn fileobj..    
-00004b00: 7265 7475 726e 2077 7261 7070 6572 0a0a  return wrapper..
-00004b10: 0a40 5f73 335f 6269 6e61 7279 5f6d 6f64  .@_s3_binary_mod
-00004b20: 650a 6465 6620 7333 5f70 7265 6665 7463  e.def s3_prefetc
-00004b30: 685f 6f70 656e 280a 2020 2020 2020 2020  h_open(.        
-00004b40: 7333 5f75 726c 3a20 5061 7468 4c69 6b65  s3_url: PathLike
-00004b50: 2c0a 2020 2020 2020 2020 6d6f 6465 3a20  ,.        mode: 
-00004b60: 7374 7220 3d20 2772 6227 2c0a 2020 2020  str = 'rb',.    
-00004b70: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733a      followlinks:
-00004b80: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-00004b90: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-00004ba0: 2020 6d61 785f 636f 6e63 7572 7265 6e63    max_concurrenc
-00004bb0: 793a 204f 7074 696f 6e61 6c5b 696e 745d  y: Optional[int]
-00004bc0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00004bd0: 206d 6178 5f62 6c6f 636b 5f73 697a 653a   max_block_size:
-00004be0: 2069 6e74 203d 2044 4546 4155 4c54 5f42   int = DEFAULT_B
-00004bf0: 4c4f 434b 5f53 495a 4529 202d 3e20 5333  LOCK_SIZE) -> S3
-00004c00: 5072 6566 6574 6368 5265 6164 6572 3a0a  PrefetchReader:.
-00004c10: 2020 2020 2727 274f 7065 6e20 6120 6173      '''Open a as
-00004c20: 796e 6368 726f 6e6f 7573 2070 7265 6665  ynchronous prefe
-00004c30: 7463 6820 7265 6164 6572 2c20 746f 2073  tch reader, to s
-00004c40: 7570 706f 7274 2066 6173 7420 7365 7175  upport fast sequ
-00004c50: 656e 7469 616c 2072 6561 6420 616e 6420  ential read and 
-00004c60: 7261 6e64 6f6d 2072 6561 640a 0a20 2020  random read..   
-00004c70: 202e 2e20 6e6f 7465 203a 3a0a 0a20 2020   .. note ::..   
-00004c80: 2020 2020 2055 7365 7220 7368 6f75 6c64       User should
-00004c90: 206d 616b 6520 7375 7265 2074 6861 7420   make sure that 
-00004ca0: 7265 6164 6572 202f 2077 7269 7465 7220  reader / writer 
-00004cb0: 6172 6520 636c 6f73 6564 2063 6f72 7265  are closed corre
-00004cc0: 6374 6c79 0a0a 2020 2020 2020 2020 5375  ctly..        Su
-00004cd0: 7070 6f72 7473 2063 6f6e 7465 7874 206d  pports context m
-00004ce0: 616e 6167 6572 0a0a 2020 2020 2020 2020  anager..        
-00004cf0: 536f 6d65 2070 6172 616d 6574 6572 2073  Some parameter s
-00004d00: 6574 7469 6e67 206d 6179 2070 6572 666f  etting may perfo
-00004d10: 726d 2077 656c 6c3a 206d 6178 5f63 6f6e  rm well: max_con
-00004d20: 6375 7272 656e 6379 3d31 3020 6f72 2032  currency=10 or 2
-00004d30: 302c 206d 6178 5f62 6c6f 636b 5f73 697a  0, max_block_siz
-00004d40: 653d 3820 6f72 2031 3620 4d42 2c20 6465  e=8 or 16 MB, de
-00004d50: 6661 756c 7420 7661 6c75 6520 4e6f 6e65  fault value None
-00004d60: 206d 6561 6e73 2075 7369 6e67 2067 6c6f   means using glo
-00004d70: 6261 6c20 7468 7265 6164 2070 6f6f 6c0a  bal thread pool.
-00004d80: 0a20 2020 203a 7061 7261 6d20 6d61 785f  .    :param max_
-00004d90: 636f 6e63 7572 7265 6e63 793a 204d 6178  concurrency: Max
-00004da0: 2064 6f77 6e6c 6f61 6420 7468 7265 6164   download thread
-00004db0: 206e 756d 6265 722c 204e 6f6e 6520 6279   number, None by
-00004dc0: 2064 6566 6175 6c74 0a20 2020 203a 7061   default.    :pa
-00004dd0: 7261 6d20 6d61 785f 626c 6f63 6b5f 7369  ram max_block_si
-00004de0: 7a65 3a20 4d61 7820 6461 7461 2073 697a  ze: Max data siz
-00004df0: 6520 646f 776e 6c6f 6164 6564 2062 7920  e downloaded by 
-00004e00: 6561 6368 2074 6872 6561 642c 2069 6e20  each thread, in 
-00004e10: 6279 7465 732c 2038 4d42 2062 7920 6465  bytes, 8MB by de
-00004e20: 6661 756c 740a 2020 2020 3a72 6574 7572  fault.    :retur
-00004e30: 6e73 3a20 416e 206f 7065 6e65 6420 5333  ns: An opened S3
-00004e40: 5072 6566 6574 6368 5265 6164 6572 206f  PrefetchReader o
-00004e50: 626a 6563 740a 2020 2020 3a72 6169 7365  bject.    :raise
-00004e60: 733a 2053 3346 696c 654e 6f74 466f 756e  s: S3FileNotFoun
-00004e70: 6445 7272 6f72 0a20 2020 2027 2727 0a20  dError.    '''. 
-00004e80: 2020 2069 6620 6d6f 6465 2021 3d20 2772     if mode != 'r
-00004e90: 6227 3a0a 2020 2020 2020 2020 7261 6973  b':.        rais
-00004ea0: 6520 5661 6c75 6545 7272 6f72 2827 756e  e ValueError('un
-00004eb0: 6163 6365 7074 6162 6c65 206d 6f64 653a  acceptable mode:
-00004ec0: 2025 7227 2025 206d 6f64 6529 0a20 2020   %r' % mode).   
-00004ed0: 2073 335f 7572 6c20 3d20 5333 5061 7468   s3_url = S3Path
-00004ee0: 2873 335f 7572 6c29 0a20 2020 2069 6620  (s3_url).    if 
-00004ef0: 666f 6c6c 6f77 6c69 6e6b 733a 0a20 2020  followlinks:.   
-00004f00: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00004f10: 2020 2020 2020 7333 5f75 726c 203d 2073        s3_url = s
-00004f20: 335f 7572 6c2e 7265 6164 6c69 6e6b 2829  3_url.readlink()
-00004f30: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00004f40: 5333 4e6f 7441 4c69 6e6b 4572 726f 723a  S3NotALinkError:
-00004f50: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
-00004f60: 730a 0a20 2020 2062 7563 6b65 742c 206b  s..    bucket, k
-00004f70: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
-00004f80: 6c28 7333 5f75 726c 2e70 6174 685f 7769  l(s3_url.path_wi
-00004f90: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-00004fa0: 2063 6f6e 6669 6720 3d20 626f 746f 636f   config = botoco
-00004fb0: 7265 2e63 6f6e 6669 672e 436f 6e66 6967  re.config.Config
-00004fc0: 286d 6178 5f70 6f6f 6c5f 636f 6e6e 6563  (max_pool_connec
-00004fd0: 7469 6f6e 733d 6d61 785f 706f 6f6c 5f63  tions=max_pool_c
-00004fe0: 6f6e 6e65 6374 696f 6e73 290a 2020 2020  onnections).    
-00004ff0: 636c 6965 6e74 203d 2067 6574 5f73 335f  client = get_s3_
-00005000: 636c 6965 6e74 280a 2020 2020 2020 2020  client(.        
-00005010: 636f 6e66 6967 3d63 6f6e 6669 672c 0a20  config=config,. 
-00005020: 2020 2020 2020 2063 6163 6865 5f6b 6579         cache_key
-00005030: 3d27 7333 5f66 696c 656c 696b 655f 636c  ='s3_filelike_cl
-00005040: 6965 6e74 272c 0a20 2020 2020 2020 2070  ient',.        p
-00005050: 726f 6669 6c65 5f6e 616d 653d 7333 5f75  rofile_name=s3_u
-00005060: 726c 2e5f 7072 6f66 696c 655f 6e61 6d65  rl._profile_name
-00005070: 290a 2020 2020 7265 7475 726e 2053 3350  ).    return S3P
-00005080: 7265 6665 7463 6852 6561 6465 7228 0a20  refetchReader(. 
-00005090: 2020 2020 2020 2062 7563 6b65 742c 0a20         bucket,. 
-000050a0: 2020 2020 2020 206b 6579 2c0a 2020 2020         key,.    
-000050b0: 2020 2020 7333 5f63 6c69 656e 743d 636c      s3_client=cl
-000050c0: 6965 6e74 2c0a 2020 2020 2020 2020 6d61  ient,.        ma
-000050d0: 785f 7265 7472 6965 733d 6d61 785f 7265  x_retries=max_re
-000050e0: 7472 6965 732c 0a20 2020 2020 2020 206d  tries,.        m
-000050f0: 6178 5f77 6f72 6b65 7273 3d6d 6178 5f63  ax_workers=max_c
-00005100: 6f6e 6375 7272 656e 6379 2c0a 2020 2020  oncurrency,.    
-00005110: 2020 2020 626c 6f63 6b5f 7369 7a65 3d6d      block_size=m
-00005120: 6178 5f62 6c6f 636b 5f73 697a 6529 0a0a  ax_block_size)..
-00005130: 0a40 5f73 335f 6269 6e61 7279 5f6d 6f64  .@_s3_binary_mod
-00005140: 650a 6465 6620 7333 5f73 6861 7265 5f63  e.def s3_share_c
-00005150: 6163 6865 5f6f 7065 6e28 0a20 2020 2020  ache_open(.     
-00005160: 2020 2073 335f 7572 6c3a 2050 6174 684c     s3_url: PathL
-00005170: 696b 652c 0a20 2020 2020 2020 206d 6f64  ike,.        mod
-00005180: 653a 2073 7472 203d 2027 7262 272c 0a20  e: str = 'rb',. 
-00005190: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
-000051a0: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
-000051b0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-000051c0: 2020 2020 2063 6163 6865 5f6b 6579 3a20       cache_key: 
-000051d0: 7374 7220 3d20 276c 7275 272c 0a20 2020  str = 'lru',.   
-000051e0: 2020 2020 206d 6178 5f63 6f6e 6375 7272       max_concurr
-000051f0: 656e 6379 3a20 4f70 7469 6f6e 616c 5b69  ency: Optional[i
-00005200: 6e74 5d20 3d20 4e6f 6e65 2c0a 2020 2020  nt] = None,.    
-00005210: 2020 2020 6d61 785f 626c 6f63 6b5f 7369      max_block_si
-00005220: 7a65 3a20 696e 7420 3d20 4445 4641 554c  ze: int = DEFAUL
-00005230: 545f 424c 4f43 4b5f 5349 5a45 2920 2d3e  T_BLOCK_SIZE) ->
-00005240: 2053 3353 6861 7265 4361 6368 6552 6561   S3ShareCacheRea
-00005250: 6465 723a 0a20 2020 2027 2727 4f70 656e  der:.    '''Open
-00005260: 2061 2061 7379 6e63 6872 6f6e 6f75 7320   a asynchronous 
-00005270: 7072 6566 6574 6368 2072 6561 6465 722c  prefetch reader,
-00005280: 2074 6f20 7375 7070 6f72 7420 6661 7374   to support fast
-00005290: 2073 6571 7565 6e74 6961 6c20 7265 6164   sequential read
-000052a0: 2061 6e64 2072 616e 646f 6d20 7265 6164   and random read
-000052b0: 0a0a 2020 2020 2e2e 206e 6f74 6520 3a3a  ..    .. note ::
-000052c0: 0a0a 2020 2020 2020 2020 5573 6572 2073  ..        User s
-000052d0: 686f 756c 6420 6d61 6b65 2073 7572 6520  hould make sure 
-000052e0: 7468 6174 2072 6561 6465 7220 2f20 7772  that reader / wr
-000052f0: 6974 6572 2061 7265 2063 6c6f 7365 6420  iter are closed 
-00005300: 636f 7272 6563 746c 790a 0a20 2020 2020  correctly..     
-00005310: 2020 2053 7570 706f 7274 7320 636f 6e74     Supports cont
-00005320: 6578 7420 6d61 6e61 6765 720a 0a20 2020  ext manager..   
-00005330: 2020 2020 2053 6f6d 6520 7061 7261 6d65       Some parame
-00005340: 7465 7220 7365 7474 696e 6720 6d61 7920  ter setting may 
-00005350: 7065 7266 6f72 6d20 7765 6c6c 3a20 6d61  perform well: ma
-00005360: 785f 636f 6e63 7572 7265 6e63 793d 3130  x_concurrency=10
-00005370: 206f 7220 3230 2c20 6d61 785f 626c 6f63   or 20, max_bloc
-00005380: 6b5f 7369 7a65 3d38 206f 7220 3136 204d  k_size=8 or 16 M
-00005390: 422c 2064 6566 6175 6c74 2076 616c 7565  B, default value
-000053a0: 204e 6f6e 6520 6d65 616e 7320 7573 696e   None means usin
-000053b0: 6720 676c 6f62 616c 2074 6872 6561 6420  g global thread 
-000053c0: 706f 6f6c 0a0a 2020 2020 3a70 6172 616d  pool..    :param
-000053d0: 206d 6178 5f63 6f6e 6375 7272 656e 6379   max_concurrency
-000053e0: 3a20 4d61 7820 646f 776e 6c6f 6164 2074  : Max download t
-000053f0: 6872 6561 6420 6e75 6d62 6572 2c20 4e6f  hread number, No
-00005400: 6e65 2062 7920 6465 6661 756c 740a 2020  ne by default.  
-00005410: 2020 3a70 6172 616d 206d 6178 5f62 6c6f    :param max_blo
-00005420: 636b 5f73 697a 653a 204d 6178 2064 6174  ck_size: Max dat
-00005430: 6120 7369 7a65 2064 6f77 6e6c 6f61 6465  a size downloade
-00005440: 6420 6279 2065 6163 6820 7468 7265 6164  d by each thread
-00005450: 2c20 696e 2062 7974 6573 2c20 384d 4220  , in bytes, 8MB 
-00005460: 6279 2064 6566 6175 6c74 0a20 2020 203a  by default.    :
-00005470: 7265 7475 726e 733a 2041 6e20 6f70 656e  returns: An open
-00005480: 6564 2053 3353 6861 7265 4361 6368 6552  ed S3ShareCacheR
-00005490: 6561 6465 7220 6f62 6a65 6374 0a20 2020  eader object.   
-000054a0: 203a 7261 6973 6573 3a20 5333 4669 6c65   :raises: S3File
-000054b0: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
-000054c0: 2020 2727 270a 2020 2020 6966 206d 6f64    '''.    if mod
-000054d0: 6520 213d 2027 7262 273a 0a20 2020 2020  e != 'rb':.     
-000054e0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000054f0: 726f 7228 2775 6e61 6363 6570 7461 626c  ror('unacceptabl
-00005500: 6520 6d6f 6465 3a20 2572 2720 2520 6d6f  e mode: %r' % mo
-00005510: 6465 290a 0a20 2020 2073 335f 7572 6c20  de)..    s3_url 
-00005520: 3d20 5333 5061 7468 2873 335f 7572 6c29  = S3Path(s3_url)
-00005530: 0a20 2020 2069 6620 666f 6c6c 6f77 6c69  .    if followli
-00005540: 6e6b 733a 0a20 2020 2020 2020 2074 7279  nks:.        try
-00005550: 3a0a 2020 2020 2020 2020 2020 2020 7333  :.            s3
-00005560: 5f75 726c 203d 2073 335f 7572 6c2e 7265  _url = s3_url.re
-00005570: 6164 6c69 6e6b 2829 0a20 2020 2020 2020  adlink().       
-00005580: 2065 7863 6570 7420 5333 4e6f 7441 4c69   except S3NotALi
-00005590: 6e6b 4572 726f 723a 0a20 2020 2020 2020  nkError:.       
-000055a0: 2020 2020 2070 6173 730a 0a20 2020 2062       pass..    b
-000055b0: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
-000055c0: 7365 5f73 335f 7572 6c28 7333 5f75 726c  se_s3_url(s3_url
-000055d0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-000055e0: 636f 6c29 0a20 2020 2063 6f6e 6669 6720  col).    config 
-000055f0: 3d20 626f 746f 636f 7265 2e63 6f6e 6669  = botocore.confi
-00005600: 672e 436f 6e66 6967 286d 6178 5f70 6f6f  g.Config(max_poo
-00005610: 6c5f 636f 6e6e 6563 7469 6f6e 733d 6d61  l_connections=ma
-00005620: 785f 706f 6f6c 5f63 6f6e 6e65 6374 696f  x_pool_connectio
-00005630: 6e73 290a 2020 2020 636c 6965 6e74 203d  ns).    client =
-00005640: 2067 6574 5f73 335f 636c 6965 6e74 280a   get_s3_client(.
-00005650: 2020 2020 2020 2020 636f 6e66 6967 3d63          config=c
-00005660: 6f6e 6669 672c 0a20 2020 2020 2020 2063  onfig,.        c
-00005670: 6163 6865 5f6b 6579 3d27 7333 5f66 696c  ache_key='s3_fil
-00005680: 656c 696b 655f 636c 6965 6e74 272c 0a20  elike_client',. 
-00005690: 2020 2020 2020 2070 726f 6669 6c65 5f6e         profile_n
-000056a0: 616d 653d 7333 5f75 726c 2e5f 7072 6f66  ame=s3_url._prof
-000056b0: 696c 655f 6e61 6d65 290a 2020 2020 7265  ile_name).    re
-000056c0: 7475 726e 2053 3353 6861 7265 4361 6368  turn S3ShareCach
-000056d0: 6552 6561 6465 7228 0a20 2020 2020 2020  eReader(.       
-000056e0: 2062 7563 6b65 742c 0a20 2020 2020 2020   bucket,.       
-000056f0: 206b 6579 2c0a 2020 2020 2020 2020 6361   key,.        ca
-00005700: 6368 655f 6b65 793d 6361 6368 655f 6b65  che_key=cache_ke
-00005710: 792c 0a20 2020 2020 2020 2073 335f 636c  y,.        s3_cl
-00005720: 6965 6e74 3d63 6c69 656e 742c 0a20 2020  ient=client,.   
-00005730: 2020 2020 206d 6178 5f72 6574 7269 6573       max_retries
-00005740: 3d6d 6178 5f72 6574 7269 6573 2c0a 2020  =max_retries,.  
-00005750: 2020 2020 2020 6d61 785f 776f 726b 6572        max_worker
-00005760: 733d 6d61 785f 636f 6e63 7572 7265 6e63  s=max_concurrenc
-00005770: 792c 0a20 2020 2020 2020 2062 6c6f 636b  y,.        block
-00005780: 5f73 697a 653d 6d61 785f 626c 6f63 6b5f  _size=max_block_
-00005790: 7369 7a65 290a 0a0a 405f 7333 5f62 696e  size)...@_s3_bin
-000057a0: 6172 795f 6d6f 6465 0a64 6566 2073 335f  ary_mode.def s3_
-000057b0: 7069 7065 5f6f 7065 6e28 0a20 2020 2020  pipe_open(.     
-000057c0: 2020 2073 335f 7572 6c3a 2050 6174 684c     s3_url: PathL
-000057d0: 696b 652c 0a20 2020 2020 2020 206d 6f64  ike,.        mod
-000057e0: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
-000057f0: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-00005800: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-00005810: 2020 202a 2c0a 2020 2020 2020 2020 6a6f     *,.        jo
-00005820: 696e 5f74 6872 6561 643a 2062 6f6f 6c20  in_thread: bool 
-00005830: 3d20 5472 7565 2920 2d3e 2053 3350 6970  = True) -> S3Pip
-00005840: 6548 616e 646c 6572 3a0a 2020 2020 2727  eHandler:.    ''
-00005850: 274f 7065 6e20 6120 6173 796e 6368 726f  'Open a asynchro
-00005860: 6e6f 7573 2072 6561 642d 7772 6974 6520  nous read-write 
-00005870: 7265 6164 6572 202f 2077 7269 7465 722c  reader / writer,
-00005880: 2074 6f20 7375 7070 6f72 7420 6661 7374   to support fast
-00005890: 2073 6571 7565 6e74 6961 6c20 7265 6164   sequential read
-000058a0: 202f 2077 7269 7465 0a0a 2020 2020 2e2e   / write..    ..
-000058b0: 206e 6f74 6520 3a3a 0a0a 2020 2020 2020   note ::..      
-000058c0: 2020 5573 6572 2073 686f 756c 6420 6d61    User should ma
-000058d0: 6b65 2073 7572 6520 7468 6174 2072 6561  ke sure that rea
-000058e0: 6465 7220 2f20 7772 6974 6572 2061 7265  der / writer are
-000058f0: 2063 6c6f 7365 6420 636f 7272 6563 746c   closed correctl
-00005900: 790a 0a20 2020 2020 2020 2053 7570 706f  y..        Suppo
-00005910: 7274 7320 636f 6e74 6578 7420 6d61 6e61  rts context mana
-00005920: 6765 720a 0a20 2020 2020 2020 2057 6865  ger..        Whe
-00005930: 6e20 6a6f 696e 5f74 6872 6561 6420 6973  n join_thread is
-00005940: 2046 616c 7365 2c20 7768 696c 6520 7468   False, while th
-00005950: 6520 6669 6c65 2068 616e 646c 6520 6172  e file handle ar
-00005960: 6520 636c 6f73 696e 672c 2074 6869 7320  e closing, this 
-00005970: 6675 6e63 7469 6f6e 2077 696c 6c20 6e6f  function will no
-00005980: 7420 7761 6974 2075 6e74 696c 2074 6865  t wait until the
-00005990: 2061 7379 6e63 6872 6f6e 6f75 7320 7772   asynchronous wr
-000059a0: 6974 696e 6720 6669 6e69 7368 6573 3b0a  iting finishes;.
-000059b0: 2020 2020 2020 2020 4661 6c73 6520 646f          False do
-000059c0: 6573 6e27 7420 6166 6665 6374 2072 6561  esn't affect rea
-000059d0: 642d 6861 6e64 6c65 2c20 6275 7420 7468  d-handle, but th
-000059e0: 6973 2063 616e 2073 7065 6564 2075 7020  is can speed up 
-000059f0: 7772 6974 652d 6861 6e64 6c65 2062 6563  write-handle bec
-00005a00: 6175 7365 2066 696c 6520 7769 6c6c 2062  ause file will b
-00005a10: 6520 7772 6974 7465 6e20 6173 796e 6368  e written asynch
-00005a20: 726f 6e6f 7573 6c79 2e0a 2020 2020 2020  ronously..      
-00005a30: 2020 4275 7420 6173 796e 6368 726f 6e6f    But asynchrono
-00005a40: 7573 2062 6568 6176 696f 7572 2063 616e  us behaviour can
-00005a50: 2067 7561 7261 6e74 6565 2074 6865 2066   guarantee the f
-00005a60: 696c 6520 6172 6520 7375 6363 6573 7366  ile are successf
-00005a70: 756c 6c79 2077 7269 7474 656e 2c20 616e  ully written, an
-00005a80: 6420 6672 6571 7565 6e74 2065 7865 6375  d frequent execu
-00005a90: 7469 6f6e 206d 6179 2063 6175 7365 2074  tion may cause t
-00005aa0: 6872 6561 6420 616e 6420 6669 6c65 2068  hread and file h
-00005ab0: 616e 646c 6520 6578 6861 7573 7469 6f6e  andle exhaustion
-00005ac0: 0a0a 2020 2020 3a70 6172 616d 206d 6f64  ..    :param mod
-00005ad0: 653a 204d 6f64 6520 746f 206f 7065 6e20  e: Mode to open 
-00005ae0: 6669 6c65 2c20 6569 7468 6572 2022 7262  file, either "rb
-00005af0: 2220 6f72 2022 7762 220a 2020 2020 3a70  " or "wb".    :p
-00005b00: 6172 616d 206a 6f69 6e5f 7468 7265 6164  aram join_thread
-00005b10: 3a20 4966 2077 6169 7420 6166 7465 7220  : If wait after 
-00005b20: 6675 6e63 7469 6f6e 2065 7865 6375 7469  function executi
-00005b30: 6f6e 2075 6e74 696c 2073 3320 6669 6e69  on until s3 fini
-00005b40: 7368 6573 2077 7269 7469 6e67 0a20 2020  shes writing.   
-00005b50: 203a 7265 7475 726e 733a 2041 6e20 6f70   :returns: An op
-00005b60: 656e 6564 2042 7566 6665 7265 6452 6561  ened BufferedRea
-00005b70: 6465 7220 2f20 4275 6666 6572 6564 5772  der / BufferedWr
-00005b80: 6974 6572 206f 626a 6563 740a 2020 2020  iter object.    
-00005b90: 2727 270a 2020 2020 6966 206d 6f64 6520  '''.    if mode 
-00005ba0: 6e6f 7420 696e 2028 2772 6227 2c20 2777  not in ('rb', 'w
-00005bb0: 6227 293a 0a20 2020 2020 2020 2072 6169  b'):.        rai
-00005bc0: 7365 2056 616c 7565 4572 726f 7228 2775  se ValueError('u
-00005bd0: 6e61 6363 6570 7461 626c 6520 6d6f 6465  nacceptable mode
-00005be0: 3a20 2572 2720 2520 6d6f 6465 290a 0a20  : %r' % mode).. 
-00005bf0: 2020 2069 6620 6d6f 6465 5b30 5d20 3d3d     if mode[0] ==
-00005c00: 2027 7227 2061 6e64 206e 6f74 2053 3350   'r' and not S3P
-00005c10: 6174 6828 7333 5f75 726c 292e 6973 5f66  ath(s3_url).is_f
-00005c20: 696c 6528 293a 0a20 2020 2020 2020 2072  ile():.        r
-00005c30: 6169 7365 2053 3346 696c 654e 6f74 466f  aise S3FileNotFo
-00005c40: 756e 6445 7272 6f72 2827 4e6f 2073 7563  undError('No suc
-00005c50: 6820 6669 6c65 3a20 2572 2720 2520 7333  h file: %r' % s3
-00005c60: 5f75 726c 290a 0a20 2020 2073 335f 7572  _url)..    s3_ur
-00005c70: 6c20 3d20 5333 5061 7468 2873 335f 7572  l = S3Path(s3_ur
-00005c80: 6c29 0a20 2020 2069 6620 666f 6c6c 6f77  l).    if follow
-00005c90: 6c69 6e6b 733a 0a20 2020 2020 2020 2074  links:.        t
-00005ca0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00005cb0: 7333 5f75 726c 203d 2073 335f 7572 6c2e  s3_url = s3_url.
-00005cc0: 7265 6164 6c69 6e6b 2829 0a20 2020 2020  readlink().     
-00005cd0: 2020 2065 7863 6570 7420 5333 4e6f 7441     except S3NotA
-00005ce0: 4c69 6e6b 4572 726f 723a 0a20 2020 2020  LinkError:.     
-00005cf0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
-00005d00: 2062 7563 6b65 742c 206b 6579 203d 2070   bucket, key = p
-00005d10: 6172 7365 5f73 335f 7572 6c28 7333 5f75  arse_s3_url(s3_u
-00005d20: 726c 2e70 6174 685f 7769 7468 5f70 726f  rl.path_with_pro
-00005d30: 746f 636f 6c29 0a20 2020 2063 6f6e 6669  tocol).    confi
-00005d40: 6720 3d20 626f 746f 636f 7265 2e63 6f6e  g = botocore.con
-00005d50: 6669 672e 436f 6e66 6967 286d 6178 5f70  fig.Config(max_p
-00005d60: 6f6f 6c5f 636f 6e6e 6563 7469 6f6e 733d  ool_connections=
-00005d70: 6d61 785f 706f 6f6c 5f63 6f6e 6e65 6374  max_pool_connect
-00005d80: 696f 6e73 290a 2020 2020 636c 6965 6e74  ions).    client
-00005d90: 203d 2067 6574 5f73 335f 636c 6965 6e74   = get_s3_client
-00005da0: 280a 2020 2020 2020 2020 636f 6e66 6967  (.        config
-00005db0: 3d63 6f6e 6669 672c 0a20 2020 2020 2020  =config,.       
-00005dc0: 2063 6163 6865 5f6b 6579 3d27 7333 5f66   cache_key='s3_f
-00005dd0: 696c 656c 696b 655f 636c 6965 6e74 272c  ilelike_client',
-00005de0: 0a20 2020 2020 2020 2070 726f 6669 6c65  .        profile
-00005df0: 5f6e 616d 653d 7333 5f75 726c 2e5f 7072  _name=s3_url._pr
-00005e00: 6f66 696c 655f 6e61 6d65 290a 2020 2020  ofile_name).    
-00005e10: 7265 7475 726e 2053 3350 6970 6548 616e  return S3PipeHan
-00005e20: 646c 6572 280a 2020 2020 2020 2020 6275  dler(.        bu
-00005e30: 636b 6574 2c20 6b65 792c 206d 6f64 652c  cket, key, mode,
-00005e40: 2073 335f 636c 6965 6e74 3d63 6c69 656e   s3_client=clien
-00005e50: 742c 206a 6f69 6e5f 7468 7265 6164 3d6a  t, join_thread=j
-00005e60: 6f69 6e5f 7468 7265 6164 290a 0a0a 405f  oin_thread)...@_
-00005e70: 7333 5f62 696e 6172 795f 6d6f 6465 0a64  s3_binary_mode.d
-00005e80: 6566 2073 335f 6361 6368 6564 5f6f 7065  ef s3_cached_ope
-00005e90: 6e28 0a20 2020 2020 2020 2073 335f 7572  n(.        s3_ur
-00005ea0: 6c3a 2050 6174 684c 696b 652c 0a20 2020  l: PathLike,.   
-00005eb0: 2020 2020 206d 6f64 653a 2073 7472 2c0a       mode: str,.
-00005ec0: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
-00005ed0: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
-00005ee0: 652c 0a20 2020 2020 2020 202a 2c0a 2020  e,.        *,.  
-00005ef0: 2020 2020 2020 6361 6368 655f 7061 7468        cache_path
-00005f00: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
-00005f10: 3d20 4e6f 6e65 2920 2d3e 2053 3343 6163  = None) -> S3Cac
-00005f20: 6865 6448 616e 646c 6572 3a0a 2020 2020  hedHandler:.    
-00005f30: 2727 274f 7065 6e20 6120 6c6f 6361 6c2d  '''Open a local-
-00005f40: 6361 6368 6520 6669 6c65 2072 6561 6465  cache file reade
-00005f50: 7220 2f20 7772 6974 6572 2c20 666f 7220  r / writer, for 
-00005f60: 6672 6571 7565 6e74 2072 616e 646f 6d20  frequent random 
-00005f70: 7265 6164 202f 2077 7269 7465 0a0a 2020  read / write..  
-00005f80: 2020 2e2e 206e 6f74 6520 3a3a 0a0a 2020    .. note ::..  
-00005f90: 2020 2020 2020 5573 6572 2073 686f 756c        User shoul
-00005fa0: 6420 6d61 6b65 2073 7572 6520 7468 6174  d make sure that
-00005fb0: 2072 6561 6465 7220 2f20 7772 6974 6572   reader / writer
-00005fc0: 2061 7265 2063 6c6f 7365 6420 636f 7272   are closed corr
-00005fd0: 6563 746c 790a 0a20 2020 2020 2020 2053  ectly..        S
-00005fe0: 7570 706f 7274 7320 636f 6e74 6578 7420  upports context 
-00005ff0: 6d61 6e61 6765 720a 0a20 2020 2020 2020  manager..       
-00006000: 2063 6163 6865 5f70 6174 6820 6361 6e20   cache_path can 
-00006010: 7370 6563 6966 7920 7468 6520 7061 7468  specify the path
-00006020: 206f 6620 6361 6368 6520 6669 6c65 2e20   of cache file. 
-00006030: 5065 7266 6f72 6d61 6e63 6520 636f 756c  Performance coul
-00006040: 6420 6265 2062 6574 7465 7220 6966 2063  d be better if c
-00006050: 6163 6865 2066 696c 6520 7061 7468 2069  ache file path i
-00006060: 7320 6f6e 2073 7364 206f 7220 746d 7066  s on ssd or tmpf
-00006070: 730a 0a20 2020 203a 7061 7261 6d20 6d6f  s..    :param mo
-00006080: 6465 3a20 4d6f 6465 2074 6f20 6f70 656e  de: Mode to open
-00006090: 2066 696c 652c 2063 6f75 6c64 2062 6520   file, could be 
-000060a0: 6f6e 6520 6f66 2022 7262 222c 2022 7762  one of "rb", "wb
-000060b0: 2220 6f72 2022 6162 220a 2020 2020 3a70  " or "ab".    :p
-000060c0: 6172 616d 2063 6163 6865 5f70 6174 683a  aram cache_path:
-000060d0: 2063 6163 6865 2066 696c 6520 7061 7468   cache file path
-000060e0: 0a20 2020 203a 7265 7475 726e 733a 2041  .    :returns: A
-000060f0: 6e20 6f70 656e 6564 2042 7566 6665 7265  n opened Buffere
-00006100: 6452 6561 6465 7220 2f20 4275 6666 6572  dReader / Buffer
-00006110: 6564 5772 6974 6572 206f 626a 6563 740a  edWriter object.
-00006120: 2020 2020 2727 270a 2020 2020 6966 206d      '''.    if m
-00006130: 6f64 6520 6e6f 7420 696e 2028 2772 6227  ode not in ('rb'
-00006140: 2c20 2777 6227 2c20 2761 6227 2c20 2772  , 'wb', 'ab', 'r
-00006150: 622b 272c 2027 7762 2b27 2c20 2761 622b  b+', 'wb+', 'ab+
-00006160: 2729 3a0a 2020 2020 2020 2020 7261 6973  '):.        rais
-00006170: 6520 5661 6c75 6545 7272 6f72 2827 756e  e ValueError('un
-00006180: 6163 6365 7074 6162 6c65 206d 6f64 653a  acceptable mode:
-00006190: 2025 7227 2025 206d 6f64 6529 0a20 2020   %r' % mode).   
-000061a0: 2073 335f 7572 6c20 3d20 5333 5061 7468   s3_url = S3Path
-000061b0: 2873 335f 7572 6c29 0a20 2020 2069 6620  (s3_url).    if 
-000061c0: 666f 6c6c 6f77 6c69 6e6b 733a 0a20 2020  followlinks:.   
-000061d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000061e0: 2020 2020 2020 7333 5f75 726c 203d 2073        s3_url = s
-000061f0: 335f 7572 6c2e 7265 6164 6c69 6e6b 2829  3_url.readlink()
-00006200: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00006210: 5333 4e6f 7441 4c69 6e6b 4572 726f 723a  S3NotALinkError:
-00006220: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
-00006230: 730a 0a20 2020 2062 7563 6b65 742c 206b  s..    bucket, k
-00006240: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
-00006250: 6c28 7333 5f75 726c 2e70 6174 685f 7769  l(s3_url.path_wi
-00006260: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-00006270: 2063 6f6e 6669 6720 3d20 626f 746f 636f   config = botoco
-00006280: 7265 2e63 6f6e 6669 672e 436f 6e66 6967  re.config.Config
-00006290: 286d 6178 5f70 6f6f 6c5f 636f 6e6e 6563  (max_pool_connec
-000062a0: 7469 6f6e 733d 6d61 785f 706f 6f6c 5f63  tions=max_pool_c
-000062b0: 6f6e 6e65 6374 696f 6e73 290a 2020 2020  onnections).    
-000062c0: 636c 6965 6e74 203d 2067 6574 5f73 335f  client = get_s3_
-000062d0: 636c 6965 6e74 280a 2020 2020 2020 2020  client(.        
-000062e0: 636f 6e66 6967 3d63 6f6e 6669 672c 0a20  config=config,. 
-000062f0: 2020 2020 2020 2063 6163 6865 5f6b 6579         cache_key
-00006300: 3d27 7333 5f66 696c 656c 696b 655f 636c  ='s3_filelike_cl
-00006310: 6965 6e74 272c 0a20 2020 2020 2020 2070  ient',.        p
-00006320: 726f 6669 6c65 5f6e 616d 653d 7333 5f75  rofile_name=s3_u
-00006330: 726c 2e5f 7072 6f66 696c 655f 6e61 6d65  rl._profile_name
-00006340: 290a 2020 2020 7265 7475 726e 2053 3343  ).    return S3C
-00006350: 6163 6865 6448 616e 646c 6572 280a 2020  achedHandler(.  
-00006360: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
-00006370: 792c 206d 6f64 652c 2073 335f 636c 6965  y, mode, s3_clie
-00006380: 6e74 3d63 6c69 656e 742c 2063 6163 6865  nt=client, cache
-00006390: 5f70 6174 683d 6361 6368 655f 7061 7468  _path=cache_path
-000063a0: 290a 0a0a 405f 7333 5f62 696e 6172 795f  )...@_s3_binary_
-000063b0: 6d6f 6465 0a64 6566 2073 335f 6275 6666  mode.def s3_buff
-000063c0: 6572 6564 5f6f 7065 6e28 0a20 2020 2020  ered_open(.     
-000063d0: 2020 2073 335f 7572 6c3a 2050 6174 684c     s3_url: PathL
-000063e0: 696b 652c 0a20 2020 2020 2020 206d 6f64  ike,.        mod
-000063f0: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
-00006400: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-00006410: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
-00006420: 2020 202a 2c0a 2020 2020 2020 2020 6d61     *,.        ma
-00006430: 785f 636f 6e63 7572 7265 6e63 793a 204f  x_concurrency: O
-00006440: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
-00006450: 6f6e 652c 0a20 2020 2020 2020 206d 6178  one,.        max
-00006460: 5f62 7566 6665 725f 7369 7a65 3a20 696e  _buffer_size: in
-00006470: 7420 3d20 4445 4641 554c 545f 4d41 585f  t = DEFAULT_MAX_
-00006480: 4255 4646 4552 5f53 495a 452c 0a20 2020  BUFFER_SIZE,.   
-00006490: 2020 2020 2066 6f72 7761 7264 5f72 6174       forward_rat
-000064a0: 696f 3a20 4f70 7469 6f6e 616c 5b66 6c6f  io: Optional[flo
-000064b0: 6174 5d20 3d20 4e6f 6e65 2c0a 2020 2020  at] = None,.    
-000064c0: 2020 2020 626c 6f63 6b5f 7369 7a65 3a20      block_size: 
-000064d0: 696e 7420 3d20 4445 4641 554c 545f 424c  int = DEFAULT_BL
-000064e0: 4f43 4b5f 5349 5a45 2c0a 2020 2020 2020  OCK_SIZE,.      
-000064f0: 2020 6c69 6d69 7465 645f 7365 656b 6162    limited_seekab
-00006500: 6c65 3a20 626f 6f6c 203d 2046 616c 7365  le: bool = False
-00006510: 2c0a 2020 2020 2020 2020 6275 6666 6572  ,.        buffer
-00006520: 6564 3a20 626f 6f6c 203d 2054 7275 652c  ed: bool = True,
-00006530: 0a20 2020 2020 2020 2073 6861 7265 5f63  .        share_c
-00006540: 6163 6865 5f6b 6579 3a20 4f70 7469 6f6e  ache_key: Option
-00006550: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
-00006560: 2020 2020 2020 2020 6361 6368 655f 7061          cache_pa
-00006570: 7468 3a20 4f70 7469 6f6e 616c 5b73 7472  th: Optional[str
-00006580: 5d20 3d20 4e6f 6e65 0a29 202d 3e20 556e  ] = None.) -> Un
-00006590: 696f 6e5b 5333 5072 6566 6574 6368 5265  ion[S3PrefetchRe
-000065a0: 6164 6572 2c20 5333 4275 6666 6572 6564  ader, S3Buffered
-000065b0: 5772 6974 6572 2c20 696f 2e42 7566 6665  Writer, io.Buffe
-000065c0: 7265 6452 6561 6465 722c 2069 6f2e 0a20  redReader, io.. 
-000065d0: 2020 2020 2020 2020 2020 4275 6666 6572            Buffer
-000065e0: 6564 5772 6974 6572 2c20 5333 4d65 6d6f  edWriter, S3Memo
-000065f0: 7279 4861 6e64 6c65 725d 3a0a 2020 2020  ryHandler]:.    
-00006600: 2727 274f 7065 6e20 616e 2061 7379 6e63  '''Open an async
-00006610: 6872 6f6e 6f75 7320 7072 6566 6574 6368  hronous prefetch
-00006620: 2072 6561 6465 722c 2074 6f20 7375 7070   reader, to supp
-00006630: 6f72 7420 6661 7374 2073 6571 7565 6e74  ort fast sequent
-00006640: 6961 6c20 7265 6164 0a0a 2020 2020 2e2e  ial read..    ..
-00006650: 206e 6f74 6520 3a3a 0a0a 2020 2020 2020   note ::..      
-00006660: 2020 5573 6572 2073 686f 756c 6420 6d61    User should ma
-00006670: 6b65 2073 7572 6520 7468 6174 2072 6561  ke sure that rea
-00006680: 6465 7220 2f20 7772 6974 6572 2061 7265  der / writer are
-00006690: 2063 6c6f 7365 6420 636f 7272 6563 746c   closed correctl
-000066a0: 790a 0a20 2020 2020 2020 2053 7570 706f  y..        Suppo
-000066b0: 7274 7320 636f 6e74 6578 7420 6d61 6e61  rts context mana
-000066c0: 6765 720a 0a20 2020 2020 2020 2053 6f6d  ger..        Som
-000066d0: 6520 7061 7261 6d65 7465 7220 7365 7474  e parameter sett
-000066e0: 696e 6720 6d61 7920 7065 7266 6f72 6d20  ing may perform 
-000066f0: 7765 6c6c 3a20 6d61 785f 636f 6e63 7572  well: max_concur
-00006700: 7265 6e63 793d 3130 206f 7220 3230 2c20  rency=10 or 20, 
-00006710: 6d61 785f 626c 6f63 6b5f 7369 7a65 3d38  max_block_size=8
-00006720: 206f 7220 3136 204d 422c 2064 6566 6175   or 16 MB, defau
-00006730: 6c74 2076 616c 7565 204e 6f6e 6520 6d65  lt value None me
-00006740: 616e 7320 7573 696e 6720 676c 6f62 616c  ans using global
-00006750: 2074 6872 6561 6420 706f 6f6c 0a0a 2020   thread pool..  
-00006760: 2020 3a70 6172 616d 206d 6178 5f63 6f6e    :param max_con
-00006770: 6375 7272 656e 6379 3a20 4d61 7820 646f  currency: Max do
-00006780: 776e 6c6f 6164 2074 6872 6561 6420 6e75  wnload thread nu
-00006790: 6d62 6572 2c20 4e6f 6e65 2062 7920 6465  mber, None by de
-000067a0: 6661 756c 740a 2020 2020 3a70 6172 616d  fault.    :param
-000067b0: 206d 6178 5f62 7566 6665 725f 7369 7a65   max_buffer_size
-000067c0: 3a20 4d61 7820 6361 6368 6564 2062 7566  : Max cached buf
-000067d0: 6665 7220 7369 7a65 2069 6e20 6d65 6d6f  fer size in memo
-000067e0: 7279 2c20 3132 384d 4220 6279 2064 6566  ry, 128MB by def
-000067f0: 6175 6c74 0a20 2020 203a 7061 7261 6d20  ault.    :param 
-00006800: 626c 6f63 6b5f 7369 7a65 3a20 5369 7a65  block_size: Size
-00006810: 206f 6620 7369 6e67 6c65 2062 6c6f 636b   of single block
-00006820: 2c20 384d 4220 6279 2064 6566 6175 6c74  , 8MB by default
-00006830: 2e20 4561 6368 2062 6c6f 636b 2077 696c  . Each block wil
-00006840: 6c20 6265 2075 706c 6f61 6465 6420 6f72  l be uploaded or
-00006850: 2064 6f77 6e6c 6f61 6465 6420 6279 2073   downloaded by s
-00006860: 696e 676c 6520 7468 7265 6164 2e0a 2020  ingle thread..  
-00006870: 2020 3a70 6172 616d 206c 696d 6974 6564    :param limited
-00006880: 5f73 6565 6b61 626c 653a 2049 6620 7772  _seekable: If wr
-00006890: 6974 652d 6861 6e64 6c65 2073 7570 706f  ite-handle suppo
-000068a0: 7274 7320 6c69 6d69 7465 6420 7365 656b  rts limited seek
-000068b0: 2028 626f 7468 2066 696c 6520 6865 6164   (both file head
-000068c0: 2070 6172 7420 616e 6420 7461 696c 2070   part and tail p
-000068d0: 6172 7420 6361 6e20 7365 656b 2062 6c6f  art can seek blo
-000068e0: 636b 5f73 697a 6529 2e20 4e6f 7465 733a  ck_size). Notes:
-000068f0: 2054 6869 7320 7061 7261 6d65 7465 7220   This parameter 
-00006900: 6172 6520 7661 6c69 6420 6f6e 6c79 2066  are valid only f
-00006910: 6f72 2077 7269 7465 2d68 616e 646c 652e  or write-handle.
-00006920: 2052 6561 642d 6861 6e64 6c65 2073 7570   Read-handle sup
-00006930: 706f 7274 2061 7262 6974 7261 7279 2073  port arbitrary s
-00006940: 6565 6b0a 2020 2020 3a72 6574 7572 6e73  eek.    :returns
-00006950: 3a20 416e 206f 7065 6e65 6420 5333 5072  : An opened S3Pr
-00006960: 6566 6574 6368 5265 6164 6572 206f 626a  efetchReader obj
-00006970: 6563 740a 2020 2020 3a72 6169 7365 733a  ect.    :raises:
-00006980: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
-00006990: 7272 6f72 0a20 2020 2027 2727 0a20 2020  rror.    '''.   
-000069a0: 2069 6620 6d6f 6465 206e 6f74 2069 6e20   if mode not in 
-000069b0: 2827 7262 272c 2027 7762 272c 2027 6162  ('rb', 'wb', 'ab
-000069c0: 272c 2027 7262 2b27 2c20 2777 622b 272c  ', 'rb+', 'wb+',
-000069d0: 2027 6162 2b27 293a 0a20 2020 2020 2020   'ab+'):.       
-000069e0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000069f0: 7228 2775 6e61 6363 6570 7461 626c 6520  r('unacceptable 
-00006a00: 6d6f 6465 3a20 2572 2720 2520 6d6f 6465  mode: %r' % mode
-00006a10: 290a 2020 2020 7333 5f75 726c 203d 2053  ).    s3_url = S
-00006a20: 3350 6174 6828 7333 5f75 726c 290a 2020  3Path(s3_url).  
-00006a30: 2020 6966 2066 6f6c 6c6f 776c 696e 6b73    if followlinks
-00006a40: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-00006a50: 2020 2020 2020 2020 2020 2073 335f 7572             s3_ur
-00006a60: 6c20 3d20 7333 5f75 726c 2e72 6561 646c  l = s3_url.readl
-00006a70: 696e 6b28 290a 2020 2020 2020 2020 6578  ink().        ex
-00006a80: 6365 7074 2053 334e 6f74 414c 696e 6b45  cept S3NotALinkE
-00006a90: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00006aa0: 2020 7061 7373 0a0a 2020 2020 6275 636b    pass..    buck
-00006ab0: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
-00006ac0: 7333 5f75 726c 2873 335f 7572 6c2e 7061  s3_url(s3_url.pa
-00006ad0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00006ae0: 290a 2020 2020 636f 6e66 6967 203d 2062  ).    config = b
-00006af0: 6f74 6f63 6f72 652e 636f 6e66 6967 2e43  otocore.config.C
-00006b00: 6f6e 6669 6728 6d61 785f 706f 6f6c 5f63  onfig(max_pool_c
-00006b10: 6f6e 6e65 6374 696f 6e73 3d6d 6178 5f70  onnections=max_p
-00006b20: 6f6f 6c5f 636f 6e6e 6563 7469 6f6e 7329  ool_connections)
-00006b30: 0a20 2020 2063 6c69 656e 7420 3d20 6765  .    client = ge
-00006b40: 745f 7333 5f63 6c69 656e 7428 0a20 2020  t_s3_client(.   
-00006b50: 2020 2020 2063 6f6e 6669 673d 636f 6e66       config=conf
-00006b60: 6967 2c0a 2020 2020 2020 2020 6361 6368  ig,.        cach
-00006b70: 655f 6b65 793d 2773 335f 6669 6c65 6c69  e_key='s3_fileli
-00006b80: 6b65 5f63 6c69 656e 7427 2c0a 2020 2020  ke_client',.    
-00006b90: 2020 2020 7072 6f66 696c 655f 6e61 6d65      profile_name
-00006ba0: 3d73 335f 7572 6c2e 5f70 726f 6669 6c65  =s3_url._profile
-00006bb0: 5f6e 616d 6529 0a0a 2020 2020 6966 2027  _name)..    if '
-00006bc0: 6127 2069 6e20 6d6f 6465 206f 7220 272b  a' in mode or '+
-00006bd0: 2720 696e 206d 6f64 653a 0a20 2020 2020  ' in mode:.     
-00006be0: 2020 2069 6620 6361 6368 655f 7061 7468     if cache_path
-00006bf0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00006c00: 2020 2020 2020 7265 7475 726e 2053 334d        return S3M
-00006c10: 656d 6f72 7948 616e 646c 6572 2862 7563  emoryHandler(buc
-00006c20: 6b65 742c 206b 6579 2c20 6d6f 6465 2c20  ket, key, mode, 
-00006c30: 7333 5f63 6c69 656e 743d 636c 6965 6e74  s3_client=client
-00006c40: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00006c50: 2053 3343 6163 6865 6448 616e 646c 6572   S3CachedHandler
-00006c60: 280a 2020 2020 2020 2020 2020 2020 6275  (.            bu
-00006c70: 636b 6574 2c20 6b65 792c 206d 6f64 652c  cket, key, mode,
-00006c80: 2073 335f 636c 6965 6e74 3d63 6c69 656e   s3_client=clien
-00006c90: 742c 2063 6163 6865 5f70 6174 683d 6361  t, cache_path=ca
-00006ca0: 6368 655f 7061 7468 290a 0a20 2020 2069  che_path)..    i
-00006cb0: 6620 6d6f 6465 203d 3d20 2772 6227 3a0a  f mode == 'rb':.
-00006cc0: 2020 2020 2020 2020 2320 4120 726f 7567          # A roug
-00006cd0: 6820 636f 6e76 6572 7369 6f6e 2061 6c67  h conversion alg
-00006ce0: 6f72 6974 686d 2074 6f20 616c 6967 6e20  orithm to align 
-00006cf0: 3220 7479 7065 7320 6f66 2052 6561 6465  2 types of Reade
-00006d00: 7220 2f20 5772 6974 6572 2070 6172 616d  r / Writer param
-00006d10: 6574 6572 730a 2020 2020 2020 2020 2320  eters.        # 
-00006d20: 544f 444f 3a20 4f70 7469 6d69 7a65 2074  TODO: Optimize t
-00006d30: 6865 2063 6f6e 7665 7273 696f 6e20 616c  he conversion al
-00006d40: 676f 7269 7468 6d0a 2020 2020 2020 2020  gorithm.        
-00006d50: 626c 6f63 6b5f 6361 7061 6369 7479 203d  block_capacity =
-00006d60: 206d 6178 5f62 7566 6665 725f 7369 7a65   max_buffer_size
-00006d70: 202f 2f20 626c 6f63 6b5f 7369 7a65 0a20   // block_size. 
-00006d80: 2020 2020 2020 2069 6620 666f 7277 6172         if forwar
-00006d90: 645f 7261 7469 6f20 6973 204e 6f6e 653a  d_ratio is None:
-00006da0: 0a20 2020 2020 2020 2020 2020 2062 6c6f  .            blo
-00006db0: 636b 5f66 6f72 7761 7264 203d 204e 6f6e  ck_forward = Non
-00006dc0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-00006dd0: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
-00006de0: 6b5f 666f 7277 6172 6420 3d20 6d61 7828  k_forward = max(
-00006df0: 696e 7428 626c 6f63 6b5f 6361 7061 6369  int(block_capaci
-00006e00: 7479 202a 2066 6f72 7761 7264 5f72 6174  ty * forward_rat
-00006e10: 696f 292c 2031 290a 2020 2020 2020 2020  io), 1).        
-00006e20: 6966 2073 6861 7265 5f63 6163 6865 5f6b  if share_cache_k
-00006e30: 6579 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ey is not None:.
-00006e40: 2020 2020 2020 2020 2020 2020 7265 6164              read
-00006e50: 6572 203d 2053 3353 6861 7265 4361 6368  er = S3ShareCach
-00006e60: 6552 6561 6465 7228 0a20 2020 2020 2020  eReader(.       
-00006e70: 2020 2020 2020 2020 2062 7563 6b65 742c           bucket,
-00006e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006e90: 206b 6579 2c0a 2020 2020 2020 2020 2020   key,.          
-00006ea0: 2020 2020 2020 6361 6368 655f 6b65 793d        cache_key=
-00006eb0: 7368 6172 655f 6361 6368 655f 6b65 792c  share_cache_key,
-00006ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006ed0: 2073 335f 636c 6965 6e74 3d63 6c69 656e   s3_client=clien
-00006ee0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00006ef0: 2020 206d 6178 5f72 6574 7269 6573 3d6d     max_retries=m
-00006f00: 6178 5f72 6574 7269 6573 2c0a 2020 2020  ax_retries,.    
-00006f10: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
-00006f20: 776f 726b 6572 733d 6d61 785f 636f 6e63  workers=max_conc
-00006f30: 7572 7265 6e63 792c 0a20 2020 2020 2020  urrency,.       
-00006f40: 2020 2020 2020 2020 2062 6c6f 636b 5f73           block_s
-00006f50: 697a 653d 626c 6f63 6b5f 7369 7a65 2c0a  ize=block_size,.
-00006f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f70: 626c 6f63 6b5f 666f 7277 6172 643d 626c  block_forward=bl
-00006f80: 6f63 6b5f 666f 7277 6172 6429 0a20 2020  ock_forward).   
-00006f90: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00006fa0: 2020 2020 2020 2072 6561 6465 7220 3d20         reader = 
-00006fb0: 5333 5072 6566 6574 6368 5265 6164 6572  S3PrefetchReader
-00006fc0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00006fd0: 2020 6275 636b 6574 2c0a 2020 2020 2020    bucket,.      
-00006fe0: 2020 2020 2020 2020 2020 6b65 792c 0a20            key,. 
-00006ff0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00007000: 335f 636c 6965 6e74 3d63 6c69 656e 742c  3_client=client,
-00007010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007020: 206d 6178 5f72 6574 7269 6573 3d6d 6178   max_retries=max
-00007030: 5f72 6574 7269 6573 2c0a 2020 2020 2020  _retries,.      
-00007040: 2020 2020 2020 2020 2020 6d61 785f 776f            max_wo
-00007050: 726b 6572 733d 6d61 785f 636f 6e63 7572  rkers=max_concur
-00007060: 7265 6e63 792c 0a20 2020 2020 2020 2020  rency,.         
-00007070: 2020 2020 2020 2062 6c6f 636b 5f63 6170         block_cap
-00007080: 6163 6974 793d 626c 6f63 6b5f 6361 7061  acity=block_capa
-00007090: 6369 7479 2c0a 2020 2020 2020 2020 2020  city,.          
-000070a0: 2020 2020 2020 626c 6f63 6b5f 666f 7277        block_forw
-000070b0: 6172 643d 626c 6f63 6b5f 666f 7277 6172  ard=block_forwar
-000070c0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-000070d0: 2020 2062 6c6f 636b 5f73 697a 653d 626c     block_size=bl
-000070e0: 6f63 6b5f 7369 7a65 290a 2020 2020 2020  ock_size).      
-000070f0: 2020 6966 2062 7566 6665 7265 643a 0a20    if buffered:. 
-00007100: 2020 2020 2020 2020 2020 2072 6561 6465             reade
-00007110: 7220 3d20 696f 2e42 7566 6665 7265 6452  r = io.BufferedR
-00007120: 6561 6465 7228 7265 6164 6572 2920 2023  eader(reader)  #
-00007130: 2070 7974 7970 653a 2064 6973 6162 6c65   pytype: disable
-00007140: 3d77 726f 6e67 2d61 7267 2d74 7970 6573  =wrong-arg-types
-00007150: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00007160: 7265 6164 6572 0a0a 2020 2020 6966 206c  reader..    if l
-00007170: 696d 6974 6564 5f73 6565 6b61 626c 653a  imited_seekable:
-00007180: 0a20 2020 2020 2020 2077 7269 7465 7220  .        writer 
-00007190: 3d20 5333 4c69 6d69 7465 6453 6565 6b61  = S3LimitedSeeka
-000071a0: 626c 6557 7269 7465 7228 0a20 2020 2020  bleWriter(.     
-000071b0: 2020 2020 2020 2062 7563 6b65 742c 0a20         bucket,. 
-000071c0: 2020 2020 2020 2020 2020 206b 6579 2c0a             key,.
-000071d0: 2020 2020 2020 2020 2020 2020 7333 5f63              s3_c
-000071e0: 6c69 656e 743d 636c 6965 6e74 2c0a 2020  lient=client,.  
-000071f0: 2020 2020 2020 2020 2020 6d61 785f 776f            max_wo
-00007200: 726b 6572 733d 6d61 785f 636f 6e63 7572  rkers=max_concur
-00007210: 7265 6e63 792c 0a20 2020 2020 2020 2020  rency,.         
-00007220: 2020 206d 6178 5f62 7566 6665 725f 7369     max_buffer_si
-00007230: 7a65 3d6d 6178 5f62 7566 6665 725f 7369  ze=max_buffer_si
-00007240: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
-00007250: 626c 6f63 6b5f 7369 7a65 3d62 6c6f 636b  block_size=block
-00007260: 5f73 697a 6529 0a20 2020 2065 6c73 653a  _size).    else:
-00007270: 0a20 2020 2020 2020 2077 7269 7465 7220  .        writer 
-00007280: 3d20 5333 4275 6666 6572 6564 5772 6974  = S3BufferedWrit
-00007290: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-000072a0: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
-000072b0: 2020 2020 6b65 792c 0a20 2020 2020 2020      key,.       
-000072c0: 2020 2020 2073 335f 636c 6965 6e74 3d63       s3_client=c
-000072d0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
-000072e0: 2020 206d 6178 5f77 6f72 6b65 7273 3d6d     max_workers=m
-000072f0: 6178 5f63 6f6e 6375 7272 656e 6379 2c0a  ax_concurrency,.
-00007300: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
-00007310: 6275 6666 6572 5f73 697a 653d 6d61 785f  buffer_size=max_
-00007320: 6275 6666 6572 5f73 697a 652c 0a20 2020  buffer_size,.   
-00007330: 2020 2020 2020 2020 2062 6c6f 636b 5f73           block_s
-00007340: 697a 653d 626c 6f63 6b5f 7369 7a65 290a  ize=block_size).
-00007350: 2020 2020 6966 2062 7566 6665 7265 643a      if buffered:
-00007360: 0a20 2020 2020 2020 2077 7269 7465 7220  .        writer 
-00007370: 3d20 696f 2e42 7566 6665 7265 6457 7269  = io.BufferedWri
-00007380: 7465 7228 7772 6974 6572 2920 2023 2070  ter(writer)  # p
-00007390: 7974 7970 653a 2064 6973 6162 6c65 3d77  ytype: disable=w
-000073a0: 726f 6e67 2d61 7267 2d74 7970 6573 0a20  rong-arg-types. 
-000073b0: 2020 2072 6574 7572 6e20 7772 6974 6572     return writer
-000073c0: 0a0a 0a40 5f73 335f 6269 6e61 7279 5f6d  ...@_s3_binary_m
-000073d0: 6f64 650a 6465 6620 7333 5f6d 656d 6f72  ode.def s3_memor
-000073e0: 795f 6f70 656e 280a 2020 2020 2020 2020  y_open(.        
-000073f0: 7333 5f75 726c 3a20 5061 7468 4c69 6b65  s3_url: PathLike
-00007400: 2c20 6d6f 6465 3a20 7374 722c 0a20 2020  , mode: str,.   
-00007410: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
-00007420: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
-00007430: 2d3e 2053 334d 656d 6f72 7948 616e 646c  -> S3MemoryHandl
-00007440: 6572 3a0a 2020 2020 2727 274f 7065 6e20  er:.    '''Open 
-00007450: 6120 6d65 6d6f 7279 2d63 6163 6865 2066  a memory-cache f
-00007460: 696c 6520 7265 6164 6572 202f 2077 7269  ile reader / wri
-00007470: 7465 722c 2066 6f72 2066 7265 7175 656e  ter, for frequen
-00007480: 7420 7261 6e64 6f6d 2072 6561 6420 2f20  t random read / 
-00007490: 7772 6974 650a 0a20 2020 202e 2e20 6e6f  write..    .. no
-000074a0: 7465 203a 3a0a 0a20 2020 2020 2020 2055  te ::..        U
-000074b0: 7365 7220 7368 6f75 6c64 206d 616b 6520  ser should make 
-000074c0: 7375 7265 2074 6861 7420 7265 6164 6572  sure that reader
-000074d0: 202f 2077 7269 7465 7220 6172 6520 636c   / writer are cl
-000074e0: 6f73 6564 2063 6f72 7265 6374 6c79 0a0a  osed correctly..
-000074f0: 2020 2020 2020 2020 5375 7070 6f72 7473          Supports
-00007500: 2063 6f6e 7465 7874 206d 616e 6167 6572   context manager
-00007510: 0a0a 2020 2020 3a70 6172 616d 206d 6f64  ..    :param mod
-00007520: 653a 204d 6f64 6520 746f 206f 7065 6e20  e: Mode to open 
-00007530: 6669 6c65 2c20 636f 756c 6420 6265 206f  file, could be o
-00007540: 6e65 206f 6620 2272 6222 2c20 2277 6222  ne of "rb", "wb"
-00007550: 2c20 2261 6222 2c20 2272 622b 222c 2022  , "ab", "rb+", "
-00007560: 7762 2b22 206f 7220 2261 622b 220a 2020  wb+" or "ab+".  
-00007570: 2020 3a72 6574 7572 6e73 3a20 416e 206f    :returns: An o
-00007580: 7065 6e65 6420 4275 6666 6572 6564 5265  pened BufferedRe
-00007590: 6164 6572 202f 2042 7566 6665 7265 6457  ader / BufferedW
-000075a0: 7269 7465 7220 6f62 6a65 6374 0a20 2020  riter object.   
-000075b0: 2027 2727 0a20 2020 2069 6620 6d6f 6465   '''.    if mode
-000075c0: 206e 6f74 2069 6e20 2827 7262 272c 2027   not in ('rb', '
-000075d0: 7762 272c 2027 6162 272c 2027 7262 2b27  wb', 'ab', 'rb+'
-000075e0: 2c20 2777 622b 272c 2027 6162 2b27 293a  , 'wb+', 'ab+'):
-000075f0: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
-00007600: 616c 7565 4572 726f 7228 2775 6e61 6363  alueError('unacc
-00007610: 6570 7461 626c 6520 6d6f 6465 3a20 2572  eptable mode: %r
-00007620: 2720 2520 6d6f 6465 290a 2020 2020 7333  ' % mode).    s3
-00007630: 5f75 726c 203d 2053 3350 6174 6828 7333  _url = S3Path(s3
-00007640: 5f75 726c 290a 2020 2020 6966 2066 6f6c  _url).    if fol
-00007650: 6c6f 776c 696e 6b73 3a0a 2020 2020 2020  lowlinks:.      
-00007660: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00007670: 2020 2073 335f 7572 6c20 3d20 7333 5f75     s3_url = s3_u
-00007680: 726c 2e72 6561 646c 696e 6b28 290a 2020  rl.readlink().  
-00007690: 2020 2020 2020 6578 6365 7074 2053 334e        except S3N
-000076a0: 6f74 414c 696e 6b45 7272 6f72 3a0a 2020  otALinkError:.  
-000076b0: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
-000076c0: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-000076d0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-000076e0: 335f 7572 6c2e 7061 7468 5f77 6974 685f  3_url.path_with_
-000076f0: 7072 6f74 6f63 6f6c 290a 2020 2020 636f  protocol).    co
-00007700: 6e66 6967 203d 2062 6f74 6f63 6f72 652e  nfig = botocore.
-00007710: 636f 6e66 6967 2e43 6f6e 6669 6728 6d61  config.Config(ma
-00007720: 785f 706f 6f6c 5f63 6f6e 6e65 6374 696f  x_pool_connectio
-00007730: 6e73 3d6d 6178 5f70 6f6f 6c5f 636f 6e6e  ns=max_pool_conn
-00007740: 6563 7469 6f6e 7329 0a20 2020 2063 6c69  ections).    cli
-00007750: 656e 7420 3d20 6765 745f 7333 5f63 6c69  ent = get_s3_cli
-00007760: 656e 7428 0a20 2020 2020 2020 2063 6f6e  ent(.        con
-00007770: 6669 673d 636f 6e66 6967 2c0a 2020 2020  fig=config,.    
-00007780: 2020 2020 6361 6368 655f 6b65 793d 2773      cache_key='s
-00007790: 335f 6669 6c65 6c69 6b65 5f63 6c69 656e  3_filelike_clien
-000077a0: 7427 2c0a 2020 2020 2020 2020 7072 6f66  t',.        prof
-000077b0: 696c 655f 6e61 6d65 3d73 335f 7572 6c2e  ile_name=s3_url.
-000077c0: 5f70 726f 6669 6c65 5f6e 616d 6529 0a20  _profile_name). 
-000077d0: 2020 2072 6574 7572 6e20 5333 4d65 6d6f     return S3Memo
-000077e0: 7279 4861 6e64 6c65 7228 6275 636b 6574  ryHandler(bucket
-000077f0: 2c20 6b65 792c 206d 6f64 652c 2073 335f  , key, mode, s3_
-00007800: 636c 6965 6e74 3d63 6c69 656e 7429 0a0a  client=client)..
-00007810: 0a73 335f 6f70 656e 203d 2073 335f 6275  .s3_open = s3_bu
-00007820: 6666 6572 6564 5f6f 7065 6e0a 0a0a 6465  ffered_open...de
-00007830: 6620 7333 5f64 6f77 6e6c 6f61 6428 0a20  f s3_download(. 
-00007840: 2020 2020 2020 2073 7263 5f75 726c 3a20         src_url: 
-00007850: 5061 7468 4c69 6b65 2c0a 2020 2020 2020  PathLike,.      
-00007860: 2020 6473 745f 7572 6c3a 2050 6174 684c    dst_url: PathL
-00007870: 696b 652c 0a20 2020 2020 2020 2066 6f6c  ike,.        fol
-00007880: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-00007890: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-000078a0: 6361 6c6c 6261 636b 3a20 4f70 7469 6f6e  callback: Option
-000078b0: 616c 5b43 616c 6c61 626c 655b 5b69 6e74  al[Callable[[int
-000078c0: 5d2c 204e 6f6e 655d 5d20 3d20 4e6f 6e65  ], None]] = None
-000078d0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2027  ) -> None:.    '
-000078e0: 2727 0a20 2020 2044 6f77 6e6c 6f61 6473  ''.    Downloads
-000078f0: 2061 2066 696c 6520 6672 6f6d 2073 3320   a file from s3 
-00007900: 746f 206c 6f63 616c 2066 696c 6573 7973  to local filesys
-00007910: 7465 6d2e 0a20 2020 203a 7061 7261 6d20  tem..    :param 
-00007920: 7372 635f 7572 6c3a 2073 6f75 7263 6520  src_url: source 
-00007930: 7333 2070 6174 680a 2020 2020 3a70 6172  s3 path.    :par
-00007940: 616d 2064 7374 5f75 726c 3a20 7461 7267  am dst_url: targ
-00007950: 6574 2066 7320 7061 7468 0a20 2020 203a  et fs path.    :
-00007960: 7061 7261 6d20 6361 6c6c 6261 636b 3a20  param callback: 
-00007970: 4361 6c6c 6564 2070 6572 696f 6469 6361  Called periodica
-00007980: 6c6c 7920 6475 7269 6e67 2063 6f70 792c  lly during copy,
-00007990: 2061 6e64 2074 6865 2069 6e70 7574 2070   and the input p
-000079a0: 6172 616d 6574 6572 2069 7320 7468 6520  arameter is the 
-000079b0: 6461 7461 2073 697a 6520 2869 6e20 6279  data size (in by
-000079c0: 7465 7329 206f 6620 636f 7079 2073 696e  tes) of copy sin
-000079d0: 6365 2074 6865 206c 6173 7420 6361 6c6c  ce the last call
-000079e0: 0a20 2020 2027 2727 0a20 2020 2073 7263  .    '''.    src
-000079f0: 5f75 726c 203d 2053 3350 6174 6828 7372  _url = S3Path(sr
-00007a00: 635f 7572 6c29 0a20 2020 2069 6620 666f  c_url).    if fo
-00007a10: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
-00007a20: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00007a30: 2020 2020 7372 635f 7572 6c20 3d20 7372      src_url = sr
-00007a40: 635f 7572 6c2e 7265 6164 6c69 6e6b 2829  c_url.readlink()
-00007a50: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00007a60: 5333 4e6f 7441 4c69 6e6b 4572 726f 723a  S3NotALinkError:
-00007a70: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
-00007a80: 730a 2020 2020 7372 635f 6275 636b 6574  s.    src_bucket
-00007a90: 2c20 7372 635f 6b65 7920 3d20 7061 7273  , src_key = pars
-00007aa0: 655f 7333 5f75 726c 2873 7263 5f75 726c  e_s3_url(src_url
-00007ab0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-00007ac0: 636f 6c29 0a20 2020 2069 6620 6e6f 7420  col).    if not 
-00007ad0: 7372 635f 6275 636b 6574 3a0a 2020 2020  src_bucket:.    
-00007ae0: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
-00007af0: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
-00007b00: 0a20 2020 2020 2020 2020 2020 2027 456d  .            'Em
-00007b10: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
-00007b20: 2025 7227 2025 2073 7263 5f75 726c 2e70   %r' % src_url.p
-00007b30: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00007b40: 6c29 0a0a 2020 2020 6966 206e 6f74 2073  l)..    if not s
-00007b50: 7263 5f75 726c 2e65 7869 7374 7328 293a  rc_url.exists():
-00007b60: 0a20 2020 2020 2020 2072 6169 7365 2053  .        raise S
-00007b70: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
-00007b80: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00007b90: 2746 696c 6520 6e6f 7420 666f 756e 643a  'File not found:
-00007ba0: 2025 7227 2025 2073 7263 5f75 726c 2e70   %r' % src_url.p
-00007bb0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-00007bc0: 6c29 0a0a 2020 2020 6966 206e 6f74 2073  l)..    if not s
-00007bd0: 7263 5f75 726c 2e69 735f 6669 6c65 2829  rc_url.is_file()
-00007be0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00007bf0: 5333 4973 4144 6972 6563 746f 7279 4572  S3IsADirectoryEr
-00007c00: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00007c10: 2027 4973 2061 2064 6972 6563 746f 7279   'Is a directory
-00007c20: 3a20 2572 2720 2520 7372 635f 7572 6c2e  : %r' % src_url.
-00007c30: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-00007c40: 6f6c 290a 0a20 2020 2064 7374 5f75 726c  ol)..    dst_url
-00007c50: 203d 2066 7370 6174 6828 6473 745f 7572   = fspath(dst_ur
-00007c60: 6c29 0a20 2020 2069 6620 6e6f 7420 6473  l).    if not ds
-00007c70: 745f 7572 6c20 6f72 2064 7374 5f75 726c  t_url or dst_url
-00007c80: 2e65 6e64 7377 6974 6828 272f 2729 3a0a  .endswith('/'):.
-00007c90: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-00007ca0: 4973 4144 6972 6563 746f 7279 4572 726f  IsADirectoryErro
-00007cb0: 7228 2749 7320 6120 6469 7265 6374 6f72  r('Is a director
-00007cc0: 793a 2025 7227 2025 2064 7374 5f75 726c  y: %r' % dst_url
-00007cd0: 290a 0a20 2020 2064 7374 5f64 6972 6563  )..    dst_direc
-00007ce0: 746f 7279 203d 206f 732e 7061 7468 2e64  tory = os.path.d
-00007cf0: 6972 6e61 6d65 2864 7374 5f75 726c 290a  irname(dst_url).
-00007d00: 2020 2020 6966 2064 7374 5f64 6972 6563      if dst_direc
-00007d10: 746f 7279 2021 3d20 2727 3a0a 2020 2020  tory != '':.    
-00007d20: 2020 2020 6f73 2e6d 616b 6564 6972 7328      os.makedirs(
-00007d30: 6473 745f 6469 7265 6374 6f72 792c 2065  dst_directory, e
-00007d40: 7869 7374 5f6f 6b3d 5472 7565 290a 0a20  xist_ok=True).. 
-00007d50: 2020 2063 6c69 656e 7420 3d20 6765 745f     client = get_
-00007d60: 7333 5f63 6c69 656e 7428 7072 6f66 696c  s3_client(profil
-00007d70: 655f 6e61 6d65 3d73 7263 5f75 726c 2e5f  e_name=src_url._
-00007d80: 7072 6f66 696c 655f 6e61 6d65 290a 2020  profile_name).  
-00007d90: 2020 7472 793a 0a20 2020 2020 2020 2063    try:.        c
-00007da0: 6c69 656e 742e 646f 776e 6c6f 6164 5f66  lient.download_f
-00007db0: 696c 6528 7372 635f 6275 636b 6574 2c20  ile(src_bucket, 
-00007dc0: 7372 635f 6b65 792c 2064 7374 5f75 726c  src_key, dst_url
-00007dd0: 2c20 4361 6c6c 6261 636b 3d63 616c 6c62  , Callback=callb
-00007de0: 6163 6b29 0a20 2020 2065 7863 6570 7420  ack).    except 
-00007df0: 4578 6365 7074 696f 6e20 6173 2065 7272  Exception as err
-00007e00: 6f72 3a20 2023 2070 7261 676d 613a 206e  or:  # pragma: n
-00007e10: 6f20 636f 7665 720a 2020 2020 2020 2020  o cover.        
-00007e20: 6572 726f 7220 3d20 7472 616e 736c 6174  error = translat
-00007e30: 655f 6673 5f65 7272 6f72 2865 7272 6f72  e_fs_error(error
-00007e40: 2c20 6473 745f 7572 6c29 0a20 2020 2020  , dst_url).     
-00007e50: 2020 2065 7272 6f72 203d 2074 7261 6e73     error = trans
-00007e60: 6c61 7465 5f73 335f 6572 726f 7228 6572  late_s3_error(er
-00007e70: 726f 722c 2073 7263 5f75 726c 2e70 6174  ror, src_url.pat
-00007e80: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00007e90: 0a20 2020 2020 2020 2072 6169 7365 2065  .        raise e
-00007ea0: 7272 6f72 0a0a 2020 2020 7372 635f 7374  rror..    src_st
-00007eb0: 6174 203d 2073 7263 5f75 726c 2e73 7461  at = src_url.sta
-00007ec0: 7428 290a 2020 2020 6f73 2e75 7469 6d65  t().    os.utime
-00007ed0: 2864 7374 5f75 726c 2c20 2873 7263 5f73  (dst_url, (src_s
-00007ee0: 7461 742e 7374 5f6d 7469 6d65 2c20 7372  tat.st_mtime, sr
-00007ef0: 635f 7374 6174 2e73 745f 6d74 696d 6529  c_stat.st_mtime)
-00007f00: 290a 0a0a 6465 6620 7333 5f75 706c 6f61  )...def s3_uploa
-00007f10: 6428 0a20 2020 2020 2020 2073 7263 5f75  d(.        src_u
-00007f20: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
-00007f30: 2020 2020 2020 6473 745f 7572 6c3a 2050        dst_url: P
-00007f40: 6174 684c 696b 652c 0a20 2020 2020 2020  athLike,.       
-00007f50: 2063 616c 6c62 6163 6b3a 204f 7074 696f   callback: Optio
-00007f60: 6e61 6c5b 4361 6c6c 6162 6c65 5b5b 696e  nal[Callable[[in
-00007f70: 745d 2c20 4e6f 6e65 5d5d 203d 204e 6f6e  t], None]] = Non
-00007f80: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
-00007f90: 7267 7329 202d 3e20 4e6f 6e65 3a0a 2020  rgs) -> None:.  
-00007fa0: 2020 2727 270a 2020 2020 5570 6c6f 6164    '''.    Upload
-00007fb0: 7320 6120 6669 6c65 2066 726f 6d20 6c6f  s a file from lo
-00007fc0: 6361 6c20 6669 6c65 7379 7374 656d 2074  cal filesystem t
-00007fd0: 6f20 7333 2e0a 2020 2020 3a70 6172 616d  o s3..    :param
-00007fe0: 2073 7263 5f75 726c 3a20 736f 7572 6365   src_url: source
-00007ff0: 2066 7320 7061 7468 0a20 2020 203a 7061   fs path.    :pa
-00008000: 7261 6d20 6473 745f 7572 6c3a 2074 6172  ram dst_url: tar
-00008010: 6765 7420 7333 2070 6174 680a 2020 2020  get s3 path.    
-00008020: 3a70 6172 616d 2063 616c 6c62 6163 6b3a  :param callback:
-00008030: 2043 616c 6c65 6420 7065 7269 6f64 6963   Called periodic
-00008040: 616c 6c79 2064 7572 696e 6720 636f 7079  ally during copy
-00008050: 2c20 616e 6420 7468 6520 696e 7075 7420  , and the input 
-00008060: 7061 7261 6d65 7465 7220 6973 2074 6865  parameter is the
-00008070: 2064 6174 6120 7369 7a65 2028 696e 2062   data size (in b
-00008080: 7974 6573 2920 6f66 2063 6f70 7920 7369  ytes) of copy si
-00008090: 6e63 6520 7468 6520 6c61 7374 2063 616c  nce the last cal
-000080a0: 6c0a 2020 2020 2727 270a 2020 2020 6473  l.    '''.    ds
-000080b0: 745f 6275 636b 6574 2c20 6473 745f 6b65  t_bucket, dst_ke
-000080c0: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
-000080d0: 2864 7374 5f75 726c 290a 2020 2020 6966  (dst_url).    if
-000080e0: 206e 6f74 2064 7374 5f62 7563 6b65 743a   not dst_bucket:
-000080f0: 0a20 2020 2020 2020 2072 6169 7365 2053  .        raise S
-00008100: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
-00008110: 7272 6f72 2827 456d 7074 7920 6275 636b  rror('Empty buck
-00008120: 6574 206e 616d 653a 2025 7227 2025 2064  et name: %r' % d
-00008130: 7374 5f75 726c 290a 2020 2020 6966 206e  st_url).    if n
-00008140: 6f74 2064 7374 5f6b 6579 206f 7220 6473  ot dst_key or ds
-00008150: 745f 6b65 792e 656e 6473 7769 7468 2827  t_key.endswith('
-00008160: 2f27 293a 0a20 2020 2020 2020 2072 6169  /'):.        rai
-00008170: 7365 2053 3349 7341 4469 7265 6374 6f72  se S3IsADirector
-00008180: 7945 7272 6f72 2827 4973 2061 2064 6972  yError('Is a dir
-00008190: 6563 746f 7279 3a20 2572 2720 2520 6473  ectory: %r' % ds
-000081a0: 745f 7572 6c29 0a0a 2020 2020 636c 6965  t_url)..    clie
-000081b0: 6e74 203d 2067 6574 5f73 335f 636c 6965  nt = get_s3_clie
-000081c0: 6e74 2870 726f 6669 6c65 5f6e 616d 653d  nt(profile_name=
-000081d0: 5333 5061 7468 2864 7374 5f75 726c 292e  S3Path(dst_url).
-000081e0: 5f70 726f 6669 6c65 5f6e 616d 6529 0a20  _profile_name). 
-000081f0: 2020 2077 6974 6820 6f70 656e 2873 7263     with open(src
-00008200: 5f75 726c 2c20 2772 6227 2920 6173 2073  _url, 'rb') as s
-00008210: 7263 3a0a 2020 2020 2020 2020 7769 7468  rc:.        with
-00008220: 2072 6169 7365 5f73 335f 6572 726f 7228   raise_s3_error(
-00008230: 6473 745f 7572 6c29 3a0a 2020 2020 2020  dst_url):.      
-00008240: 2020 2020 2020 636c 6965 6e74 2e75 706c        client.upl
-00008250: 6f61 645f 6669 6c65 6f62 6a28 0a20 2020  oad_fileobj(.   
-00008260: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00008270: 2c20 4275 636b 6574 3d64 7374 5f62 7563  , Bucket=dst_buc
-00008280: 6b65 742c 204b 6579 3d64 7374 5f6b 6579  ket, Key=dst_key
-00008290: 2c20 4361 6c6c 6261 636b 3d63 616c 6c62  , Callback=callb
-000082a0: 6163 6b29 0a0a 0a64 6566 2073 335f 6c6f  ack)...def s3_lo
-000082b0: 6164 5f63 6f6e 7465 6e74 280a 2020 2020  ad_content(.    
-000082c0: 2020 2020 7333 5f75 726c 2c0a 2020 2020      s3_url,.    
-000082d0: 2020 2020 7374 6172 743a 204f 7074 696f      start: Optio
-000082e0: 6e61 6c5b 696e 745d 203d 204e 6f6e 652c  nal[int] = None,
-000082f0: 0a20 2020 2020 2020 2073 746f 703a 204f  .        stop: O
-00008300: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
-00008310: 6f6e 652c 0a20 2020 2020 2020 2066 6f6c  one,.        fol
-00008320: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-00008330: 2046 616c 7365 2920 2d3e 2062 7974 6573   False) -> bytes
-00008340: 3a0a 2020 2020 2727 270a 2020 2020 4765  :.    '''.    Ge
-00008350: 7420 7370 6563 6966 6965 6420 6669 6c65  t specified file
-00008360: 2066 726f 6d20 5b73 7461 7274 2c20 7374   from [start, st
-00008370: 6f70 2920 696e 2062 7974 6573 0a0a 2020  op) in bytes..  
-00008380: 2020 3a70 6172 616d 2073 335f 7572 6c3a    :param s3_url:
-00008390: 2053 7065 6369 6669 6564 2070 6174 680a   Specified path.
-000083a0: 2020 2020 3a70 6172 616d 2073 7461 7274      :param start
-000083b0: 3a20 7374 6172 7420 696e 6465 780a 2020  : start index.  
-000083c0: 2020 3a70 6172 616d 2073 746f 703a 2073    :param stop: s
-000083d0: 746f 7020 696e 6465 780a 2020 2020 3a72  top index.    :r
-000083e0: 6574 7572 6e73 3a20 6279 7465 7320 636f  eturns: bytes co
-000083f0: 6e74 656e 7420 696e 2072 616e 6765 205b  ntent in range [
-00008400: 7374 6172 742c 2073 746f 7029 0a20 2020  start, stop).   
-00008410: 2027 2727 0a0a 2020 2020 6465 6620 5f67   '''..    def _g
-00008420: 6574 5f6f 626a 6563 7428 636c 6965 6e74  et_object(client
-00008430: 2c20 6275 636b 6574 2c20 6b65 792c 2072  , bucket, key, r
-00008440: 616e 6765 5f73 7472 293a 0a20 2020 2020  ange_str):.     
-00008450: 2020 2072 6574 7572 6e20 636c 6965 6e74     return client
-00008460: 2e67 6574 5f6f 626a 6563 7428 0a20 2020  .get_object(.   
-00008470: 2020 2020 2020 2020 2042 7563 6b65 743d           Bucket=
-00008480: 6275 636b 6574 2c20 4b65 793d 6b65 792c  bucket, Key=key,
-00008490: 2052 616e 6765 3d72 616e 6765 5f73 7472   Range=range_str
-000084a0: 295b 2742 6f64 7927 5d2e 7265 6164 2829  )['Body'].read()
-000084b0: 0a0a 2020 2020 7333 5f75 726c 203d 2053  ..    s3_url = S
-000084c0: 3350 6174 6828 7333 5f75 726c 290a 2020  3Path(s3_url).  
-000084d0: 2020 6966 2066 6f6c 6c6f 776c 696e 6b73    if followlinks
-000084e0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-000084f0: 2020 2020 2020 2020 2020 2073 335f 7572             s3_ur
-00008500: 6c20 3d20 7333 5f75 726c 2e72 6561 646c  l = s3_url.readl
-00008510: 696e 6b28 290a 2020 2020 2020 2020 6578  ink().        ex
-00008520: 6365 7074 2053 334e 6f74 414c 696e 6b45  cept S3NotALinkE
-00008530: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00008540: 2020 7061 7373 0a0a 2020 2020 6275 636b    pass..    buck
-00008550: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
-00008560: 7333 5f75 726c 2873 335f 7572 6c2e 7061  s3_url(s3_url.pa
-00008570: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00008580: 290a 2020 2020 6966 206e 6f74 2062 7563  ).    if not buc
-00008590: 6b65 743a 0a20 2020 2020 2020 2072 6169  ket:.        rai
-000085a0: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-000085b0: 756e 6445 7272 6f72 2827 456d 7074 7920  undError('Empty 
-000085c0: 6275 636b 6574 206e 616d 653a 2025 7227  bucket name: %r'
-000085d0: 2025 2073 335f 7572 6c29 0a20 2020 2069   % s3_url).    i
-000085e0: 6620 6e6f 7420 6b65 7920 6f72 206b 6579  f not key or key
-000085f0: 2e65 6e64 7377 6974 6828 272f 2729 3a0a  .endswith('/'):.
-00008600: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-00008610: 4973 4144 6972 6563 746f 7279 4572 726f  IsADirectoryErro
-00008620: 7228 2749 7320 6120 6469 7265 6374 6f72  r('Is a director
-00008630: 793a 2025 7227 2025 2073 335f 7572 6c29  y: %r' % s3_url)
-00008640: 0a0a 2020 2020 7374 6172 742c 2073 746f  ..    start, sto
-00008650: 7020 3d20 6765 745f 636f 6e74 656e 745f  p = get_content_
-00008660: 6f66 6673 6574 280a 2020 2020 2020 2020  offset(.        
-00008670: 7374 6172 742c 2073 746f 702c 2073 335f  start, stop, s3_
-00008680: 7572 6c2e 6765 7473 697a 6528 666f 6c6c  url.getsize(foll
-00008690: 6f77 5f73 796d 6c69 6e6b 733d 4661 6c73  ow_symlinks=Fals
-000086a0: 6529 290a 2020 2020 6966 2073 7461 7274  e)).    if start
-000086b0: 203d 3d20 3020 616e 6420 7374 6f70 203d   == 0 and stop =
-000086c0: 3d20 303a 0a20 2020 2020 2020 2072 6574  = 0:.        ret
-000086d0: 7572 6e20 6227 270a 2020 2020 7261 6e67  urn b''.    rang
-000086e0: 655f 7374 7220 3d20 2762 7974 6573 3d25  e_str = 'bytes=%
-000086f0: 642d 2564 2720 2520 2873 7461 7274 2c20  d-%d' % (start, 
-00008700: 7374 6f70 202d 2031 290a 0a20 2020 2063  stop - 1)..    c
-00008710: 6c69 656e 7420 3d20 6765 745f 7333 5f63  lient = get_s3_c
-00008720: 6c69 656e 7428 7072 6f66 696c 655f 6e61  lient(profile_na
-00008730: 6d65 3d73 335f 7572 6c2e 5f70 726f 6669  me=s3_url._profi
-00008740: 6c65 5f6e 616d 6529 0a20 2020 2077 6974  le_name).    wit
-00008750: 6820 7261 6973 655f 7333 5f65 7272 6f72  h raise_s3_error
-00008760: 2873 335f 7572 6c2e 7061 7468 293a 0a20  (s3_url.path):. 
-00008770: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
-00008780: 7463 685f 6d65 7468 6f64 280a 2020 2020  tch_method(.    
-00008790: 2020 2020 2020 2020 5f67 6574 5f6f 626a          _get_obj
-000087a0: 6563 742c 0a20 2020 2020 2020 2020 2020  ect,.           
-000087b0: 206d 6178 5f72 6574 7269 6573 3d6d 6178   max_retries=max
-000087c0: 5f72 6574 7269 6573 2c0a 2020 2020 2020  _retries,.      
-000087d0: 2020 2020 2020 7368 6f75 6c64 5f72 6574        should_ret
-000087e0: 7279 3d73 335f 7368 6f75 6c64 5f72 6574  ry=s3_should_ret
-000087f0: 7279 2c0a 2020 2020 2020 2020 2928 636c  ry,.        )(cl
-00008800: 6965 6e74 2c20 6275 636b 6574 2c20 6b65  ient, bucket, ke
-00008810: 792c 2072 616e 6765 5f73 7472 290a 0a0a  y, range_str)...
-00008820: 6465 6620 7333 5f72 6561 646c 696e 6b28  def s3_readlink(
-00008830: 7061 7468 2920 2d3e 2073 7472 3a0a 2020  path) -> str:.  
-00008840: 2020 2727 270a 2020 2020 5265 7475 726e    '''.    Return
-00008850: 2061 2073 7472 696e 6720 7265 7072 6573   a string repres
-00008860: 656e 7469 6e67 2074 6865 2070 6174 6820  enting the path 
-00008870: 746f 2077 6869 6368 2074 6865 2073 796d  to which the sym
-00008880: 626f 6c69 6320 6c69 6e6b 2070 6f69 6e74  bolic link point
-00008890: 732e 0a0a 2020 2020 3a72 6574 7572 6e73  s...    :returns
-000088a0: 3a20 5265 7475 726e 2061 2073 7472 696e  : Return a strin
-000088b0: 6720 7265 7072 6573 656e 7469 6e67 2074  g representing t
-000088c0: 6865 2070 6174 6820 746f 2077 6869 6368  he path to which
-000088d0: 2074 6865 2073 796d 626f 6c69 6320 6c69   the symbolic li
-000088e0: 6e6b 2070 6f69 6e74 732e 0a20 2020 203a  nk points..    :
-000088f0: 7261 6973 6573 3a20 5333 4e61 6d65 546f  raises: S3NameTo
-00008900: 6f4c 6f6e 6745 7272 6f72 2c20 5333 4275  oLongError, S3Bu
-00008910: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
-00008920: 722c 2053 3349 7341 4469 7265 6374 6f72  r, S3IsADirector
-00008930: 7945 7272 6f72 2c20 5333 4e6f 7441 4c69  yError, S3NotALi
-00008940: 6e6b 4572 726f 720a 2020 2020 2727 270a  nkError.    '''.
-00008950: 2020 2020 7265 7475 726e 2053 3350 6174      return S3Pat
-00008960: 6828 7061 7468 292e 7265 6164 6c69 6e6b  h(path).readlink
-00008970: 2829 2e70 6174 685f 7769 7468 5f70 726f  ().path_with_pro
-00008980: 746f 636f 6c0a 0a0a 6465 6620 7333 5f72  tocol...def s3_r
-00008990: 656e 616d 6528 7372 635f 7572 6c3a 2050  ename(src_url: P
-000089a0: 6174 684c 696b 652c 2064 7374 5f75 726c  athLike, dst_url
-000089b0: 3a20 5061 7468 4c69 6b65 293a 0a20 2020  : PathLike):.   
-000089c0: 2027 2727 0a20 2020 204d 6f76 6520 7333   '''.    Move s3
-000089d0: 2066 696c 6520 7061 7468 2066 726f 6d20   file path from 
-000089e0: 7372 635f 7572 6c20 746f 2064 7374 5f75  src_url to dst_u
-000089f0: 726c 0a0a 2020 2020 3a70 6172 616d 2064  rl..    :param d
-00008a00: 7374 5f75 726c 3a20 4769 7665 6e20 6465  st_url: Given de
-00008a10: 7374 696e 6174 696f 6e20 7061 7468 0a20  stination path. 
-00008a20: 2020 2027 2727 0a20 2020 2073 7263 5f70     '''.    src_p
-00008a30: 6174 685f 696e 7320 3d20 5333 5061 7468  ath_ins = S3Path
-00008a40: 2873 7263 5f75 726c 290a 2020 2020 6966  (src_url).    if
-00008a50: 2073 7263 5f70 6174 685f 696e 732e 6973   src_path_ins.is
-00008a60: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
-00008a70: 2073 7263 5f70 6174 685f 696e 732e 636f   src_path_ins.co
-00008a80: 7079 2864 7374 5f75 726c 290a 2020 2020  py(dst_url).    
-00008a90: 656c 7365 3a0a 2020 2020 2020 2020 7372  else:.        sr
-00008aa0: 635f 7061 7468 5f69 6e73 2e73 796e 6328  c_path_ins.sync(
-00008ab0: 6473 745f 7572 6c29 0a20 2020 2073 7263  dst_url).    src
-00008ac0: 5f70 6174 685f 696e 732e 7265 6d6f 7665  _path_ins.remove
-00008ad0: 2829 0a0a 0a63 6c61 7373 2053 3343 6163  ()...class S3Cac
-00008ae0: 6865 7228 4669 6c65 4361 6368 6572 293a  her(FileCacher):
-00008af0: 0a20 2020 2063 6163 6865 5f70 6174 6820  .    cache_path 
-00008b00: 3d20 4e6f 6e65 0a0a 2020 2020 6465 6620  = None..    def 
-00008b10: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
-00008b20: 2020 2020 2020 7365 6c66 2c20 7061 7468        self, path
-00008b30: 3a20 7374 722c 2063 6163 6865 5f70 6174  : str, cache_pat
-00008b40: 683a 204f 7074 696f 6e61 6c5b 7374 725d  h: Optional[str]
-00008b50: 203d 204e 6f6e 652c 206d 6f64 653a 2073   = None, mode: s
-00008b60: 7472 203d 2027 7227 293a 0a20 2020 2020  tr = 'r'):.     
-00008b70: 2020 2069 6620 6d6f 6465 206e 6f74 2069     if mode not i
-00008b80: 6e20 2827 7227 2c20 2777 272c 2027 6127  n ('r', 'w', 'a'
-00008b90: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00008ba0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00008bb0: 2775 6e61 6363 6570 7461 626c 6520 6d6f  'unacceptable mo
-00008bc0: 6465 3a20 2572 2720 2520 6d6f 6465 290a  de: %r' % mode).
-00008bd0: 2020 2020 2020 2020 6966 206d 6f64 6520          if mode 
-00008be0: 696e 2028 2772 272c 2027 6127 293a 0a20  in ('r', 'a'):. 
-00008bf0: 2020 2020 2020 2020 2020 2069 6620 6361             if ca
-00008c00: 6368 655f 7061 7468 2069 7320 4e6f 6e65  che_path is None
-00008c10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008c20: 2020 6361 6368 655f 7061 7468 203d 2067    cache_path = g
-00008c30: 656e 6572 6174 655f 6361 6368 655f 7061  enerate_cache_pa
-00008c40: 7468 2870 6174 6829 0a20 2020 2020 2020  th(path).       
-00008c50: 2020 2020 2073 335f 646f 776e 6c6f 6164       s3_download
-00008c60: 2870 6174 682c 2063 6163 6865 5f70 6174  (path, cache_pat
-00008c70: 6829 0a20 2020 2020 2020 2073 656c 662e  h).        self.
-00008c80: 6e61 6d65 203d 2070 6174 680a 2020 2020  name = path.    
-00008c90: 2020 2020 7365 6c66 2e6d 6f64 6520 3d20      self.mode = 
-00008ca0: 6d6f 6465 0a20 2020 2020 2020 2073 656c  mode.        sel
-00008cb0: 662e 6361 6368 655f 7061 7468 203d 2063  f.cache_path = c
-00008cc0: 6163 6865 5f70 6174 680a 0a20 2020 2064  ache_path..    d
-00008cd0: 6566 205f 636c 6f73 6528 7365 6c66 293a  ef _close(self):
-00008ce0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00008cf0: 2e63 6163 6865 5f70 6174 6820 6973 206e  .cache_path is n
-00008d00: 6f74 204e 6f6e 6520 616e 6420 5c0a 2020  ot None and \.  
-00008d10: 2020 2020 2020 2020 2020 6f73 2e70 6174            os.pat
-00008d20: 682e 6578 6973 7473 2873 656c 662e 6361  h.exists(self.ca
-00008d30: 6368 655f 7061 7468 293a 0a20 2020 2020  che_path):.     
-00008d40: 2020 2020 2020 2069 6620 7365 6c66 2e6d         if self.m
-00008d50: 6f64 6520 696e 2028 2777 272c 2027 6127  ode in ('w', 'a'
-00008d60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00008d70: 2020 2073 335f 7570 6c6f 6164 2873 656c     s3_upload(sel
-00008d80: 662e 6361 6368 655f 7061 7468 2c20 7365  f.cache_path, se
-00008d90: 6c66 2e6e 616d 6529 0a20 2020 2020 2020  lf.name).       
-00008da0: 2020 2020 206f 732e 756e 6c69 6e6b 2873       os.unlink(s
-00008db0: 656c 662e 6361 6368 655f 7061 7468 290a  elf.cache_path).
-00008dc0: 0a0a 6465 6620 7333 5f67 6c6f 6228 0a20  ..def s3_glob(. 
-00008dd0: 2020 2020 2020 2070 6174 683a 2050 6174         path: Pat
-00008de0: 684c 696b 652c 0a20 2020 2020 2020 2072  hLike,.        r
-00008df0: 6563 7572 7369 7665 3a20 626f 6f6c 203d  ecursive: bool =
-00008e00: 2054 7275 652c 0a20 2020 2020 2020 206d   True,.        m
-00008e10: 6973 7369 6e67 5f6f 6b3a 2062 6f6f 6c20  issing_ok: bool 
-00008e20: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
-00008e30: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-00008e40: 6c20 3d20 4661 6c73 652c 0a29 202d 3e20  l = False,.) -> 
-00008e50: 4c69 7374 5b73 7472 5d3a 0a20 2020 2027  List[str]:.    '
-00008e60: 2727 5265 7475 726e 2073 3320 7061 7468  ''Return s3 path
-00008e70: 206c 6973 7420 696e 2061 7363 656e 6469   list in ascendi
-00008e80: 6e67 2061 6c70 6861 6265 7469 6361 6c20  ng alphabetical 
-00008e90: 6f72 6465 722c 2069 6e20 7768 6963 6820  order, in which 
-00008ea0: 7061 7468 206d 6174 6368 6573 2067 6c6f  path matches glo
-00008eb0: 6220 7061 7474 6572 6e0a 2020 2020 4e6f  b pattern.    No
-00008ec0: 7465 733a 204f 6e6c 7920 676c 6f62 2069  tes: Only glob i
-00008ed0: 6e20 6275 636b 6574 2e20 4966 2074 7279  n bucket. If try
-00008ee0: 696e 6720 746f 206d 6174 6368 2062 7563  ing to match buc
-00008ef0: 6b65 7420 7769 7468 2077 696c 6463 6172  ket with wildcar
-00008f00: 6420 6368 6172 6163 7465 7273 2c20 7261  d characters, ra
-00008f10: 6973 6520 556e 7375 7070 6f72 7465 6445  ise UnsupportedE
-00008f20: 7272 6f72 0a0a 2020 2020 3a70 6172 616d  rror..    :param
-00008f30: 2072 6563 7572 7369 7665 3a20 4966 2046   recursive: If F
-00008f40: 616c 7365 2c20 602a 2a60 2077 696c 6c20  alse, `**` will 
-00008f50: 6e6f 7420 7365 6172 6368 2064 6972 6563  not search direc
-00008f60: 746f 7279 2072 6563 7572 7369 7665 6c79  tory recursively
-00008f70: 0a20 2020 203a 7061 7261 6d20 6d69 7373  .    :param miss
-00008f80: 696e 675f 6f6b 3a20 4966 2046 616c 7365  ing_ok: If False
-00008f90: 2061 6e64 2074 6172 6765 7420 7061 7468   and target path
-00008fa0: 2064 6f65 736e 2774 206d 6174 6368 2061   doesn't match a
-00008fb0: 6e79 2066 696c 652c 2072 6169 7365 2046  ny file, raise F
-00008fc0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-00008fd0: 0a20 2020 203a 7261 6973 6573 3a20 556e  .    :raises: Un
-00008fe0: 7375 7070 6f72 7465 6445 7272 6f72 2c20  supportedError, 
-00008ff0: 7768 656e 2062 7563 6b65 7420 7061 7274  when bucket part
-00009000: 2063 6f6e 7461 696e 7320 7769 6c64 6361   contains wildca
-00009010: 7264 2063 6861 7261 6374 6572 730a 2020  rd characters.  
-00009020: 2020 3a72 6574 7572 6e73 3a20 4120 6c69    :returns: A li
-00009030: 7374 2063 6f6e 7461 696e 7320 7061 7468  st contains path
-00009040: 7320 6d61 7463 6820 6073 335f 7061 7468  s match `s3_path
-00009050: 6e61 6d65 600a 2020 2020 2727 270a 2020  name`.    '''.  
-00009060: 2020 7265 7475 726e 206c 6973 7428 0a20    return list(. 
-00009070: 2020 2020 2020 2073 335f 6967 6c6f 6228         s3_iglob(
-00009080: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
-00009090: 683d 7061 7468 2c0a 2020 2020 2020 2020  h=path,.        
-000090a0: 2020 2020 7265 6375 7273 6976 653d 7265      recursive=re
-000090b0: 6375 7273 6976 652c 0a20 2020 2020 2020  cursive,.       
-000090c0: 2020 2020 206d 6973 7369 6e67 5f6f 6b3d       missing_ok=
-000090d0: 6d69 7373 696e 675f 6f6b 2c0a 2020 2020  missing_ok,.    
-000090e0: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
-000090f0: 6e6b 733d 666f 6c6c 6f77 6c69 6e6b 7329  nks=followlinks)
-00009100: 290a 0a0a 6465 6620 7333 5f67 6c6f 625f  )...def s3_glob_
-00009110: 7374 6174 280a 2020 2020 2020 2020 7061  stat(.        pa
-00009120: 7468 3a20 5061 7468 4c69 6b65 2c0a 2020  th: PathLike,.  
-00009130: 2020 2020 2020 7265 6375 7273 6976 653a        recursive:
-00009140: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
-00009150: 2020 2020 2020 6d69 7373 696e 675f 6f6b        missing_ok
-00009160: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
-00009170: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
-00009180: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
-00009190: 2920 2d3e 2049 7465 7261 746f 725b 4669  ) -> Iterator[Fi
-000091a0: 6c65 456e 7472 795d 3a0a 2020 2020 2727  leEntry]:.    ''
-000091b0: 2752 6574 7572 6e20 6120 6765 6e65 7261  'Return a genera
-000091c0: 746f 7220 636f 6e74 6169 6e73 2074 7570  tor contains tup
-000091d0: 6c65 7320 6f66 2070 6174 6820 616e 6420  les of path and 
-000091e0: 6669 6c65 2073 7461 742c 2069 6e20 6173  file stat, in as
-000091f0: 6365 6e64 696e 6720 616c 7068 6162 6574  cending alphabet
-00009200: 6963 616c 206f 7264 6572 2c20 696e 2077  ical order, in w
-00009210: 6869 6368 2070 6174 6820 6d61 7463 6865  hich path matche
-00009220: 7320 676c 6f62 2070 6174 7465 726e 0a20  s glob pattern. 
-00009230: 2020 204e 6f74 6573 3a20 4f6e 6c79 2067     Notes: Only g
-00009240: 6c6f 6220 696e 2062 7563 6b65 742e 2049  lob in bucket. I
-00009250: 6620 7472 7969 6e67 2074 6f20 6d61 7463  f trying to matc
-00009260: 6820 6275 636b 6574 2077 6974 6820 7769  h bucket with wi
-00009270: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
-00009280: 732c 2072 6169 7365 2055 6e73 7570 706f  s, raise Unsuppo
-00009290: 7274 6564 4572 726f 720a 0a20 2020 203a  rtedError..    :
-000092a0: 7061 7261 6d20 7265 6375 7273 6976 653a  param recursive:
-000092b0: 2049 6620 4661 6c73 652c 2060 2a2a 6020   If False, `**` 
-000092c0: 7769 6c6c 206e 6f74 2073 6561 7263 6820  will not search 
-000092d0: 6469 7265 6374 6f72 7920 7265 6375 7273  directory recurs
-000092e0: 6976 656c 790a 2020 2020 3a70 6172 616d  ively.    :param
-000092f0: 206d 6973 7369 6e67 5f6f 6b3a 2049 6620   missing_ok: If 
-00009300: 4661 6c73 6520 616e 6420 7461 7267 6574  False and target
-00009310: 2070 6174 6820 646f 6573 6e27 7420 6d61   path doesn't ma
-00009320: 7463 6820 616e 7920 6669 6c65 2c20 7261  tch any file, ra
-00009330: 6973 6520 4669 6c65 4e6f 7446 6f75 6e64  ise FileNotFound
-00009340: 4572 726f 720a 2020 2020 3a72 6169 7365  Error.    :raise
-00009350: 733a 2055 6e73 7570 706f 7274 6564 4572  s: UnsupportedEr
-00009360: 726f 722c 2077 6865 6e20 6275 636b 6574  ror, when bucket
-00009370: 2070 6172 7420 636f 6e74 6169 6e73 2077   part contains w
-00009380: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
-00009390: 7273 0a20 2020 203a 7265 7475 726e 733a  rs.    :returns:
-000093a0: 2041 2067 656e 6572 6174 6f72 2063 6f6e   A generator con
-000093b0: 7461 696e 7320 7475 706c 6573 206f 6620  tains tuples of 
-000093c0: 7061 7468 2061 6e64 2066 696c 6520 7374  path and file st
-000093d0: 6174 2c20 696e 2077 6869 6368 2070 6174  at, in which pat
-000093e0: 6873 206d 6174 6368 2060 7333 5f70 6174  hs match `s3_pat
-000093f0: 686e 616d 6560 0a20 2020 2027 2727 0a20  hname`.    '''. 
-00009400: 2020 2072 6574 7572 6e20 5333 5061 7468     return S3Path
-00009410: 2870 6174 6829 2e67 6c6f 625f 7374 6174  (path).glob_stat
-00009420: 280a 2020 2020 2020 2020 7061 7474 6572  (.        patter
-00009430: 6e3d 2222 2c0a 2020 2020 2020 2020 7265  n="",.        re
-00009440: 6375 7273 6976 653d 7265 6375 7273 6976  cursive=recursiv
-00009450: 652c 0a20 2020 2020 2020 206d 6973 7369  e,.        missi
-00009460: 6e67 5f6f 6b3d 6d69 7373 696e 675f 6f6b  ng_ok=missing_ok
-00009470: 2c0a 2020 2020 2020 2020 666f 6c6c 6f77  ,.        follow
-00009480: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
-00009490: 7329 0a0a 0a64 6566 2073 335f 6967 6c6f  s)...def s3_iglo
-000094a0: 6228 0a20 2020 2020 2020 2070 6174 683a  b(.        path:
-000094b0: 2050 6174 684c 696b 652c 0a20 2020 2020   PathLike,.     
-000094c0: 2020 2072 6563 7572 7369 7665 3a20 626f     recursive: bo
-000094d0: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
-000094e0: 2020 206d 6973 7369 6e67 5f6f 6b3a 2062     missing_ok: b
-000094f0: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-00009500: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733a      followlinks:
-00009510: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a29   bool = False,.)
-00009520: 202d 3e20 4974 6572 6174 6f72 5b73 7472   -> Iterator[str
-00009530: 5d3a 0a20 2020 2027 2727 5265 7475 726e  ]:.    '''Return
-00009540: 2073 3320 7061 7468 2069 7465 7261 746f   s3 path iterato
-00009550: 7220 696e 2061 7363 656e 6469 6e67 2061  r in ascending a
-00009560: 6c70 6861 6265 7469 6361 6c20 6f72 6465  lphabetical orde
-00009570: 722c 2069 6e20 7768 6963 6820 7061 7468  r, in which path
-00009580: 206d 6174 6368 6573 2067 6c6f 6220 7061   matches glob pa
-00009590: 7474 6572 6e0a 2020 2020 4e6f 7465 733a  ttern.    Notes:
-000095a0: 204f 6e6c 7920 676c 6f62 2069 6e20 6275   Only glob in bu
-000095b0: 636b 6574 2e20 4966 2074 7279 696e 6720  cket. If trying 
-000095c0: 746f 206d 6174 6368 2062 7563 6b65 7420  to match bucket 
-000095d0: 7769 7468 2077 696c 6463 6172 6420 6368  with wildcard ch
-000095e0: 6172 6163 7465 7273 2c20 7261 6973 6520  aracters, raise 
-000095f0: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
-00009600: 0a0a 2020 2020 3a70 6172 616d 2072 6563  ..    :param rec
-00009610: 7572 7369 7665 3a20 4966 2046 616c 7365  ursive: If False
-00009620: 2c20 602a 2a60 2077 696c 6c20 6e6f 7420  , `**` will not 
-00009630: 7365 6172 6368 2064 6972 6563 746f 7279  search directory
-00009640: 2072 6563 7572 7369 7665 6c79 0a20 2020   recursively.   
-00009650: 203a 7061 7261 6d20 6d69 7373 696e 675f   :param missing_
-00009660: 6f6b 3a20 4966 2046 616c 7365 2061 6e64  ok: If False and
-00009670: 2074 6172 6765 7420 7061 7468 2064 6f65   target path doe
-00009680: 736e 2774 206d 6174 6368 2061 6e79 2066  sn't match any f
-00009690: 696c 652c 2072 6169 7365 2046 696c 654e  ile, raise FileN
-000096a0: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
-000096b0: 203a 7261 6973 6573 3a20 556e 7375 7070   :raises: Unsupp
-000096c0: 6f72 7465 6445 7272 6f72 2c20 7768 656e  ortedError, when
-000096d0: 2062 7563 6b65 7420 7061 7274 2063 6f6e   bucket part con
-000096e0: 7461 696e 7320 7769 6c64 6361 7264 2063  tains wildcard c
-000096f0: 6861 7261 6374 6572 730a 2020 2020 3a72  haracters.    :r
-00009700: 6574 7572 6e73 3a20 416e 2069 7465 7261  eturns: An itera
-00009710: 746f 7220 636f 6e74 6169 6e73 2070 6174  tor contains pat
-00009720: 6873 206d 6174 6368 2060 7333 5f70 6174  hs match `s3_pat
-00009730: 686e 616d 6560 0a20 2020 2027 2727 0a20  hname`.    '''. 
-00009740: 2020 2066 6f72 2070 6174 685f 6f62 6a20     for path_obj 
-00009750: 696e 2053 3350 6174 6828 7061 7468 292e  in S3Path(path).
-00009760: 6967 6c6f 6228 7061 7474 6572 6e3d 2222  iglob(pattern=""
-00009770: 2c20 7265 6375 7273 6976 653d 7265 6375  , recursive=recu
-00009780: 7273 6976 652c 0a20 2020 2020 2020 2020  rsive,.         
+00004110: 2020 2020 2020 2020 2053 3350 6174 6828           S3Path(
+00004120: 7061 7468 292e 6e61 6d65 2c20 7061 7468  path).name, path
+00004130: 2c20 5374 6174 5265 7375 6c74 2869 7364  , StatResult(isd
+00004140: 6972 3d54 7275 6529 290a 2020 2020 2020  ir=True)).      
+00004150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004160: 2020 6469 726e 616d 6520 3d20 6f73 2e70    dirname = os.p
+00004170: 6174 682e 6469 726e 616d 6528 6469 726e  ath.dirname(dirn
+00004180: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+00004190: 2020 2020 2066 6f72 2063 6f6d 6d6f 6e5f       for common_
+000041a0: 7072 6566 6978 2069 6e20 7265 7370 2e67  prefix in resp.g
+000041b0: 6574 2827 436f 6d6d 6f6e 5072 6566 6978  et('CommonPrefix
+000041c0: 6573 272c 205b 5d29 3a0a 2020 2020 2020  es', []):.      
+000041d0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+000041e0: 7468 203d 2073 335f 7061 7468 5f6a 6f69  th = s3_path_joi
+000041f0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00004200: 2020 2020 2020 2020 2020 2027 7333 3a2f             's3:/
+00004210: 2f27 2c20 6275 636b 6574 2c20 636f 6d6d  /', bucket, comm
+00004220: 6f6e 5f70 7265 6669 785b 2750 7265 6669  on_prefix['Prefi
+00004230: 7827 5d29 0a20 2020 2020 2020 2020 2020  x']).           
+00004240: 2020 2020 2020 2020 2064 6972 6e61 6d65           dirname
+00004250: 203d 206f 732e 7061 7468 2e64 6972 6e61   = os.path.dirna
+00004260: 6d65 2870 6174 6829 0a20 2020 2020 2020  me(path).       
+00004270: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00004280: 6469 726e 616d 6520 6e6f 7420 696e 2064  dirname not in d
+00004290: 6972 6e61 6d65 7320 616e 6420 6469 726e  irnames and dirn
+000042a0: 616d 6520 213d 2074 6f70 5f64 6972 3a0a  ame != top_dir:.
+000042b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042c0: 2020 2020 2020 2020 6469 726e 616d 6573          dirnames
+000042d0: 2e61 6464 2864 6972 6e61 6d65 290a 2020  .add(dirname).  
+000042e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042f0: 2020 2020 2020 7061 7468 203d 2064 6972        path = dir
+00004300: 6e61 6d65 202b 2027 2f27 2069 6620 7365  name + '/' if se
+00004310: 6172 6368 5f64 6972 2065 6c73 6520 6469  arch_dir else di
+00004320: 726e 616d 650a 2020 2020 2020 2020 2020  rname.          
+00004330: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00004340: 2070 6174 7465 726e 2e6d 6174 6368 2870   pattern.match(p
+00004350: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
+00004360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004370: 2020 7969 656c 6420 4669 6c65 456e 7472    yield FileEntr
+00004380: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
+00004390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043a0: 2020 2053 3350 6174 6828 7061 7468 292e     S3Path(path).
+000043b0: 6e61 6d65 2c20 7061 7468 2c20 5374 6174  name, path, Stat
+000043c0: 5265 7375 6c74 2869 7364 6972 3d54 7275  Result(isdir=Tru
+000043d0: 6529 290a 0a20 2020 2072 6574 7572 6e20  e))..    return 
+000043e0: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
+000043f0: 2873 335f 7061 7468 6e61 6d65 290a 0a0a  (s3_pathname)...
+00004400: 6465 6620 5f73 335f 7363 616e 5f70 6169  def _s3_scan_pai
+00004410: 7273 2873 7263 5f75 726c 3a20 5061 7468  rs(src_url: Path
+00004420: 4c69 6b65 2c0a 2020 2020 2020 2020 2020  Like,.          
+00004430: 2020 2020 2020 2020 2064 7374 5f75 726c           dst_url
+00004440: 3a20 5061 7468 4c69 6b65 2920 2d3e 2049  : PathLike) -> I
+00004450: 7465 7261 746f 725b 5475 706c 655b 5061  terator[Tuple[Pa
+00004460: 7468 4c69 6b65 2c20 5061 7468 4c69 6b65  thLike, PathLike
+00004470: 5d5d 3a0a 2020 2020 666f 7220 7372 635f  ]]:.    for src_
+00004480: 6669 6c65 5f70 6174 6820 696e 2053 3350  file_path in S3P
+00004490: 6174 6828 7372 635f 7572 6c29 2e73 6361  ath(src_url).sca
+000044a0: 6e28 293a 0a20 2020 2020 2020 2063 6f6e  n():.        con
+000044b0: 7465 6e74 5f70 6174 6820 3d20 7372 635f  tent_path = src_
+000044c0: 6669 6c65 5f70 6174 685b 6c65 6e28 7372  file_path[len(sr
+000044d0: 635f 7572 6c29 3a5d 0a20 2020 2020 2020  c_url):].       
+000044e0: 2069 6620 6c65 6e28 636f 6e74 656e 745f   if len(content_
+000044f0: 7061 7468 2920 3e20 303a 0a20 2020 2020  path) > 0:.     
+00004500: 2020 2020 2020 2064 7374 5f66 696c 655f         dst_file_
+00004510: 7061 7468 203d 2073 335f 7061 7468 5f6a  path = s3_path_j
+00004520: 6f69 6e28 6473 745f 7572 6c2c 2063 6f6e  oin(dst_url, con
+00004530: 7465 6e74 5f70 6174 6829 0a20 2020 2020  tent_path).     
+00004540: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00004550: 2020 2020 2064 7374 5f66 696c 655f 7061       dst_file_pa
+00004560: 7468 203d 2064 7374 5f75 726c 0a20 2020  th = dst_url.   
+00004570: 2020 2020 2079 6965 6c64 2073 7263 5f66       yield src_f
+00004580: 696c 655f 7061 7468 2c20 6473 745f 6669  ile_path, dst_fi
+00004590: 6c65 5f70 6174 680a 0a0a 6465 6620 6973  le_path...def is
+000045a0: 5f73 3328 7061 7468 3a20 5061 7468 4c69  _s3(path: PathLi
+000045b0: 6b65 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ke) -> bool:.   
+000045c0: 2027 2727 0a20 2020 2031 2e20 4163 636f   '''.    1. Acco
+000045d0: 7264 696e 6720 746f 2060 6177 732d 636c  rding to `aws-cl
+000045e0: 6920 3c68 7474 7073 3a2f 2f64 6f63 732e  i <https://docs.
+000045f0: 6177 732e 616d 617a 6f6e 2e63 6f6d 2f63  aws.amazon.com/c
+00004600: 6c69 2f6c 6174 6573 742f 7265 6665 7265  li/latest/refere
+00004610: 6e63 652f 7333 2f69 6e64 6578 2e68 746d  nce/s3/index.htm
+00004620: 6c3e 605f 202c 2074 6573 7420 6966 2061  l>`_ , test if a
+00004630: 2070 6174 6820 6973 2073 3320 7061 7468   path is s3 path
+00004640: 2e0a 2020 2020 322e 206d 6567 6669 6c65  ..    2. megfile
+00004650: 2061 6c73 6f20 7375 7070 6f72 7420 7468   also support th
+00004660: 6520 7061 7468 206c 696b 6520 6073 335b  e path like `s3[
+00004670: 2b70 726f 6669 6c65 5f6e 616d 655d 3a2f  +profile_name]:/
+00004680: 2f62 7563 6b65 742f 6b65 7960 0a0a 2020  /bucket/key`..  
+00004690: 2020 3a70 6172 616d 2070 6174 683a 2050    :param path: P
+000046a0: 6174 6820 746f 2062 6520 7465 7374 6564  ath to be tested
+000046b0: 0a20 2020 203a 7265 7475 726e 733a 2054  .    :returns: T
+000046c0: 7275 6520 6966 2070 6174 6820 6973 2073  rue if path is s
+000046d0: 3320 7061 7468 2c20 656c 7365 2046 616c  3 path, else Fal
+000046e0: 7365 0a20 2020 2027 2727 0a20 2020 2070  se.    '''.    p
+000046f0: 6174 6820 3d20 6673 7061 7468 2870 6174  ath = fspath(pat
+00004700: 6829 0a20 2020 2069 6620 7265 2e6d 6174  h).    if re.mat
+00004710: 6368 2872 275e 7333 285c 2b5c 772b 293f  ch(r'^s3(\+\w+)?
+00004720: 3a5c 2f5c 2f27 2c20 7061 7468 293a 0a20  :\/\/', path):. 
+00004730: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00004740: 7565 0a20 2020 2072 6574 7572 6e20 4661  ue.    return Fa
+00004750: 6c73 650a 0a0a 6465 6620 5f73 335f 6269  lse...def _s3_bi
+00004760: 6e61 7279 5f6d 6f64 6528 7333 5f6f 7065  nary_mode(s3_ope
+00004770: 6e5f 6675 6e63 293a 0a0a 2020 2020 4077  n_func):..    @w
+00004780: 7261 7073 2873 335f 6f70 656e 5f66 756e  raps(s3_open_fun
+00004790: 6329 0a20 2020 2064 6566 2077 7261 7070  c).    def wrapp
+000047a0: 6572 2873 335f 7572 6c2c 206d 6f64 653a  er(s3_url, mode:
+000047b0: 2073 7472 203d 2027 7262 272c 202a 2a6b   str = 'rb', **k
+000047c0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+000047d0: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+000047e0: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
+000047f0: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+00004800: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
+00004810: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
+00004820: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+00004830: 7228 2745 6d70 7479 2062 7563 6b65 7420  r('Empty bucket 
+00004840: 6e61 6d65 3a20 2572 2720 2520 7333 5f75  name: %r' % s3_u
+00004850: 726c 290a 0a20 2020 2020 2020 2069 6620  rl)..        if 
+00004860: 6e6f 7420 6b65 7920 6f72 206b 6579 2e65  not key or key.e
+00004870: 6e64 7377 6974 6828 272f 2729 3a0a 2020  ndswith('/'):.  
+00004880: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00004890: 5333 4973 4144 6972 6563 746f 7279 4572  S3IsADirectoryEr
+000048a0: 726f 7228 2749 7320 6120 6469 7265 6374  ror('Is a direct
+000048b0: 6f72 793a 2025 7227 2025 2073 335f 7572  ory: %r' % s3_ur
+000048c0: 6c29 0a0a 2020 2020 2020 2020 6966 2027  l)..        if '
+000048d0: 7827 2069 6e20 6d6f 6465 3a0a 2020 2020  x' in mode:.    
+000048e0: 2020 2020 2020 2020 6966 2053 3350 6174          if S3Pat
+000048f0: 6828 7333 5f75 726c 292e 6973 5f66 696c  h(s3_url).is_fil
+00004900: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
+00004910: 2020 2020 2072 6169 7365 2053 3346 696c       raise S3Fil
+00004920: 6545 7869 7374 7345 7272 6f72 2827 4669  eExistsError('Fi
+00004930: 6c65 2065 7869 7374 733a 2025 7227 2025  le exists: %r' %
+00004940: 2073 335f 7572 6c29 0a20 2020 2020 2020   s3_url).       
+00004950: 2020 2020 206d 6f64 6520 3d20 6d6f 6465       mode = mode
+00004960: 2e72 6570 6c61 6365 2827 7827 2c20 2777  .replace('x', 'w
+00004970: 2729 0a0a 2020 2020 2020 2020 6966 2027  ')..        if '
+00004980: 7727 2069 6e20 6d6f 6465 206f 7220 2761  w' in mode or 'a
+00004990: 2720 696e 206d 6f64 653a 0a20 2020 2020  ' in mode:.     
+000049a0: 2020 2020 2020 2069 6620 6e6f 7420 5333         if not S3
+000049b0: 5061 7468 2873 335f 7572 6c29 2e68 6173  Path(s3_url).has
+000049c0: 6275 636b 6574 2829 3a0a 2020 2020 2020  bucket():.      
+000049d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000049e0: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+000049f0: 4572 726f 7228 274e 6f20 7375 6368 2062  Error('No such b
+00004a00: 7563 6b65 743a 2025 7227 2025 2073 335f  ucket: %r' % s3_
+00004a10: 7572 6c29 0a0a 2020 2020 2020 2020 6669  url)..        fi
+00004a20: 6c65 6f62 6a20 3d20 7333 5f6f 7065 6e5f  leobj = s3_open_
+00004a30: 6675 6e63 2873 335f 7572 6c2c 2067 6574  func(s3_url, get
+00004a40: 5f62 696e 6172 795f 6d6f 6465 286d 6f64  _binary_mode(mod
+00004a50: 6529 2c20 2a2a 6b77 6172 6773 290a 2020  e), **kwargs).  
+00004a60: 2020 2020 2020 6966 2027 6227 206e 6f74        if 'b' not
+00004a70: 2069 6e20 6d6f 6465 3a0a 2020 2020 2020   in mode:.      
+00004a80: 2020 2020 2020 6669 6c65 6f62 6a20 3d20        fileobj = 
+00004a90: 696f 2e54 6578 7449 4f57 7261 7070 6572  io.TextIOWrapper
+00004aa0: 2866 696c 656f 626a 2920 2023 2070 7974  (fileobj)  # pyt
+00004ab0: 7970 653a 2064 6973 6162 6c65 3d77 726f  ype: disable=wro
+00004ac0: 6e67 2d61 7267 2d74 7970 6573 0a20 2020  ng-arg-types.   
+00004ad0: 2020 2020 2020 2020 2066 696c 656f 626a           fileobj
+00004ae0: 2e6d 6f64 6520 3d20 6d6f 6465 0a20 2020  .mode = mode.   
+00004af0: 2020 2020 2072 6574 7572 6e20 6669 6c65       return file
+00004b00: 6f62 6a0a 0a20 2020 2072 6574 7572 6e20  obj..    return 
+00004b10: 7772 6170 7065 720a 0a0a 405f 7333 5f62  wrapper...@_s3_b
+00004b20: 696e 6172 795f 6d6f 6465 0a64 6566 2073  inary_mode.def s
+00004b30: 335f 7072 6566 6574 6368 5f6f 7065 6e28  3_prefetch_open(
+00004b40: 0a20 2020 2020 2020 2073 335f 7572 6c3a  .        s3_url:
+00004b50: 2050 6174 684c 696b 652c 0a20 2020 2020   PathLike,.     
+00004b60: 2020 206d 6f64 653a 2073 7472 203d 2027     mode: str = '
+00004b70: 7262 272c 0a20 2020 2020 2020 2066 6f6c  rb',.        fol
+00004b80: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
+00004b90: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
+00004ba0: 2a2c 0a20 2020 2020 2020 206d 6178 5f63  *,.        max_c
+00004bb0: 6f6e 6375 7272 656e 6379 3a20 4f70 7469  oncurrency: Opti
+00004bc0: 6f6e 616c 5b69 6e74 5d20 3d20 4e6f 6e65  onal[int] = None
+00004bd0: 2c0a 2020 2020 2020 2020 6d61 785f 626c  ,.        max_bl
+00004be0: 6f63 6b5f 7369 7a65 3a20 696e 7420 3d20  ock_size: int = 
+00004bf0: 4445 4641 554c 545f 424c 4f43 4b5f 5349  DEFAULT_BLOCK_SI
+00004c00: 5a45 2920 2d3e 2053 3350 7265 6665 7463  ZE) -> S3Prefetc
+00004c10: 6852 6561 6465 723a 0a20 2020 2027 2727  hReader:.    '''
+00004c20: 4f70 656e 2061 2061 7379 6e63 6872 6f6e  Open a asynchron
+00004c30: 6f75 7320 7072 6566 6574 6368 2072 6561  ous prefetch rea
+00004c40: 6465 722c 2074 6f20 7375 7070 6f72 7420  der, to support 
+00004c50: 6661 7374 2073 6571 7565 6e74 6961 6c20  fast sequential 
+00004c60: 7265 6164 2061 6e64 2072 616e 646f 6d20  read and random 
+00004c70: 7265 6164 0a0a 2020 2020 2e2e 206e 6f74  read..    .. not
+00004c80: 6520 3a3a 0a0a 2020 2020 2020 2020 5573  e ::..        Us
+00004c90: 6572 2073 686f 756c 6420 6d61 6b65 2073  er should make s
+00004ca0: 7572 6520 7468 6174 2072 6561 6465 7220  ure that reader 
+00004cb0: 2f20 7772 6974 6572 2061 7265 2063 6c6f  / writer are clo
+00004cc0: 7365 6420 636f 7272 6563 746c 790a 0a20  sed correctly.. 
+00004cd0: 2020 2020 2020 2053 7570 706f 7274 7320         Supports 
+00004ce0: 636f 6e74 6578 7420 6d61 6e61 6765 720a  context manager.
+00004cf0: 0a20 2020 2020 2020 2053 6f6d 6520 7061  .        Some pa
+00004d00: 7261 6d65 7465 7220 7365 7474 696e 6720  rameter setting 
+00004d10: 6d61 7920 7065 7266 6f72 6d20 7765 6c6c  may perform well
+00004d20: 3a20 6d61 785f 636f 6e63 7572 7265 6e63  : max_concurrenc
+00004d30: 793d 3130 206f 7220 3230 2c20 6d61 785f  y=10 or 20, max_
+00004d40: 626c 6f63 6b5f 7369 7a65 3d38 206f 7220  block_size=8 or 
+00004d50: 3136 204d 422c 2064 6566 6175 6c74 2076  16 MB, default v
+00004d60: 616c 7565 204e 6f6e 6520 6d65 616e 7320  alue None means 
+00004d70: 7573 696e 6720 676c 6f62 616c 2074 6872  using global thr
+00004d80: 6561 6420 706f 6f6c 0a0a 2020 2020 3a70  ead pool..    :p
+00004d90: 6172 616d 206d 6178 5f63 6f6e 6375 7272  aram max_concurr
+00004da0: 656e 6379 3a20 4d61 7820 646f 776e 6c6f  ency: Max downlo
+00004db0: 6164 2074 6872 6561 6420 6e75 6d62 6572  ad thread number
+00004dc0: 2c20 4e6f 6e65 2062 7920 6465 6661 756c  , None by defaul
+00004dd0: 740a 2020 2020 3a70 6172 616d 206d 6178  t.    :param max
+00004de0: 5f62 6c6f 636b 5f73 697a 653a 204d 6178  _block_size: Max
+00004df0: 2064 6174 6120 7369 7a65 2064 6f77 6e6c   data size downl
+00004e00: 6f61 6465 6420 6279 2065 6163 6820 7468  oaded by each th
+00004e10: 7265 6164 2c20 696e 2062 7974 6573 2c20  read, in bytes, 
+00004e20: 384d 4220 6279 2064 6566 6175 6c74 0a20  8MB by default. 
+00004e30: 2020 203a 7265 7475 726e 733a 2041 6e20     :returns: An 
+00004e40: 6f70 656e 6564 2053 3350 7265 6665 7463  opened S3Prefetc
+00004e50: 6852 6561 6465 7220 6f62 6a65 6374 0a20  hReader object. 
+00004e60: 2020 203a 7261 6973 6573 3a20 5333 4669     :raises: S3Fi
+00004e70: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
+00004e80: 2020 2020 2727 270a 2020 2020 6966 206d      '''.    if m
+00004e90: 6f64 6520 213d 2027 7262 273a 0a20 2020  ode != 'rb':.   
+00004ea0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00004eb0: 4572 726f 7228 2775 6e61 6363 6570 7461  Error('unaccepta
+00004ec0: 626c 6520 6d6f 6465 3a20 2572 2720 2520  ble mode: %r' % 
+00004ed0: 6d6f 6465 290a 2020 2020 7333 5f75 726c  mode).    s3_url
+00004ee0: 203d 2053 3350 6174 6828 7333 5f75 726c   = S3Path(s3_url
+00004ef0: 290a 2020 2020 6966 2066 6f6c 6c6f 776c  ).    if followl
+00004f00: 696e 6b73 3a0a 2020 2020 2020 2020 7472  inks:.        tr
+00004f10: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+00004f20: 335f 7572 6c20 3d20 7333 5f75 726c 2e72  3_url = s3_url.r
+00004f30: 6561 646c 696e 6b28 290a 2020 2020 2020  eadlink().      
+00004f40: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
+00004f50: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
+00004f60: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+00004f70: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+00004f80: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
+00004f90: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
+00004fa0: 6f63 6f6c 290a 2020 2020 636f 6e66 6967  ocol).    config
+00004fb0: 203d 2062 6f74 6f63 6f72 652e 636f 6e66   = botocore.conf
+00004fc0: 6967 2e43 6f6e 6669 6728 6d61 785f 706f  ig.Config(max_po
+00004fd0: 6f6c 5f63 6f6e 6e65 6374 696f 6e73 3d6d  ol_connections=m
+00004fe0: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
+00004ff0: 6f6e 7329 0a20 2020 2063 6c69 656e 7420  ons).    client 
+00005000: 3d20 6765 745f 7333 5f63 6c69 656e 7428  = get_s3_client(
+00005010: 0a20 2020 2020 2020 2063 6f6e 6669 673d  .        config=
+00005020: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
+00005030: 6361 6368 655f 6b65 793d 2773 335f 6669  cache_key='s3_fi
+00005040: 6c65 6c69 6b65 5f63 6c69 656e 7427 2c0a  lelike_client',.
+00005050: 2020 2020 2020 2020 7072 6f66 696c 655f          profile_
+00005060: 6e61 6d65 3d73 335f 7572 6c2e 5f70 726f  name=s3_url._pro
+00005070: 6669 6c65 5f6e 616d 6529 0a20 2020 2072  file_name).    r
+00005080: 6574 7572 6e20 5333 5072 6566 6574 6368  eturn S3Prefetch
+00005090: 5265 6164 6572 280a 2020 2020 2020 2020  Reader(.        
+000050a0: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+000050b0: 6b65 792c 0a20 2020 2020 2020 2073 335f  key,.        s3_
+000050c0: 636c 6965 6e74 3d63 6c69 656e 742c 0a20  client=client,. 
+000050d0: 2020 2020 2020 206d 6178 5f72 6574 7269         max_retri
+000050e0: 6573 3d6d 6178 5f72 6574 7269 6573 2c0a  es=max_retries,.
+000050f0: 2020 2020 2020 2020 6d61 785f 776f 726b          max_work
+00005100: 6572 733d 6d61 785f 636f 6e63 7572 7265  ers=max_concurre
+00005110: 6e63 792c 0a20 2020 2020 2020 2062 6c6f  ncy,.        blo
+00005120: 636b 5f73 697a 653d 6d61 785f 626c 6f63  ck_size=max_bloc
+00005130: 6b5f 7369 7a65 290a 0a0a 405f 7333 5f62  k_size)...@_s3_b
+00005140: 696e 6172 795f 6d6f 6465 0a64 6566 2073  inary_mode.def s
+00005150: 335f 7368 6172 655f 6361 6368 655f 6f70  3_share_cache_op
+00005160: 656e 280a 2020 2020 2020 2020 7333 5f75  en(.        s3_u
+00005170: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
+00005180: 2020 2020 2020 6d6f 6465 3a20 7374 7220        mode: str 
+00005190: 3d20 2772 6227 2c0a 2020 2020 2020 2020  = 'rb',.        
+000051a0: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
+000051b0: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+000051c0: 2020 202a 2c0a 2020 2020 2020 2020 6361     *,.        ca
+000051d0: 6368 655f 6b65 793a 2073 7472 203d 2027  che_key: str = '
+000051e0: 6c72 7527 2c0a 2020 2020 2020 2020 6d61  lru',.        ma
+000051f0: 785f 636f 6e63 7572 7265 6e63 793a 204f  x_concurrency: O
+00005200: 7074 696f 6e61 6c5b 696e 745d 203d 204e  ptional[int] = N
+00005210: 6f6e 652c 0a20 2020 2020 2020 206d 6178  one,.        max
+00005220: 5f62 6c6f 636b 5f73 697a 653a 2069 6e74  _block_size: int
+00005230: 203d 2044 4546 4155 4c54 5f42 4c4f 434b   = DEFAULT_BLOCK
+00005240: 5f53 495a 4529 202d 3e20 5333 5368 6172  _SIZE) -> S3Shar
+00005250: 6543 6163 6865 5265 6164 6572 3a0a 2020  eCacheReader:.  
+00005260: 2020 2727 274f 7065 6e20 6120 6173 796e    '''Open a asyn
+00005270: 6368 726f 6e6f 7573 2070 7265 6665 7463  chronous prefetc
+00005280: 6820 7265 6164 6572 2c20 746f 2073 7570  h reader, to sup
+00005290: 706f 7274 2066 6173 7420 7365 7175 656e  port fast sequen
+000052a0: 7469 616c 2072 6561 6420 616e 6420 7261  tial read and ra
+000052b0: 6e64 6f6d 2072 6561 640a 0a20 2020 202e  ndom read..    .
+000052c0: 2e20 6e6f 7465 203a 3a0a 0a20 2020 2020  . note ::..     
+000052d0: 2020 2055 7365 7220 7368 6f75 6c64 206d     User should m
+000052e0: 616b 6520 7375 7265 2074 6861 7420 7265  ake sure that re
+000052f0: 6164 6572 202f 2077 7269 7465 7220 6172  ader / writer ar
+00005300: 6520 636c 6f73 6564 2063 6f72 7265 6374  e closed correct
+00005310: 6c79 0a0a 2020 2020 2020 2020 5375 7070  ly..        Supp
+00005320: 6f72 7473 2063 6f6e 7465 7874 206d 616e  orts context man
+00005330: 6167 6572 0a0a 2020 2020 2020 2020 536f  ager..        So
+00005340: 6d65 2070 6172 616d 6574 6572 2073 6574  me parameter set
+00005350: 7469 6e67 206d 6179 2070 6572 666f 726d  ting may perform
+00005360: 2077 656c 6c3a 206d 6178 5f63 6f6e 6375   well: max_concu
+00005370: 7272 656e 6379 3d31 3020 6f72 2032 302c  rrency=10 or 20,
+00005380: 206d 6178 5f62 6c6f 636b 5f73 697a 653d   max_block_size=
+00005390: 3820 6f72 2031 3620 4d42 2c20 6465 6661  8 or 16 MB, defa
+000053a0: 756c 7420 7661 6c75 6520 4e6f 6e65 206d  ult value None m
+000053b0: 6561 6e73 2075 7369 6e67 2067 6c6f 6261  eans using globa
+000053c0: 6c20 7468 7265 6164 2070 6f6f 6c0a 0a20  l thread pool.. 
+000053d0: 2020 203a 7061 7261 6d20 6d61 785f 636f     :param max_co
+000053e0: 6e63 7572 7265 6e63 793a 204d 6178 2064  ncurrency: Max d
+000053f0: 6f77 6e6c 6f61 6420 7468 7265 6164 206e  ownload thread n
+00005400: 756d 6265 722c 204e 6f6e 6520 6279 2064  umber, None by d
+00005410: 6566 6175 6c74 0a20 2020 203a 7061 7261  efault.    :para
+00005420: 6d20 6d61 785f 626c 6f63 6b5f 7369 7a65  m max_block_size
+00005430: 3a20 4d61 7820 6461 7461 2073 697a 6520  : Max data size 
+00005440: 646f 776e 6c6f 6164 6564 2062 7920 6561  downloaded by ea
+00005450: 6368 2074 6872 6561 642c 2069 6e20 6279  ch thread, in by
+00005460: 7465 732c 2038 4d42 2062 7920 6465 6661  tes, 8MB by defa
+00005470: 756c 740a 2020 2020 3a72 6574 7572 6e73  ult.    :returns
+00005480: 3a20 416e 206f 7065 6e65 6420 5333 5368  : An opened S3Sh
+00005490: 6172 6543 6163 6865 5265 6164 6572 206f  areCacheReader o
+000054a0: 626a 6563 740a 2020 2020 3a72 6169 7365  bject.    :raise
+000054b0: 733a 2053 3346 696c 654e 6f74 466f 756e  s: S3FileNotFoun
+000054c0: 6445 7272 6f72 0a20 2020 2027 2727 0a20  dError.    '''. 
+000054d0: 2020 2069 6620 6d6f 6465 2021 3d20 2772     if mode != 'r
+000054e0: 6227 3a0a 2020 2020 2020 2020 7261 6973  b':.        rais
+000054f0: 6520 5661 6c75 6545 7272 6f72 2827 756e  e ValueError('un
+00005500: 6163 6365 7074 6162 6c65 206d 6f64 653a  acceptable mode:
+00005510: 2025 7227 2025 206d 6f64 6529 0a0a 2020   %r' % mode)..  
+00005520: 2020 7333 5f75 726c 203d 2053 3350 6174    s3_url = S3Pat
+00005530: 6828 7333 5f75 726c 290a 2020 2020 6966  h(s3_url).    if
+00005540: 2066 6f6c 6c6f 776c 696e 6b73 3a0a 2020   followlinks:.  
+00005550: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00005560: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
+00005570: 7333 5f75 726c 2e72 6561 646c 696e 6b28  s3_url.readlink(
+00005580: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00005590: 2053 334e 6f74 414c 696e 6b45 7272 6f72   S3NotALinkError
+000055a0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+000055b0: 7373 0a0a 2020 2020 6275 636b 6574 2c20  ss..    bucket, 
+000055c0: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
+000055d0: 726c 2873 335f 7572 6c2e 7061 7468 5f77  rl(s3_url.path_w
+000055e0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+000055f0: 2020 636f 6e66 6967 203d 2062 6f74 6f63    config = botoc
+00005600: 6f72 652e 636f 6e66 6967 2e43 6f6e 6669  ore.config.Confi
+00005610: 6728 6d61 785f 706f 6f6c 5f63 6f6e 6e65  g(max_pool_conne
+00005620: 6374 696f 6e73 3d6d 6178 5f70 6f6f 6c5f  ctions=max_pool_
+00005630: 636f 6e6e 6563 7469 6f6e 7329 0a20 2020  connections).   
+00005640: 2063 6c69 656e 7420 3d20 6765 745f 7333   client = get_s3
+00005650: 5f63 6c69 656e 7428 0a20 2020 2020 2020  _client(.       
+00005660: 2063 6f6e 6669 673d 636f 6e66 6967 2c0a   config=config,.
+00005670: 2020 2020 2020 2020 6361 6368 655f 6b65          cache_ke
+00005680: 793d 2773 335f 6669 6c65 6c69 6b65 5f63  y='s3_filelike_c
+00005690: 6c69 656e 7427 2c0a 2020 2020 2020 2020  lient',.        
+000056a0: 7072 6f66 696c 655f 6e61 6d65 3d73 335f  profile_name=s3_
+000056b0: 7572 6c2e 5f70 726f 6669 6c65 5f6e 616d  url._profile_nam
+000056c0: 6529 0a20 2020 2072 6574 7572 6e20 5333  e).    return S3
+000056d0: 5368 6172 6543 6163 6865 5265 6164 6572  ShareCacheReader
+000056e0: 280a 2020 2020 2020 2020 6275 636b 6574  (.        bucket
+000056f0: 2c0a 2020 2020 2020 2020 6b65 792c 0a20  ,.        key,. 
+00005700: 2020 2020 2020 2063 6163 6865 5f6b 6579         cache_key
+00005710: 3d63 6163 6865 5f6b 6579 2c0a 2020 2020  =cache_key,.    
+00005720: 2020 2020 7333 5f63 6c69 656e 743d 636c      s3_client=cl
+00005730: 6965 6e74 2c0a 2020 2020 2020 2020 6d61  ient,.        ma
+00005740: 785f 7265 7472 6965 733d 6d61 785f 7265  x_retries=max_re
+00005750: 7472 6965 732c 0a20 2020 2020 2020 206d  tries,.        m
+00005760: 6178 5f77 6f72 6b65 7273 3d6d 6178 5f63  ax_workers=max_c
+00005770: 6f6e 6375 7272 656e 6379 2c0a 2020 2020  oncurrency,.    
+00005780: 2020 2020 626c 6f63 6b5f 7369 7a65 3d6d      block_size=m
+00005790: 6178 5f62 6c6f 636b 5f73 697a 6529 0a0a  ax_block_size)..
+000057a0: 0a40 5f73 335f 6269 6e61 7279 5f6d 6f64  .@_s3_binary_mod
+000057b0: 650a 6465 6620 7333 5f70 6970 655f 6f70  e.def s3_pipe_op
+000057c0: 656e 280a 2020 2020 2020 2020 7333 5f75  en(.        s3_u
+000057d0: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
+000057e0: 2020 2020 2020 6d6f 6465 3a20 7374 722c        mode: str,
+000057f0: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
+00005800: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+00005810: 7365 2c0a 2020 2020 2020 2020 2a2c 0a20  se,.        *,. 
+00005820: 2020 2020 2020 206a 6f69 6e5f 7468 7265         join_thre
+00005830: 6164 3a20 626f 6f6c 203d 2054 7275 6529  ad: bool = True)
+00005840: 202d 3e20 5333 5069 7065 4861 6e64 6c65   -> S3PipeHandle
+00005850: 723a 0a20 2020 2027 2727 4f70 656e 2061  r:.    '''Open a
+00005860: 2061 7379 6e63 6872 6f6e 6f75 7320 7265   asynchronous re
+00005870: 6164 2d77 7269 7465 2072 6561 6465 7220  ad-write reader 
+00005880: 2f20 7772 6974 6572 2c20 746f 2073 7570  / writer, to sup
+00005890: 706f 7274 2066 6173 7420 7365 7175 656e  port fast sequen
+000058a0: 7469 616c 2072 6561 6420 2f20 7772 6974  tial read / writ
+000058b0: 650a 0a20 2020 202e 2e20 6e6f 7465 203a  e..    .. note :
+000058c0: 3a0a 0a20 2020 2020 2020 2055 7365 7220  :..        User 
+000058d0: 7368 6f75 6c64 206d 616b 6520 7375 7265  should make sure
+000058e0: 2074 6861 7420 7265 6164 6572 202f 2077   that reader / w
+000058f0: 7269 7465 7220 6172 6520 636c 6f73 6564  riter are closed
+00005900: 2063 6f72 7265 6374 6c79 0a0a 2020 2020   correctly..    
+00005910: 2020 2020 5375 7070 6f72 7473 2063 6f6e      Supports con
+00005920: 7465 7874 206d 616e 6167 6572 0a0a 2020  text manager..  
+00005930: 2020 2020 2020 5768 656e 206a 6f69 6e5f        When join_
+00005940: 7468 7265 6164 2069 7320 4661 6c73 652c  thread is False,
+00005950: 2077 6869 6c65 2074 6865 2066 696c 6520   while the file 
+00005960: 6861 6e64 6c65 2061 7265 2063 6c6f 7369  handle are closi
+00005970: 6e67 2c20 7468 6973 2066 756e 6374 696f  ng, this functio
+00005980: 6e20 7769 6c6c 206e 6f74 2077 6169 7420  n will not wait 
+00005990: 756e 7469 6c20 7468 6520 6173 796e 6368  until the asynch
+000059a0: 726f 6e6f 7573 2077 7269 7469 6e67 2066  ronous writing f
+000059b0: 696e 6973 6865 733b 0a20 2020 2020 2020  inishes;.       
+000059c0: 2046 616c 7365 2064 6f65 736e 2774 2061   False doesn't a
+000059d0: 6666 6563 7420 7265 6164 2d68 616e 646c  ffect read-handl
+000059e0: 652c 2062 7574 2074 6869 7320 6361 6e20  e, but this can 
+000059f0: 7370 6565 6420 7570 2077 7269 7465 2d68  speed up write-h
+00005a00: 616e 646c 6520 6265 6361 7573 6520 6669  andle because fi
+00005a10: 6c65 2077 696c 6c20 6265 2077 7269 7474  le will be writt
+00005a20: 656e 2061 7379 6e63 6872 6f6e 6f75 736c  en asynchronousl
+00005a30: 792e 0a20 2020 2020 2020 2042 7574 2061  y..        But a
+00005a40: 7379 6e63 6872 6f6e 6f75 7320 6265 6861  synchronous beha
+00005a50: 7669 6f75 7220 6361 6e20 6775 6172 616e  viour can guaran
+00005a60: 7465 6520 7468 6520 6669 6c65 2061 7265  tee the file are
+00005a70: 2073 7563 6365 7373 6675 6c6c 7920 7772   successfully wr
+00005a80: 6974 7465 6e2c 2061 6e64 2066 7265 7175  itten, and frequ
+00005a90: 656e 7420 6578 6563 7574 696f 6e20 6d61  ent execution ma
+00005aa0: 7920 6361 7573 6520 7468 7265 6164 2061  y cause thread a
+00005ab0: 6e64 2066 696c 6520 6861 6e64 6c65 2065  nd file handle e
+00005ac0: 7868 6175 7374 696f 6e0a 0a20 2020 203a  xhaustion..    :
+00005ad0: 7061 7261 6d20 6d6f 6465 3a20 4d6f 6465  param mode: Mode
+00005ae0: 2074 6f20 6f70 656e 2066 696c 652c 2065   to open file, e
+00005af0: 6974 6865 7220 2272 6222 206f 7220 2277  ither "rb" or "w
+00005b00: 6222 0a20 2020 203a 7061 7261 6d20 6a6f  b".    :param jo
+00005b10: 696e 5f74 6872 6561 643a 2049 6620 7761  in_thread: If wa
+00005b20: 6974 2061 6674 6572 2066 756e 6374 696f  it after functio
+00005b30: 6e20 6578 6563 7574 696f 6e20 756e 7469  n execution unti
+00005b40: 6c20 7333 2066 696e 6973 6865 7320 7772  l s3 finishes wr
+00005b50: 6974 696e 670a 2020 2020 3a72 6574 7572  iting.    :retur
+00005b60: 6e73 3a20 416e 206f 7065 6e65 6420 4275  ns: An opened Bu
+00005b70: 6666 6572 6564 5265 6164 6572 202f 2042  fferedReader / B
+00005b80: 7566 6665 7265 6457 7269 7465 7220 6f62  ufferedWriter ob
+00005b90: 6a65 6374 0a20 2020 2027 2727 0a20 2020  ject.    '''.   
+00005ba0: 2069 6620 6d6f 6465 206e 6f74 2069 6e20   if mode not in 
+00005bb0: 2827 7262 272c 2027 7762 2729 3a0a 2020  ('rb', 'wb'):.  
+00005bc0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00005bd0: 6545 7272 6f72 2827 756e 6163 6365 7074  eError('unaccept
+00005be0: 6162 6c65 206d 6f64 653a 2025 7227 2025  able mode: %r' %
+00005bf0: 206d 6f64 6529 0a0a 2020 2020 6966 206d   mode)..    if m
+00005c00: 6f64 655b 305d 203d 3d20 2772 2720 616e  ode[0] == 'r' an
+00005c10: 6420 6e6f 7420 5333 5061 7468 2873 335f  d not S3Path(s3_
+00005c20: 7572 6c29 2e69 735f 6669 6c65 2829 3a0a  url).is_file():.
+00005c30: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+00005c40: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+00005c50: 7228 274e 6f20 7375 6368 2066 696c 653a  r('No such file:
+00005c60: 2025 7227 2025 2073 335f 7572 6c29 0a0a   %r' % s3_url)..
+00005c70: 2020 2020 7333 5f75 726c 203d 2053 3350      s3_url = S3P
+00005c80: 6174 6828 7333 5f75 726c 290a 2020 2020  ath(s3_url).    
+00005c90: 6966 2066 6f6c 6c6f 776c 696e 6b73 3a0a  if followlinks:.
+00005ca0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00005cb0: 2020 2020 2020 2020 2073 335f 7572 6c20           s3_url 
+00005cc0: 3d20 7333 5f75 726c 2e72 6561 646c 696e  = s3_url.readlin
+00005cd0: 6b28 290a 2020 2020 2020 2020 6578 6365  k().        exce
+00005ce0: 7074 2053 334e 6f74 414c 696e 6b45 7272  pt S3NotALinkErr
+00005cf0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00005d00: 7061 7373 0a0a 2020 2020 6275 636b 6574  pass..    bucket
+00005d10: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
+00005d20: 5f75 726c 2873 335f 7572 6c2e 7061 7468  _url(s3_url.path
+00005d30: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+00005d40: 2020 2020 636f 6e66 6967 203d 2062 6f74      config = bot
+00005d50: 6f63 6f72 652e 636f 6e66 6967 2e43 6f6e  ocore.config.Con
+00005d60: 6669 6728 6d61 785f 706f 6f6c 5f63 6f6e  fig(max_pool_con
+00005d70: 6e65 6374 696f 6e73 3d6d 6178 5f70 6f6f  nections=max_poo
+00005d80: 6c5f 636f 6e6e 6563 7469 6f6e 7329 0a20  l_connections). 
+00005d90: 2020 2063 6c69 656e 7420 3d20 6765 745f     client = get_
+00005da0: 7333 5f63 6c69 656e 7428 0a20 2020 2020  s3_client(.     
+00005db0: 2020 2063 6f6e 6669 673d 636f 6e66 6967     config=config
+00005dc0: 2c0a 2020 2020 2020 2020 6361 6368 655f  ,.        cache_
+00005dd0: 6b65 793d 2773 335f 6669 6c65 6c69 6b65  key='s3_filelike
+00005de0: 5f63 6c69 656e 7427 2c0a 2020 2020 2020  _client',.      
+00005df0: 2020 7072 6f66 696c 655f 6e61 6d65 3d73    profile_name=s
+00005e00: 335f 7572 6c2e 5f70 726f 6669 6c65 5f6e  3_url._profile_n
+00005e10: 616d 6529 0a20 2020 2072 6574 7572 6e20  ame).    return 
+00005e20: 5333 5069 7065 4861 6e64 6c65 7228 0a20  S3PipeHandler(. 
+00005e30: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
+00005e40: 6579 2c20 6d6f 6465 2c20 7333 5f63 6c69  ey, mode, s3_cli
+00005e50: 656e 743d 636c 6965 6e74 2c20 6a6f 696e  ent=client, join
+00005e60: 5f74 6872 6561 643d 6a6f 696e 5f74 6872  _thread=join_thr
+00005e70: 6561 6429 0a0a 0a40 5f73 335f 6269 6e61  ead)...@_s3_bina
+00005e80: 7279 5f6d 6f64 650a 6465 6620 7333 5f63  ry_mode.def s3_c
+00005e90: 6163 6865 645f 6f70 656e 280a 2020 2020  ached_open(.    
+00005ea0: 2020 2020 7333 5f75 726c 3a20 5061 7468      s3_url: Path
+00005eb0: 4c69 6b65 2c0a 2020 2020 2020 2020 6d6f  Like,.        mo
+00005ec0: 6465 3a20 7374 722c 0a20 2020 2020 2020  de: str,.       
+00005ed0: 2066 6f6c 6c6f 776c 696e 6b73 3a20 626f   followlinks: bo
+00005ee0: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00005ef0: 2020 2020 2a2c 0a20 2020 2020 2020 2063      *,.        c
+00005f00: 6163 6865 5f70 6174 683a 204f 7074 696f  ache_path: Optio
+00005f10: 6e61 6c5b 7374 725d 203d 204e 6f6e 6529  nal[str] = None)
+00005f20: 202d 3e20 5333 4361 6368 6564 4861 6e64   -> S3CachedHand
+00005f30: 6c65 723a 0a20 2020 2027 2727 4f70 656e  ler:.    '''Open
+00005f40: 2061 206c 6f63 616c 2d63 6163 6865 2066   a local-cache f
+00005f50: 696c 6520 7265 6164 6572 202f 2077 7269  ile reader / wri
+00005f60: 7465 722c 2066 6f72 2066 7265 7175 656e  ter, for frequen
+00005f70: 7420 7261 6e64 6f6d 2072 6561 6420 2f20  t random read / 
+00005f80: 7772 6974 650a 0a20 2020 202e 2e20 6e6f  write..    .. no
+00005f90: 7465 203a 3a0a 0a20 2020 2020 2020 2055  te ::..        U
+00005fa0: 7365 7220 7368 6f75 6c64 206d 616b 6520  ser should make 
+00005fb0: 7375 7265 2074 6861 7420 7265 6164 6572  sure that reader
+00005fc0: 202f 2077 7269 7465 7220 6172 6520 636c   / writer are cl
+00005fd0: 6f73 6564 2063 6f72 7265 6374 6c79 0a0a  osed correctly..
+00005fe0: 2020 2020 2020 2020 5375 7070 6f72 7473          Supports
+00005ff0: 2063 6f6e 7465 7874 206d 616e 6167 6572   context manager
+00006000: 0a0a 2020 2020 2020 2020 6361 6368 655f  ..        cache_
+00006010: 7061 7468 2063 616e 2073 7065 6369 6679  path can specify
+00006020: 2074 6865 2070 6174 6820 6f66 2063 6163   the path of cac
+00006030: 6865 2066 696c 652e 2050 6572 666f 726d  he file. Perform
+00006040: 616e 6365 2063 6f75 6c64 2062 6520 6265  ance could be be
+00006050: 7474 6572 2069 6620 6361 6368 6520 6669  tter if cache fi
+00006060: 6c65 2070 6174 6820 6973 206f 6e20 7373  le path is on ss
+00006070: 6420 6f72 2074 6d70 6673 0a0a 2020 2020  d or tmpfs..    
+00006080: 3a70 6172 616d 206d 6f64 653a 204d 6f64  :param mode: Mod
+00006090: 6520 746f 206f 7065 6e20 6669 6c65 2c20  e to open file, 
+000060a0: 636f 756c 6420 6265 206f 6e65 206f 6620  could be one of 
+000060b0: 2272 6222 2c20 2277 6222 206f 7220 2261  "rb", "wb" or "a
+000060c0: 6222 0a20 2020 203a 7061 7261 6d20 6361  b".    :param ca
+000060d0: 6368 655f 7061 7468 3a20 6361 6368 6520  che_path: cache 
+000060e0: 6669 6c65 2070 6174 680a 2020 2020 3a72  file path.    :r
+000060f0: 6574 7572 6e73 3a20 416e 206f 7065 6e65  eturns: An opene
+00006100: 6420 4275 6666 6572 6564 5265 6164 6572  d BufferedReader
+00006110: 202f 2042 7566 6665 7265 6457 7269 7465   / BufferedWrite
+00006120: 7220 6f62 6a65 6374 0a20 2020 2027 2727  r object.    '''
+00006130: 0a20 2020 2069 6620 6d6f 6465 206e 6f74  .    if mode not
+00006140: 2069 6e20 2827 7262 272c 2027 7762 272c   in ('rb', 'wb',
+00006150: 2027 6162 272c 2027 7262 2b27 2c20 2777   'ab', 'rb+', 'w
+00006160: 622b 272c 2027 6162 2b27 293a 0a20 2020  b+', 'ab+'):.   
+00006170: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00006180: 4572 726f 7228 2775 6e61 6363 6570 7461  Error('unaccepta
+00006190: 626c 6520 6d6f 6465 3a20 2572 2720 2520  ble mode: %r' % 
+000061a0: 6d6f 6465 290a 2020 2020 7333 5f75 726c  mode).    s3_url
+000061b0: 203d 2053 3350 6174 6828 7333 5f75 726c   = S3Path(s3_url
+000061c0: 290a 2020 2020 6966 2066 6f6c 6c6f 776c  ).    if followl
+000061d0: 696e 6b73 3a0a 2020 2020 2020 2020 7472  inks:.        tr
+000061e0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+000061f0: 335f 7572 6c20 3d20 7333 5f75 726c 2e72  3_url = s3_url.r
+00006200: 6561 646c 696e 6b28 290a 2020 2020 2020  eadlink().      
+00006210: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
+00006220: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
+00006230: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+00006240: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
+00006250: 7273 655f 7333 5f75 726c 2873 335f 7572  rse_s3_url(s3_ur
+00006260: 6c2e 7061 7468 5f77 6974 685f 7072 6f74  l.path_with_prot
+00006270: 6f63 6f6c 290a 2020 2020 636f 6e66 6967  ocol).    config
+00006280: 203d 2062 6f74 6f63 6f72 652e 636f 6e66   = botocore.conf
+00006290: 6967 2e43 6f6e 6669 6728 6d61 785f 706f  ig.Config(max_po
+000062a0: 6f6c 5f63 6f6e 6e65 6374 696f 6e73 3d6d  ol_connections=m
+000062b0: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
+000062c0: 6f6e 7329 0a20 2020 2063 6c69 656e 7420  ons).    client 
+000062d0: 3d20 6765 745f 7333 5f63 6c69 656e 7428  = get_s3_client(
+000062e0: 0a20 2020 2020 2020 2063 6f6e 6669 673d  .        config=
+000062f0: 636f 6e66 6967 2c0a 2020 2020 2020 2020  config,.        
+00006300: 6361 6368 655f 6b65 793d 2773 335f 6669  cache_key='s3_fi
+00006310: 6c65 6c69 6b65 5f63 6c69 656e 7427 2c0a  lelike_client',.
+00006320: 2020 2020 2020 2020 7072 6f66 696c 655f          profile_
+00006330: 6e61 6d65 3d73 335f 7572 6c2e 5f70 726f  name=s3_url._pro
+00006340: 6669 6c65 5f6e 616d 6529 0a20 2020 2072  file_name).    r
+00006350: 6574 7572 6e20 5333 4361 6368 6564 4861  eturn S3CachedHa
+00006360: 6e64 6c65 7228 0a20 2020 2020 2020 2062  ndler(.        b
+00006370: 7563 6b65 742c 206b 6579 2c20 6d6f 6465  ucket, key, mode
+00006380: 2c20 7333 5f63 6c69 656e 743d 636c 6965  , s3_client=clie
+00006390: 6e74 2c20 6361 6368 655f 7061 7468 3d63  nt, cache_path=c
+000063a0: 6163 6865 5f70 6174 6829 0a0a 0a40 5f73  ache_path)...@_s
+000063b0: 335f 6269 6e61 7279 5f6d 6f64 650a 6465  3_binary_mode.de
+000063c0: 6620 7333 5f62 7566 6665 7265 645f 6f70  f s3_buffered_op
+000063d0: 656e 280a 2020 2020 2020 2020 7333 5f75  en(.        s3_u
+000063e0: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
+000063f0: 2020 2020 2020 6d6f 6465 3a20 7374 722c        mode: str,
+00006400: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
+00006410: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+00006420: 7365 2c0a 2020 2020 2020 2020 2a2c 0a20  se,.        *,. 
+00006430: 2020 2020 2020 206d 6178 5f63 6f6e 6375         max_concu
+00006440: 7272 656e 6379 3a20 4f70 7469 6f6e 616c  rrency: Optional
+00006450: 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a 2020  [int] = None,.  
+00006460: 2020 2020 2020 6d61 785f 6275 6666 6572        max_buffer
+00006470: 5f73 697a 653a 2069 6e74 203d 2044 4546  _size: int = DEF
+00006480: 4155 4c54 5f4d 4158 5f42 5546 4645 525f  AULT_MAX_BUFFER_
+00006490: 5349 5a45 2c0a 2020 2020 2020 2020 666f  SIZE,.        fo
+000064a0: 7277 6172 645f 7261 7469 6f3a 204f 7074  rward_ratio: Opt
+000064b0: 696f 6e61 6c5b 666c 6f61 745d 203d 204e  ional[float] = N
+000064c0: 6f6e 652c 0a20 2020 2020 2020 2062 6c6f  one,.        blo
+000064d0: 636b 5f73 697a 653a 2069 6e74 203d 2044  ck_size: int = D
+000064e0: 4546 4155 4c54 5f42 4c4f 434b 5f53 495a  EFAULT_BLOCK_SIZ
+000064f0: 452c 0a20 2020 2020 2020 206c 696d 6974  E,.        limit
+00006500: 6564 5f73 6565 6b61 626c 653a 2062 6f6f  ed_seekable: boo
+00006510: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+00006520: 2020 2062 7566 6665 7265 643a 2062 6f6f     buffered: boo
+00006530: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+00006540: 2020 7368 6172 655f 6361 6368 655f 6b65    share_cache_ke
+00006550: 793a 204f 7074 696f 6e61 6c5b 7374 725d  y: Optional[str]
+00006560: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00006570: 2063 6163 6865 5f70 6174 683a 204f 7074   cache_path: Opt
+00006580: 696f 6e61 6c5b 7374 725d 203d 204e 6f6e  ional[str] = Non
+00006590: 650a 2920 2d3e 2055 6e69 6f6e 5b53 3350  e.) -> Union[S3P
+000065a0: 7265 6665 7463 6852 6561 6465 722c 2053  refetchReader, S
+000065b0: 3342 7566 6665 7265 6457 7269 7465 722c  3BufferedWriter,
+000065c0: 2069 6f2e 4275 6666 6572 6564 5265 6164   io.BufferedRead
+000065d0: 6572 2c20 696f 2e0a 2020 2020 2020 2020  er, io..        
+000065e0: 2020 2042 7566 6665 7265 6457 7269 7465     BufferedWrite
+000065f0: 722c 2053 334d 656d 6f72 7948 616e 646c  r, S3MemoryHandl
+00006600: 6572 5d3a 0a20 2020 2027 2727 4f70 656e  er]:.    '''Open
+00006610: 2061 6e20 6173 796e 6368 726f 6e6f 7573   an asynchronous
+00006620: 2070 7265 6665 7463 6820 7265 6164 6572   prefetch reader
+00006630: 2c20 746f 2073 7570 706f 7274 2066 6173  , to support fas
+00006640: 7420 7365 7175 656e 7469 616c 2072 6561  t sequential rea
+00006650: 640a 0a20 2020 202e 2e20 6e6f 7465 203a  d..    .. note :
+00006660: 3a0a 0a20 2020 2020 2020 2055 7365 7220  :..        User 
+00006670: 7368 6f75 6c64 206d 616b 6520 7375 7265  should make sure
+00006680: 2074 6861 7420 7265 6164 6572 202f 2077   that reader / w
+00006690: 7269 7465 7220 6172 6520 636c 6f73 6564  riter are closed
+000066a0: 2063 6f72 7265 6374 6c79 0a0a 2020 2020   correctly..    
+000066b0: 2020 2020 5375 7070 6f72 7473 2063 6f6e      Supports con
+000066c0: 7465 7874 206d 616e 6167 6572 0a0a 2020  text manager..  
+000066d0: 2020 2020 2020 536f 6d65 2070 6172 616d        Some param
+000066e0: 6574 6572 2073 6574 7469 6e67 206d 6179  eter setting may
+000066f0: 2070 6572 666f 726d 2077 656c 6c3a 206d   perform well: m
+00006700: 6178 5f63 6f6e 6375 7272 656e 6379 3d31  ax_concurrency=1
+00006710: 3020 6f72 2032 302c 206d 6178 5f62 6c6f  0 or 20, max_blo
+00006720: 636b 5f73 697a 653d 3820 6f72 2031 3620  ck_size=8 or 16 
+00006730: 4d42 2c20 6465 6661 756c 7420 7661 6c75  MB, default valu
+00006740: 6520 4e6f 6e65 206d 6561 6e73 2075 7369  e None means usi
+00006750: 6e67 2067 6c6f 6261 6c20 7468 7265 6164  ng global thread
+00006760: 2070 6f6f 6c0a 0a20 2020 203a 7061 7261   pool..    :para
+00006770: 6d20 6d61 785f 636f 6e63 7572 7265 6e63  m max_concurrenc
+00006780: 793a 204d 6178 2064 6f77 6e6c 6f61 6420  y: Max download 
+00006790: 7468 7265 6164 206e 756d 6265 722c 204e  thread number, N
+000067a0: 6f6e 6520 6279 2064 6566 6175 6c74 0a20  one by default. 
+000067b0: 2020 203a 7061 7261 6d20 6d61 785f 6275     :param max_bu
+000067c0: 6666 6572 5f73 697a 653a 204d 6178 2063  ffer_size: Max c
+000067d0: 6163 6865 6420 6275 6666 6572 2073 697a  ached buffer siz
+000067e0: 6520 696e 206d 656d 6f72 792c 2031 3238  e in memory, 128
+000067f0: 4d42 2062 7920 6465 6661 756c 740a 2020  MB by default.  
+00006800: 2020 3a70 6172 616d 2062 6c6f 636b 5f73    :param block_s
+00006810: 697a 653a 2053 697a 6520 6f66 2073 696e  ize: Size of sin
+00006820: 676c 6520 626c 6f63 6b2c 2038 4d42 2062  gle block, 8MB b
+00006830: 7920 6465 6661 756c 742e 2045 6163 6820  y default. Each 
+00006840: 626c 6f63 6b20 7769 6c6c 2062 6520 7570  block will be up
+00006850: 6c6f 6164 6564 206f 7220 646f 776e 6c6f  loaded or downlo
+00006860: 6164 6564 2062 7920 7369 6e67 6c65 2074  aded by single t
+00006870: 6872 6561 642e 0a20 2020 203a 7061 7261  hread..    :para
+00006880: 6d20 6c69 6d69 7465 645f 7365 656b 6162  m limited_seekab
+00006890: 6c65 3a20 4966 2077 7269 7465 2d68 616e  le: If write-han
+000068a0: 646c 6520 7375 7070 6f72 7473 206c 696d  dle supports lim
+000068b0: 6974 6564 2073 6565 6b20 2862 6f74 6820  ited seek (both 
+000068c0: 6669 6c65 2068 6561 6420 7061 7274 2061  file head part a
+000068d0: 6e64 2074 6169 6c20 7061 7274 2063 616e  nd tail part can
+000068e0: 2073 6565 6b20 626c 6f63 6b5f 7369 7a65   seek block_size
+000068f0: 292e 204e 6f74 6573 3a20 5468 6973 2070  ). Notes: This p
+00006900: 6172 616d 6574 6572 2061 7265 2076 616c  arameter are val
+00006910: 6964 206f 6e6c 7920 666f 7220 7772 6974  id only for writ
+00006920: 652d 6861 6e64 6c65 2e20 5265 6164 2d68  e-handle. Read-h
+00006930: 616e 646c 6520 7375 7070 6f72 7420 6172  andle support ar
+00006940: 6269 7472 6172 7920 7365 656b 0a20 2020  bitrary seek.   
+00006950: 203a 7265 7475 726e 733a 2041 6e20 6f70   :returns: An op
+00006960: 656e 6564 2053 3350 7265 6665 7463 6852  ened S3PrefetchR
+00006970: 6561 6465 7220 6f62 6a65 6374 0a20 2020  eader object.   
+00006980: 203a 7261 6973 6573 3a20 5333 4669 6c65   :raises: S3File
+00006990: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
+000069a0: 2020 2727 270a 2020 2020 6966 206d 6f64    '''.    if mod
+000069b0: 6520 6e6f 7420 696e 2028 2772 6227 2c20  e not in ('rb', 
+000069c0: 2777 6227 2c20 2761 6227 2c20 2772 622b  'wb', 'ab', 'rb+
+000069d0: 272c 2027 7762 2b27 2c20 2761 622b 2729  ', 'wb+', 'ab+')
+000069e0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+000069f0: 5661 6c75 6545 7272 6f72 2827 756e 6163  ValueError('unac
+00006a00: 6365 7074 6162 6c65 206d 6f64 653a 2025  ceptable mode: %
+00006a10: 7227 2025 206d 6f64 6529 0a20 2020 2073  r' % mode).    s
+00006a20: 335f 7572 6c20 3d20 5333 5061 7468 2873  3_url = S3Path(s
+00006a30: 335f 7572 6c29 0a20 2020 2069 6620 666f  3_url).    if fo
+00006a40: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
+00006a50: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00006a60: 2020 2020 7333 5f75 726c 203d 2073 335f      s3_url = s3_
+00006a70: 7572 6c2e 7265 6164 6c69 6e6b 2829 0a20  url.readlink(). 
+00006a80: 2020 2020 2020 2065 7863 6570 7420 5333         except S3
+00006a90: 4e6f 7441 4c69 6e6b 4572 726f 723a 0a20  NotALinkError:. 
+00006aa0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00006ab0: 0a20 2020 2062 7563 6b65 742c 206b 6579  .    bucket, key
+00006ac0: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
+00006ad0: 7333 5f75 726c 2e70 6174 685f 7769 7468  s3_url.path_with
+00006ae0: 5f70 726f 746f 636f 6c29 0a20 2020 2063  _protocol).    c
+00006af0: 6f6e 6669 6720 3d20 626f 746f 636f 7265  onfig = botocore
+00006b00: 2e63 6f6e 6669 672e 436f 6e66 6967 286d  .config.Config(m
+00006b10: 6178 5f70 6f6f 6c5f 636f 6e6e 6563 7469  ax_pool_connecti
+00006b20: 6f6e 733d 6d61 785f 706f 6f6c 5f63 6f6e  ons=max_pool_con
+00006b30: 6e65 6374 696f 6e73 290a 2020 2020 636c  nections).    cl
+00006b40: 6965 6e74 203d 2067 6574 5f73 335f 636c  ient = get_s3_cl
+00006b50: 6965 6e74 280a 2020 2020 2020 2020 636f  ient(.        co
+00006b60: 6e66 6967 3d63 6f6e 6669 672c 0a20 2020  nfig=config,.   
+00006b70: 2020 2020 2063 6163 6865 5f6b 6579 3d27       cache_key='
+00006b80: 7333 5f66 696c 656c 696b 655f 636c 6965  s3_filelike_clie
+00006b90: 6e74 272c 0a20 2020 2020 2020 2070 726f  nt',.        pro
+00006ba0: 6669 6c65 5f6e 616d 653d 7333 5f75 726c  file_name=s3_url
+00006bb0: 2e5f 7072 6f66 696c 655f 6e61 6d65 290a  ._profile_name).
+00006bc0: 0a20 2020 2069 6620 2761 2720 696e 206d  .    if 'a' in m
+00006bd0: 6f64 6520 6f72 2027 2b27 2069 6e20 6d6f  ode or '+' in mo
+00006be0: 6465 3a0a 2020 2020 2020 2020 6966 2063  de:.        if c
+00006bf0: 6163 6865 5f70 6174 6820 6973 204e 6f6e  ache_path is Non
+00006c00: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00006c10: 6574 7572 6e20 5333 4d65 6d6f 7279 4861  eturn S3MemoryHa
+00006c20: 6e64 6c65 7228 6275 636b 6574 2c20 6b65  ndler(bucket, ke
+00006c30: 792c 206d 6f64 652c 2073 335f 636c 6965  y, mode, s3_clie
+00006c40: 6e74 3d63 6c69 656e 7429 0a20 2020 2020  nt=client).     
+00006c50: 2020 2072 6574 7572 6e20 5333 4361 6368     return S3Cach
+00006c60: 6564 4861 6e64 6c65 7228 0a20 2020 2020  edHandler(.     
+00006c70: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
+00006c80: 6579 2c20 6d6f 6465 2c20 7333 5f63 6c69  ey, mode, s3_cli
+00006c90: 656e 743d 636c 6965 6e74 2c20 6361 6368  ent=client, cach
+00006ca0: 655f 7061 7468 3d63 6163 6865 5f70 6174  e_path=cache_pat
+00006cb0: 6829 0a0a 2020 2020 6966 206d 6f64 6520  h)..    if mode 
+00006cc0: 3d3d 2027 7262 273a 0a20 2020 2020 2020  == 'rb':.       
+00006cd0: 2023 2041 2072 6f75 6768 2063 6f6e 7665   # A rough conve
+00006ce0: 7273 696f 6e20 616c 676f 7269 7468 6d20  rsion algorithm 
+00006cf0: 746f 2061 6c69 676e 2032 2074 7970 6573  to align 2 types
+00006d00: 206f 6620 5265 6164 6572 202f 2057 7269   of Reader / Wri
+00006d10: 7465 7220 7061 7261 6d65 7465 7273 0a20  ter parameters. 
+00006d20: 2020 2020 2020 2023 2054 4f44 4f3a 204f         # TODO: O
+00006d30: 7074 696d 697a 6520 7468 6520 636f 6e76  ptimize the conv
+00006d40: 6572 7369 6f6e 2061 6c67 6f72 6974 686d  ersion algorithm
+00006d50: 0a20 2020 2020 2020 2062 6c6f 636b 5f63  .        block_c
+00006d60: 6170 6163 6974 7920 3d20 6d61 785f 6275  apacity = max_bu
+00006d70: 6666 6572 5f73 697a 6520 2f2f 2062 6c6f  ffer_size // blo
+00006d80: 636b 5f73 697a 650a 2020 2020 2020 2020  ck_size.        
+00006d90: 6966 2066 6f72 7761 7264 5f72 6174 696f  if forward_ratio
+00006da0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00006db0: 2020 2020 2020 626c 6f63 6b5f 666f 7277        block_forw
+00006dc0: 6172 6420 3d20 4e6f 6e65 0a20 2020 2020  ard = None.     
+00006dd0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00006de0: 2020 2020 2062 6c6f 636b 5f66 6f72 7761       block_forwa
+00006df0: 7264 203d 206d 6178 2869 6e74 2862 6c6f  rd = max(int(blo
+00006e00: 636b 5f63 6170 6163 6974 7920 2a20 666f  ck_capacity * fo
+00006e10: 7277 6172 645f 7261 7469 6f29 2c20 3129  rward_ratio), 1)
+00006e20: 0a20 2020 2020 2020 2069 6620 7368 6172  .        if shar
+00006e30: 655f 6361 6368 655f 6b65 7920 6973 206e  e_cache_key is n
+00006e40: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00006e50: 2020 2020 2072 6561 6465 7220 3d20 5333       reader = S3
+00006e60: 5368 6172 6543 6163 6865 5265 6164 6572  ShareCacheReader
+00006e70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006e80: 2020 6275 636b 6574 2c0a 2020 2020 2020    bucket,.      
+00006e90: 2020 2020 2020 2020 2020 6b65 792c 0a20            key,. 
+00006ea0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00006eb0: 6163 6865 5f6b 6579 3d73 6861 7265 5f63  ache_key=share_c
+00006ec0: 6163 6865 5f6b 6579 2c0a 2020 2020 2020  ache_key,.      
+00006ed0: 2020 2020 2020 2020 2020 7333 5f63 6c69            s3_cli
+00006ee0: 656e 743d 636c 6965 6e74 2c0a 2020 2020  ent=client,.    
+00006ef0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+00006f00: 7265 7472 6965 733d 6d61 785f 7265 7472  retries=max_retr
+00006f10: 6965 732c 0a20 2020 2020 2020 2020 2020  ies,.           
+00006f20: 2020 2020 206d 6178 5f77 6f72 6b65 7273       max_workers
+00006f30: 3d6d 6178 5f63 6f6e 6375 7272 656e 6379  =max_concurrency
+00006f40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006f50: 2020 626c 6f63 6b5f 7369 7a65 3d62 6c6f    block_size=blo
+00006f60: 636b 5f73 697a 652c 0a20 2020 2020 2020  ck_size,.       
+00006f70: 2020 2020 2020 2020 2062 6c6f 636b 5f66           block_f
+00006f80: 6f72 7761 7264 3d62 6c6f 636b 5f66 6f72  orward=block_for
+00006f90: 7761 7264 290a 2020 2020 2020 2020 656c  ward).        el
+00006fa0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00006fb0: 7265 6164 6572 203d 2053 3350 7265 6665  reader = S3Prefe
+00006fc0: 7463 6852 6561 6465 7228 0a20 2020 2020  tchReader(.     
+00006fd0: 2020 2020 2020 2020 2020 2062 7563 6b65             bucke
+00006fe0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00006ff0: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
+00007000: 2020 2020 2020 2020 7333 5f63 6c69 656e          s3_clien
+00007010: 743d 636c 6965 6e74 2c0a 2020 2020 2020  t=client,.      
+00007020: 2020 2020 2020 2020 2020 6d61 785f 7265            max_re
+00007030: 7472 6965 733d 6d61 785f 7265 7472 6965  tries=max_retrie
+00007040: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00007050: 2020 206d 6178 5f77 6f72 6b65 7273 3d6d     max_workers=m
+00007060: 6178 5f63 6f6e 6375 7272 656e 6379 2c0a  ax_concurrency,.
+00007070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007080: 626c 6f63 6b5f 6361 7061 6369 7479 3d62  block_capacity=b
+00007090: 6c6f 636b 5f63 6170 6163 6974 792c 0a20  lock_capacity,. 
+000070a0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000070b0: 6c6f 636b 5f66 6f72 7761 7264 3d62 6c6f  lock_forward=blo
+000070c0: 636b 5f66 6f72 7761 7264 2c0a 2020 2020  ck_forward,.    
+000070d0: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
+000070e0: 6b5f 7369 7a65 3d62 6c6f 636b 5f73 697a  k_size=block_siz
+000070f0: 6529 0a20 2020 2020 2020 2069 6620 6275  e).        if bu
+00007100: 6666 6572 6564 3a0a 2020 2020 2020 2020  ffered:.        
+00007110: 2020 2020 7265 6164 6572 203d 2069 6f2e      reader = io.
+00007120: 4275 6666 6572 6564 5265 6164 6572 2872  BufferedReader(r
+00007130: 6561 6465 7229 2020 2320 7079 7479 7065  eader)  # pytype
+00007140: 3a20 6469 7361 626c 653d 7772 6f6e 672d  : disable=wrong-
+00007150: 6172 672d 7479 7065 730a 2020 2020 2020  arg-types.      
+00007160: 2020 7265 7475 726e 2072 6561 6465 720a    return reader.
+00007170: 0a20 2020 2069 6620 6c69 6d69 7465 645f  .    if limited_
+00007180: 7365 656b 6162 6c65 3a0a 2020 2020 2020  seekable:.      
+00007190: 2020 7772 6974 6572 203d 2053 334c 696d    writer = S3Lim
+000071a0: 6974 6564 5365 656b 6162 6c65 5772 6974  itedSeekableWrit
+000071b0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+000071c0: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+000071d0: 2020 2020 6b65 792c 0a20 2020 2020 2020      key,.       
+000071e0: 2020 2020 2073 335f 636c 6965 6e74 3d63       s3_client=c
+000071f0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
+00007200: 2020 206d 6178 5f77 6f72 6b65 7273 3d6d     max_workers=m
+00007210: 6178 5f63 6f6e 6375 7272 656e 6379 2c0a  ax_concurrency,.
+00007220: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+00007230: 6275 6666 6572 5f73 697a 653d 6d61 785f  buffer_size=max_
+00007240: 6275 6666 6572 5f73 697a 652c 0a20 2020  buffer_size,.   
+00007250: 2020 2020 2020 2020 2062 6c6f 636b 5f73           block_s
+00007260: 697a 653d 626c 6f63 6b5f 7369 7a65 290a  ize=block_size).
+00007270: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00007280: 2020 7772 6974 6572 203d 2053 3342 7566    writer = S3Buf
+00007290: 6665 7265 6457 7269 7465 7228 0a20 2020  feredWriter(.   
+000072a0: 2020 2020 2020 2020 2062 7563 6b65 742c           bucket,
+000072b0: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+000072c0: 2c0a 2020 2020 2020 2020 2020 2020 7333  ,.            s3
+000072d0: 5f63 6c69 656e 743d 636c 6965 6e74 2c0a  _client=client,.
+000072e0: 2020 2020 2020 2020 2020 2020 6d61 785f              max_
+000072f0: 776f 726b 6572 733d 6d61 785f 636f 6e63  workers=max_conc
+00007300: 7572 7265 6e63 792c 0a20 2020 2020 2020  urrency,.       
+00007310: 2020 2020 206d 6178 5f62 7566 6665 725f       max_buffer_
+00007320: 7369 7a65 3d6d 6178 5f62 7566 6665 725f  size=max_buffer_
+00007330: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+00007340: 2020 626c 6f63 6b5f 7369 7a65 3d62 6c6f    block_size=blo
+00007350: 636b 5f73 697a 6529 0a20 2020 2069 6620  ck_size).    if 
+00007360: 6275 6666 6572 6564 3a0a 2020 2020 2020  buffered:.      
+00007370: 2020 7772 6974 6572 203d 2069 6f2e 4275    writer = io.Bu
+00007380: 6666 6572 6564 5772 6974 6572 2877 7269  fferedWriter(wri
+00007390: 7465 7229 2020 2320 7079 7479 7065 3a20  ter)  # pytype: 
+000073a0: 6469 7361 626c 653d 7772 6f6e 672d 6172  disable=wrong-ar
+000073b0: 672d 7479 7065 730a 2020 2020 7265 7475  g-types.    retu
+000073c0: 726e 2077 7269 7465 720a 0a0a 405f 7333  rn writer...@_s3
+000073d0: 5f62 696e 6172 795f 6d6f 6465 0a64 6566  _binary_mode.def
+000073e0: 2073 335f 6d65 6d6f 7279 5f6f 7065 6e28   s3_memory_open(
+000073f0: 0a20 2020 2020 2020 2073 335f 7572 6c3a  .        s3_url:
+00007400: 2050 6174 684c 696b 652c 206d 6f64 653a   PathLike, mode:
+00007410: 2073 7472 2c0a 2020 2020 2020 2020 666f   str,.        fo
+00007420: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+00007430: 3d20 4661 6c73 6529 202d 3e20 5333 4d65  = False) -> S3Me
+00007440: 6d6f 7279 4861 6e64 6c65 723a 0a20 2020  moryHandler:.   
+00007450: 2027 2727 4f70 656e 2061 206d 656d 6f72   '''Open a memor
+00007460: 792d 6361 6368 6520 6669 6c65 2072 6561  y-cache file rea
+00007470: 6465 7220 2f20 7772 6974 6572 2c20 666f  der / writer, fo
+00007480: 7220 6672 6571 7565 6e74 2072 616e 646f  r frequent rando
+00007490: 6d20 7265 6164 202f 2077 7269 7465 0a0a  m read / write..
+000074a0: 2020 2020 2e2e 206e 6f74 6520 3a3a 0a0a      .. note ::..
+000074b0: 2020 2020 2020 2020 5573 6572 2073 686f          User sho
+000074c0: 756c 6420 6d61 6b65 2073 7572 6520 7468  uld make sure th
+000074d0: 6174 2072 6561 6465 7220 2f20 7772 6974  at reader / writ
+000074e0: 6572 2061 7265 2063 6c6f 7365 6420 636f  er are closed co
+000074f0: 7272 6563 746c 790a 0a20 2020 2020 2020  rrectly..       
+00007500: 2053 7570 706f 7274 7320 636f 6e74 6578   Supports contex
+00007510: 7420 6d61 6e61 6765 720a 0a20 2020 203a  t manager..    :
+00007520: 7061 7261 6d20 6d6f 6465 3a20 4d6f 6465  param mode: Mode
+00007530: 2074 6f20 6f70 656e 2066 696c 652c 2063   to open file, c
+00007540: 6f75 6c64 2062 6520 6f6e 6520 6f66 2022  ould be one of "
+00007550: 7262 222c 2022 7762 222c 2022 6162 222c  rb", "wb", "ab",
+00007560: 2022 7262 2b22 2c20 2277 622b 2220 6f72   "rb+", "wb+" or
+00007570: 2022 6162 2b22 0a20 2020 203a 7265 7475   "ab+".    :retu
+00007580: 726e 733a 2041 6e20 6f70 656e 6564 2042  rns: An opened B
+00007590: 7566 6665 7265 6452 6561 6465 7220 2f20  ufferedReader / 
+000075a0: 4275 6666 6572 6564 5772 6974 6572 206f  BufferedWriter o
+000075b0: 626a 6563 740a 2020 2020 2727 270a 2020  bject.    '''.  
+000075c0: 2020 6966 206d 6f64 6520 6e6f 7420 696e    if mode not in
+000075d0: 2028 2772 6227 2c20 2777 6227 2c20 2761   ('rb', 'wb', 'a
+000075e0: 6227 2c20 2772 622b 272c 2027 7762 2b27  b', 'rb+', 'wb+'
+000075f0: 2c20 2761 622b 2729 3a0a 2020 2020 2020  , 'ab+'):.      
+00007600: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00007610: 6f72 2827 756e 6163 6365 7074 6162 6c65  or('unacceptable
+00007620: 206d 6f64 653a 2025 7227 2025 206d 6f64   mode: %r' % mod
+00007630: 6529 0a20 2020 2073 335f 7572 6c20 3d20  e).    s3_url = 
+00007640: 5333 5061 7468 2873 335f 7572 6c29 0a20  S3Path(s3_url). 
+00007650: 2020 2069 6620 666f 6c6c 6f77 6c69 6e6b     if followlink
+00007660: 733a 0a20 2020 2020 2020 2074 7279 3a0a  s:.        try:.
+00007670: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
+00007680: 726c 203d 2073 335f 7572 6c2e 7265 6164  rl = s3_url.read
+00007690: 6c69 6e6b 2829 0a20 2020 2020 2020 2065  link().        e
+000076a0: 7863 6570 7420 5333 4e6f 7441 4c69 6e6b  xcept S3NotALink
+000076b0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+000076c0: 2020 2070 6173 730a 0a20 2020 2062 7563     pass..    buc
+000076d0: 6b65 742c 206b 6579 203d 2070 6172 7365  ket, key = parse
+000076e0: 5f73 335f 7572 6c28 7333 5f75 726c 2e70  _s3_url(s3_url.p
+000076f0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00007700: 6c29 0a20 2020 2063 6f6e 6669 6720 3d20  l).    config = 
+00007710: 626f 746f 636f 7265 2e63 6f6e 6669 672e  botocore.config.
+00007720: 436f 6e66 6967 286d 6178 5f70 6f6f 6c5f  Config(max_pool_
+00007730: 636f 6e6e 6563 7469 6f6e 733d 6d61 785f  connections=max_
+00007740: 706f 6f6c 5f63 6f6e 6e65 6374 696f 6e73  pool_connections
+00007750: 290a 2020 2020 636c 6965 6e74 203d 2067  ).    client = g
+00007760: 6574 5f73 335f 636c 6965 6e74 280a 2020  et_s3_client(.  
+00007770: 2020 2020 2020 636f 6e66 6967 3d63 6f6e        config=con
+00007780: 6669 672c 0a20 2020 2020 2020 2063 6163  fig,.        cac
+00007790: 6865 5f6b 6579 3d27 7333 5f66 696c 656c  he_key='s3_filel
+000077a0: 696b 655f 636c 6965 6e74 272c 0a20 2020  ike_client',.   
+000077b0: 2020 2020 2070 726f 6669 6c65 5f6e 616d       profile_nam
+000077c0: 653d 7333 5f75 726c 2e5f 7072 6f66 696c  e=s3_url._profil
+000077d0: 655f 6e61 6d65 290a 2020 2020 7265 7475  e_name).    retu
+000077e0: 726e 2053 334d 656d 6f72 7948 616e 646c  rn S3MemoryHandl
+000077f0: 6572 2862 7563 6b65 742c 206b 6579 2c20  er(bucket, key, 
+00007800: 6d6f 6465 2c20 7333 5f63 6c69 656e 743d  mode, s3_client=
+00007810: 636c 6965 6e74 290a 0a0a 7333 5f6f 7065  client)...s3_ope
+00007820: 6e20 3d20 7333 5f62 7566 6665 7265 645f  n = s3_buffered_
+00007830: 6f70 656e 0a0a 0a64 6566 2073 335f 646f  open...def s3_do
+00007840: 776e 6c6f 6164 280a 2020 2020 2020 2020  wnload(.        
+00007850: 7372 635f 7572 6c3a 2050 6174 684c 696b  src_url: PathLik
+00007860: 652c 0a20 2020 2020 2020 2064 7374 5f75  e,.        dst_u
+00007870: 726c 3a20 5061 7468 4c69 6b65 2c0a 2020  rl: PathLike,.  
+00007880: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
+00007890: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
+000078a0: 0a20 2020 2020 2020 2063 616c 6c62 6163  .        callbac
+000078b0: 6b3a 204f 7074 696f 6e61 6c5b 4361 6c6c  k: Optional[Call
+000078c0: 6162 6c65 5b5b 696e 745d 2c20 4e6f 6e65  able[[int], None
+000078d0: 5d5d 203d 204e 6f6e 6529 202d 3e20 4e6f  ]] = None) -> No
+000078e0: 6e65 3a0a 2020 2020 2727 270a 2020 2020  ne:.    '''.    
+000078f0: 446f 776e 6c6f 6164 7320 6120 6669 6c65  Downloads a file
+00007900: 2066 726f 6d20 7333 2074 6f20 6c6f 6361   from s3 to loca
+00007910: 6c20 6669 6c65 7379 7374 656d 2e0a 2020  l filesystem..  
+00007920: 2020 3a70 6172 616d 2073 7263 5f75 726c    :param src_url
+00007930: 3a20 736f 7572 6365 2073 3320 7061 7468  : source s3 path
+00007940: 0a20 2020 203a 7061 7261 6d20 6473 745f  .    :param dst_
+00007950: 7572 6c3a 2074 6172 6765 7420 6673 2070  url: target fs p
+00007960: 6174 680a 2020 2020 3a70 6172 616d 2063  ath.    :param c
+00007970: 616c 6c62 6163 6b3a 2043 616c 6c65 6420  allback: Called 
+00007980: 7065 7269 6f64 6963 616c 6c79 2064 7572  periodically dur
+00007990: 696e 6720 636f 7079 2c20 616e 6420 7468  ing copy, and th
+000079a0: 6520 696e 7075 7420 7061 7261 6d65 7465  e input paramete
+000079b0: 7220 6973 2074 6865 2064 6174 6120 7369  r is the data si
+000079c0: 7a65 2028 696e 2062 7974 6573 2920 6f66  ze (in bytes) of
+000079d0: 2063 6f70 7920 7369 6e63 6520 7468 6520   copy since the 
+000079e0: 6c61 7374 2063 616c 6c0a 2020 2020 2727  last call.    ''
+000079f0: 270a 2020 2020 7372 635f 7572 6c20 3d20  '.    src_url = 
+00007a00: 5333 5061 7468 2873 7263 5f75 726c 290a  S3Path(src_url).
+00007a10: 2020 2020 6966 2066 6f6c 6c6f 776c 696e      if followlin
+00007a20: 6b73 3a0a 2020 2020 2020 2020 7472 793a  ks:.        try:
+00007a30: 0a20 2020 2020 2020 2020 2020 2073 7263  .            src
+00007a40: 5f75 726c 203d 2073 7263 5f75 726c 2e72  _url = src_url.r
+00007a50: 6561 646c 696e 6b28 290a 2020 2020 2020  eadlink().      
+00007a60: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
+00007a70: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
+00007a80: 2020 2020 2020 7061 7373 0a20 2020 2073        pass.    s
+00007a90: 7263 5f62 7563 6b65 742c 2073 7263 5f6b  rc_bucket, src_k
+00007aa0: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
+00007ab0: 6c28 7372 635f 7572 6c2e 7061 7468 5f77  l(src_url.path_w
+00007ac0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+00007ad0: 2020 6966 206e 6f74 2073 7263 5f62 7563    if not src_buc
+00007ae0: 6b65 743a 0a20 2020 2020 2020 2072 6169  ket:.        rai
+00007af0: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
+00007b00: 756e 6445 7272 6f72 280a 2020 2020 2020  undError(.      
+00007b10: 2020 2020 2020 2745 6d70 7479 2062 7563        'Empty buc
+00007b20: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
+00007b30: 7372 635f 7572 6c2e 7061 7468 5f77 6974  src_url.path_wit
+00007b40: 685f 7072 6f74 6f63 6f6c 290a 0a20 2020  h_protocol)..   
+00007b50: 2069 6620 6e6f 7420 7372 635f 7572 6c2e   if not src_url.
+00007b60: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
+00007b70: 2020 7261 6973 6520 5333 4669 6c65 4e6f    raise S3FileNo
+00007b80: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
+00007b90: 2020 2020 2020 2020 2027 4669 6c65 206e           'File n
+00007ba0: 6f74 2066 6f75 6e64 3a20 2572 2720 2520  ot found: %r' % 
+00007bb0: 7372 635f 7572 6c2e 7061 7468 5f77 6974  src_url.path_wit
+00007bc0: 685f 7072 6f74 6f63 6f6c 290a 0a20 2020  h_protocol)..   
+00007bd0: 2069 6620 6e6f 7420 7372 635f 7572 6c2e   if not src_url.
+00007be0: 6973 5f66 696c 6528 293a 0a20 2020 2020  is_file():.     
+00007bf0: 2020 2072 6169 7365 2053 3349 7341 4469     raise S3IsADi
+00007c00: 7265 6374 6f72 7945 7272 6f72 280a 2020  rectoryError(.  
+00007c10: 2020 2020 2020 2020 2020 2749 7320 6120            'Is a 
+00007c20: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
+00007c30: 2073 7263 5f75 726c 2e70 6174 685f 7769   src_url.path_wi
+00007c40: 7468 5f70 726f 746f 636f 6c29 0a0a 2020  th_protocol)..  
+00007c50: 2020 6473 745f 7572 6c20 3d20 6673 7061    dst_url = fspa
+00007c60: 7468 2864 7374 5f75 726c 290a 2020 2020  th(dst_url).    
+00007c70: 6966 206e 6f74 2064 7374 5f75 726c 206f  if not dst_url o
+00007c80: 7220 6473 745f 7572 6c2e 656e 6473 7769  r dst_url.endswi
+00007c90: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
+00007ca0: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
+00007cb0: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
+00007cc0: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
+00007cd0: 2520 6473 745f 7572 6c29 0a0a 2020 2020  % dst_url)..    
+00007ce0: 6473 745f 6469 7265 6374 6f72 7920 3d20  dst_directory = 
+00007cf0: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
+00007d00: 6473 745f 7572 6c29 0a20 2020 2069 6620  dst_url).    if 
+00007d10: 6473 745f 6469 7265 6374 6f72 7920 213d  dst_directory !=
+00007d20: 2027 273a 0a20 2020 2020 2020 206f 732e   '':.        os.
+00007d30: 6d61 6b65 6469 7273 2864 7374 5f64 6972  makedirs(dst_dir
+00007d40: 6563 746f 7279 2c20 6578 6973 745f 6f6b  ectory, exist_ok
+00007d50: 3d54 7275 6529 0a0a 2020 2020 636c 6965  =True)..    clie
+00007d60: 6e74 203d 2067 6574 5f73 335f 636c 6965  nt = get_s3_clie
+00007d70: 6e74 2870 726f 6669 6c65 5f6e 616d 653d  nt(profile_name=
+00007d80: 7372 635f 7572 6c2e 5f70 726f 6669 6c65  src_url._profile
+00007d90: 5f6e 616d 6529 0a20 2020 2074 7279 3a0a  _name).    try:.
+00007da0: 2020 2020 2020 2020 636c 6965 6e74 2e64          client.d
+00007db0: 6f77 6e6c 6f61 645f 6669 6c65 2873 7263  ownload_file(src
+00007dc0: 5f62 7563 6b65 742c 2073 7263 5f6b 6579  _bucket, src_key
+00007dd0: 2c20 6473 745f 7572 6c2c 2043 616c 6c62  , dst_url, Callb
+00007de0: 6163 6b3d 6361 6c6c 6261 636b 290a 2020  ack=callback).  
+00007df0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+00007e00: 6f6e 2061 7320 6572 726f 723a 2020 2320  on as error:  # 
+00007e10: 7072 6167 6d61 3a20 6e6f 2063 6f76 6572  pragma: no cover
+00007e20: 0a20 2020 2020 2020 2065 7272 6f72 203d  .        error =
+00007e30: 2074 7261 6e73 6c61 7465 5f66 735f 6572   translate_fs_er
+00007e40: 726f 7228 6572 726f 722c 2064 7374 5f75  ror(error, dst_u
+00007e50: 726c 290a 2020 2020 2020 2020 6572 726f  rl).        erro
+00007e60: 7220 3d20 7472 616e 736c 6174 655f 7333  r = translate_s3
+00007e70: 5f65 7272 6f72 2865 7272 6f72 2c20 7372  _error(error, sr
+00007e80: 635f 7572 6c2e 7061 7468 5f77 6974 685f  c_url.path_with_
+00007e90: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+00007ea0: 2020 7261 6973 6520 6572 726f 720a 0a20    raise error.. 
+00007eb0: 2020 2073 7263 5f73 7461 7420 3d20 7372     src_stat = sr
+00007ec0: 635f 7572 6c2e 7374 6174 2829 0a20 2020  c_url.stat().   
+00007ed0: 206f 732e 7574 696d 6528 6473 745f 7572   os.utime(dst_ur
+00007ee0: 6c2c 2028 7372 635f 7374 6174 2e73 745f  l, (src_stat.st_
+00007ef0: 6d74 696d 652c 2073 7263 5f73 7461 742e  mtime, src_stat.
+00007f00: 7374 5f6d 7469 6d65 2929 0a0a 0a64 6566  st_mtime))...def
+00007f10: 2073 335f 7570 6c6f 6164 280a 2020 2020   s3_upload(.    
+00007f20: 2020 2020 7372 635f 7572 6c3a 2050 6174      src_url: Pat
+00007f30: 684c 696b 652c 0a20 2020 2020 2020 2064  hLike,.        d
+00007f40: 7374 5f75 726c 3a20 5061 7468 4c69 6b65  st_url: PathLike
+00007f50: 2c0a 2020 2020 2020 2020 6361 6c6c 6261  ,.        callba
+00007f60: 636b 3a20 4f70 7469 6f6e 616c 5b43 616c  ck: Optional[Cal
+00007f70: 6c61 626c 655b 5b69 6e74 5d2c 204e 6f6e  lable[[int], Non
+00007f80: 655d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  e]] = None,.    
+00007f90: 2020 2020 2a2a 6b77 6172 6773 2920 2d3e      **kwargs) ->
+00007fa0: 204e 6f6e 653a 0a20 2020 2027 2727 0a20   None:.    '''. 
+00007fb0: 2020 2055 706c 6f61 6473 2061 2066 696c     Uploads a fil
+00007fc0: 6520 6672 6f6d 206c 6f63 616c 2066 696c  e from local fil
+00007fd0: 6573 7973 7465 6d20 746f 2073 332e 0a20  esystem to s3.. 
+00007fe0: 2020 203a 7061 7261 6d20 7372 635f 7572     :param src_ur
+00007ff0: 6c3a 2073 6f75 7263 6520 6673 2070 6174  l: source fs pat
+00008000: 680a 2020 2020 3a70 6172 616d 2064 7374  h.    :param dst
+00008010: 5f75 726c 3a20 7461 7267 6574 2073 3320  _url: target s3 
+00008020: 7061 7468 0a20 2020 203a 7061 7261 6d20  path.    :param 
+00008030: 6361 6c6c 6261 636b 3a20 4361 6c6c 6564  callback: Called
+00008040: 2070 6572 696f 6469 6361 6c6c 7920 6475   periodically du
+00008050: 7269 6e67 2063 6f70 792c 2061 6e64 2074  ring copy, and t
+00008060: 6865 2069 6e70 7574 2070 6172 616d 6574  he input paramet
+00008070: 6572 2069 7320 7468 6520 6461 7461 2073  er is the data s
+00008080: 697a 6520 2869 6e20 6279 7465 7329 206f  ize (in bytes) o
+00008090: 6620 636f 7079 2073 696e 6365 2074 6865  f copy since the
+000080a0: 206c 6173 7420 6361 6c6c 0a20 2020 2027   last call.    '
+000080b0: 2727 0a20 2020 2064 7374 5f62 7563 6b65  ''.    dst_bucke
+000080c0: 742c 2064 7374 5f6b 6579 203d 2070 6172  t, dst_key = par
+000080d0: 7365 5f73 335f 7572 6c28 6473 745f 7572  se_s3_url(dst_ur
+000080e0: 6c29 0a20 2020 2069 6620 6e6f 7420 6473  l).    if not ds
+000080f0: 745f 6275 636b 6574 3a0a 2020 2020 2020  t_bucket:.      
+00008100: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
+00008110: 4e6f 7446 6f75 6e64 4572 726f 7228 2745  NotFoundError('E
+00008120: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
+00008130: 3a20 2572 2720 2520 6473 745f 7572 6c29  : %r' % dst_url)
+00008140: 0a20 2020 2069 6620 6e6f 7420 6473 745f  .    if not dst_
+00008150: 6b65 7920 6f72 2064 7374 5f6b 6579 2e65  key or dst_key.e
+00008160: 6e64 7377 6974 6828 272f 2729 3a0a 2020  ndswith('/'):.  
+00008170: 2020 2020 2020 7261 6973 6520 5333 4973        raise S3Is
+00008180: 4144 6972 6563 746f 7279 4572 726f 7228  ADirectoryError(
+00008190: 2749 7320 6120 6469 7265 6374 6f72 793a  'Is a directory:
+000081a0: 2025 7227 2025 2064 7374 5f75 726c 290a   %r' % dst_url).
+000081b0: 0a20 2020 2063 6c69 656e 7420 3d20 6765  .    client = ge
+000081c0: 745f 7333 5f63 6c69 656e 7428 7072 6f66  t_s3_client(prof
+000081d0: 696c 655f 6e61 6d65 3d53 3350 6174 6828  ile_name=S3Path(
+000081e0: 6473 745f 7572 6c29 2e5f 7072 6f66 696c  dst_url)._profil
+000081f0: 655f 6e61 6d65 290a 2020 2020 7769 7468  e_name).    with
+00008200: 206f 7065 6e28 7372 635f 7572 6c2c 2027   open(src_url, '
+00008210: 7262 2729 2061 7320 7372 633a 0a20 2020  rb') as src:.   
+00008220: 2020 2020 2077 6974 6820 7261 6973 655f       with raise_
+00008230: 7333 5f65 7272 6f72 2864 7374 5f75 726c  s3_error(dst_url
+00008240: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+00008250: 6c69 656e 742e 7570 6c6f 6164 5f66 696c  lient.upload_fil
+00008260: 656f 626a 280a 2020 2020 2020 2020 2020  eobj(.          
+00008270: 2020 2020 2020 7372 632c 2042 7563 6b65        src, Bucke
+00008280: 743d 6473 745f 6275 636b 6574 2c20 4b65  t=dst_bucket, Ke
+00008290: 793d 6473 745f 6b65 792c 2043 616c 6c62  y=dst_key, Callb
+000082a0: 6163 6b3d 6361 6c6c 6261 636b 290a 0a0a  ack=callback)...
+000082b0: 6465 6620 7333 5f6c 6f61 645f 636f 6e74  def s3_load_cont
+000082c0: 656e 7428 0a20 2020 2020 2020 2073 335f  ent(.        s3_
+000082d0: 7572 6c2c 0a20 2020 2020 2020 2073 7461  url,.        sta
+000082e0: 7274 3a20 4f70 7469 6f6e 616c 5b69 6e74  rt: Optional[int
+000082f0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00008300: 2020 7374 6f70 3a20 4f70 7469 6f6e 616c    stop: Optional
+00008310: 5b69 6e74 5d20 3d20 4e6f 6e65 2c0a 2020  [int] = None,.  
+00008320: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
+00008330: 733a 2062 6f6f 6c20 3d20 4661 6c73 6529  s: bool = False)
+00008340: 202d 3e20 6279 7465 733a 0a20 2020 2027   -> bytes:.    '
+00008350: 2727 0a20 2020 2047 6574 2073 7065 6369  ''.    Get speci
+00008360: 6669 6564 2066 696c 6520 6672 6f6d 205b  fied file from [
+00008370: 7374 6172 742c 2073 746f 7029 2069 6e20  start, stop) in 
+00008380: 6279 7465 730a 0a20 2020 203a 7061 7261  bytes..    :para
+00008390: 6d20 7333 5f75 726c 3a20 5370 6563 6966  m s3_url: Specif
+000083a0: 6965 6420 7061 7468 0a20 2020 203a 7061  ied path.    :pa
+000083b0: 7261 6d20 7374 6172 743a 2073 7461 7274  ram start: start
+000083c0: 2069 6e64 6578 0a20 2020 203a 7061 7261   index.    :para
+000083d0: 6d20 7374 6f70 3a20 7374 6f70 2069 6e64  m stop: stop ind
+000083e0: 6578 0a20 2020 203a 7265 7475 726e 733a  ex.    :returns:
+000083f0: 2062 7974 6573 2063 6f6e 7465 6e74 2069   bytes content i
+00008400: 6e20 7261 6e67 6520 5b73 7461 7274 2c20  n range [start, 
+00008410: 7374 6f70 290a 2020 2020 2727 270a 0a20  stop).    '''.. 
+00008420: 2020 2064 6566 205f 6765 745f 6f62 6a65     def _get_obje
+00008430: 6374 2863 6c69 656e 742c 2062 7563 6b65  ct(client, bucke
+00008440: 742c 206b 6579 2c20 7261 6e67 655f 7374  t, key, range_st
+00008450: 7229 3a0a 2020 2020 2020 2020 7265 7475  r):.        retu
+00008460: 726e 2063 6c69 656e 742e 6765 745f 6f62  rn client.get_ob
+00008470: 6a65 6374 280a 2020 2020 2020 2020 2020  ject(.          
+00008480: 2020 4275 636b 6574 3d62 7563 6b65 742c    Bucket=bucket,
+00008490: 204b 6579 3d6b 6579 2c20 5261 6e67 653d   Key=key, Range=
+000084a0: 7261 6e67 655f 7374 7229 5b27 426f 6479  range_str)['Body
+000084b0: 275d 2e72 6561 6428 290a 0a20 2020 2073  '].read()..    s
+000084c0: 335f 7572 6c20 3d20 5333 5061 7468 2873  3_url = S3Path(s
+000084d0: 335f 7572 6c29 0a20 2020 2069 6620 666f  3_url).    if fo
+000084e0: 6c6c 6f77 6c69 6e6b 733a 0a20 2020 2020  llowlinks:.     
+000084f0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00008500: 2020 2020 7333 5f75 726c 203d 2073 335f      s3_url = s3_
+00008510: 7572 6c2e 7265 6164 6c69 6e6b 2829 0a20  url.readlink(). 
+00008520: 2020 2020 2020 2065 7863 6570 7420 5333         except S3
+00008530: 4e6f 7441 4c69 6e6b 4572 726f 723a 0a20  NotALinkError:. 
+00008540: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00008550: 0a20 2020 2062 7563 6b65 742c 206b 6579  .    bucket, key
+00008560: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
+00008570: 7333 5f75 726c 2e70 6174 685f 7769 7468  s3_url.path_with
+00008580: 5f70 726f 746f 636f 6c29 0a20 2020 2069  _protocol).    i
+00008590: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
+000085a0: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
+000085b0: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+000085c0: 7228 2745 6d70 7479 2062 7563 6b65 7420  r('Empty bucket 
+000085d0: 6e61 6d65 3a20 2572 2720 2520 7333 5f75  name: %r' % s3_u
+000085e0: 726c 290a 2020 2020 6966 206e 6f74 206b  rl).    if not k
+000085f0: 6579 206f 7220 6b65 792e 656e 6473 7769  ey or key.endswi
+00008600: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
+00008610: 2072 6169 7365 2053 3349 7341 4469 7265   raise S3IsADire
+00008620: 6374 6f72 7945 7272 6f72 2827 4973 2061  ctoryError('Is a
+00008630: 2064 6972 6563 746f 7279 3a20 2572 2720   directory: %r' 
+00008640: 2520 7333 5f75 726c 290a 0a20 2020 2073  % s3_url)..    s
+00008650: 7461 7274 2c20 7374 6f70 203d 2067 6574  tart, stop = get
+00008660: 5f63 6f6e 7465 6e74 5f6f 6666 7365 7428  _content_offset(
+00008670: 0a20 2020 2020 2020 2073 7461 7274 2c20  .        start, 
+00008680: 7374 6f70 2c20 7333 5f75 726c 2e67 6574  stop, s3_url.get
+00008690: 7369 7a65 2866 6f6c 6c6f 775f 7379 6d6c  size(follow_syml
+000086a0: 696e 6b73 3d46 616c 7365 2929 0a20 2020  inks=False)).   
+000086b0: 2069 6620 7374 6172 7420 3d3d 2030 2061   if start == 0 a
+000086c0: 6e64 2073 746f 7020 3d3d 2030 3a0a 2020  nd stop == 0:.  
+000086d0: 2020 2020 2020 7265 7475 726e 2062 2727        return b''
+000086e0: 0a20 2020 2072 616e 6765 5f73 7472 203d  .    range_str =
+000086f0: 2027 6279 7465 733d 2564 2d25 6427 2025   'bytes=%d-%d' %
+00008700: 2028 7374 6172 742c 2073 746f 7020 2d20   (start, stop - 
+00008710: 3129 0a0a 2020 2020 636c 6965 6e74 203d  1)..    client =
+00008720: 2067 6574 5f73 335f 636c 6965 6e74 2870   get_s3_client(p
+00008730: 726f 6669 6c65 5f6e 616d 653d 7333 5f75  rofile_name=s3_u
+00008740: 726c 2e5f 7072 6f66 696c 655f 6e61 6d65  rl._profile_name
+00008750: 290a 2020 2020 7769 7468 2072 6169 7365  ).    with raise
+00008760: 5f73 335f 6572 726f 7228 7333 5f75 726c  _s3_error(s3_url
+00008770: 2e70 6174 6829 3a0a 2020 2020 2020 2020  .path):.        
+00008780: 7265 7475 726e 2070 6174 6368 5f6d 6574  return patch_met
+00008790: 686f 6428 0a20 2020 2020 2020 2020 2020  hod(.           
+000087a0: 205f 6765 745f 6f62 6a65 6374 2c0a 2020   _get_object,.  
+000087b0: 2020 2020 2020 2020 2020 6d61 785f 7265            max_re
+000087c0: 7472 6965 733d 6d61 785f 7265 7472 6965  tries=max_retrie
+000087d0: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
+000087e0: 686f 756c 645f 7265 7472 793d 7333 5f73  hould_retry=s3_s
+000087f0: 686f 756c 645f 7265 7472 792c 0a20 2020  hould_retry,.   
+00008800: 2020 2020 2029 2863 6c69 656e 742c 2062       )(client, b
+00008810: 7563 6b65 742c 206b 6579 2c20 7261 6e67  ucket, key, rang
+00008820: 655f 7374 7229 0a0a 0a64 6566 2073 335f  e_str)...def s3_
+00008830: 7265 6164 6c69 6e6b 2870 6174 6829 202d  readlink(path) -
+00008840: 3e20 7374 723a 0a20 2020 2027 2727 0a20  > str:.    '''. 
+00008850: 2020 2052 6574 7572 6e20 6120 7374 7269     Return a stri
+00008860: 6e67 2072 6570 7265 7365 6e74 696e 6720  ng representing 
+00008870: 7468 6520 7061 7468 2074 6f20 7768 6963  the path to whic
+00008880: 6820 7468 6520 7379 6d62 6f6c 6963 206c  h the symbolic l
+00008890: 696e 6b20 706f 696e 7473 2e0a 0a20 2020  ink points...   
+000088a0: 203a 7265 7475 726e 733a 2052 6574 7572   :returns: Retur
+000088b0: 6e20 6120 7374 7269 6e67 2072 6570 7265  n a string repre
+000088c0: 7365 6e74 696e 6720 7468 6520 7061 7468  senting the path
+000088d0: 2074 6f20 7768 6963 6820 7468 6520 7379   to which the sy
+000088e0: 6d62 6f6c 6963 206c 696e 6b20 706f 696e  mbolic link poin
+000088f0: 7473 2e0a 2020 2020 3a72 6169 7365 733a  ts..    :raises:
+00008900: 2053 334e 616d 6554 6f6f 4c6f 6e67 4572   S3NameTooLongEr
+00008910: 726f 722c 2053 3342 7563 6b65 744e 6f74  ror, S3BucketNot
+00008920: 466f 756e 6445 7272 6f72 2c20 5333 4973  FoundError, S3Is
+00008930: 4144 6972 6563 746f 7279 4572 726f 722c  ADirectoryError,
+00008940: 2053 334e 6f74 414c 696e 6b45 7272 6f72   S3NotALinkError
+00008950: 0a20 2020 2027 2727 0a20 2020 2072 6574  .    '''.    ret
+00008960: 7572 6e20 5333 5061 7468 2870 6174 6829  urn S3Path(path)
+00008970: 2e72 6561 646c 696e 6b28 292e 7061 7468  .readlink().path
+00008980: 5f77 6974 685f 7072 6f74 6f63 6f6c 0a0a  _with_protocol..
+00008990: 0a64 6566 2073 335f 7265 6e61 6d65 2873  .def s3_rename(s
+000089a0: 7263 5f75 726c 3a20 5061 7468 4c69 6b65  rc_url: PathLike
+000089b0: 2c20 6473 745f 7572 6c3a 2050 6174 684c  , dst_url: PathL
+000089c0: 696b 6529 3a0a 2020 2020 2727 270a 2020  ike):.    '''.  
+000089d0: 2020 4d6f 7665 2073 3320 6669 6c65 2070    Move s3 file p
+000089e0: 6174 6820 6672 6f6d 2073 7263 5f75 726c  ath from src_url
+000089f0: 2074 6f20 6473 745f 7572 6c0a 0a20 2020   to dst_url..   
+00008a00: 203a 7061 7261 6d20 6473 745f 7572 6c3a   :param dst_url:
+00008a10: 2047 6976 656e 2064 6573 7469 6e61 7469   Given destinati
+00008a20: 6f6e 2070 6174 680a 2020 2020 2727 270a  on path.    '''.
+00008a30: 2020 2020 7372 635f 7061 7468 5f69 6e73      src_path_ins
+00008a40: 203d 2053 3350 6174 6828 7372 635f 7572   = S3Path(src_ur
+00008a50: 6c29 0a20 2020 2069 6620 7372 635f 7061  l).    if src_pa
+00008a60: 7468 5f69 6e73 2e69 735f 6669 6c65 2829  th_ins.is_file()
+00008a70: 3a0a 2020 2020 2020 2020 7372 635f 7061  :.        src_pa
+00008a80: 7468 5f69 6e73 2e63 6f70 7928 6473 745f  th_ins.copy(dst_
+00008a90: 7572 6c29 0a20 2020 2065 6c73 653a 0a20  url).    else:. 
+00008aa0: 2020 2020 2020 2073 7263 5f70 6174 685f         src_path_
+00008ab0: 696e 732e 7379 6e63 2864 7374 5f75 726c  ins.sync(dst_url
+00008ac0: 290a 2020 2020 7372 635f 7061 7468 5f69  ).    src_path_i
+00008ad0: 6e73 2e72 656d 6f76 6528 290a 0a0a 636c  ns.remove()...cl
+00008ae0: 6173 7320 5333 4361 6368 6572 2846 696c  ass S3Cacher(Fil
+00008af0: 6543 6163 6865 7229 3a0a 2020 2020 6361  eCacher):.    ca
+00008b00: 6368 655f 7061 7468 203d 204e 6f6e 650a  che_path = None.
+00008b10: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00008b20: 5f28 0a20 2020 2020 2020 2020 2020 2073  _(.            s
+00008b30: 656c 662c 2070 6174 683a 2073 7472 2c20  elf, path: str, 
+00008b40: 6361 6368 655f 7061 7468 3a20 4f70 7469  cache_path: Opti
+00008b50: 6f6e 616c 5b73 7472 5d20 3d20 4e6f 6e65  onal[str] = None
+00008b60: 2c20 6d6f 6465 3a20 7374 7220 3d20 2772  , mode: str = 'r
+00008b70: 2729 3a0a 2020 2020 2020 2020 6966 206d  '):.        if m
+00008b80: 6f64 6520 6e6f 7420 696e 2028 2772 272c  ode not in ('r',
+00008b90: 2027 7727 2c20 2761 2729 3a0a 2020 2020   'w', 'a'):.    
+00008ba0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00008bb0: 6c75 6545 7272 6f72 2827 756e 6163 6365  lueError('unacce
+00008bc0: 7074 6162 6c65 206d 6f64 653a 2025 7227  ptable mode: %r'
+00008bd0: 2025 206d 6f64 6529 0a20 2020 2020 2020   % mode).       
+00008be0: 2069 6620 6d6f 6465 2069 6e20 2827 7227   if mode in ('r'
+00008bf0: 2c20 2761 2729 3a0a 2020 2020 2020 2020  , 'a'):.        
+00008c00: 2020 2020 6966 2063 6163 6865 5f70 6174      if cache_pat
+00008c10: 6820 6973 204e 6f6e 653a 0a20 2020 2020  h is None:.     
+00008c20: 2020 2020 2020 2020 2020 2063 6163 6865             cache
+00008c30: 5f70 6174 6820 3d20 6765 6e65 7261 7465  _path = generate
+00008c40: 5f63 6163 6865 5f70 6174 6828 7061 7468  _cache_path(path
+00008c50: 290a 2020 2020 2020 2020 2020 2020 7333  ).            s3
+00008c60: 5f64 6f77 6e6c 6f61 6428 7061 7468 2c20  _download(path, 
+00008c70: 6361 6368 655f 7061 7468 290a 2020 2020  cache_path).    
+00008c80: 2020 2020 7365 6c66 2e6e 616d 6520 3d20      self.name = 
+00008c90: 7061 7468 0a20 2020 2020 2020 2073 656c  path.        sel
+00008ca0: 662e 6d6f 6465 203d 206d 6f64 650a 2020  f.mode = mode.  
+00008cb0: 2020 2020 2020 7365 6c66 2e63 6163 6865        self.cache
+00008cc0: 5f70 6174 6820 3d20 6361 6368 655f 7061  _path = cache_pa
+00008cd0: 7468 0a0a 2020 2020 6465 6620 5f63 6c6f  th..    def _clo
+00008ce0: 7365 2873 656c 6629 3a0a 2020 2020 2020  se(self):.      
+00008cf0: 2020 6966 2073 656c 662e 6361 6368 655f    if self.cache_
+00008d00: 7061 7468 2069 7320 6e6f 7420 4e6f 6e65  path is not None
+00008d10: 2061 6e64 205c 0a20 2020 2020 2020 2020   and \.         
+00008d20: 2020 206f 732e 7061 7468 2e65 7869 7374     os.path.exist
+00008d30: 7328 7365 6c66 2e63 6163 6865 5f70 6174  s(self.cache_pat
+00008d40: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
+00008d50: 6966 2073 656c 662e 6d6f 6465 2069 6e20  if self.mode in 
+00008d60: 2827 7727 2c20 2761 2729 3a0a 2020 2020  ('w', 'a'):.    
+00008d70: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
+00008d80: 706c 6f61 6428 7365 6c66 2e63 6163 6865  pload(self.cache
+00008d90: 5f70 6174 682c 2073 656c 662e 6e61 6d65  _path, self.name
+00008da0: 290a 2020 2020 2020 2020 2020 2020 6f73  ).            os
+00008db0: 2e75 6e6c 696e 6b28 7365 6c66 2e63 6163  .unlink(self.cac
+00008dc0: 6865 5f70 6174 6829 0a0a 0a64 6566 2073  he_path)...def s
+00008dd0: 335f 676c 6f62 280a 2020 2020 2020 2020  3_glob(.        
+00008de0: 7061 7468 3a20 5061 7468 4c69 6b65 2c0a  path: PathLike,.
+00008df0: 2020 2020 2020 2020 7265 6375 7273 6976          recursiv
+00008e00: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
+00008e10: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
+00008e20: 6f6b 3a20 626f 6f6c 203d 2054 7275 652c  ok: bool = True,
+00008e30: 0a20 2020 2020 2020 2066 6f6c 6c6f 776c  .        followl
+00008e40: 696e 6b73 3a20 626f 6f6c 203d 2046 616c  inks: bool = Fal
+00008e50: 7365 2c0a 2920 2d3e 204c 6973 745b 7374  se,.) -> List[st
+00008e60: 725d 3a0a 2020 2020 2727 2752 6574 7572  r]:.    '''Retur
+00008e70: 6e20 7333 2070 6174 6820 6c69 7374 2069  n s3 path list i
+00008e80: 6e20 6173 6365 6e64 696e 6720 616c 7068  n ascending alph
+00008e90: 6162 6574 6963 616c 206f 7264 6572 2c20  abetical order, 
+00008ea0: 696e 2077 6869 6368 2070 6174 6820 6d61  in which path ma
+00008eb0: 7463 6865 7320 676c 6f62 2070 6174 7465  tches glob patte
+00008ec0: 726e 0a20 2020 204e 6f74 6573 3a20 4f6e  rn.    Notes: On
+00008ed0: 6c79 2067 6c6f 6220 696e 2062 7563 6b65  ly glob in bucke
+00008ee0: 742e 2049 6620 7472 7969 6e67 2074 6f20  t. If trying to 
+00008ef0: 6d61 7463 6820 6275 636b 6574 2077 6974  match bucket wit
+00008f00: 6820 7769 6c64 6361 7264 2063 6861 7261  h wildcard chara
+00008f10: 6374 6572 732c 2072 6169 7365 2055 6e73  cters, raise Uns
+00008f20: 7570 706f 7274 6564 4572 726f 720a 0a20  upportedError.. 
+00008f30: 2020 203a 7061 7261 6d20 7265 6375 7273     :param recurs
+00008f40: 6976 653a 2049 6620 4661 6c73 652c 2060  ive: If False, `
+00008f50: 2a2a 6020 7769 6c6c 206e 6f74 2073 6561  **` will not sea
+00008f60: 7263 6820 6469 7265 6374 6f72 7920 7265  rch directory re
+00008f70: 6375 7273 6976 656c 790a 2020 2020 3a70  cursively.    :p
+00008f80: 6172 616d 206d 6973 7369 6e67 5f6f 6b3a  aram missing_ok:
+00008f90: 2049 6620 4661 6c73 6520 616e 6420 7461   If False and ta
+00008fa0: 7267 6574 2070 6174 6820 646f 6573 6e27  rget path doesn'
+00008fb0: 7420 6d61 7463 6820 616e 7920 6669 6c65  t match any file
+00008fc0: 2c20 7261 6973 6520 4669 6c65 4e6f 7446  , raise FileNotF
+00008fd0: 6f75 6e64 4572 726f 720a 2020 2020 3a72  oundError.    :r
+00008fe0: 6169 7365 733a 2055 6e73 7570 706f 7274  aises: Unsupport
+00008ff0: 6564 4572 726f 722c 2077 6865 6e20 6275  edError, when bu
+00009000: 636b 6574 2070 6172 7420 636f 6e74 6169  cket part contai
+00009010: 6e73 2077 696c 6463 6172 6420 6368 6172  ns wildcard char
+00009020: 6163 7465 7273 0a20 2020 203a 7265 7475  acters.    :retu
+00009030: 726e 733a 2041 206c 6973 7420 636f 6e74  rns: A list cont
+00009040: 6169 6e73 2070 6174 6873 206d 6174 6368  ains paths match
+00009050: 2060 7333 5f70 6174 686e 616d 6560 0a20   `s3_pathname`. 
+00009060: 2020 2027 2727 0a20 2020 2072 6574 7572     '''.    retur
+00009070: 6e20 6c69 7374 280a 2020 2020 2020 2020  n list(.        
+00009080: 7333 5f69 676c 6f62 280a 2020 2020 2020  s3_iglob(.      
+00009090: 2020 2020 2020 7061 7468 3d70 6174 682c        path=path,
+000090a0: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+000090b0: 7572 7369 7665 3d72 6563 7572 7369 7665  ursive=recursive
+000090c0: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
+000090d0: 7373 696e 675f 6f6b 3d6d 6973 7369 6e67  ssing_ok=missing
+000090e0: 5f6f 6b2c 0a20 2020 2020 2020 2020 2020  _ok,.           
+000090f0: 2066 6f6c 6c6f 776c 696e 6b73 3d66 6f6c   followlinks=fol
+00009100: 6c6f 776c 696e 6b73 2929 0a0a 0a64 6566  lowlinks))...def
+00009110: 2073 335f 676c 6f62 5f73 7461 7428 0a20   s3_glob_stat(. 
+00009120: 2020 2020 2020 2070 6174 683a 2050 6174         path: Pat
+00009130: 684c 696b 652c 0a20 2020 2020 2020 2072  hLike,.        r
+00009140: 6563 7572 7369 7665 3a20 626f 6f6c 203d  ecursive: bool =
+00009150: 2054 7275 652c 0a20 2020 2020 2020 206d   True,.        m
+00009160: 6973 7369 6e67 5f6f 6b3a 2062 6f6f 6c20  issing_ok: bool 
+00009170: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
+00009180: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
+00009190: 6c20 3d20 4661 6c73 6529 202d 3e20 4974  l = False) -> It
+000091a0: 6572 6174 6f72 5b46 696c 6545 6e74 7279  erator[FileEntry
+000091b0: 5d3a 0a20 2020 2027 2727 5265 7475 726e  ]:.    '''Return
+000091c0: 2061 2067 656e 6572 6174 6f72 2063 6f6e   a generator con
+000091d0: 7461 696e 7320 7475 706c 6573 206f 6620  tains tuples of 
+000091e0: 7061 7468 2061 6e64 2066 696c 6520 7374  path and file st
+000091f0: 6174 2c20 696e 2061 7363 656e 6469 6e67  at, in ascending
+00009200: 2061 6c70 6861 6265 7469 6361 6c20 6f72   alphabetical or
+00009210: 6465 722c 2069 6e20 7768 6963 6820 7061  der, in which pa
+00009220: 7468 206d 6174 6368 6573 2067 6c6f 6220  th matches glob 
+00009230: 7061 7474 6572 6e0a 2020 2020 4e6f 7465  pattern.    Note
+00009240: 733a 204f 6e6c 7920 676c 6f62 2069 6e20  s: Only glob in 
+00009250: 6275 636b 6574 2e20 4966 2074 7279 696e  bucket. If tryin
+00009260: 6720 746f 206d 6174 6368 2062 7563 6b65  g to match bucke
+00009270: 7420 7769 7468 2077 696c 6463 6172 6420  t with wildcard 
+00009280: 6368 6172 6163 7465 7273 2c20 7261 6973  characters, rais
+00009290: 6520 556e 7375 7070 6f72 7465 6445 7272  e UnsupportedErr
+000092a0: 6f72 0a0a 2020 2020 3a70 6172 616d 2072  or..    :param r
+000092b0: 6563 7572 7369 7665 3a20 4966 2046 616c  ecursive: If Fal
+000092c0: 7365 2c20 602a 2a60 2077 696c 6c20 6e6f  se, `**` will no
+000092d0: 7420 7365 6172 6368 2064 6972 6563 746f  t search directo
+000092e0: 7279 2072 6563 7572 7369 7665 6c79 0a20  ry recursively. 
+000092f0: 2020 203a 7061 7261 6d20 6d69 7373 696e     :param missin
+00009300: 675f 6f6b 3a20 4966 2046 616c 7365 2061  g_ok: If False a
+00009310: 6e64 2074 6172 6765 7420 7061 7468 2064  nd target path d
+00009320: 6f65 736e 2774 206d 6174 6368 2061 6e79  oesn't match any
+00009330: 2066 696c 652c 2072 6169 7365 2046 696c   file, raise Fil
+00009340: 654e 6f74 466f 756e 6445 7272 6f72 0a20  eNotFoundError. 
+00009350: 2020 203a 7261 6973 6573 3a20 556e 7375     :raises: Unsu
+00009360: 7070 6f72 7465 6445 7272 6f72 2c20 7768  pportedError, wh
+00009370: 656e 2062 7563 6b65 7420 7061 7274 2063  en bucket part c
+00009380: 6f6e 7461 696e 7320 7769 6c64 6361 7264  ontains wildcard
+00009390: 2063 6861 7261 6374 6572 730a 2020 2020   characters.    
+000093a0: 3a72 6574 7572 6e73 3a20 4120 6765 6e65  :returns: A gene
+000093b0: 7261 746f 7220 636f 6e74 6169 6e73 2074  rator contains t
+000093c0: 7570 6c65 7320 6f66 2070 6174 6820 616e  uples of path an
+000093d0: 6420 6669 6c65 2073 7461 742c 2069 6e20  d file stat, in 
+000093e0: 7768 6963 6820 7061 7468 7320 6d61 7463  which paths matc
+000093f0: 6820 6073 335f 7061 7468 6e61 6d65 600a  h `s3_pathname`.
+00009400: 2020 2020 2727 270a 2020 2020 7265 7475      '''.    retu
+00009410: 726e 2053 3350 6174 6828 7061 7468 292e  rn S3Path(path).
+00009420: 676c 6f62 5f73 7461 7428 0a20 2020 2020  glob_stat(.     
+00009430: 2020 2070 6174 7465 726e 3d22 222c 0a20     pattern="",. 
+00009440: 2020 2020 2020 2072 6563 7572 7369 7665         recursive
+00009450: 3d72 6563 7572 7369 7665 2c0a 2020 2020  =recursive,.    
+00009460: 2020 2020 6d69 7373 696e 675f 6f6b 3d6d      missing_ok=m
+00009470: 6973 7369 6e67 5f6f 6b2c 0a20 2020 2020  issing_ok,.     
+00009480: 2020 2066 6f6c 6c6f 776c 696e 6b73 3d66     followlinks=f
+00009490: 6f6c 6c6f 776c 696e 6b73 290a 0a0a 6465  ollowlinks)...de
+000094a0: 6620 7333 5f69 676c 6f62 280a 2020 2020  f s3_iglob(.    
+000094b0: 2020 2020 7061 7468 3a20 5061 7468 4c69      path: PathLi
+000094c0: 6b65 2c0a 2020 2020 2020 2020 7265 6375  ke,.        recu
+000094d0: 7273 6976 653a 2062 6f6f 6c20 3d20 5472  rsive: bool = Tr
+000094e0: 7565 2c0a 2020 2020 2020 2020 6d69 7373  ue,.        miss
+000094f0: 696e 675f 6f6b 3a20 626f 6f6c 203d 2054  ing_ok: bool = T
+00009500: 7275 652c 0a20 2020 2020 2020 2066 6f6c  rue,.        fol
+00009510: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
+00009520: 2046 616c 7365 2c0a 2920 2d3e 2049 7465   False,.) -> Ite
+00009530: 7261 746f 725b 7374 725d 3a0a 2020 2020  rator[str]:.    
+00009540: 2727 2752 6574 7572 6e20 7333 2070 6174  '''Return s3 pat
+00009550: 6820 6974 6572 6174 6f72 2069 6e20 6173  h iterator in as
+00009560: 6365 6e64 696e 6720 616c 7068 6162 6574  cending alphabet
+00009570: 6963 616c 206f 7264 6572 2c20 696e 2077  ical order, in w
+00009580: 6869 6368 2070 6174 6820 6d61 7463 6865  hich path matche
+00009590: 7320 676c 6f62 2070 6174 7465 726e 0a20  s glob pattern. 
+000095a0: 2020 204e 6f74 6573 3a20 4f6e 6c79 2067     Notes: Only g
+000095b0: 6c6f 6220 696e 2062 7563 6b65 742e 2049  lob in bucket. I
+000095c0: 6620 7472 7969 6e67 2074 6f20 6d61 7463  f trying to matc
+000095d0: 6820 6275 636b 6574 2077 6974 6820 7769  h bucket with wi
+000095e0: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
+000095f0: 732c 2072 6169 7365 2055 6e73 7570 706f  s, raise Unsuppo
+00009600: 7274 6564 4572 726f 720a 0a20 2020 203a  rtedError..    :
+00009610: 7061 7261 6d20 7265 6375 7273 6976 653a  param recursive:
+00009620: 2049 6620 4661 6c73 652c 2060 2a2a 6020   If False, `**` 
+00009630: 7769 6c6c 206e 6f74 2073 6561 7263 6820  will not search 
+00009640: 6469 7265 6374 6f72 7920 7265 6375 7273  directory recurs
+00009650: 6976 656c 790a 2020 2020 3a70 6172 616d  ively.    :param
+00009660: 206d 6973 7369 6e67 5f6f 6b3a 2049 6620   missing_ok: If 
+00009670: 4661 6c73 6520 616e 6420 7461 7267 6574  False and target
+00009680: 2070 6174 6820 646f 6573 6e27 7420 6d61   path doesn't ma
+00009690: 7463 6820 616e 7920 6669 6c65 2c20 7261  tch any file, ra
+000096a0: 6973 6520 4669 6c65 4e6f 7446 6f75 6e64  ise FileNotFound
+000096b0: 4572 726f 720a 2020 2020 3a72 6169 7365  Error.    :raise
+000096c0: 733a 2055 6e73 7570 706f 7274 6564 4572  s: UnsupportedEr
+000096d0: 726f 722c 2077 6865 6e20 6275 636b 6574  ror, when bucket
+000096e0: 2070 6172 7420 636f 6e74 6169 6e73 2077   part contains w
+000096f0: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
+00009700: 7273 0a20 2020 203a 7265 7475 726e 733a  rs.    :returns:
+00009710: 2041 6e20 6974 6572 6174 6f72 2063 6f6e   An iterator con
+00009720: 7461 696e 7320 7061 7468 7320 6d61 7463  tains paths matc
+00009730: 6820 6073 335f 7061 7468 6e61 6d65 600a  h `s3_pathname`.
+00009740: 2020 2020 2727 270a 2020 2020 666f 7220      '''.    for 
+00009750: 7061 7468 5f6f 626a 2069 6e20 5333 5061  path_obj in S3Pa
+00009760: 7468 2870 6174 6829 2e69 676c 6f62 2870  th(path).iglob(p
+00009770: 6174 7465 726e 3d22 222c 2072 6563 7572  attern="", recur
+00009780: 7369 7665 3d72 6563 7572 7369 7665 2c0a  sive=recursive,.
 00009790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000097a0: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-000097b0: 7373 696e 675f 6f6b 3d6d 6973 7369 6e67  ssing_ok=missing
-000097c0: 5f6f 6b2c 0a20 2020 2020 2020 2020 2020  _ok,.           
+000097a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097b0: 2020 2020 2020 206d 6973 7369 6e67 5f6f         missing_o
+000097c0: 6b3d 6d69 7373 696e 675f 6f6b 2c0a 2020  k=missing_ok,.  
 000097d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000097e0: 2020 2020 2020 2020 2020 2020 666f 6c6c              foll
-000097f0: 6f77 6c69 6e6b 733d 666f 6c6c 6f77 6c69  owlinks=followli
-00009800: 6e6b 7329 3a0a 2020 2020 2020 2020 7969  nks):.        yi
-00009810: 656c 6420 7061 7468 5f6f 626a 2e70 6174  eld path_obj.pat
-00009820: 685f 7769 7468 5f70 726f 746f 636f 6c0a  h_with_protocol.
-00009830: 0a0a 6465 6620 7333 5f6d 616b 6564 6972  ..def s3_makedir
-00009840: 7328 7061 7468 3a20 5061 7468 4c69 6b65  s(path: PathLike
-00009850: 2c20 6578 6973 745f 6f6b 3a20 626f 6f6c  , exist_ok: bool
-00009860: 203d 2046 616c 7365 293a 0a20 2020 2027   = False):.    '
-00009870: 2727 0a20 2020 2043 7265 6174 6520 616e  ''.    Create an
-00009880: 2073 3320 6469 7265 6374 6f72 792e 0a20   s3 directory.. 
-00009890: 2020 2050 7572 656c 7920 6372 6561 7469     Purely creati
-000098a0: 6e67 2064 6972 6563 746f 7279 2069 7320  ng directory is 
-000098b0: 696e 7661 6c69 6420 6265 6361 7573 6520  invalid because 
-000098c0: 6974 2773 2075 6e61 7661 696c 6162 6c65  it's unavailable
-000098d0: 206f 6e20 4f53 532e 0a20 2020 2054 6869   on OSS..    Thi
-000098e0: 7320 6675 6e63 7469 6f6e 2069 7320 746f  s function is to
-000098f0: 2074 6573 7420 7468 6520 7461 7267 6574   test the target
-00009900: 2062 7563 6b65 7420 6861 7665 2057 5249   bucket have WRI
-00009910: 5445 2061 6363 6573 732e 0a0a 2020 2020  TE access...    
-00009920: 3a70 6172 616d 2070 6174 683a 2047 6976  :param path: Giv
-00009930: 656e 2070 6174 680a 2020 2020 3a70 6172  en path.    :par
-00009940: 616d 2065 7869 7374 5f6f 6b3a 2049 6620  am exist_ok: If 
-00009950: 4661 6c73 6520 616e 6420 7461 7267 6574  False and target
-00009960: 2064 6972 6563 746f 7279 2065 7869 7374   directory exist
-00009970: 732c 2072 6169 7365 2053 3346 696c 6545  s, raise S3FileE
-00009980: 7869 7374 7345 7272 6f72 0a20 2020 203a  xistsError.    :
-00009990: 7261 6973 6573 3a20 5333 4275 636b 6574  raises: S3Bucket
-000099a0: 4e6f 7446 6f75 6e64 4572 726f 722c 2053  NotFoundError, S
-000099b0: 3346 696c 6545 7869 7374 7345 7272 6f72  3FileExistsError
-000099c0: 0a20 2020 2027 2727 0a20 2020 2072 6574  .    '''.    ret
-000099d0: 7572 6e20 5333 5061 7468 2870 6174 6829  urn S3Path(path)
-000099e0: 2e6d 6b64 6972 2870 6172 656e 7473 3d54  .mkdir(parents=T
-000099f0: 7275 652c 2065 7869 7374 5f6f 6b3d 6578  rue, exist_ok=ex
-00009a00: 6973 745f 6f6b 290a 0a0a 6465 6620 5f67  ist_ok)...def _g
-00009a10: 726f 7570 5f73 7263 5f70 6174 6873 5f62  roup_src_paths_b
-00009a20: 795f 626c 6f63 6b28 0a20 2020 2020 2020  y_block(.       
-00009a30: 2073 7263 5f70 6174 6873 3a20 4c69 7374   src_paths: List
-00009a40: 5b50 6174 684c 696b 655d 2c20 626c 6f63  [PathLike], bloc
-00009a50: 6b5f 7369 7a65 3a20 696e 7420 3d20 4445  k_size: int = DE
-00009a60: 4641 554c 545f 424c 4f43 4b5f 5349 5a45  FAULT_BLOCK_SIZE
-00009a70: 0a29 202d 3e20 4c69 7374 5b4c 6973 745b  .) -> List[List[
-00009a80: 5475 706c 655b 5061 7468 4c69 6b65 2c20  Tuple[PathLike, 
-00009a90: 4f70 7469 6f6e 616c 5b73 7472 5d5d 5d5d  Optional[str]]]]
-00009aa0: 3a0a 2020 2020 6772 6f75 7073 203d 205b  :.    groups = [
-00009ab0: 5d0a 2020 2020 6375 7272 656e 745f 6772  ].    current_gr
-00009ac0: 6f75 702c 2063 7572 7265 6e74 5f67 726f  oup, current_gro
-00009ad0: 7570 5f73 697a 6520 3d20 5b5d 2c20 300a  up_size = [], 0.
-00009ae0: 2020 2020 666f 7220 7372 635f 7061 7468      for src_path
-00009af0: 2069 6e20 7372 635f 7061 7468 733a 0a20   in src_paths:. 
-00009b00: 2020 2020 2020 2063 7572 7265 6e74 5f66         current_f
-00009b10: 696c 655f 7369 7a65 203d 2053 3350 6174  ile_size = S3Pat
-00009b20: 6828 7372 635f 7061 7468 292e 7374 6174  h(src_path).stat
-00009b30: 2829 2e73 697a 650a 2020 2020 2020 2020  ().size.        
-00009b40: 6966 2063 7572 7265 6e74 5f66 696c 655f  if current_file_
-00009b50: 7369 7a65 203d 3d20 303a 2020 2320 7072  size == 0:  # pr
-00009b60: 6167 6d61 3a20 6e6f 2063 6f76 6572 0a20  agma: no cover. 
-00009b70: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00009b80: 6e75 650a 0a20 2020 2020 2020 2069 6620  nue..        if 
-00009b90: 6375 7272 656e 745f 6669 6c65 5f73 697a  current_file_siz
-00009ba0: 6520 3e3d 2062 6c6f 636b 5f73 697a 653a  e >= block_size:
-00009bb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00009bc0: 6c65 6e28 6772 6f75 7073 2920 3d3d 2030  len(groups) == 0
-00009bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009be0: 2020 6966 2063 7572 7265 6e74 5f67 726f    if current_gro
-00009bf0: 7570 5f73 697a 6520 2b20 6375 7272 656e  up_size + curren
-00009c00: 745f 6669 6c65 5f73 697a 6520 3e20 3220  t_file_size > 2 
-00009c10: 2a20 626c 6f63 6b5f 7369 7a65 3a0a 2020  * block_size:.  
-00009c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009c30: 2020 6772 6f75 705f 6c61 636b 5f73 697a    group_lack_siz
-00009c40: 6520 3d20 626c 6f63 6b5f 7369 7a65 202d  e = block_size -
-00009c50: 2063 7572 7265 6e74 5f67 726f 7570 5f73   current_group_s
-00009c60: 697a 650a 2020 2020 2020 2020 2020 2020  ize.            
-00009c70: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-00009c80: 6772 6f75 702e 6170 7065 6e64 280a 2020  group.append(.  
-00009c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ca0: 2020 2020 2020 2873 7263 5f70 6174 682c        (src_path,
-00009cb0: 2066 2762 7974 6573 3d30 2d7b 6772 6f75   f'bytes=0-{grou
-00009cc0: 705f 6c61 636b 5f73 697a 652d 317d 2729  p_lack_size-1}')
-00009cd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00009ce0: 2020 2020 2020 6772 6f75 7073 2e65 7874        groups.ext
-00009cf0: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-00009d00: 2020 2020 2020 2020 2020 2020 205b 0a20               [. 
-00009d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d20: 2020 2020 2020 2020 2020 2063 7572 7265             curre
-00009d30: 6e74 5f67 726f 7570 2c0a 2020 2020 2020  nt_group,.      
-00009d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d50: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00009d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d70: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
-00009d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009d90: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00009da0: 635f 7061 7468 2c0a 2020 2020 2020 2020  c_path,.        
-00009db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009dc0: 2020 2020 2020 2020 2020 2020 6627 6279              f'by
-00009dd0: 7465 733d 7b67 726f 7570 5f6c 6163 6b5f  tes={group_lack_
-00009de0: 7369 7a65 7d2d 7b63 7572 7265 6e74 5f66  size}-{current_f
-00009df0: 696c 655f 7369 7a65 2d31 7d27 0a20 2020  ile_size-1}'.   
-00009e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e10: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00009e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e30: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-00009e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e50: 2020 2020 205d 290a 2020 2020 2020 2020       ]).        
-00009e60: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00009e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e80: 2020 6375 7272 656e 745f 6772 6f75 702e    current_group.
-00009e90: 6170 7065 6e64 2828 7372 635f 7061 7468  append((src_path
-00009ea0: 2c20 4e6f 6e65 2929 0a20 2020 2020 2020  , None)).       
-00009eb0: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00009ec0: 7570 732e 6170 7065 6e64 2863 7572 7265  ups.append(curre
-00009ed0: 6e74 5f67 726f 7570 290a 2020 2020 2020  nt_group).      
-00009ee0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00009ef0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
-00009f00: 7073 5b2d 315d 2e65 7874 656e 6428 6375  ps[-1].extend(cu
-00009f10: 7272 656e 745f 6772 6f75 7029 0a20 2020  rrent_group).   
-00009f20: 2020 2020 2020 2020 2020 2020 2067 726f               gro
-00009f30: 7570 732e 6170 7065 6e64 285b 2873 7263  ups.append([(src
-00009f40: 5f70 6174 682c 204e 6f6e 6529 5d29 0a20  _path, None)]). 
-00009f50: 2020 2020 2020 2020 2020 2063 7572 7265             curre
-00009f60: 6e74 5f67 726f 7570 2c20 6375 7272 656e  nt_group, curren
-00009f70: 745f 6772 6f75 705f 7369 7a65 203d 205b  t_group_size = [
-00009f80: 5d2c 2030 0a20 2020 2020 2020 2065 6c73  ], 0.        els
-00009f90: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-00009fa0: 7572 7265 6e74 5f67 726f 7570 2e61 7070  urrent_group.app
-00009fb0: 656e 6428 2873 7263 5f70 6174 682c 204e  end((src_path, N
-00009fc0: 6f6e 6529 290a 2020 2020 2020 2020 2020  one)).          
-00009fd0: 2020 6375 7272 656e 745f 6772 6f75 705f    current_group_
-00009fe0: 7369 7a65 202b 3d20 6375 7272 656e 745f  size += current_
-00009ff0: 6669 6c65 5f73 697a 650a 2020 2020 2020  file_size.      
-0000a000: 2020 2020 2020 6966 2063 7572 7265 6e74        if current
-0000a010: 5f67 726f 7570 5f73 697a 6520 3e3d 2062  _group_size >= b
-0000a020: 6c6f 636b 5f73 697a 653a 0a20 2020 2020  lock_size:.     
-0000a030: 2020 2020 2020 2020 2020 2067 726f 7570             group
-0000a040: 732e 6170 7065 6e64 2863 7572 7265 6e74  s.append(current
-0000a050: 5f67 726f 7570 290a 2020 2020 2020 2020  _group).        
-0000a060: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-0000a070: 6772 6f75 702c 2063 7572 7265 6e74 5f67  group, current_g
-0000a080: 726f 7570 5f73 697a 6520 3d20 5b5d 2c20  roup_size = [], 
-0000a090: 300a 2020 2020 6966 2063 7572 7265 6e74  0.    if current
-0000a0a0: 5f67 726f 7570 3a0a 2020 2020 2020 2020  _group:.        
-0000a0b0: 6772 6f75 7073 2e61 7070 656e 6428 6375  groups.append(cu
-0000a0c0: 7272 656e 745f 6772 6f75 7029 0a20 2020  rrent_group).   
-0000a0d0: 2072 6574 7572 6e20 6772 6f75 7073 0a0a   return groups..
-0000a0e0: 0a64 6566 2073 335f 636f 6e63 6174 280a  .def s3_concat(.
-0000a0f0: 2020 2020 2020 2020 7372 635f 7061 7468          src_path
-0000a100: 733a 204c 6973 745b 5061 7468 4c69 6b65  s: List[PathLike
-0000a110: 5d2c 0a20 2020 2020 2020 2064 7374 5f70  ],.        dst_p
-0000a120: 6174 683a 2050 6174 684c 696b 652c 0a20  ath: PathLike,. 
-0000a130: 2020 2020 2020 2062 6c6f 636b 5f73 697a         block_siz
-0000a140: 653a 2069 6e74 203d 2044 4546 4155 4c54  e: int = DEFAULT
-0000a150: 5f42 4c4f 434b 5f53 495a 452c 0a20 2020  _BLOCK_SIZE,.   
-0000a160: 2020 2020 206d 6178 5f77 6f72 6b65 7273       max_workers
-0000a170: 3a20 696e 7420 3d20 474c 4f42 414c 5f4d  : int = GLOBAL_M
-0000a180: 4158 5f57 4f52 4b45 5253 2920 2d3e 204e  AX_WORKERS) -> N
-0000a190: 6f6e 653a 0a20 2020 2027 2727 436f 6e63  one:.    '''Conc
-0000a1a0: 6174 656e 6174 6520 7333 2066 696c 6573  atenate s3 files
-0000a1b0: 2074 6f20 6f6e 6520 6669 6c65 2e0a 0a20   to one file... 
-0000a1c0: 2020 203a 7061 7261 6d20 7372 635f 7061     :param src_pa
-0000a1d0: 7468 733a 2047 6976 656e 2073 6f75 7263  ths: Given sourc
-0000a1e0: 6520 7061 7468 730a 2020 2020 3a70 6172  e paths.    :par
-0000a1f0: 616d 2064 7374 5f70 6174 683a 2047 6976  am dst_path: Giv
-0000a200: 656e 2064 6573 7469 6e61 7469 6f6e 2070  en destination p
-0000a210: 6174 680a 2020 2020 2727 270a 2020 2020  ath.    '''.    
-0000a220: 636c 6965 6e74 203d 2053 3350 6174 6828  client = S3Path(
-0000a230: 6473 745f 7061 7468 292e 5f63 6c69 656e  dst_path)._clien
-0000a240: 740a 2020 2020 7769 7468 2072 6169 7365  t.    with raise
-0000a250: 5f73 335f 6572 726f 7228 6473 745f 7061  _s3_error(dst_pa
-0000a260: 7468 293a 0a20 2020 2020 2020 2069 6620  th):.        if 
-0000a270: 626c 6f63 6b5f 7369 7a65 203d 3d20 303a  block_size == 0:
-0000a280: 2020 2320 7072 6167 6d61 3a20 6e6f 2063    # pragma: no c
-0000a290: 6f76 6572 0a20 2020 2020 2020 2020 2020  over.           
-0000a2a0: 2067 726f 7570 7320 3d20 5b5b 2873 7263   groups = [[(src
-0000a2b0: 5f70 6174 682c 204e 6f6e 6529 5d20 666f  _path, None)] fo
-0000a2c0: 7220 7372 635f 7061 7468 2069 6e20 7372  r src_path in sr
-0000a2d0: 635f 7061 7468 735d 0a20 2020 2020 2020  c_paths].       
-0000a2e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000a2f0: 2020 2067 726f 7570 7320 3d20 5f67 726f     groups = _gro
-0000a300: 7570 5f73 7263 5f70 6174 6873 5f62 795f  up_src_paths_by_
-0000a310: 626c 6f63 6b28 7372 635f 7061 7468 732c  block(src_paths,
-0000a320: 2062 6c6f 636b 5f73 697a 653d 626c 6f63   block_size=bloc
-0000a330: 6b5f 7369 7a65 290a 0a20 2020 2020 2020  k_size)..       
-0000a340: 2077 6974 6820 4d75 6c74 6950 6172 7457   with MultiPartW
-0000a350: 7269 7465 7228 636c 6965 6e74 2c20 6473  riter(client, ds
-0000a360: 745f 7061 7468 2920 6173 2077 7269 7465  t_path) as write
-0000a370: 722c 2054 6872 6561 6450 6f6f 6c45 7865  r, ThreadPoolExe
-0000a380: 6375 746f 7228 0a20 2020 2020 2020 2020  cutor(.         
-0000a390: 2020 2020 2020 206d 6178 5f77 6f72 6b65         max_worke
-0000a3a0: 7273 3d6d 6178 5f77 6f72 6b65 7273 2920  rs=max_workers) 
-0000a3b0: 6173 2065 7865 6375 746f 723a 0a20 2020  as executor:.   
-0000a3c0: 2020 2020 2020 2020 2066 6f72 2069 6e64           for ind
-0000a3d0: 6578 2c20 6772 6f75 7020 696e 2065 6e75  ex, group in enu
-0000a3e0: 6d65 7261 7465 2867 726f 7570 732c 2073  merate(groups, s
-0000a3f0: 7461 7274 3d31 293a 0a20 2020 2020 2020  tart=1):.       
-0000a400: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-0000a410: 6772 6f75 7029 203d 3d20 313a 0a20 2020  group) == 1:.   
-0000a420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a430: 2065 7865 6375 746f 722e 7375 626d 6974   executor.submit
-0000a440: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000a450: 2020 2020 2020 2020 2020 7772 6974 6572            writer
-0000a460: 2e75 706c 6f61 645f 7061 7274 5f63 6f70  .upload_part_cop
-0000a470: 792c 2069 6e64 6578 2c20 6772 6f75 705b  y, index, group[
-0000a480: 305d 5b30 5d2c 0a20 2020 2020 2020 2020  0][0],.         
-0000a490: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0000a4a0: 726f 7570 5b30 5d5b 315d 290a 2020 2020  roup[0][1]).    
-0000a4b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000a4c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a4d0: 2020 2020 2020 6578 6563 7574 6f72 2e73        executor.s
-0000a4e0: 7562 6d69 7428 7772 6974 6572 2e75 706c  ubmit(writer.upl
-0000a4f0: 6f61 645f 7061 7274 5f62 795f 7061 7468  oad_part_by_path
-0000a500: 732c 2069 6e64 6578 2c20 6772 6f75 7029  s, index, group)
-0000a510: 0a0a 0a40 536d 6172 7450 6174 682e 7265  ...@SmartPath.re
-0000a520: 6769 7374 6572 0a63 6c61 7373 2053 3350  gister.class S3P
-0000a530: 6174 6828 5552 4950 6174 6829 3a0a 0a20  ath(URIPath):.. 
-0000a540: 2020 2070 726f 746f 636f 6c20 3d20 2273     protocol = "s
-0000a550: 3322 0a0a 2020 2020 6465 6620 5f5f 696e  3"..    def __in
-0000a560: 6974 5f5f 2873 656c 662c 2070 6174 683a  it__(self, path:
-0000a570: 2022 5061 7468 4c69 6b65 222c 202a 6f74   "PathLike", *ot
-0000a580: 6865 725f 7061 7468 733a 2022 5061 7468  her_paths: "Path
-0000a590: 4c69 6b65 2229 3a0a 2020 2020 2020 2020  Like"):.        
-0000a5a0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-0000a5b0: 2870 6174 682c 202a 6f74 6865 725f 7061  (path, *other_pa
-0000a5c0: 7468 7329 0a20 2020 2020 2020 2070 726f  ths).        pro
-0000a5d0: 746f 636f 6c20 3d20 7572 6c73 706c 6974  tocol = urlsplit
-0000a5e0: 2873 656c 662e 7061 7468 292e 7363 6865  (self.path).sche
-0000a5f0: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
-0000a600: 5f70 726f 746f 636f 6c5f 7769 7468 5f70  _protocol_with_p
-0000a610: 726f 6669 6c65 203d 2073 656c 662e 7072  rofile = self.pr
-0000a620: 6f74 6f63 6f6c 0a20 2020 2020 2020 2073  otocol.        s
-0000a630: 656c 662e 5f70 726f 6669 6c65 5f6e 616d  elf._profile_nam
-0000a640: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
-0000a650: 2069 6620 7072 6f74 6f63 6f6c 2e73 7461   if protocol.sta
-0000a660: 7274 7377 6974 6828 2773 332b 2729 3a0a  rtswith('s3+'):.
-0000a670: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000a680: 2e5f 7072 6f74 6f63 6f6c 5f77 6974 685f  ._protocol_with_
-0000a690: 7072 6f66 696c 6520 3d20 7072 6f74 6f63  profile = protoc
-0000a6a0: 6f6c 0a20 2020 2020 2020 2020 2020 2073  ol.            s
-0000a6b0: 656c 662e 5f70 726f 6669 6c65 5f6e 616d  elf._profile_nam
-0000a6c0: 6520 3d20 7072 6f74 6f63 6f6c 5b33 3a5d  e = protocol[3:]
-0000a6d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000a6e0: 662e 5f73 335f 7061 7468 203d 2066 2273  f._s3_path = f"s
-0000a6f0: 333a 2f2f 7b73 656c 662e 7061 7468 5b6c  3://{self.path[l
-0000a700: 656e 2870 726f 746f 636f 6c29 2b33 3a5d  en(protocol)+3:]
-0000a710: 7d22 0a20 2020 2020 2020 2065 6c69 6620  }".        elif 
-0000a720: 6e6f 7420 7072 6f74 6f63 6f6c 3a0a 2020  not protocol:.  
-0000a730: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0000a740: 7333 5f70 6174 6820 3d20 6622 7333 3a2f  s3_path = f"s3:/
-0000a750: 2f7b 7365 6c66 2e70 6174 682e 6c73 7472  /{self.path.lstr
-0000a760: 6970 2827 2f27 297d 220a 2020 2020 2020  ip('/')}".      
-0000a770: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000a780: 2020 2020 7365 6c66 2e5f 7333 5f70 6174      self._s3_pat
-0000a790: 6820 3d20 7365 6c66 2e70 6174 680a 0a20  h = self.path.. 
-0000a7a0: 2020 2040 6361 6368 6564 7072 6f70 6572     @cachedproper
-0000a7b0: 7479 0a20 2020 2064 6566 2070 6174 685f  ty.    def path_
-0000a7c0: 7769 7468 5f70 726f 746f 636f 6c28 7365  with_protocol(se
-0000a7d0: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
-0000a7e0: 2020 2020 2727 2752 6574 7572 6e20 7061      '''Return pa
-0000a7f0: 7468 2077 6974 6820 7072 6f74 6f63 6f6c  th with protocol
-0000a800: 2c20 6c69 6b65 2066 696c 653a 2f2f 2f72  , like file:///r
-0000a810: 6f6f 742c 2073 333a 2f2f 6275 636b 6574  oot, s3://bucket
-0000a820: 2f6b 6579 2727 270a 2020 2020 2020 2020  /key'''.        
-0000a830: 7061 7468 203d 2073 656c 662e 7061 7468  path = self.path
-0000a840: 0a20 2020 2020 2020 2070 726f 746f 636f  .        protoco
-0000a850: 6c5f 7072 6566 6978 203d 2073 656c 662e  l_prefix = self.
-0000a860: 5f70 726f 746f 636f 6c5f 7769 7468 5f70  _protocol_with_p
-0000a870: 726f 6669 6c65 202b 2022 3a2f 2f22 0a20  rofile + "://". 
-0000a880: 2020 2020 2020 2069 6620 7061 7468 2e73         if path.s
-0000a890: 7461 7274 7377 6974 6828 7072 6f74 6f63  tartswith(protoc
-0000a8a0: 6f6c 5f70 7265 6669 7829 3a0a 2020 2020  ol_prefix):.    
-0000a8b0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0000a8c0: 6174 680a 2020 2020 2020 2020 7265 7475  ath.        retu
-0000a8d0: 726e 2070 726f 746f 636f 6c5f 7072 6566  rn protocol_pref
-0000a8e0: 6978 202b 2070 6174 682e 6c73 7472 6970  ix + path.lstrip
-0000a8f0: 2827 2f27 290a 0a20 2020 2040 6361 6368  ('/')..    @cach
-0000a900: 6564 7072 6f70 6572 7479 0a20 2020 2064  edproperty.    d
-0000a910: 6566 2070 6174 685f 7769 7468 6f75 745f  ef path_without_
-0000a920: 7072 6f74 6f63 6f6c 2873 656c 6629 202d  protocol(self) -
-0000a930: 3e20 7374 723a 0a20 2020 2020 2020 2027  > str:.        '
-0000a940: 2727 5265 7475 726e 2070 6174 6820 7769  ''Return path wi
-0000a950: 7468 6f75 7420 7072 6f74 6f63 6f6c 2c20  thout protocol, 
-0000a960: 6578 616d 706c 653a 2069 6620 7061 7468  example: if path
-0000a970: 2069 7320 7333 3a2f 2f62 7563 6b65 742f   is s3://bucket/
-0000a980: 6b65 792c 2072 6574 7572 6e20 6275 636b  key, return buck
-0000a990: 6574 2f6b 6579 2727 270a 2020 2020 2020  et/key'''.      
-0000a9a0: 2020 7061 7468 203d 2073 656c 662e 7061    path = self.pa
-0000a9b0: 7468 0a20 2020 2020 2020 2070 726f 746f  th.        proto
-0000a9c0: 636f 6c5f 7072 6566 6978 203d 2073 656c  col_prefix = sel
-0000a9d0: 662e 5f70 726f 746f 636f 6c5f 7769 7468  f._protocol_with
-0000a9e0: 5f70 726f 6669 6c65 202b 2022 3a2f 2f22  _profile + "://"
-0000a9f0: 0a20 2020 2020 2020 2069 6620 7061 7468  .        if path
-0000aa00: 2e73 7461 7274 7377 6974 6828 7072 6f74  .startswith(prot
-0000aa10: 6f63 6f6c 5f70 7265 6669 7829 3a0a 2020  ocol_prefix):.  
-0000aa20: 2020 2020 2020 2020 2020 7061 7468 203d            path =
-0000aa30: 2070 6174 685b 6c65 6e28 7072 6f74 6f63   path[len(protoc
-0000aa40: 6f6c 5f70 7265 6669 7829 3a5d 0a20 2020  ol_prefix):].   
-0000aa50: 2020 2020 2072 6574 7572 6e20 7061 7468       return path
-0000aa60: 0a0a 2020 2020 4063 6163 6865 6470 726f  ..    @cachedpro
-0000aa70: 7065 7274 790a 2020 2020 6465 6620 5f63  perty.    def _c
-0000aa80: 6c69 656e 7428 7365 6c66 293a 0a20 2020  lient(self):.   
-0000aa90: 2020 2020 2072 6574 7572 6e20 6765 745f       return get_
-0000aaa0: 7333 5f63 6c69 656e 7428 7072 6f66 696c  s3_client(profil
-0000aab0: 655f 6e61 6d65 3d73 656c 662e 5f70 726f  e_name=self._pro
-0000aac0: 6669 6c65 5f6e 616d 6529 0a0a 2020 2020  file_name)..    
-0000aad0: 6465 6620 5f73 335f 6765 745f 6d65 7461  def _s3_get_meta
-0000aae0: 6461 7461 2873 656c 6629 202d 3e20 6469  data(self) -> di
-0000aaf0: 6374 3a0a 2020 2020 2020 2020 2727 270a  ct:.        '''.
-0000ab00: 2020 2020 2020 2020 4765 7420 6f62 6a65          Get obje
-0000ab10: 6374 206d 6574 6164 6174 610a 0a20 2020  ct metadata..   
-0000ab20: 2020 2020 203a 7061 7261 6d20 7061 7468       :param path
-0000ab30: 3a20 4f62 6a65 6374 2070 6174 680a 2020  : Object path.  
-0000ab40: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000ab50: 4f62 6a65 6374 206d 6574 6164 6174 610a  Object metadata.
-0000ab60: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000ab70: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-0000ab80: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-0000ab90: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-0000aba0: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
-0000abb0: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
-0000abc0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000abd0: 6e20 7b7d 0a20 2020 2020 2020 2069 6620  n {}.        if 
-0000abe0: 6e6f 7420 6b65 7920 6f72 206b 6579 2e65  not key or key.e
-0000abf0: 6e64 7377 6974 6828 272f 2729 3a0a 2020  ndswith('/'):.  
-0000ac00: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000ac10: 207b 7d0a 2020 2020 2020 2020 7472 793a   {}.        try:
-0000ac20: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
-0000ac30: 6820 7261 6973 655f 7333 5f65 7272 6f72  h raise_s3_error
-0000ac40: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
-0000ac50: 7072 6f74 6f63 6f6c 293a 0a20 2020 2020  protocol):.     
-0000ac60: 2020 2020 2020 2020 2020 2072 6573 7020             resp 
-0000ac70: 3d20 7365 6c66 2e5f 636c 6965 6e74 2e68  = self._client.h
-0000ac80: 6561 645f 6f62 6a65 6374 2842 7563 6b65  ead_object(Bucke
-0000ac90: 743d 6275 636b 6574 2c20 4b65 793d 6b65  t=bucket, Key=ke
-0000aca0: 7929 0a20 2020 2020 2020 2020 2020 2072  y).            r
-0000acb0: 6574 7572 6e20 6469 6374 280a 2020 2020  eturn dict(.    
-0000acc0: 2020 2020 2020 2020 2020 2020 286b 6579              (key
-0000acd0: 2e6c 6f77 6572 2829 2c20 7661 6c75 6529  .lower(), value)
-0000ace0: 2066 6f72 206b 6579 2c20 7661 6c75 6520   for key, value 
-0000acf0: 696e 2072 6573 705b 274d 6574 6164 6174  in resp['Metadat
-0000ad00: 6127 5d2e 6974 656d 7328 2929 0a20 2020  a'].items()).   
-0000ad10: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-0000ad20: 7074 696f 6e20 6173 2065 7272 6f72 3a0a  ption as error:.
-0000ad30: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000ad40: 7369 6e73 7461 6e63 6528 6572 726f 722c  sinstance(error,
-0000ad50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ad60: 2020 2020 2020 2020 2020 2028 5333 556e             (S3Un
-0000ad70: 6b6e 6f77 6e45 7272 6f72 2c20 5333 436f  knownError, S3Co
-0000ad80: 6e66 6967 4572 726f 722c 2053 3350 6572  nfigError, S3Per
-0000ad90: 6d69 7373 696f 6e45 7272 6f72 2929 3a0a  missionError)):.
-0000ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000adb0: 7261 6973 6520 6572 726f 720a 2020 2020  raise error.    
-0000adc0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0000add0: 7d0a 0a20 2020 2064 6566 2061 6363 6573  }..    def acces
-0000ade0: 7328 0a20 2020 2020 2020 2020 2020 2073  s(.            s
-0000adf0: 656c 662c 206d 6f64 653a 2041 6363 6573  elf, mode: Acces
-0000ae00: 7320 3d20 4163 6365 7373 2e52 4541 442c  s = Access.READ,
-0000ae10: 0a20 2020 2020 2020 2020 2020 2066 6f6c  .            fol
-0000ae20: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-0000ae30: 2046 616c 7365 2920 2d3e 2062 6f6f 6c3a   False) -> bool:
-0000ae40: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000ae50: 2020 2020 2054 6573 7420 6966 2070 6174       Test if pat
-0000ae60: 6820 6861 7320 6163 6365 7373 2070 6572  h has access per
-0000ae70: 6d69 7373 696f 6e20 6465 7363 7269 6265  mission describe
-0000ae80: 6420 6279 206d 6f64 650a 2020 2020 2020  d by mode.      
-0000ae90: 2020 5573 696e 6720 6865 6164 5f62 7563    Using head_buc
-0000aea0: 6b65 7428 292c 206e 6f77 2052 4541 442f  ket(), now READ/
-0000aeb0: 5752 4954 4520 6172 6520 7361 6d65 2e0a  WRITE are same..
-0000aec0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000aed0: 6d6f 6465 3a20 6163 6365 7373 206d 6f64  mode: access mod
-0000aee0: 650a 2020 2020 2020 2020 3a72 6574 7572  e.        :retur
-0000aef0: 6e73 3a20 626f 6f6c 2c20 6966 2074 6865  ns: bool, if the
-0000af00: 2062 7563 6b65 7420 6f66 2073 335f 7572   bucket of s3_ur
-0000af10: 6c20 6861 7320 7265 6164 2f77 7269 7465  l has read/write
-0000af20: 2061 6363 6573 732e 0a20 2020 2020 2020   access..       
-0000af30: 2027 2727 0a20 2020 2020 2020 2073 335f   '''.        s3_
-0000af40: 7572 6c20 3d20 7365 6c66 2e70 6174 685f  url = self.path_
-0000af50: 7769 7468 5f70 726f 746f 636f 6c0a 2020  with_protocol.  
-0000af60: 2020 2020 2020 6966 2066 6f6c 6c6f 776c        if followl
-0000af70: 696e 6b73 3a0a 2020 2020 2020 2020 2020  inks:.          
-0000af80: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000af90: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
-0000afa0: 7365 6c66 2e72 6561 646c 696e 6b28 292e  self.readlink().
-0000afb0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000afc0: 6f6c 0a20 2020 2020 2020 2020 2020 2065  ol.            e
-0000afd0: 7863 6570 7420 5333 4e6f 7441 4c69 6e6b  xcept S3NotALink
-0000afe0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0000aff0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-0000b000: 2020 2020 6275 636b 6574 2c20 5f20 3d20      bucket, _ = 
-0000b010: 7061 7273 655f 7333 5f75 726c 2873 335f  parse_s3_url(s3_
-0000b020: 7572 6c29 2020 2320 6f6e 6c79 2063 6865  url)  # only che
-0000b030: 636b 2062 7563 6b65 7420 6163 6365 7373  ck bucket access
-0000b040: 6962 696c 6974 790a 2020 2020 2020 2020  ibility.        
-0000b050: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
-0000b060: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000b070: 2045 7863 6570 7469 6f6e 2822 4e6f 2061   Exception("No a
-0000b080: 7661 696c 6162 6c65 2062 7563 6b65 7422  vailable bucket"
-0000b090: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0000b0a0: 2069 7369 6e73 7461 6e63 6528 6d6f 6465   isinstance(mode
-0000b0b0: 2c20 4163 6365 7373 293a 0a20 2020 2020  , Access):.     
-0000b0c0: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
-0000b0d0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
-0000b0e0: 2020 2020 2020 2020 2755 6e73 7570 706f          'Unsuppo
-0000b0f0: 7274 6564 206d 6f64 653a 207b 7d20 2d2d  rted mode: {} --
-0000b100: 204d 6f64 6520 7368 6f75 6c64 2075 7365   Mode should use
-0000b110: 206f 6e65 206f 6620 7468 6520 656e 756d   one of the enum
-0000b120: 7320 6265 6c6f 6e67 696e 6720 746f 3a20  s belonging to: 
-0000b130: 207b 7d27 0a20 2020 2020 2020 2020 2020   {}'.           
-0000b140: 2020 2020 202e 666f 726d 6174 286d 6f64       .format(mod
-0000b150: 652c 2027 2c20 272e 6a6f 696e 285b 7374  e, ', '.join([st
-0000b160: 7228 6129 2066 6f72 2061 2069 6e20 4163  r(a) for a in Ac
-0000b170: 6365 7373 5d29 2929 0a20 2020 2020 2020  cess]))).       
-0000b180: 2069 6620 6d6f 6465 206e 6f74 2069 6e20   if mode not in 
-0000b190: 2841 6363 6573 732e 5245 4144 2c20 4163  (Access.READ, Ac
-0000b1a0: 6365 7373 2e57 5249 5445 293a 0a20 2020  cess.WRITE):.   
-0000b1b0: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-0000b1c0: 7970 6545 7272 6f72 2827 556e 7375 7070  ypeError('Unsupp
-0000b1d0: 6f72 7465 6420 6d6f 6465 3a20 7b7d 272e  orted mode: {}'.
-0000b1e0: 666f 726d 6174 286d 6f64 6529 290a 2020  format(mode)).  
-0000b1f0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000b200: 2020 2020 2020 2073 656c 662e 5f63 6c69         self._cli
-0000b210: 656e 742e 6865 6164 5f62 7563 6b65 7428  ent.head_bucket(
-0000b220: 4275 636b 6574 3d62 7563 6b65 7429 0a20  Bucket=bucket). 
-0000b230: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0000b240: 6365 7074 696f 6e20 6173 2065 7272 6f72  ception as error
-0000b250: 3a0a 2020 2020 2020 2020 2020 2020 6572  :.            er
-0000b260: 726f 7220 3d20 7472 616e 736c 6174 655f  ror = translate_
-0000b270: 7333 5f65 7272 6f72 2865 7272 6f72 2c20  s3_error(error, 
-0000b280: 7333 5f75 726c 290a 2020 2020 2020 2020  s3_url).        
-0000b290: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-0000b2a0: 6528 6572 726f 722c 2028 5333 5065 726d  e(error, (S3Perm
-0000b2b0: 6973 7369 6f6e 4572 726f 722c 2053 3346  issionError, S3F
-0000b2c0: 696c 654e 6f74 466f 756e 6445 7272 6f72  ileNotFoundError
-0000b2d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000097e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097f0: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
+00009800: 3d66 6f6c 6c6f 776c 696e 6b73 293a 0a20  =followlinks):. 
+00009810: 2020 2020 2020 2079 6965 6c64 2070 6174         yield pat
+00009820: 685f 6f62 6a2e 7061 7468 5f77 6974 685f  h_obj.path_with_
+00009830: 7072 6f74 6f63 6f6c 0a0a 0a64 6566 2073  protocol...def s
+00009840: 335f 6d61 6b65 6469 7273 2870 6174 683a  3_makedirs(path:
+00009850: 2050 6174 684c 696b 652c 2065 7869 7374   PathLike, exist
+00009860: 5f6f 6b3a 2062 6f6f 6c20 3d20 4661 6c73  _ok: bool = Fals
+00009870: 6529 3a0a 2020 2020 2727 270a 2020 2020  e):.    '''.    
+00009880: 4372 6561 7465 2061 6e20 7333 2064 6972  Create an s3 dir
+00009890: 6563 746f 7279 2e0a 2020 2020 5075 7265  ectory..    Pure
+000098a0: 6c79 2063 7265 6174 696e 6720 6469 7265  ly creating dire
+000098b0: 6374 6f72 7920 6973 2069 6e76 616c 6964  ctory is invalid
+000098c0: 2062 6563 6175 7365 2069 7427 7320 756e   because it's un
+000098d0: 6176 6169 6c61 626c 6520 6f6e 204f 5353  available on OSS
+000098e0: 2e0a 2020 2020 5468 6973 2066 756e 6374  ..    This funct
+000098f0: 696f 6e20 6973 2074 6f20 7465 7374 2074  ion is to test t
+00009900: 6865 2074 6172 6765 7420 6275 636b 6574  he target bucket
+00009910: 2068 6176 6520 5752 4954 4520 6163 6365   have WRITE acce
+00009920: 7373 2e0a 0a20 2020 203a 7061 7261 6d20  ss...    :param 
+00009930: 7061 7468 3a20 4769 7665 6e20 7061 7468  path: Given path
+00009940: 0a20 2020 203a 7061 7261 6d20 6578 6973  .    :param exis
+00009950: 745f 6f6b 3a20 4966 2046 616c 7365 2061  t_ok: If False a
+00009960: 6e64 2074 6172 6765 7420 6469 7265 6374  nd target direct
+00009970: 6f72 7920 6578 6973 7473 2c20 7261 6973  ory exists, rais
+00009980: 6520 5333 4669 6c65 4578 6973 7473 4572  e S3FileExistsEr
+00009990: 726f 720a 2020 2020 3a72 6169 7365 733a  ror.    :raises:
+000099a0: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
+000099b0: 6445 7272 6f72 2c20 5333 4669 6c65 4578  dError, S3FileEx
+000099c0: 6973 7473 4572 726f 720a 2020 2020 2727  istsError.    ''
+000099d0: 270a 2020 2020 7265 7475 726e 2053 3350  '.    return S3P
+000099e0: 6174 6828 7061 7468 292e 6d6b 6469 7228  ath(path).mkdir(
+000099f0: 7061 7265 6e74 733d 5472 7565 2c20 6578  parents=True, ex
+00009a00: 6973 745f 6f6b 3d65 7869 7374 5f6f 6b29  ist_ok=exist_ok)
+00009a10: 0a0a 0a64 6566 205f 6772 6f75 705f 7372  ...def _group_sr
+00009a20: 635f 7061 7468 735f 6279 5f62 6c6f 636b  c_paths_by_block
+00009a30: 280a 2020 2020 2020 2020 7372 635f 7061  (.        src_pa
+00009a40: 7468 733a 204c 6973 745b 5061 7468 4c69  ths: List[PathLi
+00009a50: 6b65 5d2c 2062 6c6f 636b 5f73 697a 653a  ke], block_size:
+00009a60: 2069 6e74 203d 2044 4546 4155 4c54 5f42   int = DEFAULT_B
+00009a70: 4c4f 434b 5f53 495a 450a 2920 2d3e 204c  LOCK_SIZE.) -> L
+00009a80: 6973 745b 4c69 7374 5b54 7570 6c65 5b50  ist[List[Tuple[P
+00009a90: 6174 684c 696b 652c 204f 7074 696f 6e61  athLike, Optiona
+00009aa0: 6c5b 7374 725d 5d5d 5d3a 0a20 2020 2067  l[str]]]]:.    g
+00009ab0: 726f 7570 7320 3d20 5b5d 0a20 2020 2063  roups = [].    c
+00009ac0: 7572 7265 6e74 5f67 726f 7570 2c20 6375  urrent_group, cu
+00009ad0: 7272 656e 745f 6772 6f75 705f 7369 7a65  rrent_group_size
+00009ae0: 203d 205b 5d2c 2030 0a20 2020 2066 6f72   = [], 0.    for
+00009af0: 2073 7263 5f70 6174 6820 696e 2073 7263   src_path in src
+00009b00: 5f70 6174 6873 3a0a 2020 2020 2020 2020  _paths:.        
+00009b10: 6375 7272 656e 745f 6669 6c65 5f73 697a  current_file_siz
+00009b20: 6520 3d20 5333 5061 7468 2873 7263 5f70  e = S3Path(src_p
+00009b30: 6174 6829 2e73 7461 7428 292e 7369 7a65  ath).stat().size
+00009b40: 0a20 2020 2020 2020 2069 6620 6375 7272  .        if curr
+00009b50: 656e 745f 6669 6c65 5f73 697a 6520 3d3d  ent_file_size ==
+00009b60: 2030 3a20 2023 2070 7261 676d 613a 206e   0:  # pragma: n
+00009b70: 6f20 636f 7665 720a 2020 2020 2020 2020  o cover.        
+00009b80: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+00009b90: 2020 2020 2020 6966 2063 7572 7265 6e74        if current
+00009ba0: 5f66 696c 655f 7369 7a65 203e 3d20 626c  _file_size >= bl
+00009bb0: 6f63 6b5f 7369 7a65 3a0a 2020 2020 2020  ock_size:.      
+00009bc0: 2020 2020 2020 6966 206c 656e 2867 726f        if len(gro
+00009bd0: 7570 7329 203d 3d20 303a 0a20 2020 2020  ups) == 0:.     
+00009be0: 2020 2020 2020 2020 2020 2069 6620 6375             if cu
+00009bf0: 7272 656e 745f 6772 6f75 705f 7369 7a65  rrent_group_size
+00009c00: 202b 2063 7572 7265 6e74 5f66 696c 655f   + current_file_
+00009c10: 7369 7a65 203e 2032 202a 2062 6c6f 636b  size > 2 * block
+00009c20: 5f73 697a 653a 0a20 2020 2020 2020 2020  _size:.         
+00009c30: 2020 2020 2020 2020 2020 2067 726f 7570             group
+00009c40: 5f6c 6163 6b5f 7369 7a65 203d 2062 6c6f  _lack_size = blo
+00009c50: 636b 5f73 697a 6520 2d20 6375 7272 656e  ck_size - curren
+00009c60: 745f 6772 6f75 705f 7369 7a65 0a20 2020  t_group_size.   
+00009c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c80: 2063 7572 7265 6e74 5f67 726f 7570 2e61   current_group.a
+00009c90: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
+00009ca0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00009cb0: 7372 635f 7061 7468 2c20 6627 6279 7465  src_path, f'byte
+00009cc0: 733d 302d 7b67 726f 7570 5f6c 6163 6b5f  s=0-{group_lack_
+00009cd0: 7369 7a65 2d31 7d27 2929 0a20 2020 2020  size-1}')).     
+00009ce0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00009cf0: 726f 7570 732e 6578 7465 6e64 280a 2020  roups.extend(.  
+00009d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d10: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00009d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d30: 2020 2020 6375 7272 656e 745f 6772 6f75      current_grou
+00009d40: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
+00009d50: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+00009d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d80: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00009d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009da0: 2020 2020 2020 2073 7263 5f70 6174 682c         src_path,
+00009db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009dd0: 2020 2020 2066 2762 7974 6573 3d7b 6772       f'bytes={gr
+00009de0: 6f75 705f 6c61 636b 5f73 697a 657d 2d7b  oup_lack_size}-{
+00009df0: 6375 7272 656e 745f 6669 6c65 5f73 697a  current_file_siz
+00009e00: 652d 317d 270a 2020 2020 2020 2020 2020  e-1}'.          
+00009e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e20: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00009e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e40: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+00009e50: 2020 2020 2020 2020 2020 2020 2020 5d29                ])
+00009e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009e70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00009e80: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+00009e90: 6e74 5f67 726f 7570 2e61 7070 656e 6428  nt_group.append(
+00009ea0: 2873 7263 5f70 6174 682c 204e 6f6e 6529  (src_path, None)
+00009eb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00009ec0: 2020 2020 2020 6772 6f75 7073 2e61 7070        groups.app
+00009ed0: 656e 6428 6375 7272 656e 745f 6772 6f75  end(current_grou
+00009ee0: 7029 0a20 2020 2020 2020 2020 2020 2065  p).            e
+00009ef0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00009f00: 2020 2020 2067 726f 7570 735b 2d31 5d2e       groups[-1].
+00009f10: 6578 7465 6e64 2863 7572 7265 6e74 5f67  extend(current_g
+00009f20: 726f 7570 290a 2020 2020 2020 2020 2020  roup).          
+00009f30: 2020 2020 2020 6772 6f75 7073 2e61 7070        groups.app
+00009f40: 656e 6428 5b28 7372 635f 7061 7468 2c20  end([(src_path, 
+00009f50: 4e6f 6e65 295d 290a 2020 2020 2020 2020  None)]).        
+00009f60: 2020 2020 6375 7272 656e 745f 6772 6f75      current_grou
+00009f70: 702c 2063 7572 7265 6e74 5f67 726f 7570  p, current_group
+00009f80: 5f73 697a 6520 3d20 5b5d 2c20 300a 2020  _size = [], 0.  
+00009f90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00009fa0: 2020 2020 2020 2020 6375 7272 656e 745f          current_
+00009fb0: 6772 6f75 702e 6170 7065 6e64 2828 7372  group.append((sr
+00009fc0: 635f 7061 7468 2c20 4e6f 6e65 2929 0a20  c_path, None)). 
+00009fd0: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+00009fe0: 6e74 5f67 726f 7570 5f73 697a 6520 2b3d  nt_group_size +=
+00009ff0: 2063 7572 7265 6e74 5f66 696c 655f 7369   current_file_si
+0000a000: 7a65 0a20 2020 2020 2020 2020 2020 2069  ze.            i
+0000a010: 6620 6375 7272 656e 745f 6772 6f75 705f  f current_group_
+0000a020: 7369 7a65 203e 3d20 626c 6f63 6b5f 7369  size >= block_si
+0000a030: 7a65 3a0a 2020 2020 2020 2020 2020 2020  ze:.            
+0000a040: 2020 2020 6772 6f75 7073 2e61 7070 656e      groups.appen
+0000a050: 6428 6375 7272 656e 745f 6772 6f75 7029  d(current_group)
+0000a060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a070: 2063 7572 7265 6e74 5f67 726f 7570 2c20   current_group, 
+0000a080: 6375 7272 656e 745f 6772 6f75 705f 7369  current_group_si
+0000a090: 7a65 203d 205b 5d2c 2030 0a20 2020 2069  ze = [], 0.    i
+0000a0a0: 6620 6375 7272 656e 745f 6772 6f75 703a  f current_group:
+0000a0b0: 0a20 2020 2020 2020 2067 726f 7570 732e  .        groups.
+0000a0c0: 6170 7065 6e64 2863 7572 7265 6e74 5f67  append(current_g
+0000a0d0: 726f 7570 290a 2020 2020 7265 7475 726e  roup).    return
+0000a0e0: 2067 726f 7570 730a 0a0a 6465 6620 7333   groups...def s3
+0000a0f0: 5f63 6f6e 6361 7428 0a20 2020 2020 2020  _concat(.       
+0000a100: 2073 7263 5f70 6174 6873 3a20 4c69 7374   src_paths: List
+0000a110: 5b50 6174 684c 696b 655d 2c0a 2020 2020  [PathLike],.    
+0000a120: 2020 2020 6473 745f 7061 7468 3a20 5061      dst_path: Pa
+0000a130: 7468 4c69 6b65 2c0a 2020 2020 2020 2020  thLike,.        
+0000a140: 626c 6f63 6b5f 7369 7a65 3a20 696e 7420  block_size: int 
+0000a150: 3d20 4445 4641 554c 545f 424c 4f43 4b5f  = DEFAULT_BLOCK_
+0000a160: 5349 5a45 2c0a 2020 2020 2020 2020 6d61  SIZE,.        ma
+0000a170: 785f 776f 726b 6572 733a 2069 6e74 203d  x_workers: int =
+0000a180: 2047 4c4f 4241 4c5f 4d41 585f 574f 524b   GLOBAL_MAX_WORK
+0000a190: 4552 5329 202d 3e20 4e6f 6e65 3a0a 2020  ERS) -> None:.  
+0000a1a0: 2020 2727 2743 6f6e 6361 7465 6e61 7465    '''Concatenate
+0000a1b0: 2073 3320 6669 6c65 7320 746f 206f 6e65   s3 files to one
+0000a1c0: 2066 696c 652e 0a0a 2020 2020 3a70 6172   file...    :par
+0000a1d0: 616d 2073 7263 5f70 6174 6873 3a20 4769  am src_paths: Gi
+0000a1e0: 7665 6e20 736f 7572 6365 2070 6174 6873  ven source paths
+0000a1f0: 0a20 2020 203a 7061 7261 6d20 6473 745f  .    :param dst_
+0000a200: 7061 7468 3a20 4769 7665 6e20 6465 7374  path: Given dest
+0000a210: 696e 6174 696f 6e20 7061 7468 0a20 2020  ination path.   
+0000a220: 2027 2727 0a20 2020 2063 6c69 656e 7420   '''.    client 
+0000a230: 3d20 5333 5061 7468 2864 7374 5f70 6174  = S3Path(dst_pat
+0000a240: 6829 2e5f 636c 6965 6e74 0a20 2020 2077  h)._client.    w
+0000a250: 6974 6820 7261 6973 655f 7333 5f65 7272  ith raise_s3_err
+0000a260: 6f72 2864 7374 5f70 6174 6829 3a0a 2020  or(dst_path):.  
+0000a270: 2020 2020 2020 6966 2062 6c6f 636b 5f73        if block_s
+0000a280: 697a 6520 3d3d 2030 3a20 2023 2070 7261  ize == 0:  # pra
+0000a290: 676d 613a 206e 6f20 636f 7665 720a 2020  gma: no cover.  
+0000a2a0: 2020 2020 2020 2020 2020 6772 6f75 7073            groups
+0000a2b0: 203d 205b 5b28 7372 635f 7061 7468 2c20   = [[(src_path, 
+0000a2c0: 4e6f 6e65 295d 2066 6f72 2073 7263 5f70  None)] for src_p
+0000a2d0: 6174 6820 696e 2073 7263 5f70 6174 6873  ath in src_paths
+0000a2e0: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
+0000a2f0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0000a300: 7073 203d 205f 6772 6f75 705f 7372 635f  ps = _group_src_
+0000a310: 7061 7468 735f 6279 5f62 6c6f 636b 2873  paths_by_block(s
+0000a320: 7263 5f70 6174 6873 2c20 626c 6f63 6b5f  rc_paths, block_
+0000a330: 7369 7a65 3d62 6c6f 636b 5f73 697a 6529  size=block_size)
+0000a340: 0a0a 2020 2020 2020 2020 7769 7468 204d  ..        with M
+0000a350: 756c 7469 5061 7274 5772 6974 6572 2863  ultiPartWriter(c
+0000a360: 6c69 656e 742c 2064 7374 5f70 6174 6829  lient, dst_path)
+0000a370: 2061 7320 7772 6974 6572 2c20 5468 7265   as writer, Thre
+0000a380: 6164 506f 6f6c 4578 6563 7574 6f72 280a  adPoolExecutor(.
+0000a390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3a0: 6d61 785f 776f 726b 6572 733d 6d61 785f  max_workers=max_
+0000a3b0: 776f 726b 6572 7329 2061 7320 6578 6563  workers) as exec
+0000a3c0: 7574 6f72 3a0a 2020 2020 2020 2020 2020  utor:.          
+0000a3d0: 2020 666f 7220 696e 6465 782c 2067 726f    for index, gro
+0000a3e0: 7570 2069 6e20 656e 756d 6572 6174 6528  up in enumerate(
+0000a3f0: 6772 6f75 7073 2c20 7374 6172 743d 3129  groups, start=1)
+0000a400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a410: 2020 6966 206c 656e 2867 726f 7570 2920    if len(group) 
+0000a420: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+0000a430: 2020 2020 2020 2020 2020 6578 6563 7574            execut
+0000a440: 6f72 2e73 7562 6d69 7428 0a20 2020 2020  or.submit(.     
+0000a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a460: 2020 2077 7269 7465 722e 7570 6c6f 6164     writer.upload
+0000a470: 5f70 6172 745f 636f 7079 2c20 696e 6465  _part_copy, inde
+0000a480: 782c 2067 726f 7570 5b30 5d5b 305d 2c0a  x, group[0][0],.
+0000a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a4a0: 2020 2020 2020 2020 6772 6f75 705b 305d          group[0]
+0000a4b0: 5b31 5d29 0a20 2020 2020 2020 2020 2020  [1]).           
+0000a4c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000a4d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000a4e0: 7865 6375 746f 722e 7375 626d 6974 2877  xecutor.submit(w
+0000a4f0: 7269 7465 722e 7570 6c6f 6164 5f70 6172  riter.upload_par
+0000a500: 745f 6279 5f70 6174 6873 2c20 696e 6465  t_by_paths, inde
+0000a510: 782c 2067 726f 7570 290a 0a0a 4053 6d61  x, group)...@Sma
+0000a520: 7274 5061 7468 2e72 6567 6973 7465 720a  rtPath.register.
+0000a530: 636c 6173 7320 5333 5061 7468 2855 5249  class S3Path(URI
+0000a540: 5061 7468 293a 0a0a 2020 2020 7072 6f74  Path):..    prot
+0000a550: 6f63 6f6c 203d 2022 7333 220a 0a20 2020  ocol = "s3"..   
+0000a560: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0000a570: 6c66 2c20 7061 7468 3a20 2250 6174 684c  lf, path: "PathL
+0000a580: 696b 6522 2c20 2a6f 7468 6572 5f70 6174  ike", *other_pat
+0000a590: 6873 3a20 2250 6174 684c 696b 6522 293a  hs: "PathLike"):
+0000a5a0: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+0000a5b0: 2e5f 5f69 6e69 745f 5f28 7061 7468 2c20  .__init__(path, 
+0000a5c0: 2a6f 7468 6572 5f70 6174 6873 290a 2020  *other_paths).  
+0000a5d0: 2020 2020 2020 7072 6f74 6f63 6f6c 203d        protocol =
+0000a5e0: 2067 6574 5f75 726c 5f73 6368 656d 6528   get_url_scheme(
+0000a5f0: 7365 6c66 2e70 6174 6829 0a20 2020 2020  self.path).     
+0000a600: 2020 2073 656c 662e 5f70 726f 746f 636f     self._protoco
+0000a610: 6c5f 7769 7468 5f70 726f 6669 6c65 203d  l_with_profile =
+0000a620: 2073 656c 662e 7072 6f74 6f63 6f6c 0a20   self.protocol. 
+0000a630: 2020 2020 2020 2073 656c 662e 5f70 726f         self._pro
+0000a640: 6669 6c65 5f6e 616d 6520 3d20 4e6f 6e65  file_name = None
+0000a650: 0a20 2020 2020 2020 2069 6620 7072 6f74  .        if prot
+0000a660: 6f63 6f6c 2e73 7461 7274 7377 6974 6828  ocol.startswith(
+0000a670: 2773 332b 2729 3a0a 2020 2020 2020 2020  's3+'):.        
+0000a680: 2020 2020 7365 6c66 2e5f 7072 6f74 6f63      self._protoc
+0000a690: 6f6c 5f77 6974 685f 7072 6f66 696c 6520  ol_with_profile 
+0000a6a0: 3d20 7072 6f74 6f63 6f6c 0a20 2020 2020  = protocol.     
+0000a6b0: 2020 2020 2020 2073 656c 662e 5f70 726f         self._pro
+0000a6c0: 6669 6c65 5f6e 616d 6520 3d20 7072 6f74  file_name = prot
+0000a6d0: 6f63 6f6c 5b33 3a5d 0a20 2020 2020 2020  ocol[3:].       
+0000a6e0: 2020 2020 2073 656c 662e 5f73 335f 7061       self._s3_pa
+0000a6f0: 7468 203d 2066 2273 333a 2f2f 7b73 656c  th = f"s3://{sel
+0000a700: 662e 7061 7468 5b6c 656e 2870 726f 746f  f.path[len(proto
+0000a710: 636f 6c29 2b33 3a5d 7d22 0a20 2020 2020  col)+3:]}".     
+0000a720: 2020 2065 6c69 6620 6e6f 7420 7072 6f74     elif not prot
+0000a730: 6f63 6f6c 3a0a 2020 2020 2020 2020 2020  ocol:.          
+0000a740: 2020 7365 6c66 2e5f 7333 5f70 6174 6820    self._s3_path 
+0000a750: 3d20 6622 7333 3a2f 2f7b 7365 6c66 2e70  = f"s3://{self.p
+0000a760: 6174 682e 6c73 7472 6970 2827 2f27 297d  ath.lstrip('/')}
+0000a770: 220a 2020 2020 2020 2020 656c 7365 3a0a  ".        else:.
+0000a780: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000a790: 2e5f 7333 5f70 6174 6820 3d20 7365 6c66  ._s3_path = self
+0000a7a0: 2e70 6174 680a 0a20 2020 2040 6361 6368  .path..    @cach
+0000a7b0: 6564 7072 6f70 6572 7479 0a20 2020 2064  edproperty.    d
+0000a7c0: 6566 2070 6174 685f 7769 7468 5f70 726f  ef path_with_pro
+0000a7d0: 746f 636f 6c28 7365 6c66 2920 2d3e 2073  tocol(self) -> s
+0000a7e0: 7472 3a0a 2020 2020 2020 2020 2727 2752  tr:.        '''R
+0000a7f0: 6574 7572 6e20 7061 7468 2077 6974 6820  eturn path with 
+0000a800: 7072 6f74 6f63 6f6c 2c20 6c69 6b65 2066  protocol, like f
+0000a810: 696c 653a 2f2f 2f72 6f6f 742c 2073 333a  ile:///root, s3:
+0000a820: 2f2f 6275 636b 6574 2f6b 6579 2727 270a  //bucket/key'''.
+0000a830: 2020 2020 2020 2020 7061 7468 203d 2073          path = s
+0000a840: 656c 662e 7061 7468 0a20 2020 2020 2020  elf.path.       
+0000a850: 2070 726f 746f 636f 6c5f 7072 6566 6978   protocol_prefix
+0000a860: 203d 2073 656c 662e 5f70 726f 746f 636f   = self._protoco
+0000a870: 6c5f 7769 7468 5f70 726f 6669 6c65 202b  l_with_profile +
+0000a880: 2022 3a2f 2f22 0a20 2020 2020 2020 2069   "://".        i
+0000a890: 6620 7061 7468 2e73 7461 7274 7377 6974  f path.startswit
+0000a8a0: 6828 7072 6f74 6f63 6f6c 5f70 7265 6669  h(protocol_prefi
+0000a8b0: 7829 3a0a 2020 2020 2020 2020 2020 2020  x):.            
+0000a8c0: 7265 7475 726e 2070 6174 680a 2020 2020  return path.    
+0000a8d0: 2020 2020 7265 7475 726e 2070 726f 746f      return proto
+0000a8e0: 636f 6c5f 7072 6566 6978 202b 2070 6174  col_prefix + pat
+0000a8f0: 682e 6c73 7472 6970 2827 2f27 290a 0a20  h.lstrip('/').. 
+0000a900: 2020 2040 6361 6368 6564 7072 6f70 6572     @cachedproper
+0000a910: 7479 0a20 2020 2064 6566 2070 6174 685f  ty.    def path_
+0000a920: 7769 7468 6f75 745f 7072 6f74 6f63 6f6c  without_protocol
+0000a930: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
+0000a940: 2020 2020 2020 2027 2727 5265 7475 726e         '''Return
+0000a950: 2070 6174 6820 7769 7468 6f75 7420 7072   path without pr
+0000a960: 6f74 6f63 6f6c 2c20 6578 616d 706c 653a  otocol, example:
+0000a970: 2069 6620 7061 7468 2069 7320 7333 3a2f   if path is s3:/
+0000a980: 2f62 7563 6b65 742f 6b65 792c 2072 6574  /bucket/key, ret
+0000a990: 7572 6e20 6275 636b 6574 2f6b 6579 2727  urn bucket/key''
+0000a9a0: 270a 2020 2020 2020 2020 7061 7468 203d  '.        path =
+0000a9b0: 2073 656c 662e 7061 7468 0a20 2020 2020   self.path.     
+0000a9c0: 2020 2070 726f 746f 636f 6c5f 7072 6566     protocol_pref
+0000a9d0: 6978 203d 2073 656c 662e 5f70 726f 746f  ix = self._proto
+0000a9e0: 636f 6c5f 7769 7468 5f70 726f 6669 6c65  col_with_profile
+0000a9f0: 202b 2022 3a2f 2f22 0a20 2020 2020 2020   + "://".       
+0000aa00: 2069 6620 7061 7468 2e73 7461 7274 7377   if path.startsw
+0000aa10: 6974 6828 7072 6f74 6f63 6f6c 5f70 7265  ith(protocol_pre
+0000aa20: 6669 7829 3a0a 2020 2020 2020 2020 2020  fix):.          
+0000aa30: 2020 7061 7468 203d 2070 6174 685b 6c65    path = path[le
+0000aa40: 6e28 7072 6f74 6f63 6f6c 5f70 7265 6669  n(protocol_prefi
+0000aa50: 7829 3a5d 0a20 2020 2020 2020 2072 6574  x):].        ret
+0000aa60: 7572 6e20 7061 7468 0a0a 2020 2020 4063  urn path..    @c
+0000aa70: 6163 6865 6470 726f 7065 7274 790a 2020  achedproperty.  
+0000aa80: 2020 6465 6620 5f63 6c69 656e 7428 7365    def _client(se
+0000aa90: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+0000aaa0: 7572 6e20 6765 745f 7333 5f63 6c69 656e  urn get_s3_clien
+0000aab0: 7428 7072 6f66 696c 655f 6e61 6d65 3d73  t(profile_name=s
+0000aac0: 656c 662e 5f70 726f 6669 6c65 5f6e 616d  elf._profile_nam
+0000aad0: 6529 0a0a 2020 2020 6465 6620 5f73 335f  e)..    def _s3_
+0000aae0: 6765 745f 6d65 7461 6461 7461 2873 656c  get_metadata(sel
+0000aaf0: 6629 202d 3e20 6469 6374 3a0a 2020 2020  f) -> dict:.    
+0000ab00: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+0000ab10: 4765 7420 6f62 6a65 6374 206d 6574 6164  Get object metad
+0000ab20: 6174 610a 0a20 2020 2020 2020 203a 7061  ata..        :pa
+0000ab30: 7261 6d20 7061 7468 3a20 4f62 6a65 6374  ram path: Object
+0000ab40: 2070 6174 680a 2020 2020 2020 2020 3a72   path.        :r
+0000ab50: 6574 7572 6e73 3a20 4f62 6a65 6374 206d  eturns: Object m
+0000ab60: 6574 6164 6174 610a 2020 2020 2020 2020  etadata.        
+0000ab70: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
+0000ab80: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
+0000ab90: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
+0000aba0: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+0000abb0: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
+0000abc0: 7563 6b65 743a 0a20 2020 2020 2020 2020  ucket:.         
+0000abd0: 2020 2072 6574 7572 6e20 7b7d 0a20 2020     return {}.   
+0000abe0: 2020 2020 2069 6620 6e6f 7420 6b65 7920       if not key 
+0000abf0: 6f72 206b 6579 2e65 6e64 7377 6974 6828  or key.endswith(
+0000ac00: 272f 2729 3a0a 2020 2020 2020 2020 2020  '/'):.          
+0000ac10: 2020 7265 7475 726e 207b 7d0a 2020 2020    return {}.    
+0000ac20: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000ac30: 2020 2020 2077 6974 6820 7261 6973 655f       with raise_
+0000ac40: 7333 5f65 7272 6f72 2873 656c 662e 7061  s3_error(self.pa
+0000ac50: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000ac60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000ac70: 2020 2072 6573 7020 3d20 7365 6c66 2e5f     resp = self._
+0000ac80: 636c 6965 6e74 2e68 6561 645f 6f62 6a65  client.head_obje
+0000ac90: 6374 2842 7563 6b65 743d 6275 636b 6574  ct(Bucket=bucket
+0000aca0: 2c20 4b65 793d 6b65 7929 0a20 2020 2020  , Key=key).     
+0000acb0: 2020 2020 2020 2072 6574 7572 6e20 6469         return di
+0000acc0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+0000acd0: 2020 2020 286b 6579 2e6c 6f77 6572 2829      (key.lower()
+0000ace0: 2c20 7661 6c75 6529 2066 6f72 206b 6579  , value) for key
+0000acf0: 2c20 7661 6c75 6520 696e 2072 6573 705b  , value in resp[
+0000ad00: 274d 6574 6164 6174 6127 5d2e 6974 656d  'Metadata'].item
+0000ad10: 7328 2929 0a20 2020 2020 2020 2065 7863  s()).        exc
+0000ad20: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+0000ad30: 2065 7272 6f72 3a0a 2020 2020 2020 2020   error:.        
+0000ad40: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0000ad50: 6528 6572 726f 722c 0a20 2020 2020 2020  e(error,.       
+0000ad60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad70: 2020 2028 5333 556e 6b6e 6f77 6e45 7272     (S3UnknownErr
+0000ad80: 6f72 2c20 5333 436f 6e66 6967 4572 726f  or, S3ConfigErro
+0000ad90: 722c 2053 3350 6572 6d69 7373 696f 6e45  r, S3PermissionE
+0000ada0: 7272 6f72 2929 3a0a 2020 2020 2020 2020  rror)):.        
+0000adb0: 2020 2020 2020 2020 7261 6973 6520 6572          raise er
+0000adc0: 726f 720a 2020 2020 2020 2020 2020 2020  ror.            
+0000add0: 7265 7475 726e 207b 7d0a 0a20 2020 2064  return {}..    d
+0000ade0: 6566 2061 6363 6573 7328 0a20 2020 2020  ef access(.     
+0000adf0: 2020 2020 2020 2073 656c 662c 206d 6f64         self, mod
+0000ae00: 653a 2041 6363 6573 7320 3d20 4163 6365  e: Access = Acce
+0000ae10: 7373 2e52 4541 442c 0a20 2020 2020 2020  ss.READ,.       
+0000ae20: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
+0000ae30: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
+0000ae40: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+0000ae50: 2027 2727 0a20 2020 2020 2020 2054 6573   '''.        Tes
+0000ae60: 7420 6966 2070 6174 6820 6861 7320 6163  t if path has ac
+0000ae70: 6365 7373 2070 6572 6d69 7373 696f 6e20  cess permission 
+0000ae80: 6465 7363 7269 6265 6420 6279 206d 6f64  described by mod
+0000ae90: 650a 2020 2020 2020 2020 5573 696e 6720  e.        Using 
+0000aea0: 6865 6164 5f62 7563 6b65 7428 292c 206e  head_bucket(), n
+0000aeb0: 6f77 2052 4541 442f 5752 4954 4520 6172  ow READ/WRITE ar
+0000aec0: 6520 7361 6d65 2e0a 0a20 2020 2020 2020  e same...       
+0000aed0: 203a 7061 7261 6d20 6d6f 6465 3a20 6163   :param mode: ac
+0000aee0: 6365 7373 206d 6f64 650a 2020 2020 2020  cess mode.      
+0000aef0: 2020 3a72 6574 7572 6e73 3a20 626f 6f6c    :returns: bool
+0000af00: 2c20 6966 2074 6865 2062 7563 6b65 7420  , if the bucket 
+0000af10: 6f66 2073 335f 7572 6c20 6861 7320 7265  of s3_url has re
+0000af20: 6164 2f77 7269 7465 2061 6363 6573 732e  ad/write access.
+0000af30: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000af40: 2020 2020 2073 335f 7572 6c20 3d20 7365       s3_url = se
+0000af50: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000af60: 746f 636f 6c0a 2020 2020 2020 2020 6966  tocol.        if
+0000af70: 2066 6f6c 6c6f 776c 696e 6b73 3a0a 2020   followlinks:.  
+0000af80: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0000af90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000afa0: 335f 7572 6c20 3d20 7365 6c66 2e72 6561  3_url = self.rea
+0000afb0: 646c 696e 6b28 292e 7061 7468 5f77 6974  dlink().path_wit
+0000afc0: 685f 7072 6f74 6f63 6f6c 0a20 2020 2020  h_protocol.     
+0000afd0: 2020 2020 2020 2065 7863 6570 7420 5333         except S3
+0000afe0: 4e6f 7441 4c69 6e6b 4572 726f 723a 0a20  NotALinkError:. 
+0000aff0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000b000: 6173 730a 2020 2020 2020 2020 6275 636b  ass.        buck
+0000b010: 6574 2c20 5f20 3d20 7061 7273 655f 7333  et, _ = parse_s3
+0000b020: 5f75 726c 2873 335f 7572 6c29 2020 2320  _url(s3_url)  # 
+0000b030: 6f6e 6c79 2063 6865 636b 2062 7563 6b65  only check bucke
+0000b040: 7420 6163 6365 7373 6962 696c 6974 790a  t accessibility.
+0000b050: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
+0000b060: 7563 6b65 743a 0a20 2020 2020 2020 2020  ucket:.         
+0000b070: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+0000b080: 6f6e 2822 4e6f 2061 7661 696c 6162 6c65  on("No available
+0000b090: 2062 7563 6b65 7422 290a 2020 2020 2020   bucket").      
+0000b0a0: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+0000b0b0: 6e63 6528 6d6f 6465 2c20 4163 6365 7373  nce(mode, Access
+0000b0c0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+0000b0d0: 6169 7365 2054 7970 6545 7272 6f72 280a  aise TypeError(.
+0000b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0f0: 2755 6e73 7570 706f 7274 6564 206d 6f64  'Unsupported mod
+0000b100: 653a 207b 7d20 2d2d 204d 6f64 6520 7368  e: {} -- Mode sh
+0000b110: 6f75 6c64 2075 7365 206f 6e65 206f 6620  ould use one of 
+0000b120: 7468 6520 656e 756d 7320 6265 6c6f 6e67  the enums belong
+0000b130: 696e 6720 746f 3a20 207b 7d27 0a20 2020  ing to:  {}'.   
+0000b140: 2020 2020 2020 2020 2020 2020 202e 666f               .fo
+0000b150: 726d 6174 286d 6f64 652c 2027 2c20 272e  rmat(mode, ', '.
+0000b160: 6a6f 696e 285b 7374 7228 6129 2066 6f72  join([str(a) for
+0000b170: 2061 2069 6e20 4163 6365 7373 5d29 2929   a in Access])))
+0000b180: 0a20 2020 2020 2020 2069 6620 6d6f 6465  .        if mode
+0000b190: 206e 6f74 2069 6e20 2841 6363 6573 732e   not in (Access.
+0000b1a0: 5245 4144 2c20 4163 6365 7373 2e57 5249  READ, Access.WRI
+0000b1b0: 5445 293a 0a20 2020 2020 2020 2020 2020  TE):.           
+0000b1c0: 2072 6169 7365 2054 7970 6545 7272 6f72   raise TypeError
+0000b1d0: 2827 556e 7375 7070 6f72 7465 6420 6d6f  ('Unsupported mo
+0000b1e0: 6465 3a20 7b7d 272e 666f 726d 6174 286d  de: {}'.format(m
+0000b1f0: 6f64 6529 290a 2020 2020 2020 2020 7472  ode)).        tr
+0000b200: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+0000b210: 656c 662e 5f63 6c69 656e 742e 6865 6164  elf._client.head
+0000b220: 5f62 7563 6b65 7428 4275 636b 6574 3d62  _bucket(Bucket=b
+0000b230: 7563 6b65 7429 0a20 2020 2020 2020 2065  ucket).        e
+0000b240: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+0000b250: 6173 2065 7272 6f72 3a0a 2020 2020 2020  as error:.      
+0000b260: 2020 2020 2020 6572 726f 7220 3d20 7472        error = tr
+0000b270: 616e 736c 6174 655f 7333 5f65 7272 6f72  anslate_s3_error
+0000b280: 2865 7272 6f72 2c20 7333 5f75 726c 290a  (error, s3_url).
+0000b290: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0000b2a0: 7369 6e73 7461 6e63 6528 6572 726f 722c  sinstance(error,
+0000b2b0: 2028 5333 5065 726d 6973 7369 6f6e 4572   (S3PermissionEr
+0000b2c0: 726f 722c 2053 3346 696c 654e 6f74 466f  ror, S3FileNotFo
+0000b2d0: 756e 6445 7272 6f72 2c0a 2020 2020 2020  undError,.      
 0000b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b2f0: 2020 2020 5333 4275 636b 6574 4e6f 7446      S3BucketNotF
-0000b300: 6f75 6e64 4572 726f 7229 293a 0a20 2020  oundError)):.   
-0000b310: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000b320: 7572 6e20 4661 6c73 650a 2020 2020 2020  urn False.      
-0000b330: 2020 2020 2020 7261 6973 6520 6572 726f        raise erro
-0000b340: 720a 2020 2020 2020 2020 7265 7475 726e  r.        return
-0000b350: 2054 7275 650a 0a20 2020 2064 6566 2065   True..    def e
-0000b360: 7869 7374 7328 7365 6c66 2c20 666f 6c6c  xists(self, foll
-0000b370: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-0000b380: 4661 6c73 6529 202d 3e20 626f 6f6c 3a0a  False) -> bool:.
-0000b390: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000b3a0: 2020 2020 5465 7374 2069 6620 7333 5f75      Test if s3_u
-0000b3b0: 726c 2065 7869 7374 730a 0a20 2020 2020  rl exists..     
-0000b3c0: 2020 2049 6620 7468 6520 6275 636b 6574     If the bucket
-0000b3d0: 206f 6620 7333 5f75 726c 2061 7265 206e   of s3_url are n
-0000b3e0: 6f74 2070 6572 6d69 7474 6564 2074 6f20  ot permitted to 
-0000b3f0: 7265 6164 2c20 7265 7475 726e 2046 616c  read, return Fal
-0000b400: 7365 0a0a 2020 2020 2020 2020 3a72 6574  se..        :ret
-0000b410: 7572 6e73 3a20 5472 7565 2069 6620 7333  urns: True if s3
-0000b420: 5f75 726c 2065 6978 7374 732c 2065 6c73  _url eixsts, els
-0000b430: 6520 4661 6c73 650a 2020 2020 2020 2020  e False.        
-0000b440: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
-0000b450: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
-0000b460: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
-0000b470: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-0000b480: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
-0000b490: 7563 6b65 743a 2020 2320 7333 3a2f 2f20  ucket:  # s3:// 
-0000b4a0: 3d3e 2054 7275 652c 2073 333a 2f2f 2f6b  => True, s3:///k
-0000b4b0: 6579 203d 3e20 4661 6c73 650a 2020 2020  ey => False.    
-0000b4c0: 2020 2020 2020 2020 7265 7475 726e 206e          return n
-0000b4d0: 6f74 206b 6579 0a0a 2020 2020 2020 2020  ot key..        
-0000b4e0: 7265 7475 726e 2073 656c 662e 6973 5f64  return self.is_d
-0000b4f0: 6972 2829 206f 7220 7365 6c66 2e69 735f  ir() or self.is_
-0000b500: 6669 6c65 2866 6f6c 6c6f 776c 696e 6b73  file(followlinks
-0000b510: 290a 0a20 2020 2064 6566 2067 6574 6d74  )..    def getmt
-0000b520: 696d 6528 7365 6c66 2c20 666f 6c6c 6f77  ime(self, follow
-0000b530: 5f73 796d 6c69 6e6b 733a 2062 6f6f 6c20  _symlinks: bool 
-0000b540: 3d20 4661 6c73 6529 202d 3e20 666c 6f61  = False) -> floa
-0000b550: 743a 0a20 2020 2020 2020 2027 2727 0a20  t:.        '''. 
-0000b560: 2020 2020 2020 2047 6574 206c 6173 742d         Get last-
-0000b570: 6d6f 6469 6669 6564 2074 696d 6520 6f66  modified time of
-0000b580: 2074 6865 2066 696c 6520 6f6e 2074 6865   the file on the
-0000b590: 2067 6976 656e 2073 335f 7572 6c20 7061   given s3_url pa
-0000b5a0: 7468 2028 696e 2055 6e69 7820 7469 6d65  th (in Unix time
-0000b5b0: 7374 616d 7020 666f 726d 6174 292e 0a20  stamp format).. 
-0000b5c0: 2020 2020 2020 2049 6620 7468 6520 7061         If the pa
-0000b5d0: 7468 2069 7320 616e 2065 7869 7374 656e  th is an existen
-0000b5e0: 7420 6469 7265 6374 6f72 792c 2072 6574  t directory, ret
-0000b5f0: 7572 6e20 7468 6520 6c61 7465 7374 206d  urn the latest m
-0000b600: 6f64 6966 6965 6420 7469 6d65 206f 6620  odified time of 
-0000b610: 616c 6c20 6669 6c65 2069 6e20 6974 2e20  all file in it. 
-0000b620: 5468 6520 6d74 696d 6520 6f66 2065 6d70  The mtime of emp
-0000b630: 7479 2064 6972 6563 746f 7279 2069 7320  ty directory is 
-0000b640: 3139 3730 2d30 312d 3031 2030 303a 3030  1970-01-01 00:00
-0000b650: 3a30 300a 0a20 2020 2020 2020 2049 6620  :00..        If 
-0000b660: 7333 5f75 726c 2069 7320 6e6f 7420 616e  s3_url is not an
-0000b670: 2065 7869 7374 656e 7420 7061 7468 2c20   existent path, 
-0000b680: 7768 6963 6820 6d65 616e 7320 7333 5f65  which means s3_e
-0000b690: 7869 7374 2873 335f 7572 6c29 2072 6574  xist(s3_url) ret
-0000b6a0: 7572 6e73 2046 616c 7365 2c20 7468 656e  urns False, then
-0000b6b0: 2072 6169 7365 2053 3346 696c 654e 6f74   raise S3FileNot
-0000b6c0: 466f 756e 6445 7272 6f72 0a0a 2020 2020  FoundError..    
-0000b6d0: 2020 2020 3a72 6574 7572 6e73 3a20 4c61      :returns: La
-0000b6e0: 7374 2d6d 6f64 6966 6965 6420 7469 6d65  st-modified time
-0000b6f0: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
-0000b700: 3a20 5333 4669 6c65 4e6f 7446 6f75 6e64  : S3FileNotFound
-0000b710: 4572 726f 722c 2055 6e73 7570 706f 7274  Error, Unsupport
-0000b720: 6564 4572 726f 720a 2020 2020 2020 2020  edError.        
-0000b730: 2727 270a 2020 2020 2020 2020 7265 7475  '''.        retu
-0000b740: 726e 2073 656c 662e 7374 6174 2866 6f6c  rn self.stat(fol
-0000b750: 6c6f 775f 7379 6d6c 696e 6b73 3d66 6f6c  low_symlinks=fol
-0000b760: 6c6f 775f 7379 6d6c 696e 6b73 292e 6d74  low_symlinks).mt
-0000b770: 696d 650a 0a20 2020 2064 6566 2067 6574  ime..    def get
-0000b780: 7369 7a65 2873 656c 662c 2066 6f6c 6c6f  size(self, follo
-0000b790: 775f 7379 6d6c 696e 6b73 3a20 626f 6f6c  w_symlinks: bool
-0000b7a0: 203d 2046 616c 7365 2920 2d3e 2069 6e74   = False) -> int
-0000b7b0: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
-0000b7c0: 2020 2020 2020 4765 7420 6669 6c65 2073        Get file s
-0000b7d0: 697a 6520 6f6e 2074 6865 2067 6976 656e  ize on the given
-0000b7e0: 2073 335f 7572 6c20 7061 7468 2028 696e   s3_url path (in
-0000b7f0: 2062 7974 6573 292e 0a20 2020 2020 2020   bytes)..       
-0000b800: 2049 6620 7468 6520 7061 7468 2069 6e20   If the path in 
-0000b810: 6120 6469 7265 6374 6f72 792c 2072 6574  a directory, ret
-0000b820: 7572 6e20 7468 6520 7375 6d20 6f66 2061  urn the sum of a
-0000b830: 6c6c 2066 696c 6520 7369 7a65 2069 6e20  ll file size in 
-0000b840: 6974 2c20 696e 636c 7564 696e 6720 6669  it, including fi
-0000b850: 6c65 2069 6e20 7375 6264 6972 6563 746f  le in subdirecto
-0000b860: 7269 6573 2028 6966 2065 7869 7374 292e  ries (if exist).
-0000b870: 0a20 2020 2020 2020 2054 6865 2072 6573  .        The res
-0000b880: 756c 7420 6578 636c 7564 6573 2074 6865  ult excludes the
-0000b890: 2073 697a 6520 6f66 2064 6972 6563 746f   size of directo
-0000b8a0: 7279 2069 7473 656c 662e 2049 6e20 6f74  ry itself. In ot
-0000b8b0: 6865 7220 776f 7264 732c 2072 6574 7572  her words, retur
-0000b8c0: 6e20 3020 4279 7465 206f 6e20 616e 2065  n 0 Byte on an e
-0000b8d0: 6d70 7479 2064 6972 6563 746f 7279 2070  mpty directory p
-0000b8e0: 6174 682e 0a0a 2020 2020 2020 2020 4966  ath...        If
-0000b8f0: 2073 335f 7572 6c20 6973 206e 6f74 2061   s3_url is not a
-0000b900: 6e20 6578 6973 7465 6e74 2070 6174 682c  n existent path,
-0000b910: 2077 6869 6368 206d 6561 6e73 2073 335f   which means s3_
-0000b920: 6578 6973 7428 7333 5f75 726c 2920 7265  exist(s3_url) re
-0000b930: 7475 726e 7320 4661 6c73 652c 2074 6865  turns False, the
-0000b940: 6e20 7261 6973 6520 5333 4669 6c65 4e6f  n raise S3FileNo
-0000b950: 7446 6f75 6e64 4572 726f 720a 0a20 2020  tFoundError..   
-0000b960: 2020 2020 203a 7265 7475 726e 733a 2046       :returns: F
-0000b970: 696c 6520 7369 7a65 0a20 2020 2020 2020  ile size.       
-0000b980: 203a 7261 6973 6573 3a20 5333 4669 6c65   :raises: S3File
-0000b990: 4e6f 7446 6f75 6e64 4572 726f 722c 2055  NotFoundError, U
-0000b9a0: 6e73 7570 706f 7274 6564 4572 726f 720a  nsupportedError.
-0000b9b0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000b9c0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000b9d0: 7374 6174 2866 6f6c 6c6f 775f 7379 6d6c  stat(follow_syml
-0000b9e0: 696e 6b73 3d66 6f6c 6c6f 775f 7379 6d6c  inks=follow_syml
-0000b9f0: 696e 6b73 292e 7369 7a65 0a0a 2020 2020  inks).size..    
-0000ba00: 6465 6620 676c 6f62 280a 2020 2020 2020  def glob(.      
-0000ba10: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-0000ba20: 2020 2020 2020 2020 7061 7474 6572 6e2c          pattern,
-0000ba30: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-0000ba40: 7572 7369 7665 3a20 626f 6f6c 203d 2054  ursive: bool = T
-0000ba50: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-0000ba60: 206d 6973 7369 6e67 5f6f 6b3a 2062 6f6f   missing_ok: boo
-0000ba70: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
-0000ba80: 2020 2020 2020 666f 6c6c 6f77 6c69 6e6b        followlink
-0000ba90: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-0000baa0: 0a20 2020 2029 202d 3e20 4c69 7374 5b27  .    ) -> List['
-0000bab0: 5333 5061 7468 275d 3a0a 2020 2020 2020  S3Path']:.      
-0000bac0: 2020 2727 2752 6574 7572 6e20 7333 2070    '''Return s3 p
-0000bad0: 6174 6820 6c69 7374 2069 6e20 6173 6365  ath list in asce
-0000bae0: 6e64 696e 6720 616c 7068 6162 6574 6963  nding alphabetic
-0000baf0: 616c 206f 7264 6572 2c20 696e 2077 6869  al order, in whi
-0000bb00: 6368 2070 6174 6820 6d61 7463 6865 7320  ch path matches 
-0000bb10: 676c 6f62 2070 6174 7465 726e 0a20 2020  glob pattern.   
-0000bb20: 2020 2020 204e 6f74 6573 3a20 4f6e 6c79       Notes: Only
-0000bb30: 2067 6c6f 6220 696e 2062 7563 6b65 742e   glob in bucket.
-0000bb40: 2049 6620 7472 7969 6e67 2074 6f20 6d61   If trying to ma
-0000bb50: 7463 6820 6275 636b 6574 2077 6974 6820  tch bucket with 
-0000bb60: 7769 6c64 6361 7264 2063 6861 7261 6374  wildcard charact
-0000bb70: 6572 732c 2072 6169 7365 2055 6e73 7570  ers, raise Unsup
-0000bb80: 706f 7274 6564 4572 726f 720a 0a20 2020  portedError..   
-0000bb90: 2020 2020 203a 7061 7261 6d20 7061 7474       :param patt
-0000bba0: 6572 6e3a 2047 6c6f 6220 7468 6520 6769  ern: Glob the gi
-0000bbb0: 7665 6e20 7265 6c61 7469 7665 2070 6174  ven relative pat
-0000bbc0: 7465 726e 2069 6e20 7468 6520 6469 7265  tern in the dire
-0000bbd0: 6374 6f72 7920 7265 7072 6573 656e 7465  ctory represente
-0000bbe0: 6420 6279 2074 6869 7320 7061 7468 0a20  d by this path. 
-0000bbf0: 2020 2020 2020 203a 7061 7261 6d20 7265         :param re
-0000bc00: 6375 7273 6976 653a 2049 6620 4661 6c73  cursive: If Fals
-0000bc10: 652c 2060 2a2a 6020 7769 6c6c 206e 6f74  e, `**` will not
-0000bc20: 2073 6561 7263 6820 6469 7265 6374 6f72   search director
-0000bc30: 7920 7265 6375 7273 6976 656c 790a 2020  y recursively.  
-0000bc40: 2020 2020 2020 3a70 6172 616d 206d 6973        :param mis
-0000bc50: 7369 6e67 5f6f 6b3a 2049 6620 4661 6c73  sing_ok: If Fals
-0000bc60: 6520 616e 6420 7461 7267 6574 2070 6174  e and target pat
-0000bc70: 6820 646f 6573 6e27 7420 6d61 7463 6820  h doesn't match 
-0000bc80: 616e 7920 6669 6c65 2c20 7261 6973 6520  any file, raise 
-0000bc90: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
-0000bca0: 720a 2020 2020 2020 2020 3a72 6169 7365  r.        :raise
-0000bcb0: 733a 2055 6e73 7570 706f 7274 6564 4572  s: UnsupportedEr
-0000bcc0: 726f 722c 2077 6865 6e20 6275 636b 6574  ror, when bucket
-0000bcd0: 2070 6172 7420 636f 6e74 6169 6e73 2077   part contains w
-0000bce0: 696c 6463 6172 6420 6368 6172 6163 7465  ildcard characte
-0000bcf0: 7273 0a20 2020 2020 2020 203a 7265 7475  rs.        :retu
-0000bd00: 726e 733a 2041 206c 6973 7420 636f 6e74  rns: A list cont
-0000bd10: 6169 6e73 2070 6174 6873 206d 6174 6368  ains paths match
-0000bd20: 2060 7333 5f70 6174 686e 616d 6560 0a20   `s3_pathname`. 
-0000bd30: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000bd40: 2020 2072 6574 7572 6e20 6c69 7374 280a     return list(.
-0000bd50: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000bd60: 2e69 676c 6f62 280a 2020 2020 2020 2020  .iglob(.        
-0000bd70: 2020 2020 2020 2020 7061 7474 6572 6e3d          pattern=
-0000bd80: 7061 7474 6572 6e2c 0a20 2020 2020 2020  pattern,.       
-0000bd90: 2020 2020 2020 2020 2072 6563 7572 7369           recursi
-0000bda0: 7665 3d72 6563 7572 7369 7665 2c0a 2020  ve=recursive,.  
-0000bdb0: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
-0000bdc0: 7373 696e 675f 6f6b 3d6d 6973 7369 6e67  ssing_ok=missing
-0000bdd0: 5f6f 6b2c 0a20 2020 2020 2020 2020 2020  _ok,.           
-0000bde0: 2020 2020 2066 6f6c 6c6f 776c 696e 6b73       followlinks
-0000bdf0: 3d66 6f6c 6c6f 776c 696e 6b73 2929 0a0a  =followlinks))..
-0000be00: 2020 2020 6465 6620 676c 6f62 5f73 7461      def glob_sta
-0000be10: 7428 0a20 2020 2020 2020 2020 2020 2073  t(.            s
-0000be20: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
-0000be30: 2070 6174 7465 726e 2c0a 2020 2020 2020   pattern,.      
-0000be40: 2020 2020 2020 7265 6375 7273 6976 653a        recursive:
-0000be50: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
-0000be60: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
-0000be70: 675f 6f6b 3a20 626f 6f6c 203d 2054 7275  g_ok: bool = Tru
-0000be80: 652c 0a20 2020 2020 2020 2020 2020 2066  e,.            f
-0000be90: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
-0000bea0: 203d 2046 616c 7365 2920 2d3e 2049 7465   = False) -> Ite
-0000beb0: 7261 746f 725b 4669 6c65 456e 7472 795d  rator[FileEntry]
-0000bec0: 3a0a 2020 2020 2020 2020 2727 2752 6574  :.        '''Ret
-0000bed0: 7572 6e20 6120 6765 6e65 7261 746f 7220  urn a generator 
-0000bee0: 636f 6e74 6169 6e73 2074 7570 6c65 7320  contains tuples 
-0000bef0: 6f66 2070 6174 6820 616e 6420 6669 6c65  of path and file
-0000bf00: 2073 7461 742c 2069 6e20 6173 6365 6e64   stat, in ascend
-0000bf10: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
-0000bf20: 206f 7264 6572 2c20 696e 2077 6869 6368   order, in which
-0000bf30: 2070 6174 6820 6d61 7463 6865 7320 676c   path matches gl
-0000bf40: 6f62 2070 6174 7465 726e 0a20 2020 2020  ob pattern.     
-0000bf50: 2020 204e 6f74 6573 3a20 4f6e 6c79 2067     Notes: Only g
-0000bf60: 6c6f 6220 696e 2062 7563 6b65 742e 2049  lob in bucket. I
-0000bf70: 6620 7472 7969 6e67 2074 6f20 6d61 7463  f trying to matc
-0000bf80: 6820 6275 636b 6574 2077 6974 6820 7769  h bucket with wi
-0000bf90: 6c64 6361 7264 2063 6861 7261 6374 6572  ldcard character
-0000bfa0: 732c 2072 6169 7365 2055 6e73 7570 706f  s, raise Unsuppo
-0000bfb0: 7274 6564 4572 726f 720a 0a20 2020 2020  rtedError..     
-0000bfc0: 2020 203a 7061 7261 6d20 7061 7474 6572     :param patter
-0000bfd0: 6e3a 2047 6c6f 6220 7468 6520 6769 7665  n: Glob the give
-0000bfe0: 6e20 7265 6c61 7469 7665 2070 6174 7465  n relative patte
-0000bff0: 726e 2069 6e20 7468 6520 6469 7265 6374  rn in the direct
-0000c000: 6f72 7920 7265 7072 6573 656e 7465 6420  ory represented 
-0000c010: 6279 2074 6869 7320 7061 7468 0a20 2020  by this path.   
-0000c020: 2020 2020 203a 7061 7261 6d20 7265 6375       :param recu
-0000c030: 7273 6976 653a 2049 6620 4661 6c73 652c  rsive: If False,
-0000c040: 2060 2a2a 6020 7769 6c6c 206e 6f74 2073   `**` will not s
-0000c050: 6561 7263 6820 6469 7265 6374 6f72 7920  earch directory 
-0000c060: 7265 6375 7273 6976 656c 790a 2020 2020  recursively.    
-0000c070: 2020 2020 3a70 6172 616d 206d 6973 7369      :param missi
-0000c080: 6e67 5f6f 6b3a 2049 6620 4661 6c73 6520  ng_ok: If False 
-0000c090: 616e 6420 7461 7267 6574 2070 6174 6820  and target path 
-0000c0a0: 646f 6573 6e27 7420 6d61 7463 6820 616e  doesn't match an
-0000c0b0: 7920 6669 6c65 2c20 7261 6973 6520 4669  y file, raise Fi
-0000c0c0: 6c65 4e6f 7446 6f75 6e64 4572 726f 720a  leNotFoundError.
-0000c0d0: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
-0000c0e0: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
-0000c0f0: 722c 2077 6865 6e20 6275 636b 6574 2070  r, when bucket p
-0000c100: 6172 7420 636f 6e74 6169 6e73 2077 696c  art contains wil
-0000c110: 6463 6172 6420 6368 6172 6163 7465 7273  dcard characters
-0000c120: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0000c130: 733a 2041 2067 656e 6572 6174 6f72 2063  s: A generator c
-0000c140: 6f6e 7461 696e 7320 7475 706c 6573 206f  ontains tuples o
-0000c150: 6620 7061 7468 2061 6e64 2066 696c 6520  f path and file 
-0000c160: 7374 6174 2c20 696e 2077 6869 6368 2070  stat, in which p
-0000c170: 6174 6873 206d 6174 6368 2060 7333 5f70  aths match `s3_p
-0000c180: 6174 686e 616d 6560 0a20 2020 2020 2020  athname`.       
-0000c190: 2027 2727 0a20 2020 2020 2020 2067 6c6f   '''.        glo
-0000c1a0: 625f 7061 7468 203d 2073 656c 662e 5f73  b_path = self._s
-0000c1b0: 335f 7061 7468 0a20 2020 2020 2020 2069  3_path.        i
-0000c1c0: 6620 7061 7474 6572 6e3a 0a20 2020 2020  f pattern:.     
-0000c1d0: 2020 2020 2020 2067 6c6f 625f 7061 7468         glob_path
-0000c1e0: 203d 2073 656c 662e 6a6f 696e 7061 7468   = self.joinpath
-0000c1f0: 2870 6174 7465 726e 292e 5f73 335f 7061  (pattern)._s3_pa
-0000c200: 7468 2020 2320 7079 7479 7065 3a20 6469  th  # pytype: di
-0000c210: 7361 626c 653d 6174 7472 6962 7574 652d  sable=attribute-
-0000c220: 6572 726f 720a 2020 2020 2020 2020 7333  error.        s3
-0000c230: 5f70 6174 686e 616d 6520 3d20 6673 7061  _pathname = fspa
-0000c240: 7468 2867 6c6f 625f 7061 7468 290a 0a20  th(glob_path).. 
-0000c250: 2020 2020 2020 2064 6566 2063 7265 6174         def creat
-0000c260: 655f 6765 6e65 7261 746f 7228 293a 0a20  e_generator():. 
-0000c270: 2020 2020 2020 2020 2020 2066 6f72 2067             for g
-0000c280: 726f 7570 5f73 335f 7061 7468 6e61 6d65  roup_s3_pathname
-0000c290: 5f31 2069 6e20 5f67 726f 7570 5f73 3370  _1 in _group_s3p
-0000c2a0: 6174 685f 6279 5f62 7563 6b65 7428 0a20  ath_by_bucket(. 
-0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2c0: 2020 2073 335f 7061 7468 6e61 6d65 2c20     s3_pathname, 
-0000c2d0: 7365 6c66 2e5f 7072 6f66 696c 655f 6e61  self._profile_na
-0000c2e0: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
-0000c2f0: 2020 2020 2066 6f72 2067 726f 7570 5f73       for group_s
-0000c300: 335f 7061 7468 6e61 6d65 5f32 2069 6e20  3_pathname_2 in 
-0000c310: 5f67 726f 7570 5f73 3370 6174 685f 6279  _group_s3path_by
-0000c320: 5f70 7265 6669 7828 0a20 2020 2020 2020  _prefix(.       
-0000c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c340: 2067 726f 7570 5f73 335f 7061 7468 6e61   group_s3_pathna
-0000c350: 6d65 5f31 293a 0a20 2020 2020 2020 2020  me_1):.         
-0000c360: 2020 2020 2020 2020 2020 2066 6f72 2066             for f
-0000c370: 696c 655f 656e 7472 7920 696e 205f 7333  ile_entry in _s3
-0000c380: 5f67 6c6f 625f 7374 6174 5f73 696e 676c  _glob_stat_singl
-0000c390: 655f 7061 7468 280a 2020 2020 2020 2020  e_path(.        
+0000b2f0: 2020 2020 2020 2020 2020 2020 5333 4275              S3Bu
+0000b300: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+0000b310: 7229 293a 0a20 2020 2020 2020 2020 2020  r)):.           
+0000b320: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+0000b330: 650a 2020 2020 2020 2020 2020 2020 7261  e.            ra
+0000b340: 6973 6520 6572 726f 720a 2020 2020 2020  ise error.      
+0000b350: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
+0000b360: 2020 2064 6566 2065 7869 7374 7328 7365     def exists(se
+0000b370: 6c66 2c20 666f 6c6c 6f77 6c69 6e6b 733a  lf, followlinks:
+0000b380: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
+0000b390: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
+0000b3a0: 2727 270a 2020 2020 2020 2020 5465 7374  '''.        Test
+0000b3b0: 2069 6620 7333 5f75 726c 2065 7869 7374   if s3_url exist
+0000b3c0: 730a 0a20 2020 2020 2020 2049 6620 7468  s..        If th
+0000b3d0: 6520 6275 636b 6574 206f 6620 7333 5f75  e bucket of s3_u
+0000b3e0: 726c 2061 7265 206e 6f74 2070 6572 6d69  rl are not permi
+0000b3f0: 7474 6564 2074 6f20 7265 6164 2c20 7265  tted to read, re
+0000b400: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
+0000b410: 2020 2020 3a72 6574 7572 6e73 3a20 5472      :returns: Tr
+0000b420: 7565 2069 6620 7333 5f75 726c 2065 6978  ue if s3_url eix
+0000b430: 7374 732c 2065 6c73 6520 4661 6c73 650a  sts, else False.
+0000b440: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000b450: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
+0000b460: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
+0000b470: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+0000b480: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+0000b490: 6966 206e 6f74 2062 7563 6b65 743a 2020  if not bucket:  
+0000b4a0: 2320 7333 3a2f 2f20 3d3e 2054 7275 652c  # s3:// => True,
+0000b4b0: 2073 333a 2f2f 2f6b 6579 203d 3e20 4661   s3:///key => Fa
+0000b4c0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+0000b4d0: 7265 7475 726e 206e 6f74 206b 6579 0a0a  return not key..
+0000b4e0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0000b4f0: 656c 662e 6973 5f64 6972 2829 206f 7220  elf.is_dir() or 
+0000b500: 7365 6c66 2e69 735f 6669 6c65 2866 6f6c  self.is_file(fol
+0000b510: 6c6f 776c 696e 6b73 290a 0a20 2020 2064  lowlinks)..    d
+0000b520: 6566 2067 6574 6d74 696d 6528 7365 6c66  ef getmtime(self
+0000b530: 2c20 666f 6c6c 6f77 5f73 796d 6c69 6e6b  , follow_symlink
+0000b540: 733a 2062 6f6f 6c20 3d20 4661 6c73 6529  s: bool = False)
+0000b550: 202d 3e20 666c 6f61 743a 0a20 2020 2020   -> float:.     
+0000b560: 2020 2027 2727 0a20 2020 2020 2020 2047     '''.        G
+0000b570: 6574 206c 6173 742d 6d6f 6469 6669 6564  et last-modified
+0000b580: 2074 696d 6520 6f66 2074 6865 2066 696c   time of the fil
+0000b590: 6520 6f6e 2074 6865 2067 6976 656e 2073  e on the given s
+0000b5a0: 335f 7572 6c20 7061 7468 2028 696e 2055  3_url path (in U
+0000b5b0: 6e69 7820 7469 6d65 7374 616d 7020 666f  nix timestamp fo
+0000b5c0: 726d 6174 292e 0a20 2020 2020 2020 2049  rmat)..        I
+0000b5d0: 6620 7468 6520 7061 7468 2069 7320 616e  f the path is an
+0000b5e0: 2065 7869 7374 656e 7420 6469 7265 6374   existent direct
+0000b5f0: 6f72 792c 2072 6574 7572 6e20 7468 6520  ory, return the 
+0000b600: 6c61 7465 7374 206d 6f64 6966 6965 6420  latest modified 
+0000b610: 7469 6d65 206f 6620 616c 6c20 6669 6c65  time of all file
+0000b620: 2069 6e20 6974 2e20 5468 6520 6d74 696d   in it. The mtim
+0000b630: 6520 6f66 2065 6d70 7479 2064 6972 6563  e of empty direc
+0000b640: 746f 7279 2069 7320 3139 3730 2d30 312d  tory is 1970-01-
+0000b650: 3031 2030 303a 3030 3a30 300a 0a20 2020  01 00:00:00..   
+0000b660: 2020 2020 2049 6620 7333 5f75 726c 2069       If s3_url i
+0000b670: 7320 6e6f 7420 616e 2065 7869 7374 656e  s not an existen
+0000b680: 7420 7061 7468 2c20 7768 6963 6820 6d65  t path, which me
+0000b690: 616e 7320 7333 5f65 7869 7374 2873 335f  ans s3_exist(s3_
+0000b6a0: 7572 6c29 2072 6574 7572 6e73 2046 616c  url) returns Fal
+0000b6b0: 7365 2c20 7468 656e 2072 6169 7365 2053  se, then raise S
+0000b6c0: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
+0000b6d0: 6f72 0a0a 2020 2020 2020 2020 3a72 6574  or..        :ret
+0000b6e0: 7572 6e73 3a20 4c61 7374 2d6d 6f64 6966  urns: Last-modif
+0000b6f0: 6965 6420 7469 6d65 0a20 2020 2020 2020  ied time.       
+0000b700: 203a 7261 6973 6573 3a20 5333 4669 6c65   :raises: S3File
+0000b710: 4e6f 7446 6f75 6e64 4572 726f 722c 2055  NotFoundError, U
+0000b720: 6e73 7570 706f 7274 6564 4572 726f 720a  nsupportedError.
+0000b730: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000b740: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000b750: 7374 6174 2866 6f6c 6c6f 775f 7379 6d6c  stat(follow_syml
+0000b760: 696e 6b73 3d66 6f6c 6c6f 775f 7379 6d6c  inks=follow_syml
+0000b770: 696e 6b73 292e 6d74 696d 650a 0a20 2020  inks).mtime..   
+0000b780: 2064 6566 2067 6574 7369 7a65 2873 656c   def getsize(sel
+0000b790: 662c 2066 6f6c 6c6f 775f 7379 6d6c 696e  f, follow_symlin
+0000b7a0: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
+0000b7b0: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
+0000b7c0: 2020 2727 270a 2020 2020 2020 2020 4765    '''.        Ge
+0000b7d0: 7420 6669 6c65 2073 697a 6520 6f6e 2074  t file size on t
+0000b7e0: 6865 2067 6976 656e 2073 335f 7572 6c20  he given s3_url 
+0000b7f0: 7061 7468 2028 696e 2062 7974 6573 292e  path (in bytes).
+0000b800: 0a20 2020 2020 2020 2049 6620 7468 6520  .        If the 
+0000b810: 7061 7468 2069 6e20 6120 6469 7265 6374  path in a direct
+0000b820: 6f72 792c 2072 6574 7572 6e20 7468 6520  ory, return the 
+0000b830: 7375 6d20 6f66 2061 6c6c 2066 696c 6520  sum of all file 
+0000b840: 7369 7a65 2069 6e20 6974 2c20 696e 636c  size in it, incl
+0000b850: 7564 696e 6720 6669 6c65 2069 6e20 7375  uding file in su
+0000b860: 6264 6972 6563 746f 7269 6573 2028 6966  bdirectories (if
+0000b870: 2065 7869 7374 292e 0a20 2020 2020 2020   exist)..       
+0000b880: 2054 6865 2072 6573 756c 7420 6578 636c   The result excl
+0000b890: 7564 6573 2074 6865 2073 697a 6520 6f66  udes the size of
+0000b8a0: 2064 6972 6563 746f 7279 2069 7473 656c   directory itsel
+0000b8b0: 662e 2049 6e20 6f74 6865 7220 776f 7264  f. In other word
+0000b8c0: 732c 2072 6574 7572 6e20 3020 4279 7465  s, return 0 Byte
+0000b8d0: 206f 6e20 616e 2065 6d70 7479 2064 6972   on an empty dir
+0000b8e0: 6563 746f 7279 2070 6174 682e 0a0a 2020  ectory path...  
+0000b8f0: 2020 2020 2020 4966 2073 335f 7572 6c20        If s3_url 
+0000b900: 6973 206e 6f74 2061 6e20 6578 6973 7465  is not an existe
+0000b910: 6e74 2070 6174 682c 2077 6869 6368 206d  nt path, which m
+0000b920: 6561 6e73 2073 335f 6578 6973 7428 7333  eans s3_exist(s3
+0000b930: 5f75 726c 2920 7265 7475 726e 7320 4661  _url) returns Fa
+0000b940: 6c73 652c 2074 6865 6e20 7261 6973 6520  lse, then raise 
+0000b950: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
+0000b960: 726f 720a 0a20 2020 2020 2020 203a 7265  ror..        :re
+0000b970: 7475 726e 733a 2046 696c 6520 7369 7a65  turns: File size
+0000b980: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
+0000b990: 3a20 5333 4669 6c65 4e6f 7446 6f75 6e64  : S3FileNotFound
+0000b9a0: 4572 726f 722c 2055 6e73 7570 706f 7274  Error, Unsupport
+0000b9b0: 6564 4572 726f 720a 2020 2020 2020 2020  edError.        
+0000b9c0: 2727 270a 2020 2020 2020 2020 7265 7475  '''.        retu
+0000b9d0: 726e 2073 656c 662e 7374 6174 2866 6f6c  rn self.stat(fol
+0000b9e0: 6c6f 775f 7379 6d6c 696e 6b73 3d66 6f6c  low_symlinks=fol
+0000b9f0: 6c6f 775f 7379 6d6c 696e 6b73 292e 7369  low_symlinks).si
+0000ba00: 7a65 0a0a 2020 2020 6465 6620 676c 6f62  ze..    def glob
+0000ba10: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+0000ba20: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+0000ba30: 7061 7474 6572 6e2c 0a20 2020 2020 2020  pattern,.       
+0000ba40: 2020 2020 2072 6563 7572 7369 7665 3a20       recursive: 
+0000ba50: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+0000ba60: 2020 2020 2020 2020 206d 6973 7369 6e67           missing
+0000ba70: 5f6f 6b3a 2062 6f6f 6c20 3d20 5472 7565  _ok: bool = True
+0000ba80: 2c0a 2020 2020 2020 2020 2020 2020 666f  ,.            fo
+0000ba90: 6c6c 6f77 6c69 6e6b 733a 2062 6f6f 6c20  llowlinks: bool 
+0000baa0: 3d20 4661 6c73 652c 0a20 2020 2029 202d  = False,.    ) -
+0000bab0: 3e20 4c69 7374 5b27 5333 5061 7468 275d  > List['S3Path']
+0000bac0: 3a0a 2020 2020 2020 2020 2727 2752 6574  :.        '''Ret
+0000bad0: 7572 6e20 7333 2070 6174 6820 6c69 7374  urn s3 path list
+0000bae0: 2069 6e20 6173 6365 6e64 696e 6720 616c   in ascending al
+0000baf0: 7068 6162 6574 6963 616c 206f 7264 6572  phabetical order
+0000bb00: 2c20 696e 2077 6869 6368 2070 6174 6820  , in which path 
+0000bb10: 6d61 7463 6865 7320 676c 6f62 2070 6174  matches glob pat
+0000bb20: 7465 726e 0a20 2020 2020 2020 204e 6f74  tern.        Not
+0000bb30: 6573 3a20 4f6e 6c79 2067 6c6f 6220 696e  es: Only glob in
+0000bb40: 2062 7563 6b65 742e 2049 6620 7472 7969   bucket. If tryi
+0000bb50: 6e67 2074 6f20 6d61 7463 6820 6275 636b  ng to match buck
+0000bb60: 6574 2077 6974 6820 7769 6c64 6361 7264  et with wildcard
+0000bb70: 2063 6861 7261 6374 6572 732c 2072 6169   characters, rai
+0000bb80: 7365 2055 6e73 7570 706f 7274 6564 4572  se UnsupportedEr
+0000bb90: 726f 720a 0a20 2020 2020 2020 203a 7061  ror..        :pa
+0000bba0: 7261 6d20 7061 7474 6572 6e3a 2047 6c6f  ram pattern: Glo
+0000bbb0: 6220 7468 6520 6769 7665 6e20 7265 6c61  b the given rela
+0000bbc0: 7469 7665 2070 6174 7465 726e 2069 6e20  tive pattern in 
+0000bbd0: 7468 6520 6469 7265 6374 6f72 7920 7265  the directory re
+0000bbe0: 7072 6573 656e 7465 6420 6279 2074 6869  presented by thi
+0000bbf0: 7320 7061 7468 0a20 2020 2020 2020 203a  s path.        :
+0000bc00: 7061 7261 6d20 7265 6375 7273 6976 653a  param recursive:
+0000bc10: 2049 6620 4661 6c73 652c 2060 2a2a 6020   If False, `**` 
+0000bc20: 7769 6c6c 206e 6f74 2073 6561 7263 6820  will not search 
+0000bc30: 6469 7265 6374 6f72 7920 7265 6375 7273  directory recurs
+0000bc40: 6976 656c 790a 2020 2020 2020 2020 3a70  ively.        :p
+0000bc50: 6172 616d 206d 6973 7369 6e67 5f6f 6b3a  aram missing_ok:
+0000bc60: 2049 6620 4661 6c73 6520 616e 6420 7461   If False and ta
+0000bc70: 7267 6574 2070 6174 6820 646f 6573 6e27  rget path doesn'
+0000bc80: 7420 6d61 7463 6820 616e 7920 6669 6c65  t match any file
+0000bc90: 2c20 7261 6973 6520 4669 6c65 4e6f 7446  , raise FileNotF
+0000bca0: 6f75 6e64 4572 726f 720a 2020 2020 2020  oundError.      
+0000bcb0: 2020 3a72 6169 7365 733a 2055 6e73 7570    :raises: Unsup
+0000bcc0: 706f 7274 6564 4572 726f 722c 2077 6865  portedError, whe
+0000bcd0: 6e20 6275 636b 6574 2070 6172 7420 636f  n bucket part co
+0000bce0: 6e74 6169 6e73 2077 696c 6463 6172 6420  ntains wildcard 
+0000bcf0: 6368 6172 6163 7465 7273 0a20 2020 2020  characters.     
+0000bd00: 2020 203a 7265 7475 726e 733a 2041 206c     :returns: A l
+0000bd10: 6973 7420 636f 6e74 6169 6e73 2070 6174  ist contains pat
+0000bd20: 6873 206d 6174 6368 2060 7333 5f70 6174  hs match `s3_pat
+0000bd30: 686e 616d 6560 0a20 2020 2020 2020 2027  hname`.        '
+0000bd40: 2727 0a20 2020 2020 2020 2072 6574 7572  ''.        retur
+0000bd50: 6e20 6c69 7374 280a 2020 2020 2020 2020  n list(.        
+0000bd60: 2020 2020 7365 6c66 2e69 676c 6f62 280a      self.iglob(.
+0000bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd80: 7061 7474 6572 6e3d 7061 7474 6572 6e2c  pattern=pattern,
+0000bd90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bda0: 2072 6563 7572 7369 7665 3d72 6563 7572   recursive=recur
+0000bdb0: 7369 7665 2c0a 2020 2020 2020 2020 2020  sive,.          
+0000bdc0: 2020 2020 2020 6d69 7373 696e 675f 6f6b        missing_ok
+0000bdd0: 3d6d 6973 7369 6e67 5f6f 6b2c 0a20 2020  =missing_ok,.   
+0000bde0: 2020 2020 2020 2020 2020 2020 2066 6f6c               fol
+0000bdf0: 6c6f 776c 696e 6b73 3d66 6f6c 6c6f 776c  lowlinks=followl
+0000be00: 696e 6b73 2929 0a0a 2020 2020 6465 6620  inks))..    def 
+0000be10: 676c 6f62 5f73 7461 7428 0a20 2020 2020  glob_stat(.     
+0000be20: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0000be30: 2020 2020 2020 2020 2070 6174 7465 726e           pattern
+0000be40: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+0000be50: 6375 7273 6976 653a 2062 6f6f 6c20 3d20  cursive: bool = 
+0000be60: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0000be70: 2020 6d69 7373 696e 675f 6f6b 3a20 626f    missing_ok: bo
+0000be80: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
+0000be90: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
+0000bea0: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
+0000beb0: 2920 2d3e 2049 7465 7261 746f 725b 4669  ) -> Iterator[Fi
+0000bec0: 6c65 456e 7472 795d 3a0a 2020 2020 2020  leEntry]:.      
+0000bed0: 2020 2727 2752 6574 7572 6e20 6120 6765    '''Return a ge
+0000bee0: 6e65 7261 746f 7220 636f 6e74 6169 6e73  nerator contains
+0000bef0: 2074 7570 6c65 7320 6f66 2070 6174 6820   tuples of path 
+0000bf00: 616e 6420 6669 6c65 2073 7461 742c 2069  and file stat, i
+0000bf10: 6e20 6173 6365 6e64 696e 6720 616c 7068  n ascending alph
+0000bf20: 6162 6574 6963 616c 206f 7264 6572 2c20  abetical order, 
+0000bf30: 696e 2077 6869 6368 2070 6174 6820 6d61  in which path ma
+0000bf40: 7463 6865 7320 676c 6f62 2070 6174 7465  tches glob patte
+0000bf50: 726e 0a20 2020 2020 2020 204e 6f74 6573  rn.        Notes
+0000bf60: 3a20 4f6e 6c79 2067 6c6f 6220 696e 2062  : Only glob in b
+0000bf70: 7563 6b65 742e 2049 6620 7472 7969 6e67  ucket. If trying
+0000bf80: 2074 6f20 6d61 7463 6820 6275 636b 6574   to match bucket
+0000bf90: 2077 6974 6820 7769 6c64 6361 7264 2063   with wildcard c
+0000bfa0: 6861 7261 6374 6572 732c 2072 6169 7365  haracters, raise
+0000bfb0: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
+0000bfc0: 720a 0a20 2020 2020 2020 203a 7061 7261  r..        :para
+0000bfd0: 6d20 7061 7474 6572 6e3a 2047 6c6f 6220  m pattern: Glob 
+0000bfe0: 7468 6520 6769 7665 6e20 7265 6c61 7469  the given relati
+0000bff0: 7665 2070 6174 7465 726e 2069 6e20 7468  ve pattern in th
+0000c000: 6520 6469 7265 6374 6f72 7920 7265 7072  e directory repr
+0000c010: 6573 656e 7465 6420 6279 2074 6869 7320  esented by this 
+0000c020: 7061 7468 0a20 2020 2020 2020 203a 7061  path.        :pa
+0000c030: 7261 6d20 7265 6375 7273 6976 653a 2049  ram recursive: I
+0000c040: 6620 4661 6c73 652c 2060 2a2a 6020 7769  f False, `**` wi
+0000c050: 6c6c 206e 6f74 2073 6561 7263 6820 6469  ll not search di
+0000c060: 7265 6374 6f72 7920 7265 6375 7273 6976  rectory recursiv
+0000c070: 656c 790a 2020 2020 2020 2020 3a70 6172  ely.        :par
+0000c080: 616d 206d 6973 7369 6e67 5f6f 6b3a 2049  am missing_ok: I
+0000c090: 6620 4661 6c73 6520 616e 6420 7461 7267  f False and targ
+0000c0a0: 6574 2070 6174 6820 646f 6573 6e27 7420  et path doesn't 
+0000c0b0: 6d61 7463 6820 616e 7920 6669 6c65 2c20  match any file, 
+0000c0c0: 7261 6973 6520 4669 6c65 4e6f 7446 6f75  raise FileNotFou
+0000c0d0: 6e64 4572 726f 720a 2020 2020 2020 2020  ndError.        
+0000c0e0: 3a72 6169 7365 733a 2055 6e73 7570 706f  :raises: Unsuppo
+0000c0f0: 7274 6564 4572 726f 722c 2077 6865 6e20  rtedError, when 
+0000c100: 6275 636b 6574 2070 6172 7420 636f 6e74  bucket part cont
+0000c110: 6169 6e73 2077 696c 6463 6172 6420 6368  ains wildcard ch
+0000c120: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
+0000c130: 203a 7265 7475 726e 733a 2041 2067 656e   :returns: A gen
+0000c140: 6572 6174 6f72 2063 6f6e 7461 696e 7320  erator contains 
+0000c150: 7475 706c 6573 206f 6620 7061 7468 2061  tuples of path a
+0000c160: 6e64 2066 696c 6520 7374 6174 2c20 696e  nd file stat, in
+0000c170: 2077 6869 6368 2070 6174 6873 206d 6174   which paths mat
+0000c180: 6368 2060 7333 5f70 6174 686e 616d 6560  ch `s3_pathname`
+0000c190: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000c1a0: 2020 2020 2067 6c6f 625f 7061 7468 203d       glob_path =
+0000c1b0: 2073 656c 662e 5f73 335f 7061 7468 0a20   self._s3_path. 
+0000c1c0: 2020 2020 2020 2069 6620 7061 7474 6572         if patter
+0000c1d0: 6e3a 0a20 2020 2020 2020 2020 2020 2067  n:.            g
+0000c1e0: 6c6f 625f 7061 7468 203d 2073 656c 662e  lob_path = self.
+0000c1f0: 6a6f 696e 7061 7468 2870 6174 7465 726e  joinpath(pattern
+0000c200: 292e 5f73 335f 7061 7468 2020 2320 7079  )._s3_path  # py
+0000c210: 7479 7065 3a20 6469 7361 626c 653d 6174  type: disable=at
+0000c220: 7472 6962 7574 652d 6572 726f 720a 2020  tribute-error.  
+0000c230: 2020 2020 2020 7333 5f70 6174 686e 616d        s3_pathnam
+0000c240: 6520 3d20 6673 7061 7468 2867 6c6f 625f  e = fspath(glob_
+0000c250: 7061 7468 290a 0a20 2020 2020 2020 2064  path)..        d
+0000c260: 6566 2063 7265 6174 655f 6765 6e65 7261  ef create_genera
+0000c270: 746f 7228 293a 0a20 2020 2020 2020 2020  tor():.         
+0000c280: 2020 2066 6f72 2067 726f 7570 5f73 335f     for group_s3_
+0000c290: 7061 7468 6e61 6d65 5f31 2069 6e20 5f67  pathname_1 in _g
+0000c2a0: 726f 7570 5f73 3370 6174 685f 6279 5f62  roup_s3path_by_b
+0000c2b0: 7563 6b65 7428 0a20 2020 2020 2020 2020  ucket(.         
+0000c2c0: 2020 2020 2020 2020 2020 2073 335f 7061             s3_pa
+0000c2d0: 7468 6e61 6d65 2c20 7365 6c66 2e5f 7072  thname, self._pr
+0000c2e0: 6f66 696c 655f 6e61 6d65 293a 0a20 2020  ofile_name):.   
+0000c2f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000c300: 2067 726f 7570 5f73 335f 7061 7468 6e61   group_s3_pathna
+0000c310: 6d65 5f32 2069 6e20 5f67 726f 7570 5f73  me_2 in _group_s
+0000c320: 3370 6174 685f 6279 5f70 7265 6669 7828  3path_by_prefix(
+0000c330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c340: 2020 2020 2020 2020 2067 726f 7570 5f73           group_s
+0000c350: 335f 7061 7468 6e61 6d65 5f31 293a 0a20  3_pathname_1):. 
+0000c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c370: 2020 2066 6f72 2066 696c 655f 656e 7472     for file_entr
+0000c380: 7920 696e 205f 7333 5f67 6c6f 625f 7374  y in _s3_glob_st
+0000c390: 6174 5f73 696e 676c 655f 7061 7468 280a  at_single_path(.
 0000c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3b0: 2020 2020 6772 6f75 705f 7333 5f70 6174      group_s3_pat
-0000c3c0: 686e 616d 655f 322c 2072 6563 7572 7369  hname_2, recursi
-0000c3d0: 7665 2c20 6d69 7373 696e 675f 6f6b 2c0a  ve, missing_ok,.
-0000c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3f0: 2020 2020 2020 2020 2020 2020 666f 6c6c              foll
-0000c400: 6f77 6c69 6e6b 733d 666f 6c6c 6f77 6c69  owlinks=followli
-0000c410: 6e6b 732c 0a20 2020 2020 2020 2020 2020  nks,.           
+0000c3b0: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0000c3c0: 705f 7333 5f70 6174 686e 616d 655f 322c  p_s3_pathname_2,
+0000c3d0: 2072 6563 7572 7369 7665 2c20 6d69 7373   recursive, miss
+0000c3e0: 696e 675f 6f6b 2c0a 2020 2020 2020 2020  ing_ok,.        
+0000c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c400: 2020 2020 666f 6c6c 6f77 6c69 6e6b 733d      followlinks=
+0000c410: 666f 6c6c 6f77 6c69 6e6b 732c 0a20 2020  followlinks,.   
 0000c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c430: 2070 726f 6669 6c65 5f6e 616d 653d 7365   profile_name=se
-0000c440: 6c66 2e5f 7072 6f66 696c 655f 6e61 6d65  lf._profile_name
-0000c450: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000c460: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0000c470: 6c66 2e5f 7072 6f66 696c 655f 6e61 6d65  lf._profile_name
-0000c480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c490: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0000c4a0: 6c65 5f65 6e74 7279 203d 2066 696c 655f  le_entry = file_
-0000c4b0: 656e 7472 792e 5f72 6570 6c61 6365 280a  entry._replace(.
-0000c4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c430: 2020 2020 2020 2020 2070 726f 6669 6c65           profile
+0000c440: 5f6e 616d 653d 7365 6c66 2e5f 7072 6f66  _name=self._prof
+0000c450: 696c 655f 6e61 6d65 293a 0a20 2020 2020  ile_name):.     
+0000c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c470: 2020 2069 6620 7365 6c66 2e5f 7072 6f66     if self._prof
+0000c480: 696c 655f 6e61 6d65 3a0a 2020 2020 2020  ile_name:.      
+0000c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4a0: 2020 2020 2020 6669 6c65 5f65 6e74 7279        file_entry
+0000c4b0: 203d 2066 696c 655f 656e 7472 792e 5f72   = file_entry._r
+0000c4c0: 6570 6c61 6365 280a 2020 2020 2020 2020  eplace(.        
 0000c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4e0: 7061 7468 3d0a 2020 2020 2020 2020 2020  path=.          
+0000c4e0: 2020 2020 2020 2020 7061 7468 3d0a 2020          path=.  
 0000c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c500: 2020 2020 2020 6622 7b73 656c 662e 5f70        f"{self._p
-0000c510: 726f 746f 636f 6c5f 7769 7468 5f70 726f  rotocol_with_pro
-0000c520: 6669 6c65 7d3a 2f2f 7b66 696c 655f 656e  file}://{file_en
-0000c530: 7472 792e 7061 7468 5b35 3a5d 7d22 0a20  try.path[5:]}". 
-0000c540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c550: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0000c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c570: 2020 2020 2079 6965 6c64 2066 696c 655f       yield file_
-0000c580: 656e 7472 790a 0a20 2020 2020 2020 2072  entry..        r
-0000c590: 6574 7572 6e20 5f63 7265 6174 655f 6d69  eturn _create_mi
-0000c5a0: 7373 696e 675f 6f6b 5f67 656e 6572 6174  ssing_ok_generat
-0000c5b0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000c5c0: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
-0000c5d0: 2829 2c20 6d69 7373 696e 675f 6f6b 2c0a  (), missing_ok,.
-0000c5e0: 2020 2020 2020 2020 2020 2020 5333 4669              S3Fi
-0000c5f0: 6c65 4e6f 7446 6f75 6e64 4572 726f 7228  leNotFoundError(
-0000c600: 274e 6f20 6d61 7463 6820 6669 6c65 3a20  'No match file: 
-0000c610: 2572 2720 2520 7333 5f70 6174 686e 616d  %r' % s3_pathnam
-0000c620: 6529 290a 0a20 2020 2064 6566 2069 676c  e))..    def igl
-0000c630: 6f62 280a 2020 2020 2020 2020 2020 2020  ob(.            
-0000c640: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
-0000c650: 2020 7061 7474 6572 6e2c 0a20 2020 2020    pattern,.     
-0000c660: 2020 2020 2020 2072 6563 7572 7369 7665         recursive
-0000c670: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
-0000c680: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-0000c690: 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20 5472  ng_ok: bool = Tr
-0000c6a0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0000c6b0: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-0000c6c0: 6c20 3d20 4661 6c73 652c 0a20 2020 2029  l = False,.    )
-0000c6d0: 202d 3e20 4974 6572 6174 6f72 5b27 5333   -> Iterator['S3
-0000c6e0: 5061 7468 275d 3a0a 2020 2020 2020 2020  Path']:.        
-0000c6f0: 2727 2752 6574 7572 6e20 7333 2070 6174  '''Return s3 pat
-0000c700: 6820 6974 6572 6174 6f72 2069 6e20 6173  h iterator in as
-0000c710: 6365 6e64 696e 6720 616c 7068 6162 6574  cending alphabet
-0000c720: 6963 616c 206f 7264 6572 2c20 696e 2077  ical order, in w
-0000c730: 6869 6368 2070 6174 6820 6d61 7463 6865  hich path matche
-0000c740: 7320 676c 6f62 2070 6174 7465 726e 0a20  s glob pattern. 
-0000c750: 2020 2020 2020 204e 6f74 6573 3a20 4f6e         Notes: On
-0000c760: 6c79 2067 6c6f 6220 696e 2062 7563 6b65  ly glob in bucke
-0000c770: 742e 2049 6620 7472 7969 6e67 2074 6f20  t. If trying to 
-0000c780: 6d61 7463 6820 6275 636b 6574 2077 6974  match bucket wit
-0000c790: 6820 7769 6c64 6361 7264 2063 6861 7261  h wildcard chara
-0000c7a0: 6374 6572 732c 2072 6169 7365 2055 6e73  cters, raise Uns
-0000c7b0: 7570 706f 7274 6564 4572 726f 720a 0a20  upportedError.. 
-0000c7c0: 2020 2020 2020 203a 7061 7261 6d20 7061         :param pa
-0000c7d0: 7474 6572 6e3a 2047 6c6f 6220 7468 6520  ttern: Glob the 
-0000c7e0: 6769 7665 6e20 7265 6c61 7469 7665 2070  given relative p
-0000c7f0: 6174 7465 726e 2069 6e20 7468 6520 6469  attern in the di
-0000c800: 7265 6374 6f72 7920 7265 7072 6573 656e  rectory represen
-0000c810: 7465 6420 6279 2074 6869 7320 7061 7468  ted by this path
-0000c820: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000c830: 7265 6375 7273 6976 653a 2049 6620 4661  recursive: If Fa
-0000c840: 6c73 652c 2060 2a2a 6020 7769 6c6c 206e  lse, `**` will n
-0000c850: 6f74 2073 6561 7263 6820 6469 7265 6374  ot search direct
-0000c860: 6f72 7920 7265 6375 7273 6976 656c 790a  ory recursively.
-0000c870: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
-0000c880: 6973 7369 6e67 5f6f 6b3a 2049 6620 4661  issing_ok: If Fa
-0000c890: 6c73 6520 616e 6420 7461 7267 6574 2070  lse and target p
-0000c8a0: 6174 6820 646f 6573 6e27 7420 6d61 7463  ath doesn't matc
-0000c8b0: 6820 616e 7920 6669 6c65 2c20 7261 6973  h any file, rais
-0000c8c0: 6520 4669 6c65 4e6f 7446 6f75 6e64 4572  e FileNotFoundEr
-0000c8d0: 726f 720a 2020 2020 2020 2020 3a72 6169  ror.        :rai
-0000c8e0: 7365 733a 2055 6e73 7570 706f 7274 6564  ses: Unsupported
-0000c8f0: 4572 726f 722c 2077 6865 6e20 6275 636b  Error, when buck
-0000c900: 6574 2070 6172 7420 636f 6e74 6169 6e73  et part contains
-0000c910: 2077 696c 6463 6172 6420 6368 6172 6163   wildcard charac
-0000c920: 7465 7273 0a20 2020 2020 2020 203a 7265  ters.        :re
-0000c930: 7475 726e 733a 2041 6e20 6974 6572 6174  turns: An iterat
-0000c940: 6f72 2063 6f6e 7461 696e 7320 7061 7468  or contains path
-0000c950: 7320 6d61 7463 6820 6073 335f 7061 7468  s match `s3_path
-0000c960: 6e61 6d65 600a 2020 2020 2020 2020 2727  name`.        ''
-0000c970: 270a 2020 2020 2020 2020 666f 7220 6669  '.        for fi
-0000c980: 6c65 5f65 6e74 7279 2069 6e20 7365 6c66  le_entry in self
-0000c990: 2e67 6c6f 625f 7374 6174 2870 6174 7465  .glob_stat(patte
-0000c9a0: 726e 3d70 6174 7465 726e 2c20 7265 6375  rn=pattern, recu
-0000c9b0: 7273 6976 653d 7265 6375 7273 6976 652c  rsive=recursive,
-0000c9c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c500: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0000c510: 7b73 656c 662e 5f70 726f 746f 636f 6c5f  {self._protocol_
+0000c520: 7769 7468 5f70 726f 6669 6c65 7d3a 2f2f  with_profile}://
+0000c530: 7b66 696c 655f 656e 7472 792e 7061 7468  {file_entry.path
+0000c540: 5b35 3a5d 7d22 0a20 2020 2020 2020 2020  [5:]}".         
+0000c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c560: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000c570: 2020 2020 2020 2020 2020 2020 2079 6965               yie
+0000c580: 6c64 2066 696c 655f 656e 7472 790a 0a20  ld file_entry.. 
+0000c590: 2020 2020 2020 2072 6574 7572 6e20 5f63         return _c
+0000c5a0: 7265 6174 655f 6d69 7373 696e 675f 6f6b  reate_missing_ok
+0000c5b0: 5f67 656e 6572 6174 6f72 280a 2020 2020  _generator(.    
+0000c5c0: 2020 2020 2020 2020 6372 6561 7465 5f67          create_g
+0000c5d0: 656e 6572 6174 6f72 2829 2c20 6d69 7373  enerator(), miss
+0000c5e0: 696e 675f 6f6b 2c0a 2020 2020 2020 2020  ing_ok,.        
+0000c5f0: 2020 2020 5333 4669 6c65 4e6f 7446 6f75      S3FileNotFou
+0000c600: 6e64 4572 726f 7228 274e 6f20 6d61 7463  ndError('No matc
+0000c610: 6820 6669 6c65 3a20 2572 2720 2520 7333  h file: %r' % s3
+0000c620: 5f70 6174 686e 616d 6529 290a 0a20 2020  _pathname))..   
+0000c630: 2064 6566 2069 676c 6f62 280a 2020 2020   def iglob(.    
+0000c640: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0000c650: 2020 2020 2020 2020 2020 7061 7474 6572            patter
+0000c660: 6e2c 0a20 2020 2020 2020 2020 2020 2072  n,.            r
+0000c670: 6563 7572 7369 7665 3a20 626f 6f6c 203d  ecursive: bool =
+0000c680: 2054 7275 652c 0a20 2020 2020 2020 2020   True,.         
+0000c690: 2020 206d 6973 7369 6e67 5f6f 6b3a 2062     missing_ok: b
+0000c6a0: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
+0000c6b0: 2020 2020 2020 2020 666f 6c6c 6f77 6c69          followli
+0000c6c0: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
+0000c6d0: 652c 0a20 2020 2029 202d 3e20 4974 6572  e,.    ) -> Iter
+0000c6e0: 6174 6f72 5b27 5333 5061 7468 275d 3a0a  ator['S3Path']:.
+0000c6f0: 2020 2020 2020 2020 2727 2752 6574 7572          '''Retur
+0000c700: 6e20 7333 2070 6174 6820 6974 6572 6174  n s3 path iterat
+0000c710: 6f72 2069 6e20 6173 6365 6e64 696e 6720  or in ascending 
+0000c720: 616c 7068 6162 6574 6963 616c 206f 7264  alphabetical ord
+0000c730: 6572 2c20 696e 2077 6869 6368 2070 6174  er, in which pat
+0000c740: 6820 6d61 7463 6865 7320 676c 6f62 2070  h matches glob p
+0000c750: 6174 7465 726e 0a20 2020 2020 2020 204e  attern.        N
+0000c760: 6f74 6573 3a20 4f6e 6c79 2067 6c6f 6220  otes: Only glob 
+0000c770: 696e 2062 7563 6b65 742e 2049 6620 7472  in bucket. If tr
+0000c780: 7969 6e67 2074 6f20 6d61 7463 6820 6275  ying to match bu
+0000c790: 636b 6574 2077 6974 6820 7769 6c64 6361  cket with wildca
+0000c7a0: 7264 2063 6861 7261 6374 6572 732c 2072  rd characters, r
+0000c7b0: 6169 7365 2055 6e73 7570 706f 7274 6564  aise Unsupported
+0000c7c0: 4572 726f 720a 0a20 2020 2020 2020 203a  Error..        :
+0000c7d0: 7061 7261 6d20 7061 7474 6572 6e3a 2047  param pattern: G
+0000c7e0: 6c6f 6220 7468 6520 6769 7665 6e20 7265  lob the given re
+0000c7f0: 6c61 7469 7665 2070 6174 7465 726e 2069  lative pattern i
+0000c800: 6e20 7468 6520 6469 7265 6374 6f72 7920  n the directory 
+0000c810: 7265 7072 6573 656e 7465 6420 6279 2074  represented by t
+0000c820: 6869 7320 7061 7468 0a20 2020 2020 2020  his path.       
+0000c830: 203a 7061 7261 6d20 7265 6375 7273 6976   :param recursiv
+0000c840: 653a 2049 6620 4661 6c73 652c 2060 2a2a  e: If False, `**
+0000c850: 6020 7769 6c6c 206e 6f74 2073 6561 7263  ` will not searc
+0000c860: 6820 6469 7265 6374 6f72 7920 7265 6375  h directory recu
+0000c870: 7273 6976 656c 790a 2020 2020 2020 2020  rsively.        
+0000c880: 3a70 6172 616d 206d 6973 7369 6e67 5f6f  :param missing_o
+0000c890: 6b3a 2049 6620 4661 6c73 6520 616e 6420  k: If False and 
+0000c8a0: 7461 7267 6574 2070 6174 6820 646f 6573  target path does
+0000c8b0: 6e27 7420 6d61 7463 6820 616e 7920 6669  n't match any fi
+0000c8c0: 6c65 2c20 7261 6973 6520 4669 6c65 4e6f  le, raise FileNo
+0000c8d0: 7446 6f75 6e64 4572 726f 720a 2020 2020  tFoundError.    
+0000c8e0: 2020 2020 3a72 6169 7365 733a 2055 6e73      :raises: Uns
+0000c8f0: 7570 706f 7274 6564 4572 726f 722c 2077  upportedError, w
+0000c900: 6865 6e20 6275 636b 6574 2070 6172 7420  hen bucket part 
+0000c910: 636f 6e74 6169 6e73 2077 696c 6463 6172  contains wildcar
+0000c920: 6420 6368 6172 6163 7465 7273 0a20 2020  d characters.   
+0000c930: 2020 2020 203a 7265 7475 726e 733a 2041       :returns: A
+0000c940: 6e20 6974 6572 6174 6f72 2063 6f6e 7461  n iterator conta
+0000c950: 696e 7320 7061 7468 7320 6d61 7463 6820  ins paths match 
+0000c960: 6073 335f 7061 7468 6e61 6d65 600a 2020  `s3_pathname`.  
+0000c970: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+0000c980: 2020 666f 7220 6669 6c65 5f65 6e74 7279    for file_entry
+0000c990: 2069 6e20 7365 6c66 2e67 6c6f 625f 7374   in self.glob_st
+0000c9a0: 6174 2870 6174 7465 726e 3d70 6174 7465  at(pattern=patte
+0000c9b0: 726e 2c20 7265 6375 7273 6976 653d 7265  rn, recursive=re
+0000c9c0: 6375 7273 6976 652c 0a20 2020 2020 2020  cursive,.       
 0000c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c9e0: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
-0000c9f0: 675f 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c  g_ok=missing_ok,
-0000ca00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9f0: 2020 6d69 7373 696e 675f 6f6b 3d6d 6973    missing_ok=mis
+0000ca00: 7369 6e67 5f6f 6b2c 0a20 2020 2020 2020  sing_ok,.       
 0000ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca20: 2020 2020 2020 2020 2020 666f 6c6c 6f77            follow
-0000ca30: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
-0000ca40: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0000ca50: 7969 656c 6420 7365 6c66 2e66 726f 6d5f  yield self.from_
-0000ca60: 7061 7468 2866 696c 655f 656e 7472 792e  path(file_entry.
-0000ca70: 7061 7468 290a 0a20 2020 2064 6566 2069  path)..    def i
-0000ca80: 735f 6469 7228 7365 6c66 2c20 666f 6c6c  s_dir(self, foll
-0000ca90: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-0000caa0: 4661 6c73 6529 202d 3e20 626f 6f6c 3a0a  False) -> bool:.
-0000cab0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000cac0: 2020 2020 5465 7374 2069 6620 616e 2073      Test if an s
-0000cad0: 3320 7572 6c20 6973 2064 6972 6563 746f  3 url is directo
-0000cae0: 7279 0a20 2020 2020 2020 2053 7065 6369  ry.        Speci
-0000caf0: 6669 6320 7072 6f63 6564 7572 6573 2061  fic procedures a
-0000cb00: 7265 2061 7320 666f 6c6c 6f77 733a 0a20  re as follows:. 
-0000cb10: 2020 2020 2020 2049 6620 7468 6572 6520         If there 
-0000cb20: 6578 6973 7473 2061 2073 7566 6669 782c  exists a suffix,
-0000cb30: 206f 6620 7768 6963 6820 6060 6f73 2e70   of which ``os.p
-0000cb40: 6174 682e 6a6f 696e 2873 335f 7572 6c2c  ath.join(s3_url,
-0000cb50: 2073 7566 6669 7829 6060 2069 7320 6120   suffix)`` is a 
-0000cb60: 6669 6c65 0a20 2020 2020 2020 2049 6620  file.        If 
-0000cb70: 7468 6520 7572 6c20 6973 2065 6d70 7479  the url is empty
-0000cb80: 2062 7563 6b65 7420 6f72 2073 333a 2f2f   bucket or s3://
-0000cb90: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-0000cba0: 2066 6f6c 6c6f 776c 696e 6b73 3a20 7768   followlinks: wh
-0000cbb0: 6574 6865 7220 666f 6c6c 6f77 6c69 6e6b  ether followlink
-0000cbc0: 7320 6973 2054 7275 6520 6f72 2046 616c  s is True or Fal
-0000cbd0: 7365 2c20 7265 7375 6c74 2069 7320 7468  se, result is th
-0000cbe0: 6520 7361 6d65 2e20 4265 6361 7573 6520  e same. Because 
-0000cbf0: 7333 2073 796d 6c69 6e6b 206e 6f74 2073  s3 symlink not s
-0000cc00: 7570 706f 7274 2064 6972 2e0a 2020 2020  upport dir..    
-0000cc10: 2020 2020 3a72 6574 7572 6e73 3a20 5472      :returns: Tr
-0000cc20: 7565 2069 6620 7061 7468 2069 7320 7333  ue if path is s3
-0000cc30: 2064 6972 6563 746f 7279 2c20 656c 7365   directory, else
-0000cc40: 2046 616c 7365 0a20 2020 2020 2020 2027   False.        '
-0000cc50: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
-0000cc60: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
-0000cc70: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
-0000cc80: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
-0000cc90: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
-0000cca0: 636b 6574 3a20 2023 2073 333a 2f2f 203d  cket:  # s3:// =
-0000ccb0: 3e20 5472 7565 2c20 7333 3a2f 2f2f 6b65  > True, s3:///ke
-0000ccc0: 7920 3d3e 2046 616c 7365 0a20 2020 2020  y => False.     
-0000ccd0: 2020 2020 2020 2072 6574 7572 6e20 6e6f         return no
-0000cce0: 7420 6b65 790a 2020 2020 2020 2020 7072  t key.        pr
-0000ccf0: 6566 6978 203d 205f 6265 636f 6d65 5f70  efix = _become_p
-0000cd00: 7265 6669 7828 6b65 7929 0a20 2020 2020  refix(key).     
-0000cd10: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000cd20: 2020 2020 7265 7370 203d 2073 656c 662e      resp = self.
-0000cd30: 5f63 6c69 656e 742e 6c69 7374 5f6f 626a  _client.list_obj
-0000cd40: 6563 7473 5f76 3228 0a20 2020 2020 2020  ects_v2(.       
-0000cd50: 2020 2020 2020 2020 2042 7563 6b65 743d           Bucket=
-0000cd60: 6275 636b 6574 2c20 5072 6566 6978 3d70  bucket, Prefix=p
-0000cd70: 7265 6669 782c 2044 656c 696d 6974 6572  refix, Delimiter
-0000cd80: 3d27 2f27 2c20 4d61 784b 6579 733d 3129  ='/', MaxKeys=1)
-0000cd90: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0000cda0: 4578 6365 7074 696f 6e20 6173 2065 7272  Exception as err
-0000cdb0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0000cdc0: 6572 726f 7220 3d20 7472 616e 736c 6174  error = translat
-0000cdd0: 655f 7333 5f65 7272 6f72 2865 7272 6f72  e_s3_error(error
-0000cde0: 2c20 7365 6c66 2e70 6174 685f 7769 7468  , self.path_with
-0000cdf0: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
-0000ce00: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0000ce10: 616e 6365 2865 7272 6f72 2c0a 2020 2020  ance(error,.    
-0000ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce30: 2020 2020 2020 2853 3355 6e6b 6e6f 776e        (S3Unknown
-0000ce40: 4572 726f 722c 2053 3343 6f6e 6669 6745  Error, S3ConfigE
-0000ce50: 7272 6f72 2c20 5333 5065 726d 6973 7369  rror, S3Permissi
-0000ce60: 6f6e 4572 726f 7229 293a 0a20 2020 2020  onError)):.     
-0000ce70: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000ce80: 2065 7272 6f72 0a20 2020 2020 2020 2020   error.         
-0000ce90: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-0000cea0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000ceb0: 6b65 793a 2020 2320 6275 636b 6574 2069  key:  # bucket i
-0000cec0: 7320 6163 6365 7373 6962 6c65 0a20 2020  s accessible.   
-0000ced0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0000cee0: 5472 7565 0a0a 2020 2020 2020 2020 6966  True..        if
-0000cef0: 2027 4b65 7943 6f75 6e74 2720 696e 2072   'KeyCount' in r
-0000cf00: 6573 703a 0a20 2020 2020 2020 2020 2020  esp:.           
-0000cf10: 2072 6574 7572 6e20 7265 7370 5b27 4b65   return resp['Ke
-0000cf20: 7943 6f75 6e74 275d 203e 2030 0a0a 2020  yCount'] > 0..  
-0000cf30: 2020 2020 2020 7265 7475 726e 206c 656e        return len
-0000cf40: 2872 6573 702e 6765 7428 2743 6f6e 7465  (resp.get('Conte
-0000cf50: 6e74 7327 2c20 5b5d 2929 203e 2030 206f  nts', [])) > 0 o
-0000cf60: 7220 5c0a 2020 2020 2020 2020 2020 2020  r \.            
-0000cf70: 6c65 6e28 7265 7370 2e67 6574 2827 436f  len(resp.get('Co
-0000cf80: 6d6d 6f6e 5072 6566 6978 6573 272c 205b  mmonPrefixes', [
-0000cf90: 5d29 2920 3e20 300a 0a20 2020 2064 6566  ])) > 0..    def
-0000cfa0: 2069 735f 6669 6c65 2873 656c 662c 2066   is_file(self, f
-0000cfb0: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
-0000cfc0: 203d 2046 616c 7365 2920 2d3e 2062 6f6f   = False) -> boo
-0000cfd0: 6c3a 0a20 2020 2020 2020 2027 2727 0a20  l:.        '''. 
-0000cfe0: 2020 2020 2020 2054 6573 7420 6966 2061         Test if a
-0000cff0: 6e20 7333 5f75 726c 2069 7320 6669 6c65  n s3_url is file
-0000d000: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-0000d010: 6e73 3a20 5472 7565 2069 6620 7061 7468  ns: True if path
-0000d020: 2069 7320 7333 2066 696c 652c 2065 6c73   is s3 file, els
-0000d030: 6520 4661 6c73 650a 2020 2020 2020 2020  e False.        
-0000d040: 2727 270a 2020 2020 2020 2020 7333 5f75  '''.        s3_u
-0000d050: 726c 203d 2073 656c 662e 7061 7468 5f77  rl = self.path_w
-0000d060: 6974 685f 7072 6f74 6f63 6f6c 0a20 2020  ith_protocol.   
-0000d070: 2020 2020 2069 6620 666f 6c6c 6f77 6c69       if followli
-0000d080: 6e6b 733a 0a20 2020 2020 2020 2020 2020  nks:.           
-0000d090: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0000d0a0: 2020 2020 2020 7333 5f75 726c 203d 2073        s3_url = s
-0000d0b0: 656c 662e 7265 6164 6c69 6e6b 2829 2e70  elf.readlink().p
-0000d0c0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000d0d0: 6c0a 2020 2020 2020 2020 2020 2020 6578  l.            ex
-0000d0e0: 6365 7074 2053 334e 6f74 414c 696e 6b45  cept S3NotALinkE
-0000d0f0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-0000d100: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-0000d110: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
-0000d120: 2070 6172 7365 5f73 335f 7572 6c28 7333   parse_s3_url(s3
-0000d130: 5f75 726c 290a 2020 2020 2020 2020 6966  _url).        if
-0000d140: 206e 6f74 2062 7563 6b65 7420 6f72 206e   not bucket or n
-0000d150: 6f74 206b 6579 206f 7220 6b65 792e 656e  ot key or key.en
-0000d160: 6473 7769 7468 2827 2f27 293a 0a20 2020  dswith('/'):.   
-0000d170: 2020 2020 2020 2020 2023 2073 333a 2f2f           # s3://
-0000d180: 2c20 7333 3a2f 2f2f 6b65 792c 2073 333a  , s3:///key, s3:
-0000d190: 2f2f 6275 636b 6574 2c20 7333 3a2f 2f62  //bucket, s3://b
-0000d1a0: 7563 6b65 742f 7072 6566 6978 2f0a 2020  ucket/prefix/.  
-0000d1b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000d1c0: 2046 616c 7365 0a20 2020 2020 2020 2074   False.        t
-0000d1d0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000d1e0: 7365 6c66 2e5f 636c 6965 6e74 2e68 6561  self._client.hea
-0000d1f0: 645f 6f62 6a65 6374 2842 7563 6b65 743d  d_object(Bucket=
-0000d200: 6275 636b 6574 2c20 4b65 793d 6b65 7929  bucket, Key=key)
-0000d210: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0000d220: 4578 6365 7074 696f 6e20 6173 2065 7272  Exception as err
-0000d230: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0000d240: 6572 726f 7220 3d20 7472 616e 736c 6174  error = translat
-0000d250: 655f 7333 5f65 7272 6f72 2865 7272 6f72  e_s3_error(error
-0000d260: 2c20 7333 5f75 726c 290a 2020 2020 2020  , s3_url).      
-0000d270: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0000d280: 6e63 6528 6572 726f 722c 0a20 2020 2020  nce(error,.     
-0000d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d2a0: 2020 2020 2028 5333 556e 6b6e 6f77 6e45       (S3UnknownE
-0000d2b0: 7272 6f72 2c20 5333 436f 6e66 6967 4572  rror, S3ConfigEr
-0000d2c0: 726f 722c 2053 3350 6572 6d69 7373 696f  ror, S3Permissio
-0000d2d0: 6e45 7272 6f72 2929 3a0a 2020 2020 2020  nError)):.      
-0000d2e0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000d2f0: 6572 726f 720a 2020 2020 2020 2020 2020  error.          
-0000d300: 2020 7265 7475 726e 2046 616c 7365 0a20    return False. 
-0000d310: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-0000d320: 7565 0a0a 2020 2020 6465 6620 6c69 7374  ue..    def list
-0000d330: 6469 7228 7365 6c66 2c20 666f 6c6c 6f77  dir(self, follow
-0000d340: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
-0000d350: 6c73 6529 202d 3e20 4c69 7374 5b73 7472  lse) -> List[str
-0000d360: 5d3a 0a20 2020 2020 2020 2027 2727 0a20  ]:.        '''. 
-0000d370: 2020 2020 2020 2047 6574 2061 6c6c 2063         Get all c
-0000d380: 6f6e 7465 6e74 7320 6f66 2067 6976 656e  ontents of given
-0000d390: 2073 335f 7572 6c2e 2054 6865 2072 6573   s3_url. The res
-0000d3a0: 756c 7420 6973 2069 6e20 6163 7365 6e64  ult is in acsend
-0000d3b0: 696e 6720 616c 7068 6162 6574 6963 616c  ing alphabetical
-0000d3c0: 206f 7264 6572 2e0a 0a20 2020 2020 2020   order...       
-0000d3d0: 203a 7265 7475 726e 733a 2041 6c6c 2063   :returns: All c
-0000d3e0: 6f6e 7465 6e74 7320 6861 7665 2070 7265  ontents have pre
-0000d3f0: 6669 7820 6f66 2073 335f 7572 6c20 696e  fix of s3_url in
-0000d400: 2061 6373 656e 6469 6e67 2061 6c70 6861   acsending alpha
-0000d410: 6265 7469 6361 6c20 6f72 6465 720a 2020  betical order.  
-0000d420: 2020 2020 2020 3a72 6169 7365 733a 2053        :raises: S
-0000d430: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
-0000d440: 6f72 2c20 5333 4e6f 7441 4469 7265 6374  or, S3NotADirect
-0000d450: 6f72 7945 7272 6f72 0a20 2020 2020 2020  oryError.       
-0000d460: 2027 2727 0a20 2020 2020 2020 2065 6e74   '''.        ent
-0000d470: 7269 6573 203d 206c 6973 7428 7365 6c66  ries = list(self
-0000d480: 2e73 6361 6e64 6972 2866 6f6c 6c6f 776c  .scandir(followl
-0000d490: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
-0000d4a0: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
-0000d4b0: 6e20 736f 7274 6564 285b 656e 7472 792e  n sorted([entry.
-0000d4c0: 6e61 6d65 2066 6f72 2065 6e74 7279 2069  name for entry i
-0000d4d0: 6e20 656e 7472 6965 735d 290a 0a20 2020  n entries])..   
-0000d4e0: 2064 6566 2069 7465 7264 6972 2873 656c   def iterdir(sel
-0000d4f0: 662c 2066 6f6c 6c6f 776c 696e 6b73 3a20  f, followlinks: 
-0000d500: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
-0000d510: 2049 7465 7261 746f 725b 2753 3350 6174   Iterator['S3Pat
-0000d520: 6827 5d3a 0a20 2020 2020 2020 2027 2727  h']:.        '''
-0000d530: 0a20 2020 2020 2020 2047 6574 2061 6c6c  .        Get all
-0000d540: 2063 6f6e 7465 6e74 7320 6f66 2067 6976   contents of giv
-0000d550: 656e 2073 335f 7572 6c2e 2054 6865 2072  en s3_url. The r
-0000d560: 6573 756c 7420 6973 2069 6e20 6163 7365  esult is in acse
-0000d570: 6e64 696e 6720 616c 7068 6162 6574 6963  nding alphabetic
-0000d580: 616c 206f 7264 6572 2e0a 0a20 2020 2020  al order...     
-0000d590: 2020 203a 7265 7475 726e 733a 2041 6c6c     :returns: All
-0000d5a0: 2063 6f6e 7465 6e74 7320 6861 7665 2070   contents have p
-0000d5b0: 7265 6669 7820 6f66 2073 335f 7572 6c20  refix of s3_url 
-0000d5c0: 696e 2061 6373 656e 6469 6e67 2061 6c70  in acsending alp
-0000d5d0: 6861 6265 7469 6361 6c20 6f72 6465 720a  habetical order.
-0000d5e0: 2020 2020 2020 2020 3a72 6169 7365 733a          :raises:
-0000d5f0: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
-0000d600: 7272 6f72 2c20 5333 4e6f 7441 4469 7265  rror, S3NotADire
-0000d610: 6374 6f72 7945 7272 6f72 0a20 2020 2020  ctoryError.     
-0000d620: 2020 2027 2727 0a20 2020 2020 2020 2066     '''.        f
-0000d630: 6f72 2070 6174 6820 696e 2073 656c 662e  or path in self.
-0000d640: 6c69 7374 6469 7228 666f 6c6c 6f77 6c69  listdir(followli
-0000d650: 6e6b 733d 666f 6c6c 6f77 6c69 6e6b 7329  nks=followlinks)
-0000d660: 3a0a 2020 2020 2020 2020 2020 2020 7969  :.            yi
-0000d670: 656c 6420 7365 6c66 2e6a 6f69 6e70 6174  eld self.joinpat
-0000d680: 6828 7061 7468 2920 2023 2074 7970 653a  h(path)  # type:
-0000d690: 2069 676e 6f72 650a 0a20 2020 2064 6566   ignore..    def
-0000d6a0: 206c 6f61 6428 7365 6c66 2c20 666f 6c6c   load(self, foll
-0000d6b0: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
-0000d6c0: 4661 6c73 6529 202d 3e20 4269 6e61 7279  False) -> Binary
-0000d6d0: 494f 3a0a 2020 2020 2020 2020 2727 2752  IO:.        '''R
-0000d6e0: 6561 6420 616c 6c20 636f 6e74 656e 7420  ead all content 
-0000d6f0: 696e 2062 696e 6172 7920 6f6e 2073 7065  in binary on spe
-0000d700: 6369 6669 6564 2070 6174 6820 616e 6420  cified path and 
-0000d710: 7772 6974 6520 696e 746f 206d 656d 6f72  write into memor
-0000d720: 790a 0a20 2020 2020 2020 2055 7365 7220  y..        User 
-0000d730: 7368 6f75 6c64 2063 6c6f 7365 2074 6865  should close the
-0000d740: 2042 696e 6172 7949 4f20 6d61 6e75 616c   BinaryIO manual
-0000d750: 6c79 0a0a 2020 2020 2020 2020 3a72 6574  ly..        :ret
-0000d760: 7572 6e73 3a20 4269 6e61 7279 494f 0a20  urns: BinaryIO. 
-0000d770: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000d780: 2020 2073 335f 7572 6c20 3d20 7365 6c66     s3_url = self
-0000d790: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-0000d7a0: 636f 6c0a 2020 2020 2020 2020 6966 2066  col.        if f
-0000d7b0: 6f6c 6c6f 776c 696e 6b73 3a0a 2020 2020  ollowlinks:.    
-0000d7c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000d7d0: 2020 2020 2020 2020 2020 2020 2073 335f               s3_
-0000d7e0: 7572 6c20 3d20 7365 6c66 2e72 6561 646c  url = self.readl
-0000d7f0: 696e 6b28 292e 7061 7468 5f77 6974 685f  ink().path_with_
-0000d800: 7072 6f74 6f63 6f6c 0a20 2020 2020 2020  protocol.       
-0000d810: 2020 2020 2065 7863 6570 7420 5333 4e6f       except S3No
-0000d820: 7441 4c69 6e6b 4572 726f 723a 0a20 2020  tALinkError:.   
-0000d830: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-0000d840: 730a 2020 2020 2020 2020 6275 636b 6574  s.        bucket
-0000d850: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
-0000d860: 5f75 726c 2873 335f 7572 6c29 0a20 2020  _url(s3_url).   
-0000d870: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
-0000d880: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-0000d890: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
-0000d8a0: 7446 6f75 6e64 4572 726f 7228 2745 6d70  tFoundError('Emp
-0000d8b0: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
-0000d8c0: 2572 2720 2520 7333 5f75 726c 290a 2020  %r' % s3_url).  
-0000d8d0: 2020 2020 2020 6966 206e 6f74 206b 6579        if not key
-0000d8e0: 206f 7220 6b65 792e 656e 6473 7769 7468   or key.endswith
-0000d8f0: 2827 2f27 293a 0a20 2020 2020 2020 2020  ('/'):.         
-0000d900: 2020 2072 6169 7365 2053 3349 7341 4469     raise S3IsADi
-0000d910: 7265 6374 6f72 7945 7272 6f72 2827 4973  rectoryError('Is
-0000d920: 2061 2064 6972 6563 746f 7279 3a20 2572   a directory: %r
-0000d930: 2720 2520 7333 5f75 726c 290a 0a20 2020  ' % s3_url)..   
-0000d940: 2020 2020 2062 7566 6665 7220 3d20 696f       buffer = io
-0000d950: 2e42 7974 6573 494f 2829 0a20 2020 2020  .BytesIO().     
-0000d960: 2020 2077 6974 6820 7261 6973 655f 7333     with raise_s3
-0000d970: 5f65 7272 6f72 2873 335f 7572 6c29 3a0a  _error(s3_url):.
-0000d980: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000d990: 2e5f 636c 6965 6e74 2e64 6f77 6e6c 6f61  ._client.downloa
-0000d9a0: 645f 6669 6c65 6f62 6a28 6275 636b 6574  d_fileobj(bucket
-0000d9b0: 2c20 6b65 792c 2062 7566 6665 7229 0a20  , key, buffer). 
-0000d9c0: 2020 2020 2020 2062 7566 6665 722e 7365         buffer.se
-0000d9d0: 656b 2830 290a 2020 2020 2020 2020 7265  ek(0).        re
-0000d9e0: 7475 726e 2062 7566 6665 720a 0a20 2020  turn buffer..   
-0000d9f0: 2064 6566 2068 6173 6275 636b 6574 2873   def hasbucket(s
-0000da00: 656c 6629 202d 3e20 626f 6f6c 3a0a 2020  elf) -> bool:.  
-0000da10: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000da20: 2020 5465 7374 2069 6620 7468 6520 6275    Test if the bu
-0000da30: 636b 6574 206f 6620 7333 5f75 726c 2065  cket of s3_url e
-0000da40: 7869 7374 730a 0a20 2020 2020 2020 203a  xists..        :
-0000da50: 7265 7475 726e 733a 2054 7275 6520 6966  returns: True if
-0000da60: 2062 7563 6b65 7420 6f66 2073 335f 7572   bucket of s3_ur
-0000da70: 6c20 6569 7873 7473 2c20 656c 7365 2046  l eixsts, else F
-0000da80: 616c 7365 0a20 2020 2020 2020 2027 2727  alse.        '''
-0000da90: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
-0000daa0: 205f 203d 2070 6172 7365 5f73 335f 7572   _ = parse_s3_ur
-0000dab0: 6c28 7365 6c66 2e70 6174 685f 7769 7468  l(self.path_with
-0000dac0: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
-0000dad0: 2020 2069 6620 6e6f 7420 6275 636b 6574     if not bucket
-0000dae0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000daf0: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-0000db00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000db10: 2020 2020 2073 656c 662e 5f63 6c69 656e       self._clien
-0000db20: 742e 6865 6164 5f62 7563 6b65 7428 4275  t.head_bucket(Bu
-0000db30: 636b 6574 3d62 7563 6b65 7429 0a20 2020  cket=bucket).   
-0000db40: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
-0000db50: 7074 696f 6e20 6173 2065 7272 6f72 3a0a  ption as error:.
-0000db60: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-0000db70: 7220 3d20 7472 616e 736c 6174 655f 7333  r = translate_s3
-0000db80: 5f65 7272 6f72 2865 7272 6f72 2c20 7365  _error(error, se
-0000db90: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000dba0: 746f 636f 6c29 0a20 2020 2020 2020 2020  tocol).         
-0000dbb0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-0000dbc0: 2865 7272 6f72 2c0a 2020 2020 2020 2020  (error,.        
+0000ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca30: 2020 666f 6c6c 6f77 6c69 6e6b 733d 666f    followlinks=fo
+0000ca40: 6c6c 6f77 6c69 6e6b 7329 3a0a 2020 2020  llowlinks):.    
+0000ca50: 2020 2020 2020 2020 7969 656c 6420 7365          yield se
+0000ca60: 6c66 2e66 726f 6d5f 7061 7468 2866 696c  lf.from_path(fil
+0000ca70: 655f 656e 7472 792e 7061 7468 290a 0a20  e_entry.path).. 
+0000ca80: 2020 2064 6566 2069 735f 6469 7228 7365     def is_dir(se
+0000ca90: 6c66 2c20 666f 6c6c 6f77 6c69 6e6b 733a  lf, followlinks:
+0000caa0: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
+0000cab0: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
+0000cac0: 2727 270a 2020 2020 2020 2020 5465 7374  '''.        Test
+0000cad0: 2069 6620 616e 2073 3320 7572 6c20 6973   if an s3 url is
+0000cae0: 2064 6972 6563 746f 7279 0a20 2020 2020   directory.     
+0000caf0: 2020 2053 7065 6369 6669 6320 7072 6f63     Specific proc
+0000cb00: 6564 7572 6573 2061 7265 2061 7320 666f  edures are as fo
+0000cb10: 6c6c 6f77 733a 0a20 2020 2020 2020 2049  llows:.        I
+0000cb20: 6620 7468 6572 6520 6578 6973 7473 2061  f there exists a
+0000cb30: 2073 7566 6669 782c 206f 6620 7768 6963   suffix, of whic
+0000cb40: 6820 6060 6f73 2e70 6174 682e 6a6f 696e  h ``os.path.join
+0000cb50: 2873 335f 7572 6c2c 2073 7566 6669 7829  (s3_url, suffix)
+0000cb60: 6060 2069 7320 6120 6669 6c65 0a20 2020  `` is a file.   
+0000cb70: 2020 2020 2049 6620 7468 6520 7572 6c20       If the url 
+0000cb80: 6973 2065 6d70 7479 2062 7563 6b65 7420  is empty bucket 
+0000cb90: 6f72 2073 333a 2f2f 0a0a 2020 2020 2020  or s3://..      
+0000cba0: 2020 3a70 6172 616d 2066 6f6c 6c6f 776c    :param followl
+0000cbb0: 696e 6b73 3a20 7768 6574 6865 7220 666f  inks: whether fo
+0000cbc0: 6c6c 6f77 6c69 6e6b 7320 6973 2054 7275  llowlinks is Tru
+0000cbd0: 6520 6f72 2046 616c 7365 2c20 7265 7375  e or False, resu
+0000cbe0: 6c74 2069 7320 7468 6520 7361 6d65 2e20  lt is the same. 
+0000cbf0: 4265 6361 7573 6520 7333 2073 796d 6c69  Because s3 symli
+0000cc00: 6e6b 206e 6f74 2073 7570 706f 7274 2064  nk not support d
+0000cc10: 6972 2e0a 2020 2020 2020 2020 3a72 6574  ir..        :ret
+0000cc20: 7572 6e73 3a20 5472 7565 2069 6620 7061  urns: True if pa
+0000cc30: 7468 2069 7320 7333 2064 6972 6563 746f  th is s3 directo
+0000cc40: 7279 2c20 656c 7365 2046 616c 7365 0a20  ry, else False. 
+0000cc50: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+0000cc60: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
+0000cc70: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
+0000cc80: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000cc90: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
+0000cca0: 6620 6e6f 7420 6275 636b 6574 3a20 2023  f not bucket:  #
+0000ccb0: 2073 333a 2f2f 203d 3e20 5472 7565 2c20   s3:// => True, 
+0000ccc0: 7333 3a2f 2f2f 6b65 7920 3d3e 2046 616c  s3:///key => Fal
+0000ccd0: 7365 0a20 2020 2020 2020 2020 2020 2072  se.            r
+0000cce0: 6574 7572 6e20 6e6f 7420 6b65 790a 2020  eturn not key.  
+0000ccf0: 2020 2020 2020 7072 6566 6978 203d 205f        prefix = _
+0000cd00: 6265 636f 6d65 5f70 7265 6669 7828 6b65  become_prefix(ke
+0000cd10: 7929 0a20 2020 2020 2020 2074 7279 3a0a  y).        try:.
+0000cd20: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+0000cd30: 203d 2073 656c 662e 5f63 6c69 656e 742e   = self._client.
+0000cd40: 6c69 7374 5f6f 626a 6563 7473 5f76 3228  list_objects_v2(
+0000cd50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cd60: 2042 7563 6b65 743d 6275 636b 6574 2c20   Bucket=bucket, 
+0000cd70: 5072 6566 6978 3d70 7265 6669 782c 2044  Prefix=prefix, D
+0000cd80: 656c 696d 6974 6572 3d27 2f27 2c20 4d61  elimiter='/', Ma
+0000cd90: 784b 6579 733d 3129 0a20 2020 2020 2020  xKeys=1).       
+0000cda0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0000cdb0: 6e20 6173 2065 7272 6f72 3a0a 2020 2020  n as error:.    
+0000cdc0: 2020 2020 2020 2020 6572 726f 7220 3d20          error = 
+0000cdd0: 7472 616e 736c 6174 655f 7333 5f65 7272  translate_s3_err
+0000cde0: 6f72 2865 7272 6f72 2c20 7365 6c66 2e70  or(error, self.p
+0000cdf0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000ce00: 6c29 0a20 2020 2020 2020 2020 2020 2069  l).            i
+0000ce10: 6620 6973 696e 7374 616e 6365 2865 7272  f isinstance(err
+0000ce20: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+0000ce30: 2020 2020 2020 2020 2020 2020 2020 2853                (S
+0000ce40: 3355 6e6b 6e6f 776e 4572 726f 722c 2053  3UnknownError, S
+0000ce50: 3343 6f6e 6669 6745 7272 6f72 2c20 5333  3ConfigError, S3
+0000ce60: 5065 726d 6973 7369 6f6e 4572 726f 7229  PermissionError)
+0000ce70: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000ce80: 2020 2072 6169 7365 2065 7272 6f72 0a20     raise error. 
+0000ce90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000cea0: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
+0000ceb0: 2069 6620 6e6f 7420 6b65 793a 2020 2320   if not key:  # 
+0000cec0: 6275 636b 6574 2069 7320 6163 6365 7373  bucket is access
+0000ced0: 6962 6c65 0a20 2020 2020 2020 2020 2020  ible.           
+0000cee0: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
+0000cef0: 2020 2020 2020 6966 2027 4b65 7943 6f75        if 'KeyCou
+0000cf00: 6e74 2720 696e 2072 6573 703a 0a20 2020  nt' in resp:.   
+0000cf10: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000cf20: 7265 7370 5b27 4b65 7943 6f75 6e74 275d  resp['KeyCount']
+0000cf30: 203e 2030 0a0a 2020 2020 2020 2020 7265   > 0..        re
+0000cf40: 7475 726e 206c 656e 2872 6573 702e 6765  turn len(resp.ge
+0000cf50: 7428 2743 6f6e 7465 6e74 7327 2c20 5b5d  t('Contents', []
+0000cf60: 2929 203e 2030 206f 7220 5c0a 2020 2020  )) > 0 or \.    
+0000cf70: 2020 2020 2020 2020 6c65 6e28 7265 7370          len(resp
+0000cf80: 2e67 6574 2827 436f 6d6d 6f6e 5072 6566  .get('CommonPref
+0000cf90: 6978 6573 272c 205b 5d29 2920 3e20 300a  ixes', [])) > 0.
+0000cfa0: 0a20 2020 2064 6566 2069 735f 6669 6c65  .    def is_file
+0000cfb0: 2873 656c 662c 2066 6f6c 6c6f 776c 696e  (self, followlin
+0000cfc0: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
+0000cfd0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+0000cfe0: 2020 2027 2727 0a20 2020 2020 2020 2054     '''.        T
+0000cff0: 6573 7420 6966 2061 6e20 7333 5f75 726c  est if an s3_url
+0000d000: 2069 7320 6669 6c65 0a0a 2020 2020 2020   is file..      
+0000d010: 2020 3a72 6574 7572 6e73 3a20 5472 7565    :returns: True
+0000d020: 2069 6620 7061 7468 2069 7320 7333 2066   if path is s3 f
+0000d030: 696c 652c 2065 6c73 6520 4661 6c73 650a  ile, else False.
+0000d040: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000d050: 2020 2020 7333 5f75 726c 203d 2073 656c      s3_url = sel
+0000d060: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000d070: 6f63 6f6c 0a20 2020 2020 2020 2069 6620  ocol.        if 
+0000d080: 666f 6c6c 6f77 6c69 6e6b 733a 0a20 2020  followlinks:.   
+0000d090: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0000d0a0: 2020 2020 2020 2020 2020 2020 2020 7333                s3
+0000d0b0: 5f75 726c 203d 2073 656c 662e 7265 6164  _url = self.read
+0000d0c0: 6c69 6e6b 2829 2e70 6174 685f 7769 7468  link().path_with
+0000d0d0: 5f70 726f 746f 636f 6c0a 2020 2020 2020  _protocol.      
+0000d0e0: 2020 2020 2020 6578 6365 7074 2053 334e        except S3N
+0000d0f0: 6f74 414c 696e 6b45 7272 6f72 3a0a 2020  otALinkError:.  
+0000d100: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+0000d110: 7373 0a20 2020 2020 2020 2062 7563 6b65  ss.        bucke
+0000d120: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+0000d130: 335f 7572 6c28 7333 5f75 726c 290a 2020  3_url(s3_url).  
+0000d140: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
+0000d150: 6b65 7420 6f72 206e 6f74 206b 6579 206f  ket or not key o
+0000d160: 7220 6b65 792e 656e 6473 7769 7468 2827  r key.endswith('
+0000d170: 2f27 293a 0a20 2020 2020 2020 2020 2020  /'):.           
+0000d180: 2023 2073 333a 2f2f 2c20 7333 3a2f 2f2f   # s3://, s3:///
+0000d190: 6b65 792c 2073 333a 2f2f 6275 636b 6574  key, s3://bucket
+0000d1a0: 2c20 7333 3a2f 2f62 7563 6b65 742f 7072  , s3://bucket/pr
+0000d1b0: 6566 6978 2f0a 2020 2020 2020 2020 2020  efix/.          
+0000d1c0: 2020 7265 7475 726e 2046 616c 7365 0a20    return False. 
+0000d1d0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000d1e0: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
+0000d1f0: 6965 6e74 2e68 6561 645f 6f62 6a65 6374  ient.head_object
+0000d200: 2842 7563 6b65 743d 6275 636b 6574 2c20  (Bucket=bucket, 
+0000d210: 4b65 793d 6b65 7929 0a20 2020 2020 2020  Key=key).       
+0000d220: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0000d230: 6e20 6173 2065 7272 6f72 3a0a 2020 2020  n as error:.    
+0000d240: 2020 2020 2020 2020 6572 726f 7220 3d20          error = 
+0000d250: 7472 616e 736c 6174 655f 7333 5f65 7272  translate_s3_err
+0000d260: 6f72 2865 7272 6f72 2c20 7333 5f75 726c  or(error, s3_url
+0000d270: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0000d280: 2069 7369 6e73 7461 6e63 6528 6572 726f   isinstance(erro
+0000d290: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0000d2a0: 2020 2020 2020 2020 2020 2020 2028 5333               (S3
+0000d2b0: 556e 6b6e 6f77 6e45 7272 6f72 2c20 5333  UnknownError, S3
+0000d2c0: 436f 6e66 6967 4572 726f 722c 2053 3350  ConfigError, S3P
+0000d2d0: 6572 6d69 7373 696f 6e45 7272 6f72 2929  ermissionError))
+0000d2e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d2f0: 2020 7261 6973 6520 6572 726f 720a 2020    raise error.  
+0000d300: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000d310: 2046 616c 7365 0a20 2020 2020 2020 2072   False.        r
+0000d320: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+0000d330: 6465 6620 6c69 7374 6469 7228 7365 6c66  def listdir(self
+0000d340: 2c20 666f 6c6c 6f77 6c69 6e6b 733a 2062  , followlinks: b
+0000d350: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
+0000d360: 4c69 7374 5b73 7472 5d3a 0a20 2020 2020  List[str]:.     
+0000d370: 2020 2027 2727 0a20 2020 2020 2020 2047     '''.        G
+0000d380: 6574 2061 6c6c 2063 6f6e 7465 6e74 7320  et all contents 
+0000d390: 6f66 2067 6976 656e 2073 335f 7572 6c2e  of given s3_url.
+0000d3a0: 2054 6865 2072 6573 756c 7420 6973 2069   The result is i
+0000d3b0: 6e20 6163 7365 6e64 696e 6720 616c 7068  n acsending alph
+0000d3c0: 6162 6574 6963 616c 206f 7264 6572 2e0a  abetical order..
+0000d3d0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000d3e0: 733a 2041 6c6c 2063 6f6e 7465 6e74 7320  s: All contents 
+0000d3f0: 6861 7665 2070 7265 6669 7820 6f66 2073  have prefix of s
+0000d400: 335f 7572 6c20 696e 2061 6373 656e 6469  3_url in acsendi
+0000d410: 6e67 2061 6c70 6861 6265 7469 6361 6c20  ng alphabetical 
+0000d420: 6f72 6465 720a 2020 2020 2020 2020 3a72  order.        :r
+0000d430: 6169 7365 733a 2053 3346 696c 654e 6f74  aises: S3FileNot
+0000d440: 466f 756e 6445 7272 6f72 2c20 5333 4e6f  FoundError, S3No
+0000d450: 7441 4469 7265 6374 6f72 7945 7272 6f72  tADirectoryError
+0000d460: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
+0000d470: 2020 2020 2065 6e74 7269 6573 203d 206c       entries = l
+0000d480: 6973 7428 7365 6c66 2e73 6361 6e64 6972  ist(self.scandir
+0000d490: 2866 6f6c 6c6f 776c 696e 6b73 3d66 6f6c  (followlinks=fol
+0000d4a0: 6c6f 776c 696e 6b73 2929 0a20 2020 2020  lowlinks)).     
+0000d4b0: 2020 2072 6574 7572 6e20 736f 7274 6564     return sorted
+0000d4c0: 285b 656e 7472 792e 6e61 6d65 2066 6f72  ([entry.name for
+0000d4d0: 2065 6e74 7279 2069 6e20 656e 7472 6965   entry in entrie
+0000d4e0: 735d 290a 0a20 2020 2064 6566 2069 7465  s])..    def ite
+0000d4f0: 7264 6972 2873 656c 662c 2066 6f6c 6c6f  rdir(self, follo
+0000d500: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
+0000d510: 616c 7365 2920 2d3e 2049 7465 7261 746f  alse) -> Iterato
+0000d520: 725b 2753 3350 6174 6827 5d3a 0a20 2020  r['S3Path']:.   
+0000d530: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
+0000d540: 2047 6574 2061 6c6c 2063 6f6e 7465 6e74   Get all content
+0000d550: 7320 6f66 2067 6976 656e 2073 335f 7572  s of given s3_ur
+0000d560: 6c2e 2054 6865 2072 6573 756c 7420 6973  l. The result is
+0000d570: 2069 6e20 6163 7365 6e64 696e 6720 616c   in acsending al
+0000d580: 7068 6162 6574 6963 616c 206f 7264 6572  phabetical order
+0000d590: 2e0a 0a20 2020 2020 2020 203a 7265 7475  ...        :retu
+0000d5a0: 726e 733a 2041 6c6c 2063 6f6e 7465 6e74  rns: All content
+0000d5b0: 7320 6861 7665 2070 7265 6669 7820 6f66  s have prefix of
+0000d5c0: 2073 335f 7572 6c20 696e 2061 6373 656e   s3_url in acsen
+0000d5d0: 6469 6e67 2061 6c70 6861 6265 7469 6361  ding alphabetica
+0000d5e0: 6c20 6f72 6465 720a 2020 2020 2020 2020  l order.        
+0000d5f0: 3a72 6169 7365 733a 2053 3346 696c 654e  :raises: S3FileN
+0000d600: 6f74 466f 756e 6445 7272 6f72 2c20 5333  otFoundError, S3
+0000d610: 4e6f 7441 4469 7265 6374 6f72 7945 7272  NotADirectoryErr
+0000d620: 6f72 0a20 2020 2020 2020 2027 2727 0a20  or.        '''. 
+0000d630: 2020 2020 2020 2066 6f72 2070 6174 6820         for path 
+0000d640: 696e 2073 656c 662e 6c69 7374 6469 7228  in self.listdir(
+0000d650: 666f 6c6c 6f77 6c69 6e6b 733d 666f 6c6c  followlinks=foll
+0000d660: 6f77 6c69 6e6b 7329 3a0a 2020 2020 2020  owlinks):.      
+0000d670: 2020 2020 2020 7969 656c 6420 7365 6c66        yield self
+0000d680: 2e6a 6f69 6e70 6174 6828 7061 7468 2920  .joinpath(path) 
+0000d690: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+0000d6a0: 0a20 2020 2064 6566 206c 6f61 6428 7365  .    def load(se
+0000d6b0: 6c66 2c20 666f 6c6c 6f77 6c69 6e6b 733a  lf, followlinks:
+0000d6c0: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
+0000d6d0: 3e20 4269 6e61 7279 494f 3a0a 2020 2020  > BinaryIO:.    
+0000d6e0: 2020 2020 2727 2752 6561 6420 616c 6c20      '''Read all 
+0000d6f0: 636f 6e74 656e 7420 696e 2062 696e 6172  content in binar
+0000d700: 7920 6f6e 2073 7065 6369 6669 6564 2070  y on specified p
+0000d710: 6174 6820 616e 6420 7772 6974 6520 696e  ath and write in
+0000d720: 746f 206d 656d 6f72 790a 0a20 2020 2020  to memory..     
+0000d730: 2020 2055 7365 7220 7368 6f75 6c64 2063     User should c
+0000d740: 6c6f 7365 2074 6865 2042 696e 6172 7949  lose the BinaryI
+0000d750: 4f20 6d61 6e75 616c 6c79 0a0a 2020 2020  O manually..    
+0000d760: 2020 2020 3a72 6574 7572 6e73 3a20 4269      :returns: Bi
+0000d770: 6e61 7279 494f 0a20 2020 2020 2020 2027  naryIO.        '
+0000d780: 2727 0a20 2020 2020 2020 2073 335f 7572  ''.        s3_ur
+0000d790: 6c20 3d20 7365 6c66 2e70 6174 685f 7769  l = self.path_wi
+0000d7a0: 7468 5f70 726f 746f 636f 6c0a 2020 2020  th_protocol.    
+0000d7b0: 2020 2020 6966 2066 6f6c 6c6f 776c 696e      if followlin
+0000d7c0: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
+0000d7d0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000d7e0: 2020 2020 2073 335f 7572 6c20 3d20 7365       s3_url = se
+0000d7f0: 6c66 2e72 6561 646c 696e 6b28 292e 7061  lf.readlink().pa
+0000d800: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000d810: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+0000d820: 6570 7420 5333 4e6f 7441 4c69 6e6b 4572  ept S3NotALinkEr
+0000d830: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0000d840: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+0000d850: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
+0000d860: 7061 7273 655f 7333 5f75 726c 2873 335f  parse_s3_url(s3_
+0000d870: 7572 6c29 0a20 2020 2020 2020 2069 6620  url).        if 
+0000d880: 6e6f 7420 6275 636b 6574 3a0a 2020 2020  not bucket:.    
+0000d890: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+0000d8a0: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
+0000d8b0: 726f 7228 2745 6d70 7479 2062 7563 6b65  ror('Empty bucke
+0000d8c0: 7420 6e61 6d65 3a20 2572 2720 2520 7333  t name: %r' % s3
+0000d8d0: 5f75 726c 290a 2020 2020 2020 2020 6966  _url).        if
+0000d8e0: 206e 6f74 206b 6579 206f 7220 6b65 792e   not key or key.
+0000d8f0: 656e 6473 7769 7468 2827 2f27 293a 0a20  endswith('/'):. 
+0000d900: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000d910: 2053 3349 7341 4469 7265 6374 6f72 7945   S3IsADirectoryE
+0000d920: 7272 6f72 2827 4973 2061 2064 6972 6563  rror('Is a direc
+0000d930: 746f 7279 3a20 2572 2720 2520 7333 5f75  tory: %r' % s3_u
+0000d940: 726c 290a 0a20 2020 2020 2020 2062 7566  rl)..        buf
+0000d950: 6665 7220 3d20 696f 2e42 7974 6573 494f  fer = io.BytesIO
+0000d960: 2829 0a20 2020 2020 2020 2077 6974 6820  ().        with 
+0000d970: 7261 6973 655f 7333 5f65 7272 6f72 2873  raise_s3_error(s
+0000d980: 335f 7572 6c29 3a0a 2020 2020 2020 2020  3_url):.        
+0000d990: 2020 2020 7365 6c66 2e5f 636c 6965 6e74      self._client
+0000d9a0: 2e64 6f77 6e6c 6f61 645f 6669 6c65 6f62  .download_fileob
+0000d9b0: 6a28 6275 636b 6574 2c20 6b65 792c 2062  j(bucket, key, b
+0000d9c0: 7566 6665 7229 0a20 2020 2020 2020 2062  uffer).        b
+0000d9d0: 7566 6665 722e 7365 656b 2830 290a 2020  uffer.seek(0).  
+0000d9e0: 2020 2020 2020 7265 7475 726e 2062 7566        return buf
+0000d9f0: 6665 720a 0a20 2020 2064 6566 2068 6173  fer..    def has
+0000da00: 6275 636b 6574 2873 656c 6629 202d 3e20  bucket(self) -> 
+0000da10: 626f 6f6c 3a0a 2020 2020 2020 2020 2727  bool:.        ''
+0000da20: 270a 2020 2020 2020 2020 5465 7374 2069  '.        Test i
+0000da30: 6620 7468 6520 6275 636b 6574 206f 6620  f the bucket of 
+0000da40: 7333 5f75 726c 2065 7869 7374 730a 0a20  s3_url exists.. 
+0000da50: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+0000da60: 2054 7275 6520 6966 2062 7563 6b65 7420   True if bucket 
+0000da70: 6f66 2073 335f 7572 6c20 6569 7873 7473  of s3_url eixsts
+0000da80: 2c20 656c 7365 2046 616c 7365 0a20 2020  , else False.   
+0000da90: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
+0000daa0: 2062 7563 6b65 742c 205f 203d 2070 6172   bucket, _ = par
+0000dab0: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
+0000dac0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000dad0: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+0000dae0: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
+0000daf0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+0000db00: 7365 0a0a 2020 2020 2020 2020 7472 793a  se..        try:
+0000db10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000db20: 662e 5f63 6c69 656e 742e 6865 6164 5f62  f._client.head_b
+0000db30: 7563 6b65 7428 4275 636b 6574 3d62 7563  ucket(Bucket=buc
+0000db40: 6b65 7429 0a20 2020 2020 2020 2065 7863  ket).        exc
+0000db50: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+0000db60: 2065 7272 6f72 3a0a 2020 2020 2020 2020   error:.        
+0000db70: 2020 2020 6572 726f 7220 3d20 7472 616e      error = tran
+0000db80: 736c 6174 655f 7333 5f65 7272 6f72 2865  slate_s3_error(e
+0000db90: 7272 6f72 2c20 7365 6c66 2e70 6174 685f  rror, self.path_
+0000dba0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+0000dbb0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0000dbc0: 696e 7374 616e 6365 2865 7272 6f72 2c0a  instance(error,.
 0000dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dbe0: 2020 2853 3355 6e6b 6e6f 776e 4572 726f    (S3UnknownErro
-0000dbf0: 722c 2053 3343 6f6e 6669 6745 7272 6f72  r, S3ConfigError
-0000dc00: 2c20 5333 5065 726d 6973 7369 6f6e 4572  , S3PermissionEr
-0000dc10: 726f 7229 293a 0a20 2020 2020 2020 2020  ror)):.         
-0000dc20: 2020 2020 2020 2072 6169 7365 2065 7272         raise err
-0000dc30: 6f72 0a20 2020 2020 2020 2020 2020 2069  or.            i
-0000dc40: 6620 6973 696e 7374 616e 6365 2865 7272  f isinstance(err
-0000dc50: 6f72 2c20 5333 4669 6c65 4e6f 7446 6f75  or, S3FileNotFou
-0000dc60: 6e64 4572 726f 7229 3a0a 2020 2020 2020  ndError):.      
-0000dc70: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000dc80: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-0000dc90: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
-0000dca0: 2064 6566 206d 6b64 6972 2873 656c 662c   def mkdir(self,
-0000dcb0: 206d 6f64 653d 306f 3737 372c 2070 6172   mode=0o777, par
-0000dcc0: 656e 7473 3a20 626f 6f6c 203d 2046 616c  ents: bool = Fal
-0000dcd0: 7365 2c20 6578 6973 745f 6f6b 3a20 626f  se, exist_ok: bo
-0000dce0: 6f6c 203d 2046 616c 7365 293a 0a20 2020  ol = False):.   
-0000dcf0: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-0000dd00: 2043 7265 6174 6520 616e 2073 3320 6469   Create an s3 di
-0000dd10: 7265 6374 6f72 792e 0a20 2020 2020 2020  rectory..       
-0000dd20: 2050 7572 656c 7920 6372 6561 7469 6e67   Purely creating
-0000dd30: 2064 6972 6563 746f 7279 2069 7320 696e   directory is in
-0000dd40: 7661 6c69 6420 6265 6361 7573 6520 6974  valid because it
-0000dd50: 2773 2075 6e61 7661 696c 6162 6c65 206f  's unavailable o
-0000dd60: 6e20 4f53 532e 0a20 2020 2020 2020 2054  n OSS..        T
-0000dd70: 6869 7320 6675 6e63 7469 6f6e 2069 7320  his function is 
-0000dd80: 746f 2074 6573 7420 7468 6520 7461 7267  to test the targ
-0000dd90: 6574 2062 7563 6b65 7420 6861 7665 2057  et bucket have W
-0000dda0: 5249 5445 2061 6363 6573 732e 0a0a 2020  RITE access...  
-0000ddb0: 2020 2020 2020 3a70 6172 616d 206d 6f64        :param mod
-0000ddc0: 653a 206d 6f64 6520 6973 2069 676e 6f72  e: mode is ignor
-0000ddd0: 6564 2c20 6f6e 6c79 2062 6520 636f 6d70  ed, only be comp
-0000dde0: 6174 6962 6c65 2077 6974 6820 7061 7468  atible with path
-0000ddf0: 6c69 622e 5061 7468 0a20 2020 2020 2020  lib.Path.       
-0000de00: 203a 7061 7261 6d20 7061 7265 6e74 733a   :param parents:
-0000de10: 2070 6172 656e 7473 2069 7320 6967 6e6f   parents is igno
-0000de20: 7265 642c 206f 6e6c 7920 6265 2063 6f6d  red, only be com
-0000de30: 7061 7469 626c 6520 7769 7468 2070 6174  patible with pat
-0000de40: 686c 6962 2e50 6174 680a 2020 2020 2020  hlib.Path.      
-0000de50: 2020 3a70 6172 616d 2065 7869 7374 5f6f    :param exist_o
-0000de60: 6b3a 2049 6620 4661 6c73 6520 616e 6420  k: If False and 
-0000de70: 7461 7267 6574 2064 6972 6563 746f 7279  target directory
-0000de80: 2065 7869 7374 732c 2072 6169 7365 2053   exists, raise S
-0000de90: 3346 696c 6545 7869 7374 7345 7272 6f72  3FileExistsError
-0000dea0: 0a20 2020 2020 2020 203a 7261 6973 6573  .        :raises
-0000deb0: 3a20 5333 4275 636b 6574 4e6f 7446 6f75  : S3BucketNotFou
-0000dec0: 6e64 4572 726f 722c 2053 3346 696c 6545  ndError, S3FileE
-0000ded0: 7869 7374 7345 7272 6f72 0a20 2020 2020  xistsError.     
-0000dee0: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
-0000def0: 7563 6b65 742c 205f 203d 2070 6172 7365  ucket, _ = parse
-0000df00: 5f73 335f 7572 6c28 7365 6c66 2e70 6174  _s3_url(self.pat
-0000df10: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000df20: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000df30: 6275 636b 6574 3a0a 2020 2020 2020 2020  bucket:.        
-0000df40: 2020 2020 7261 6973 6520 5333 4275 636b      raise S3Buck
-0000df50: 6574 4e6f 7446 6f75 6e64 4572 726f 7228  etNotFoundError(
-0000df60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000df70: 2027 456d 7074 7920 6275 636b 6574 206e   'Empty bucket n
-0000df80: 616d 653a 2025 7227 2025 2073 656c 662e  ame: %r' % self.
-0000df90: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000dfa0: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
-0000dfb0: 6f74 2073 656c 662e 6861 7362 7563 6b65  ot self.hasbucke
-0000dfc0: 7428 293a 0a20 2020 2020 2020 2020 2020  t():.           
-0000dfd0: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
-0000dfe0: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
-0000dff0: 2020 2020 2020 2020 2020 2020 2020 274e                'N
-0000e000: 6f20 7375 6368 2062 7563 6b65 743a 2025  o such bucket: %
-0000e010: 7227 2025 2073 656c 662e 7061 7468 5f77  r' % self.path_w
-0000e020: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-0000e030: 2020 2020 2020 6966 2065 7869 7374 5f6f        if exist_o
-0000e040: 6b3a 0a20 2020 2020 2020 2020 2020 2069  k:.            i
-0000e050: 6620 7365 6c66 2e69 735f 6669 6c65 2829  f self.is_file()
-0000e060: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e070: 2020 7261 6973 6520 5333 4669 6c65 4578    raise S3FileEx
-0000e080: 6973 7473 4572 726f 7228 0a20 2020 2020  istsError(.     
-0000e090: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000e0a0: 4669 6c65 2065 7869 7374 733a 2025 7227  File exists: %r'
-0000e0b0: 2025 2073 656c 662e 7061 7468 5f77 6974   % self.path_wit
-0000e0c0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
-0000e0d0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0000e0e0: 2020 2020 2020 2069 6620 7365 6c66 2e65         if self.e
-0000e0f0: 7869 7374 7328 293a 0a20 2020 2020 2020  xists():.       
-0000e100: 2020 2020 2072 6169 7365 2053 3346 696c       raise S3Fil
-0000e110: 6545 7869 7374 7345 7272 6f72 2827 4669  eExistsError('Fi
-0000e120: 6c65 2065 7869 7374 733a 2025 7227 2025  le exists: %r' %
-0000e130: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-0000e140: 7072 6f74 6f63 6f6c 290a 0a20 2020 2064  protocol)..    d
-0000e150: 6566 206d 6f76 6528 7365 6c66 2c20 6473  ef move(self, ds
-0000e160: 745f 7572 6c3a 2050 6174 684c 696b 6529  t_url: PathLike)
-0000e170: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0000e180: 2020 2727 270a 2020 2020 2020 2020 4d6f    '''.        Mo
-0000e190: 7665 2066 696c 652f 6469 7265 6374 6f72  ve file/director
-0000e1a0: 7920 7061 7468 2066 726f 6d20 7372 635f  y path from src_
-0000e1b0: 7572 6c20 746f 2064 7374 5f75 726c 0a0a  url to dst_url..
-0000e1c0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
-0000e1d0: 7374 5f75 726c 3a20 4769 7665 6e20 6465  st_url: Given de
-0000e1e0: 7374 696e 6174 696f 6e20 7061 7468 0a20  stination path. 
-0000e1f0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000e200: 2020 2066 6f72 2073 7263 5f66 696c 655f     for src_file_
-0000e210: 7061 7468 2c20 6473 745f 6669 6c65 5f70  path, dst_file_p
-0000e220: 6174 6820 696e 205f 7333 5f73 6361 6e5f  ath in _s3_scan_
-0000e230: 7061 6972 7328 0a20 2020 2020 2020 2020  pairs(.         
-0000e240: 2020 2020 2020 2073 656c 662e 7061 7468         self.path
-0000e250: 5f77 6974 685f 7072 6f74 6f63 6f6c 2c20  _with_protocol, 
-0000e260: 6473 745f 7572 6c29 3a0a 2020 2020 2020  dst_url):.      
-0000e270: 2020 2020 2020 5333 5061 7468 2873 7263        S3Path(src
-0000e280: 5f66 696c 655f 7061 7468 292e 7265 6e61  _file_path).rena
-0000e290: 6d65 2864 7374 5f66 696c 655f 7061 7468  me(dst_file_path
-0000e2a0: 290a 0a20 2020 2064 6566 2072 656d 6f76  )..    def remov
-0000e2b0: 6528 7365 6c66 2c20 6d69 7373 696e 675f  e(self, missing_
-0000e2c0: 6f6b 3a20 626f 6f6c 203d 2046 616c 7365  ok: bool = False
-0000e2d0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0000e2e0: 2020 2027 2727 0a20 2020 2020 2020 2052     '''.        R
-0000e2f0: 656d 6f76 6520 7468 6520 6669 6c65 206f  emove the file o
-0000e300: 7220 6469 7265 6374 6f72 7920 6f6e 2073  r directory on s
-0000e310: 332c 2060 7333 3a2f 2f60 2061 6e64 2060  3, `s3://` and `
-0000e320: 7333 3a2f 2f62 7563 6b65 7460 2061 7265  s3://bucket` are
-0000e330: 206e 6f74 2070 6572 6d69 7474 6564 2074   not permitted t
-0000e340: 6f20 7265 6d6f 7665 0a0a 2020 2020 2020  o remove..      
-0000e350: 2020 3a70 6172 616d 206d 6973 7369 6e67    :param missing
-0000e360: 5f6f 6b3a 2069 6620 4661 6c73 6520 616e  _ok: if False an
-0000e370: 6420 7461 7267 6574 2066 696c 652f 6469  d target file/di
-0000e380: 7265 6374 6f72 7920 6e6f 7420 6578 6973  rectory not exis
-0000e390: 7473 2c20 7261 6973 6520 5333 4669 6c65  ts, raise S3File
-0000e3a0: 4e6f 7446 6f75 6e64 4572 726f 720a 2020  NotFoundError.  
-0000e3b0: 2020 2020 2020 3a72 6169 7365 733a 2053        :raises: S
-0000e3c0: 3350 6572 6d69 7373 696f 6e45 7272 6f72  3PermissionError
-0000e3d0: 2c20 5333 4669 6c65 4e6f 7446 6f75 6e64  , S3FileNotFound
-0000e3e0: 4572 726f 722c 2055 6e73 7570 706f 7274  Error, Unsupport
-0000e3f0: 6564 4572 726f 720a 2020 2020 2020 2020  edError.        
-0000e400: 2727 270a 2020 2020 2020 2020 6275 636b  '''.        buck
-0000e410: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
-0000e420: 7333 5f75 726c 2873 656c 662e 7061 7468  s3_url(self.path
-0000e430: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-0000e440: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
-0000e450: 7563 6b65 743a 0a20 2020 2020 2020 2020  ucket:.         
-0000e460: 2020 2069 6620 6e6f 7420 6b65 793a 0a20     if not key:. 
-0000e470: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000e480: 6169 7365 2055 6e73 7570 706f 7274 6564  aise Unsupported
-0000e490: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0000e4a0: 2020 2020 2020 2020 2020 2027 5265 6d6f             'Remo
-0000e4b0: 7665 2077 686f 6c65 2073 3327 2c20 7365  ve whole s3', se
-0000e4c0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000e4d0: 746f 636f 6c29 0a20 2020 2020 2020 2020  tocol).         
-0000e4e0: 2020 2072 6169 7365 2053 3342 7563 6b65     raise S3Bucke
-0000e4f0: 744e 6f74 466f 756e 6445 7272 6f72 280a  tNotFoundError(.
-0000e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e510: 2745 6d70 7479 2062 7563 6b65 7420 6e61  'Empty bucket na
-0000e520: 6d65 3a20 2572 2720 2520 7365 6c66 2e70  me: %r' % self.p
-0000e530: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
-0000e540: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
-0000e550: 7420 6b65 793a 0a20 2020 2020 2020 2020  t key:.         
-0000e560: 2020 2072 6169 7365 2055 6e73 7570 706f     raise Unsuppo
-0000e570: 7274 6564 4572 726f 7228 2752 656d 6f76  rtedError('Remov
-0000e580: 6520 6275 636b 6574 272c 2073 656c 662e  e bucket', self.
-0000e590: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-0000e5a0: 6f6c 290a 2020 2020 2020 2020 6966 206e  ol).        if n
-0000e5b0: 6f74 2073 656c 662e 6578 6973 7473 2829  ot self.exists()
-0000e5c0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0000e5d0: 206d 6973 7369 6e67 5f6f 6b3a 0a20 2020   missing_ok:.   
-0000e5e0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000e5f0: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
-0000e600: 7261 6973 6520 5333 4669 6c65 4e6f 7446  raise S3FileNotF
-0000e610: 6f75 6e64 4572 726f 7228 0a20 2020 2020  oundError(.     
-0000e620: 2020 2020 2020 2020 2020 2027 4e6f 2073             'No s
-0000e630: 7563 6820 6669 6c65 206f 7220 6469 7265  uch file or dire
-0000e640: 6374 6f72 793a 2025 7227 2025 2073 656c  ctory: %r' % sel
-0000e650: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000e660: 6f63 6f6c 290a 0a20 2020 2020 2020 2063  ocol)..        c
-0000e670: 6c69 656e 7420 3d20 7365 6c66 2e5f 636c  lient = self._cl
-0000e680: 6965 6e74 0a20 2020 2020 2020 2077 6974  ient.        wit
-0000e690: 6820 7261 6973 655f 7333 5f65 7272 6f72  h raise_s3_error
-0000e6a0: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
-0000e6b0: 7072 6f74 6f63 6f6c 293a 0a20 2020 2020  protocol):.     
-0000e6c0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-0000e6d0: 735f 6669 6c65 2829 3a0a 2020 2020 2020  s_file():.      
-0000e6e0: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-0000e6f0: 2e64 656c 6574 655f 6f62 6a65 6374 2842  .delete_object(B
-0000e700: 7563 6b65 743d 6275 636b 6574 2c20 4b65  ucket=bucket, Ke
-0000e710: 793d 6b65 7929 0a20 2020 2020 2020 2020  y=key).         
-0000e720: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-0000e730: 2020 2020 2020 2020 2020 7072 6566 6978            prefix
-0000e740: 203d 205f 6265 636f 6d65 5f70 7265 6669   = _become_prefi
-0000e750: 7828 6b65 7929 0a20 2020 2020 2020 2020  x(key).         
-0000e760: 2020 2074 6f74 616c 5f63 6f75 6e74 2c20     total_count, 
-0000e770: 6572 726f 725f 636f 756e 7420 3d20 302c  error_count = 0,
-0000e780: 2030 0a20 2020 2020 2020 2020 2020 2066   0.            f
-0000e790: 6f72 2072 6573 7020 696e 205f 6c69 7374  or resp in _list
-0000e7a0: 5f6f 626a 6563 7473 5f72 6563 7572 7369  _objects_recursi
-0000e7b0: 7665 2863 6c69 656e 742c 2062 7563 6b65  ve(client, bucke
-0000e7c0: 742c 2070 7265 6669 7829 3a0a 2020 2020  t, prefix):.    
-0000e7d0: 2020 2020 2020 2020 2020 2020 6966 2027              if '
-0000e7e0: 436f 6e74 656e 7473 2720 696e 2072 6573  Contents' in res
-0000e7f0: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-0000e800: 2020 2020 2020 206b 6579 7320 3d20 5b0a         keys = [.
-0000e810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e820: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0000e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e840: 2020 2020 2020 274b 6579 273a 2063 6f6e        'Key': con
-0000e850: 7465 6e74 5b27 4b65 7927 5d0a 2020 2020  tent['Key'].    
-0000e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e870: 2020 2020 7d20 666f 7220 636f 6e74 656e      } for conten
-0000e880: 7420 696e 2072 6573 705b 2743 6f6e 7465  t in resp['Conte
-0000e890: 6e74 7327 5d0a 2020 2020 2020 2020 2020  nts'].          
-0000e8a0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-0000e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e8c0: 746f 7461 6c5f 636f 756e 7420 2b3d 206c  total_count += l
-0000e8d0: 656e 286b 6579 7329 0a20 2020 2020 2020  en(keys).       
-0000e8e0: 2020 2020 2020 2020 2020 2020 2065 7272               err
-0000e8f0: 6f72 7320 3d20 5b5d 0a20 2020 2020 2020  ors = [].       
-0000e900: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000e910: 7269 6573 203d 2032 0a20 2020 2020 2020  ries = 2.       
-0000e920: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0000e930: 7279 5f69 6e74 6572 7661 6c20 3d20 6d69  ry_interval = mi
-0000e940: 6e28 302e 3120 2a20 322a 2a72 6574 7269  n(0.1 * 2**retri
-0000e950: 6573 2c20 3330 290a 2020 2020 2020 2020  es, 30).        
-0000e960: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000e970: 6920 696e 2072 616e 6765 2872 6574 7269  i in range(retri
-0000e980: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
-0000e990: 2020 2020 2020 2020 2020 2020 2023 2064               # d
-0000e9a0: 6f63 3a20 6874 7470 733a 2f2f 626f 746f  oc: https://boto
-0000e9b0: 332e 616d 617a 6f6e 6177 732e 636f 6d2f  3.amazonaws.com/
-0000e9c0: 7631 2f64 6f63 756d 656e 7461 7469 6f6e  v1/documentation
-0000e9d0: 2f61 7069 2f6c 6174 6573 742f 7265 6665  /api/latest/refe
-0000e9e0: 7265 6e63 652f 7365 7276 6963 6573 2f73  rence/services/s
-0000e9f0: 332e 6874 6d6c 2353 332e 436c 6965 6e74  3.html#S3.Client
-0000ea00: 2e64 656c 6574 655f 6f62 6a65 6374 730a  .delete_objects.
-0000ea10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea20: 2020 2020 2020 2020 6966 206e 6f74 206b          if not k
-0000ea30: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
+0000dbe0: 2020 2020 2020 2020 2020 2853 3355 6e6b            (S3Unk
+0000dbf0: 6e6f 776e 4572 726f 722c 2053 3343 6f6e  nownError, S3Con
+0000dc00: 6669 6745 7272 6f72 2c20 5333 5065 726d  figError, S3Perm
+0000dc10: 6973 7369 6f6e 4572 726f 7229 293a 0a20  issionError)):. 
+0000dc20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000dc30: 6169 7365 2065 7272 6f72 0a20 2020 2020  aise error.     
+0000dc40: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0000dc50: 616e 6365 2865 7272 6f72 2c20 5333 4669  ance(error, S3Fi
+0000dc60: 6c65 4e6f 7446 6f75 6e64 4572 726f 7229  leNotFoundError)
+0000dc70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000dc80: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+0000dc90: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+0000dca0: 7275 650a 0a20 2020 2064 6566 206d 6b64  rue..    def mkd
+0000dcb0: 6972 2873 656c 662c 206d 6f64 653d 306f  ir(self, mode=0o
+0000dcc0: 3737 372c 2070 6172 656e 7473 3a20 626f  777, parents: bo
+0000dcd0: 6f6c 203d 2046 616c 7365 2c20 6578 6973  ol = False, exis
+0000dce0: 745f 6f6b 3a20 626f 6f6c 203d 2046 616c  t_ok: bool = Fal
+0000dcf0: 7365 293a 0a20 2020 2020 2020 2027 2727  se):.        '''
+0000dd00: 0a20 2020 2020 2020 2043 7265 6174 6520  .        Create 
+0000dd10: 616e 2073 3320 6469 7265 6374 6f72 792e  an s3 directory.
+0000dd20: 0a20 2020 2020 2020 2050 7572 656c 7920  .        Purely 
+0000dd30: 6372 6561 7469 6e67 2064 6972 6563 746f  creating directo
+0000dd40: 7279 2069 7320 696e 7661 6c69 6420 6265  ry is invalid be
+0000dd50: 6361 7573 6520 6974 2773 2075 6e61 7661  cause it's unava
+0000dd60: 696c 6162 6c65 206f 6e20 4f53 532e 0a20  ilable on OSS.. 
+0000dd70: 2020 2020 2020 2054 6869 7320 6675 6e63         This func
+0000dd80: 7469 6f6e 2069 7320 746f 2074 6573 7420  tion is to test 
+0000dd90: 7468 6520 7461 7267 6574 2062 7563 6b65  the target bucke
+0000dda0: 7420 6861 7665 2057 5249 5445 2061 6363  t have WRITE acc
+0000ddb0: 6573 732e 0a0a 2020 2020 2020 2020 3a70  ess...        :p
+0000ddc0: 6172 616d 206d 6f64 653a 206d 6f64 6520  aram mode: mode 
+0000ddd0: 6973 2069 676e 6f72 6564 2c20 6f6e 6c79  is ignored, only
+0000dde0: 2062 6520 636f 6d70 6174 6962 6c65 2077   be compatible w
+0000ddf0: 6974 6820 7061 7468 6c69 622e 5061 7468  ith pathlib.Path
+0000de00: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000de10: 7061 7265 6e74 733a 2070 6172 656e 7473  parents: parents
+0000de20: 2069 7320 6967 6e6f 7265 642c 206f 6e6c   is ignored, onl
+0000de30: 7920 6265 2063 6f6d 7061 7469 626c 6520  y be compatible 
+0000de40: 7769 7468 2070 6174 686c 6962 2e50 6174  with pathlib.Pat
+0000de50: 680a 2020 2020 2020 2020 3a70 6172 616d  h.        :param
+0000de60: 2065 7869 7374 5f6f 6b3a 2049 6620 4661   exist_ok: If Fa
+0000de70: 6c73 6520 616e 6420 7461 7267 6574 2064  lse and target d
+0000de80: 6972 6563 746f 7279 2065 7869 7374 732c  irectory exists,
+0000de90: 2072 6169 7365 2053 3346 696c 6545 7869   raise S3FileExi
+0000dea0: 7374 7345 7272 6f72 0a20 2020 2020 2020  stsError.       
+0000deb0: 203a 7261 6973 6573 3a20 5333 4275 636b   :raises: S3Buck
+0000dec0: 6574 4e6f 7446 6f75 6e64 4572 726f 722c  etNotFoundError,
+0000ded0: 2053 3346 696c 6545 7869 7374 7345 7272   S3FileExistsErr
+0000dee0: 6f72 0a20 2020 2020 2020 2027 2727 0a20  or.        '''. 
+0000def0: 2020 2020 2020 2062 7563 6b65 742c 205f         bucket, _
+0000df00: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
+0000df10: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000df20: 726f 746f 636f 6c29 0a20 2020 2020 2020  rotocol).       
+0000df30: 2069 6620 6e6f 7420 6275 636b 6574 3a0a   if not bucket:.
+0000df40: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000df50: 6520 5333 4275 636b 6574 4e6f 7446 6f75  e S3BucketNotFou
+0000df60: 6e64 4572 726f 7228 0a20 2020 2020 2020  ndError(.       
+0000df70: 2020 2020 2020 2020 2027 456d 7074 7920           'Empty 
+0000df80: 6275 636b 6574 206e 616d 653a 2025 7227  bucket name: %r'
+0000df90: 2025 2073 656c 662e 7061 7468 5f77 6974   % self.path_wit
+0000dfa0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+0000dfb0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+0000dfc0: 6861 7362 7563 6b65 7428 293a 0a20 2020  hasbucket():.   
+0000dfd0: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+0000dfe0: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
+0000dff0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000e000: 2020 2020 2020 274e 6f20 7375 6368 2062        'No such b
+0000e010: 7563 6b65 743a 2025 7227 2025 2073 656c  ucket: %r' % sel
+0000e020: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+0000e030: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
+0000e040: 2065 7869 7374 5f6f 6b3a 0a20 2020 2020   exist_ok:.     
+0000e050: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+0000e060: 735f 6669 6c65 2829 3a0a 2020 2020 2020  s_file():.      
+0000e070: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000e080: 5333 4669 6c65 4578 6973 7473 4572 726f  S3FileExistsErro
+0000e090: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000e0a0: 2020 2020 2020 2027 4669 6c65 2065 7869         'File exi
+0000e0b0: 7374 733a 2025 7227 2025 2073 656c 662e  sts: %r' % self.
+0000e0c0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+0000e0d0: 6f6c 290a 2020 2020 2020 2020 2020 2020  ol).            
+0000e0e0: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
+0000e0f0: 6620 7365 6c66 2e65 7869 7374 7328 293a  f self.exists():
+0000e100: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000e110: 7365 2053 3346 696c 6545 7869 7374 7345  se S3FileExistsE
+0000e120: 7272 6f72 2827 4669 6c65 2065 7869 7374  rror('File exist
+0000e130: 733a 2025 7227 2025 2073 656c 662e 7061  s: %r' % self.pa
+0000e140: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000e150: 290a 0a20 2020 2064 6566 206d 6f76 6528  )..    def move(
+0000e160: 7365 6c66 2c20 6473 745f 7572 6c3a 2050  self, dst_url: P
+0000e170: 6174 684c 696b 6529 202d 3e20 4e6f 6e65  athLike) -> None
+0000e180: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
+0000e190: 2020 2020 2020 4d6f 7665 2066 696c 652f        Move file/
+0000e1a0: 6469 7265 6374 6f72 7920 7061 7468 2066  directory path f
+0000e1b0: 726f 6d20 7372 635f 7572 6c20 746f 2064  rom src_url to d
+0000e1c0: 7374 5f75 726c 0a0a 2020 2020 2020 2020  st_url..        
+0000e1d0: 3a70 6172 616d 2064 7374 5f75 726c 3a20  :param dst_url: 
+0000e1e0: 4769 7665 6e20 6465 7374 696e 6174 696f  Given destinatio
+0000e1f0: 6e20 7061 7468 0a20 2020 2020 2020 2027  n path.        '
+0000e200: 2727 0a20 2020 2020 2020 2066 6f72 2073  ''.        for s
+0000e210: 7263 5f66 696c 655f 7061 7468 2c20 6473  rc_file_path, ds
+0000e220: 745f 6669 6c65 5f70 6174 6820 696e 205f  t_file_path in _
+0000e230: 7333 5f73 6361 6e5f 7061 6972 7328 0a20  s3_scan_pairs(. 
+0000e240: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000e250: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+0000e260: 6f74 6f63 6f6c 2c20 6473 745f 7572 6c29  otocol, dst_url)
+0000e270: 3a0a 2020 2020 2020 2020 2020 2020 5333  :.            S3
+0000e280: 5061 7468 2873 7263 5f66 696c 655f 7061  Path(src_file_pa
+0000e290: 7468 292e 7265 6e61 6d65 2864 7374 5f66  th).rename(dst_f
+0000e2a0: 696c 655f 7061 7468 290a 0a20 2020 2064  ile_path)..    d
+0000e2b0: 6566 2072 656d 6f76 6528 7365 6c66 2c20  ef remove(self, 
+0000e2c0: 6d69 7373 696e 675f 6f6b 3a20 626f 6f6c  missing_ok: bool
+0000e2d0: 203d 2046 616c 7365 2920 2d3e 204e 6f6e   = False) -> Non
+0000e2e0: 653a 0a20 2020 2020 2020 2027 2727 0a20  e:.        '''. 
+0000e2f0: 2020 2020 2020 2052 656d 6f76 6520 7468         Remove th
+0000e300: 6520 6669 6c65 206f 7220 6469 7265 6374  e file or direct
+0000e310: 6f72 7920 6f6e 2073 332c 2060 7333 3a2f  ory on s3, `s3:/
+0000e320: 2f60 2061 6e64 2060 7333 3a2f 2f62 7563  /` and `s3://buc
+0000e330: 6b65 7460 2061 7265 206e 6f74 2070 6572  ket` are not per
+0000e340: 6d69 7474 6564 2074 6f20 7265 6d6f 7665  mitted to remove
+0000e350: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0000e360: 206d 6973 7369 6e67 5f6f 6b3a 2069 6620   missing_ok: if 
+0000e370: 4661 6c73 6520 616e 6420 7461 7267 6574  False and target
+0000e380: 2066 696c 652f 6469 7265 6374 6f72 7920   file/directory 
+0000e390: 6e6f 7420 6578 6973 7473 2c20 7261 6973  not exists, rais
+0000e3a0: 6520 5333 4669 6c65 4e6f 7446 6f75 6e64  e S3FileNotFound
+0000e3b0: 4572 726f 720a 2020 2020 2020 2020 3a72  Error.        :r
+0000e3c0: 6169 7365 733a 2053 3350 6572 6d69 7373  aises: S3Permiss
+0000e3d0: 696f 6e45 7272 6f72 2c20 5333 4669 6c65  ionError, S3File
+0000e3e0: 4e6f 7446 6f75 6e64 4572 726f 722c 2055  NotFoundError, U
+0000e3f0: 6e73 7570 706f 7274 6564 4572 726f 720a  nsupportedError.
+0000e400: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+0000e410: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
+0000e420: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
+0000e430: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+0000e440: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+0000e450: 6966 206e 6f74 2062 7563 6b65 743a 0a20  if not bucket:. 
+0000e460: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0000e470: 7420 6b65 793a 0a20 2020 2020 2020 2020  t key:.         
+0000e480: 2020 2020 2020 2072 6169 7365 2055 6e73         raise Uns
+0000e490: 7570 706f 7274 6564 4572 726f 7228 0a20  upportedError(. 
+0000e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e4b0: 2020 2027 5265 6d6f 7665 2077 686f 6c65     'Remove whole
+0000e4c0: 2073 3327 2c20 7365 6c66 2e70 6174 685f   s3', self.path_
+0000e4d0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+0000e4e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000e4f0: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
+0000e500: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
+0000e510: 2020 2020 2020 2020 2745 6d70 7479 2062          'Empty b
+0000e520: 7563 6b65 7420 6e61 6d65 3a20 2572 2720  ucket name: %r' 
+0000e530: 2520 7365 6c66 2e70 6174 685f 7769 7468  % self.path_with
+0000e540: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
+0000e550: 2020 2069 6620 6e6f 7420 6b65 793a 0a20     if not key:. 
+0000e560: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000e570: 2055 6e73 7570 706f 7274 6564 4572 726f   UnsupportedErro
+0000e580: 7228 2752 656d 6f76 6520 6275 636b 6574  r('Remove bucket
+0000e590: 272c 2073 656c 662e 7061 7468 5f77 6974  ', self.path_wit
+0000e5a0: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+0000e5b0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+0000e5c0: 6578 6973 7473 2829 3a0a 2020 2020 2020  exists():.      
+0000e5d0: 2020 2020 2020 6966 206d 6973 7369 6e67        if missing
+0000e5e0: 5f6f 6b3a 0a20 2020 2020 2020 2020 2020  _ok:.           
+0000e5f0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0000e600: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+0000e610: 4669 6c65 4e6f 7446 6f75 6e64 4572 726f  FileNotFoundErro
+0000e620: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0000e630: 2020 2027 4e6f 2073 7563 6820 6669 6c65     'No such file
+0000e640: 206f 7220 6469 7265 6374 6f72 793a 2025   or directory: %
+0000e650: 7227 2025 2073 656c 662e 7061 7468 5f77  r' % self.path_w
+0000e660: 6974 685f 7072 6f74 6f63 6f6c 290a 0a20  ith_protocol).. 
+0000e670: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
+0000e680: 7365 6c66 2e5f 636c 6965 6e74 0a20 2020  self._client.   
+0000e690: 2020 2020 2077 6974 6820 7261 6973 655f       with raise_
+0000e6a0: 7333 5f65 7272 6f72 2873 656c 662e 7061  s3_error(self.pa
+0000e6b0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+0000e6c0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0000e6d0: 6620 7365 6c66 2e69 735f 6669 6c65 2829  f self.is_file()
+0000e6e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e6f0: 2020 636c 6965 6e74 2e64 656c 6574 655f    client.delete_
+0000e700: 6f62 6a65 6374 2842 7563 6b65 743d 6275  object(Bucket=bu
+0000e710: 636b 6574 2c20 4b65 793d 6b65 7929 0a20  cket, Key=key). 
+0000e720: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000e730: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
+0000e740: 2020 7072 6566 6978 203d 205f 6265 636f    prefix = _beco
+0000e750: 6d65 5f70 7265 6669 7828 6b65 7929 0a20  me_prefix(key). 
+0000e760: 2020 2020 2020 2020 2020 2074 6f74 616c             total
+0000e770: 5f63 6f75 6e74 2c20 6572 726f 725f 636f  _count, error_co
+0000e780: 756e 7420 3d20 302c 2030 0a20 2020 2020  unt = 0, 0.     
+0000e790: 2020 2020 2020 2066 6f72 2072 6573 7020         for resp 
+0000e7a0: 696e 205f 6c69 7374 5f6f 626a 6563 7473  in _list_objects
+0000e7b0: 5f72 6563 7572 7369 7665 2863 6c69 656e  _recursive(clien
+0000e7c0: 742c 2062 7563 6b65 742c 2070 7265 6669  t, bucket, prefi
+0000e7d0: 7829 3a0a 2020 2020 2020 2020 2020 2020  x):.            
+0000e7e0: 2020 2020 6966 2027 436f 6e74 656e 7473      if 'Contents
+0000e7f0: 2720 696e 2072 6573 703a 0a20 2020 2020  ' in resp:.     
+0000e800: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+0000e810: 6579 7320 3d20 5b0a 2020 2020 2020 2020  eys = [.        
+0000e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e830: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0000e840: 2020 2020 2020 2020 2020 2020 2020 274b                'K
+0000e850: 6579 273a 2063 6f6e 7465 6e74 5b27 4b65  ey': content['Ke
+0000e860: 7927 5d0a 2020 2020 2020 2020 2020 2020  y'].            
+0000e870: 2020 2020 2020 2020 2020 2020 7d20 666f              } fo
+0000e880: 7220 636f 6e74 656e 7420 696e 2072 6573  r content in res
+0000e890: 705b 2743 6f6e 7465 6e74 7327 5d0a 2020  p['Contents'].  
+0000e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8b0: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+0000e8c0: 2020 2020 2020 2020 746f 7461 6c5f 636f          total_co
+0000e8d0: 756e 7420 2b3d 206c 656e 286b 6579 7329  unt += len(keys)
+0000e8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e8f0: 2020 2020 2065 7272 6f72 7320 3d20 5b5d       errors = []
+0000e900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e910: 2020 2020 2072 6574 7269 6573 203d 2032       retries = 2
+0000e920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e930: 2020 2020 2072 6574 7279 5f69 6e74 6572       retry_inter
+0000e940: 7661 6c20 3d20 6d69 6e28 302e 3120 2a20  val = min(0.1 * 
+0000e950: 322a 2a72 6574 7269 6573 2c20 3330 290a  2**retries, 30).
+0000e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e970: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0000e980: 6765 2872 6574 7269 6573 293a 0a20 2020  ge(retries):.   
+0000e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9a0: 2020 2020 2023 2064 6f63 3a20 6874 7470       # doc: http
+0000e9b0: 733a 2f2f 626f 746f 332e 616d 617a 6f6e  s://boto3.amazon
+0000e9c0: 6177 732e 636f 6d2f 7631 2f64 6f63 756d  aws.com/v1/docum
+0000e9d0: 656e 7461 7469 6f6e 2f61 7069 2f6c 6174  entation/api/lat
+0000e9e0: 6573 742f 7265 6665 7265 6e63 652f 7365  est/reference/se
+0000e9f0: 7276 6963 6573 2f73 332e 6874 6d6c 2353  rvices/s3.html#S
+0000ea00: 332e 436c 6965 6e74 2e64 656c 6574 655f  3.Client.delete_
+0000ea10: 6f62 6a65 6374 730a 2020 2020 2020 2020  objects.        
+0000ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea30: 6966 206e 6f74 206b 6579 733a 0a20 2020  if not keys:.   
 0000ea40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea50: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
-0000ea60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000ea70: 6573 706f 6e73 6520 3d20 636c 6965 6e74  esponse = client
-0000ea80: 2e64 656c 6574 655f 6f62 6a65 6374 7328  .delete_objects(
-0000ea90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eaa0: 2020 2020 2020 2020 2020 2020 2042 7563               Buc
-0000eab0: 6b65 743d 6275 636b 6574 2c20 4465 6c65  ket=bucket, Dele
-0000eac0: 7465 3d7b 274f 626a 6563 7473 273a 206b  te={'Objects': k
-0000ead0: 6579 737d 290a 2020 2020 2020 2020 2020  eys}).          
-0000eae0: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-0000eaf0: 7973 203d 205b 5d0a 2020 2020 2020 2020  ys = [].        
+0000ea50: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+0000ea60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea70: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+0000ea80: 3d20 636c 6965 6e74 2e64 656c 6574 655f  = client.delete_
+0000ea90: 6f62 6a65 6374 7328 0a20 2020 2020 2020  objects(.       
+0000eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eab0: 2020 2020 2042 7563 6b65 743d 6275 636b       Bucket=buck
+0000eac0: 6574 2c20 4465 6c65 7465 3d7b 274f 626a  et, Delete={'Obj
+0000ead0: 6563 7473 273a 206b 6579 737d 290a 2020  ects': keys}).  
+0000eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eaf0: 2020 2020 2020 6b65 7973 203d 205b 5d0a        keys = [].
 0000eb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb10: 666f 7220 6572 726f 725f 696e 666f 2069  for error_info i
-0000eb20: 6e20 7265 7370 6f6e 7365 2e67 6574 2827  n response.get('
-0000eb30: 4572 726f 7273 272c 205b 5d29 3a0a 2020  Errors', []):.  
-0000eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb50: 2020 2020 2020 2020 2020 6966 2073 335f            if s3_
-0000eb60: 6572 726f 725f 636f 6465 5f73 686f 756c  error_code_shoul
-0000eb70: 645f 7265 7472 7928 0a20 2020 2020 2020  d_retry(.       
-0000eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb90: 2020 2020 2020 2020 2020 2020 2065 7272               err
-0000eba0: 6f72 5f69 6e66 6f2e 6765 7428 2743 6f64  or_info.get('Cod
-0000ebb0: 6527 2929 3a0a 2020 2020 2020 2020 2020  e')):.          
+0000eb10: 2020 2020 2020 2020 666f 7220 6572 726f          for erro
+0000eb20: 725f 696e 666f 2069 6e20 7265 7370 6f6e  r_info in respon
+0000eb30: 7365 2e67 6574 2827 4572 726f 7273 272c  se.get('Errors',
+0000eb40: 205b 5d29 3a0a 2020 2020 2020 2020 2020   []):.          
+0000eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb60: 2020 6966 2073 335f 6572 726f 725f 636f    if s3_error_co
+0000eb70: 6465 5f73 686f 756c 645f 7265 7472 7928  de_should_retry(
+0000eb80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eba0: 2020 2020 2065 7272 6f72 5f69 6e66 6f2e       error_info.
+0000ebb0: 6765 7428 2743 6f64 6527 2929 3a0a 2020  get('Code')):.  
 0000ebc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ebd0: 2020 2020 2020 6572 726f 725f 6c6f 6767        error_logg
-0000ebe0: 6572 2e77 6172 6e69 6e67 280a 2020 2020  er.warning(.    
-0000ebf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ebd0: 2020 2020 2020 2020 2020 2020 2020 6572                er
+0000ebe0: 726f 725f 6c6f 6767 6572 2e77 6172 6e69  ror_logger.warni
+0000ebf0: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
 0000ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec10: 2272 6574 7279 2025 7320 7469 6d65 732c  "retry %s times,
-0000ec20: 2072 656d 6f76 696e 6720 6669 6c65 3a20   removing file: 
-0000ec30: 2573 2c20 7769 7468 2065 7272 6f72 2025  %s, with error %
-0000ec40: 733a 2025 7322 0a20 2020 2020 2020 2020  s: %s".         
+0000ec10: 2020 2020 2020 2020 2272 6574 7279 2025          "retry %
+0000ec20: 7320 7469 6d65 732c 2072 656d 6f76 696e  s times, removin
+0000ec30: 6720 6669 6c65 3a20 2573 2c20 7769 7468  g file: %s, with
+0000ec40: 2065 7272 6f72 2025 733a 2025 7322 0a20   error %s: %s". 
 0000ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec60: 2020 2020 2020 2020 2020 2025 2028 0a20             % (. 
-0000ec70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ec70: 2020 2025 2028 0a20 2020 2020 2020 2020     % (.         
 0000ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ec90: 2020 2020 2020 2069 202b 2031 2c20 6572         i + 1, er
-0000eca0: 726f 725f 696e 666f 5b27 4b65 7927 5d2c  ror_info['Key'],
-0000ecb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ec90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000eca0: 202b 2031 2c20 6572 726f 725f 696e 666f   + 1, error_info
+0000ecb0: 5b27 4b65 7927 5d2c 0a20 2020 2020 2020  ['Key'],.       
 0000ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ecd0: 2020 2020 2020 2020 2065 7272 6f72 5f69           error_i
-0000ece0: 6e66 6f5b 2743 6f64 6527 5d2c 0a20 2020  nfo['Code'],.   
-0000ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ecd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ece0: 2065 7272 6f72 5f69 6e66 6f5b 2743 6f64   error_info['Cod
+0000ecf0: 6527 5d2c 0a20 2020 2020 2020 2020 2020  e'],.           
 0000ed00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed10: 2020 2020 2065 7272 6f72 5f69 6e66 6f5b       error_info[
-0000ed20: 274d 6573 7361 6765 275d 2929 0a20 2020  'Message'])).   
-0000ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed40: 2020 2020 2020 2020 2020 2020 206b 6579               key
-0000ed50: 732e 6170 7065 6e64 287b 274b 6579 273a  s.append({'Key':
-0000ed60: 2065 7272 6f72 5f69 6e66 6f5b 274b 6579   error_info['Key
-0000ed70: 275d 7d29 0a20 2020 2020 2020 2020 2020  ']}).           
+0000ed10: 2020 2020 2020 2020 2020 2020 2065 7272               err
+0000ed20: 6f72 5f69 6e66 6f5b 274d 6573 7361 6765  or_info['Message
+0000ed30: 275d 2929 0a20 2020 2020 2020 2020 2020  '])).           
+0000ed40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed50: 2020 2020 206b 6579 732e 6170 7065 6e64       keys.append
+0000ed60: 287b 274b 6579 273a 2065 7272 6f72 5f69  ({'Key': error_i
+0000ed70: 6e66 6f5b 274b 6579 275d 7d29 0a20 2020  nfo['Key']}).   
 0000ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed90: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000ed90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
 0000eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000edb0: 2020 2020 2020 2065 7272 6f72 732e 6170         errors.ap
-0000edc0: 7065 6e64 2865 7272 6f72 5f69 6e66 6f29  pend(error_info)
-0000edd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ede0: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
-0000edf0: 6565 7028 7265 7472 795f 696e 7465 7276  eep(retry_interv
-0000ee00: 616c 290a 2020 2020 2020 2020 2020 2020  al).            
-0000ee10: 2020 2020 2020 2020 666f 7220 6572 726f          for erro
-0000ee20: 725f 696e 666f 2069 6e20 6572 726f 7273  r_info in errors
-0000ee30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000ee40: 2020 2020 2020 2020 2020 6572 726f 725f            error_
-0000ee50: 6c6f 6767 6572 2e65 7272 6f72 280a 2020  logger.error(.  
-0000ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee70: 2020 2020 2020 2020 2020 2266 6169 6c65            "faile
-0000ee80: 6420 7265 6d6f 7665 2066 696c 653a 2025  d remove file: %
-0000ee90: 732c 2077 6974 6820 6572 726f 7220 2573  s, with error %s
-0000eea0: 3a20 2573 2220 2520 280a 2020 2020 2020  : %s" % (.      
-0000eeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eec0: 2020 2020 2020 2020 2020 6572 726f 725f            error_
-0000eed0: 696e 666f 5b27 4b65 7927 5d2c 2065 7272  info['Key'], err
-0000eee0: 6f72 5f69 6e66 6f5b 2743 6f64 6527 5d2c  or_info['Code'],
-0000eef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000edb0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000edc0: 7272 6f72 732e 6170 7065 6e64 2865 7272  rrors.append(err
+0000edd0: 6f72 5f69 6e66 6f29 0a20 2020 2020 2020  or_info).       
+0000ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000edf0: 2074 696d 652e 736c 6565 7028 7265 7472   time.sleep(retr
+0000ee00: 795f 696e 7465 7276 616c 290a 2020 2020  y_interval).    
+0000ee10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee20: 666f 7220 6572 726f 725f 696e 666f 2069  for error_info i
+0000ee30: 6e20 6572 726f 7273 3a0a 2020 2020 2020  n errors:.      
+0000ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee50: 2020 6572 726f 725f 6c6f 6767 6572 2e65    error_logger.e
+0000ee60: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee80: 2020 2266 6169 6c65 6420 7265 6d6f 7665    "failed remove
+0000ee90: 2066 696c 653a 2025 732c 2077 6974 6820   file: %s, with 
+0000eea0: 6572 726f 7220 2573 3a20 2573 2220 2520  error %s: %s" % 
+0000eeb0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000eec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eed0: 2020 6572 726f 725f 696e 666f 5b27 4b65    error_info['Ke
+0000eee0: 7927 5d2c 2065 7272 6f72 5f69 6e66 6f5b  y'], error_info[
+0000eef0: 2743 6f64 6527 5d2c 0a20 2020 2020 2020  'Code'],.       
 0000ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef10: 2065 7272 6f72 5f69 6e66 6f5b 274d 6573   error_info['Mes
-0000ef20: 7361 6765 275d 2929 0a20 2020 2020 2020  sage'])).       
-0000ef30: 2020 2020 2020 2020 2020 2020 2065 7272               err
-0000ef40: 6f72 5f63 6f75 6e74 202b 3d20 6c65 6e28  or_count += len(
-0000ef50: 6572 726f 7273 290a 2020 2020 2020 2020  errors).        
-0000ef60: 2020 2020 6966 2065 7272 6f72 5f63 6f75      if error_cou
-0000ef70: 6e74 203e 2030 3a0a 2020 2020 2020 2020  nt > 0:.        
-0000ef80: 2020 2020 2020 2020 6572 726f 725f 6d73          error_ms
-0000ef90: 6720 3d20 2266 6169 6c65 6420 7265 6d6f  g = "failed remo
-0000efa0: 7665 2070 6174 683a 2025 732c 2074 6f74  ve path: %s, tot
-0000efb0: 616c 2066 696c 6520 636f 756e 743a 2025  al file count: %
-0000efc0: 732c 2066 6169 6c65 6420 636f 756e 743a  s, failed count:
-0000efd0: 2025 7322 2025 2028 0a20 2020 2020 2020   %s" % (.       
-0000efe0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000eff0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000f000: 6f63 6f6c 2c20 746f 7461 6c5f 636f 756e  ocol, total_coun
-0000f010: 742c 2065 7272 6f72 5f63 6f75 6e74 290a  t, error_count).
-0000f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f030: 7261 6973 6520 5333 556e 6b6e 6f77 6e45  raise S3UnknownE
-0000f040: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-0000f050: 2020 2020 2020 2020 2020 4578 6365 7074            Except
-0000f060: 696f 6e28 6572 726f 725f 6d73 6729 2c20  ion(error_msg), 
-0000f070: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-0000f080: 726f 746f 636f 6c29 0a0a 2020 2020 6465  rotocol)..    de
-0000f090: 6620 7265 6e61 6d65 2873 656c 662c 2064  f rename(self, d
-0000f0a0: 7374 5f70 6174 683a 2050 6174 684c 696b  st_path: PathLik
-0000f0b0: 6529 202d 3e20 2753 3350 6174 6827 3a0a  e) -> 'S3Path':.
-0000f0c0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000f0d0: 2020 2020 4d6f 7665 2073 3320 6669 6c65      Move s3 file
-0000f0e0: 2070 6174 6820 6672 6f6d 2073 7263 5f75   path from src_u
-0000f0f0: 726c 2074 6f20 6473 745f 7572 6c0a 0a20  rl to dst_url.. 
-0000f100: 2020 2020 2020 203a 7061 7261 6d20 6473         :param ds
-0000f110: 745f 7061 7468 3a20 4769 7665 6e20 6465  t_path: Given de
-0000f120: 7374 696e 6174 696f 6e20 7061 7468 0a20  stination path. 
-0000f130: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000f140: 2020 2073 335f 7265 6e61 6d65 2873 656c     s3_rename(sel
-0000f150: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000f160: 6f63 6f6c 2c20 6473 745f 7061 7468 290a  ocol, dst_path).
-0000f170: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000f180: 656c 662e 6672 6f6d 5f70 6174 6828 6473  elf.from_path(ds
-0000f190: 745f 7061 7468 290a 0a20 2020 2064 6566  t_path)..    def
-0000f1a0: 2073 6361 6e28 7365 6c66 2c20 6d69 7373   scan(self, miss
-0000f1b0: 696e 675f 6f6b 3a20 626f 6f6c 203d 2054  ing_ok: bool = T
-0000f1c0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-0000f1d0: 2020 666f 6c6c 6f77 6c69 6e6b 733a 2062    followlinks: b
-0000f1e0: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
-0000f1f0: 4974 6572 6174 6f72 5b73 7472 5d3a 0a20  Iterator[str]:. 
-0000f200: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000f210: 2020 2049 7465 7261 7469 7665 6c79 2074     Iteratively t
-0000f220: 7261 7665 7273 6520 6f6e 6c79 2066 696c  raverse only fil
-0000f230: 6573 2069 6e20 6769 7665 6e20 7333 2064  es in given s3 d
-0000f240: 6972 6563 746f 7279 2c20 696e 2061 6c70  irectory, in alp
-0000f250: 6861 6265 7469 6361 6c20 6f72 6465 722e  habetical order.
-0000f260: 0a20 2020 2020 2020 2045 7665 7279 2069  .        Every i
-0000f270: 7465 7261 7469 6f6e 206f 6e20 6765 6e65  teration on gene
-0000f280: 7261 746f 7220 7969 656c 6473 2061 2070  rator yields a p
-0000f290: 6174 6820 7374 7269 6e67 2e0a 0a20 2020  ath string...   
-0000f2a0: 2020 2020 2049 6620 7333 5f75 726c 2069       If s3_url i
-0000f2b0: 7320 6120 6669 6c65 2070 6174 682c 2079  s a file path, y
-0000f2c0: 6965 6c64 7320 7468 6520 6669 6c65 206f  ields the file o
-0000f2d0: 6e6c 790a 2020 2020 2020 2020 4966 2073  nly.        If s
-0000f2e0: 335f 7572 6c20 6973 2061 206e 6f6e 2d65  3_url is a non-e
-0000f2f0: 7869 7374 656e 7420 7061 7468 2c20 7265  xistent path, re
-0000f300: 7475 726e 2061 6e20 656d 7074 7920 6765  turn an empty ge
-0000f310: 6e65 7261 746f 720a 2020 2020 2020 2020  nerator.        
-0000f320: 4966 2073 335f 7572 6c20 6973 2061 2062  If s3_url is a b
-0000f330: 7563 6b65 7420 7061 7468 2c20 7265 7475  ucket path, retu
-0000f340: 726e 2061 6c6c 2066 696c 6520 7061 7468  rn all file path
-0000f350: 7320 696e 2074 6865 2062 7563 6b65 740a  s in the bucket.
-0000f360: 2020 2020 2020 2020 4966 2073 335f 7572          If s3_ur
-0000f370: 6c20 6973 2061 6e20 656d 7074 7920 6275  l is an empty bu
-0000f380: 636b 6574 2c20 7265 7475 726e 2061 6e20  cket, return an 
-0000f390: 656d 7074 7920 6765 6e65 7261 746f 720a  empty generator.
-0000f3a0: 2020 2020 2020 2020 4966 2073 335f 7572          If s3_ur
-0000f3b0: 6c20 646f 6573 6e27 7420 636f 6e74 6169  l doesn't contai
-0000f3c0: 6e20 616e 7920 6275 636b 6574 2c20 7768  n any bucket, wh
-0000f3d0: 6963 6820 6973 2073 335f 7572 6c20 3d3d  ich is s3_url ==
-0000f3e0: 2027 7333 3a2f 2f27 2c20 7261 6973 6520   's3://', raise 
-0000f3f0: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
-0000f400: 2e20 7761 6c6b 2829 206f 6e20 636f 6d70  . walk() on comp
-0000f410: 6c65 7465 2073 3320 6973 206e 6f74 2073  lete s3 is not s
-0000f420: 7570 706f 7274 6564 2069 6e20 6d65 6766  upported in megf
-0000f430: 696c 650a 0a20 2020 2020 2020 203a 7061  ile..        :pa
-0000f440: 7261 6d20 6d69 7373 696e 675f 6f6b 3a20  ram missing_ok: 
-0000f450: 4966 2046 616c 7365 2061 6e64 2074 6865  If False and the
-0000f460: 7265 2773 206e 6f20 6669 6c65 2069 6e20  re's no file in 
-0000f470: 7468 6520 6469 7265 6374 6f72 792c 2072  the directory, r
-0000f480: 6169 7365 2046 696c 654e 6f74 466f 756e  aise FileNotFoun
-0000f490: 6445 7272 6f72 0a20 2020 2020 2020 203a  dError.        :
-0000f4a0: 7261 6973 6573 3a20 556e 7375 7070 6f72  raises: Unsuppor
-0000f4b0: 7465 6445 7272 6f72 0a20 2020 2020 2020  tedError.       
-0000f4c0: 203a 7265 7475 726e 733a 2041 2066 696c   :returns: A fil
-0000f4d0: 6520 7061 7468 2067 656e 6572 6174 6f72  e path generator
-0000f4e0: 0a20 2020 2020 2020 2027 2727 0a20 2020  .        '''.   
-0000f4f0: 2020 2020 2073 6361 6e5f 7374 6174 5f69       scan_stat_i
-0000f500: 7465 7220 3d20 7365 6c66 2e73 6361 6e5f  ter = self.scan_
-0000f510: 7374 6174 280a 2020 2020 2020 2020 2020  stat(.          
-0000f520: 2020 6d69 7373 696e 675f 6f6b 3d6d 6973    missing_ok=mis
-0000f530: 7369 6e67 5f6f 6b2c 2066 6f6c 6c6f 776c  sing_ok, followl
-0000f540: 696e 6b73 3d66 6f6c 6c6f 776c 696e 6b73  inks=followlinks
-0000f550: 290a 0a20 2020 2020 2020 2064 6566 2063  )..        def c
-0000f560: 7265 6174 655f 6765 6e65 7261 746f 7228  reate_generator(
-0000f570: 2920 2d3e 2049 7465 7261 746f 725b 7374  ) -> Iterator[st
-0000f580: 725d 3a0a 2020 2020 2020 2020 2020 2020  r]:.            
-0000f590: 666f 7220 6669 6c65 5f65 6e74 7279 2069  for file_entry i
-0000f5a0: 6e20 7363 616e 5f73 7461 745f 6974 6572  n scan_stat_iter
-0000f5b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f5c0: 2020 7969 656c 6420 6669 6c65 5f65 6e74    yield file_ent
-0000f5d0: 7279 2e70 6174 680a 0a20 2020 2020 2020  ry.path..       
-0000f5e0: 2072 6574 7572 6e20 6372 6561 7465 5f67   return create_g
-0000f5f0: 656e 6572 6174 6f72 2829 0a0a 2020 2020  enerator()..    
-0000f600: 6465 6620 7363 616e 5f73 7461 7428 7365  def scan_stat(se
-0000f610: 6c66 2c20 6d69 7373 696e 675f 6f6b 3a20  lf, missing_ok: 
-0000f620: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-0000f630: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000f640: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
-0000f650: 203d 2046 616c 7365 2920 2d3e 2049 7465   = False) -> Ite
-0000f660: 7261 746f 725b 4669 6c65 456e 7472 795d  rator[FileEntry]
-0000f670: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
-0000f680: 2020 2020 2020 4974 6572 6174 6976 656c        Iterativel
-0000f690: 7920 7472 6176 6572 7365 206f 6e6c 7920  y traverse only 
-0000f6a0: 6669 6c65 7320 696e 2067 6976 656e 2064  files in given d
-0000f6b0: 6972 6563 746f 7279 2c20 696e 2061 6c70  irectory, in alp
-0000f6c0: 6861 6265 7469 6361 6c20 6f72 6465 722e  habetical order.
-0000f6d0: 0a20 2020 2020 2020 2045 7665 7279 2069  .        Every i
-0000f6e0: 7465 7261 7469 6f6e 206f 6e20 6765 6e65  teration on gene
-0000f6f0: 7261 746f 7220 7969 656c 6473 2061 2074  rator yields a t
-0000f700: 7570 6c65 206f 6620 7061 7468 2073 7472  uple of path str
-0000f710: 696e 6720 616e 6420 6669 6c65 2073 7461  ing and file sta
-0000f720: 740a 0a20 2020 2020 2020 203a 7061 7261  t..        :para
-0000f730: 6d20 6d69 7373 696e 675f 6f6b 3a20 4966  m missing_ok: If
-0000f740: 2046 616c 7365 2061 6e64 2074 6865 7265   False and there
-0000f750: 2773 206e 6f20 6669 6c65 2069 6e20 7468  's no file in th
-0000f760: 6520 6469 7265 6374 6f72 792c 2072 6169  e directory, rai
-0000f770: 7365 2046 696c 654e 6f74 466f 756e 6445  se FileNotFoundE
-0000f780: 7272 6f72 0a20 2020 2020 2020 203a 7261  rror.        :ra
-0000f790: 6973 6573 3a20 556e 7375 7070 6f72 7465  ises: Unsupporte
-0000f7a0: 6445 7272 6f72 0a20 2020 2020 2020 203a  dError.        :
-0000f7b0: 7265 7475 726e 733a 2041 2066 696c 6520  returns: A file 
-0000f7c0: 7061 7468 2067 656e 6572 6174 6f72 0a20  path generator. 
-0000f7d0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-0000f7e0: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
-0000f7f0: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
-0000f800: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-0000f810: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
-0000f820: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
-0000f830: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000f840: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
-0000f850: 2827 5363 616e 2077 686f 6c65 2073 3327  ('Scan whole s3'
-0000f860: 2c20 7365 6c66 2e70 6174 685f 7769 7468  , self.path_with
-0000f870: 5f70 726f 746f 636f 6c29 0a0a 2020 2020  _protocol)..    
-0000f880: 2020 2020 6465 6620 6372 6561 7465 5f67      def create_g
-0000f890: 656e 6572 6174 6f72 2829 202d 3e20 4974  enerator() -> It
-0000f8a0: 6572 6174 6f72 5b46 696c 6545 6e74 7279  erator[FileEntry
-0000f8b0: 5d3a 0a20 2020 2020 2020 2020 2020 2069  ]:.            i
-0000f8c0: 6620 6e6f 7420 7365 6c66 2e69 735f 6469  f not self.is_di
-0000f8d0: 7228 293a 0a20 2020 2020 2020 2020 2020  r():.           
-0000f8e0: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
-0000f8f0: 6669 6c65 2829 3a0a 2020 2020 2020 2020  file():.        
-0000f900: 2020 2020 2020 2020 2020 2020 2320 4f6e              # On
-0000f910: 2073 332c 2066 696c 6520 616e 6420 6469   s3, file and di
-0000f920: 7265 6374 6f72 7920 6d61 7920 6265 206f  rectory may be o
-0000f930: 6620 7361 6d65 206e 616d 6520 616e 6420  f same name and 
-0000f940: 6c65 7665 6c2c 2073 6f20 6e65 6564 2074  level, so need t
-0000f950: 6f20 7465 7374 2074 6865 2070 6174 6820  o test the path 
-0000f960: 6973 2066 696c 6520 6f72 2064 6972 6563  is file or direc
-0000f970: 746f 7279 0a20 2020 2020 2020 2020 2020  tory.           
-0000f980: 2020 2020 2020 2020 2079 6965 6c64 2046           yield F
-0000f990: 696c 6545 6e74 7279 280a 2020 2020 2020  ileEntry(.      
-0000f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9b0: 2020 7365 6c66 2e6e 616d 652c 2066 7370    self.name, fsp
-0000f9c0: 6174 6828 7365 6c66 2e70 6174 685f 7769  ath(self.path_wi
-0000f9d0: 7468 5f70 726f 746f 636f 6c29 2c0a 2020  th_protocol),.  
-0000f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9f0: 2020 2020 2020 7365 6c66 2e73 7461 7428        self.stat(
-0000fa00: 666f 6c6c 6f77 5f73 796d 6c69 6e6b 733d  follow_symlinks=
-0000fa10: 666f 6c6c 6f77 6c69 6e6b 7329 290a 2020  followlinks)).  
-0000fa20: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000fa30: 7475 726e 0a0a 2020 2020 2020 2020 2020  turn..          
-0000fa40: 2020 6966 206e 6f74 206b 6579 2e65 6e64    if not key.end
-0000fa50: 7377 6974 6828 272f 2729 2061 6e64 2073  swith('/') and s
-0000fa60: 656c 662e 6973 5f66 696c 6528 293a 0a20  elf.is_file():. 
-0000fa70: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-0000fa80: 6965 6c64 2046 696c 6545 6e74 7279 280a  ield FileEntry(.
-0000fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000faa0: 2020 2020 7365 6c66 2e6e 616d 652c 2066      self.name, f
-0000fab0: 7370 6174 6828 7365 6c66 2e70 6174 685f  spath(self.path_
-0000fac0: 7769 7468 5f70 726f 746f 636f 6c29 2c0a  with_protocol),.
-0000fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fae0: 2020 2020 7365 6c66 2e73 7461 7428 666f      self.stat(fo
-0000faf0: 6c6c 6f77 5f73 796d 6c69 6e6b 733d 666f  llow_symlinks=fo
-0000fb00: 6c6c 6f77 6c69 6e6b 7329 290a 0a20 2020  llowlinks))..   
-0000fb10: 2020 2020 2020 2020 2070 7265 6669 7820           prefix 
-0000fb20: 3d20 5f62 6563 6f6d 655f 7072 6566 6978  = _become_prefix
-0000fb30: 286b 6579 290a 2020 2020 2020 2020 2020  (key).          
-0000fb40: 2020 636c 6965 6e74 203d 2073 656c 662e    client = self.
-0000fb50: 5f63 6c69 656e 740a 2020 2020 2020 2020  _client.        
-0000fb60: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
-0000fb70: 335f 6572 726f 7228 7365 6c66 2e70 6174  3_error(self.pat
-0000fb80: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000fb90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000fba0: 2020 666f 7220 7265 7370 2069 6e20 5f6c    for resp in _l
-0000fbb0: 6973 745f 6f62 6a65 6374 735f 7265 6375  ist_objects_recu
-0000fbc0: 7273 6976 6528 636c 6965 6e74 2c20 6275  rsive(client, bu
-0000fbd0: 636b 6574 2c20 7072 6566 6978 293a 0a20  cket, prefix):. 
-0000fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fbf0: 2020 2066 6f72 2063 6f6e 7465 6e74 2069     for content i
-0000fc00: 6e20 7265 7370 2e67 6574 2827 436f 6e74  n resp.get('Cont
-0000fc10: 656e 7473 272c 205b 5d29 3a0a 2020 2020  ents', []):.    
-0000fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc30: 2020 2020 6675 6c6c 5f70 6174 6820 3d20      full_path = 
-0000fc40: 7333 5f70 6174 685f 6a6f 696e 280a 2020  s3_path_join(.  
-0000fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc60: 2020 2020 2020 2020 2020 6627 7b73 656c            f'{sel
-0000fc70: 662e 5f70 726f 746f 636f 6c5f 7769 7468  f._protocol_with
-0000fc80: 5f70 726f 6669 6c65 7d3a 2f2f 272c 2062  _profile}://', b
-0000fc90: 7563 6b65 742c 0a20 2020 2020 2020 2020  ucket,.         
+0000ef10: 2020 2020 2020 2020 2065 7272 6f72 5f69           error_i
+0000ef20: 6e66 6f5b 274d 6573 7361 6765 275d 2929  nfo['Message']))
+0000ef30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ef40: 2020 2020 2065 7272 6f72 5f63 6f75 6e74       error_count
+0000ef50: 202b 3d20 6c65 6e28 6572 726f 7273 290a   += len(errors).
+0000ef60: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+0000ef70: 7272 6f72 5f63 6f75 6e74 203e 2030 3a0a  rror_count > 0:.
+0000ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef90: 6572 726f 725f 6d73 6720 3d20 2266 6169  error_msg = "fai
+0000efa0: 6c65 6420 7265 6d6f 7665 2070 6174 683a  led remove path:
+0000efb0: 2025 732c 2074 6f74 616c 2066 696c 6520   %s, total file 
+0000efc0: 636f 756e 743a 2025 732c 2066 6169 6c65  count: %s, faile
+0000efd0: 6420 636f 756e 743a 2025 7322 2025 2028  d count: %s" % (
+0000efe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000eff0: 2020 2020 2073 656c 662e 7061 7468 5f77       self.path_w
+0000f000: 6974 685f 7072 6f74 6f63 6f6c 2c20 746f  ith_protocol, to
+0000f010: 7461 6c5f 636f 756e 742c 2065 7272 6f72  tal_count, error
+0000f020: 5f63 6f75 6e74 290a 2020 2020 2020 2020  _count).        
+0000f030: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+0000f040: 556e 6b6e 6f77 6e45 7272 6f72 280a 2020  UnknownError(.  
+0000f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f060: 2020 4578 6365 7074 696f 6e28 6572 726f    Exception(erro
+0000f070: 725f 6d73 6729 2c20 7365 6c66 2e70 6174  r_msg), self.pat
+0000f080: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
+0000f090: 0a0a 2020 2020 6465 6620 7265 6e61 6d65  ..    def rename
+0000f0a0: 2873 656c 662c 2064 7374 5f70 6174 683a  (self, dst_path:
+0000f0b0: 2050 6174 684c 696b 6529 202d 3e20 2753   PathLike) -> 'S
+0000f0c0: 3350 6174 6827 3a0a 2020 2020 2020 2020  3Path':.        
+0000f0d0: 2727 270a 2020 2020 2020 2020 4d6f 7665  '''.        Move
+0000f0e0: 2073 3320 6669 6c65 2070 6174 6820 6672   s3 file path fr
+0000f0f0: 6f6d 2073 7263 5f75 726c 2074 6f20 6473  om src_url to ds
+0000f100: 745f 7572 6c0a 0a20 2020 2020 2020 203a  t_url..        :
+0000f110: 7061 7261 6d20 6473 745f 7061 7468 3a20  param dst_path: 
+0000f120: 4769 7665 6e20 6465 7374 696e 6174 696f  Given destinatio
+0000f130: 6e20 7061 7468 0a20 2020 2020 2020 2027  n path.        '
+0000f140: 2727 0a20 2020 2020 2020 2073 335f 7265  ''.        s3_re
+0000f150: 6e61 6d65 2873 656c 662e 7061 7468 5f77  name(self.path_w
+0000f160: 6974 685f 7072 6f74 6f63 6f6c 2c20 6473  ith_protocol, ds
+0000f170: 745f 7061 7468 290a 2020 2020 2020 2020  t_path).        
+0000f180: 7265 7475 726e 2073 656c 662e 6672 6f6d  return self.from
+0000f190: 5f70 6174 6828 6473 745f 7061 7468 290a  _path(dst_path).
+0000f1a0: 0a20 2020 2064 6566 2073 6361 6e28 7365  .    def scan(se
+0000f1b0: 6c66 2c20 6d69 7373 696e 675f 6f6b 3a20  lf, missing_ok: 
+0000f1c0: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+0000f1d0: 2020 2020 2020 2020 2020 666f 6c6c 6f77            follow
+0000f1e0: 6c69 6e6b 733a 2062 6f6f 6c20 3d20 4661  links: bool = Fa
+0000f1f0: 6c73 6529 202d 3e20 4974 6572 6174 6f72  lse) -> Iterator
+0000f200: 5b73 7472 5d3a 0a20 2020 2020 2020 2027  [str]:.        '
+0000f210: 2727 0a20 2020 2020 2020 2049 7465 7261  ''.        Itera
+0000f220: 7469 7665 6c79 2074 7261 7665 7273 6520  tively traverse 
+0000f230: 6f6e 6c79 2066 696c 6573 2069 6e20 6769  only files in gi
+0000f240: 7665 6e20 7333 2064 6972 6563 746f 7279  ven s3 directory
+0000f250: 2c20 696e 2061 6c70 6861 6265 7469 6361  , in alphabetica
+0000f260: 6c20 6f72 6465 722e 0a20 2020 2020 2020  l order..       
+0000f270: 2045 7665 7279 2069 7465 7261 7469 6f6e   Every iteration
+0000f280: 206f 6e20 6765 6e65 7261 746f 7220 7969   on generator yi
+0000f290: 656c 6473 2061 2070 6174 6820 7374 7269  elds a path stri
+0000f2a0: 6e67 2e0a 0a20 2020 2020 2020 2049 6620  ng...        If 
+0000f2b0: 7333 5f75 726c 2069 7320 6120 6669 6c65  s3_url is a file
+0000f2c0: 2070 6174 682c 2079 6965 6c64 7320 7468   path, yields th
+0000f2d0: 6520 6669 6c65 206f 6e6c 790a 2020 2020  e file only.    
+0000f2e0: 2020 2020 4966 2073 335f 7572 6c20 6973      If s3_url is
+0000f2f0: 2061 206e 6f6e 2d65 7869 7374 656e 7420   a non-existent 
+0000f300: 7061 7468 2c20 7265 7475 726e 2061 6e20  path, return an 
+0000f310: 656d 7074 7920 6765 6e65 7261 746f 720a  empty generator.
+0000f320: 2020 2020 2020 2020 4966 2073 335f 7572          If s3_ur
+0000f330: 6c20 6973 2061 2062 7563 6b65 7420 7061  l is a bucket pa
+0000f340: 7468 2c20 7265 7475 726e 2061 6c6c 2066  th, return all f
+0000f350: 696c 6520 7061 7468 7320 696e 2074 6865  ile paths in the
+0000f360: 2062 7563 6b65 740a 2020 2020 2020 2020   bucket.        
+0000f370: 4966 2073 335f 7572 6c20 6973 2061 6e20  If s3_url is an 
+0000f380: 656d 7074 7920 6275 636b 6574 2c20 7265  empty bucket, re
+0000f390: 7475 726e 2061 6e20 656d 7074 7920 6765  turn an empty ge
+0000f3a0: 6e65 7261 746f 720a 2020 2020 2020 2020  nerator.        
+0000f3b0: 4966 2073 335f 7572 6c20 646f 6573 6e27  If s3_url doesn'
+0000f3c0: 7420 636f 6e74 6169 6e20 616e 7920 6275  t contain any bu
+0000f3d0: 636b 6574 2c20 7768 6963 6820 6973 2073  cket, which is s
+0000f3e0: 335f 7572 6c20 3d3d 2027 7333 3a2f 2f27  3_url == 's3://'
+0000f3f0: 2c20 7261 6973 6520 556e 7375 7070 6f72  , raise Unsuppor
+0000f400: 7465 6445 7272 6f72 2e20 7761 6c6b 2829  tedError. walk()
+0000f410: 206f 6e20 636f 6d70 6c65 7465 2073 3320   on complete s3 
+0000f420: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
+0000f430: 2069 6e20 6d65 6766 696c 650a 0a20 2020   in megfile..   
+0000f440: 2020 2020 203a 7061 7261 6d20 6d69 7373       :param miss
+0000f450: 696e 675f 6f6b 3a20 4966 2046 616c 7365  ing_ok: If False
+0000f460: 2061 6e64 2074 6865 7265 2773 206e 6f20   and there's no 
+0000f470: 6669 6c65 2069 6e20 7468 6520 6469 7265  file in the dire
+0000f480: 6374 6f72 792c 2072 6169 7365 2046 696c  ctory, raise Fil
+0000f490: 654e 6f74 466f 756e 6445 7272 6f72 0a20  eNotFoundError. 
+0000f4a0: 2020 2020 2020 203a 7261 6973 6573 3a20         :raises: 
+0000f4b0: 556e 7375 7070 6f72 7465 6445 7272 6f72  UnsupportedError
+0000f4c0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000f4d0: 733a 2041 2066 696c 6520 7061 7468 2067  s: A file path g
+0000f4e0: 656e 6572 6174 6f72 0a20 2020 2020 2020  enerator.       
+0000f4f0: 2027 2727 0a20 2020 2020 2020 2073 6361   '''.        sca
+0000f500: 6e5f 7374 6174 5f69 7465 7220 3d20 7365  n_stat_iter = se
+0000f510: 6c66 2e73 6361 6e5f 7374 6174 280a 2020  lf.scan_stat(.  
+0000f520: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
+0000f530: 675f 6f6b 3d6d 6973 7369 6e67 5f6f 6b2c  g_ok=missing_ok,
+0000f540: 2066 6f6c 6c6f 776c 696e 6b73 3d66 6f6c   followlinks=fol
+0000f550: 6c6f 776c 696e 6b73 290a 0a20 2020 2020  lowlinks)..     
+0000f560: 2020 2064 6566 2063 7265 6174 655f 6765     def create_ge
+0000f570: 6e65 7261 746f 7228 2920 2d3e 2049 7465  nerator() -> Ite
+0000f580: 7261 746f 725b 7374 725d 3a0a 2020 2020  rator[str]:.    
+0000f590: 2020 2020 2020 2020 666f 7220 6669 6c65          for file
+0000f5a0: 5f65 6e74 7279 2069 6e20 7363 616e 5f73  _entry in scan_s
+0000f5b0: 7461 745f 6974 6572 3a0a 2020 2020 2020  tat_iter:.      
+0000f5c0: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
+0000f5d0: 6669 6c65 5f65 6e74 7279 2e70 6174 680a  file_entry.path.
+0000f5e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000f5f0: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
+0000f600: 2829 0a0a 2020 2020 6465 6620 7363 616e  ()..    def scan
+0000f610: 5f73 7461 7428 7365 6c66 2c20 6d69 7373  _stat(self, miss
+0000f620: 696e 675f 6f6b 3a20 626f 6f6c 203d 2054  ing_ok: bool = T
+0000f630: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0000f640: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
+0000f650: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
+0000f660: 2920 2d3e 2049 7465 7261 746f 725b 4669  ) -> Iterator[Fi
+0000f670: 6c65 456e 7472 795d 3a0a 2020 2020 2020  leEntry]:.      
+0000f680: 2020 2727 270a 2020 2020 2020 2020 4974    '''.        It
+0000f690: 6572 6174 6976 656c 7920 7472 6176 6572  eratively traver
+0000f6a0: 7365 206f 6e6c 7920 6669 6c65 7320 696e  se only files in
+0000f6b0: 2067 6976 656e 2064 6972 6563 746f 7279   given directory
+0000f6c0: 2c20 696e 2061 6c70 6861 6265 7469 6361  , in alphabetica
+0000f6d0: 6c20 6f72 6465 722e 0a20 2020 2020 2020  l order..       
+0000f6e0: 2045 7665 7279 2069 7465 7261 7469 6f6e   Every iteration
+0000f6f0: 206f 6e20 6765 6e65 7261 746f 7220 7969   on generator yi
+0000f700: 656c 6473 2061 2074 7570 6c65 206f 6620  elds a tuple of 
+0000f710: 7061 7468 2073 7472 696e 6720 616e 6420  path string and 
+0000f720: 6669 6c65 2073 7461 740a 0a20 2020 2020  file stat..     
+0000f730: 2020 203a 7061 7261 6d20 6d69 7373 696e     :param missin
+0000f740: 675f 6f6b 3a20 4966 2046 616c 7365 2061  g_ok: If False a
+0000f750: 6e64 2074 6865 7265 2773 206e 6f20 6669  nd there's no fi
+0000f760: 6c65 2069 6e20 7468 6520 6469 7265 6374  le in the direct
+0000f770: 6f72 792c 2072 6169 7365 2046 696c 654e  ory, raise FileN
+0000f780: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
+0000f790: 2020 2020 203a 7261 6973 6573 3a20 556e       :raises: Un
+0000f7a0: 7375 7070 6f72 7465 6445 7272 6f72 0a20  supportedError. 
+0000f7b0: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+0000f7c0: 2041 2066 696c 6520 7061 7468 2067 656e   A file path gen
+0000f7d0: 6572 6174 6f72 0a20 2020 2020 2020 2027  erator.        '
+0000f7e0: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
+0000f7f0: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+0000f800: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
+0000f810: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+0000f820: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
+0000f830: 636b 6574 3a0a 2020 2020 2020 2020 2020  cket:.          
+0000f840: 2020 7261 6973 6520 556e 7375 7070 6f72    raise Unsuppor
+0000f850: 7465 6445 7272 6f72 2827 5363 616e 2077  tedError('Scan w
+0000f860: 686f 6c65 2073 3327 2c20 7365 6c66 2e70  hole s3', self.p
+0000f870: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+0000f880: 6c29 0a0a 2020 2020 2020 2020 6465 6620  l)..        def 
+0000f890: 6372 6561 7465 5f67 656e 6572 6174 6f72  create_generator
+0000f8a0: 2829 202d 3e20 4974 6572 6174 6f72 5b46  () -> Iterator[F
+0000f8b0: 696c 6545 6e74 7279 5d3a 0a20 2020 2020  ileEntry]:.     
+0000f8c0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+0000f8d0: 6c66 2e69 735f 6469 7228 293a 0a20 2020  lf.is_dir():.   
+0000f8e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000f8f0: 7365 6c66 2e69 735f 6669 6c65 2829 3a0a  self.is_file():.
+0000f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f910: 2020 2020 2320 4f6e 2073 332c 2066 696c      # On s3, fil
+0000f920: 6520 616e 6420 6469 7265 6374 6f72 7920  e and directory 
+0000f930: 6d61 7920 6265 206f 6620 7361 6d65 206e  may be of same n
+0000f940: 616d 6520 616e 6420 6c65 7665 6c2c 2073  ame and level, s
+0000f950: 6f20 6e65 6564 2074 6f20 7465 7374 2074  o need to test t
+0000f960: 6865 2070 6174 6820 6973 2066 696c 6520  he path is file 
+0000f970: 6f72 2064 6972 6563 746f 7279 0a20 2020  or directory.   
+0000f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f990: 2079 6965 6c64 2046 696c 6545 6e74 7279   yield FileEntry
+0000f9a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000f9b0: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
+0000f9c0: 616d 652c 2066 7370 6174 6828 7365 6c66  ame, fspath(self
+0000f9d0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+0000f9e0: 636f 6c29 2c0a 2020 2020 2020 2020 2020  col),.          
+0000f9f0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000fa00: 6c66 2e73 7461 7428 666f 6c6c 6f77 5f73  lf.stat(follow_s
+0000fa10: 796d 6c69 6e6b 733d 666f 6c6c 6f77 6c69  ymlinks=followli
+0000fa20: 6e6b 7329 290a 2020 2020 2020 2020 2020  nks)).          
+0000fa30: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0000fa40: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0000fa50: 206b 6579 2e65 6e64 7377 6974 6828 272f   key.endswith('/
+0000fa60: 2729 2061 6e64 2073 656c 662e 6973 5f66  ') and self.is_f
+0000fa70: 696c 6528 293a 0a20 2020 2020 2020 2020  ile():.         
+0000fa80: 2020 2020 2020 2079 6965 6c64 2046 696c         yield Fil
+0000fa90: 6545 6e74 7279 280a 2020 2020 2020 2020  eEntry(.        
+0000faa0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000fab0: 2e6e 616d 652c 2066 7370 6174 6828 7365  .name, fspath(se
+0000fac0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
+0000fad0: 746f 636f 6c29 2c0a 2020 2020 2020 2020  tocol),.        
+0000fae0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000faf0: 2e73 7461 7428 666f 6c6c 6f77 5f73 796d  .stat(follow_sym
+0000fb00: 6c69 6e6b 733d 666f 6c6c 6f77 6c69 6e6b  links=followlink
+0000fb10: 7329 290a 0a20 2020 2020 2020 2020 2020  s))..           
+0000fb20: 2070 7265 6669 7820 3d20 5f62 6563 6f6d   prefix = _becom
+0000fb30: 655f 7072 6566 6978 286b 6579 290a 2020  e_prefix(key).  
+0000fb40: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+0000fb50: 203d 2073 656c 662e 5f63 6c69 656e 740a   = self._client.
+0000fb60: 2020 2020 2020 2020 2020 2020 7769 7468              with
+0000fb70: 2072 6169 7365 5f73 335f 6572 726f 7228   raise_s3_error(
+0000fb80: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000fb90: 726f 746f 636f 6c29 3a0a 2020 2020 2020  rotocol):.      
+0000fba0: 2020 2020 2020 2020 2020 666f 7220 7265            for re
+0000fbb0: 7370 2069 6e20 5f6c 6973 745f 6f62 6a65  sp in _list_obje
+0000fbc0: 6374 735f 7265 6375 7273 6976 6528 636c  cts_recursive(cl
+0000fbd0: 6965 6e74 2c20 6275 636b 6574 2c20 7072  ient, bucket, pr
+0000fbe0: 6566 6978 293a 0a20 2020 2020 2020 2020  efix):.         
+0000fbf0: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+0000fc00: 6f6e 7465 6e74 2069 6e20 7265 7370 2e67  ontent in resp.g
+0000fc10: 6574 2827 436f 6e74 656e 7473 272c 205b  et('Contents', [
+0000fc20: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+0000fc30: 2020 2020 2020 2020 2020 2020 6675 6c6c              full
+0000fc40: 5f70 6174 6820 3d20 7333 5f70 6174 685f  _path = s3_path_
+0000fc50: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+0000fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc70: 2020 6627 7b73 656c 662e 5f70 726f 746f    f'{self._proto
+0000fc80: 636f 6c5f 7769 7468 5f70 726f 6669 6c65  col_with_profile
+0000fc90: 7d3a 2f2f 272c 2062 7563 6b65 742c 0a20  }://', bucket,. 
 0000fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fcb0: 2020 2063 6f6e 7465 6e74 5b27 4b65 7927     content['Key'
-0000fcc0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-0000fcd0: 2020 2020 2020 2020 2020 2079 6965 6c64             yield
-0000fce0: 2046 696c 6545 6e74 7279 280a 2020 2020   FileEntry(.    
-0000fcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd00: 2020 2020 2020 2020 5333 5061 7468 2866          S3Path(f
-0000fd10: 756c 6c5f 7061 7468 292e 6e61 6d65 2c20  ull_path).name, 
-0000fd20: 6675 6c6c 5f70 6174 682c 0a20 2020 2020  full_path,.     
-0000fd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd40: 2020 2020 2020 205f 6d61 6b65 5f73 7461         _make_sta
-0000fd50: 7428 636f 6e74 656e 7429 290a 0a20 2020  t(content))..   
-0000fd60: 2020 2020 2072 6574 7572 6e20 5f63 7265       return _cre
-0000fd70: 6174 655f 6d69 7373 696e 675f 6f6b 5f67  ate_missing_ok_g
-0000fd80: 656e 6572 6174 6f72 280a 2020 2020 2020  enerator(.      
-0000fd90: 2020 2020 2020 6372 6561 7465 5f67 656e        create_gen
-0000fda0: 6572 6174 6f72 2829 2c20 6d69 7373 696e  erator(), missin
-0000fdb0: 675f 6f6b 2c0a 2020 2020 2020 2020 2020  g_ok,.          
-0000fdc0: 2020 5333 4669 6c65 4e6f 7446 6f75 6e64    S3FileNotFound
-0000fdd0: 4572 726f 7228 274e 6f20 6d61 7463 6820  Error('No match 
-0000fde0: 6669 6c65 3a20 2572 2720 2520 7365 6c66  file: %r' % self
-0000fdf0: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-0000fe00: 636f 6c29 290a 0a20 2020 2064 6566 2073  col))..    def s
-0000fe10: 6361 6e64 6972 2873 656c 662c 2066 6f6c  candir(self, fol
-0000fe20: 6c6f 776c 696e 6b73 3a20 626f 6f6c 203d  lowlinks: bool =
-0000fe30: 2046 616c 7365 2920 2d3e 2049 7465 7261   False) -> Itera
-0000fe40: 746f 725b 4669 6c65 456e 7472 795d 3a0a  tor[FileEntry]:.
-0000fe50: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
-0000fe60: 2020 2020 4765 7420 616c 6c20 636f 6e74      Get all cont
-0000fe70: 656e 7473 206f 6620 6769 7665 6e20 7333  ents of given s3
-0000fe80: 5f75 726c 2c20 7468 6520 6f72 6465 7220  _url, the order 
-0000fe90: 6f66 2072 6573 756c 7420 6973 206e 6f74  of result is not
-0000fea0: 2067 7561 7261 6e74 6565 642e 0a0a 2020   guaranteed...  
-0000feb0: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000fec0: 416c 6c20 636f 6e74 656e 7473 2068 6176  All contents hav
-0000fed0: 6520 7072 6566 6978 206f 6620 7333 5f75  e prefix of s3_u
-0000fee0: 726c 0a20 2020 2020 2020 203a 7261 6973  rl.        :rais
-0000fef0: 6573 3a20 5333 4669 6c65 4e6f 7446 6f75  es: S3FileNotFou
-0000ff00: 6e64 4572 726f 722c 2053 334e 6f74 4144  ndError, S3NotAD
-0000ff10: 6972 6563 746f 7279 4572 726f 720a 2020  irectoryError.  
-0000ff20: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-0000ff30: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
-0000ff40: 7061 7273 655f 7333 5f75 726c 2873 656c  parse_s3_url(sel
-0000ff50: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-0000ff60: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
-0000ff70: 206e 6f74 2062 7563 6b65 7420 616e 6420   not bucket and 
-0000ff80: 6b65 793a 0a20 2020 2020 2020 2020 2020  key:.           
-0000ff90: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
-0000ffa0: 6f74 466f 756e 6445 7272 6f72 280a 2020  otFoundError(.  
-0000ffb0: 2020 2020 2020 2020 2020 2020 2020 2745                'E
-0000ffc0: 6d70 7479 2062 7563 6b65 7420 6e61 6d65  mpty bucket name
-0000ffd0: 3a20 2572 2720 2520 7365 6c66 2e70 6174  : %r' % self.pat
-0000ffe0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-0000fff0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00010000: 662e 6973 5f66 696c 6528 293a 0a20 2020  f.is_file():.   
-00010010: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
-00010020: 334e 6f74 4144 6972 6563 746f 7279 4572  3NotADirectoryEr
-00010030: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-00010040: 2020 2020 2027 4e6f 7420 6120 6469 7265       'Not a dire
-00010050: 6374 6f72 793a 2025 7227 2025 2073 656c  ctory: %r' % sel
-00010060: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-00010070: 6f63 6f6c 290a 2020 2020 2020 2020 656c  ocol).        el
-00010080: 6966 206e 6f74 2073 656c 662e 6973 5f64  if not self.is_d
-00010090: 6972 2829 3a0a 2020 2020 2020 2020 2020  ir():.          
-000100a0: 2020 7261 6973 6520 5333 4669 6c65 4e6f    raise S3FileNo
-000100b0: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
-000100c0: 2020 2020 2020 2020 2020 2020 2027 4e6f               'No
-000100d0: 2073 7563 6820 6469 7265 6374 6f72 793a   such directory:
-000100e0: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
-000100f0: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-00010100: 2020 2020 2020 2020 7072 6566 6978 203d          prefix =
-00010110: 205f 6265 636f 6d65 5f70 7265 6669 7828   _become_prefix(
-00010120: 6b65 7929 0a20 2020 2020 2020 2063 6c69  key).        cli
-00010130: 656e 7420 3d20 7365 6c66 2e5f 636c 6965  ent = self._clie
-00010140: 6e74 0a0a 2020 2020 2020 2020 2320 496e  nt..        # In
-00010150: 206f 7264 6572 2074 6f20 646f 2063 6865   order to do che
-00010160: 636b 206f 6e20 6372 6561 7469 6f6e 2c0a  ck on creation,.
-00010170: 2020 2020 2020 2020 2320 7765 206e 6565          # we nee
-00010180: 6420 746f 2077 7261 7020 7468 6520 6974  d to wrap the it
-00010190: 6572 6174 6f72 2069 6e20 616e 6f74 6865  erator in anothe
-000101a0: 7220 6675 6e63 7469 6f6e 0a20 2020 2020  r function.     
-000101b0: 2020 2064 6566 2063 7265 6174 655f 6765     def create_ge
-000101c0: 6e65 7261 746f 7228 2920 2d3e 2049 7465  nerator() -> Ite
-000101d0: 7261 746f 725b 4669 6c65 456e 7472 795d  rator[FileEntry]
-000101e0: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-000101f0: 7468 2072 6169 7365 5f73 335f 6572 726f  th raise_s3_erro
-00010200: 7228 7365 6c66 2e70 6174 685f 7769 7468  r(self.path_with
-00010210: 5f70 726f 746f 636f 6c29 3a0a 0a20 2020  _protocol):..   
-00010220: 2020 2020 2020 2020 2020 2020 2064 6566               def
-00010230: 2067 656e 6572 6174 655f 7333 5f70 6174   generate_s3_pat
-00010240: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
-00010250: 2020 2020 2020 2020 2020 2070 726f 746f             proto
-00010260: 636f 6c3a 2073 7472 2c20 6275 636b 6574  col: str, bucket
-00010270: 3a20 7374 722c 206b 6579 3a20 7374 7229  : str, key: str)
-00010280: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00010290: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-000102a0: 7572 6e20 2225 733a 2f2f 2573 2f25 7322  urn "%s://%s/%s"
-000102b0: 2025 2028 7072 6f74 6f63 6f6c 2c20 6275   % (protocol, bu
-000102c0: 636b 6574 2c20 6b65 7929 0a0a 2020 2020  cket, key)..    
-000102d0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000102e0: 6f74 2062 7563 6b65 7420 616e 6420 6e6f  ot bucket and no
-000102f0: 7420 6b65 793a 2020 2320 6c69 7374 2062  t key:  # list b
-00010300: 7563 6b65 7473 0a20 2020 2020 2020 2020  uckets.         
-00010310: 2020 2020 2020 2020 2020 2072 6573 706f             respo
-00010320: 6e73 6520 3d20 636c 6965 6e74 2e6c 6973  nse = client.lis
-00010330: 745f 6275 636b 6574 7328 290a 2020 2020  t_buckets().    
-00010340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010350: 666f 7220 636f 6e74 656e 7420 696e 2072  for content in r
-00010360: 6573 706f 6e73 655b 2742 7563 6b65 7473  esponse['Buckets
-00010370: 275d 3a0a 2020 2020 2020 2020 2020 2020  ']:.            
-00010380: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-00010390: 6420 4669 6c65 456e 7472 7928 0a20 2020  d FileEntry(.   
-000103a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103b0: 2020 2020 2020 2020 2063 6f6e 7465 6e74           content
-000103c0: 5b27 4e61 6d65 275d 2c20 6622 7333 3a2f  ['Name'], f"s3:/
-000103d0: 2f7b 636f 6e74 656e 745b 274e 616d 6527  /{content['Name'
-000103e0: 5d7d 222c 0a20 2020 2020 2020 2020 2020  ]}",.           
+0000fcb0: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
+0000fcc0: 6e74 5b27 4b65 7927 5d29 0a20 2020 2020  nt['Key']).     
+0000fcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fce0: 2020 2079 6965 6c64 2046 696c 6545 6e74     yield FileEnt
+0000fcf0: 7279 280a 2020 2020 2020 2020 2020 2020  ry(.            
+0000fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd10: 5333 5061 7468 2866 756c 6c5f 7061 7468  S3Path(full_path
+0000fd20: 292e 6e61 6d65 2c20 6675 6c6c 5f70 6174  ).name, full_pat
+0000fd30: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+0000fd40: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+0000fd50: 6d61 6b65 5f73 7461 7428 636f 6e74 656e  make_stat(conten
+0000fd60: 7429 290a 0a20 2020 2020 2020 2072 6574  t))..        ret
+0000fd70: 7572 6e20 5f63 7265 6174 655f 6d69 7373  urn _create_miss
+0000fd80: 696e 675f 6f6b 5f67 656e 6572 6174 6f72  ing_ok_generator
+0000fd90: 280a 2020 2020 2020 2020 2020 2020 6372  (.            cr
+0000fda0: 6561 7465 5f67 656e 6572 6174 6f72 2829  eate_generator()
+0000fdb0: 2c20 6d69 7373 696e 675f 6f6b 2c0a 2020  , missing_ok,.  
+0000fdc0: 2020 2020 2020 2020 2020 5333 4669 6c65            S3File
+0000fdd0: 4e6f 7446 6f75 6e64 4572 726f 7228 274e  NotFoundError('N
+0000fde0: 6f20 6d61 7463 6820 6669 6c65 3a20 2572  o match file: %r
+0000fdf0: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
+0000fe00: 7468 5f70 726f 746f 636f 6c29 290a 0a20  th_protocol)).. 
+0000fe10: 2020 2064 6566 2073 6361 6e64 6972 2873     def scandir(s
+0000fe20: 656c 662c 2066 6f6c 6c6f 776c 696e 6b73  elf, followlinks
+0000fe30: 3a20 626f 6f6c 203d 2046 616c 7365 2920  : bool = False) 
+0000fe40: 2d3e 2049 7465 7261 746f 725b 4669 6c65  -> Iterator[File
+0000fe50: 456e 7472 795d 3a0a 2020 2020 2020 2020  Entry]:.        
+0000fe60: 2727 270a 2020 2020 2020 2020 4765 7420  '''.        Get 
+0000fe70: 616c 6c20 636f 6e74 656e 7473 206f 6620  all contents of 
+0000fe80: 6769 7665 6e20 7333 5f75 726c 2c20 7468  given s3_url, th
+0000fe90: 6520 6f72 6465 7220 6f66 2072 6573 756c  e order of resul
+0000fea0: 7420 6973 206e 6f74 2067 7561 7261 6e74  t is not guarant
+0000feb0: 6565 642e 0a0a 2020 2020 2020 2020 3a72  eed...        :r
+0000fec0: 6574 7572 6e73 3a20 416c 6c20 636f 6e74  eturns: All cont
+0000fed0: 656e 7473 2068 6176 6520 7072 6566 6978  ents have prefix
+0000fee0: 206f 6620 7333 5f75 726c 0a20 2020 2020   of s3_url.     
+0000fef0: 2020 203a 7261 6973 6573 3a20 5333 4669     :raises: S3Fi
+0000ff00: 6c65 4e6f 7446 6f75 6e64 4572 726f 722c  leNotFoundError,
+0000ff10: 2053 334e 6f74 4144 6972 6563 746f 7279   S3NotADirectory
+0000ff20: 4572 726f 720a 2020 2020 2020 2020 2727  Error.        ''
+0000ff30: 270a 2020 2020 2020 2020 6275 636b 6574  '.        bucket
+0000ff40: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
+0000ff50: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
+0000ff60: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+0000ff70: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
+0000ff80: 6b65 7420 616e 6420 6b65 793a 0a20 2020  ket and key:.   
+0000ff90: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+0000ffa0: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
+0000ffb0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000ffc0: 2020 2020 2020 2745 6d70 7479 2062 7563        'Empty buc
+0000ffd0: 6b65 7420 6e61 6d65 3a20 2572 2720 2520  ket name: %r' % 
+0000ffe0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+0000fff0: 726f 746f 636f 6c29 0a0a 2020 2020 2020  rotocol)..      
+00010000: 2020 6966 2073 656c 662e 6973 5f66 696c    if self.is_fil
+00010010: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
+00010020: 2072 6169 7365 2053 334e 6f74 4144 6972   raise S3NotADir
+00010030: 6563 746f 7279 4572 726f 7228 0a20 2020  ectoryError(.   
+00010040: 2020 2020 2020 2020 2020 2020 2027 4e6f               'No
+00010050: 7420 6120 6469 7265 6374 6f72 793a 2025  t a directory: %
+00010060: 7227 2025 2073 656c 662e 7061 7468 5f77  r' % self.path_w
+00010070: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
+00010080: 2020 2020 2020 656c 6966 206e 6f74 2073        elif not s
+00010090: 656c 662e 6973 5f64 6972 2829 3a0a 2020  elf.is_dir():.  
+000100a0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000100b0: 5333 4669 6c65 4e6f 7446 6f75 6e64 4572  S3FileNotFoundEr
+000100c0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+000100d0: 2020 2020 2027 4e6f 2073 7563 6820 6469       'No such di
+000100e0: 7265 6374 6f72 793a 2025 7227 2025 2073  rectory: %r' % s
+000100f0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+00010100: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+00010110: 7072 6566 6978 203d 205f 6265 636f 6d65  prefix = _become
+00010120: 5f70 7265 6669 7828 6b65 7929 0a20 2020  _prefix(key).   
+00010130: 2020 2020 2063 6c69 656e 7420 3d20 7365       client = se
+00010140: 6c66 2e5f 636c 6965 6e74 0a0a 2020 2020  lf._client..    
+00010150: 2020 2020 2320 496e 206f 7264 6572 2074      # In order t
+00010160: 6f20 646f 2063 6865 636b 206f 6e20 6372  o do check on cr
+00010170: 6561 7469 6f6e 2c0a 2020 2020 2020 2020  eation,.        
+00010180: 2320 7765 206e 6565 6420 746f 2077 7261  # we need to wra
+00010190: 7020 7468 6520 6974 6572 6174 6f72 2069  p the iterator i
+000101a0: 6e20 616e 6f74 6865 7220 6675 6e63 7469  n another functi
+000101b0: 6f6e 0a20 2020 2020 2020 2064 6566 2063  on.        def c
+000101c0: 7265 6174 655f 6765 6e65 7261 746f 7228  reate_generator(
+000101d0: 2920 2d3e 2049 7465 7261 746f 725b 4669  ) -> Iterator[Fi
+000101e0: 6c65 456e 7472 795d 3a0a 2020 2020 2020  leEntry]:.      
+000101f0: 2020 2020 2020 7769 7468 2072 6169 7365        with raise
+00010200: 5f73 335f 6572 726f 7228 7365 6c66 2e70  _s3_error(self.p
+00010210: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00010220: 6c29 3a0a 0a20 2020 2020 2020 2020 2020  l):..           
+00010230: 2020 2020 2064 6566 2067 656e 6572 6174       def generat
+00010240: 655f 7333 5f70 6174 6828 0a20 2020 2020  e_s3_path(.     
+00010250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010260: 2020 2070 726f 746f 636f 6c3a 2073 7472     protocol: str
+00010270: 2c20 6275 636b 6574 3a20 7374 722c 206b  , bucket: str, k
+00010280: 6579 3a20 7374 7229 202d 3e20 7374 723a  ey: str) -> str:
+00010290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000102a0: 2020 2020 2072 6574 7572 6e20 2225 733a       return "%s:
+000102b0: 2f2f 2573 2f25 7322 2025 2028 7072 6f74  //%s/%s" % (prot
+000102c0: 6f63 6f6c 2c20 6275 636b 6574 2c20 6b65  ocol, bucket, ke
+000102d0: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
+000102e0: 2020 2020 6966 206e 6f74 2062 7563 6b65      if not bucke
+000102f0: 7420 616e 6420 6e6f 7420 6b65 793a 2020  t and not key:  
+00010300: 2320 6c69 7374 2062 7563 6b65 7473 0a20  # list buckets. 
+00010310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010320: 2020 2072 6573 706f 6e73 6520 3d20 636c     response = cl
+00010330: 6965 6e74 2e6c 6973 745f 6275 636b 6574  ient.list_bucket
+00010340: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00010350: 2020 2020 2020 2020 666f 7220 636f 6e74          for cont
+00010360: 656e 7420 696e 2072 6573 706f 6e73 655b  ent in response[
+00010370: 2742 7563 6b65 7473 275d 3a0a 2020 2020  'Buckets']:.    
+00010380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010390: 2020 2020 7969 656c 6420 4669 6c65 456e      yield FileEn
+000103a0: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
+000103b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103c0: 2063 6f6e 7465 6e74 5b27 4e61 6d65 275d   content['Name']
+000103d0: 2c20 6622 7333 3a2f 2f7b 636f 6e74 656e  , f"s3://{conten
+000103e0: 745b 274e 616d 6527 5d7d 222c 0a20 2020  t['Name']}",.   
 000103f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010400: 2053 7461 7452 6573 756c 7428 0a20 2020   StatResult(.   
-00010410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010420: 2020 2020 2020 2020 2020 2020 2063 7469               cti
-00010430: 6d65 3d63 6f6e 7465 6e74 5b27 4372 6561  me=content['Crea
-00010440: 7469 6f6e 4461 7465 275d 2e74 696d 6573  tionDate'].times
-00010450: 7461 6d70 2829 2c0a 2020 2020 2020 2020  tamp(),.        
+00010400: 2020 2020 2020 2020 2053 7461 7452 6573           StatRes
+00010410: 756c 7428 0a20 2020 2020 2020 2020 2020  ult(.           
+00010420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010430: 2020 2020 2063 7469 6d65 3d63 6f6e 7465       ctime=conte
+00010440: 6e74 5b27 4372 6561 7469 6f6e 4461 7465  nt['CreationDate
+00010450: 275d 2e74 696d 6573 7461 6d70 2829 2c0a  '].timestamp(),.
 00010460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010470: 2020 2020 2020 2020 6973 6469 723d 5472          isdir=Tr
-00010480: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+00010470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010480: 6973 6469 723d 5472 7565 2c0a 2020 2020  isdir=True,.    
 00010490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104a0: 2020 2020 6578 7472 613d 636f 6e74 656e      extra=conten
-000104b0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-000104c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000104d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000104e0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-000104f0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00010500: 7220 7265 7370 2069 6e20 5f6c 6973 745f  r resp in _list_
-00010510: 6f62 6a65 6374 735f 7265 6375 7273 6976  objects_recursiv
-00010520: 6528 636c 6965 6e74 2c20 6275 636b 6574  e(client, bucket
-00010530: 2c20 7072 6566 6978 2c0a 2020 2020 2020  , prefix,.      
-00010540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104a0: 2020 2020 2020 2020 2020 2020 6578 7472              extr
+000104b0: 613d 636f 6e74 656e 742c 0a20 2020 2020  a=content,.     
+000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104d0: 2020 2020 2020 2029 290a 2020 2020 2020         )).      
+000104e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000104f0: 7475 726e 0a0a 2020 2020 2020 2020 2020  turn..          
+00010500: 2020 2020 2020 666f 7220 7265 7370 2069        for resp i
+00010510: 6e20 5f6c 6973 745f 6f62 6a65 6374 735f  n _list_objects_
+00010520: 7265 6375 7273 6976 6528 636c 6965 6e74  recursive(client
+00010530: 2c20 6275 636b 6574 2c20 7072 6566 6978  , bucket, prefix
+00010540: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00010550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010560: 2020 2020 2020 2020 2020 2020 2020 272f                '/
-00010570: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-00010580: 2020 2020 2020 2020 666f 7220 636f 6d6d          for comm
-00010590: 6f6e 5f70 7265 6669 7820 696e 2072 6573  on_prefix in res
-000105a0: 702e 6765 7428 2743 6f6d 6d6f 6e50 7265  p.get('CommonPre
-000105b0: 6669 7865 7327 2c20 5b5d 293a 0a20 2020  fixes', []):.   
-000105c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000105d0: 2020 2020 2079 6965 6c64 2046 696c 6545       yield FileE
-000105e0: 6e74 7279 280a 2020 2020 2020 2020 2020  ntry(.          
+00010560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010570: 2020 2020 2020 272f 2729 3a0a 2020 2020        '/'):.    
+00010580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010590: 666f 7220 636f 6d6d 6f6e 5f70 7265 6669  for common_prefi
+000105a0: 7820 696e 2072 6573 702e 6765 7428 2743  x in resp.get('C
+000105b0: 6f6d 6d6f 6e50 7265 6669 7865 7327 2c20  ommonPrefixes', 
+000105c0: 5b5d 293a 0a20 2020 2020 2020 2020 2020  []):.           
+000105d0: 2020 2020 2020 2020 2020 2020 2079 6965               yie
+000105e0: 6c64 2046 696c 6545 6e74 7279 280a 2020  ld FileEntry(.  
 000105f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010600: 2020 636f 6d6d 6f6e 5f70 7265 6669 785b    common_prefix[
-00010610: 2750 7265 6669 7827 5d5b 6c65 6e28 7072  'Prefix'][len(pr
-00010620: 6566 6978 293a 2d31 5d2c 0a20 2020 2020  efix):-1],.     
-00010630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010640: 2020 2020 2020 2067 656e 6572 6174 655f         generate_
-00010650: 7333 5f70 6174 6828 0a20 2020 2020 2020  s3_path(.       
-00010660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010670: 2020 2020 2020 2020 2073 656c 662e 5f70           self._p
-00010680: 726f 746f 636f 6c5f 7769 7468 5f70 726f  rotocol_with_pro
-00010690: 6669 6c65 2c20 6275 636b 6574 2c0a 2020  file, bucket,.  
-000106a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000106c0: 6d6d 6f6e 5f70 7265 6669 785b 2750 7265  mmon_prefix['Pre
-000106d0: 6669 7827 5d29 2c0a 2020 2020 2020 2020  fix']),.        
+00010600: 2020 2020 2020 2020 2020 636f 6d6d 6f6e            common
+00010610: 5f70 7265 6669 785b 2750 7265 6669 7827  _prefix['Prefix'
+00010620: 5d5b 6c65 6e28 7072 6566 6978 293a 2d31  ][len(prefix):-1
+00010630: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00010640: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00010650: 656e 6572 6174 655f 7333 5f70 6174 6828  enerate_s3_path(
+00010660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010680: 2073 656c 662e 5f70 726f 746f 636f 6c5f   self._protocol_
+00010690: 7769 7468 5f70 726f 6669 6c65 2c20 6275  with_profile, bu
+000106a0: 636b 6574 2c0a 2020 2020 2020 2020 2020  cket,.          
+000106b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106c0: 2020 2020 2020 636f 6d6d 6f6e 5f70 7265        common_pre
+000106d0: 6669 785b 2750 7265 6669 7827 5d29 2c0a  fix['Prefix']),.
 000106e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106f0: 2020 2020 5374 6174 5265 7375 6c74 2869      StatResult(i
-00010700: 7364 6972 3d54 7275 652c 2065 7874 7261  sdir=True, extra
-00010710: 3d63 6f6d 6d6f 6e5f 7072 6566 6978 2929  =common_prefix))
-00010720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010730: 2020 2020 2066 6f72 2063 6f6e 7465 6e74       for content
-00010740: 2069 6e20 7265 7370 2e67 6574 2827 436f   in resp.get('Co
-00010750: 6e74 656e 7473 272c 205b 5d29 3a0a 2020  ntents', []):.  
-00010760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010770: 2020 2020 2020 7372 635f 7572 6c20 3d20        src_url = 
-00010780: 6765 6e65 7261 7465 5f73 335f 7061 7468  generate_s3_path
-00010790: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000107a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000107b0: 6c66 2e5f 7072 6f74 6f63 6f6c 5f77 6974  lf._protocol_wit
-000107c0: 685f 7072 6f66 696c 652c 2062 7563 6b65  h_profile, bucke
-000107d0: 742c 2063 6f6e 7465 6e74 5b27 4b65 7927  t, content['Key'
-000107e0: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-000107f0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-00010800: 6f6c 6c6f 776c 696e 6b73 2061 6e64 2053  ollowlinks and S
-00010810: 3350 6174 6828 7372 635f 7572 6c29 2e69  3Path(src_url).i
-00010820: 735f 7379 6d6c 696e 6b28 293a 0a20 2020  s_symlink():.   
-00010830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010840: 2020 2020 2020 2020 2063 6f6e 7465 6e74           content
-00010850: 5b27 6973 6c6e 6b27 5d20 3d20 5472 7565  ['islnk'] = True
-00010860: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00010870: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-00010880: 4669 6c65 456e 7472 7928 0a20 2020 2020  FileEntry(.     
-00010890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108a0: 2020 2020 2020 2063 6f6e 7465 6e74 5b27         content['
-000108b0: 4b65 7927 5d5b 6c65 6e28 7072 6566 6978  Key'][len(prefix
-000108c0: 293a 5d2c 2073 7263 5f75 726c 2c0a 2020  ):], src_url,.  
-000108d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000108e0: 2020 2020 2020 2020 2020 5f6d 616b 655f            _make_
-000108f0: 7374 6174 2863 6f6e 7465 6e74 2929 0a0a  stat(content))..
-00010900: 2020 2020 2020 2020 7265 7475 726e 2043          return C
-00010910: 6f6e 7465 7874 4974 6572 6174 6f72 2863  ontextIterator(c
-00010920: 7265 6174 655f 6765 6e65 7261 746f 7228  reate_generator(
-00010930: 2929 0a0a 2020 2020 6465 6620 5f67 6574  ))..    def _get
-00010940: 6469 7273 7461 7428 7365 6c66 2920 2d3e  dirstat(self) ->
-00010950: 2053 7461 7452 6573 756c 743a 0a20 2020   StatResult:.   
-00010960: 2020 2020 2027 2727 0a20 2020 2020 2020       '''.       
-00010970: 2052 6574 7572 6e20 5374 6174 5265 7375   Return StatResu
-00010980: 6c74 206f 6620 6769 7665 6e20 7333 5f75  lt of given s3_u
-00010990: 726c 2064 6972 6563 746f 7279 2c20 696e  rl directory, in
-000109a0: 636c 7564 696e 673a 200a 0a20 2020 2020  cluding: ..     
-000109b0: 2020 2031 2e20 4469 7265 6374 6f72 7920     1. Directory 
-000109c0: 7369 7a65 3a20 7468 6520 7375 6d20 6f66  size: the sum of
-000109d0: 2061 6c6c 2066 696c 6520 7369 7a65 2069   all file size i
-000109e0: 6e20 6974 2c20 696e 636c 7564 696e 6720  n it, including 
-000109f0: 6669 6c65 2069 6e20 7375 6264 6972 6563  file in subdirec
-00010a00: 746f 7269 6573 2028 6966 2065 7869 7374  tories (if exist
-00010a10: 292e 0a20 2020 2020 2020 2054 6865 2072  )..        The r
-00010a20: 6573 756c 7420 6578 636c 7564 6573 2074  esult excludes t
-00010a30: 6865 2073 697a 6520 6f66 2064 6972 6563  he size of direc
-00010a40: 746f 7279 2069 7473 656c 662e 2049 6e20  tory itself. In 
-00010a50: 6f74 6865 7220 776f 7264 732c 2072 6574  other words, ret
-00010a60: 7572 6e20 3020 4279 7465 206f 6e20 616e  urn 0 Byte on an
-00010a70: 2065 6d70 7479 2064 6972 6563 746f 7279   empty directory
-00010a80: 2070 6174 680a 2020 2020 2020 2020 322e   path.        2.
-00010a90: 204c 6173 742d 6d6f 6469 6669 6564 2074   Last-modified t
-00010aa0: 696d 6520 6f66 2064 6972 6563 746f 7279  ime of directory
-00010ab0: 3a20 7265 7475 726e 2074 6865 206c 6174  : return the lat
-00010ac0: 6573 7420 6d6f 6469 6669 6564 2074 696d  est modified tim
-00010ad0: 6520 6f66 2061 6c6c 2066 696c 6520 696e  e of all file in
-00010ae0: 2069 742e 2054 6865 206d 7469 6d65 206f   it. The mtime o
-00010af0: 6620 656d 7074 7920 6469 7265 6374 6f72  f empty director
-00010b00: 7920 6973 2031 3937 302d 3031 2d30 3120  y is 1970-01-01 
-00010b10: 3030 3a30 303a 3030 0a0a 2020 2020 2020  00:00:00..      
-00010b20: 2020 3a72 6574 7572 6e73 3a20 416e 2069    :returns: An i
-00010b30: 6e74 2069 6e64 6963 6174 6573 2073 697a  nt indicates siz
-00010b40: 6520 696e 2042 7974 6573 0a20 2020 2020  e in Bytes.     
-00010b50: 2020 2027 2727 0a20 2020 2020 2020 2069     '''.        i
-00010b60: 6620 6e6f 7420 7365 6c66 2e69 735f 6469  f not self.is_di
-00010b70: 7228 293a 0a20 2020 2020 2020 2020 2020  r():.           
-00010b80: 2072 6169 7365 2053 3346 696c 654e 6f74   raise S3FileNot
-00010b90: 466f 756e 6445 7272 6f72 280a 2020 2020  FoundError(.    
-00010ba0: 2020 2020 2020 2020 2020 2020 274e 6f20              'No 
-00010bb0: 7375 6368 2066 696c 6520 6f72 2064 6972  such file or dir
-00010bc0: 6563 746f 7279 3a20 2572 2720 2520 7365  ectory: %r' % se
-00010bd0: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-00010be0: 746f 636f 6c29 0a0a 2020 2020 2020 2020  tocol)..        
-00010bf0: 6275 636b 6574 2c20 6b65 7920 3d20 7061  bucket, key = pa
-00010c00: 7273 655f 7333 5f75 726c 2873 656c 662e  rse_s3_url(self.
-00010c10: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-00010c20: 6f6c 290a 2020 2020 2020 2020 7072 6566  ol).        pref
-00010c30: 6978 203d 205f 6265 636f 6d65 5f70 7265  ix = _become_pre
-00010c40: 6669 7828 6b65 7929 0a20 2020 2020 2020  fix(key).       
-00010c50: 2063 6c69 656e 7420 3d20 7365 6c66 2e5f   client = self._
-00010c60: 636c 6965 6e74 0a20 2020 2020 2020 2073  client.        s
-00010c70: 697a 6520 3d20 300a 2020 2020 2020 2020  ize = 0.        
-00010c80: 6d74 696d 6520 3d20 302e 300a 2020 2020  mtime = 0.0.    
-00010c90: 2020 2020 7769 7468 2072 6169 7365 5f73      with raise_s
-00010ca0: 335f 6572 726f 7228 7365 6c66 2e70 6174  3_error(self.pat
-00010cb0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-00010cc0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00010cd0: 7220 7265 7370 2069 6e20 5f6c 6973 745f  r resp in _list_
-00010ce0: 6f62 6a65 6374 735f 7265 6375 7273 6976  objects_recursiv
-00010cf0: 6528 636c 6965 6e74 2c20 6275 636b 6574  e(client, bucket
-00010d00: 2c20 7072 6566 6978 293a 0a20 2020 2020  , prefix):.     
-00010d10: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-00010d20: 6f6e 7465 6e74 2069 6e20 7265 7370 2e67  ontent in resp.g
-00010d30: 6574 2827 436f 6e74 656e 7473 272c 205b  et('Contents', [
-00010d40: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-00010d50: 2020 2020 2020 2020 7369 7a65 202b 3d20          size += 
-00010d60: 636f 6e74 656e 745b 2753 697a 6527 5d0a  content['Size'].
-00010d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d80: 2020 2020 6c61 7374 5f6d 6f64 6966 6965      last_modifie
-00010d90: 6420 3d20 636f 6e74 656e 745b 274c 6173  d = content['Las
-00010da0: 744d 6f64 6966 6965 6427 5d2e 7469 6d65  tModified'].time
-00010db0: 7374 616d 7028 290a 2020 2020 2020 2020  stamp().        
-00010dc0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-00010dd0: 7469 6d65 203c 206c 6173 745f 6d6f 6469  time < last_modi
-00010de0: 6669 6564 3a0a 2020 2020 2020 2020 2020  fied:.          
-00010df0: 2020 2020 2020 2020 2020 2020 2020 6d74                mt
-00010e00: 696d 6520 3d20 6c61 7374 5f6d 6f64 6966  ime = last_modif
-00010e10: 6965 640a 0a20 2020 2020 2020 2072 6574  ied..        ret
-00010e20: 7572 6e20 5374 6174 5265 7375 6c74 2873  urn StatResult(s
-00010e30: 697a 653d 7369 7a65 2c20 6d74 696d 653d  ize=size, mtime=
-00010e40: 6d74 696d 652c 2069 7364 6972 3d54 7275  mtime, isdir=Tru
-00010e50: 6529 0a0a 2020 2020 6465 6620 7374 6174  e)..    def stat
-00010e60: 2873 656c 662c 2066 6f6c 6c6f 775f 7379  (self, follow_sy
-00010e70: 6d6c 696e 6b73 3d54 7275 6529 202d 3e20  mlinks=True) -> 
-00010e80: 5374 6174 5265 7375 6c74 3a0a 2020 2020  StatResult:.    
-00010e90: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
-00010ea0: 4765 7420 5374 6174 5265 7375 6c74 206f  Get StatResult o
-00010eb0: 6620 7333 5f75 726c 2066 696c 652c 2069  f s3_url file, i
-00010ec0: 6e63 6c75 6469 6e67 2066 696c 6520 7369  ncluding file si
-00010ed0: 7a65 2061 6e64 206d 7469 6d65 2c20 7265  ze and mtime, re
-00010ee0: 6665 7272 696e 6720 746f 2073 335f 6765  ferring to s3_ge
-00010ef0: 7473 697a 6520 616e 6420 7333 5f67 6574  tsize and s3_get
-00010f00: 6d74 696d 650a 0a20 2020 2020 2020 2049  mtime..        I
-00010f10: 6620 7333 5f75 726c 2069 7320 6e6f 7420  f s3_url is not 
-00010f20: 616e 2065 7869 7374 656e 7420 7061 7468  an existent path
-00010f30: 2c20 7768 6963 6820 6d65 616e 7320 7333  , which means s3
-00010f40: 5f65 7869 7374 2873 335f 7572 6c29 2072  _exist(s3_url) r
-00010f50: 6574 7572 6e73 2046 616c 7365 2c20 7468  eturns False, th
-00010f60: 656e 2072 6169 7365 2053 3346 696c 654e  en raise S3FileN
-00010f70: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
-00010f80: 2020 2020 2049 6620 6174 7465 6d70 7420       If attempt 
-00010f90: 746f 2067 6574 2053 7461 7452 6573 756c  to get StatResul
-00010fa0: 7420 6f66 2063 6f6d 706c 6574 6520 7333  t of complete s3
-00010fb0: 2c20 7375 6368 2061 7320 7333 5f64 6972  , such as s3_dir
-00010fc0: 5f75 726c 203d 3d20 2773 333a 2f2f 272c  _url == 's3://',
-00010fd0: 2072 6169 7365 2053 3342 7563 6b65 744e   raise S3BucketN
-00010fe0: 6f74 466f 756e 6445 7272 6f72 0a0a 2020  otFoundError..  
-00010ff0: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-00011000: 5374 6174 5265 7375 6c74 0a20 2020 2020  StatResult.     
-00011010: 2020 203a 7261 6973 6573 3a20 5333 4669     :raises: S3Fi
-00011020: 6c65 4e6f 7446 6f75 6e64 4572 726f 722c  leNotFoundError,
-00011030: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
-00011040: 6445 7272 6f72 0a20 2020 2020 2020 2027  dError.        '
-00011050: 2727 0a20 2020 2020 2020 2069 736c 6e6b  ''.        islnk
-00011060: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00011070: 2062 7563 6b65 742c 206b 6579 203d 2070   bucket, key = p
-00011080: 6172 7365 5f73 335f 7572 6c28 7365 6c66  arse_s3_url(self
-00011090: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
-000110a0: 636f 6c29 0a20 2020 2020 2020 2069 6620  col).        if 
-000110b0: 6e6f 7420 6275 636b 6574 3a0a 2020 2020  not bucket:.    
-000110c0: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-000110d0: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
-000110e0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-000110f0: 2020 2020 2027 456d 7074 7920 6275 636b       'Empty buck
-00011100: 6574 206e 616d 653a 2025 7227 2025 2073  et name: %r' % s
-00011110: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
-00011120: 6f74 6f63 6f6c 290a 0a20 2020 2020 2020  otocol)..       
-00011130: 2069 6620 6e6f 7420 7365 6c66 2e69 735f   if not self.is_
-00011140: 6669 6c65 2829 3a0a 2020 2020 2020 2020  file():.        
-00011150: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00011160: 5f67 6574 6469 7273 7461 7428 290a 0a20  _getdirstat().. 
-00011170: 2020 2020 2020 2063 6c69 656e 7420 3d20         client = 
-00011180: 7365 6c66 2e5f 636c 6965 6e74 0a20 2020  self._client.   
-00011190: 2020 2020 2077 6974 6820 7261 6973 655f       with raise_
-000111a0: 7333 5f65 7272 6f72 2873 656c 662e 7061  s3_error(self.pa
-000111b0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-000111c0: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-000111d0: 6f6e 7465 6e74 203d 2063 6c69 656e 742e  ontent = client.
-000111e0: 6865 6164 5f6f 626a 6563 7428 4275 636b  head_object(Buck
-000111f0: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
-00011200: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-00011210: 6966 2027 4d65 7461 6461 7461 2720 696e  if 'Metadata' in
-00011220: 2063 6f6e 7465 6e74 3a0a 2020 2020 2020   content:.      
-00011230: 2020 2020 2020 2020 2020 6d65 7461 6461            metada
-00011240: 7461 203d 2064 6963 7428 0a20 2020 2020  ta = dict(.     
-00011250: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00011260: 6b65 792e 6c6f 7765 7228 292c 2076 616c  key.lower(), val
-00011270: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-00011280: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
-00011290: 2076 616c 7565 2069 6e20 636f 6e74 656e   value in conten
-000112a0: 745b 274d 6574 6164 6174 6127 5d2e 6974  t['Metadata'].it
-000112b0: 656d 7328 2929 0a20 2020 2020 2020 2020  ems()).         
-000112c0: 2020 2020 2020 2069 6620 6d65 7461 6461         if metada
-000112d0: 7461 2061 6e64 2027 7379 6d6c 696e 6b5f  ta and 'symlink_
-000112e0: 746f 2720 696e 206d 6574 6164 6174 613a  to' in metadata:
-000112f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011300: 2020 2020 2069 736c 6e6b 203d 2054 7275       islnk = Tru
-00011310: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00011320: 2020 2020 2020 6966 2069 736c 6e6b 2061        if islnk a
-00011330: 6e64 2066 6f6c 6c6f 775f 7379 6d6c 696e  nd follow_symlin
-00011340: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
-00011350: 2020 2020 2020 2020 2020 2020 7333 5f75              s3_u
-00011360: 726c 203d 206d 6574 6164 6174 615b 2773  rl = metadata['s
-00011370: 796d 6c69 6e6b 5f74 6f27 5d0a 2020 2020  ymlink_to'].    
-00011380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011390: 2020 2020 6275 636b 6574 2c20 6b65 7920      bucket, key 
-000113a0: 3d20 7061 7273 655f 7333 5f75 726c 2873  = parse_s3_url(s
-000113b0: 335f 7572 6c29 0a20 2020 2020 2020 2020  3_url).         
-000113c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000113d0: 6f6e 7465 6e74 203d 2063 6c69 656e 742e  ontent = client.
-000113e0: 6865 6164 5f6f 626a 6563 7428 4275 636b  head_object(Buck
-000113f0: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
-00011400: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-00011410: 7374 6174 5f72 6563 6f72 6420 3d20 5374  stat_record = St
-00011420: 6174 5265 7375 6c74 280a 2020 2020 2020  atResult(.      
-00011430: 2020 2020 2020 2020 2020 6973 6c6e 6b3d            islnk=
-00011440: 6973 6c6e 6b2c 0a20 2020 2020 2020 2020  islnk,.         
-00011450: 2020 2020 2020 2073 697a 653d 636f 6e74         size=cont
-00011460: 656e 745b 2743 6f6e 7465 6e74 4c65 6e67  ent['ContentLeng
-00011470: 7468 275d 2c0a 2020 2020 2020 2020 2020  th'],.          
-00011480: 2020 2020 2020 6d74 696d 653d 636f 6e74        mtime=cont
-00011490: 656e 745b 274c 6173 744d 6f64 6966 6965  ent['LastModifie
-000114a0: 6427 5d2e 7469 6d65 7374 616d 7028 292c  d'].timestamp(),
-000114b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000114c0: 2065 7874 7261 3d63 6f6e 7465 6e74 290a   extra=content).
-000114d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000114e0: 7461 745f 7265 636f 7264 0a0a 2020 2020  tat_record..    
-000114f0: 6465 6620 6c73 7461 7428 7365 6c66 2920  def lstat(self) 
-00011500: 2d3e 2053 7461 7452 6573 756c 743a 0a20  -> StatResult:. 
-00011510: 2020 2020 2020 2027 2727 4c69 6b65 2050         '''Like P
-00011520: 6174 682e 7374 6174 2829 2062 7574 2c20  ath.stat() but, 
-00011530: 6966 2074 6865 2070 6174 6820 706f 696e  if the path poin
-00011540: 7473 2074 6f20 6120 7379 6d62 6f6c 6963  ts to a symbolic
-00011550: 206c 696e 6b2c 2072 6574 7572 6e20 7468   link, return th
-00011560: 6520 7379 6d62 6f6c 6963 206c 696e 6be2  e symbolic link.
-00011570: 8099 7320 696e 666f 726d 6174 696f 6e20  ..s information 
-00011580: 7261 7468 6572 2074 6861 6e20 6974 7320  rather than its 
-00011590: 7461 7267 6574 e280 9973 2e27 2727 0a20  target...s.'''. 
-000115a0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000115b0: 6c66 2e73 7461 7428 666f 6c6c 6f77 5f73  lf.stat(follow_s
-000115c0: 796d 6c69 6e6b 733d 4661 6c73 6529 0a0a  ymlinks=False)..
-000115d0: 2020 2020 6465 6620 756e 6c69 6e6b 2873      def unlink(s
-000115e0: 656c 662c 206d 6973 7369 6e67 5f6f 6b3a  elf, missing_ok:
-000115f0: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
-00011600: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00011610: 2727 270a 2020 2020 2020 2020 5265 6d6f  '''.        Remo
-00011620: 7665 2074 6865 2066 696c 6520 6f6e 2073  ve the file on s
-00011630: 330a 0a20 2020 2020 2020 203a 7061 7261  3..        :para
-00011640: 6d20 6d69 7373 696e 675f 6f6b 3a20 6966  m missing_ok: if
-00011650: 2046 616c 7365 2061 6e64 2074 6172 6765   False and targe
-00011660: 7420 6669 6c65 206e 6f74 2065 7869 7374  t file not exist
-00011670: 732c 2072 6169 7365 2053 3346 696c 654e  s, raise S3FileN
-00011680: 6f74 466f 756e 6445 7272 6f72 0a20 2020  otFoundError.   
-00011690: 2020 2020 203a 7261 6973 6573 3a20 5333       :raises: S3
-000116a0: 5065 726d 6973 7369 6f6e 4572 726f 722c  PermissionError,
-000116b0: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
-000116c0: 7272 6f72 2c20 5333 4973 4144 6972 6563  rror, S3IsADirec
-000116d0: 746f 7279 4572 726f 720a 2020 2020 2020  toryError.      
-000116e0: 2020 2727 270a 2020 2020 2020 2020 6275    '''.        bu
-000116f0: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
-00011700: 655f 7333 5f75 726c 2873 656c 662e 7061  e_s3_url(self.pa
-00011710: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00011720: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-00011730: 2062 7563 6b65 7420 6f72 206e 6f74 206b   bucket or not k
-00011740: 6579 206f 7220 6b65 792e 656e 6473 7769  ey or key.endswi
-00011750: 7468 2827 2f27 293a 0a20 2020 2020 2020  th('/'):.       
-00011760: 2020 2020 2072 6169 7365 2053 3349 7341       raise S3IsA
-00011770: 4469 7265 6374 6f72 7945 7272 6f72 280a  DirectoryError(.
-00011780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011790: 2749 7320 6120 6469 7265 6374 6f72 793a  'Is a directory:
-000117a0: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
-000117b0: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-000117c0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-000117d0: 656c 662e 6973 5f66 696c 6528 293a 0a20  elf.is_file():. 
-000117e0: 2020 2020 2020 2020 2020 2069 6620 6d69             if mi
-000117f0: 7373 696e 675f 6f6b 3a0a 2020 2020 2020  ssing_ok:.      
-00011800: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00011810: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00011820: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
-00011830: 6445 7272 6f72 280a 2020 2020 2020 2020  dError(.        
-00011840: 2020 2020 2020 2020 274e 6f20 7375 6368          'No such
-00011850: 2066 696c 653a 2025 7227 2025 2073 656c   file: %r' % sel
-00011860: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
-00011870: 6f63 6f6c 290a 0a20 2020 2020 2020 2077  ocol)..        w
-00011880: 6974 6820 7261 6973 655f 7333 5f65 7272  ith raise_s3_err
-00011890: 6f72 2873 656c 662e 7061 7468 5f77 6974  or(self.path_wit
-000118a0: 685f 7072 6f74 6f63 6f6c 293a 0a20 2020  h_protocol):.   
-000118b0: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
-000118c0: 6c69 656e 742e 6465 6c65 7465 5f6f 626a  lient.delete_obj
-000118d0: 6563 7428 4275 636b 6574 3d62 7563 6b65  ect(Bucket=bucke
-000118e0: 742c 204b 6579 3d6b 6579 290a 0a20 2020  t, Key=key)..   
-000118f0: 2064 6566 2077 616c 6b28 7365 6c66 2c20   def walk(self, 
-00011900: 666f 6c6c 6f77 6c69 6e6b 733a 2062 6f6f  followlinks: boo
-00011910: 6c20 3d20 4661 6c73 650a 2020 2020 2020  l = False.      
-00011920: 2020 2020 2020 2920 2d3e 2049 7465 7261        ) -> Itera
-00011930: 746f 725b 5475 706c 655b 7374 722c 204c  tor[Tuple[str, L
-00011940: 6973 745b 7374 725d 2c20 4c69 7374 5b73  ist[str], List[s
-00011950: 7472 5d5d 5d3a 0a20 2020 2020 2020 2027  tr]]]:.        '
-00011960: 2727 0a20 2020 2020 2020 2049 7465 7261  ''.        Itera
-00011970: 7469 7665 6c79 2074 7261 7665 7273 6520  tively traverse 
-00011980: 7468 6520 6769 7665 6e20 7333 2064 6972  the given s3 dir
-00011990: 6563 746f 7279 2c20 696e 2074 6f70 2d62  ectory, in top-b
-000119a0: 6f74 746f 6d20 6f72 6465 722e 2049 6e20  ottom order. In 
-000119b0: 6f74 6865 7220 776f 7264 732c 2066 6972  other words, fir
-000119c0: 7374 6c79 2074 7261 7665 7273 6520 7061  stly traverse pa
-000119d0: 7265 6e74 2064 6972 6563 746f 7279 2c20  rent directory, 
-000119e0: 6966 2073 7562 6469 7265 6374 6f72 6965  if subdirectorie
-000119f0: 7320 6578 6973 742c 2074 7261 7665 7273  s exist, travers
-00011a00: 6520 7468 6520 7375 6264 6972 6563 746f  e the subdirecto
-00011a10: 7269 6573 2069 6e20 616c 7068 6162 6574  ries in alphabet
-00011a20: 6963 616c 206f 7264 6572 2e0a 2020 2020  ical order..    
-00011a30: 2020 2020 4576 6572 7920 6974 6572 6174      Every iterat
-00011a40: 696f 6e20 6f6e 2067 656e 6572 6174 6f72  ion on generator
-00011a50: 2079 6965 6c64 7320 6120 332d 7475 706c   yields a 3-tupl
-00011a60: 653a 2028 726f 6f74 2c20 6469 7273 2c20  e: (root, dirs, 
-00011a70: 6669 6c65 7329 0a0a 2020 2020 2020 2020  files)..        
-00011a80: 2d20 726f 6f74 3a20 4375 7272 656e 7420  - root: Current 
-00011a90: 7333 2070 6174 683b 0a20 2020 2020 2020  s3 path;.       
-00011aa0: 202d 2064 6972 733a 204e 616d 6520 6c69   - dirs: Name li
-00011ab0: 7374 206f 6620 7375 6264 6972 6563 746f  st of subdirecto
-00011ac0: 7269 6573 2069 6e20 6375 7272 656e 7420  ries in current 
-00011ad0: 6469 7265 6374 6f72 792e 2054 6865 206c  directory. The l
-00011ae0: 6973 7420 6973 2073 6f72 7465 6420 6279  ist is sorted by
-00011af0: 206e 616d 6520 696e 2061 7363 656e 6469   name in ascendi
-00011b00: 6e67 2061 6c70 6861 6265 7469 6361 6c20  ng alphabetical 
-00011b10: 6f72 6465 723b 0a20 2020 2020 2020 202d  order;.        -
-00011b20: 2066 696c 6573 3a20 4e61 6d65 206c 6973   files: Name lis
-00011b30: 7420 6f66 2066 696c 6573 2069 6e20 6375  t of files in cu
-00011b40: 7272 656e 7420 6469 7265 6374 6f72 792e  rrent directory.
-00011b50: 2054 6865 206c 6973 7420 6973 2073 6f72   The list is sor
-00011b60: 7465 6420 6279 206e 616d 6520 696e 2061  ted by name in a
-00011b70: 7363 656e 6469 6e67 2061 6c70 6861 6265  scending alphabe
-00011b80: 7469 6361 6c20 6f72 6465 723b 0a0a 2020  tical order;..  
-00011b90: 2020 2020 2020 4966 2073 335f 7572 6c20        If s3_url 
-00011ba0: 6973 2061 2066 696c 6520 7061 7468 2c20  is a file path, 
-00011bb0: 7265 7475 726e 2061 6e20 656d 7074 7920  return an empty 
-00011bc0: 6765 6e65 7261 746f 720a 2020 2020 2020  generator.      
-00011bd0: 2020 4966 2073 335f 7572 6c20 6973 2061    If s3_url is a
-00011be0: 206e 6f6e 2d65 7869 7374 656e 7420 7061   non-existent pa
-00011bf0: 7468 2c20 7265 7475 726e 2061 6e20 656d  th, return an em
-00011c00: 7074 7920 6765 6e65 7261 746f 720a 2020  pty generator.  
-00011c10: 2020 2020 2020 4966 2073 335f 7572 6c20        If s3_url 
-00011c20: 6973 2061 2062 7563 6b65 7420 7061 7468  is a bucket path
-00011c30: 2c20 6275 636b 6574 2077 696c 6c20 6265  , bucket will be
-00011c40: 2074 6865 2074 6f70 2064 6972 6563 746f   the top directo
-00011c50: 7279 2c20 616e 6420 7769 6c6c 2062 6520  ry, and will be 
-00011c60: 7265 7475 726e 6564 2061 7420 6669 7273  returned at firs
-00011c70: 7420 6974 6572 6174 696f 6e20 6f66 2067  t iteration of g
-00011c80: 656e 6572 6174 6f72 0a20 2020 2020 2020  enerator.       
-00011c90: 2049 6620 7333 5f75 726c 2069 7320 616e   If s3_url is an
-00011ca0: 2065 6d70 7479 2062 7563 6b65 742c 206f   empty bucket, o
-00011cb0: 6e6c 7920 7969 656c 6420 6f6e 6520 332d  nly yield one 3-
-00011cc0: 7475 706c 6520 286e 6f74 6573 3a20 7333  tuple (notes: s3
-00011cd0: 2064 6f65 736e 2774 2068 6176 6520 656d   doesn't have em
-00011ce0: 7074 7920 6469 7265 6374 6f72 7929 0a20  pty directory). 
-00011cf0: 2020 2020 2020 2049 6620 7333 5f75 726c         If s3_url
-00011d00: 2064 6f65 736e 2774 2063 6f6e 7461 696e   doesn't contain
-00011d10: 2061 6e79 2062 7563 6b65 742c 2077 6869   any bucket, whi
-00011d20: 6368 2069 7320 7333 5f75 726c 203d 3d20  ch is s3_url == 
-00011d30: 2773 333a 2f2f 272c 2072 6169 7365 2055  's3://', raise U
-00011d40: 6e73 7570 706f 7274 6564 4572 726f 722e  nsupportedError.
-00011d50: 2077 616c 6b28 2920 6f6e 2063 6f6d 706c   walk() on compl
-00011d60: 6574 6520 7333 2069 7320 6e6f 7420 7375  ete s3 is not su
-00011d70: 7070 6f72 7465 6420 696e 206d 6567 6669  pported in megfi
-00011d80: 6c65 0a0a 2020 2020 2020 2020 3a70 6172  le..        :par
-00011d90: 616d 2066 6f6c 6c6f 776c 696e 6b73 3a20  am followlinks: 
-00011da0: 7768 6574 6865 7220 666f 6c6c 6f77 6c69  whether followli
-00011db0: 6e6b 7320 6973 2054 7275 6520 6f72 2046  nks is True or F
-00011dc0: 616c 7365 2c20 7265 7375 6c74 2069 7320  alse, result is 
-00011dd0: 7468 6520 7361 6d65 2e20 4265 6361 7573  the same. Becaus
-00011de0: 6520 7333 2073 796d 6c69 6e6b 206e 6f74  e s3 symlink not
-00011df0: 2073 7570 706f 7274 2064 6972 2e0a 2020   support dir..  
-00011e00: 2020 2020 2020 3a72 6169 7365 733a 2055        :raises: U
-00011e10: 6e73 7570 706f 7274 6564 4572 726f 720a  nsupportedError.
-00011e20: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-00011e30: 3a20 4120 332d 7475 706c 6520 6765 6e65  : A 3-tuple gene
-00011e40: 7261 746f 720a 2020 2020 2020 2020 2727  rator.        ''
-00011e50: 270a 2020 2020 2020 2020 6275 636b 6574  '.        bucket
-00011e60: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
-00011e70: 5f75 726c 2873 656c 662e 7061 7468 5f77  _url(self.path_w
-00011e80: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-00011e90: 2020 2020 2020 6966 206e 6f74 2062 7563        if not buc
-00011ea0: 6b65 743a 0a20 2020 2020 2020 2020 2020  ket:.           
-00011eb0: 2072 6169 7365 2055 6e73 7570 706f 7274   raise Unsupport
-00011ec0: 6564 4572 726f 7228 2757 616c 6b20 7768  edError('Walk wh
-00011ed0: 6f6c 6520 7333 272c 2073 656c 662e 7061  ole s3', self.pa
-00011ee0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00011ef0: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-00011f00: 7420 7365 6c66 2e69 735f 6469 7228 293a  t self.is_dir():
-00011f10: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00011f20: 7572 6e0a 0a20 2020 2020 2020 2073 7461  urn..        sta
-00011f30: 636b 203d 205b 6b65 795d 0a20 2020 2020  ck = [key].     
-00011f40: 2020 2063 6c69 656e 7420 3d20 7365 6c66     client = self
-00011f50: 2e5f 636c 6965 6e74 0a20 2020 2020 2020  ._client.       
-00011f60: 2077 6869 6c65 206c 656e 2873 7461 636b   while len(stack
-00011f70: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-00011f80: 2020 2063 7572 7265 6e74 203d 205f 6265     current = _be
-00011f90: 636f 6d65 5f70 7265 6669 7828 7374 6163  come_prefix(stac
-00011fa0: 6b2e 706f 7028 2929 0a20 2020 2020 2020  k.pop()).       
-00011fb0: 2020 2020 2064 6972 732c 2066 696c 6573       dirs, files
-00011fc0: 203d 205b 5d2c 205b 5d0a 2020 2020 2020   = [], [].      
-00011fd0: 2020 2020 2020 666f 7220 7265 7370 2069        for resp i
-00011fe0: 6e20 5f6c 6973 745f 6f62 6a65 6374 735f  n _list_objects_
-00011ff0: 7265 6375 7273 6976 6528 636c 6965 6e74  recursive(client
-00012000: 2c20 6275 636b 6574 2c20 6375 7272 656e  , bucket, curren
-00012010: 742c 2027 2f27 293a 0a20 2020 2020 2020  t, '/'):.       
-00012020: 2020 2020 2020 2020 2066 6f72 2063 6f6d           for com
-00012030: 6d6f 6e5f 7072 6566 6978 2069 6e20 7265  mon_prefix in re
-00012040: 7370 2e67 6574 2827 436f 6d6d 6f6e 5072  sp.get('CommonPr
-00012050: 6566 6978 6573 272c 205b 5d29 3a0a 2020  efixes', []):.  
-00012060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012070: 2020 6469 7273 2e61 7070 656e 6428 636f    dirs.append(co
-00012080: 6d6d 6f6e 5f70 7265 6669 785b 2750 7265  mmon_prefix['Pre
-00012090: 6669 7827 5d5b 3a2d 315d 290a 2020 2020  fix'][:-1]).    
-000120a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000120b0: 636f 6e74 656e 7420 696e 2072 6573 702e  content in resp.
-000120c0: 6765 7428 2743 6f6e 7465 6e74 7327 2c20  get('Contents', 
-000120d0: 5b5d 293a 0a20 2020 2020 2020 2020 2020  []):.           
-000120e0: 2020 2020 2020 2020 2066 696c 6573 2e61           files.a
-000120f0: 7070 656e 6428 636f 6e74 656e 745b 274b  ppend(content['K
-00012100: 6579 275d 290a 0a20 2020 2020 2020 2020  ey'])..         
-00012110: 2020 2064 6972 7320 3d20 736f 7274 6564     dirs = sorted
-00012120: 2864 6972 7329 0a20 2020 2020 2020 2020  (dirs).         
-00012130: 2020 2073 7461 636b 2e65 7874 656e 6428     stack.extend(
-00012140: 7265 7665 7273 6564 2864 6972 7329 290a  reversed(dirs)).
-00012150: 0a20 2020 2020 2020 2020 2020 2072 6f6f  .            roo
-00012160: 7420 3d20 7333 5f70 6174 685f 6a6f 696e  t = s3_path_join
-00012170: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00012180: 2020 6627 7b73 656c 662e 5f70 726f 746f    f'{self._proto
-00012190: 636f 6c5f 7769 7468 5f70 726f 6669 6c65  col_with_profile
-000121a0: 7d3a 2f2f 272c 2062 7563 6b65 742c 2063  }://', bucket, c
-000121b0: 7572 7265 6e74 295b 3a2d 315d 0a20 2020  urrent)[:-1].   
-000121c0: 2020 2020 2020 2020 2064 6972 7320 3d20           dirs = 
-000121d0: 5b70 6174 685b 6c65 6e28 6375 7272 656e  [path[len(curren
-000121e0: 7429 3a5d 2066 6f72 2070 6174 6820 696e  t):] for path in
-000121f0: 2064 6972 735d 0a20 2020 2020 2020 2020   dirs].         
-00012200: 2020 2066 696c 6573 203d 2073 6f72 7465     files = sorte
-00012210: 6428 7061 7468 5b6c 656e 2863 7572 7265  d(path[len(curre
-00012220: 6e74 293a 5d20 666f 7220 7061 7468 2069  nt):] for path i
-00012230: 6e20 6669 6c65 7329 0a20 2020 2020 2020  n files).       
-00012240: 2020 2020 2079 6965 6c64 2072 6f6f 742c       yield root,
-00012250: 2064 6972 732c 2066 696c 6573 0a0a 2020   dirs, files..  
-00012260: 2020 6465 6620 6d64 3528 7365 6c66 2c20    def md5(self, 
-00012270: 7265 6361 6c63 756c 6174 653a 2062 6f6f  recalculate: boo
-00012280: 6c20 3d20 4661 6c73 652c 2066 6f6c 6c6f  l = False, follo
-00012290: 776c 696e 6b73 3a20 626f 6f6c 203d 2046  wlinks: bool = F
-000122a0: 616c 7365 2920 2d3e 2073 7472 3a0a 2020  alse) -> str:.  
-000122b0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-000122c0: 2020 4765 7420 6d64 3520 6d65 7461 2069    Get md5 meta i
-000122d0: 6e66 6f20 696e 2066 696c 6573 2074 6861  nfo in files tha
-000122e0: 7420 7570 6c6f 6164 6564 2f63 6f70 6965  t uploaded/copie
-000122f0: 6420 7669 6120 6d65 6766 696c 650a 0a20  d via megfile.. 
-00012300: 2020 2020 2020 2049 6620 6d65 7461 2069         If meta i
-00012310: 6e66 6f20 6973 206c 6f73 7420 6f72 206e  nfo is lost or n
-00012320: 6f6e 2d65 7869 7374 656e 742c 2072 6574  on-existent, ret
-00012330: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2020  urn None..      
-00012340: 2020 3a70 6172 616d 2072 6563 616c 6375    :param recalcu
-00012350: 6c61 7465 3a20 6361 6c63 756c 6174 6520  late: calculate 
-00012360: 6d64 3520 696e 2072 6561 6c2d 7469 6d65  md5 in real-time
-00012370: 206f 7220 7265 7475 726e 2073 3320 6574   or return s3 et
-00012380: 6167 0a20 2020 2020 2020 203a 7061 7261  ag.        :para
-00012390: 6d20 666f 6c6c 6f77 6c69 6e6b 733a 2049  m followlinks: I
-000123a0: 6620 6973 2054 7275 652c 2063 616c 6375  f is True, calcu
-000123b0: 6c61 7465 206d 6435 2066 6f72 2072 6561  late md5 for rea
-000123c0: 6c20 6669 6c65 0a20 2020 2020 2020 203a  l file.        :
-000123d0: 7265 7475 726e 733a 206d 6435 206d 6574  returns: md5 met
-000123e0: 6120 696e 666f 0a20 2020 2020 2020 2027  a info.        '
-000123f0: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
-00012400: 742c 205f 203d 2070 6172 7365 5f73 335f  t, _ = parse_s3_
-00012410: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
-00012420: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-00012430: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
-00012440: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-00012450: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
-00012460: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
-00012470: 2020 2020 2020 2020 2020 2020 2027 456d               'Em
-00012480: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
-00012490: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
-000124a0: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
-000124b0: 2020 2020 2020 2020 7374 6174 203d 2073          stat = s
-000124c0: 656c 662e 7374 6174 2866 6f6c 6c6f 775f  elf.stat(follow_
-000124d0: 7379 6d6c 696e 6b73 3d66 6f6c 6c6f 776c  symlinks=followl
-000124e0: 696e 6b73 290a 2020 2020 2020 2020 6966  inks).        if
-000124f0: 2073 7461 742e 6973 6469 723a 0a20 2020   stat.isdir:.   
-00012500: 2020 2020 2020 2020 2068 6173 685f 6d64           hash_md
-00012510: 3520 3d20 6861 7368 6c69 622e 6d64 3528  5 = hashlib.md5(
-00012520: 2920 2023 206e 6f73 6563 0a20 2020 2020  )  # nosec.     
-00012530: 2020 2020 2020 2066 6f72 2066 696c 655f         for file_
-00012540: 6e61 6d65 2069 6e20 7365 6c66 2e6c 6973  name in self.lis
-00012550: 7464 6972 2829 3a0a 2020 2020 2020 2020  tdir():.        
-00012560: 2020 2020 2020 2020 6368 756e 6b20 3d20          chunk = 
-00012570: 5333 5061 7468 280a 2020 2020 2020 2020  S3Path(.        
-00012580: 2020 2020 2020 2020 2020 2020 7333 5f70              s3_p
-00012590: 6174 685f 6a6f 696e 280a 2020 2020 2020  ath_join(.      
-000125a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125b0: 2020 7365 6c66 2e70 6174 685f 7769 7468    self.path_with
-000125c0: 5f70 726f 746f 636f 6c2c 0a20 2020 2020  _protocol,.     
-000125d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125e0: 2020 2066 696c 655f 6e61 6d65 2929 2e6d     file_name)).m
-000125f0: 6435 2872 6563 616c 6375 6c61 7465 3d72  d5(recalculate=r
-00012600: 6563 616c 6375 6c61 7465 292e 656e 636f  ecalculate).enco
-00012610: 6465 2829 0a20 2020 2020 2020 2020 2020  de().           
-00012620: 2020 2020 2068 6173 685f 6d64 352e 7570       hash_md5.up
-00012630: 6461 7465 2863 6875 6e6b 290a 2020 2020  date(chunk).    
-00012640: 2020 2020 2020 2020 7265 7475 726e 2068          return h
-00012650: 6173 685f 6d64 352e 6865 7864 6967 6573  ash_md5.hexdiges
-00012660: 7428 290a 2020 2020 2020 2020 6966 2072  t().        if r
-00012670: 6563 616c 6375 6c61 7465 3a0a 2020 2020  ecalculate:.    
-00012680: 2020 2020 2020 2020 7061 7468 5f69 6e73          path_ins
-00012690: 7461 6e63 6520 3d20 7365 6c66 0a20 2020  tance = self.   
-000126a0: 2020 2020 2020 2020 2069 6620 666f 6c6c           if foll
-000126b0: 6f77 6c69 6e6b 733a 0a20 2020 2020 2020  owlinks:.       
-000126c0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-000126d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126e0: 2020 7061 7468 5f69 6e73 7461 6e63 6520    path_instance 
-000126f0: 3d20 7365 6c66 2e72 6561 646c 696e 6b28  = self.readlink(
-00012700: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012710: 2020 6578 6365 7074 2053 334e 6f74 414c    except S3NotAL
-00012720: 696e 6b45 7272 6f72 3a0a 2020 2020 2020  inkError:.      
-00012730: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00012740: 7373 0a20 2020 2020 2020 2020 2020 2077  ss.            w
-00012750: 6974 6820 7061 7468 5f69 6e73 7461 6e63  ith path_instanc
-00012760: 652e 6f70 656e 2827 7262 2729 2061 7320  e.open('rb') as 
-00012770: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
-00012780: 2020 2072 6574 7572 6e20 6361 6c63 756c     return calcul
-00012790: 6174 655f 6d64 3528 6629 0a20 2020 2020  ate_md5(f).     
-000127a0: 2020 2072 6574 7572 6e20 7374 6174 2e65     return stat.e
-000127b0: 7874 7261 2e67 6574 2827 4554 6167 272c  xtra.get('ETag',
-000127c0: 2027 2729 5b31 3a2d 315d 0a0a 2020 2020   '')[1:-1]..    
-000127d0: 6465 6620 636f 7079 280a 2020 2020 2020  def copy(.      
-000127e0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000127f0: 2020 2020 2020 2020 6473 745f 7572 6c3a          dst_url:
-00012800: 2050 6174 684c 696b 652c 0a20 2020 2020   PathLike,.     
-00012810: 2020 2020 2020 2066 6f6c 6c6f 776c 696e         followlin
-00012820: 6b73 3a20 626f 6f6c 203d 2046 616c 7365  ks: bool = False
-00012830: 2c0a 2020 2020 2020 2020 2020 2020 6361  ,.            ca
-00012840: 6c6c 6261 636b 3a20 4f70 7469 6f6e 616c  llback: Optional
-00012850: 5b43 616c 6c61 626c 655b 5b69 6e74 5d2c  [Callable[[int],
-00012860: 204e 6f6e 655d 5d20 3d20 4e6f 6e65 2920   None]] = None) 
-00012870: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00012880: 2027 2727 2046 696c 6520 636f 7079 206f   ''' File copy o
-00012890: 6e20 5333 0a20 2020 2020 2020 2043 6f70  n S3.        Cop
-000128a0: 7920 636f 6e74 656e 7420 6f66 2066 696c  y content of fil
-000128b0: 6520 6f6e 2060 7372 635f 7061 7468 6020  e on `src_path` 
-000128c0: 746f 2060 6473 745f 7061 7468 602e 0a20  to `dst_path`.. 
-000128d0: 2020 2020 2020 2049 7427 7320 6361 6c6c         It's call
-000128e0: 6572 2773 2072 6573 706f 6e73 6562 696c  er's responsebil
-000128f0: 6974 7920 746f 2065 6e73 7572 6520 7468  ity to ensure th
-00012900: 6520 7333 5f69 7366 696c 6528 7372 635f  e s3_isfile(src_
-00012910: 7572 6c29 203d 3d20 5472 7565 0a0a 2020  url) == True..  
-00012920: 2020 2020 2020 3a70 6172 616d 2064 7374        :param dst
-00012930: 5f70 6174 683a 2054 6172 6765 7420 6669  _path: Target fi
-00012940: 6c65 2070 6174 680a 2020 2020 2020 2020  le path.        
-00012950: 3a70 6172 616d 2063 616c 6c62 6163 6b3a  :param callback:
-00012960: 2043 616c 6c65 6420 7065 7269 6f64 6963   Called periodic
-00012970: 616c 6c79 2064 7572 696e 6720 636f 7079  ally during copy
-00012980: 2c20 616e 6420 7468 6520 696e 7075 7420  , and the input 
-00012990: 7061 7261 6d65 7465 7220 6973 2074 6865  parameter is the
-000129a0: 2064 6174 6120 7369 7a65 2028 696e 2062   data size (in b
-000129b0: 7974 6573 2920 6f66 2063 6f70 7920 7369  ytes) of copy si
-000129c0: 6e63 6520 7468 6520 6c61 7374 2063 616c  nce the last cal
-000129d0: 6c0a 2020 2020 2020 2020 2727 270a 2020  l.        '''.  
-000129e0: 2020 2020 2020 7372 635f 7572 6c20 3d20        src_url = 
-000129f0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
-00012a00: 726f 746f 636f 6c0a 2020 2020 2020 2020  rotocol.        
-00012a10: 7372 635f 6275 636b 6574 2c20 7372 635f  src_bucket, src_
-00012a20: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
-00012a30: 726c 2873 7263 5f75 726c 290a 2020 2020  rl(src_url).    
-00012a40: 2020 2020 6473 745f 6275 636b 6574 2c20      dst_bucket, 
-00012a50: 6473 745f 6b65 7920 3d20 7061 7273 655f  dst_key = parse_
-00012a60: 7333 5f75 726c 2864 7374 5f75 726c 290a  s3_url(dst_url).
-00012a70: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00012a80: 7372 635f 6275 636b 6574 3a0a 2020 2020  src_bucket:.    
-00012a90: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
-00012aa0: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
-00012ab0: 726f 7228 2745 6d70 7479 2062 7563 6b65  ror('Empty bucke
-00012ac0: 7420 6e61 6d65 3a20 2572 2720 2520 7372  t name: %r' % sr
-00012ad0: 635f 7572 6c29 0a20 2020 2020 2020 2069  c_url).        i
-00012ae0: 6620 7365 6c66 2e69 735f 6469 7228 293a  f self.is_dir():
-00012af0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00012b00: 7365 2053 3349 7341 4469 7265 6374 6f72  se S3IsADirector
-00012b10: 7945 7272 6f72 2827 4973 2061 2064 6972  yError('Is a dir
-00012b20: 6563 746f 7279 3a20 2572 2720 2520 7372  ectory: %r' % sr
-00012b30: 635f 7572 6c29 0a0a 2020 2020 2020 2020  c_url)..        
-00012b40: 6966 206e 6f74 2064 7374 5f62 7563 6b65  if not dst_bucke
-00012b50: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
-00012b60: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
-00012b70: 466f 756e 6445 7272 6f72 2827 456d 7074  FoundError('Empt
-00012b80: 7920 6275 636b 6574 206e 616d 653a 2025  y bucket name: %
-00012b90: 7227 2025 2064 7374 5f75 726c 290a 2020  r' % dst_url).  
-00012ba0: 2020 2020 2020 6966 206e 6f74 2064 7374        if not dst
-00012bb0: 5f6b 6579 206f 7220 6473 745f 6b65 792e  _key or dst_key.
-00012bc0: 656e 6473 7769 7468 2827 2f27 293a 0a20  endswith('/'):. 
-00012bd0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00012be0: 2053 3349 7341 4469 7265 6374 6f72 7945   S3IsADirectoryE
-00012bf0: 7272 6f72 2827 4973 2061 2064 6972 6563  rror('Is a direc
-00012c00: 746f 7279 3a20 2572 2720 2520 6473 745f  tory: %r' % dst_
-00012c10: 7572 6c29 0a0a 2020 2020 2020 2020 6966  url)..        if
-00012c20: 2066 6f6c 6c6f 776c 696e 6b73 3a0a 2020   followlinks:.  
-00012c30: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00012c40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00012c50: 335f 7572 6c20 3d20 7365 6c66 2e72 6561  3_url = self.rea
-00012c60: 646c 696e 6b28 292e 7061 7468 0a20 2020  dlink().path.   
-00012c70: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00012c80: 5f62 7563 6b65 742c 2073 7263 5f6b 6579  _bucket, src_key
-00012c90: 203d 2070 6172 7365 5f73 335f 7572 6c28   = parse_s3_url(
-00012ca0: 7333 5f75 726c 290a 2020 2020 2020 2020  s3_url).        
-00012cb0: 2020 2020 6578 6365 7074 2053 334e 6f74      except S3Not
-00012cc0: 414c 696e 6b45 7272 6f72 3a0a 2020 2020  ALinkError:.    
-00012cd0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00012ce0: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-00012cf0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00012d00: 5f63 6c69 656e 742e 636f 7079 280a 2020  _client.copy(.  
-00012d10: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-00012d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d30: 2020 2020 2742 7563 6b65 7427 3a20 7372      'Bucket': sr
-00012d40: 635f 6275 636b 6574 2c0a 2020 2020 2020  c_bucket,.      
-00012d50: 2020 2020 2020 2020 2020 2020 2020 274b                'K
-00012d60: 6579 273a 2073 7263 5f6b 6579 2c0a 2020  ey': src_key,.  
-00012d70: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
-00012d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012d90: 2042 7563 6b65 743d 6473 745f 6275 636b   Bucket=dst_buck
-00012da0: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
-00012db0: 2020 2020 4b65 793d 6473 745f 6b65 792c      Key=dst_key,
-00012dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012dd0: 2043 616c 6c62 6163 6b3d 6361 6c6c 6261   Callback=callba
-00012de0: 636b 290a 2020 2020 2020 2020 6578 6365  ck).        exce
-00012df0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-00012e00: 6572 726f 723a 0a20 2020 2020 2020 2020  error:.         
-00012e10: 2020 2065 7272 6f72 203d 2074 7261 6e73     error = trans
-00012e20: 6c61 7465 5f73 335f 6572 726f 7228 6572  late_s3_error(er
-00012e30: 726f 722c 2064 7374 5f75 726c 290a 2020  ror, dst_url).  
-00012e40: 2020 2020 2020 2020 2020 2320 4572 726f            # Erro
-00012e50: 7220 6361 6e27 7420 6865 6c70 2074 656c  r can't help tel
-00012e60: 6c20 7768 6963 6820 6973 2070 726f 626c  l which is probl
-00012e70: 656d 6174 6963 0a20 2020 2020 2020 2020  ematic.         
-00012e80: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00012e90: 2865 7272 6f72 2c20 5333 4275 636b 6574  (error, S3Bucket
-00012ea0: 4e6f 7446 6f75 6e64 4572 726f 7229 3a0a  NotFoundError):.
-00012eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ec0: 6966 206e 6f74 2073 656c 662e 6861 7362  if not self.hasb
-00012ed0: 7563 6b65 7428 293a 0a20 2020 2020 2020  ucket():.       
-00012ee0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00012ef0: 7365 2053 3342 7563 6b65 744e 6f74 466f  se S3BucketNotFo
-00012f00: 756e 6445 7272 6f72 2827 4e6f 2073 7563  undError('No suc
-00012f10: 6820 6275 636b 6574 3a20 2572 2720 2520  h bucket: %r' % 
-00012f20: 7372 635f 7572 6c29 0a20 2020 2020 2020  src_url).       
-00012f30: 2020 2020 2065 6c69 6620 6973 696e 7374       elif isinst
-00012f40: 616e 6365 2865 7272 6f72 2c20 5333 4669  ance(error, S3Fi
-00012f50: 6c65 4e6f 7446 6f75 6e64 4572 726f 7229  leNotFoundError)
-00012f60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012f70: 2020 6966 206e 6f74 2073 656c 662e 6973    if not self.is
-00012f80: 5f66 696c 6528 293a 0a20 2020 2020 2020  _file():.       
-00012f90: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00012fa0: 7365 2053 3346 696c 654e 6f74 466f 756e  se S3FileNotFoun
-00012fb0: 6445 7272 6f72 2827 4e6f 2073 7563 6820  dError('No such 
-00012fc0: 6669 6c65 3a20 2572 2720 2520 7372 635f  file: %r' % src_
-00012fd0: 7572 6c29 0a20 2020 2020 2020 2020 2020  url).           
-00012fe0: 2072 6169 7365 2065 7272 6f72 0a0a 2020   raise error..  
-00012ff0: 2020 6465 6620 7379 6e63 2873 656c 662c    def sync(self,
-00013000: 2064 7374 5f75 726c 3a20 5061 7468 4c69   dst_url: PathLi
-00013010: 6b65 2c20 666f 6c6c 6f77 6c69 6e6b 733a  ke, followlinks:
-00013020: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
-00013030: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00013040: 2727 270a 2020 2020 2020 2020 436f 7079  '''.        Copy
-00013050: 2066 696c 652f 6469 7265 6374 6f72 7920   file/directory 
-00013060: 6f6e 2073 7263 5f75 726c 2074 6f20 6473  on src_url to ds
-00013070: 745f 7572 6c0a 0a20 2020 2020 2020 203a  t_url..        :
-00013080: 7061 7261 6d20 6473 745f 7572 6c3a 2047  param dst_url: G
-00013090: 6976 656e 2064 6573 7469 6e61 7469 6f6e  iven destination
-000130a0: 2070 6174 680a 2020 2020 2020 2020 2727   path.        ''
-000130b0: 270a 2020 2020 2020 2020 666f 7220 7372  '.        for sr
-000130c0: 635f 6669 6c65 5f70 6174 682c 2064 7374  c_file_path, dst
-000130d0: 5f66 696c 655f 7061 7468 2069 6e20 5f73  _file_path in _s
-000130e0: 335f 7363 616e 5f70 6169 7273 280a 2020  3_scan_pairs(.  
-000130f0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00013100: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-00013110: 746f 636f 6c2c 2064 7374 5f75 726c 293a  tocol, dst_url):
-00013120: 0a20 2020 2020 2020 2020 2020 2073 7263  .            src
-00013130: 5f66 696c 655f 7061 7468 203d 2073 656c  _file_path = sel
-00013140: 662e 6672 6f6d 5f70 6174 6828 7372 635f  f.from_path(src_
-00013150: 6669 6c65 5f70 6174 6829 0a20 2020 2020  file_path).     
-00013160: 2020 2020 2020 2064 7374 5f66 696c 655f         dst_file_
-00013170: 7061 7468 203d 2073 656c 662e 6672 6f6d  path = self.from
-00013180: 5f70 6174 6828 6473 745f 6669 6c65 5f70  _path(dst_file_p
-00013190: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-000131a0: 2069 6620 6473 745f 6669 6c65 5f70 6174   if dst_file_pat
-000131b0: 682e 6578 6973 7473 2829 2061 6e64 2069  h.exists() and i
-000131c0: 735f 7361 6d65 5f66 696c 6528 0a20 2020  s_same_file(.   
-000131d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131e0: 2073 7263 5f66 696c 655f 7061 7468 2e73   src_file_path.s
-000131f0: 7461 7428 292c 2064 7374 5f66 696c 655f  tat(), dst_file_
-00013200: 7061 7468 2e73 7461 7428 292c 2027 636f  path.stat(), 'co
-00013210: 7079 2729 3a0a 2020 2020 2020 2020 2020  py'):.          
-00013220: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00013230: 2020 2020 2020 2020 2020 2073 7263 5f66             src_f
-00013240: 696c 655f 7061 7468 2e63 6f70 7928 6473  ile_path.copy(ds
-00013250: 745f 6669 6c65 5f70 6174 682c 2066 6f6c  t_file_path, fol
-00013260: 6c6f 776c 696e 6b73 3d66 6f6c 6c6f 776c  lowlinks=followl
-00013270: 696e 6b73 290a 0a20 2020 2064 6566 2073  inks)..    def s
-00013280: 796d 6c69 6e6b 2873 656c 662c 2064 7374  ymlink(self, dst
-00013290: 5f70 6174 683a 2050 6174 684c 696b 6529  _path: PathLike)
-000132a0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000132b0: 2020 2727 270a 2020 2020 2020 2020 4372    '''.        Cr
-000132c0: 6561 7465 2061 2073 796d 626f 6c69 6320  eate a symbolic 
-000132d0: 6c69 6e6b 2070 6f69 6e74 696e 6720 746f  link pointing to
-000132e0: 2073 7263 5f70 6174 6820 6e61 6d65 6420   src_path named 
-000132f0: 6473 745f 7061 7468 2e0a 0a20 2020 2020  dst_path...     
-00013300: 2020 203a 7061 7261 6d20 6473 745f 7061     :param dst_pa
-00013310: 7468 3a20 4465 7369 6e61 7469 6f6e 2070  th: Desination p
-00013320: 6174 680a 2020 2020 2020 2020 3a72 6169  ath.        :rai
-00013330: 7365 733a 2053 334e 616d 6554 6f6f 4c6f  ses: S3NameTooLo
-00013340: 6e67 4572 726f 722c 2053 3342 7563 6b65  ngError, S3Bucke
-00013350: 744e 6f74 466f 756e 6445 7272 6f72 2c20  tNotFoundError, 
-00013360: 5333 4973 4144 6972 6563 746f 7279 4572  S3IsADirectoryEr
-00013370: 726f 720a 2020 2020 2020 2020 2727 270a  ror.        '''.
-00013380: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
-00013390: 7472 2873 656c 662e 5f73 335f 7061 7468  tr(self._s3_path
-000133a0: 292e 656e 636f 6465 2829 2920 3e20 3130  ).encode()) > 10
-000133b0: 3234 3a0a 2020 2020 2020 2020 2020 2020  24:.            
-000133c0: 7261 6973 6520 5333 4e61 6d65 546f 6f4c  raise S3NameTooL
-000133d0: 6f6e 6745 7272 6f72 2827 4669 6c65 206e  ongError('File n
-000133e0: 616d 6520 746f 6f20 6c6f 6e67 3a20 2572  ame too long: %r
-000133f0: 2720 2520 6473 745f 7061 7468 290a 2020  ' % dst_path).  
-00013400: 2020 2020 2020 7372 635f 6275 636b 6574        src_bucket
-00013410: 2c20 7372 635f 6b65 7920 3d20 7061 7273  , src_key = pars
-00013420: 655f 7333 5f75 726c 2873 656c 662e 7061  e_s3_url(self.pa
-00013430: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
-00013440: 290a 2020 2020 2020 2020 6473 745f 6275  ).        dst_bu
-00013450: 636b 6574 2c20 6473 745f 6b65 7920 3d20  cket, dst_key = 
-00013460: 7061 7273 655f 7333 5f75 726c 2864 7374  parse_s3_url(dst
-00013470: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-00013480: 6966 206e 6f74 2073 7263 5f62 7563 6b65  if not src_bucke
-00013490: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
-000134a0: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
-000134b0: 466f 756e 6445 7272 6f72 2827 456d 7074  FoundError('Empt
-000134c0: 7920 6275 636b 6574 206e 616d 653a 2025  y bucket name: %
-000134d0: 7227 2025 2073 656c 662e 7061 7468 290a  r' % self.path).
-000134e0: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
-000134f0: 7374 5f62 7563 6b65 743a 0a20 2020 2020  st_bucket:.     
-00013500: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
-00013510: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
-00013520: 6f72 2827 456d 7074 7920 6275 636b 6574  or('Empty bucket
-00013530: 206e 616d 653a 2025 7227 2025 2064 7374   name: %r' % dst
-00013540: 5f70 6174 6829 0a20 2020 2020 2020 2069  _path).        i
-00013550: 6620 6e6f 7420 6473 745f 6b65 7920 6f72  f not dst_key or
-00013560: 2064 7374 5f6b 6579 2e65 6e64 7377 6974   dst_key.endswit
-00013570: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
-00013580: 2020 2020 7261 6973 6520 5333 4973 4144      raise S3IsAD
-00013590: 6972 6563 746f 7279 4572 726f 7228 2749  irectoryError('I
-000135a0: 7320 6120 6469 7265 6374 6f72 793a 2025  s a directory: %
-000135b0: 7227 2025 2064 7374 5f70 6174 6829 0a0a  r' % dst_path)..
-000135c0: 2020 2020 2020 2020 7372 635f 7061 7468          src_path
-000135d0: 203d 2073 656c 662e 5f73 335f 7061 7468   = self._s3_path
-000135e0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-000135f0: 2020 2020 2020 2020 2020 7372 635f 7061            src_pa
-00013600: 7468 203d 2073 656c 662e 7265 6164 6c69  th = self.readli
-00013610: 6e6b 2829 2e5f 7333 5f70 6174 680a 2020  nk()._s3_path.  
-00013620: 2020 2020 2020 6578 6365 7074 2053 334e        except S3N
-00013630: 6f74 414c 696e 6b45 7272 6f72 3a0a 2020  otALinkError:.  
-00013640: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-00013650: 2020 2020 2020 2077 6974 6820 7261 6973         with rais
-00013660: 655f 7333 5f65 7272 6f72 2864 7374 5f70  e_s3_error(dst_p
-00013670: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
-00013680: 2020 7365 6c66 2e5f 636c 6965 6e74 2e70    self._client.p
-00013690: 7574 5f6f 626a 6563 7428 0a20 2020 2020  ut_object(.     
-000136a0: 2020 2020 2020 2020 2020 2042 7563 6b65             Bucke
-000136b0: 743d 6473 745f 6275 636b 6574 2c0a 2020  t=dst_bucket,.  
-000136c0: 2020 2020 2020 2020 2020 2020 2020 4b65                Ke
-000136d0: 793d 6473 745f 6b65 792c 0a20 2020 2020  y=dst_key,.     
-000136e0: 2020 2020 2020 2020 2020 204d 6574 6164             Metad
-000136f0: 6174 613d 7b22 7379 6d6c 696e 6b5f 746f  ata={"symlink_to
-00013700: 223a 2073 7263 5f70 6174 687d 290a 0a20  ": src_path}).. 
-00013710: 2020 2064 6566 2072 6561 646c 696e 6b28     def readlink(
-00013720: 7365 6c66 2920 2d3e 2027 5333 5061 7468  self) -> 'S3Path
-00013730: 273a 0a20 2020 2020 2020 2027 2727 0a20  ':.        '''. 
-00013740: 2020 2020 2020 2052 6574 7572 6e20 6120         Return a 
-00013750: 5333 5061 7468 2069 6e73 7461 6e63 6520  S3Path instance 
-00013760: 7265 7072 6573 656e 7469 6e67 2074 6865  representing the
-00013770: 2070 6174 6820 746f 2077 6869 6368 2074   path to which t
-00013780: 6865 2073 796d 626f 6c69 6320 6c69 6e6b  he symbolic link
-00013790: 2070 6f69 6e74 732e 0a0a 2020 2020 2020   points...      
-000137a0: 2020 3a72 6574 7572 6e73 3a20 5265 7475    :returns: Retu
-000137b0: 726e 2061 2053 3350 6174 6820 696e 7374  rn a S3Path inst
-000137c0: 616e 6365 2072 6570 7265 7365 6e74 696e  ance representin
-000137d0: 6720 7468 6520 7061 7468 2074 6f20 7768  g the path to wh
-000137e0: 6963 6820 7468 6520 7379 6d62 6f6c 6963  ich the symbolic
-000137f0: 206c 696e 6b20 706f 696e 7473 2e0a 2020   link points..  
-00013800: 2020 2020 2020 3a72 6169 7365 733a 2053        :raises: S
-00013810: 334e 616d 6554 6f6f 4c6f 6e67 4572 726f  3NameTooLongErro
-00013820: 722c 2053 3342 7563 6b65 744e 6f74 466f  r, S3BucketNotFo
-00013830: 756e 6445 7272 6f72 2c20 5333 4973 4144  undError, S3IsAD
-00013840: 6972 6563 746f 7279 4572 726f 722c 2053  irectoryError, S
-00013850: 334e 6f74 414c 696e 6b45 7272 6f72 0a20  3NotALinkError. 
-00013860: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-00013870: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
-00013880: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
-00013890: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-000138a0: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
-000138b0: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
-000138c0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000138d0: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
-000138e0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-000138f0: 2020 2020 2020 2027 456d 7074 7920 6275         'Empty bu
-00013900: 636b 6574 206e 616d 653a 2025 7227 2025  cket name: %r' %
-00013910: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-00013920: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
-00013930: 2020 6966 206e 6f74 206b 6579 206f 7220    if not key or 
-00013940: 6b65 792e 656e 6473 7769 7468 2827 2f27  key.endswith('/'
-00013950: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00013960: 6169 7365 2053 3349 7341 4469 7265 6374  aise S3IsADirect
-00013970: 6f72 7945 7272 6f72 280a 2020 2020 2020  oryError(.      
-00013980: 2020 2020 2020 2020 2020 2749 7320 6120            'Is a 
-00013990: 6469 7265 6374 6f72 793a 2025 7227 2025  directory: %r' %
-000139a0: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
-000139b0: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
-000139c0: 2020 6d65 7461 6461 7461 203d 2073 656c    metadata = sel
-000139d0: 662e 5f73 335f 6765 745f 6d65 7461 6461  f._s3_get_metada
-000139e0: 7461 2829 0a0a 2020 2020 2020 2020 6966  ta()..        if
-000139f0: 206e 6f74 2027 7379 6d6c 696e 6b5f 746f   not 'symlink_to
-00013a00: 2720 696e 206d 6574 6164 6174 613a 0a20  ' in metadata:. 
-00013a10: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00013a20: 2053 334e 6f74 414c 696e 6b45 7272 6f72   S3NotALinkError
-00013a30: 2827 4e6f 7420 6120 6c69 6e6b 3a20 2572  ('Not a link: %r
-00013a40: 2720 2520 7365 6c66 2e70 6174 685f 7769  ' % self.path_wi
-00013a50: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
-00013a60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00013a70: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00013a80: 6c66 2e66 726f 6d5f 7061 7468 286d 6574  lf.from_path(met
-00013a90: 6164 6174 615b 2773 796d 6c69 6e6b 5f74  adata['symlink_t
-00013aa0: 6f27 5d29 0a0a 2020 2020 6465 6620 6973  o'])..    def is
-00013ab0: 5f73 796d 6c69 6e6b 2873 656c 6629 202d  _symlink(self) -
-00013ac0: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
-00013ad0: 2727 270a 2020 2020 2020 2020 5465 7374  '''.        Test
-00013ae0: 2077 6865 7468 6572 2061 2070 6174 6820   whether a path 
-00013af0: 6973 206c 696e 6b0a 0a20 2020 2020 2020  is link..       
-00013b00: 203a 7265 7475 726e 733a 2054 7275 6520   :returns: True 
-00013b10: 6966 2061 2070 6174 6820 6973 206c 696e  if a path is lin
-00013b20: 6b2c 2065 6c73 6520 4661 6c73 650a 2020  k, else False.  
-00013b30: 2020 2020 2020 3a72 6169 7365 733a 2053        :raises: S
-00013b40: 334e 6f74 414c 696e 6b45 7272 6f72 0a20  3NotALinkError. 
-00013b50: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
-00013b60: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
-00013b70: 2070 6172 7365 5f73 335f 7572 6c28 7365   parse_s3_url(se
-00013b80: 6c66 2e70 6174 685f 7769 7468 5f70 726f  lf.path_with_pro
-00013b90: 746f 636f 6c29 0a20 2020 2020 2020 2069  tocol).        i
-00013ba0: 6620 6e6f 7420 6275 636b 6574 3a0a 2020  f not bucket:.  
-00013bb0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00013bc0: 2046 616c 7365 0a20 2020 2020 2020 2069   False.        i
-00013bd0: 6620 6e6f 7420 6b65 7920 6f72 206b 6579  f not key or key
-00013be0: 2e65 6e64 7377 6974 6828 272f 2729 3a0a  .endswith('/'):.
-00013bf0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00013c00: 726e 2046 616c 7365 0a20 2020 2020 2020  rn False.       
-00013c10: 206d 6574 6164 6174 6120 3d20 7365 6c66   metadata = self
-00013c20: 2e5f 7333 5f67 6574 5f6d 6574 6164 6174  ._s3_get_metadat
-00013c30: 6128 290a 2020 2020 2020 2020 7265 7475  a().        retu
-00013c40: 726e 2027 7379 6d6c 696e 6b5f 746f 2720  rn 'symlink_to' 
-00013c50: 696e 206d 6574 6164 6174 610a 0a20 2020  in metadata..   
-00013c60: 2064 6566 2073 6176 6528 7365 6c66 2c20   def save(self, 
-00013c70: 6669 6c65 5f6f 626a 6563 743a 2042 696e  file_object: Bin
-00013c80: 6172 7949 4f29 3a0a 2020 2020 2020 2020  aryIO):.        
-00013c90: 2727 2757 7269 7465 2074 6865 206f 7065  '''Write the ope
-00013ca0: 6e65 6420 6269 6e61 7279 2073 7472 6561  ned binary strea
-00013cb0: 6d20 746f 2073 7065 6369 6669 6564 2070  m to specified p
-00013cc0: 6174 682c 2062 7574 2074 6865 2073 7472  ath, but the str
-00013cd0: 6561 6d20 776f 6e27 7420 6265 2063 6c6f  eam won't be clo
-00013ce0: 7365 640a 0a20 2020 2020 2020 203a 7061  sed..        :pa
-00013cf0: 7261 6d20 6669 6c65 5f6f 626a 6563 743a  ram file_object:
-00013d00: 2053 7472 6561 6d20 746f 2062 6520 7265   Stream to be re
-00013d10: 6164 0a20 2020 2020 2020 2027 2727 0a20  ad.        '''. 
-00013d20: 2020 2020 2020 2062 7563 6b65 742c 206b         bucket, k
-00013d30: 6579 203d 2070 6172 7365 5f73 335f 7572  ey = parse_s3_ur
-00013d40: 6c28 7365 6c66 2e70 6174 685f 7769 7468  l(self.path_with
-00013d50: 5f70 726f 746f 636f 6c29 0a20 2020 2020  _protocol).     
-00013d60: 2020 2069 6620 6e6f 7420 6275 636b 6574     if not bucket
-00013d70: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00013d80: 6973 6520 5333 4275 636b 6574 4e6f 7446  ise S3BucketNotF
-00013d90: 6f75 6e64 4572 726f 7228 0a20 2020 2020  oundError(.     
-00013da0: 2020 2020 2020 2020 2020 2027 456d 7074             'Empt
-00013db0: 7920 6275 636b 6574 206e 616d 653a 2025  y bucket name: %
-00013dc0: 7227 2025 2073 656c 662e 7061 7468 5f77  r' % self.path_w
-00013dd0: 6974 685f 7072 6f74 6f63 6f6c 290a 2020  ith_protocol).  
-00013de0: 2020 2020 2020 6966 206e 6f74 206b 6579        if not key
-00013df0: 206f 7220 6b65 792e 656e 6473 7769 7468   or key.endswith
-00013e00: 2827 2f27 293a 0a20 2020 2020 2020 2020  ('/'):.         
-00013e10: 2020 2072 6169 7365 2053 3349 7341 4469     raise S3IsADi
-00013e20: 7265 6374 6f72 7945 7272 6f72 280a 2020  rectoryError(.  
-00013e30: 2020 2020 2020 2020 2020 2020 2020 2749                'I
-00013e40: 7320 6120 6469 7265 6374 6f72 793a 2025  s a directory: %
-00013e50: 7227 2025 2073 656c 662e 7061 7468 5f77  r' % self.path_w
-00013e60: 6974 685f 7072 6f74 6f63 6f6c 290a 0a20  ith_protocol).. 
-00013e70: 2020 2020 2020 2077 6974 6820 7261 6973         with rais
-00013e80: 655f 7333 5f65 7272 6f72 2873 656c 662e  e_s3_error(self.
-00013e90: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
-00013ea0: 6f6c 293a 0a20 2020 2020 2020 2020 2020  ol):.           
-00013eb0: 2073 656c 662e 5f63 6c69 656e 742e 7570   self._client.up
-00013ec0: 6c6f 6164 5f66 696c 656f 626a 2866 696c  load_fileobj(fil
-00013ed0: 655f 6f62 6a65 6374 2c20 4275 636b 6574  e_object, Bucket
-00013ee0: 3d62 7563 6b65 742c 204b 6579 3d6b 6579  =bucket, Key=key
-00013ef0: 290a 0a20 2020 2064 6566 206f 7065 6e28  )..    def open(
-00013f00: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00013f10: 662c 0a20 2020 2020 2020 2020 2020 206d  f,.            m
-00013f20: 6f64 653a 2073 7472 203d 2027 7227 2c0a  ode: str = 'r',.
-00013f30: 2020 2020 2020 2020 2020 2020 2a2c 0a20              *,. 
-00013f40: 2020 2020 2020 2020 2020 2073 335f 6f70             s3_op
-00013f50: 656e 5f66 756e 633a 2043 616c 6c61 626c  en_func: Callabl
-00013f60: 655b 5b73 7472 2c20 7374 725d 2c20 4269  e[[str, str], Bi
-00013f70: 6e61 7279 494f 5d20 3d20 7333 5f6f 7065  naryIO] = s3_ope
-00013f80: 6e2c 0a20 2020 2020 2020 2020 2020 202a  n,.            *
-00013f90: 2a6b 7761 7267 7329 202d 3e20 494f 5b41  *kwargs) -> IO[A
-00013fa0: 6e79 5374 725d 3a20 2023 2070 7974 7970  nyStr]:  # pytyp
-00013fb0: 653a 2064 6973 6162 6c65 3d73 6967 6e61  e: disable=signa
-00013fc0: 7475 7265 2d6d 6973 6d61 7463 680a 2020  ture-mismatch.  
-00013fd0: 2020 2020 2020 7265 7475 726e 2073 335f        return s3_
-00013fe0: 6f70 656e 5f66 756e 6328 0a20 2020 2020  open_func(.     
-00013ff0: 2020 2020 2020 2073 656c 662e 7061 7468         self.path
-00014000: 5f77 6974 685f 7072 6f74 6f63 6f6c 2c20  _with_protocol, 
-00014010: 6d6f 6465 2c0a 2020 2020 2020 2020 2020  mode,.          
-00014020: 2020 2a2a 6e65 6365 7373 6172 795f 7061    **necessary_pa
-00014030: 7261 6d73 2873 335f 6f70 656e 5f66 756e  rams(s3_open_fun
-00014040: 632c 202a 2a6b 7761 7267 7329 290a 0a20  c, **kwargs)).. 
-00014050: 2020 2064 6566 2061 6273 6f6c 7574 6528     def absolute(
-00014060: 7365 6c66 2920 2d3e 2027 5333 5061 7468  self) -> 'S3Path
-00014070: 273a 0a20 2020 2020 2020 2027 2727 0a20  ':.        '''. 
-00014080: 2020 2020 2020 204d 616b 6520 7468 6520         Make the 
-00014090: 7061 7468 2061 6273 6f6c 7574 652c 2077  path absolute, w
-000140a0: 6974 686f 7574 206e 6f72 6d61 6c69 7a61  ithout normaliza
-000140b0: 7469 6f6e 206f 7220 7265 736f 6c76 696e  tion or resolvin
-000140c0: 6720 7379 6d6c 696e 6b73 2e20 5265 7475  g symlinks. Retu
-000140d0: 726e 7320 6120 6e65 7720 7061 7468 206f  rns a new path o
-000140e0: 626a 6563 740a 2020 2020 2020 2020 2727  bject.        ''
-000140f0: 270a 2020 2020 2020 2020 7265 7475 726e  '.        return
-00014100: 2073 656c 660a 0a20 2020 2064 6566 2063   self..    def c
-00014110: 7764 2873 656c 6629 202d 3e20 2753 3350  wd(self) -> 'S3P
-00014120: 6174 6827 3a0a 2020 2020 2020 2020 2727  ath':.        ''
-00014130: 2752 6574 7572 6e20 6375 7272 656e 7420  'Return current 
-00014140: 776f 726b 696e 6720 6469 7265 6374 6f72  working director
-00014150: 790a 0a20 2020 2020 2020 2072 6574 7572  y..        retur
-00014160: 6e73 3a20 4375 7272 656e 7420 776f 726b  ns: Current work
-00014170: 696e 6720 6469 7265 6374 6f72 790a 2020  ing directory.  
-00014180: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
-00014190: 2020 7265 7475 726e 2073 656c 662e 6672    return self.fr
-000141a0: 6f6d 5f70 6174 6828 7365 6c66 2e70 6174  om_path(self.pat
-000141b0: 685f 7769 7468 5f70 726f 746f 636f 6c29  h_with_protocol)
-000141c0: 0a0a 0a63 6c61 7373 204d 756c 7469 5061  ...class MultiPa
-000141d0: 7274 5772 6974 6572 3a0a 0a20 2020 2064  rtWriter:..    d
-000141e0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-000141f0: 2c20 636c 6965 6e74 2c20 7061 7468 3a20  , client, path: 
-00014200: 5061 7468 4c69 6b65 2920 2d3e 204e 6f6e  PathLike) -> Non
-00014210: 653a 0a20 2020 2020 2020 2073 656c 662e  e:.        self.
-00014220: 5f63 6c69 656e 7420 3d20 636c 6965 6e74  _client = client
-00014230: 0a20 2020 2020 2020 2073 656c 662e 5f6d  .        self._m
-00014240: 756c 7469 7061 7274 5f75 706c 6f61 645f  ultipart_upload_
-00014250: 696e 666f 203d 205b 5d0a 0a20 2020 2020  info = []..     
-00014260: 2020 2062 7563 6b65 742c 206b 6579 203d     bucket, key =
-00014270: 2070 6172 7365 5f73 335f 7572 6c28 7061   parse_s3_url(pa
-00014280: 7468 290a 2020 2020 2020 2020 7365 6c66  th).        self
-00014290: 2e5f 6275 636b 6574 203d 2062 7563 6b65  ._bucket = bucke
-000142a0: 740a 2020 2020 2020 2020 7365 6c66 2e5f  t.        self._
-000142b0: 6b65 7920 3d20 6b65 790a 2020 2020 2020  key = key.      
-000142c0: 2020 7365 6c66 2e5f 7570 6c6f 6164 5f69    self._upload_i
-000142d0: 6420 3d20 7365 6c66 2e5f 636c 6965 6e74  d = self._client
-000142e0: 2e63 7265 6174 655f 6d75 6c74 6970 6172  .create_multipar
-000142f0: 745f 7570 6c6f 6164 280a 2020 2020 2020  t_upload(.      
-00014300: 2020 2020 2020 4275 636b 6574 3d73 656c        Bucket=sel
-00014310: 662e 5f62 7563 6b65 742c 204b 6579 3d73  f._bucket, Key=s
-00014320: 656c 662e 5f6b 6579 295b 2755 706c 6f61  elf._key)['Uploa
-00014330: 6449 6427 5d0a 0a20 2020 2064 6566 2075  dId']..    def u
-00014340: 706c 6f61 645f 7061 7274 2873 656c 662c  pload_part(self,
-00014350: 2070 6172 745f 6e75 6d3a 2069 6e74 2c20   part_num: int, 
-00014360: 6669 6c65 5f6f 626a 3a20 696f 2e42 7974  file_obj: io.Byt
-00014370: 6573 494f 2920 2d3e 204e 6f6e 653a 0a20  esIO) -> None:. 
-00014380: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
-00014390: 3d20 7365 6c66 2e5f 636c 6965 6e74 2e75  = self._client.u
-000143a0: 706c 6f61 645f 7061 7274 280a 2020 2020  pload_part(.    
-000143b0: 2020 2020 2020 2020 426f 6479 3d66 696c          Body=fil
-000143c0: 655f 6f62 6a2c 0a20 2020 2020 2020 2020  e_obj,.         
-000143d0: 2020 2055 706c 6f61 6449 643d 7365 6c66     UploadId=self
-000143e0: 2e5f 7570 6c6f 6164 5f69 642c 0a20 2020  ._upload_id,.   
-000143f0: 2020 2020 2020 2020 2050 6172 744e 756d           PartNum
-00014400: 6265 723d 7061 7274 5f6e 756d 2c0a 2020  ber=part_num,.  
-00014410: 2020 2020 2020 2020 2020 4275 636b 6574            Bucket
-00014420: 3d73 656c 662e 5f62 7563 6b65 742c 0a20  =self._bucket,. 
-00014430: 2020 2020 2020 2020 2020 204b 6579 3d73             Key=s
-00014440: 656c 662e 5f6b 6579 2c0a 2020 2020 2020  elf._key,.      
-00014450: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00014460: 2e5f 6d75 6c74 6970 6172 745f 7570 6c6f  ._multipart_uplo
-00014470: 6164 5f69 6e66 6f2e 6170 7065 6e64 280a  ad_info.append(.
-00014480: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00014490: 2020 2020 2020 2020 2020 2020 2020 2750                'P
-000144a0: 6172 744e 756d 6265 7227 3a20 7061 7274  artNumber': part
-000144b0: 5f6e 756d 2c0a 2020 2020 2020 2020 2020  _num,.          
-000144c0: 2020 2020 2020 2745 5461 6727 3a20 7265        'ETag': re
-000144d0: 7370 6f6e 7365 5b27 4554 6167 275d 0a20  sponse['ETag']. 
-000144e0: 2020 2020 2020 2020 2020 207d 290a 0a20             }).. 
-000144f0: 2020 2064 6566 2075 706c 6f61 645f 7061     def upload_pa
-00014500: 7274 5f62 795f 7061 7468 7328 0a20 2020  rt_by_paths(.   
-00014510: 2020 2020 2020 2020 2073 656c 662c 2070           self, p
-00014520: 6172 745f 6e75 6d3a 2069 6e74 2c20 7061  art_num: int, pa
-00014530: 7468 733a 204c 6973 745b 5475 706c 655b  ths: List[Tuple[
-00014540: 5061 7468 4c69 6b65 2c20 7374 725d 5d29  PathLike, str]])
-00014550: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00014560: 2020 6669 6c65 5f6f 626a 203d 2069 6f2e    file_obj = io.
-00014570: 4279 7465 7349 4f28 290a 2020 2020 2020  BytesIO().      
-00014580: 2020 666f 7220 7061 7468 2c20 6279 7465    for path, byte
-00014590: 735f 7261 6e67 6520 696e 2070 6174 6873  s_range in paths
-000145a0: 3a0a 2020 2020 2020 2020 2020 2020 6275  :.            bu
-000145b0: 636b 6574 2c20 6b65 7920 3d20 7061 7273  cket, key = pars
-000145c0: 655f 7333 5f75 726c 2870 6174 6829 0a20  e_s3_url(path). 
-000145d0: 2020 2020 2020 2020 2020 2069 6620 6279             if by
-000145e0: 7465 735f 7261 6e67 653a 0a20 2020 2020  tes_range:.     
-000145f0: 2020 2020 2020 2020 2020 2066 696c 655f             file_
-00014600: 6f62 6a2e 7772 6974 6528 0a20 2020 2020  obj.write(.     
-00014610: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00014620: 656c 662e 5f63 6c69 656e 742e 6765 745f  elf._client.get_
-00014630: 6f62 6a65 6374 280a 2020 2020 2020 2020  object(.        
+000106f0: 2020 2020 2020 2020 2020 2020 5374 6174              Stat
+00010700: 5265 7375 6c74 2869 7364 6972 3d54 7275  Result(isdir=Tru
+00010710: 652c 2065 7874 7261 3d63 6f6d 6d6f 6e5f  e, extra=common_
+00010720: 7072 6566 6978 2929 0a20 2020 2020 2020  prefix)).       
+00010730: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00010740: 2063 6f6e 7465 6e74 2069 6e20 7265 7370   content in resp
+00010750: 2e67 6574 2827 436f 6e74 656e 7473 272c  .get('Contents',
+00010760: 205b 5d29 3a0a 2020 2020 2020 2020 2020   []):.          
+00010770: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00010780: 635f 7572 6c20 3d20 6765 6e65 7261 7465  c_url = generate
+00010790: 5f73 335f 7061 7468 280a 2020 2020 2020  _s3_path(.      
+000107a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107b0: 2020 2020 2020 7365 6c66 2e5f 7072 6f74        self._prot
+000107c0: 6f63 6f6c 5f77 6974 685f 7072 6f66 696c  ocol_with_profil
+000107d0: 652c 2062 7563 6b65 742c 2063 6f6e 7465  e, bucket, conte
+000107e0: 6e74 5b27 4b65 7927 5d29 0a0a 2020 2020  nt['Key'])..    
+000107f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010800: 2020 2020 6966 2066 6f6c 6c6f 776c 696e      if followlin
+00010810: 6b73 2061 6e64 2053 3350 6174 6828 7372  ks and S3Path(sr
+00010820: 635f 7572 6c29 2e69 735f 7379 6d6c 696e  c_url).is_symlin
+00010830: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
+00010840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010850: 2063 6f6e 7465 6e74 5b27 6973 6c6e 6b27   content['islnk'
+00010860: 5d20 3d20 5472 7565 0a0a 2020 2020 2020  ] = True..      
+00010870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010880: 2020 7969 656c 6420 4669 6c65 456e 7472    yield FileEntr
+00010890: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
+000108a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000108b0: 6f6e 7465 6e74 5b27 4b65 7927 5d5b 6c65  ontent['Key'][le
+000108c0: 6e28 7072 6566 6978 293a 5d2c 2073 7263  n(prefix):], src
+000108d0: 5f75 726c 2c0a 2020 2020 2020 2020 2020  _url,.          
+000108e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108f0: 2020 5f6d 616b 655f 7374 6174 2863 6f6e    _make_stat(con
+00010900: 7465 6e74 2929 0a0a 2020 2020 2020 2020  tent))..        
+00010910: 7265 7475 726e 2043 6f6e 7465 7874 4974  return ContextIt
+00010920: 6572 6174 6f72 2863 7265 6174 655f 6765  erator(create_ge
+00010930: 6e65 7261 746f 7228 2929 0a0a 2020 2020  nerator())..    
+00010940: 6465 6620 5f67 6574 6469 7273 7461 7428  def _getdirstat(
+00010950: 7365 6c66 2920 2d3e 2053 7461 7452 6573  self) -> StatRes
+00010960: 756c 743a 0a20 2020 2020 2020 2027 2727  ult:.        '''
+00010970: 0a20 2020 2020 2020 2052 6574 7572 6e20  .        Return 
+00010980: 5374 6174 5265 7375 6c74 206f 6620 6769  StatResult of gi
+00010990: 7665 6e20 7333 5f75 726c 2064 6972 6563  ven s3_url direc
+000109a0: 746f 7279 2c20 696e 636c 7564 696e 673a  tory, including:
+000109b0: 200a 0a20 2020 2020 2020 2031 2e20 4469   ..        1. Di
+000109c0: 7265 6374 6f72 7920 7369 7a65 3a20 7468  rectory size: th
+000109d0: 6520 7375 6d20 6f66 2061 6c6c 2066 696c  e sum of all fil
+000109e0: 6520 7369 7a65 2069 6e20 6974 2c20 696e  e size in it, in
+000109f0: 636c 7564 696e 6720 6669 6c65 2069 6e20  cluding file in 
+00010a00: 7375 6264 6972 6563 746f 7269 6573 2028  subdirectories (
+00010a10: 6966 2065 7869 7374 292e 0a20 2020 2020  if exist)..     
+00010a20: 2020 2054 6865 2072 6573 756c 7420 6578     The result ex
+00010a30: 636c 7564 6573 2074 6865 2073 697a 6520  cludes the size 
+00010a40: 6f66 2064 6972 6563 746f 7279 2069 7473  of directory its
+00010a50: 656c 662e 2049 6e20 6f74 6865 7220 776f  elf. In other wo
+00010a60: 7264 732c 2072 6574 7572 6e20 3020 4279  rds, return 0 By
+00010a70: 7465 206f 6e20 616e 2065 6d70 7479 2064  te on an empty d
+00010a80: 6972 6563 746f 7279 2070 6174 680a 2020  irectory path.  
+00010a90: 2020 2020 2020 322e 204c 6173 742d 6d6f        2. Last-mo
+00010aa0: 6469 6669 6564 2074 696d 6520 6f66 2064  dified time of d
+00010ab0: 6972 6563 746f 7279 3a20 7265 7475 726e  irectory: return
+00010ac0: 2074 6865 206c 6174 6573 7420 6d6f 6469   the latest modi
+00010ad0: 6669 6564 2074 696d 6520 6f66 2061 6c6c  fied time of all
+00010ae0: 2066 696c 6520 696e 2069 742e 2054 6865   file in it. The
+00010af0: 206d 7469 6d65 206f 6620 656d 7074 7920   mtime of empty 
+00010b00: 6469 7265 6374 6f72 7920 6973 2031 3937  directory is 197
+00010b10: 302d 3031 2d30 3120 3030 3a30 303a 3030  0-01-01 00:00:00
+00010b20: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+00010b30: 6e73 3a20 416e 2069 6e74 2069 6e64 6963  ns: An int indic
+00010b40: 6174 6573 2073 697a 6520 696e 2042 7974  ates size in Byt
+00010b50: 6573 0a20 2020 2020 2020 2027 2727 0a20  es.        '''. 
+00010b60: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00010b70: 6c66 2e69 735f 6469 7228 293a 0a20 2020  lf.is_dir():.   
+00010b80: 2020 2020 2020 2020 2072 6169 7365 2053           raise S
+00010b90: 3346 696c 654e 6f74 466f 756e 6445 7272  3FileNotFoundErr
+00010ba0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00010bb0: 2020 2020 274e 6f20 7375 6368 2066 696c      'No such fil
+00010bc0: 6520 6f72 2064 6972 6563 746f 7279 3a20  e or directory: 
+00010bd0: 2572 2720 2520 7365 6c66 2e70 6174 685f  %r' % self.path_
+00010be0: 7769 7468 5f70 726f 746f 636f 6c29 0a0a  with_protocol)..
+00010bf0: 2020 2020 2020 2020 6275 636b 6574 2c20          bucket, 
+00010c00: 6b65 7920 3d20 7061 7273 655f 7333 5f75  key = parse_s3_u
+00010c10: 726c 2873 656c 662e 7061 7468 5f77 6974  rl(self.path_wit
+00010c20: 685f 7072 6f74 6f63 6f6c 290a 2020 2020  h_protocol).    
+00010c30: 2020 2020 7072 6566 6978 203d 205f 6265      prefix = _be
+00010c40: 636f 6d65 5f70 7265 6669 7828 6b65 7929  come_prefix(key)
+00010c50: 0a20 2020 2020 2020 2063 6c69 656e 7420  .        client 
+00010c60: 3d20 7365 6c66 2e5f 636c 6965 6e74 0a20  = self._client. 
+00010c70: 2020 2020 2020 2073 697a 6520 3d20 300a         size = 0.
+00010c80: 2020 2020 2020 2020 6d74 696d 6520 3d20          mtime = 
+00010c90: 302e 300a 2020 2020 2020 2020 7769 7468  0.0.        with
+00010ca0: 2072 6169 7365 5f73 335f 6572 726f 7228   raise_s3_error(
+00010cb0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+00010cc0: 726f 746f 636f 6c29 3a0a 2020 2020 2020  rotocol):.      
+00010cd0: 2020 2020 2020 666f 7220 7265 7370 2069        for resp i
+00010ce0: 6e20 5f6c 6973 745f 6f62 6a65 6374 735f  n _list_objects_
+00010cf0: 7265 6375 7273 6976 6528 636c 6965 6e74  recursive(client
+00010d00: 2c20 6275 636b 6574 2c20 7072 6566 6978  , bucket, prefix
+00010d10: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00010d20: 2020 2066 6f72 2063 6f6e 7465 6e74 2069     for content i
+00010d30: 6e20 7265 7370 2e67 6574 2827 436f 6e74  n resp.get('Cont
+00010d40: 656e 7473 272c 205b 5d29 3a0a 2020 2020  ents', []):.    
+00010d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d60: 7369 7a65 202b 3d20 636f 6e74 656e 745b  size += content[
+00010d70: 2753 697a 6527 5d0a 2020 2020 2020 2020  'Size'].        
+00010d80: 2020 2020 2020 2020 2020 2020 6c61 7374              last
+00010d90: 5f6d 6f64 6966 6965 6420 3d20 636f 6e74  _modified = cont
+00010da0: 656e 745b 274c 6173 744d 6f64 6966 6965  ent['LastModifie
+00010db0: 6427 5d2e 7469 6d65 7374 616d 7028 290a  d'].timestamp().
+00010dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010dd0: 2020 2020 6966 206d 7469 6d65 203c 206c      if mtime < l
+00010de0: 6173 745f 6d6f 6469 6669 6564 3a0a 2020  ast_modified:.  
+00010df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e00: 2020 2020 2020 6d74 696d 6520 3d20 6c61        mtime = la
+00010e10: 7374 5f6d 6f64 6966 6965 640a 0a20 2020  st_modified..   
+00010e20: 2020 2020 2072 6574 7572 6e20 5374 6174       return Stat
+00010e30: 5265 7375 6c74 2873 697a 653d 7369 7a65  Result(size=size
+00010e40: 2c20 6d74 696d 653d 6d74 696d 652c 2069  , mtime=mtime, i
+00010e50: 7364 6972 3d54 7275 6529 0a0a 2020 2020  sdir=True)..    
+00010e60: 6465 6620 7374 6174 2873 656c 662c 2066  def stat(self, f
+00010e70: 6f6c 6c6f 775f 7379 6d6c 696e 6b73 3d54  ollow_symlinks=T
+00010e80: 7275 6529 202d 3e20 5374 6174 5265 7375  rue) -> StatResu
+00010e90: 6c74 3a0a 2020 2020 2020 2020 2727 270a  lt:.        '''.
+00010ea0: 2020 2020 2020 2020 4765 7420 5374 6174          Get Stat
+00010eb0: 5265 7375 6c74 206f 6620 7333 5f75 726c  Result of s3_url
+00010ec0: 2066 696c 652c 2069 6e63 6c75 6469 6e67   file, including
+00010ed0: 2066 696c 6520 7369 7a65 2061 6e64 206d   file size and m
+00010ee0: 7469 6d65 2c20 7265 6665 7272 696e 6720  time, referring 
+00010ef0: 746f 2073 335f 6765 7473 697a 6520 616e  to s3_getsize an
+00010f00: 6420 7333 5f67 6574 6d74 696d 650a 0a20  d s3_getmtime.. 
+00010f10: 2020 2020 2020 2049 6620 7333 5f75 726c         If s3_url
+00010f20: 2069 7320 6e6f 7420 616e 2065 7869 7374   is not an exist
+00010f30: 656e 7420 7061 7468 2c20 7768 6963 6820  ent path, which 
+00010f40: 6d65 616e 7320 7333 5f65 7869 7374 2873  means s3_exist(s
+00010f50: 335f 7572 6c29 2072 6574 7572 6e73 2046  3_url) returns F
+00010f60: 616c 7365 2c20 7468 656e 2072 6169 7365  alse, then raise
+00010f70: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
+00010f80: 7272 6f72 0a20 2020 2020 2020 2049 6620  rror.        If 
+00010f90: 6174 7465 6d70 7420 746f 2067 6574 2053  attempt to get S
+00010fa0: 7461 7452 6573 756c 7420 6f66 2063 6f6d  tatResult of com
+00010fb0: 706c 6574 6520 7333 2c20 7375 6368 2061  plete s3, such a
+00010fc0: 7320 7333 5f64 6972 5f75 726c 203d 3d20  s s3_dir_url == 
+00010fd0: 2773 333a 2f2f 272c 2072 6169 7365 2053  's3://', raise S
+00010fe0: 3342 7563 6b65 744e 6f74 466f 756e 6445  3BucketNotFoundE
+00010ff0: 7272 6f72 0a0a 2020 2020 2020 2020 3a72  rror..        :r
+00011000: 6574 7572 6e73 3a20 5374 6174 5265 7375  eturns: StatResu
+00011010: 6c74 0a20 2020 2020 2020 203a 7261 6973  lt.        :rais
+00011020: 6573 3a20 5333 4669 6c65 4e6f 7446 6f75  es: S3FileNotFou
+00011030: 6e64 4572 726f 722c 2053 3342 7563 6b65  ndError, S3Bucke
+00011040: 744e 6f74 466f 756e 6445 7272 6f72 0a20  tNotFoundError. 
+00011050: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+00011060: 2020 2069 736c 6e6b 203d 2046 616c 7365     islnk = False
+00011070: 0a20 2020 2020 2020 2062 7563 6b65 742c  .        bucket,
+00011080: 206b 6579 203d 2070 6172 7365 5f73 335f   key = parse_s3_
+00011090: 7572 6c28 7365 6c66 2e70 6174 685f 7769  url(self.path_wi
+000110a0: 7468 5f70 726f 746f 636f 6c29 0a20 2020  th_protocol).   
+000110b0: 2020 2020 2069 6620 6e6f 7420 6275 636b       if not buck
+000110c0: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+000110d0: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
+000110e0: 7446 6f75 6e64 4572 726f 7228 0a20 2020  tFoundError(.   
+000110f0: 2020 2020 2020 2020 2020 2020 2027 456d               'Em
+00011100: 7074 7920 6275 636b 6574 206e 616d 653a  pty bucket name:
+00011110: 2025 7227 2025 2073 656c 662e 7061 7468   %r' % self.path
+00011120: 5f77 6974 685f 7072 6f74 6f63 6f6c 290a  _with_protocol).
+00011130: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00011140: 7365 6c66 2e69 735f 6669 6c65 2829 3a0a  self.is_file():.
+00011150: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00011160: 726e 2073 656c 662e 5f67 6574 6469 7273  rn self._getdirs
+00011170: 7461 7428 290a 0a20 2020 2020 2020 2063  tat()..        c
+00011180: 6c69 656e 7420 3d20 7365 6c66 2e5f 636c  lient = self._cl
+00011190: 6965 6e74 0a20 2020 2020 2020 2077 6974  ient.        wit
+000111a0: 6820 7261 6973 655f 7333 5f65 7272 6f72  h raise_s3_error
+000111b0: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+000111c0: 7072 6f74 6f63 6f6c 293a 0a20 2020 2020  protocol):.     
+000111d0: 2020 2020 2020 2063 6f6e 7465 6e74 203d         content =
+000111e0: 2063 6c69 656e 742e 6865 6164 5f6f 626a   client.head_obj
+000111f0: 6563 7428 4275 636b 6574 3d62 7563 6b65  ect(Bucket=bucke
+00011200: 742c 204b 6579 3d6b 6579 290a 2020 2020  t, Key=key).    
+00011210: 2020 2020 2020 2020 6966 2027 4d65 7461          if 'Meta
+00011220: 6461 7461 2720 696e 2063 6f6e 7465 6e74  data' in content
+00011230: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011240: 2020 6d65 7461 6461 7461 203d 2064 6963    metadata = dic
+00011250: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00011260: 2020 2020 2020 2028 6b65 792e 6c6f 7765         (key.lowe
+00011270: 7228 292c 2076 616c 7565 290a 2020 2020  r(), value).    
+00011280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011290: 666f 7220 6b65 792c 2076 616c 7565 2069  for key, value i
+000112a0: 6e20 636f 6e74 656e 745b 274d 6574 6164  n content['Metad
+000112b0: 6174 6127 5d2e 6974 656d 7328 2929 0a20  ata'].items()). 
+000112c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000112d0: 6620 6d65 7461 6461 7461 2061 6e64 2027  f metadata and '
+000112e0: 7379 6d6c 696e 6b5f 746f 2720 696e 206d  symlink_to' in m
+000112f0: 6574 6164 6174 613a 0a20 2020 2020 2020  etadata:.       
+00011300: 2020 2020 2020 2020 2020 2020 2069 736c               isl
+00011310: 6e6b 203d 2054 7275 650a 2020 2020 2020  nk = True.      
+00011320: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00011330: 2069 736c 6e6b 2061 6e64 2066 6f6c 6c6f   islnk and follo
+00011340: 775f 7379 6d6c 696e 6b73 3a0a 2020 2020  w_symlinks:.    
+00011350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011360: 2020 2020 7333 5f75 726c 203d 206d 6574      s3_url = met
+00011370: 6164 6174 615b 2773 796d 6c69 6e6b 5f74  adata['symlink_t
+00011380: 6f27 5d0a 2020 2020 2020 2020 2020 2020  o'].            
+00011390: 2020 2020 2020 2020 2020 2020 6275 636b              buck
+000113a0: 6574 2c20 6b65 7920 3d20 7061 7273 655f  et, key = parse_
+000113b0: 7333 5f75 726c 2873 335f 7572 6c29 0a20  s3_url(s3_url). 
+000113c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113d0: 2020 2020 2020 2063 6f6e 7465 6e74 203d         content =
+000113e0: 2063 6c69 656e 742e 6865 6164 5f6f 626a   client.head_obj
+000113f0: 6563 7428 4275 636b 6574 3d62 7563 6b65  ect(Bucket=bucke
+00011400: 742c 204b 6579 3d6b 6579 290a 2020 2020  t, Key=key).    
+00011410: 2020 2020 2020 2020 7374 6174 5f72 6563          stat_rec
+00011420: 6f72 6420 3d20 5374 6174 5265 7375 6c74  ord = StatResult
+00011430: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00011440: 2020 6973 6c6e 6b3d 6973 6c6e 6b2c 0a20    islnk=islnk,. 
+00011450: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00011460: 697a 653d 636f 6e74 656e 745b 2743 6f6e  ize=content['Con
+00011470: 7465 6e74 4c65 6e67 7468 275d 2c0a 2020  tentLength'],.  
+00011480: 2020 2020 2020 2020 2020 2020 2020 6d74                mt
+00011490: 696d 653d 636f 6e74 656e 745b 274c 6173  ime=content['Las
+000114a0: 744d 6f64 6966 6965 6427 5d2e 7469 6d65  tModified'].time
+000114b0: 7374 616d 7028 292c 0a20 2020 2020 2020  stamp(),.       
+000114c0: 2020 2020 2020 2020 2065 7874 7261 3d63           extra=c
+000114d0: 6f6e 7465 6e74 290a 2020 2020 2020 2020  ontent).        
+000114e0: 7265 7475 726e 2073 7461 745f 7265 636f  return stat_reco
+000114f0: 7264 0a0a 2020 2020 6465 6620 6c73 7461  rd..    def lsta
+00011500: 7428 7365 6c66 2920 2d3e 2053 7461 7452  t(self) -> StatR
+00011510: 6573 756c 743a 0a20 2020 2020 2020 2027  esult:.        '
+00011520: 2727 4c69 6b65 2050 6174 682e 7374 6174  ''Like Path.stat
+00011530: 2829 2062 7574 2c20 6966 2074 6865 2070  () but, if the p
+00011540: 6174 6820 706f 696e 7473 2074 6f20 6120  ath points to a 
+00011550: 7379 6d62 6f6c 6963 206c 696e 6b2c 2072  symbolic link, r
+00011560: 6574 7572 6e20 7468 6520 7379 6d62 6f6c  eturn the symbol
+00011570: 6963 206c 696e 6be2 8099 7320 696e 666f  ic link...s info
+00011580: 726d 6174 696f 6e20 7261 7468 6572 2074  rmation rather t
+00011590: 6861 6e20 6974 7320 7461 7267 6574 e280  han its target..
+000115a0: 9973 2e27 2727 0a20 2020 2020 2020 2072  .s.'''.        r
+000115b0: 6574 7572 6e20 7365 6c66 2e73 7461 7428  eturn self.stat(
+000115c0: 666f 6c6c 6f77 5f73 796d 6c69 6e6b 733d  follow_symlinks=
+000115d0: 4661 6c73 6529 0a0a 2020 2020 6465 6620  False)..    def 
+000115e0: 756e 6c69 6e6b 2873 656c 662c 206d 6973  unlink(self, mis
+000115f0: 7369 6e67 5f6f 6b3a 2062 6f6f 6c20 3d20  sing_ok: bool = 
+00011600: 4661 6c73 6529 202d 3e20 4e6f 6e65 3a0a  False) -> None:.
+00011610: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+00011620: 2020 2020 5265 6d6f 7665 2074 6865 2066      Remove the f
+00011630: 696c 6520 6f6e 2073 330a 0a20 2020 2020  ile on s3..     
+00011640: 2020 203a 7061 7261 6d20 6d69 7373 696e     :param missin
+00011650: 675f 6f6b 3a20 6966 2046 616c 7365 2061  g_ok: if False a
+00011660: 6e64 2074 6172 6765 7420 6669 6c65 206e  nd target file n
+00011670: 6f74 2065 7869 7374 732c 2072 6169 7365  ot exists, raise
+00011680: 2053 3346 696c 654e 6f74 466f 756e 6445   S3FileNotFoundE
+00011690: 7272 6f72 0a20 2020 2020 2020 203a 7261  rror.        :ra
+000116a0: 6973 6573 3a20 5333 5065 726d 6973 7369  ises: S3Permissi
+000116b0: 6f6e 4572 726f 722c 2053 3346 696c 654e  onError, S3FileN
+000116c0: 6f74 466f 756e 6445 7272 6f72 2c20 5333  otFoundError, S3
+000116d0: 4973 4144 6972 6563 746f 7279 4572 726f  IsADirectoryErro
+000116e0: 720a 2020 2020 2020 2020 2727 270a 2020  r.        '''.  
+000116f0: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
+00011700: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+00011710: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+00011720: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+00011730: 2020 6966 206e 6f74 2062 7563 6b65 7420    if not bucket 
+00011740: 6f72 206e 6f74 206b 6579 206f 7220 6b65  or not key or ke
+00011750: 792e 656e 6473 7769 7468 2827 2f27 293a  y.endswith('/'):
+00011760: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00011770: 7365 2053 3349 7341 4469 7265 6374 6f72  se S3IsADirector
+00011780: 7945 7272 6f72 280a 2020 2020 2020 2020  yError(.        
+00011790: 2020 2020 2020 2020 2749 7320 6120 6469          'Is a di
+000117a0: 7265 6374 6f72 793a 2025 7227 2025 2073  rectory: %r' % s
+000117b0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+000117c0: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+000117d0: 6966 206e 6f74 2073 656c 662e 6973 5f66  if not self.is_f
+000117e0: 696c 6528 293a 0a20 2020 2020 2020 2020  ile():.         
+000117f0: 2020 2069 6620 6d69 7373 696e 675f 6f6b     if missing_ok
+00011800: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011810: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+00011820: 2020 2020 2072 6169 7365 2053 3346 696c       raise S3Fil
+00011830: 654e 6f74 466f 756e 6445 7272 6f72 280a  eNotFoundError(.
+00011840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011850: 274e 6f20 7375 6368 2066 696c 653a 2025  'No such file: %
+00011860: 7227 2025 2073 656c 662e 7061 7468 5f77  r' % self.path_w
+00011870: 6974 685f 7072 6f74 6f63 6f6c 290a 0a20  ith_protocol).. 
+00011880: 2020 2020 2020 2077 6974 6820 7261 6973         with rais
+00011890: 655f 7333 5f65 7272 6f72 2873 656c 662e  e_s3_error(self.
+000118a0: 7061 7468 5f77 6974 685f 7072 6f74 6f63  path_with_protoc
+000118b0: 6f6c 293a 0a20 2020 2020 2020 2020 2020  ol):.           
+000118c0: 2073 656c 662e 5f63 6c69 656e 742e 6465   self._client.de
+000118d0: 6c65 7465 5f6f 626a 6563 7428 4275 636b  lete_object(Buck
+000118e0: 6574 3d62 7563 6b65 742c 204b 6579 3d6b  et=bucket, Key=k
+000118f0: 6579 290a 0a20 2020 2064 6566 2077 616c  ey)..    def wal
+00011900: 6b28 7365 6c66 2c20 666f 6c6c 6f77 6c69  k(self, followli
+00011910: 6e6b 733a 2062 6f6f 6c20 3d20 4661 6c73  nks: bool = Fals
+00011920: 650a 2020 2020 2020 2020 2020 2020 2920  e.            ) 
+00011930: 2d3e 2049 7465 7261 746f 725b 5475 706c  -> Iterator[Tupl
+00011940: 655b 7374 722c 204c 6973 745b 7374 725d  e[str, List[str]
+00011950: 2c20 4c69 7374 5b73 7472 5d5d 5d3a 0a20  , List[str]]]:. 
+00011960: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+00011970: 2020 2049 7465 7261 7469 7665 6c79 2074     Iteratively t
+00011980: 7261 7665 7273 6520 7468 6520 6769 7665  raverse the give
+00011990: 6e20 7333 2064 6972 6563 746f 7279 2c20  n s3 directory, 
+000119a0: 696e 2074 6f70 2d62 6f74 746f 6d20 6f72  in top-bottom or
+000119b0: 6465 722e 2049 6e20 6f74 6865 7220 776f  der. In other wo
+000119c0: 7264 732c 2066 6972 7374 6c79 2074 7261  rds, firstly tra
+000119d0: 7665 7273 6520 7061 7265 6e74 2064 6972  verse parent dir
+000119e0: 6563 746f 7279 2c20 6966 2073 7562 6469  ectory, if subdi
+000119f0: 7265 6374 6f72 6965 7320 6578 6973 742c  rectories exist,
+00011a00: 2074 7261 7665 7273 6520 7468 6520 7375   traverse the su
+00011a10: 6264 6972 6563 746f 7269 6573 2069 6e20  bdirectories in 
+00011a20: 616c 7068 6162 6574 6963 616c 206f 7264  alphabetical ord
+00011a30: 6572 2e0a 2020 2020 2020 2020 4576 6572  er..        Ever
+00011a40: 7920 6974 6572 6174 696f 6e20 6f6e 2067  y iteration on g
+00011a50: 656e 6572 6174 6f72 2079 6965 6c64 7320  enerator yields 
+00011a60: 6120 332d 7475 706c 653a 2028 726f 6f74  a 3-tuple: (root
+00011a70: 2c20 6469 7273 2c20 6669 6c65 7329 0a0a  , dirs, files)..
+00011a80: 2020 2020 2020 2020 2d20 726f 6f74 3a20          - root: 
+00011a90: 4375 7272 656e 7420 7333 2070 6174 683b  Current s3 path;
+00011aa0: 0a20 2020 2020 2020 202d 2064 6972 733a  .        - dirs:
+00011ab0: 204e 616d 6520 6c69 7374 206f 6620 7375   Name list of su
+00011ac0: 6264 6972 6563 746f 7269 6573 2069 6e20  bdirectories in 
+00011ad0: 6375 7272 656e 7420 6469 7265 6374 6f72  current director
+00011ae0: 792e 2054 6865 206c 6973 7420 6973 2073  y. The list is s
+00011af0: 6f72 7465 6420 6279 206e 616d 6520 696e  orted by name in
+00011b00: 2061 7363 656e 6469 6e67 2061 6c70 6861   ascending alpha
+00011b10: 6265 7469 6361 6c20 6f72 6465 723b 0a20  betical order;. 
+00011b20: 2020 2020 2020 202d 2066 696c 6573 3a20         - files: 
+00011b30: 4e61 6d65 206c 6973 7420 6f66 2066 696c  Name list of fil
+00011b40: 6573 2069 6e20 6375 7272 656e 7420 6469  es in current di
+00011b50: 7265 6374 6f72 792e 2054 6865 206c 6973  rectory. The lis
+00011b60: 7420 6973 2073 6f72 7465 6420 6279 206e  t is sorted by n
+00011b70: 616d 6520 696e 2061 7363 656e 6469 6e67  ame in ascending
+00011b80: 2061 6c70 6861 6265 7469 6361 6c20 6f72   alphabetical or
+00011b90: 6465 723b 0a0a 2020 2020 2020 2020 4966  der;..        If
+00011ba0: 2073 335f 7572 6c20 6973 2061 2066 696c   s3_url is a fil
+00011bb0: 6520 7061 7468 2c20 7265 7475 726e 2061  e path, return a
+00011bc0: 6e20 656d 7074 7920 6765 6e65 7261 746f  n empty generato
+00011bd0: 720a 2020 2020 2020 2020 4966 2073 335f  r.        If s3_
+00011be0: 7572 6c20 6973 2061 206e 6f6e 2d65 7869  url is a non-exi
+00011bf0: 7374 656e 7420 7061 7468 2c20 7265 7475  stent path, retu
+00011c00: 726e 2061 6e20 656d 7074 7920 6765 6e65  rn an empty gene
+00011c10: 7261 746f 720a 2020 2020 2020 2020 4966  rator.        If
+00011c20: 2073 335f 7572 6c20 6973 2061 2062 7563   s3_url is a buc
+00011c30: 6b65 7420 7061 7468 2c20 6275 636b 6574  ket path, bucket
+00011c40: 2077 696c 6c20 6265 2074 6865 2074 6f70   will be the top
+00011c50: 2064 6972 6563 746f 7279 2c20 616e 6420   directory, and 
+00011c60: 7769 6c6c 2062 6520 7265 7475 726e 6564  will be returned
+00011c70: 2061 7420 6669 7273 7420 6974 6572 6174   at first iterat
+00011c80: 696f 6e20 6f66 2067 656e 6572 6174 6f72  ion of generator
+00011c90: 0a20 2020 2020 2020 2049 6620 7333 5f75  .        If s3_u
+00011ca0: 726c 2069 7320 616e 2065 6d70 7479 2062  rl is an empty b
+00011cb0: 7563 6b65 742c 206f 6e6c 7920 7969 656c  ucket, only yiel
+00011cc0: 6420 6f6e 6520 332d 7475 706c 6520 286e  d one 3-tuple (n
+00011cd0: 6f74 6573 3a20 7333 2064 6f65 736e 2774  otes: s3 doesn't
+00011ce0: 2068 6176 6520 656d 7074 7920 6469 7265   have empty dire
+00011cf0: 6374 6f72 7929 0a20 2020 2020 2020 2049  ctory).        I
+00011d00: 6620 7333 5f75 726c 2064 6f65 736e 2774  f s3_url doesn't
+00011d10: 2063 6f6e 7461 696e 2061 6e79 2062 7563   contain any buc
+00011d20: 6b65 742c 2077 6869 6368 2069 7320 7333  ket, which is s3
+00011d30: 5f75 726c 203d 3d20 2773 333a 2f2f 272c  _url == 's3://',
+00011d40: 2072 6169 7365 2055 6e73 7570 706f 7274   raise Unsupport
+00011d50: 6564 4572 726f 722e 2077 616c 6b28 2920  edError. walk() 
+00011d60: 6f6e 2063 6f6d 706c 6574 6520 7333 2069  on complete s3 i
+00011d70: 7320 6e6f 7420 7375 7070 6f72 7465 6420  s not supported 
+00011d80: 696e 206d 6567 6669 6c65 0a0a 2020 2020  in megfile..    
+00011d90: 2020 2020 3a70 6172 616d 2066 6f6c 6c6f      :param follo
+00011da0: 776c 696e 6b73 3a20 7768 6574 6865 7220  wlinks: whether 
+00011db0: 666f 6c6c 6f77 6c69 6e6b 7320 6973 2054  followlinks is T
+00011dc0: 7275 6520 6f72 2046 616c 7365 2c20 7265  rue or False, re
+00011dd0: 7375 6c74 2069 7320 7468 6520 7361 6d65  sult is the same
+00011de0: 2e20 4265 6361 7573 6520 7333 2073 796d  . Because s3 sym
+00011df0: 6c69 6e6b 206e 6f74 2073 7570 706f 7274  link not support
+00011e00: 2064 6972 2e0a 2020 2020 2020 2020 3a72   dir..        :r
+00011e10: 6169 7365 733a 2055 6e73 7570 706f 7274  aises: Unsupport
+00011e20: 6564 4572 726f 720a 2020 2020 2020 2020  edError.        
+00011e30: 3a72 6574 7572 6e73 3a20 4120 332d 7475  :returns: A 3-tu
+00011e40: 706c 6520 6765 6e65 7261 746f 720a 2020  ple generator.  
+00011e50: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+00011e60: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
+00011e70: 7061 7273 655f 7333 5f75 726c 2873 656c  parse_s3_url(sel
+00011e80: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+00011e90: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
+00011ea0: 206e 6f74 2062 7563 6b65 743a 0a20 2020   not bucket:.   
+00011eb0: 2020 2020 2020 2020 2072 6169 7365 2055           raise U
+00011ec0: 6e73 7570 706f 7274 6564 4572 726f 7228  nsupportedError(
+00011ed0: 2757 616c 6b20 7768 6f6c 6520 7333 272c  'Walk whole s3',
+00011ee0: 2073 656c 662e 7061 7468 5f77 6974 685f   self.path_with_
+00011ef0: 7072 6f74 6f63 6f6c 290a 0a20 2020 2020  protocol)..     
+00011f00: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
+00011f10: 735f 6469 7228 293a 0a20 2020 2020 2020  s_dir():.       
+00011f20: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00011f30: 2020 2020 2073 7461 636b 203d 205b 6b65       stack = [ke
+00011f40: 795d 0a20 2020 2020 2020 2063 6c69 656e  y].        clien
+00011f50: 7420 3d20 7365 6c66 2e5f 636c 6965 6e74  t = self._client
+00011f60: 0a20 2020 2020 2020 2077 6869 6c65 206c  .        while l
+00011f70: 656e 2873 7461 636b 2920 3e20 303a 0a20  en(stack) > 0:. 
+00011f80: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+00011f90: 6e74 203d 205f 6265 636f 6d65 5f70 7265  nt = _become_pre
+00011fa0: 6669 7828 7374 6163 6b2e 706f 7028 2929  fix(stack.pop())
+00011fb0: 0a20 2020 2020 2020 2020 2020 2064 6972  .            dir
+00011fc0: 732c 2066 696c 6573 203d 205b 5d2c 205b  s, files = [], [
+00011fd0: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
+00011fe0: 7220 7265 7370 2069 6e20 5f6c 6973 745f  r resp in _list_
+00011ff0: 6f62 6a65 6374 735f 7265 6375 7273 6976  objects_recursiv
+00012000: 6528 636c 6965 6e74 2c20 6275 636b 6574  e(client, bucket
+00012010: 2c20 6375 7272 656e 742c 2027 2f27 293a  , current, '/'):
+00012020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012030: 2066 6f72 2063 6f6d 6d6f 6e5f 7072 6566   for common_pref
+00012040: 6978 2069 6e20 7265 7370 2e67 6574 2827  ix in resp.get('
+00012050: 436f 6d6d 6f6e 5072 6566 6978 6573 272c  CommonPrefixes',
+00012060: 205b 5d29 3a0a 2020 2020 2020 2020 2020   []):.          
+00012070: 2020 2020 2020 2020 2020 6469 7273 2e61            dirs.a
+00012080: 7070 656e 6428 636f 6d6d 6f6e 5f70 7265  ppend(common_pre
+00012090: 6669 785b 2750 7265 6669 7827 5d5b 3a2d  fix['Prefix'][:-
+000120a0: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
+000120b0: 2020 2020 666f 7220 636f 6e74 656e 7420      for content 
+000120c0: 696e 2072 6573 702e 6765 7428 2743 6f6e  in resp.get('Con
+000120d0: 7465 6e74 7327 2c20 5b5d 293a 0a20 2020  tents', []):.   
+000120e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000120f0: 2066 696c 6573 2e61 7070 656e 6428 636f   files.append(co
+00012100: 6e74 656e 745b 274b 6579 275d 290a 0a20  ntent['Key']).. 
+00012110: 2020 2020 2020 2020 2020 2064 6972 7320             dirs 
+00012120: 3d20 736f 7274 6564 2864 6972 7329 0a20  = sorted(dirs). 
+00012130: 2020 2020 2020 2020 2020 2073 7461 636b             stack
+00012140: 2e65 7874 656e 6428 7265 7665 7273 6564  .extend(reversed
+00012150: 2864 6972 7329 290a 0a20 2020 2020 2020  (dirs))..       
+00012160: 2020 2020 2072 6f6f 7420 3d20 7333 5f70       root = s3_p
+00012170: 6174 685f 6a6f 696e 280a 2020 2020 2020  ath_join(.      
+00012180: 2020 2020 2020 2020 2020 6627 7b73 656c            f'{sel
+00012190: 662e 5f70 726f 746f 636f 6c5f 7769 7468  f._protocol_with
+000121a0: 5f70 726f 6669 6c65 7d3a 2f2f 272c 2062  _profile}://', b
+000121b0: 7563 6b65 742c 2063 7572 7265 6e74 295b  ucket, current)[
+000121c0: 3a2d 315d 0a20 2020 2020 2020 2020 2020  :-1].           
+000121d0: 2064 6972 7320 3d20 5b70 6174 685b 6c65   dirs = [path[le
+000121e0: 6e28 6375 7272 656e 7429 3a5d 2066 6f72  n(current):] for
+000121f0: 2070 6174 6820 696e 2064 6972 735d 0a20   path in dirs]. 
+00012200: 2020 2020 2020 2020 2020 2066 696c 6573             files
+00012210: 203d 2073 6f72 7465 6428 7061 7468 5b6c   = sorted(path[l
+00012220: 656e 2863 7572 7265 6e74 293a 5d20 666f  en(current):] fo
+00012230: 7220 7061 7468 2069 6e20 6669 6c65 7329  r path in files)
+00012240: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+00012250: 6c64 2072 6f6f 742c 2064 6972 732c 2066  ld root, dirs, f
+00012260: 696c 6573 0a0a 2020 2020 6465 6620 6d64  iles..    def md
+00012270: 3528 7365 6c66 2c20 7265 6361 6c63 756c  5(self, recalcul
+00012280: 6174 653a 2062 6f6f 6c20 3d20 4661 6c73  ate: bool = Fals
+00012290: 652c 2066 6f6c 6c6f 776c 696e 6b73 3a20  e, followlinks: 
+000122a0: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
+000122b0: 2073 7472 3a0a 2020 2020 2020 2020 2727   str:.        ''
+000122c0: 270a 2020 2020 2020 2020 4765 7420 6d64  '.        Get md
+000122d0: 3520 6d65 7461 2069 6e66 6f20 696e 2066  5 meta info in f
+000122e0: 696c 6573 2074 6861 7420 7570 6c6f 6164  iles that upload
+000122f0: 6564 2f63 6f70 6965 6420 7669 6120 6d65  ed/copied via me
+00012300: 6766 696c 650a 0a20 2020 2020 2020 2049  gfile..        I
+00012310: 6620 6d65 7461 2069 6e66 6f20 6973 206c  f meta info is l
+00012320: 6f73 7420 6f72 206e 6f6e 2d65 7869 7374  ost or non-exist
+00012330: 656e 742c 2072 6574 7572 6e20 4e6f 6e65  ent, return None
+00012340: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00012350: 2072 6563 616c 6375 6c61 7465 3a20 6361   recalculate: ca
+00012360: 6c63 756c 6174 6520 6d64 3520 696e 2072  lculate md5 in r
+00012370: 6561 6c2d 7469 6d65 206f 7220 7265 7475  eal-time or retu
+00012380: 726e 2073 3320 6574 6167 0a20 2020 2020  rn s3 etag.     
+00012390: 2020 203a 7061 7261 6d20 666f 6c6c 6f77     :param follow
+000123a0: 6c69 6e6b 733a 2049 6620 6973 2054 7275  links: If is Tru
+000123b0: 652c 2063 616c 6375 6c61 7465 206d 6435  e, calculate md5
+000123c0: 2066 6f72 2072 6561 6c20 6669 6c65 0a20   for real file. 
+000123d0: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+000123e0: 206d 6435 206d 6574 6120 696e 666f 0a20   md5 meta info. 
+000123f0: 2020 2020 2020 2027 2727 0a20 2020 2020         '''.     
+00012400: 2020 2062 7563 6b65 742c 205f 203d 2070     bucket, _ = p
+00012410: 6172 7365 5f73 335f 7572 6c28 7365 6c66  arse_s3_url(self
+00012420: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00012430: 636f 6c29 0a20 2020 2020 2020 2069 6620  col).        if 
+00012440: 6e6f 7420 6275 636b 6574 3a0a 2020 2020  not bucket:.    
+00012450: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+00012460: 4275 636b 6574 4e6f 7446 6f75 6e64 4572  BucketNotFoundEr
+00012470: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00012480: 2020 2020 2027 456d 7074 7920 6275 636b       'Empty buck
+00012490: 6574 206e 616d 653a 2025 7227 2025 2073  et name: %r' % s
+000124a0: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+000124b0: 6f74 6f63 6f6c 290a 2020 2020 2020 2020  otocol).        
+000124c0: 7374 6174 203d 2073 656c 662e 7374 6174  stat = self.stat
+000124d0: 2866 6f6c 6c6f 775f 7379 6d6c 696e 6b73  (follow_symlinks
+000124e0: 3d66 6f6c 6c6f 776c 696e 6b73 290a 2020  =followlinks).  
+000124f0: 2020 2020 2020 6966 2073 7461 742e 6973        if stat.is
+00012500: 6469 723a 0a20 2020 2020 2020 2020 2020  dir:.           
+00012510: 2068 6173 685f 6d64 3520 3d20 6861 7368   hash_md5 = hash
+00012520: 6c69 622e 6d64 3528 2920 2023 206e 6f73  lib.md5()  # nos
+00012530: 6563 0a20 2020 2020 2020 2020 2020 2066  ec.            f
+00012540: 6f72 2066 696c 655f 6e61 6d65 2069 6e20  or file_name in 
+00012550: 7365 6c66 2e6c 6973 7464 6972 2829 3a0a  self.listdir():.
+00012560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012570: 6368 756e 6b20 3d20 5333 5061 7468 280a  chunk = S3Path(.
+00012580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012590: 2020 2020 7333 5f70 6174 685f 6a6f 696e      s3_path_join
+000125a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000125b0: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
+000125c0: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+000125d0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
+000125e0: 2020 2020 2020 2020 2020 2066 696c 655f             file_
+000125f0: 6e61 6d65 2929 2e6d 6435 2872 6563 616c  name)).md5(recal
+00012600: 6375 6c61 7465 3d72 6563 616c 6375 6c61  culate=recalcula
+00012610: 7465 292e 656e 636f 6465 2829 0a20 2020  te).encode().   
+00012620: 2020 2020 2020 2020 2020 2020 2068 6173               has
+00012630: 685f 6d64 352e 7570 6461 7465 2863 6875  h_md5.update(chu
+00012640: 6e6b 290a 2020 2020 2020 2020 2020 2020  nk).            
+00012650: 7265 7475 726e 2068 6173 685f 6d64 352e  return hash_md5.
+00012660: 6865 7864 6967 6573 7428 290a 2020 2020  hexdigest().    
+00012670: 2020 2020 6966 2072 6563 616c 6375 6c61      if recalcula
+00012680: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00012690: 7061 7468 5f69 6e73 7461 6e63 6520 3d20  path_instance = 
+000126a0: 7365 6c66 0a20 2020 2020 2020 2020 2020  self.           
+000126b0: 2069 6620 666f 6c6c 6f77 6c69 6e6b 733a   if followlinks:
+000126c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000126d0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+000126e0: 2020 2020 2020 2020 2020 7061 7468 5f69            path_i
+000126f0: 6e73 7461 6e63 6520 3d20 7365 6c66 2e72  nstance = self.r
+00012700: 6561 646c 696e 6b28 290a 2020 2020 2020  eadlink().      
+00012710: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00012720: 2053 334e 6f74 414c 696e 6b45 7272 6f72   S3NotALinkError
+00012730: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012740: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
+00012750: 2020 2020 2020 2077 6974 6820 7061 7468         with path
+00012760: 5f69 6e73 7461 6e63 652e 6f70 656e 2827  _instance.open('
+00012770: 7262 2729 2061 7320 663a 0a20 2020 2020  rb') as f:.     
+00012780: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00012790: 6e20 6361 6c63 756c 6174 655f 6d64 3528  n calculate_md5(
+000127a0: 6629 0a20 2020 2020 2020 2072 6574 7572  f).        retur
+000127b0: 6e20 7374 6174 2e65 7874 7261 2e67 6574  n stat.extra.get
+000127c0: 2827 4554 6167 272c 2027 2729 5b31 3a2d  ('ETag', '')[1:-
+000127d0: 315d 0a0a 2020 2020 6465 6620 636f 7079  1]..    def copy
+000127e0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+000127f0: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
+00012800: 6473 745f 7572 6c3a 2050 6174 684c 696b  dst_url: PathLik
+00012810: 652c 0a20 2020 2020 2020 2020 2020 2066  e,.            f
+00012820: 6f6c 6c6f 776c 696e 6b73 3a20 626f 6f6c  ollowlinks: bool
+00012830: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+00012840: 2020 2020 2020 6361 6c6c 6261 636b 3a20        callback: 
+00012850: 4f70 7469 6f6e 616c 5b43 616c 6c61 626c  Optional[Callabl
+00012860: 655b 5b69 6e74 5d2c 204e 6f6e 655d 5d20  e[[int], None]] 
+00012870: 3d20 4e6f 6e65 2920 2d3e 204e 6f6e 653a  = None) -> None:
+00012880: 0a20 2020 2020 2020 2027 2727 2046 696c  .        ''' Fil
+00012890: 6520 636f 7079 206f 6e20 5333 0a20 2020  e copy on S3.   
+000128a0: 2020 2020 2043 6f70 7920 636f 6e74 656e       Copy conten
+000128b0: 7420 6f66 2066 696c 6520 6f6e 2060 7372  t of file on `sr
+000128c0: 635f 7061 7468 6020 746f 2060 6473 745f  c_path` to `dst_
+000128d0: 7061 7468 602e 0a20 2020 2020 2020 2049  path`..        I
+000128e0: 7427 7320 6361 6c6c 6572 2773 2072 6573  t's caller's res
+000128f0: 706f 6e73 6562 696c 6974 7920 746f 2065  ponsebility to e
+00012900: 6e73 7572 6520 7468 6520 7333 5f69 7366  nsure the s3_isf
+00012910: 696c 6528 7372 635f 7572 6c29 203d 3d20  ile(src_url) == 
+00012920: 5472 7565 0a0a 2020 2020 2020 2020 3a70  True..        :p
+00012930: 6172 616d 2064 7374 5f70 6174 683a 2054  aram dst_path: T
+00012940: 6172 6765 7420 6669 6c65 2070 6174 680a  arget file path.
+00012950: 2020 2020 2020 2020 3a70 6172 616d 2063          :param c
+00012960: 616c 6c62 6163 6b3a 2043 616c 6c65 6420  allback: Called 
+00012970: 7065 7269 6f64 6963 616c 6c79 2064 7572  periodically dur
+00012980: 696e 6720 636f 7079 2c20 616e 6420 7468  ing copy, and th
+00012990: 6520 696e 7075 7420 7061 7261 6d65 7465  e input paramete
+000129a0: 7220 6973 2074 6865 2064 6174 6120 7369  r is the data si
+000129b0: 7a65 2028 696e 2062 7974 6573 2920 6f66  ze (in bytes) of
+000129c0: 2063 6f70 7920 7369 6e63 6520 7468 6520   copy since the 
+000129d0: 6c61 7374 2063 616c 6c0a 2020 2020 2020  last call.      
+000129e0: 2020 2727 270a 2020 2020 2020 2020 7372    '''.        sr
+000129f0: 635f 7572 6c20 3d20 7365 6c66 2e70 6174  c_url = self.pat
+00012a00: 685f 7769 7468 5f70 726f 746f 636f 6c0a  h_with_protocol.
+00012a10: 2020 2020 2020 2020 7372 635f 6275 636b          src_buck
+00012a20: 6574 2c20 7372 635f 6b65 7920 3d20 7061  et, src_key = pa
+00012a30: 7273 655f 7333 5f75 726c 2873 7263 5f75  rse_s3_url(src_u
+00012a40: 726c 290a 2020 2020 2020 2020 6473 745f  rl).        dst_
+00012a50: 6275 636b 6574 2c20 6473 745f 6b65 7920  bucket, dst_key 
+00012a60: 3d20 7061 7273 655f 7333 5f75 726c 2864  = parse_s3_url(d
+00012a70: 7374 5f75 726c 290a 0a20 2020 2020 2020  st_url)..       
+00012a80: 2069 6620 6e6f 7420 7372 635f 6275 636b   if not src_buck
+00012a90: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
+00012aa0: 7261 6973 6520 5333 4275 636b 6574 4e6f  raise S3BucketNo
+00012ab0: 7446 6f75 6e64 4572 726f 7228 2745 6d70  tFoundError('Emp
+00012ac0: 7479 2062 7563 6b65 7420 6e61 6d65 3a20  ty bucket name: 
+00012ad0: 2572 2720 2520 7372 635f 7572 6c29 0a20  %r' % src_url). 
+00012ae0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+00012af0: 735f 6469 7228 293a 0a20 2020 2020 2020  s_dir():.       
+00012b00: 2020 2020 2072 6169 7365 2053 3349 7341       raise S3IsA
+00012b10: 4469 7265 6374 6f72 7945 7272 6f72 2827  DirectoryError('
+00012b20: 4973 2061 2064 6972 6563 746f 7279 3a20  Is a directory: 
+00012b30: 2572 2720 2520 7372 635f 7572 6c29 0a0a  %r' % src_url)..
+00012b40: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
+00012b50: 7374 5f62 7563 6b65 743a 0a20 2020 2020  st_bucket:.     
+00012b60: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
+00012b70: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
+00012b80: 6f72 2827 456d 7074 7920 6275 636b 6574  or('Empty bucket
+00012b90: 206e 616d 653a 2025 7227 2025 2064 7374   name: %r' % dst
+00012ba0: 5f75 726c 290a 2020 2020 2020 2020 6966  _url).        if
+00012bb0: 206e 6f74 2064 7374 5f6b 6579 206f 7220   not dst_key or 
+00012bc0: 6473 745f 6b65 792e 656e 6473 7769 7468  dst_key.endswith
+00012bd0: 2827 2f27 293a 0a20 2020 2020 2020 2020  ('/'):.         
+00012be0: 2020 2072 6169 7365 2053 3349 7341 4469     raise S3IsADi
+00012bf0: 7265 6374 6f72 7945 7272 6f72 2827 4973  rectoryError('Is
+00012c00: 2061 2064 6972 6563 746f 7279 3a20 2572   a directory: %r
+00012c10: 2720 2520 6473 745f 7572 6c29 0a0a 2020  ' % dst_url)..  
+00012c20: 2020 2020 2020 6966 2066 6f6c 6c6f 776c        if followl
+00012c30: 696e 6b73 3a0a 2020 2020 2020 2020 2020  inks:.          
+00012c40: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00012c50: 2020 2020 2020 2073 335f 7572 6c20 3d20         s3_url = 
+00012c60: 7365 6c66 2e72 6561 646c 696e 6b28 292e  self.readlink().
+00012c70: 7061 7468 0a20 2020 2020 2020 2020 2020  path.           
+00012c80: 2020 2020 2073 7263 5f62 7563 6b65 742c       src_bucket,
+00012c90: 2073 7263 5f6b 6579 203d 2070 6172 7365   src_key = parse
+00012ca0: 5f73 335f 7572 6c28 7333 5f75 726c 290a  _s3_url(s3_url).
+00012cb0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00012cc0: 7074 2053 334e 6f74 414c 696e 6b45 7272  pt S3NotALinkErr
+00012cd0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00012ce0: 2020 2020 7061 7373 0a0a 2020 2020 2020      pass..      
+00012cf0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00012d00: 2020 2073 656c 662e 5f63 6c69 656e 742e     self._client.
+00012d10: 636f 7079 280a 2020 2020 2020 2020 2020  copy(.          
+00012d20: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00012d30: 2020 2020 2020 2020 2020 2020 2742 7563              'Buc
+00012d40: 6b65 7427 3a20 7372 635f 6275 636b 6574  ket': src_bucket
+00012d50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012d60: 2020 2020 2020 274b 6579 273a 2073 7263        'Key': src
+00012d70: 5f6b 6579 2c0a 2020 2020 2020 2020 2020  _key,.          
+00012d80: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+00012d90: 2020 2020 2020 2020 2042 7563 6b65 743d           Bucket=
+00012da0: 6473 745f 6275 636b 6574 2c0a 2020 2020  dst_bucket,.    
+00012db0: 2020 2020 2020 2020 2020 2020 4b65 793d              Key=
+00012dc0: 6473 745f 6b65 792c 0a20 2020 2020 2020  dst_key,.       
+00012dd0: 2020 2020 2020 2020 2043 616c 6c62 6163           Callbac
+00012de0: 6b3d 6361 6c6c 6261 636b 290a 2020 2020  k=callback).    
+00012df0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00012e00: 7469 6f6e 2061 7320 6572 726f 723a 0a20  tion as error:. 
+00012e10: 2020 2020 2020 2020 2020 2065 7272 6f72             error
+00012e20: 203d 2074 7261 6e73 6c61 7465 5f73 335f   = translate_s3_
+00012e30: 6572 726f 7228 6572 726f 722c 2064 7374  error(error, dst
+00012e40: 5f75 726c 290a 2020 2020 2020 2020 2020  _url).          
+00012e50: 2020 2320 4572 726f 7220 6361 6e27 7420    # Error can't 
+00012e60: 6865 6c70 2074 656c 6c20 7768 6963 6820  help tell which 
+00012e70: 6973 2070 726f 626c 656d 6174 6963 0a20  is problematic. 
+00012e80: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00012e90: 696e 7374 616e 6365 2865 7272 6f72 2c20  instance(error, 
+00012ea0: 5333 4275 636b 6574 4e6f 7446 6f75 6e64  S3BucketNotFound
+00012eb0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00012ec0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00012ed0: 656c 662e 6861 7362 7563 6b65 7428 293a  elf.hasbucket():
+00012ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012ef0: 2020 2020 2072 6169 7365 2053 3342 7563       raise S3Buc
+00012f00: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
+00012f10: 2827 4e6f 2073 7563 6820 6275 636b 6574  ('No such bucket
+00012f20: 3a20 2572 2720 2520 7372 635f 7572 6c29  : %r' % src_url)
+00012f30: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00012f40: 6620 6973 696e 7374 616e 6365 2865 7272  f isinstance(err
+00012f50: 6f72 2c20 5333 4669 6c65 4e6f 7446 6f75  or, S3FileNotFou
+00012f60: 6e64 4572 726f 7229 3a0a 2020 2020 2020  ndError):.      
+00012f70: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00012f80: 2073 656c 662e 6973 5f66 696c 6528 293a   self.is_file():
+00012f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012fa0: 2020 2020 2072 6169 7365 2053 3346 696c       raise S3Fil
+00012fb0: 654e 6f74 466f 756e 6445 7272 6f72 2827  eNotFoundError('
+00012fc0: 4e6f 2073 7563 6820 6669 6c65 3a20 2572  No such file: %r
+00012fd0: 2720 2520 7372 635f 7572 6c29 0a20 2020  ' % src_url).   
+00012fe0: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
+00012ff0: 7272 6f72 0a0a 2020 2020 6465 6620 7379  rror..    def sy
+00013000: 6e63 2873 656c 662c 2064 7374 5f75 726c  nc(self, dst_url
+00013010: 3a20 5061 7468 4c69 6b65 2c20 666f 6c6c  : PathLike, foll
+00013020: 6f77 6c69 6e6b 733a 2062 6f6f 6c20 3d20  owlinks: bool = 
+00013030: 4661 6c73 6529 202d 3e20 4e6f 6e65 3a0a  False) -> None:.
+00013040: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+00013050: 2020 2020 436f 7079 2066 696c 652f 6469      Copy file/di
+00013060: 7265 6374 6f72 7920 6f6e 2073 7263 5f75  rectory on src_u
+00013070: 726c 2074 6f20 6473 745f 7572 6c0a 0a20  rl to dst_url.. 
+00013080: 2020 2020 2020 203a 7061 7261 6d20 6473         :param ds
+00013090: 745f 7572 6c3a 2047 6976 656e 2064 6573  t_url: Given des
+000130a0: 7469 6e61 7469 6f6e 2070 6174 680a 2020  tination path.  
+000130b0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+000130c0: 2020 666f 7220 7372 635f 6669 6c65 5f70    for src_file_p
+000130d0: 6174 682c 2064 7374 5f66 696c 655f 7061  ath, dst_file_pa
+000130e0: 7468 2069 6e20 5f73 335f 7363 616e 5f70  th in _s3_scan_p
+000130f0: 6169 7273 280a 2020 2020 2020 2020 2020  airs(.          
+00013100: 2020 2020 2020 7365 6c66 2e70 6174 685f        self.path_
+00013110: 7769 7468 5f70 726f 746f 636f 6c2c 2064  with_protocol, d
+00013120: 7374 5f75 726c 293a 0a20 2020 2020 2020  st_url):.       
+00013130: 2020 2020 2073 7263 5f66 696c 655f 7061       src_file_pa
+00013140: 7468 203d 2073 656c 662e 6672 6f6d 5f70  th = self.from_p
+00013150: 6174 6828 7372 635f 6669 6c65 5f70 6174  ath(src_file_pat
+00013160: 6829 0a20 2020 2020 2020 2020 2020 2064  h).            d
+00013170: 7374 5f66 696c 655f 7061 7468 203d 2073  st_file_path = s
+00013180: 656c 662e 6672 6f6d 5f70 6174 6828 6473  elf.from_path(ds
+00013190: 745f 6669 6c65 5f70 6174 6829 0a20 2020  t_file_path).   
+000131a0: 2020 2020 2020 2020 2069 6620 6473 745f           if dst_
+000131b0: 6669 6c65 5f70 6174 682e 6578 6973 7473  file_path.exists
+000131c0: 2829 2061 6e64 2069 735f 7361 6d65 5f66  () and is_same_f
+000131d0: 696c 6528 0a20 2020 2020 2020 2020 2020  ile(.           
+000131e0: 2020 2020 2020 2020 2073 7263 5f66 696c           src_fil
+000131f0: 655f 7061 7468 2e73 7461 7428 292c 2064  e_path.stat(), d
+00013200: 7374 5f66 696c 655f 7061 7468 2e73 7461  st_file_path.sta
+00013210: 7428 292c 2027 636f 7079 2729 3a0a 2020  t(), 'copy'):.  
+00013220: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00013230: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+00013240: 2020 2073 7263 5f66 696c 655f 7061 7468     src_file_path
+00013250: 2e63 6f70 7928 6473 745f 6669 6c65 5f70  .copy(dst_file_p
+00013260: 6174 682c 2066 6f6c 6c6f 776c 696e 6b73  ath, followlinks
+00013270: 3d66 6f6c 6c6f 776c 696e 6b73 290a 0a20  =followlinks).. 
+00013280: 2020 2064 6566 2073 796d 6c69 6e6b 2873     def symlink(s
+00013290: 656c 662c 2064 7374 5f70 6174 683a 2050  elf, dst_path: P
+000132a0: 6174 684c 696b 6529 202d 3e20 4e6f 6e65  athLike) -> None
+000132b0: 3a0a 2020 2020 2020 2020 2727 270a 2020  :.        '''.  
+000132c0: 2020 2020 2020 4372 6561 7465 2061 2073        Create a s
+000132d0: 796d 626f 6c69 6320 6c69 6e6b 2070 6f69  ymbolic link poi
+000132e0: 6e74 696e 6720 746f 2073 7263 5f70 6174  nting to src_pat
+000132f0: 6820 6e61 6d65 6420 6473 745f 7061 7468  h named dst_path
+00013300: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
+00013310: 6d20 6473 745f 7061 7468 3a20 4465 7369  m dst_path: Desi
+00013320: 6e61 7469 6f6e 2070 6174 680a 2020 2020  nation path.    
+00013330: 2020 2020 3a72 6169 7365 733a 2053 334e      :raises: S3N
+00013340: 616d 6554 6f6f 4c6f 6e67 4572 726f 722c  ameTooLongError,
+00013350: 2053 3342 7563 6b65 744e 6f74 466f 756e   S3BucketNotFoun
+00013360: 6445 7272 6f72 2c20 5333 4973 4144 6972  dError, S3IsADir
+00013370: 6563 746f 7279 4572 726f 720a 2020 2020  ectoryError.    
+00013380: 2020 2020 2727 270a 2020 2020 2020 2020      '''.        
+00013390: 6966 206c 656e 2873 7472 2873 656c 662e  if len(str(self.
+000133a0: 5f73 335f 7061 7468 292e 656e 636f 6465  _s3_path).encode
+000133b0: 2829 2920 3e20 3130 3234 3a0a 2020 2020  ()) > 1024:.    
+000133c0: 2020 2020 2020 2020 7261 6973 6520 5333          raise S3
+000133d0: 4e61 6d65 546f 6f4c 6f6e 6745 7272 6f72  NameTooLongError
+000133e0: 2827 4669 6c65 206e 616d 6520 746f 6f20  ('File name too 
+000133f0: 6c6f 6e67 3a20 2572 2720 2520 6473 745f  long: %r' % dst_
+00013400: 7061 7468 290a 2020 2020 2020 2020 7372  path).        sr
+00013410: 635f 6275 636b 6574 2c20 7372 635f 6b65  c_bucket, src_ke
+00013420: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+00013430: 2873 656c 662e 7061 7468 5f77 6974 685f  (self.path_with_
+00013440: 7072 6f74 6f63 6f6c 290a 2020 2020 2020  protocol).      
+00013450: 2020 6473 745f 6275 636b 6574 2c20 6473    dst_bucket, ds
+00013460: 745f 6b65 7920 3d20 7061 7273 655f 7333  t_key = parse_s3
+00013470: 5f75 726c 2864 7374 5f70 6174 6829 0a0a  _url(dst_path)..
+00013480: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00013490: 7263 5f62 7563 6b65 743a 0a20 2020 2020  rc_bucket:.     
+000134a0: 2020 2020 2020 2072 6169 7365 2053 3342         raise S3B
+000134b0: 7563 6b65 744e 6f74 466f 756e 6445 7272  ucketNotFoundErr
+000134c0: 6f72 2827 456d 7074 7920 6275 636b 6574  or('Empty bucket
+000134d0: 206e 616d 653a 2025 7227 2025 2073 656c   name: %r' % sel
+000134e0: 662e 7061 7468 290a 2020 2020 2020 2020  f.path).        
+000134f0: 6966 206e 6f74 2064 7374 5f62 7563 6b65  if not dst_bucke
+00013500: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00013510: 6169 7365 2053 3342 7563 6b65 744e 6f74  aise S3BucketNot
+00013520: 466f 756e 6445 7272 6f72 2827 456d 7074  FoundError('Empt
+00013530: 7920 6275 636b 6574 206e 616d 653a 2025  y bucket name: %
+00013540: 7227 2025 2064 7374 5f70 6174 6829 0a20  r' % dst_path). 
+00013550: 2020 2020 2020 2069 6620 6e6f 7420 6473         if not ds
+00013560: 745f 6b65 7920 6f72 2064 7374 5f6b 6579  t_key or dst_key
+00013570: 2e65 6e64 7377 6974 6828 272f 2729 3a0a  .endswith('/'):.
+00013580: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00013590: 6520 5333 4973 4144 6972 6563 746f 7279  e S3IsADirectory
+000135a0: 4572 726f 7228 2749 7320 6120 6469 7265  Error('Is a dire
+000135b0: 6374 6f72 793a 2025 7227 2025 2064 7374  ctory: %r' % dst
+000135c0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+000135d0: 7372 635f 7061 7468 203d 2073 656c 662e  src_path = self.
+000135e0: 5f73 335f 7061 7468 0a20 2020 2020 2020  _s3_path.       
+000135f0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00013600: 2020 7372 635f 7061 7468 203d 2073 656c    src_path = sel
+00013610: 662e 7265 6164 6c69 6e6b 2829 2e5f 7333  f.readlink()._s3
+00013620: 5f70 6174 680a 2020 2020 2020 2020 6578  _path.        ex
+00013630: 6365 7074 2053 334e 6f74 414c 696e 6b45  cept S3NotALinkE
+00013640: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00013650: 2020 7061 7373 0a20 2020 2020 2020 2077    pass.        w
+00013660: 6974 6820 7261 6973 655f 7333 5f65 7272  ith raise_s3_err
+00013670: 6f72 2864 7374 5f70 6174 6829 3a0a 2020  or(dst_path):.  
+00013680: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00013690: 636c 6965 6e74 2e70 7574 5f6f 626a 6563  client.put_objec
+000136a0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+000136b0: 2020 2042 7563 6b65 743d 6473 745f 6275     Bucket=dst_bu
+000136c0: 636b 6574 2c0a 2020 2020 2020 2020 2020  cket,.          
+000136d0: 2020 2020 2020 4b65 793d 6473 745f 6b65        Key=dst_ke
+000136e0: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+000136f0: 2020 204d 6574 6164 6174 613d 7b22 7379     Metadata={"sy
+00013700: 6d6c 696e 6b5f 746f 223a 2073 7263 5f70  mlink_to": src_p
+00013710: 6174 687d 290a 0a20 2020 2064 6566 2072  ath})..    def r
+00013720: 6561 646c 696e 6b28 7365 6c66 2920 2d3e  eadlink(self) ->
+00013730: 2027 5333 5061 7468 273a 0a20 2020 2020   'S3Path':.     
+00013740: 2020 2027 2727 0a20 2020 2020 2020 2052     '''.        R
+00013750: 6574 7572 6e20 6120 5333 5061 7468 2069  eturn a S3Path i
+00013760: 6e73 7461 6e63 6520 7265 7072 6573 656e  nstance represen
+00013770: 7469 6e67 2074 6865 2070 6174 6820 746f  ting the path to
+00013780: 2077 6869 6368 2074 6865 2073 796d 626f   which the symbo
+00013790: 6c69 6320 6c69 6e6b 2070 6f69 6e74 732e  lic link points.
+000137a0: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+000137b0: 6e73 3a20 5265 7475 726e 2061 2053 3350  ns: Return a S3P
+000137c0: 6174 6820 696e 7374 616e 6365 2072 6570  ath instance rep
+000137d0: 7265 7365 6e74 696e 6720 7468 6520 7061  resenting the pa
+000137e0: 7468 2074 6f20 7768 6963 6820 7468 6520  th to which the 
+000137f0: 7379 6d62 6f6c 6963 206c 696e 6b20 706f  symbolic link po
+00013800: 696e 7473 2e0a 2020 2020 2020 2020 3a72  ints..        :r
+00013810: 6169 7365 733a 2053 334e 616d 6554 6f6f  aises: S3NameToo
+00013820: 4c6f 6e67 4572 726f 722c 2053 3342 7563  LongError, S3Buc
+00013830: 6b65 744e 6f74 466f 756e 6445 7272 6f72  ketNotFoundError
+00013840: 2c20 5333 4973 4144 6972 6563 746f 7279  , S3IsADirectory
+00013850: 4572 726f 722c 2053 334e 6f74 414c 696e  Error, S3NotALin
+00013860: 6b45 7272 6f72 0a20 2020 2020 2020 2027  kError.        '
+00013870: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
+00013880: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+00013890: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
+000138a0: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+000138b0: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
+000138c0: 636b 6574 3a0a 2020 2020 2020 2020 2020  cket:.          
+000138d0: 2020 7261 6973 6520 5333 4275 636b 6574    raise S3Bucket
+000138e0: 4e6f 7446 6f75 6e64 4572 726f 7228 0a20  NotFoundError(. 
+000138f0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00013900: 456d 7074 7920 6275 636b 6574 206e 616d  Empty bucket nam
+00013910: 653a 2025 7227 2025 2073 656c 662e 7061  e: %r' % self.pa
+00013920: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+00013930: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00013940: 206b 6579 206f 7220 6b65 792e 656e 6473   key or key.ends
+00013950: 7769 7468 2827 2f27 293a 0a20 2020 2020  with('/'):.     
+00013960: 2020 2020 2020 2072 6169 7365 2053 3349         raise S3I
+00013970: 7341 4469 7265 6374 6f72 7945 7272 6f72  sADirectoryError
+00013980: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00013990: 2020 2749 7320 6120 6469 7265 6374 6f72    'Is a director
+000139a0: 793a 2025 7227 2025 2073 656c 662e 7061  y: %r' % self.pa
+000139b0: 7468 5f77 6974 685f 7072 6f74 6f63 6f6c  th_with_protocol
+000139c0: 290a 2020 2020 2020 2020 6d65 7461 6461  ).        metada
+000139d0: 7461 203d 2073 656c 662e 5f73 335f 6765  ta = self._s3_ge
+000139e0: 745f 6d65 7461 6461 7461 2829 0a0a 2020  t_metadata()..  
+000139f0: 2020 2020 2020 6966 206e 6f74 2027 7379        if not 'sy
+00013a00: 6d6c 696e 6b5f 746f 2720 696e 206d 6574  mlink_to' in met
+00013a10: 6164 6174 613a 0a20 2020 2020 2020 2020  adata:.         
+00013a20: 2020 2072 6169 7365 2053 334e 6f74 414c     raise S3NotAL
+00013a30: 696e 6b45 7272 6f72 2827 4e6f 7420 6120  inkError('Not a 
+00013a40: 6c69 6e6b 3a20 2572 2720 2520 7365 6c66  link: %r' % self
+00013a50: 2e70 6174 685f 7769 7468 5f70 726f 746f  .path_with_proto
+00013a60: 636f 6c29 0a20 2020 2020 2020 2065 6c73  col).        els
+00013a70: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00013a80: 6574 7572 6e20 7365 6c66 2e66 726f 6d5f  eturn self.from_
+00013a90: 7061 7468 286d 6574 6164 6174 615b 2773  path(metadata['s
+00013aa0: 796d 6c69 6e6b 5f74 6f27 5d29 0a0a 2020  ymlink_to'])..  
+00013ab0: 2020 6465 6620 6973 5f73 796d 6c69 6e6b    def is_symlink
+00013ac0: 2873 656c 6629 202d 3e20 626f 6f6c 3a0a  (self) -> bool:.
+00013ad0: 2020 2020 2020 2020 2727 270a 2020 2020          '''.    
+00013ae0: 2020 2020 5465 7374 2077 6865 7468 6572      Test whether
+00013af0: 2061 2070 6174 6820 6973 206c 696e 6b0a   a path is link.
+00013b00: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+00013b10: 733a 2054 7275 6520 6966 2061 2070 6174  s: True if a pat
+00013b20: 6820 6973 206c 696e 6b2c 2065 6c73 6520  h is link, else 
+00013b30: 4661 6c73 650a 2020 2020 2020 2020 3a72  False.        :r
+00013b40: 6169 7365 733a 2053 334e 6f74 414c 696e  aises: S3NotALin
+00013b50: 6b45 7272 6f72 0a20 2020 2020 2020 2027  kError.        '
+00013b60: 2727 0a20 2020 2020 2020 2062 7563 6b65  ''.        bucke
+00013b70: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+00013b80: 335f 7572 6c28 7365 6c66 2e70 6174 685f  3_url(self.path_
+00013b90: 7769 7468 5f70 726f 746f 636f 6c29 0a20  with_protocol). 
+00013ba0: 2020 2020 2020 2069 6620 6e6f 7420 6275         if not bu
+00013bb0: 636b 6574 3a0a 2020 2020 2020 2020 2020  cket:.          
+00013bc0: 2020 7265 7475 726e 2046 616c 7365 0a20    return False. 
+00013bd0: 2020 2020 2020 2069 6620 6e6f 7420 6b65         if not ke
+00013be0: 7920 6f72 206b 6579 2e65 6e64 7377 6974  y or key.endswit
+00013bf0: 6828 272f 2729 3a0a 2020 2020 2020 2020  h('/'):.        
+00013c00: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+00013c10: 0a20 2020 2020 2020 206d 6574 6164 6174  .        metadat
+00013c20: 6120 3d20 7365 6c66 2e5f 7333 5f67 6574  a = self._s3_get
+00013c30: 5f6d 6574 6164 6174 6128 290a 2020 2020  _metadata().    
+00013c40: 2020 2020 7265 7475 726e 2027 7379 6d6c      return 'syml
+00013c50: 696e 6b5f 746f 2720 696e 206d 6574 6164  ink_to' in metad
+00013c60: 6174 610a 0a20 2020 2064 6566 2073 6176  ata..    def sav
+00013c70: 6528 7365 6c66 2c20 6669 6c65 5f6f 626a  e(self, file_obj
+00013c80: 6563 743a 2042 696e 6172 7949 4f29 3a0a  ect: BinaryIO):.
+00013c90: 2020 2020 2020 2020 2727 2757 7269 7465          '''Write
+00013ca0: 2074 6865 206f 7065 6e65 6420 6269 6e61   the opened bina
+00013cb0: 7279 2073 7472 6561 6d20 746f 2073 7065  ry stream to spe
+00013cc0: 6369 6669 6564 2070 6174 682c 2062 7574  cified path, but
+00013cd0: 2074 6865 2073 7472 6561 6d20 776f 6e27   the stream won'
+00013ce0: 7420 6265 2063 6c6f 7365 640a 0a20 2020  t be closed..   
+00013cf0: 2020 2020 203a 7061 7261 6d20 6669 6c65       :param file
+00013d00: 5f6f 626a 6563 743a 2053 7472 6561 6d20  _object: Stream 
+00013d10: 746f 2062 6520 7265 6164 0a20 2020 2020  to be read.     
+00013d20: 2020 2027 2727 0a20 2020 2020 2020 2062     '''.        b
+00013d30: 7563 6b65 742c 206b 6579 203d 2070 6172  ucket, key = par
+00013d40: 7365 5f73 335f 7572 6c28 7365 6c66 2e70  se_s3_url(self.p
+00013d50: 6174 685f 7769 7468 5f70 726f 746f 636f  ath_with_protoco
+00013d60: 6c29 0a20 2020 2020 2020 2069 6620 6e6f  l).        if no
+00013d70: 7420 6275 636b 6574 3a0a 2020 2020 2020  t bucket:.      
+00013d80: 2020 2020 2020 7261 6973 6520 5333 4275        raise S3Bu
+00013d90: 636b 6574 4e6f 7446 6f75 6e64 4572 726f  cketNotFoundErro
+00013da0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00013db0: 2020 2027 456d 7074 7920 6275 636b 6574     'Empty bucket
+00013dc0: 206e 616d 653a 2025 7227 2025 2073 656c   name: %r' % sel
+00013dd0: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+00013de0: 6f63 6f6c 290a 2020 2020 2020 2020 6966  ocol).        if
+00013df0: 206e 6f74 206b 6579 206f 7220 6b65 792e   not key or key.
+00013e00: 656e 6473 7769 7468 2827 2f27 293a 0a20  endswith('/'):. 
+00013e10: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00013e20: 2053 3349 7341 4469 7265 6374 6f72 7945   S3IsADirectoryE
+00013e30: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00013e40: 2020 2020 2020 2749 7320 6120 6469 7265        'Is a dire
+00013e50: 6374 6f72 793a 2025 7227 2025 2073 656c  ctory: %r' % sel
+00013e60: 662e 7061 7468 5f77 6974 685f 7072 6f74  f.path_with_prot
+00013e70: 6f63 6f6c 290a 0a20 2020 2020 2020 2077  ocol)..        w
+00013e80: 6974 6820 7261 6973 655f 7333 5f65 7272  ith raise_s3_err
+00013e90: 6f72 2873 656c 662e 7061 7468 5f77 6974  or(self.path_wit
+00013ea0: 685f 7072 6f74 6f63 6f6c 293a 0a20 2020  h_protocol):.   
+00013eb0: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
+00013ec0: 6c69 656e 742e 7570 6c6f 6164 5f66 696c  lient.upload_fil
+00013ed0: 656f 626a 2866 696c 655f 6f62 6a65 6374  eobj(file_object
+00013ee0: 2c20 4275 636b 6574 3d62 7563 6b65 742c  , Bucket=bucket,
+00013ef0: 204b 6579 3d6b 6579 290a 0a20 2020 2064   Key=key)..    d
+00013f00: 6566 206f 7065 6e28 0a20 2020 2020 2020  ef open(.       
+00013f10: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00013f20: 2020 2020 2020 206d 6f64 653a 2073 7472         mode: str
+00013f30: 203d 2027 7227 2c0a 2020 2020 2020 2020   = 'r',.        
+00013f40: 2020 2020 2a2c 0a20 2020 2020 2020 2020      *,.         
+00013f50: 2020 2073 335f 6f70 656e 5f66 756e 633a     s3_open_func:
+00013f60: 2043 616c 6c61 626c 655b 5b73 7472 2c20   Callable[[str, 
+00013f70: 7374 725d 2c20 4269 6e61 7279 494f 5d20  str], BinaryIO] 
+00013f80: 3d20 7333 5f6f 7065 6e2c 0a20 2020 2020  = s3_open,.     
+00013f90: 2020 2020 2020 202a 2a6b 7761 7267 7329         **kwargs)
+00013fa0: 202d 3e20 494f 5b41 6e79 5374 725d 3a20   -> IO[AnyStr]: 
+00013fb0: 2023 2070 7974 7970 653a 2064 6973 6162   # pytype: disab
+00013fc0: 6c65 3d73 6967 6e61 7475 7265 2d6d 6973  le=signature-mis
+00013fd0: 6d61 7463 680a 2020 2020 2020 2020 7265  match.        re
+00013fe0: 7475 726e 2073 335f 6f70 656e 5f66 756e  turn s3_open_fun
+00013ff0: 6328 0a20 2020 2020 2020 2020 2020 2073  c(.            s
+00014000: 656c 662e 7061 7468 5f77 6974 685f 7072  elf.path_with_pr
+00014010: 6f74 6f63 6f6c 2c20 6d6f 6465 2c0a 2020  otocol, mode,.  
+00014020: 2020 2020 2020 2020 2020 2a2a 6e65 6365            **nece
+00014030: 7373 6172 795f 7061 7261 6d73 2873 335f  ssary_params(s3_
+00014040: 6f70 656e 5f66 756e 632c 202a 2a6b 7761  open_func, **kwa
+00014050: 7267 7329 290a 0a20 2020 2064 6566 2061  rgs))..    def a
+00014060: 6273 6f6c 7574 6528 7365 6c66 2920 2d3e  bsolute(self) ->
+00014070: 2027 5333 5061 7468 273a 0a20 2020 2020   'S3Path':.     
+00014080: 2020 2027 2727 0a20 2020 2020 2020 204d     '''.        M
+00014090: 616b 6520 7468 6520 7061 7468 2061 6273  ake the path abs
+000140a0: 6f6c 7574 652c 2077 6974 686f 7574 206e  olute, without n
+000140b0: 6f72 6d61 6c69 7a61 7469 6f6e 206f 7220  ormalization or 
+000140c0: 7265 736f 6c76 696e 6720 7379 6d6c 696e  resolving symlin
+000140d0: 6b73 2e20 5265 7475 726e 7320 6120 6e65  ks. Returns a ne
+000140e0: 7720 7061 7468 206f 626a 6563 740a 2020  w path object.  
+000140f0: 2020 2020 2020 2727 270a 2020 2020 2020        '''.      
+00014100: 2020 7265 7475 726e 2073 656c 660a 0a20    return self.. 
+00014110: 2020 2064 6566 2063 7764 2873 656c 6629     def cwd(self)
+00014120: 202d 3e20 2753 3350 6174 6827 3a0a 2020   -> 'S3Path':.  
+00014130: 2020 2020 2020 2727 2752 6574 7572 6e20        '''Return 
+00014140: 6375 7272 656e 7420 776f 726b 696e 6720  current working 
+00014150: 6469 7265 6374 6f72 790a 0a20 2020 2020  directory..     
+00014160: 2020 2072 6574 7572 6e73 3a20 4375 7272     returns: Curr
+00014170: 656e 7420 776f 726b 696e 6720 6469 7265  ent working dire
+00014180: 6374 6f72 790a 2020 2020 2020 2020 2727  ctory.        ''
+00014190: 270a 2020 2020 2020 2020 7265 7475 726e  '.        return
+000141a0: 2073 656c 662e 6672 6f6d 5f70 6174 6828   self.from_path(
+000141b0: 7365 6c66 2e70 6174 685f 7769 7468 5f70  self.path_with_p
+000141c0: 726f 746f 636f 6c29 0a0a 0a63 6c61 7373  rotocol)...class
+000141d0: 204d 756c 7469 5061 7274 5772 6974 6572   MultiPartWriter
+000141e0: 3a0a 0a20 2020 2064 6566 205f 5f69 6e69  :..    def __ini
+000141f0: 745f 5f28 7365 6c66 2c20 636c 6965 6e74  t__(self, client
+00014200: 2c20 7061 7468 3a20 5061 7468 4c69 6b65  , path: PathLike
+00014210: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00014220: 2020 2073 656c 662e 5f63 6c69 656e 7420     self._client 
+00014230: 3d20 636c 6965 6e74 0a20 2020 2020 2020  = client.       
+00014240: 2073 656c 662e 5f6d 756c 7469 7061 7274   self._multipart
+00014250: 5f75 706c 6f61 645f 696e 666f 203d 205b  _upload_info = [
+00014260: 5d0a 0a20 2020 2020 2020 2062 7563 6b65  ]..        bucke
+00014270: 742c 206b 6579 203d 2070 6172 7365 5f73  t, key = parse_s
+00014280: 335f 7572 6c28 7061 7468 290a 2020 2020  3_url(path).    
+00014290: 2020 2020 7365 6c66 2e5f 6275 636b 6574      self._bucket
+000142a0: 203d 2062 7563 6b65 740a 2020 2020 2020   = bucket.      
+000142b0: 2020 7365 6c66 2e5f 6b65 7920 3d20 6b65    self._key = ke
+000142c0: 790a 2020 2020 2020 2020 7365 6c66 2e5f  y.        self._
+000142d0: 7570 6c6f 6164 5f69 6420 3d20 7365 6c66  upload_id = self
+000142e0: 2e5f 636c 6965 6e74 2e63 7265 6174 655f  ._client.create_
+000142f0: 6d75 6c74 6970 6172 745f 7570 6c6f 6164  multipart_upload
+00014300: 280a 2020 2020 2020 2020 2020 2020 4275  (.            Bu
+00014310: 636b 6574 3d73 656c 662e 5f62 7563 6b65  cket=self._bucke
+00014320: 742c 204b 6579 3d73 656c 662e 5f6b 6579  t, Key=self._key
+00014330: 295b 2755 706c 6f61 6449 6427 5d0a 0a20  )['UploadId'].. 
+00014340: 2020 2064 6566 2075 706c 6f61 645f 7061     def upload_pa
+00014350: 7274 2873 656c 662c 2070 6172 745f 6e75  rt(self, part_nu
+00014360: 6d3a 2069 6e74 2c20 6669 6c65 5f6f 626a  m: int, file_obj
+00014370: 3a20 696f 2e42 7974 6573 494f 2920 2d3e  : io.BytesIO) ->
+00014380: 204e 6f6e 653a 0a20 2020 2020 2020 2072   None:.        r
+00014390: 6573 706f 6e73 6520 3d20 7365 6c66 2e5f  esponse = self._
+000143a0: 636c 6965 6e74 2e75 706c 6f61 645f 7061  client.upload_pa
+000143b0: 7274 280a 2020 2020 2020 2020 2020 2020  rt(.            
+000143c0: 426f 6479 3d66 696c 655f 6f62 6a2c 0a20  Body=file_obj,. 
+000143d0: 2020 2020 2020 2020 2020 2055 706c 6f61             Uploa
+000143e0: 6449 643d 7365 6c66 2e5f 7570 6c6f 6164  dId=self._upload
+000143f0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+00014400: 2050 6172 744e 756d 6265 723d 7061 7274   PartNumber=part
+00014410: 5f6e 756d 2c0a 2020 2020 2020 2020 2020  _num,.          
+00014420: 2020 4275 636b 6574 3d73 656c 662e 5f62    Bucket=self._b
+00014430: 7563 6b65 742c 0a20 2020 2020 2020 2020  ucket,.         
+00014440: 2020 204b 6579 3d73 656c 662e 5f6b 6579     Key=self._key
+00014450: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00014460: 2020 2020 7365 6c66 2e5f 6d75 6c74 6970      self._multip
+00014470: 6172 745f 7570 6c6f 6164 5f69 6e66 6f2e  art_upload_info.
+00014480: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
+00014490: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000144a0: 2020 2020 2020 2750 6172 744e 756d 6265        'PartNumbe
+000144b0: 7227 3a20 7061 7274 5f6e 756d 2c0a 2020  r': part_num,.  
+000144c0: 2020 2020 2020 2020 2020 2020 2020 2745                'E
+000144d0: 5461 6727 3a20 7265 7370 6f6e 7365 5b27  Tag': response['
+000144e0: 4554 6167 275d 0a20 2020 2020 2020 2020  ETag'].         
+000144f0: 2020 207d 290a 0a20 2020 2064 6566 2075     })..    def u
+00014500: 706c 6f61 645f 7061 7274 5f62 795f 7061  pload_part_by_pa
+00014510: 7468 7328 0a20 2020 2020 2020 2020 2020  ths(.           
+00014520: 2073 656c 662c 2070 6172 745f 6e75 6d3a   self, part_num:
+00014530: 2069 6e74 2c20 7061 7468 733a 204c 6973   int, paths: Lis
+00014540: 745b 5475 706c 655b 5061 7468 4c69 6b65  t[Tuple[PathLike
+00014550: 2c20 7374 725d 5d29 202d 3e20 4e6f 6e65  , str]]) -> None
+00014560: 3a0a 2020 2020 2020 2020 6669 6c65 5f6f  :.        file_o
+00014570: 626a 203d 2069 6f2e 4279 7465 7349 4f28  bj = io.BytesIO(
+00014580: 290a 2020 2020 2020 2020 666f 7220 7061  ).        for pa
+00014590: 7468 2c20 6279 7465 735f 7261 6e67 6520  th, bytes_range 
+000145a0: 696e 2070 6174 6873 3a0a 2020 2020 2020  in paths:.      
+000145b0: 2020 2020 2020 6275 636b 6574 2c20 6b65        bucket, ke
+000145c0: 7920 3d20 7061 7273 655f 7333 5f75 726c  y = parse_s3_url
+000145d0: 2870 6174 6829 0a20 2020 2020 2020 2020  (path).         
+000145e0: 2020 2069 6620 6279 7465 735f 7261 6e67     if bytes_rang
+000145f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00014600: 2020 2066 696c 655f 6f62 6a2e 7772 6974     file_obj.writ
+00014610: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00014620: 2020 2020 2020 2073 656c 662e 5f63 6c69         self._cli
+00014630: 656e 742e 6765 745f 6f62 6a65 6374 280a  ent.get_object(.
 00014640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014650: 4275 636b 6574 3d62 7563 6b65 742c 204b  Bucket=bucket, K
-00014660: 6579 3d6b 6579 2c0a 2020 2020 2020 2020  ey=key,.        
+00014650: 2020 2020 2020 2020 4275 636b 6574 3d62          Bucket=b
+00014660: 7563 6b65 742c 204b 6579 3d6b 6579 2c0a  ucket, Key=key,.
 00014670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014680: 5261 6e67 653d 6279 7465 735f 7261 6e67  Range=bytes_rang
-00014690: 6529 5b27 426f 6479 275d 2e72 6561 6428  e)['Body'].read(
-000146a0: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
-000146b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000146c0: 2020 2020 2066 696c 655f 6f62 6a2e 7772       file_obj.wr
-000146d0: 6974 6528 0a20 2020 2020 2020 2020 2020  ite(.           
-000146e0: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
-000146f0: 6c69 656e 742e 6765 745f 6f62 6a65 6374  lient.get_object
-00014700: 2842 7563 6b65 743d 6275 636b 6574 2c0a  (Bucket=bucket,.
-00014710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014680: 2020 2020 2020 2020 5261 6e67 653d 6279          Range=by
+00014690: 7465 735f 7261 6e67 6529 5b27 426f 6479  tes_range)['Body
+000146a0: 275d 2e72 6561 6428 2929 0a20 2020 2020  '].read()).     
+000146b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000146c0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+000146d0: 655f 6f62 6a2e 7772 6974 6528 0a20 2020  e_obj.write(.   
+000146e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000146f0: 2073 656c 662e 5f63 6c69 656e 742e 6765   self._client.ge
+00014700: 745f 6f62 6a65 6374 2842 7563 6b65 743d  t_object(Bucket=
+00014710: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
 00014720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014730: 2020 2020 2020 2020 2020 2020 4b65 793d              Key=
-00014740: 6b65 7929 5b27 426f 6479 275d 2e72 6561  key)['Body'].rea
-00014750: 6428 2929 0a20 2020 2020 2020 2066 696c  d()).        fil
-00014760: 655f 6f62 6a2e 7365 656b 2830 2c20 6f73  e_obj.seek(0, os
-00014770: 2e53 4545 4b5f 5345 5429 0a20 2020 2020  .SEEK_SET).     
-00014780: 2020 2073 656c 662e 7570 6c6f 6164 5f70     self.upload_p
-00014790: 6172 7428 7061 7274 5f6e 756d 2c20 6669  art(part_num, fi
-000147a0: 6c65 5f6f 626a 290a 0a20 2020 2064 6566  le_obj)..    def
-000147b0: 2075 706c 6f61 645f 7061 7274 5f63 6f70   upload_part_cop
-000147c0: 7928 0a20 2020 2020 2020 2020 2020 2073  y(.            s
-000147d0: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
-000147e0: 2070 6172 745f 6e75 6d3a 2069 6e74 2c0a   part_num: int,.
-000147f0: 2020 2020 2020 2020 2020 2020 7061 7468              path
-00014800: 3a20 5061 7468 4c69 6b65 2c0a 2020 2020  : PathLike,.    
-00014810: 2020 2020 2020 2020 636f 7079 5f73 6f75          copy_sou
-00014820: 7263 655f 7261 6e67 653a 204f 7074 696f  rce_range: Optio
-00014830: 6e61 6c5b 7374 725d 203d 204e 6f6e 6529  nal[str] = None)
-00014840: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00014850: 2020 6275 636b 6574 2c20 6b65 7920 3d20    bucket, key = 
-00014860: 7061 7273 655f 7333 5f75 726c 2870 6174  parse_s3_url(pat
-00014870: 6829 0a20 2020 2020 2020 2070 6172 616d  h).        param
-00014880: 7320 3d20 6469 6374 280a 2020 2020 2020  s = dict(.      
-00014890: 2020 2020 2020 5570 6c6f 6164 4964 3d73        UploadId=s
-000148a0: 656c 662e 5f75 706c 6f61 645f 6964 2c0a  elf._upload_id,.
-000148b0: 2020 2020 2020 2020 2020 2020 5061 7274              Part
-000148c0: 4e75 6d62 6572 3d70 6172 745f 6e75 6d2c  Number=part_num,
-000148d0: 0a20 2020 2020 2020 2020 2020 2043 6f70  .            Cop
-000148e0: 7953 6f75 7263 653d 7b0a 2020 2020 2020  ySource={.      
-000148f0: 2020 2020 2020 2020 2020 2742 7563 6b65            'Bucke
-00014900: 7427 3a20 6275 636b 6574 2c0a 2020 2020  t': bucket,.    
-00014910: 2020 2020 2020 2020 2020 2020 274b 6579              'Key
-00014920: 273a 206b 6579 0a20 2020 2020 2020 2020  ': key.         
-00014930: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-00014940: 2020 4275 636b 6574 3d73 656c 662e 5f62    Bucket=self._b
-00014950: 7563 6b65 742c 0a20 2020 2020 2020 2020  ucket,.         
-00014960: 2020 204b 6579 3d73 656c 662e 5f6b 6579     Key=self._key
-00014970: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00014980: 2020 2020 6966 2063 6f70 795f 736f 7572      if copy_sour
-00014990: 6365 5f72 616e 6765 3a0a 2020 2020 2020  ce_range:.      
-000149a0: 2020 2020 2020 7061 7261 6d73 5b27 436f        params['Co
-000149b0: 7079 536f 7572 6365 5261 6e67 6527 5d20  pySourceRange'] 
-000149c0: 3d20 636f 7079 5f73 6f75 7263 655f 7261  = copy_source_ra
-000149d0: 6e67 650a 2020 2020 2020 2020 7265 7370  nge.        resp
-000149e0: 6f6e 7365 203d 2073 656c 662e 5f63 6c69  onse = self._cli
-000149f0: 656e 742e 7570 6c6f 6164 5f70 6172 745f  ent.upload_part_
-00014a00: 636f 7079 282a 2a70 6172 616d 7329 0a20  copy(**params). 
-00014a10: 2020 2020 2020 2073 656c 662e 5f6d 756c         self._mul
-00014a20: 7469 7061 7274 5f75 706c 6f61 645f 696e  tipart_upload_in
-00014a30: 666f 2e61 7070 656e 6428 0a20 2020 2020  fo.append(.     
-00014a40: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00014a50: 2020 2020 2020 2020 2027 5061 7274 4e75           'PartNu
-00014a60: 6d62 6572 273a 2070 6172 745f 6e75 6d2c  mber': part_num,
-00014a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014a80: 2027 4554 6167 273a 2072 6573 706f 6e73   'ETag': respons
-00014a90: 655b 2743 6f70 7950 6172 7452 6573 756c  e['CopyPartResul
-00014aa0: 7427 5d5b 2745 5461 6727 5d0a 2020 2020  t']['ETag'].    
-00014ab0: 2020 2020 2020 2020 7d29 0a0a 2020 2020          })..    
-00014ac0: 6465 6620 636c 6f73 6528 7365 6c66 293a  def close(self):
-00014ad0: 0a20 2020 2020 2020 2073 656c 662e 5f6d  .        self._m
-00014ae0: 756c 7469 7061 7274 5f75 706c 6f61 645f  ultipart_upload_
-00014af0: 696e 666f 2e73 6f72 7428 6b65 793d 6c61  info.sort(key=la
-00014b00: 6d62 6461 2074 3a20 745b 2750 6172 744e  mbda t: t['PartN
-00014b10: 756d 6265 7227 5d29 0a20 2020 2020 2020  umber']).       
-00014b20: 2073 656c 662e 5f63 6c69 656e 742e 636f   self._client.co
-00014b30: 6d70 6c65 7465 5f6d 756c 7469 7061 7274  mplete_multipart
-00014b40: 5f75 706c 6f61 6428 0a20 2020 2020 2020  _upload(.       
-00014b50: 2020 2020 2055 706c 6f61 6449 643d 7365       UploadId=se
-00014b60: 6c66 2e5f 7570 6c6f 6164 5f69 642c 0a20  lf._upload_id,. 
-00014b70: 2020 2020 2020 2020 2020 2042 7563 6b65             Bucke
-00014b80: 743d 7365 6c66 2e5f 6275 636b 6574 2c0a  t=self._bucket,.
-00014b90: 2020 2020 2020 2020 2020 2020 4b65 793d              Key=
-00014ba0: 7365 6c66 2e5f 6b65 792c 0a20 2020 2020  self._key,.     
-00014bb0: 2020 2020 2020 204d 756c 7469 7061 7274         Multipart
-00014bc0: 5570 6c6f 6164 3d7b 2750 6172 7473 273a  Upload={'Parts':
-00014bd0: 2073 656c 662e 5f6d 756c 7469 7061 7274   self._multipart
-00014be0: 5f75 706c 6f61 645f 696e 666f 7d29 0a0a  _upload_info})..
-00014bf0: 2020 2020 6465 6620 5f5f 656e 7465 725f      def __enter_
-00014c00: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
-00014c10: 2072 6574 7572 6e20 7365 6c66 0a0a 2020   return self..  
-00014c20: 2020 6465 6620 5f5f 6578 6974 5f5f 2873    def __exit__(s
-00014c30: 656c 662c 2065 7863 5f74 7970 652c 2065  elf, exc_type, e
-00014c40: 7863 5f76 616c 2c20 6578 635f 7462 293a  xc_val, exc_tb):
-00014c50: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00014c60: 6f73 6528 290a                           ose().
+00014730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014740: 2020 2020 4b65 793d 6b65 7929 5b27 426f      Key=key)['Bo
+00014750: 6479 275d 2e72 6561 6428 2929 0a20 2020  dy'].read()).   
+00014760: 2020 2020 2066 696c 655f 6f62 6a2e 7365       file_obj.se
+00014770: 656b 2830 2c20 6f73 2e53 4545 4b5f 5345  ek(0, os.SEEK_SE
+00014780: 5429 0a20 2020 2020 2020 2073 656c 662e  T).        self.
+00014790: 7570 6c6f 6164 5f70 6172 7428 7061 7274  upload_part(part
+000147a0: 5f6e 756d 2c20 6669 6c65 5f6f 626a 290a  _num, file_obj).
+000147b0: 0a20 2020 2064 6566 2075 706c 6f61 645f  .    def upload_
+000147c0: 7061 7274 5f63 6f70 7928 0a20 2020 2020  part_copy(.     
+000147d0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+000147e0: 2020 2020 2020 2020 2070 6172 745f 6e75           part_nu
+000147f0: 6d3a 2069 6e74 2c0a 2020 2020 2020 2020  m: int,.        
+00014800: 2020 2020 7061 7468 3a20 5061 7468 4c69      path: PathLi
+00014810: 6b65 2c0a 2020 2020 2020 2020 2020 2020  ke,.            
+00014820: 636f 7079 5f73 6f75 7263 655f 7261 6e67  copy_source_rang
+00014830: 653a 204f 7074 696f 6e61 6c5b 7374 725d  e: Optional[str]
+00014840: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
+00014850: 3a0a 2020 2020 2020 2020 6275 636b 6574  :.        bucket
+00014860: 2c20 6b65 7920 3d20 7061 7273 655f 7333  , key = parse_s3
+00014870: 5f75 726c 2870 6174 6829 0a20 2020 2020  _url(path).     
+00014880: 2020 2070 6172 616d 7320 3d20 6469 6374     params = dict
+00014890: 280a 2020 2020 2020 2020 2020 2020 5570  (.            Up
+000148a0: 6c6f 6164 4964 3d73 656c 662e 5f75 706c  loadId=self._upl
+000148b0: 6f61 645f 6964 2c0a 2020 2020 2020 2020  oad_id,.        
+000148c0: 2020 2020 5061 7274 4e75 6d62 6572 3d70      PartNumber=p
+000148d0: 6172 745f 6e75 6d2c 0a20 2020 2020 2020  art_num,.       
+000148e0: 2020 2020 2043 6f70 7953 6f75 7263 653d       CopySource=
+000148f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00014900: 2020 2742 7563 6b65 7427 3a20 6275 636b    'Bucket': buck
+00014910: 6574 2c0a 2020 2020 2020 2020 2020 2020  et,.            
+00014920: 2020 2020 274b 6579 273a 206b 6579 0a20      'Key': key. 
+00014930: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00014940: 2020 2020 2020 2020 2020 4275 636b 6574            Bucket
+00014950: 3d73 656c 662e 5f62 7563 6b65 742c 0a20  =self._bucket,. 
+00014960: 2020 2020 2020 2020 2020 204b 6579 3d73             Key=s
+00014970: 656c 662e 5f6b 6579 2c0a 2020 2020 2020  elf._key,.      
+00014980: 2020 290a 2020 2020 2020 2020 6966 2063    ).        if c
+00014990: 6f70 795f 736f 7572 6365 5f72 616e 6765  opy_source_range
+000149a0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+000149b0: 7261 6d73 5b27 436f 7079 536f 7572 6365  rams['CopySource
+000149c0: 5261 6e67 6527 5d20 3d20 636f 7079 5f73  Range'] = copy_s
+000149d0: 6f75 7263 655f 7261 6e67 650a 2020 2020  ource_range.    
+000149e0: 2020 2020 7265 7370 6f6e 7365 203d 2073      response = s
+000149f0: 656c 662e 5f63 6c69 656e 742e 7570 6c6f  elf._client.uplo
+00014a00: 6164 5f70 6172 745f 636f 7079 282a 2a70  ad_part_copy(**p
+00014a10: 6172 616d 7329 0a20 2020 2020 2020 2073  arams).        s
+00014a20: 656c 662e 5f6d 756c 7469 7061 7274 5f75  elf._multipart_u
+00014a30: 706c 6f61 645f 696e 666f 2e61 7070 656e  pload_info.appen
+00014a40: 6428 0a20 2020 2020 2020 2020 2020 207b  d(.            {
+00014a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014a60: 2027 5061 7274 4e75 6d62 6572 273a 2070   'PartNumber': p
+00014a70: 6172 745f 6e75 6d2c 0a20 2020 2020 2020  art_num,.       
+00014a80: 2020 2020 2020 2020 2027 4554 6167 273a           'ETag':
+00014a90: 2072 6573 706f 6e73 655b 2743 6f70 7950   response['CopyP
+00014aa0: 6172 7452 6573 756c 7427 5d5b 2745 5461  artResult']['ETa
+00014ab0: 6727 5d0a 2020 2020 2020 2020 2020 2020  g'].            
+00014ac0: 7d29 0a0a 2020 2020 6465 6620 636c 6f73  })..    def clos
+00014ad0: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
+00014ae0: 2073 656c 662e 5f6d 756c 7469 7061 7274   self._multipart
+00014af0: 5f75 706c 6f61 645f 696e 666f 2e73 6f72  _upload_info.sor
+00014b00: 7428 6b65 793d 6c61 6d62 6461 2074 3a20  t(key=lambda t: 
+00014b10: 745b 2750 6172 744e 756d 6265 7227 5d29  t['PartNumber'])
+00014b20: 0a20 2020 2020 2020 2073 656c 662e 5f63  .        self._c
+00014b30: 6c69 656e 742e 636f 6d70 6c65 7465 5f6d  lient.complete_m
+00014b40: 756c 7469 7061 7274 5f75 706c 6f61 6428  ultipart_upload(
+00014b50: 0a20 2020 2020 2020 2020 2020 2055 706c  .            Upl
+00014b60: 6f61 6449 643d 7365 6c66 2e5f 7570 6c6f  oadId=self._uplo
+00014b70: 6164 5f69 642c 0a20 2020 2020 2020 2020  ad_id,.         
+00014b80: 2020 2042 7563 6b65 743d 7365 6c66 2e5f     Bucket=self._
+00014b90: 6275 636b 6574 2c0a 2020 2020 2020 2020  bucket,.        
+00014ba0: 2020 2020 4b65 793d 7365 6c66 2e5f 6b65      Key=self._ke
+00014bb0: 792c 0a20 2020 2020 2020 2020 2020 204d  y,.            M
+00014bc0: 756c 7469 7061 7274 5570 6c6f 6164 3d7b  ultipartUpload={
+00014bd0: 2750 6172 7473 273a 2073 656c 662e 5f6d  'Parts': self._m
+00014be0: 756c 7469 7061 7274 5f75 706c 6f61 645f  ultipart_upload_
+00014bf0: 696e 666f 7d29 0a0a 2020 2020 6465 6620  info})..    def 
+00014c00: 5f5f 656e 7465 725f 5f28 7365 6c66 293a  __enter__(self):
+00014c10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00014c20: 7365 6c66 0a0a 2020 2020 6465 6620 5f5f  self..    def __
+00014c30: 6578 6974 5f5f 2873 656c 662c 2065 7863  exit__(self, exc
+00014c40: 5f74 7970 652c 2065 7863 5f76 616c 2c20  _type, exc_val, 
+00014c50: 6578 635f 7462 293a 0a20 2020 2020 2020  exc_tb):.       
+00014c60: 2073 656c 662e 636c 6f73 6528 290a        self.close().
```

## megfile/smart_path.py

```diff
@@ -1,12 +1,12 @@
 from pathlib import PurePath
 from typing import Tuple, Union
-from urllib.parse import urlsplit
 
 from megfile.lib.compat import fspath
+from megfile.lib.url import get_url_scheme
 
 from .errors import ProtocolExistsError, ProtocolNotFoundError
 from .interfaces import BasePath, BaseURIPath, PathLike
 
 
 def _bind_function(name):
 
@@ -43,15 +43,15 @@
     @staticmethod
     def _extract_protocol(path: Union[PathLike, int]
                          ) -> Tuple[str, Union[str, int]]:
         if isinstance(path, int):
             protocol = "file"
             path_without_protocol = path
         elif isinstance(path, str):
-            protocol = urlsplit(path).scheme
+            protocol = get_url_scheme(path)
             if protocol == "":
                 protocol = "file"
                 path_without_protocol = path
             else:
                 path_without_protocol = path[len(protocol) + 3:]
         elif isinstance(path, (BaseURIPath, SmartPath)):
             protocol = path.protocol
```

## megfile/stdio_path.py

```diff
@@ -1,14 +1,14 @@
 import io
 from typing import IO, AnyStr, Union
-from urllib.parse import urlsplit
 
 from megfile.interfaces import BaseURIPath, PathLike
 from megfile.lib.compat import fspath
 from megfile.lib.stdio_handler import STDReader, STDWriter
+from megfile.lib.url import get_url_scheme
 from megfile.smart_path import SmartPath
 from megfile.utils import get_binary_mode
 
 __all__ = [
     "StdioPath",
     "is_stdio",
 ]
@@ -25,16 +25,16 @@
     :returns: True of a path is stdio url, else False
     '''
 
     path = fspath(path)
     if not isinstance(path, str) or not path.startswith('stdio://'):
         return False
 
-    parts = urlsplit(path)
-    return parts.scheme == 'stdio'
+    scheme = get_url_scheme(path)
+    return scheme == 'stdio'
 
 
 @SmartPath.register
 class StdioPath(BaseURIPath):
 
     protocol = "stdio"
```

## megfile/version.py

```diff
@@ -1 +1 @@
-VERSION = "2.0.6"
+VERSION = "2.0.6.post1"
```

## megfile/lib/glob.py

```diff
@@ -27,15 +27,15 @@
 
 
 def _isdir(path: str) -> bool:
     return os.path.isdir(path)
 
 
 def _scandir(dirname: str) -> Iterator[Tuple[str, bool]]:
-    for entry in os.scandir(dirname):
+    for entry in sorted(list(os.scandir(dirname)), key=lambda t: t.name):
         yield entry.name, entry.is_dir()
 
 
 DEFAULT_FILESYSTEM_FUNC = FSFunc(_exists, _isdir, _scandir)
 
 
 def glob(
```

## Comparing `megfile-2.0.6.dist-info/LICENSE` & `megfile-2.0.6.post1.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `megfile-2.0.6.dist-info/LICENSE.pyre` & `megfile-2.0.6.post1.dist-info/LICENSE.pyre`

 * *Files identical despite different names*

## Comparing `megfile-2.0.6.dist-info/METADATA` & `megfile-2.0.6.post1.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: megfile
-Version: 2.0.6
+Version: 2.0.6.post1
 Summary: Megvii file operation library
 Home-page: https://github.com/megvii-research/megfile
 Author: megvii
 Author-email: megfile@megvii.com
 Classifier: Development Status :: 4 - Beta
 Classifier: Environment :: Console
 Classifier: Intended Audience :: Developers
```

## Comparing `megfile-2.0.6.dist-info/RECORD` & `megfile-2.0.6.post1.dist-info/RECORD`

 * *Files 15% similar despite different names*

```diff
@@ -1,44 +1,45 @@
 megfile/__init__.py,sha256=wlijLJS6F8Vdm1xjpsjd9fKBeDGpgIMrVsXYSeOQ4Xw,5434
 megfile/cli.py,sha256=t299Wo9lA0EbZlS5k3tCxW19liCqY7-i7zbu8oHOwHo,10033
-megfile/errors.py,sha256=FE9mGMxnNFpsQdtNJWiL-BuZbPGbbx8es9eAo8osyio,11584
+megfile/errors.py,sha256=oYmKXD-nguj491hzaRlHfOsE_ENKIGEgSHjECwUHjY4,11686
 megfile/fs.py,sha256=sjkm_LsvNCw8hj9Ee-1HSNzvg7bRHTPem8KTDDBQlCw,11621
-megfile/fs_path.py,sha256=v-xjLTaGLAHdirnFk5R1ZkrObNh5p6cw8TiZwo-wNA8,38484
+megfile/fs_path.py,sha256=xadMpuqRCdr3CLFmRMg6lTlZfSvnPbc_Dql23NO24SU,38552
 megfile/http.py,sha256=EtyFazgenIhEvkwMpX6ga32POKUG21969Y2cRQbFn58,1852
-megfile/http_path.py,sha256=up1gB0Yk1a3ZbmHoJV-XWzOTiKh66hmm5p_Kzy3GMHo,4483
+megfile/http_path.py,sha256=nmmKLRM5I3SozEfX0m9BcHhSaq8LE4SLTTkBjvQnVEc,4487
 megfile/interfaces.py,sha256=h3tWE8hVt5S-HopaMAX6lunPJ97vzhv6jH_2HubcDNc,6219
 megfile/pathlike.py,sha256=52e6POtMfUCC3Hb9XNwBLXM3Gkz3aGP8H8AagGKlDSg,29307
 megfile/s3.py,sha256=hlXqQvZuXuDJbLjsrK23LD25cblThO9f-r78eWFsYZ8,12456
-megfile/s3_path.py,sha256=7QPS4ED9rdMM-o1EG2WQ08ZZBlJTRP8Zx4ROcQOtmrE,85094
+megfile/s3_path.py,sha256=C_0xCeuUIj7eMj-Fl-Kt-aM2YTDRAlT87daS8ZwYjvU,85102
 megfile/sftp.py,sha256=qzfgI-MGzNsr7adUQaiVKS7zRHGuK-Hs6o45wNIAcww,11943
 megfile/sftp_path.py,sha256=rO7HnJ91Jv849Ns3A4KX3IQTPOPUznL-p2Ycg0SiYnw,44039
 megfile/smart.py,sha256=l4orTpsYzwuNkg0mdS-gBy2_iZ8asL8UUhqMzztN2xQ,31952
-megfile/smart_path.py,sha256=T46uVOH-2nuLYMxLlI7No3RZdlmo04MaPY_wwgD0VUc,6700
+megfile/smart_path.py,sha256=Rwb1McXsshi9-F6miTRqE6j8FO2j1edjmSxZF32YZ6E,6708
 megfile/stdio.py,sha256=qmi1c7VTll6Y6ya9MCd-dSKffocX2GafA-YUncZRU1Y,559
-megfile/stdio_path.py,sha256=77P-SEFy5EONViTe-J7gK8ID9VkfACLvB-7WXrWry6s,2672
-megfile/version.py,sha256=s8Xos4yNZ4VhNGY1ms7-L2JZmKkSsSqdAGNaa3o2pMI,19
+megfile/stdio_path.py,sha256=ULMzGOj7SBMn3c7fYVSDepT_1nEUiVetc-xRt2pR5o4,2682
+megfile/version.py,sha256=_qcZEiLLfeioNA5CCIzOkmDuezgK12ue_3nyZYvL9qw,25
 megfile/lib/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 megfile/lib/combine_reader.py,sha256=TkjvYvM5ZBVCh3tA7cOmTe8dYZc_eI7XbpPhnzqaNvU,4580
 megfile/lib/compare.py,sha256=yG2fZve_gMg32rQVCdwixBdqgYRsjn-24TqhALQaOrA,2233
 megfile/lib/compat.py,sha256=QYIO6RkvfJ2ewdn9bP_17H_fhIlfnL9g-4RQnSt18zM,3053
 megfile/lib/fnmatch.py,sha256=HgdlnEWBsdFUOZqnW_v1kj1jeH_9lMcCqW85pyMu4vM,4054
-megfile/lib/glob.py,sha256=XOENsZS5aLJk1WDqDkBJl62CICxgarmqlKjCAWvixMg,9478
+megfile/lib/glob.py,sha256=OEa3_3sWP_nwgESj5m4XCdNWV44RQKwdB0im6A6haNI,9514
 megfile/lib/joinpath.py,sha256=D4Px6-lnDDpYs1LMUHkTIGqMPJQ0oCBGfTzREs373iU,929
 megfile/lib/lazy_handler.py,sha256=f1rip2_T57vVo0WRNXve2bAa4LArvVheMfQg1S0vFzg,1915
 megfile/lib/s3_buffered_writer.py,sha256=AGjCNQ1X16kjFbEJouavkO6ykmlAtfVKBPAD-yYwAT0,6934
 megfile/lib/s3_cached_handler.py,sha256=e4KamTLMIPKa96yp7HGF05wDl2Yfoizz9pBrz-uAQ5w,1322
 megfile/lib/s3_limited_seekable_writer.py,sha256=OEh_HCbxNt8hsF2Y5OAQ9puikvzDfNkzluHjXtThegg,6057
 megfile/lib/s3_memory_handler.py,sha256=jLBA5HVuI-UBPYMYN-B8iX_VGr8bC9brAqY-KbEGrtw,3725
 megfile/lib/s3_pipe_handler.py,sha256=6r0rmLQp6VlJ4ZpBAvurfkaY0-qxKIuNpi5wMe1sDJ4,3404
 megfile/lib/s3_prefetch_reader.py,sha256=zSd_gmpDtQCDA-Rrh7Nxh2WOb0Z8Q1QZZg1g7WO6JNg,15053
 megfile/lib/s3_share_cache_reader.py,sha256=q3MVEDUgOvalO7js6S_LWQ-eJS4xFHiio8ZoJZt40e4,3791
 megfile/lib/shadow_handler.py,sha256=IbFyTw107t-yWH0cGrDjAJX-CS3xeEr77_PTGsnSgk4,2683
 megfile/lib/stdio_handler.py,sha256=QDWtcZxz-hzi-rqQUiSlR3NrihX1fjK_Rj9T2mdTFEg,2044
+megfile/lib/url.py,sha256=VbQLjo0s4AaV0iSk66BcjI68aUTcN9zBZ5x6-cM4Qvs,103
 megfile/utils/__init__.py,sha256=gWplPIHzpSqV9AiQiRvUrBCkD737caNYyudsgwQBbKk,9025
 megfile/utils/mutex.py,sha256=BE16gbmZxr0RgU0ULaAFVDTZGwiOA-Jven-fDeG3ltQ,2461
-megfile-2.0.6.dist-info/LICENSE,sha256=WNHhf_5RCaeuKWyq_K39vmp9F28LxKsB4SpomwSZ2L0,11357
-megfile-2.0.6.dist-info/LICENSE.pyre,sha256=9lf5nT-5ZH25JijpYAequ0bl8E8z5JmZB1qrjiUMp84,1080
-megfile-2.0.6.dist-info/METADATA,sha256=QWeaFTr2FtUpphuJ-gS4hGDsWjDA8Lco2P4PSaluLgI,10154
-megfile-2.0.6.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-megfile-2.0.6.dist-info/entry_points.txt,sha256=M6ZWSSv5_5_QtIpZafy3vq7WuOJ_5dSGQQnEZbByt2Q,49
-megfile-2.0.6.dist-info/top_level.txt,sha256=i3rMgdU1ZAJekAceojhA-bkm3749PzshtRmLTbeLUPQ,8
-megfile-2.0.6.dist-info/RECORD,,
+megfile-2.0.6.post1.dist-info/LICENSE,sha256=WNHhf_5RCaeuKWyq_K39vmp9F28LxKsB4SpomwSZ2L0,11357
+megfile-2.0.6.post1.dist-info/LICENSE.pyre,sha256=9lf5nT-5ZH25JijpYAequ0bl8E8z5JmZB1qrjiUMp84,1080
+megfile-2.0.6.post1.dist-info/METADATA,sha256=y-7SUwxYATEnq348lFyV7TiHg354HVZABw-AHRgIxoU,10160
+megfile-2.0.6.post1.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+megfile-2.0.6.post1.dist-info/entry_points.txt,sha256=M6ZWSSv5_5_QtIpZafy3vq7WuOJ_5dSGQQnEZbByt2Q,49
+megfile-2.0.6.post1.dist-info/top_level.txt,sha256=i3rMgdU1ZAJekAceojhA-bkm3749PzshtRmLTbeLUPQ,8
+megfile-2.0.6.post1.dist-info/RECORD,,
```

