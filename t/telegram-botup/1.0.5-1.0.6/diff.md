# Comparing `tmp/telegram_botup-1.0.5-py3-none-any.whl.zip` & `tmp/telegram_botup-1.0.6-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,17 +1,18 @@
-Zip file size: 40774 bytes, number of entries: 45
+Zip file size: 41239 bytes, number of entries: 46
 -rw-rw-r--  2.0 unx      148 b- defN 23-Jun-15 18:16 botup/__init__.py
 -rw-rw-r--  2.0 unx    52937 b- defN 23-Jun-15 19:49 botup/api.py
--rw-rw-r--  2.0 unx      895 b- defN 23-Jun-15 17:57 botup/bot.py
+-rw-rw-r--  2.0 unx      867 b- defN 23-Jun-15 21:03 botup/bot.py
 -rw-rw-r--  2.0 unx    17610 b- defN 23-Jun-15 20:03 botup/dispatcher.py
+-rw-rw-r--  2.0 unx       52 b- defN 23-Jun-15 20:56 botup/exceptions.py
 -rw-rw-r--  2.0 unx     9824 b- defN 23-Jun-15 19:13 botup/handlers.py
--rw-rw-r--  2.0 unx     1266 b- defN 23-Jun-13 09:13 botup/navigation.py
+-rw-rw-r--  2.0 unx     1841 b- defN 23-Jun-15 21:07 botup/navigation.py
 -rw-rw-r--  2.0 unx    48224 b- defN 23-Jun-15 20:07 botup/types.py
 -rw-rw-r--  2.0 unx      505 b- defN 23-Jun-15 17:55 botup/utils.py
--rw-rw-r--  2.0 unx     1933 b- defN 23-Jun-15 17:57 botup/widget.py
+-rw-rw-r--  2.0 unx     2600 b- defN 23-Jun-15 20:58 botup/widget.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-Jun-13 09:53 botup/constants/__init__.py
 -rw-rw-r--  2.0 unx     5243 b- defN 23-Jun-13 08:57 botup/constants/api_method.py
 -rw-rw-r--  2.0 unx      115 b- defN 23-Jun-13 08:57 botup/constants/base.py
 -rw-rw-r--  2.0 unx      470 b- defN 23-Jun-13 08:57 botup/constants/bot_command_scope_type.py
 -rw-rw-r--  2.0 unx      562 b- defN 23-Jun-13 08:57 botup/constants/chat_action.py
 -rw-rw-r--  2.0 unx      322 b- defN 23-Jun-13 08:57 botup/constants/chat_member_status.py
 -rw-rw-r--  2.0 unx      200 b- defN 23-Jun-13 08:57 botup/constants/chat_type.py
@@ -29,19 +30,19 @@
 -rw-rw-r--  2.0 unx     1648 b- defN 23-Jun-15 19:10 botup/constants/update_type.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-Jun-13 09:53 botup/mixins/__init__.py
 -rw-rw-r--  2.0 unx      404 b- defN 23-Jun-15 18:02 botup/mixins/echo.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-Jun-13 09:53 botup/state_manager/__init__.py
 -rw-rw-r--  2.0 unx     2045 b- defN 23-Jun-13 08:57 botup/state_manager/base.py
 -rw-rw-r--  2.0 unx     1003 b- defN 23-Jun-15 18:22 botup/state_manager/redis.py
 -rw-rw-r--  2.0 unx        0 b- defN 23-Jun-13 09:53 botup/widgets/__init__.py
--rw-rw-r--  2.0 unx     8920 b- defN 23-Jun-15 18:02 botup/widgets/date_picker.py
+-rw-rw-r--  2.0 unx     9010 b- defN 23-Jun-15 21:03 botup/widgets/date_picker.py
 -rw-rw-r--  2.0 unx        0 b- defN 22-May-15 21:45 tests/__init__.py
 -rw-rw-r--  2.0 unx      114 b- defN 23-Jun-15 18:37 tests/conftest.py
 -rw-rw-r--  2.0 unx    33367 b- defN 23-Jun-15 19:15 tests/test_dispatcher.py
 -rw-rw-r--  2.0 unx    10847 b- defN 23-Jun-15 20:03 tests/test_dispatcher_decorator.py
 -rw-rw-r--  2.0 unx      609 b- defN 23-Jun-15 19:54 tests/test_serializing.py
 -rw-rw-r--  2.0 unx    43262 b- defN 23-Jun-15 19:29 tests/utils.py
--rw-rw-r--  2.0 unx     4441 b- defN 23-Jun-15 20:08 telegram_botup-1.0.5.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Jun-15 20:08 telegram_botup-1.0.5.dist-info/WHEEL
--rw-rw-r--  2.0 unx       12 b- defN 23-Jun-15 20:08 telegram_botup-1.0.5.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     3751 b- defN 23-Jun-15 20:08 telegram_botup-1.0.5.dist-info/RECORD
-45 files, 255122 bytes uncompressed, 34782 bytes compressed:  86.4%
+-rw-rw-r--  2.0 unx     3850 b- defN 23-Jun-16 12:19 telegram_botup-1.0.6.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Jun-16 12:19 telegram_botup-1.0.6.dist-info/WHEEL
+-rw-rw-r--  2.0 unx       12 b- defN 23-Jun-16 12:19 telegram_botup-1.0.6.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     3825 b- defN 23-Jun-16 12:19 telegram_botup-1.0.6.dist-info/RECORD
+46 files, 255961 bytes uncompressed, 35133 bytes compressed:  86.3%
```

## zipnote {}

```diff
@@ -6,14 +6,17 @@
 
 Filename: botup/bot.py
 Comment: 
 
 Filename: botup/dispatcher.py
 Comment: 
 
+Filename: botup/exceptions.py
+Comment: 
+
 Filename: botup/handlers.py
 Comment: 
 
 Filename: botup/navigation.py
 Comment: 
 
 Filename: botup/types.py
@@ -117,20 +120,20 @@
 
 Filename: tests/test_serializing.py
 Comment: 
 
 Filename: tests/utils.py
 Comment: 
 
-Filename: telegram_botup-1.0.5.dist-info/METADATA
+Filename: telegram_botup-1.0.6.dist-info/METADATA
 Comment: 
 
-Filename: telegram_botup-1.0.5.dist-info/WHEEL
+Filename: telegram_botup-1.0.6.dist-info/WHEEL
 Comment: 
 
-Filename: telegram_botup-1.0.5.dist-info/top_level.txt
+Filename: telegram_botup-1.0.6.dist-info/top_level.txt
 Comment: 
 
-Filename: telegram_botup-1.0.5.dist-info/RECORD
+Filename: telegram_botup-1.0.6.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## botup/bot.py

```diff
@@ -6,23 +6,23 @@
 
 
 class Bot:
 
     def __init__(
             self,
             token: str,
-            root_widget: Widget,
+            root: Widget,
             state_manager: StateManager = DictStateManager(),
             api_timeout: int = 5
     ):
         self._api = Api(token, api_timeout)
-        self._root_widget = root_widget
+        self._root = root
         self._state_manager = state_manager
 
     async def close_session(self):
         await self._api.close_session()
 
     async def handle(self, update: dict):
         update = Update.from_dict(update)
-        context = Context(update, self._api, self._root_widget, self._state_manager)
+        context = Context(update, self._api, self._root, self._state_manager)
         navigation = await Navigation.of(context)
         await navigation.current_widget.handle(context)
```

## botup/navigation.py

```diff
@@ -1,37 +1,50 @@
 from __future__ import annotations
 
 from typing import List
 
+from botup.exceptions import WidgetNotInRegistryError
 from botup.widget import WidgetRegistry, Widget, Context
 
 
 class Navigation:
 
     def __init__(self, context: Context, path: str):
         path = path or context.root_widget.key
-        _widget_registry = WidgetRegistry()
+        widget_registry = WidgetRegistry()
         self._context = context
-        self._stack: List[Widget] = [_widget_registry.get(key) for key in path.split('/')]
+
+        try:
+            self._stack: List[Widget] = [widget_registry.get(key) for key in path.split('/')]
+        except WidgetNotInRegistryError:
+            self._stack: List[Widget] = [context.root_widget]
 
     @property
     def current_widget(self) -> Widget:
         return self._stack[-1]
 
     @classmethod
     async def of(cls, context: Context) -> Navigation:
         path = await context.get_path()
         return Navigation(context, path)
 
-    async def push(self, name: str, **kwargs):
-        assert name in (w.key for w in self.current_widget.children)
-        self._stack.append(WidgetRegistry().get(name))
+    async def push(self, key: str, **kwargs):
+        if not self.current_widget.is_children_by_key(key):
+            raise Exception(f'Key "{key}" is not children for current widget "{self.current_widget.key}"')  # TODO: specify exception
+
+        if not self._context.chat_id:
+            raise Exception("Can't resolve chat_id from current update")  # TODO: specify exception
+
+        self._stack.append(WidgetRegistry().get(key))
         await self._context.state_manager.set_path(self._context.chat_id, self.path())
         await self.current_widget.entry(self._context, **kwargs)
 
     async def pop(self, **kwargs):
+        if not self._context.chat_id:
+            raise Exception("Can't resolve chat_id from current update")  # TODO: specify exception
+
         self._stack.pop()
         await self._context.state_manager.set_path(self._context.chat_id, self.path())
         await self.current_widget.entry(self._context, **kwargs)
 
     def path(self) -> str:
         return '/'.join((w.key for w in self._stack))
```

## botup/widget.py

```diff
@@ -2,46 +2,60 @@
 
 from typing import Dict, Optional, List
 
 from botup.api import Api
 from botup.dispatcher import Dispatcher
 from botup.types import Update, BaseContext
 from botup.state_manager.base import Singleton, StateManager
+from botup.exceptions import WidgetNotInRegistryError
 
 
 class WidgetRegistry(metaclass=Singleton):
 
     def __init__(self):
-        self._data: Dict[str, Widget] = {}
+        self._registry: Dict[str, Widget] = {}
 
     def add(self, widget: Widget):
-        self._data[widget.key] = widget
+        if widget.key in self._registry:
+            raise Exception('Widget key already in WidgetRegistry')  # TODO: specify exception
+        self._registry[widget.key] = widget
 
     def get(self, key: str) -> Widget:
-        return self._data[key]
+        if key not in self._registry:
+            raise WidgetNotInRegistryError(f'Widget with key "{key}" not found')
+        return self._registry[key]
 
 
 class Widget:
 
-    def __init__(self, key: str, children: Optional[List[Widget]] = None):
-        self.key = key
+    def __init__(
+            self,
+            key: Optional[str] = None,
+            children: Optional[List[Widget]] = None
+    ):
+
+        self.key = key or self.__class__.__name__
         self._dispatcher = Dispatcher()
         self.children = children or []
+        self._children_keys = [w.key for w in self.children]
         self.build(self._dispatcher)
         WidgetRegistry().add(self)
 
-    async def entry(self, ctx: Context, **kwargs):
+    def build(self, dispatcher: Dispatcher):
         pass
 
-    def build(self, dispatcher: Dispatcher):
+    async def entry(self, ctx: Context, **kwargs):
         pass
 
     async def handle(self, ctx: Context):
         await self._dispatcher.handle_context(ctx)
 
+    def is_children_by_key(self, key: str) -> bool:
+        return key in self._children_keys
+
 
 class Context(BaseContext):
 
     def __init__(
             self,
             update: Update,
             api: Api,
@@ -57,17 +71,18 @@
         return await self.state_manager.get_path(self.chat_id or self.get_chat_id()) or ''
 
     def get_chat_id(self) -> Optional[int]:
         if self.is_message:
             return self.update.message.chat.id
 
         if self.is_callback_query:
-            return self.update.callback_query.from_.id
+            return self.update.callback_query.message.chat.id
 
         if self.is_inline_query:
             return self.update.inline_query.from_.id
 
         return None
 
     async def quick_callback_answer(self):
-        assert self.is_callback_query
+        if not self.is_callback_query:
+            raise Exception('Current update is not callback query')  # TODO: specify exception
         await self.api.answer_callback_query(self.update.callback_query.id)
```

## botup/widgets/date_picker.py

```diff
@@ -1,25 +1,28 @@
 import operator
 import re
 from calendar import Calendar, month_name
 from datetime import datetime, timedelta
 from asyncio import gather
+from typing import Optional
 
 from botup.navigation import Navigation
 from botup.widget import Widget, Context
 from botup.dispatcher import Dispatcher
 from botup.types import InlineKeyboardMarkup, InlineKeyboardButton
 
 
 class DatePicker(Widget):
 
+    DEFAULT_RESULT_KEY = 'botup_date_picker_result'
+
     def __init__(
             self,
-            key: str,
-            result_key: str = 'botup_date_picker_result',
+            key: Optional[str] = None,
+            result_key: str = DEFAULT_RESULT_KEY,
             message_text: str = 'Date picker'
     ):
         super().__init__(key)
         self._message_text = message_text
         self._storage_section = 'botup_date_picker'
         self._storage_value_key = 'value'
         self._storage_message_id_key = 'message_id'
```

## Comparing `telegram_botup-1.0.5.dist-info/METADATA` & `telegram_botup-1.0.6.dist-info/METADATA`

 * *Files 8% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: telegram-botup
-Version: 1.0.5
+Version: 1.0.6
 Summary: Python library for building Telegram bots
 Home-page: UNKNOWN
 Author: Dmitry Shebotinov
 Author-email: groovestreetmagic@gmail.com
 License: UNKNOWN
 Project-URL: Source Code, https://github.com/spirtum/telegram-botup
 Platform: UNKNOWN
@@ -66,103 +66,76 @@
 from botup.widgets.date_picker import DatePicker
 from botup.mixins.echo import EchoMixin
 from botup.types import InlineKeyboardMarkup, InlineKeyboardButton
 
 TOKEN = "token"
 WEBHOOK = f'https://url/{TOKEN}'
 
-app = App()
-
 
 class TestMixin:
 
     def build(self, dispatcher: Dispatcher):
-        print('TestMixin build')
         dispatcher.register_command_handler('/test', self.cmd_test)
 
     @staticmethod
     async def cmd_test(ctx: Context):
         await ctx.api.send_message(
             chat_id=ctx.chat_id,
             text='Test'
         )
 
 
 class RootWidget(Widget, TestMixin, EchoMixin):
-    """
-    Type "go" message
-    """
-
-    KEY = 'root'
-    DATE_PICKER_KEY = 'date_picker'
-    DATE_PICKER_RESULT_KEY = 'dp_result'
-
     async def entry(self, ctx: Context, **kwargs):
-        botup_date_picker_result = kwargs.get(RootWidget.DATE_PICKER_RESULT_KEY)
+        botup_date_picker_result = kwargs.get(DatePicker.DEFAULT_RESULT_KEY)
         if botup_date_picker_result:
             await ctx.api.send_message(
                 chat_id=ctx.chat_id,
                 text=f'date: {botup_date_picker_result}'
             )
             return
 
     def build(self, dispatcher: Dispatcher):
         TestMixin.build(self, dispatcher)
-        dispatcher.register_message_handler('go', self.go_handler)
         dispatcher.register_command_handler('/start', self.cmd_start)
         dispatcher.register_callback_handler('ready', self.clb_ready)
         EchoMixin.build(self, dispatcher)
 
     @staticmethod
     async def cmd_start(ctx: Context):
         message = await ctx.api.send_message(
             chat_id=ctx.chat_id,
-            text='Are you ready?',
-            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton(callback_data='ready', text='Yeah!')]])
+            text='Click for view date picker',
+            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton(callback_data='ready', text='Click')]])
         )
         await ctx.state_manager.set(
             chat_id=ctx.chat_id,
             key='message_id',
             value=str(message.message_id)
         )
-        return None
 
     @staticmethod
     async def clb_ready(ctx: Context):
         _, message_id, nav = await gather(
             ctx.api.answer_callback_query(ctx.update.callback_query.id),
             ctx.state_manager.get(
                 chat_id=ctx.chat_id,
                 key='message_id'
             ),
             Navigation.of(ctx)
         )
 
-        await nav.push(RootWidget.DATE_PICKER_KEY, message_id=int(message_id))
-
-    @staticmethod
-    async def go_handler(ctx: Context):
-        nav = await Navigation.of(ctx)
-        await nav.push(RootWidget.DATE_PICKER_KEY)
+        await nav.push(DatePicker.__name__, message_id=int(message_id))
 
 
-root_widget = RootWidget(
-    key=RootWidget.KEY,
-    children=[
-        DatePicker(
-            key=RootWidget.DATE_PICKER_KEY,
-            result_key=RootWidget.DATE_PICKER_RESULT_KEY
-        )
-    ]
-)
-
 bot = Bot(
     token=TOKEN,
-    root_widget=root_widget
+    root=RootWidget(children=[DatePicker()])
 )
+app = App()
 
 
 @app.on_event("startup")
 async def startup_event():
     async with Api(TOKEN) as api:
         await api.set_webhook(WEBHOOK)
```

## Comparing `telegram_botup-1.0.5.dist-info/RECORD` & `telegram_botup-1.0.6.dist-info/RECORD`

 * *Files 4% similar despite different names*

```diff
@@ -1,16 +1,17 @@
 botup/__init__.py,sha256=SqkgBNCPv-Ds2BREZ1kpe_eOe9fwjKFvfuKOsw7Pilg,148
 botup/api.py,sha256=3MGWjGsu87BSLIWMq32bK-B89aCjM3GapfPol3X05t8,52937
-botup/bot.py,sha256=V5NK2Zikej5_KYwOAfZqM1oM7fP6uIWUGgdtkLGj550,895
+botup/bot.py,sha256=ATH5uliyIJSygNqs24-Cz4EhhRWazgA26jVFk4pxUQU,867
 botup/dispatcher.py,sha256=Hhrmt1bmozSIjibUOkWsfI5oWdrdvpdkqXPJsvXMgFE,17610
+botup/exceptions.py,sha256=CSrDGqpF45s3cwAWb6S8IQCSKGAk3_qFSVCFgsA320o,52
 botup/handlers.py,sha256=OcFr-q7W8K3qVz8uvvdQxPBe74gcy2Gjq2vvvnJ_fcs,9824
-botup/navigation.py,sha256=pEE4Jo0olM9ZvHsvag2HNrSyLjSW9mvtw0VFBLNkACE,1266
+botup/navigation.py,sha256=SkW81HvXFwA58rmvqIYiFmfxdyFhcd258ndkI7fJ0wQ,1841
 botup/types.py,sha256=hHiVPbV7UUaXNQoLWOq4aWYrNcW1geF3Jcg2d0Pdzh8,48224
 botup/utils.py,sha256=1TByBVg8jNmadrc0WfxavnhQOhZl3D3LslQg2riBauE,505
-botup/widget.py,sha256=-FxEaY_PrGpSi-dqM_3AivclSE2JTRUtfiM6J46_ZbI,1933
+botup/widget.py,sha256=hjWb9IHUh5kwlmb6oXgdRVeaOW8tgYcicfhjpI1I8Yk,2600
 botup/constants/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 botup/constants/api_method.py,sha256=QPXt4RZLfhZWvV-3tAzQ9xYvHiEg0hKLcvrvbwTVryc,5243
 botup/constants/base.py,sha256=HueKF2ErW9pr3FeoDA61T7uTGvytUgRtEX8ycsNezg0,115
 botup/constants/bot_command_scope_type.py,sha256=bTyvL9n0DGas6mVsd1N0xpQhkOVhpwGY496aa4csUA4,470
 botup/constants/chat_action.py,sha256=sK2cLy0MurlJoqakVLHwjnsljw4Jo0kTERnPvX4-zNs,562
 botup/constants/chat_member_status.py,sha256=ArHrDTx0LYYCB1bPkfpqqr5Jqm8h3Di3wF6-yLzeRtY,322
 botup/constants/chat_type.py,sha256=W_eIJoHA5MB0r-XAI2dbgPqkE-W5C3QYrQu8bM_TlZo,200
@@ -28,18 +29,18 @@
 botup/constants/update_type.py,sha256=xOkuqv-51r8nmWhITgFVhOOUJ5Cb2Bq2ow5saF_dGBE,1648
 botup/mixins/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 botup/mixins/echo.py,sha256=GnzvDuZexW73MG-ENwR0Pd0V1lT1i9Vzd1rSJlcf7ZM,404
 botup/state_manager/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 botup/state_manager/base.py,sha256=b1Cyze7vcQEXeg8TLenPN0cNnv7W-GO4yxe5usAQGOM,2045
 botup/state_manager/redis.py,sha256=s95y41ZmBmY6e0g8VG3tpngt5CYtkbx-L9C5PI63exo,1003
 botup/widgets/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-botup/widgets/date_picker.py,sha256=64DdooqE5z0khhuzjHDhO2GjTkSi7-RfoYWqUpQIL9k,8920
+botup/widgets/date_picker.py,sha256=QZipzzRCorva5-RrI50qhxMbsKhD1bAqoF2AAy845AI,9010
 tests/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/conftest.py,sha256=FelSgebNBfCLurK__WHojoL5zTYL-HKqTwJjGCm2mCA,114
 tests/test_dispatcher.py,sha256=c6Wsn0OWGPyuE98Zf8-oakBbrPh_Hy0CQIC00tV-9vI,33367
 tests/test_dispatcher_decorator.py,sha256=nId6Qr_ydabg3KzA5AcTksv052AyAJZ3tX6FqFo6LEo,10847
 tests/test_serializing.py,sha256=Ny0WBjS2Ikn80QM5Ymteoi7WtgdvlXE5Dfz5b2JTjBc,609
 tests/utils.py,sha256=HA_NKbOd4HZl4dCeqFv1ud1cZhlPN37os_Z6u4yFjts,43262
-telegram_botup-1.0.5.dist-info/METADATA,sha256=yKqmNYleoJvC5ysW0cXHPv8ctHhChlCERit7oKNGs78,4441
-telegram_botup-1.0.5.dist-info/WHEEL,sha256=g4nMs7d-Xl9-xC9XovUrsDHGXt-FT0E17Yqo92DEfvY,92
-telegram_botup-1.0.5.dist-info/top_level.txt,sha256=5xSddxEvjN25GjUZSsBTJZ1OyYrsPAApb5FXZUYYoLU,12
-telegram_botup-1.0.5.dist-info/RECORD,,
+telegram_botup-1.0.6.dist-info/METADATA,sha256=0AfkG2ZCLsuIQZUd0lvc0SZMxrzrSTD3lYqViMKmntU,3850
+telegram_botup-1.0.6.dist-info/WHEEL,sha256=g4nMs7d-Xl9-xC9XovUrsDHGXt-FT0E17Yqo92DEfvY,92
+telegram_botup-1.0.6.dist-info/top_level.txt,sha256=5xSddxEvjN25GjUZSsBTJZ1OyYrsPAApb5FXZUYYoLU,12
+telegram_botup-1.0.6.dist-info/RECORD,,
```

